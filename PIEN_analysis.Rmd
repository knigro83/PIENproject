---
title: "PIEN analysis"
author: "Katie Nigro"
date: "2024-05-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up 

##Packages

```{r}
#load required packages
library(terra)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(dplyr)
library(stringr)
library(ClimateNAr)
library(ggfortify)
library(RColorBrewer)
library(tidyr)
library(lme4)
library(lmerTest)
library(car)
library(viridis)
library(dplR)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(MuMIn)
library(vegan)
library(cluster)
library(MASS)
library(indicspecies)
library(SPEI)
library(lattice)
library(tibble)
library(pals)
library(aod)
library(interactions)
library(gridExtra)
library(climwin)
library(lubridate)
library(dichromat)
library(prism)
library(multcomp)
library(multcompView)
library(lsmeans)
library(cowplot)
library(glmm)
library(glmmTMB)
library(colorspace)

```

##Plot locations

```{r}
#read in site and provenance locations
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")
west_states<- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","California","Oregon","Washington","Kansas","Oklahoma","Texas")
westernus <- us[match(toupper(west_states),toupper(us$NAME_1)),]

canada <- geodata::gadm(country = "Canada",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")

##use coordinates adjusted based on elevation and google maps
adjusted_coords<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIEN_corrected_coords.csv")

adjusted_provs<- vect(adjusted_coords, geom=c("long_corrected","lat_corrected"), crs=crs(us))

geo.dist.df<- data.frame(Provenance = adjusted_provs$Provenance, geo.dist.to.plant.km = as.matrix(terra::distance(adjusted_provs))[,21]/1000)

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=canada)+
  geom_spatvector(data=adjusted_provs, color="maroon")

adjusted_provs %>% 
  as.data.frame() %>% 
  bind_cols(crds(adjusted_provs))

#make key for provenance names
prov_names<-adjusted_coords %>% dplyr::select(Provenance, no) %>% 
 separate_wider_delim(Provenance, delim=" ", names=c("first","second","third"), too_few = "align_start", cols_remove=FALSE) %>% 
  separate_wider_delim(first, delim= "-", names=c("first","2"), too_few="align_start") %>% 
    separate_wider_delim(second, delim= "-", names=c("second","3"), too_few="align_start") %>% 
  mutate(across(everything(), ~ replace(.x, is.na(.x), ""))) %>%
  mutate(`3` = ifelse(second=="NF","F",`3`)) %>% 
  mutate(code=paste(substr(first,0,1),substr(`2`,0,1),substr(second,0,1),substr(`3`,0,1),third, sep="")) %>% 
  dplyr::select(c(Provenance,no,code)) %>% 
  mutate(no=as.integer(no)) %>% 
  mutate(code=case_when(Provenance == "Roosevelt NF" ~ "RoNF",
                        Provenance == "Pike NF" ~ "PiNF",
                        Provenance == "Gunnison NF" ~ "GuNF",
                        Provenance == "Coconino NF" ~ "CoNF",
                        Provenance == "Payette NF" ~ "PaNF",
                        Provenance == "Cache NF" ~ "CaNF",
                        Provenance == "Gila NF" ~ "GiNF",
                        TRUE ~ code))
```

#Climate

##ClimateNA

```{r}
#read in climate from climateNA

filenames <- c("AHM","bFFP","CMD","DD_18","DD_0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPT_sm","PPT_sp","PPT_at","PPT_wt","RH","Tave_sm","Tave_wt","TD","SHM")

filenames_edited <- c("AHM","bFFP","CMD","DD18","DD0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","Tavesm","Tavewt","TD","SHM")


clim_raster_stack <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1961_1990_bioclim/Normal_1961_1990/Normal_1961_1990_bioclim/Normal_1961_1990_",filenames,".tif",sep=""))

names(clim_raster_stack)<- filenames_edited


prov_clim_adjusted_bi <- terra::extract(clim_raster_stack, adjusted_provs, method='bilinear') %>% cbind(as.data.frame(adjusted_provs)) %>% cbind(crds(adjusted_provs)) %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP)

prov_clim_adjusted_bi_long<- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,AHM:SHM, smrpb, monsoonality)) %>% 
  pivot_longer(AHM:monsoonality) %>% 
  mutate(type="adj bilinear") 

#NFFD x map
ggplot()+
  geom_point(data=prov_clim_adjusted_bi, size=3, aes(x=NFFD, y=MAP), col="aquamarine3")+
  geom_text(data=prov_clim_adjusted_bi, aes(x=NFFD, y=MAP, label=Provenance), vjust=0.5, hjust=-.1)+
  theme_bw()+
  theme(legend.position = 'none')

#NFFD x TD
ggplot()+
  geom_point(data=prov_clim_adjusted_bi, size=3, aes(x=NFFD, y=TD), col="aquamarine3")+
  geom_text(data=prov_clim_adjusted_bi, aes(x=NFFD, y=TD, label=Provenance), vjust=1)+
  theme_bw()+
  theme(legend.position = 'none')

# crop_clim <- crop(clim_raster_stack %>% project(crs(us)), ext(-121, -120, 48.1, 48.2))
# 
# plot(crop_clim$AHM)
# 
# ggplot()+
#   geom_spatraster(data=crop_clim, aes(fill=AHM))+
#   geom_spatvector(data= adjusted_provs %>% filter(Provenance=="Wenatchee NF") %>% project(crs(crop_clim)))

```

###Rehfeldt comparison

```{r}
##compare White River to Rehfeldt 2004 planting sites
idacreek<- c(48.364002, -116.822747)
canyoncreek<- c(48.370716, -116.799922)
high <- c(48.353759, -116.760290)
highest <- c(48.344491, -116.714165)
preistriver<- data.frame(rbind(idacreek, canyoncreek, high,highest))
colnames(preistriver)<- c("y","x")

preistriver_vect <- vect(preistriver, geom=c("x","y"), crs=crs(us))
plot(preistriver_vect)

preistriver_clim <- terra::extract(clim_raster_stack, preistriver_vect, method="simple", df=TRUE)
preistriver_clim

prov_clim_adjusted_bi %>% 
  filter(Provenance=="Plantation")

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MAT, y=MAP), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MAT, y=MAP), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=NFFD, y=SHM), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=NFFD, y=SHM), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MCMT, y=RH), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MCMT, y=RH), col="black", size=3)

```

```{r}
#monthly normals

months = c("01","02","03","04","05","06","07","08","09","10","11","12")

monthly_ppt<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/ppt/PPT",months[i],".tif",sep=""))
ppt <- terra::extract(raster, adjusted_provs)
monthly_ppt <- left_join(monthly_ppt, ppt)}


monthly_tave<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/tave/Tave",months[i],".tif",sep=""))
tave <- terra::extract(raster, adjusted_provs)
monthly_tave <- left_join(monthly_tave, tave)}

monthly_clim <- monthly_ppt %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(PPT01:PPT12) %>% 
  bind_rows(monthly_tave %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(Tave01:Tave12)) %>% 
  mutate(month=substr(name,nchar(name)-1,nchar(name)),
         var = substr(name,0,nchar(name)-2))

monthly_clim_wide <- monthly_clim %>% 
  dplyr::select(c(Provenance, no, elev, value, month, var)) %>% 
  pivot_wider(values_from=value, names_from=var)

ggplot(monthly_clim, aes(x=month, y=value, col=var))+
  geom_point()+
  geom_line()+
  facet_wrap(~factor(Provenance))

#png("figures/prov_temp_precip.png", width=8,height=8, res=300, units="in")
ggplot()+
  geom_bar(data=monthly_clim_wide, aes(x=as.numeric(month), y=PPT), stat="identity", fill="grey")+
  geom_line(data=monthly_clim_wide, aes(x=as.numeric(month), y=Tave*10), col="black", lwd=1)+
  scale_y_continuous(
    "PPT (mm)", 
    sec.axis = sec_axis(~ . / 10, name = "Temp (C)"), limits=c(-150,350))+
  scale_x_continuous(breaks=seq(1,12,1), labels=seq(1,12,1), name="Month")+
  facet_wrap(~factor(Provenance))+
  theme_bw()+
  theme(panel.grid.minor=element_blank())
#dev.off()

ggplot(monthly_clim %>% filter(var=="Tave") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="Tave") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="red",size=2)+
    facet_wrap(~factor(Provenance))

ggplot(monthly_clim %>% filter(var=="PPT") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="PPT") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="green",size=3)+
    facet_wrap(~factor(Provenance))
```


```{r}
#compare climates of provenances
prov_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(Provenance,AHM:SHM,smrpb)) %>% 
  left_join(prov_names) %>% 
  pivot_longer(AHM:smrpb, names_to = "var", values_to = "value")

order<- prov_clim_adjusted_bi %>% 
  arrange(y) %>% 
  pull(Provenance)

# png("figures/prov_clim_plot.png", width=12, height=8, units="in", res=500)
ggplot(prov_vars, aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
# dev.off()

ggplot(prov_vars %>% filter(!Provenance=="Gila NF"), aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
```

###future climate

```{r}
##get future projections from ClimateNA

#2000's normal
clim2000s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1991_2020_bioclim/Normal_1991_2020_bioclim/Normal_1991_2020_",filenames,".tif",sep=""))

names(clim2000s) <- paste(filenames_edited,"_ssp585_2000s", sep="") 

##2020's projections
clim2020s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040_",filenames,".tif",sep=""))

names(clim2020s) <- paste(filenames_edited,"_ssp585_2020s", sep="")  

##2050's projections
clim2050s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070_",filenames,".tif",sep=""))

names(clim2050s) <- paste(filenames_edited,"_ssp585_2050s", sep="") 

##2080's projections
clim2080s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100_",filenames,".tif",sep=""))

names(clim2080s) <- paste(filenames_edited,"_ssp585_2080s", sep="")  

future_clim_raster_stack <- c(clim2020s,clim2050s,clim2080s)

prov_futures<- terra::extract(future_clim_raster_stack, adjusted_provs, weights=T)

prov_futures_long<- prov_futures %>%
  left_join(data.frame(ID=seq(1,21,1), Provenance =adjusted_provs$Provenance)) %>% 
  dplyr::select(ID,Provenance,everything()) %>% 
  pivot_longer(cols=AHM_ssp585_2020s:SHM_ssp585_2080s) %>% 
  separate(name, into=c("climvar","carbon","period"), remove=TRUE) 

prov_futures_long

```

##PRISM

```{r}
#read in files
ppt_comb_plantation<- read.csv("ppt_comb_plantation.csv") 
tmax_comb_plantation<- read.csv("tmax_comb_plantation.csv")
tmin_comb_plantation<- read.csv("tmin_comb_plantation.csv")
tmean_comb_plantation<- read.csv("tmean_comb_plantation.csv")
vpdmax_comb_plantation<- read.csv("vpdmax_comb_plantation.csv")
vpdmin_comb_plantation<- read.csv("vpdmin_comb_plantation.csv")

ppt_comb_all<- read.csv("ppt_comb_all.csv")
tmax_comb_all<- read.csv("tmax_comb_all.csv")
tmin_comb_all<- read.csv("tmin_comb_all.csv")
tmean_comb_all<- read.csv("tmean_comb_all.csv")
vpdmax_comb_all<- read.csv("vpdmax_comb_all.csv")
vpdmin_comb_all<- read.csv("vpdmin_comb_all.csv")


##add in 1969 to plantation data
 months<- c("01","02","03","04","05","06","07","08","09","10","11","12")
# 
# # set location of climate data
climdir <- "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/PRISM"
# 
ppt_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_ppt_stable_4kmM3_198101_202305_bil/PRISM_ppt_stable_4kmM2_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  ppt<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  ppt_CN<-cbind(CN,ppt,year,month)
  ppt_data_1969<-rbind(ppt_data_1969,ppt_CN)}

tmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmin_stable_4kmM3_198101_202305_bil/PRISM_tmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmin_CN<-cbind(CN,tmin,year,month)
  tmin_data_1969<-rbind(tmin_data_1969,tmin_CN)}

tmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmax_stable_4kmM3_198101_202305_bil/PRISM_tmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmax_CN<-cbind(CN,tmax,year,month)
  tmax_data_1969<-rbind(tmax_data_1969,tmax_CN)}

tmean_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmean_stable_4kmM3_198101_202305_bil/PRISM_tmean_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmean<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmean_CN<-cbind(CN,tmean,year,month)
  tmean_data_1969<-rbind(tmean_data_1969,tmean_CN)}

vpdmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmax_stable_4kmM3_198101_202305_bil/PRISM_vpdmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmax_CN<-cbind(CN,vpdmax,year,month)
  vpdmax_data_1969<-rbind(vpdmax_data_1969,vpdmax_CN)}

vpdmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmin_stable_4kmM3_198101_202305_bil/PRISM_vpdmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmin_CN<-cbind(CN,vpdmin,year,month)
  vpdmin_data_1969<-rbind(vpdmin_data_1969,vpdmin_CN)}


##append 1969
ppt_comb_plantation <- bind_rows(as.data.frame(ppt_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), ppt=as.numeric(ppt), year=as.integer(year), month=as.integer(month)), ppt_comb_plantation %>% dplyr::select(-c(X.1, X))) 

tmax_comb_plantation <- bind_rows(as.data.frame(tmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmax=as.numeric(tmax), year=as.integer(year), month=as.integer(month)), tmax_comb_plantation %>% dplyr::select(-X))

tmean_comb_plantation <- bind_rows(as.data.frame(tmean_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmean=as.numeric(tmean), year=as.integer(year), month=as.integer(month)), tmean_comb_plantation %>% dplyr::select(-X)) 

tmin_comb_plantation <- bind_rows(as.data.frame(tmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmin=as.numeric(tmin), year=as.integer(year), month=as.integer(month)), tmin_comb_plantation%>% dplyr::select(-X)) 

vpdmax_comb_plantation <- bind_rows(as.data.frame(vpdmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmax=as.numeric(vpdmax), year=as.integer(year), month=as.integer(month)), vpdmax_comb_plantation%>% dplyr::select(-X)) 

vpdmin_comb_plantation <- bind_rows(as.data.frame(vpdmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmin=as.numeric(vpdmin), year=as.integer(year), month=as.integer(month)), vpdmin_comb_plantation%>% dplyr::select(-X))

```

```{r}
###site climate summary
ppt_plantation_yearly <- ppt_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(ppt_sum = sum(ppt))

mean(ppt_plantation_yearly$ppt_sum)
sd(ppt_plantation_yearly$ppt_sum)

tmin_plantation_dailyave <- tmin_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(tmin_ave=mean(tmin))
mean(tmin_plantation_dailyave$tmin_ave)

mean(tmin_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% pull(tmin))
mean(tmax_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% pull(tmax))
mean(tmean_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% pull(tmean))

##plotting site climate over time


tmean_sum<- tmean_comb_plantation %>% 
  filter(year>1969) %>% 
  mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(decade) %>% 
  summarise(MAT = mean(tmean), se_MAT=sd(tmean)/sqrt(n()))

ppt_sum <- ppt_comb_plantation %>% 
  filter(year > 1969) %>% 
    mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(year,decade) %>% 
  summarise(MAP=sum(ppt)) %>% 
  group_by(decade) %>% 
  summarise(MAP_ave = mean(MAP), se_MAP=sd(MAP)/sqrt(n()))

plantation_2dclim <- left_join(tmean_sum, ppt_sum)

ggplot(plantation_2dclim, aes(x=MAT, y=MAP_ave, col=decade))+
         geom_point()

tmean_mod <- lm(tmean ~ year, data=tmean_comb_plantation %>% group_by(year) %>% summarise(tmean=mean(tmean)))
par(mfrow=c(2,2))
plot(tmean_mod)
summary(tmean_mod)

0.015728*45

tmin_mod <- lm(tmin ~ year, data=tmin_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmin=mean(tmin)))
par(mfrow=c(2,2))
plot(tmin_mod)
summary(tmin_mod)

tmax_mod <- lm(tmax ~ year, data=tmax_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmax=mean(tmax)))
par(mfrow=c(2,2))
plot(tmax_mod)
summary(tmax_mod)

ppt_mod <- lm(ppt ~ year, data=ppt_comb_plantation %>%  filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(ppt=sum(ppt)))
par(mfrow=c(2,2))
plot(ppt_mod)
summary(ppt_mod)

0.021181*46

##making provenance climate table for paper
prov_clim_table<- prov_clim_adjusted_bi %>% 
  left_join(prov_names %>% dplyr::select(Provenance, code)) %>% 
  dplyr::select(Provenance, y, x, elev, MAT, MAP, NFFD,PAS) %>% 
  arrange(desc(y))

write.csv(prov_clim_table,"prov_clim_table.csv")  

```

```{r}
##looking for anomolous frosts

prov_clim_adjusted_bi %>% 
  filter(Provenance=="Plantation") %>% 
  pull(bFFP)

prov_clim_adjusted_bi %>% 
  filter(Provenance=="Plantation") %>% 
  pull(eFFP)

prov_clim_adjusted_bi %>% 
  filter(Provenance=="Gila NF") %>% 
  pull(eFFP)

#prism_set_dl_dir("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp")

# get_prism_dailys(type="tmin", minDate = "1981-04-01", maxDate = "1981-10-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1982-04-01", maxDate = "1982-10-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1983-07-01", maxDate = "1983-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1984-07-01", maxDate = "1984-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1985-07-01", maxDate = "1985-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1986-07-01", maxDate = "1986-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1987-07-01", maxDate = "1987-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1988-07-01", maxDate = "1988-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1989-07-01", maxDate = "1989-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1990-07-01", maxDate = "1990-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1991-07-01", maxDate = "1991-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1992-07-01", maxDate = "1992-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1993-07-01", maxDate = "1993-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1994-07-01", maxDate = "1994-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1995-07-01", maxDate = "1995-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1996-07-01", maxDate = "1996-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1997-07-01", maxDate = "1997-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "1998-07-01", maxDate = "1998-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2000-07-01", maxDate = "2000-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2001-07-01", maxDate = "2001-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2002-07-01", maxDate = "2002-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2003-07-01", maxDate = "2003-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2004-07-01", maxDate = "2004-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2005-07-01", maxDate = "2005-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2006-07-01", maxDate = "2006-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2007-07-01", maxDate = "2007-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2008-07-01", maxDate = "2008-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2009-07-01", maxDate = "2009-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2010-07-01", maxDate = "2010-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2011-07-01", maxDate = "2011-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2012-07-01", maxDate = "2012-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2013-07-01", maxDate = "2013-08-31", keepZip=FALSE)
# get_prism_dailys(type="tmin", minDate = "2014-07-01", maxDate = "2014-08-31", keepZip=FALSE)

#  prism_set_dl_dir("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp")
# # 
# # years <- seq(1981,2014,1)
#  years <- c(2015)
# # 
# for(k in 1:length(years)){
#       get_prism_dailys(type="tmin", minDate = paste(years[k],"-05-15",sep=""), maxDate = paste(years[k],"-10-13",sep=""), keepZip=FALSE)
#     }
  
# get_prism_dailys(type="tmin", minDate = paste(2015,"-10-14",sep=""), maxDate = paste(2015,"-10-31",sep=""), keepZip=FALSE)
# 
# get_prism_dailys(type="tmin", minDate = paste(2009,"-05-01",sep=""), maxDate = paste(2009,"-05-14",sep=""), keepZip=FALSE)


dates_31 <- c("01","02","03","04","05","06","07","08","09",seq(10,31,1))
dates_30 <- c("01","02","03","04","05","06","07","08","09",seq(10,30,1))
months_31 <- c("07","08")
months_30 <- c("06","09")
#years <- seq(1981,2014,1)
dates_may<- seq(15,31,1)
dates_oct<-  c("01","02","03","04","05","06","07","08","09",seq(10,13,1))

##first for partial May
# tmindata_31<- data.frame()
# for(k in 1:length(years)){
#     for(i in 1:length(dates_may)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],"05",dates_may[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],"05",dates_may[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_31 <- bind_rows(tmindata_31,data.frame(year=years[k], month="05", day = dates_may[i], tmin = tmin[,2]))}}
# 
# for(k in 1:length(years)){
#   for(j in 1:length(months_31)){
#     for(i in 1:length(dates_31)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],months_31[j],dates_31[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],months_31[j],dates_31[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_31 <- bind_rows(tmindata_31,data.frame(year=years[k], month=months_31[j], day = as.numeric(dates_31[i]), tmin = tmin[,2]))}}}
# 
# for(k in 1:length(years)){
#     for(i in 1:length(dates_oct)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],"10",dates_oct[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],"10",dates_oct[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_31 <- bind_rows(tmindata_31,data.frame(year=years[k], month="10", day = as.numeric(dates_oct[i]), tmin = tmin[,2]))}}
# 
# 
# head(tmindata_31)
# tail(tmindata_31)
# write.csv(tmindata_31,"tmindata_31.csv")
# 
# tmindata_30<- data.frame()
# for(k in 1:length(years)){
#   for(j in 1:length(months_30)){
#     for(i in 1:length(dates_30)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],months_30[j],dates_30[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],months_30[j],dates_30[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_30 <- bind_rows(tmindata_30,data.frame(year=years[k], month=months_30[j], day = dates_30[i], tmin = tmin[,2]))}}}
# 
# write.csv(tmindata_30, "tmindata_30.csv")

######adding 2015
#first for partial May
# tmindata_31_2015<- data.frame()
# for(k in 1:length(years)){
#     for(i in 1:length(dates_may)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],"05",dates_may[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],"05",dates_may[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_31_2015 <- bind_rows(tmindata_31_2015,data.frame(year=years[k], month="05", day = dates_may[i], tmin = tmin[,2]))}}
# 
# for(k in 1:length(years)){
#   for(j in 1:length(months_31)){
#     for(i in 1:length(dates_31)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],months_31[j],dates_31[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],months_31[j],dates_31[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_31_2015 <- bind_rows(tmindata_31_2015,data.frame(year=years[k], month=months_31[j], day = as.numeric(dates_31[i]), tmin = tmin[,2]))}}}
# 
# for(k in 1:length(years)){
#     for(i in 1:length(dates_oct)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],"10",dates_oct[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],"10",dates_oct[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_31_2015 <- bind_rows(tmindata_31_2015,data.frame(year=years[k], month="10", day = as.numeric(dates_oct[i]), tmin = tmin[,2]))}}
# 
# 
# head(tmindata_31_2015)
# tail(tmindata_31_2015)
# 
# tmindata_31 <- read.csv("tmindata_31.csv")
# tmindata_31 <- bind_rows(tmindata_31,tmindata_31_2015 %>% mutate(year=as.integer(year),month=as.integer(month),day=as.integer(day)))
# 
# write.csv(tmindata_31,"tmindata_31.csv")
# 
# tmindata_30_2015<- data.frame()
# for(k in 1:length(years)){
#   for(j in 1:length(months_30)){
#     for(i in 1:length(dates_30)){
# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",years[k],months_30[j],dates_30[i],"_bil","/PRISM_tmin_stable_4kmD2_",years[k],months_30[j],dates_30[i],"_bil.bil",sep=""))
# tmin <- terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# tmindata_30_2015 <- bind_rows(tmindata_30_2015,data.frame(year=years[k], month=months_30[j], day = dates_30[i], tmin = tmin[,2]))}}}
# 
# tmindata_30 <- read.csv("tmindata_30.csv")
# tmindata_30 <- bind_rows(tmindata_30,tmindata_30_2015 %>% mutate(year=as.integer(year),month=as.integer(month),day=as.integer(day)))
# 
# write.csv(tmindata_30,"tmindata_30.csv")


# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",2015,10,14,"_bil","/PRISM_tmin_stable_4kmD2_",2015,10,14,"_bil.bil",sep=""))
# terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# ##first fall frost in 2015 is on 10-14

# raster<- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/prismtmp/PRISM_tmin_stable_4kmD2_",2009,05,14,"_bil","/PRISM_tmin_stable_4kmD2_",2009,05,14,"_bil.bil",sep=""))
# terra::extract(raster, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# ##05-14-2009 was the last spring frost

```

```{r}
##calculate seasonal PRISM values

##ppt
ppt_summed <- as.data.frame(ppt_comb_plantation) %>% 
  mutate(ppt = as.numeric(ppt), year=as.integer(year)) %>%
  filter(!is.na(ppt)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(ppt = sum(ppt)) 

ggplot(ppt_summed %>% filter(CN=="Plantation"), aes(x=year, y=ppt)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(ppt_summed %>% filter(CN=="Plantation") %>% pull(ppt)), col="red")

##seasonal ppt
ppt_seasonal_plantation <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
  summarise(PPTsm = sum(ppt)) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(5,6,7,8,9)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_gs = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(12,1,2)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_wt = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
  summarise(PPT_at = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
  summarise(PPTsp = sum(ppt))) %>% 
  left_join(ppt_summed) 


##tmin
tmin_summed <- as.data.frame(tmin_comb_plantation) %>% 
  mutate(tmin = as.numeric(tmin), year=as.integer(year)) %>%
  filter(!is.na(tmin)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmin = mean(tmin)) 

ggplot(tmin_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmin)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmin_summed %>% filter(CN=="Plantation") %>% pull(tmin)), col="red")

##tmax
tmax_summed <- as.data.frame(tmax_comb_plantation) %>% 
  mutate(tmax = as.numeric(tmax), year=as.integer(year)) %>%
  filter(!is.na(tmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmax = mean(tmax))

ggplot(tmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmax_summed %>% filter(CN=="Plantation") %>% pull(tmax)), col="red")

##tmean
tmean_summed <- as.data.frame(tmean_comb_plantation) %>% 
  mutate(tmean = as.numeric(tmean), year=as.integer(year)) %>%
  filter(!is.na(tmean)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmean = mean(tmean)) 

ggplot(tmean_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmean)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmean_summed %>% filter(CN=="Plantation") %>% pull(tmean)), col="red")

##seasonal temps
all_temps <- bind_rows(tmean_comb_plantation %>% pivot_longer(tmean), tmin_comb_plantation %>% pivot_longer(tmin), tmax_comb_plantation %>% pivot_longer(tmax))

summertemps <- all_temps %>% filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sm =mean(value))
falltemps <- all_temps %>% filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_fa =mean(value))
wintertemps <- all_temps %>% filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month=="12",year+1,year)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_wt =mean(value))
springtemps <- all_temps %>% filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sp =mean(value))

plantation_seasonal_temps <- left_join(summertemps,falltemps) %>% 
  left_join(wintertemps) %>% 
  left_join(springtemps)

plantation_seasonal_temps_wide<- plantation_seasonal_temps %>% 
  pivot_wider(values_from = c(value_sm,value_fa,value_wt,value_sp), names_from = name)

##vpdmax

vpdmax_summed <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(!is.na(vpdmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax = mean(vpdmax))

ggplot(vpdmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=vpdmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(vpdmax_summed %>% filter(CN=="Plantation") %>% pull(vpdmax)), col="red")

vpdmax_seasonal <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sm = mean(vpdmax)) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_fa = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month == "12", year+1, year)) %>% 
  filter(!year %in% c(1970,2017)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_wt = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sp = mean(vpdmax)))


##look at correlation in annual variables
left_join(tmean_summed,tmax_summed) %>% 
  left_join(tmin_summed) %>% 
  left_join(vpdmax_summed) %>% 
  left_join(ppt_summed) %>% 
  ungroup() %>% 
  dplyr::select(tmean:ppt) %>% 
  cor()

```
##FDSI calculation

High FDSI value = less droughty

```{r}
all_climate <- left_join(ppt_comb_plantation,tmax_comb_plantation) %>% 
  left_join(tmin_comb_plantation) %>% 
  left_join(tmean_comb_plantation) %>% 
  left_join(vpdmax_comb_plantation) %>% 
  left_join(vpdmin_comb_plantation) %>% 
  mutate(vpdmean=(vpdmin+vpdmax)/2)

nrow(all_climate)
nrow(tmin_comb_plantation)

all_climate_long <- all_climate %>% 
  pivot_longer(c("ppt","tmax","tmin","tmean","vpdmax","vpdmin","vpdmean"), names_to="climvar", values_to = "value") %>% 
  mutate(monthvar = paste(climvar,month,sep=""))

climate_minus1<- all_climate_long %>% 
  mutate(year=year+1) %>% 
  mutate(monthvar = paste("yr1",climvar,month,sep=""))

climate_minus2<- all_climate_long %>% 
  mutate(year=year+2) %>% 
  mutate(monthvar = paste("yr2",climvar,month,sep=""))

climate_allyears <- rbind(all_climate_long, climate_minus1, climate_minus2)


### FDSI CALC

### CALCULATIONS TAKEN FROM WILLIAMS ET AL., 2013 
# DOI: 10.1038/NCLIMATE1693
#https://www.nature.com/articles/nclimate1693
FDSI_C <- climate_allyears %>%
 dplyr::select(-c("date","month","climvar")) %>% 
  pivot_wider(id_cols=c("CN","year"), names_from = monthvar, values_from = value)

head(FDSI_C)

FDSI_raw<- FDSI_C %>% 
  group_by(CN, year) %>% 
  summarise(FDSIvpd=(((vpdmean5+vpdmean6+vpdmean7)/3)+(yr1vpdmean8+yr1vpdmean9+yr1vpdmean10)/3)/2, FDSIppt=log(yr1ppt11+yr1ppt12+ppt1+ppt2+ppt3))

meanVPD <- mean(FDSI_raw$FDSIvpd, na.rm=T)
meanppt <- mean(FDSI_raw$FDSIppt, na.rm=T)
SDVPD <- sd(FDSI_raw$FDSIvpd, na.rm=T)
SDppt <- sd(FDSI_raw$FDSIppt, na.rm=T)
FDSI_raw$zscoreppt <- ((FDSI_raw$FDSIppt-meanppt)/SDppt)
FDSI_raw$zscoreVPD <- ((FDSI_raw$FDSIvpd-meanVPD)/SDVPD)

FDSI_raw$FDSI <- (0.44*(FDSI_raw$zscoreppt)-0.56*(FDSI_raw$zscoreVPD))

ggplot(FDSI_raw, aes(x=year, y=FDSI))+
  geom_line()+
  geom_point()
#I think we need to consider the fact that FDSI was really high right before the drought of the early 2000's so that's why trees may not be showing equivalent growth rates after the drought (cause it was still relatively hot and dry)
```


##CWD calculation

```{r}
source("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/grad school/cwd_function_v3.r")
# 
# #get dem
# dem_plantation <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/USGS_13_n40w107_20220216.tif")
# 
# slpasp <- terrain(dem_plantation, v = c("slope","aspect"))
# 
# slpasp_plantation <- terra::extract(slpasp, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# 
# plantation_cwd_data <- all_climate %>% left_join(as.data.frame(adjusted_provs) %>% bind_cols(crds(adjusted_provs)) %>% filter(Provenance=="Plantation"), by=c("CN"="Provenance")) %>%
#   mutate(soilawc=116.5, foldedaspect = abs(180-abs(slpasp_plantation$aspect - 225)), slope=slpasp_plantation$slope)
# 
# write.csv(plantation_cwd_data, "plantation_cwd_data.csv")

plantation_cwd_data<- read.csv("plantation_cwd_data.csv")

plantation_cwd <- cwd_function(site="plantation",slope=plantation_cwd_data$slope, latitude=plantation_cwd_data$y, foldedaspect = plantation_cwd_data$foldedaspect, ppt = plantation_cwd_data$ppt, tmean = plantation_cwd_data$tmean, month = plantation_cwd_data$month, soilawc = plantation_cwd_data$soilawc, year = plantation_cwd_data$year, type="annual")

head(plantation_cwd)

cwd_year0 <- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month<9) %>% 
  group_by(site, year) %>% 
  summarise(cwd_1_9 = sum(cwd))

cwd_yearminus1 <-  plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month>8) %>%
  mutate(wateryear=year+1) %>% 
  group_by(site, wateryear) %>% 
  summarise(cwd_prev = sum(cwd))

wateryear_cwd<- cwd_year0 %>% 
  left_join(cwd_yearminus1, by=c("year" = "wateryear","site")) %>% 
  rowwise() %>% 
  mutate(cwd_wy = sum(cwd_1_9, cwd_prev))

sp_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd))

fa_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(cwd_fa = sum(cwd))

##water year drought
ggplot(wateryear_cwd, aes(x=year, y=cwd_wy))+
  geom_point()+
  geom_line()+
  geom_point(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_line(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_point(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")+
  geom_line(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")  ##1970s and 80s droughts were influenced more by fall lack of moisture than 2002 drought. 


##spring drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd)), aes(x=year, y=cwd_sp))+
  geom_point()+
  geom_line()

##fall drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)), aes(x=year, y=cwd_fa))+
  geom_point()+
  geom_line()

#summer drought
ggplot(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% filter(month%in%c(6,7,8)), aes(x=date, y=cwd))+
  geom_point(aes(col=factor(year)))+
  geom_line()

#number of times each month throughout the time series had CWD>0. July and August are most common times when CWD > 0, and it averages ~9mm
plantation_cwd %>% 
  filter(cwd>0) %>% 
  group_by(month) %>% 
  summarise(n=n(), mean=mean(cwd))

##summarise monthly climate on an annual basis
plantation_cwd_annual <- plantation_cwd %>% 
  group_by(site,year, soilawc) %>% 
  summarise(ppt_sum = sum(ppt), tmean_ave=mean(tmean), aet_sum=sum(aet), cwd_sum=sum(cwd))

plantation_cwd_annual_long<- plantation_cwd_annual %>% 
  left_join(FDSI_raw %>% dplyr::select(year,FDSI), by="year") %>% 
  dplyr::select(-CN) %>% 
  pivot_longer(ppt_sum:FDSI)

ggplot(plantation_cwd_annual_long %>% filter(name%in%c("cwd_sum","FDSI")), aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales = "free")
  
```

##SPEI

```{r}
##calculate SPEI - Standardized Precipitation Evapotranspiration Index (higher is wetter, lower is drier)
plantation_climatebalance <- plantation_cwd %>% 
  mutate(ppt_pet = ppt - petm)

plantation_spei <- spei(plantation_climatebalance %>% pull(ppt_pet), scale=1)
plantation_spei$fitted
summary(plantation_spei)

plantation_spei_sum <- data.frame(year=plantation_climatebalance$year, month=plantation_climatebalance$month, spei = plantation_spei$fitted, date = as.Date(paste(plantation_climatebalance$month,"01",plantation_climatebalance$year, sep="/"), "%m/%d/%Y"))

ggplot(plantation_spei_sum %>% filter(year > 1987 & year <2024), aes(x=date, y=spei, fill=spei>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

plantation_spei_annual<- plantation_spei_sum %>% 
  group_by(year) %>% 
  summarise(spei_mean = mean(spei), spei_sum=sum(spei))

ggplot(plantation_spei_annual %>% filter(year > 1987 & year <2024), aes(x=year, y=spei_sum, fill=spei_sum>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

##RAWS
This data is from Dowd Junction weather station, located at 39.626944, -106.451667 - just down the mountain from the White River Plantation site. 

```{r}
DJ <- read.csv("DowdJunction_monthlydata.csv")

DJ[ DJ == "-9999"] <- NA

DJ_seasonal<- DJ %>% 
  separate(date, into=c("month","day","year"), sep="/", remove=TRUE) %>% 
  mutate(month=as.numeric(month), day=as.numeric(day), year=as.numeric(year)) %>% 
  mutate(season = case_when(month %in% c(12,1,2) ~ "winter",
                            month %in% c(3,4,5) ~ "spring",
                            month %in% c(6,7,8) ~ "summer",
                            month %in% c(9,10,11) ~ "fall"),
         seasonyear = ifelse(month==12, year+1, year)) %>% 
  filter(seasonyear>1985) %>% 
  group_by(seasonyear, season) %>% 
  summarise(ave_mean_air_temp_C = mean(mean_air_temp_C, na.rm=TRUE),
            ave_daily_max_temp_C = mean(mean_daily_max_temp_C, na.rm=TRUE),
            ave_daily_min_temp_C = mean(mean_daily_min_temp_C, na.rm=TRUE),
            ave_mean_RH = mean(mean_RH, na.rm=TRUE),
            total_season_precip_mm = sum(total_precip_mm, na.rm=TRUE))
DJ_seasonal

```

##All climate vars

```{r}
#combine all climate vars

plantation_clim <- ppt_seasonal_plantation %>% 
  left_join(plantation_seasonal_temps_wide) %>% 
  left_join(vpdmax_seasonal) %>% 
  left_join(FDSI_raw) %>% 
  left_join(plantation_cwd_annual) %>% 
  left_join(wateryear_cwd) %>% 
  left_join(plantation_spei_annual)

colnames(plantation_clim)

plantation_clim_long <- plantation_clim %>% 
dplyr::select(c(CN:vpdmax_sp, FDSI, aet_sum, cwd_sum, cwd_wy, spei_sum)) %>% 
  pivot_longer(PPTsm:spei_sum) %>% 
  mutate(type = ifelse(name %in% c("PPTsp","PPTsm","PPT_at","ppt_wt"), "PPT",
                       ifelse(name %in% c("value_sp_tmean","value_sm_tmean","value_fa_tmean","value_wt_tmean","value_sp_tmin","value_sm_tmin","value_fa_tmin","value_wt_tmin","value_sp_tmax","value_sm_tmax","value_fa_tmax","value_wt_tmax"),"TEMP",NA)),
         season = ifelse(name %in% c("PPTsp","value_sp_tmean","value_sp_tmin","value_sp_tmax"), "Spring", 
                         ifelse(name %in% c("PPTsm","value_sm_tmean","value_sm_tmin","value_sm_tmax"), "Summer",
                                ifelse(name %in% c("ppt_wt","value_wt_tmean","value_wt_tmin","value_wt_tmax"),"Winter",
                                                   ifelse(name %in% c("PPT_at","value_fa_tmean","value_fa_tmin","value_fa_tmax"),"Fall",NA))))) %>% 
  separate(name, into=c("name1","name2","name3"), sep="_",remove=FALSE) %>% 
  mutate(statistic = case_when(name3=="tmax" ~ "max",
                               name3=="tmin"~ "min",
                               name3=="tmean" ~ "mean",
                               type=="PPT" ~ "sum",
                               TRUE ~ NA))

ggplot(plantation_clim_long %>% filter(name %in% c("PPTsp","PPTsm","PPT_at","ppt_wt","value_sp_tmean","value_sm_tmean","value_fa_tmean","value_wt_tmean")), aes(x=year, y=value, col=type))+
  scale_color_manual(values=c("skyblue4","firebrick"))+
  geom_line(aes(lty=factor(season,levels=c("Spring","Summer","Fall","Winter"))))+
  scale_linetype(name="Season")+
  geom_smooth(method="lm")+
  facet_wrap(type~factor(season,levels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=2)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))

ggplot(plantation_clim_long %>% filter(name %in% c("PPTsp","PPTsm","PPT_at","ppt_wt","value_sp_tmean","value_sm_tmean","value_fa_tmean","value_wt_tmean","value_sp_tmin","value_sm_tmin","value_fa_tmin","value_wt_tmin","value_sp_tmax","value_sm_tmax","value_fa_tmax","value_wt_tmax")), aes(x=year, y=value, col=type))+
  scale_color_manual(values=c("skyblue4","firebrick"))+
  geom_line(aes(lty=factor(statistic, levels=c("mean","max","min","sum"))))+
  scale_linetype(name="Statistic")+
  geom_smooth(method="lm", aes(lty=factor(statistic, levels=c("mean","max","min","sum"))))+
  facet_wrap(type~factor(season,levels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=2)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))

###models

##spring ppt

spppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="PPTsp"))
plot(spppt_mod)
summary(spppt_mod) #NS

##summer ppt

smppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="PPTsm"))
plot(smppt_mod)
summary(smppt_mod) #NS

##fall ppt

atppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="PPT_at"))
plot(atppt_mod)
summary(atppt_mod) #NS

##winter ppt

wtppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="ppt_wt"))
plot(wtppt_mod)
summary(wtppt_mod) #NS

##spring tmean

sptmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sp_tmean"))
plot(sptmean_mod)
summary(sptmean_mod) #NS

sptmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sp_tmin"))
plot(sptmin_mod)
summary(sptmin_mod) #significant

sptmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sp_tmax"))
plot(sptmax_mod)
summary(sptmax_mod) #NS

##summer tmean

smtmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sm_tmean"))
plot(smtmean_mod)
summary(smtmean_mod) #Significant

smtmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sm_tmin"))
plot(smtmin_mod)
summary(smtmin_mod) #significant

smtmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sm_tmax"))
plot(smtmax_mod)
summary(smtmax_mod) #significant

##fall tmean

attmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_fa_tmean"))
plot(attmean_mod)
summary(attmean_mod) #Significant

fatmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_fa_tmin"))
plot(fatmin_mod)
summary(fatmin_mod) #significant

fatmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_fa_tmax"))
plot(fatmax_mod)
summary(fatmax_mod) #significant

##winter tmean

wttmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_wt_tmean"))
plot(wttmean_mod)
summary(wttmean_mod) #NS

wttmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_wt_tmin"))
plot(wttmin_mod)
summary(wttmin_mod) #NS

wttmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_wt_tmax"))
plot(wttmax_mod)
summary(wttmax_mod) #NS


```

```{r, eval=FALSE}
##how does mean annual temperature at the plantation during the study compare to future projections?

ggplot(data=tmean_comb_plantation %>% 
  group_by(year) %>% 
  summarise(tmean=mean(tmean)), aes(x=year, y=tmean))+
    geom_point()+
  geom_point(data=plantation_all, aes(x=c(1975,2025,2055,2085), y=MAT), col="red")
```

##Climate extremes

```{r}
plantation_clim_long_qs<- plantation_clim_long %>% 
  left_join(plantation_clim_long %>% 
  filter(!is.na(value)) %>% 
  group_by(name) %>% 
  summarise(q2.5 = quantile(value, 0.025), q97.5 = quantile(value, 0.975), out.hi = quantile(value, c(0.75))  + IQR(value)*1.5, out.low = quantile(value, c(0.75)) - IQR(value)*1.5))

#data.frame(climvar = unique(plantation_clim_long_qs$name)) %>% write.csv("plantation_clim_vars.csv")
##look at years where each climate variable exceeded the 97.5th (or 2.5th) percentile - these are years of potentially extreme climate 
ggplot(plantation_clim_long_qs, aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.hi), col="black")

##plot RAWS data to compare
DJ_seasonal_long <- pivot_longer(DJ_seasonal,ave_mean_air_temp_C:total_season_precip_mm)

ggplot(DJ_seasonal_long %>% filter(!seasonyear %in%c(1986,1999,2015)), aes(x=seasonyear, y=value, col=season))+ #removing 1986 and 1999 because they have months with NAs for all variables so totals and averages will be really off. 
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")

DJ_seasonal %>% 
  group_by(seasonyear) %>% 
  summarise(total_ppt = sum(total_season_precip_mm)) %>% 
  print(n=30)

###############
## identify drought year
###############
unique(plantation_clim_long_qs$name)

plantation_clim_xtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet") & value < out.low, "yes",
                          ifelse(name %in% c("value_sm_tmax","value_sm_tmean","value_sm_tmin","value_fa_tmax","value_fa_tmean","value_fa_tmin","value_wt_tmax","value_wt_tmean","value_wt_tmin","value_sp_tmax","value_sp_tmean","value_sp_tmin","vpdmax_sm","vpdmax_fa","vpdmax_wt","vpdmax_sp","cwd_sum","cwd_wy","spei_sum") & value > out.hi, "yes", "no" 
  ))) %>% 
  filter(extreme=="yes")

head(plantation_clim_xtremes)

xtreme_d_byyr<- plantation_clim_xtremes %>% 
  group_by(year) %>% 
  summarise(n=n()) %>% 
  as.data.frame()

ggplot(xtreme_d_byyr, aes(x=year, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("gold","brown"))

###########
## identify cold years
#############
plantation_clim_long_qs %>% 
  pull(name)%>% 
  unique()

plantation_clim_coldxtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("value_sm_tmax","value_sm_tmean","value_sm_tmin","value_fa_tmax","value_fa_tmean","value_fa_tmin","value_wt_tmax","value_wt_tmean","value_wt_tmin","value_sp_tmax","value_sp_tmean","value_sp_tmin","vpdmax_sm","vpdmax_fa","vpdmax_wt","vpdmax_sp","cwd_sum","cwd_wy") & value < out.low, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

xtreme_c_byyr<- plantation_clim_coldxtremes %>% 
  group_by(year) %>% 
  summarise(n=n()) 

ggplot(xtreme_c_byyr, aes(x=year, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("lightblue","navy"))

plantation_clim_wetextremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum") & value > out.hi, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

plantation_clim_wetextremes %>% 
  group_by(year) %>% 
  summarise(n=n())

ggplot(plantation_clim_long_qs %>% 
  filter(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum")), aes(x=year, y=value, color=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")+
  geom_line(data=plantation_clim_long_qs %>% 
  filter(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum")), aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs %>% 
  filter(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum")), aes(x=year, y=out.hi), col="black")+
  geom_hline(yintercept=0)

plantation_clim_long_qs %>% 
  filter(name=="FDSI") %>% 
  print(n=60)
```


##K Means

```{r}
##group provenances and plantation site into "climate groups"

#first look at correlations in climate variables
env_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(AHM:SHM,smrpb))

prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Gila NF") %>% 
  dplyr::select(c(AHM:SHM,smrpb,y)) %>% 
  cor()

###model mat x NFFD
tempmod <- lm(NFFD ~ MAT, data=prov_clim_adjusted_bi)
par(mfrow=c(2,2))
plot(tempmod)
summary(tempmod)

tmean = 3.4
13.051*tmean + 95.128

(140-95.128)/13.051

anna_piar<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/pifl_piar/PIAR sites and tested sites_aws.csv")


anna_piar_vect <- vect(anna_piar, geom=c("Site.Longitude", "Site.Latitude"), crs=crs(us))
tmean_annual <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/PRISM/PRISM_tmean_30yr_normal_800mM4_all_bil/PRISM_tmean_30yr_normal_800mM4_annual_bil.bil")
tmean_annual

ggplot()+
  geom_spatraster(data=tmean_annual)+
  geom_spatvector(data=anna_piar_vect %>% project(crs(tmean_annual)), col="pink")

anna_piar_tmean <- terra::extract(tmean_annual, anna_piar_vect %>% project(crs(tmean_annual)), method="simple")
anna_piar_clim <- terra::extract(clim_raster_stack, anna_piar_vect, method="simple")

piar_mat_NFFD_mod <- lm(NFFD ~ MAT, data=anna_piar_clim)
plot(piar_mat_NFFD_mod)
summary(piar_mat_NFFD_mod)

tmean = 3.4
11.1635*tmean + 87.4897     

(145-87.4897)/11.1635

###

env_vars %>% 
  cor() %>% 
  ggcorrplot()

env_vars %>% 
  cor() %>% 
  abs()>0.9

env_vars_cut <- env_vars %>% 
  dplyr::select(-c(bFFP, eFFP, FFP, EMT, PAS, DD18, DD5, DD0, PPTsm, Tavewt, Tavesm))

env_vars_cut %>%
  cor() %>% 
  abs()>0.9

#look at linearity of relationships

pairs(env_vars_cut, lower.panel = NULL)
pairs(env_vars_cut[-20,], lower.panel = NULL) #looking at it without Gila


prov_clim_adjusted_bi_wide <- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,AHM:SHM, smrpb, monsoonality))

rownames(prov_clim_adjusted_bi_wide)<- prov_clim_adjusted_bi_wide$Provenance

adjbi_prov_clim_eucdist <- vegdist(prov_clim_adjusted_bi_wide %>% dplyr::select(colnames(env_vars_cut)) %>% as.data.frame(), method="euclidean")

pam4<-pam(adjbi_prov_clim_eucdist,k=4)
pam4
pam4$clustering #view cluster membership
pam4$clusinfo
par(mfrow=c(1,1))
plot(pam4)

pam5<-pam(adjbi_prov_clim_eucdist,k=5)
pam5
pam5$clustering #view cluster membership
pam5$clusinfo
plot(pam5)

pam6<-pam(adjbi_prov_clim_eucdist,k=6)
pam6
pam6$clustering #view cluster membership
pam6$clusinfo
plot(pam6)

pam7<-pam(adjbi_prov_clim_eucdist,k=7)
pam7
pam7$clustering #view cluster membership - I think this is the best
pam7$clusinfo
plot(pam7)

pam8<-pam(adjbi_prov_clim_eucdist,k=8)
pam8
pam8$clustering #view cluster membership
pam8$clusinfo
plot(pam8)

pam7$silinfo$avg.width 
pam6$silinfo$avg.width 
pam5$silinfo$avg.width #5 groups best by this metric
pam4$silinfo$avg.width
pam8$silinfo$avg.width
```


##PCA

```{r, echo = FALSE}
#run the PCA 
set.seed(83)
clim_pca <- prcomp(env_vars_cut,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals <- (clim_pca$sdev)^2
eigenvals
sum(eigenvals) #the sum of the eigenvalues = the number of variables (9)
eigenvals/sum(eigenvals)#this is the proportion variance explained
summary(clim_pca)
par(mfrow=c(1,1))
plot(clim_pca,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts<- clim_pca$x %>% 
  cbind(prov_clim_adjusted_bi) %>% 
  left_join(prov_names) %>% 
  left_join(data.frame(cluster=pam5$clustering) %>% mutate(Provenance=rownames(data.frame(cluster=pam5$clustering))))

autoplot(clim_pca,x=1,y=2,colour="aquamarine3",loadings.colour="red", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.size=4)+
  geom_point(data=prov_pcapts, aes(x=PC1, y=PC2, col=factor(cluster)), size=5)+
  geom_text_repel(data=prov_pcapts, aes(x=PC1, y=PC2, label=code))+
  theme(text=element_text(size=14, color="black"))
  
autoplot(clim_pca,x=1,y=3,colour="aquamarine3",loadings.colour="red", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.size=6)+
  geom_point(data=prov_pcapts, aes(x=PC1, y=PC3, col=factor(cluster)), size=5)+
  geom_text_repel(data=prov_pcapts, aes(x=PC1, y=PC3, label=code))+
  theme(text=element_text(size=14, color="black"))
  
canada_crop <- crop(canada, ext(-126.92, -97.23, 41.6769, 52))
prov_pcapts_onlyprovs<- prov_pcapts %>% 
  filter(!Provenance=="Plantation")

provs_bylat <- prov_pcapts_onlyprovs %>% arrange(y)

###put pien distribution on map
pien_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Engelmann spruce (Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")
pigl_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/White spruce (Picea glauca) extent, North America/data/commondata/data0/piceglau.shp")
pipu_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Blue spruce (Picea pungens) extent, North America/data/commondata/data0/picepung.shp")
plot(pien_little_map)
pien_little_map_prj <- project(pien_little_map, crs(westernus))
pien_little_map_prj_crop <- crop(pien_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pigl_little_map_prj <- project(pigl_little_map, crs(westernus))
pigl_little_map_prj_crop <- crop(pigl_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pipu_little_map_prj <- project(pipu_little_map, crs(westernus))
pipu_little_map_prj_crop <- crop(pipu_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )

map <- ggplot()+
  geom_spatvector(data=westernus, col="grey", fill="gray100")+
  geom_spatvector(data=canada_crop, col="grey", fill="gray100")+
  geom_spatvector(data=pien_little_map_prj_crop, fill="wheat", col="wheat")+
  geom_spatvector(data=pigl_little_map_prj_crop, fill="thistle", col="thistle", alpha=0.6)+
  geom_spatvector(data=pipu_little_map_prj_crop, fill="paleturquoise", col="paleturquoise",alpha=.6)+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(!Provenance == "Plantation"), aes(fill=factor(Provenance, levels=provs_bylat$Provenance)), shape=24, size=1.5)+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(Provenance == "Plantation"), color="black", size=1.5)+
  geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(!Provenance == "Plantation"), aes(label=code), hjust=c(1.2,-.2,-.2,1.1,-.2,-.2,1,.1,0,1.2,-0.2,1.0, 1.1,1.0,0,1,-0.2,1.2,1,1.2), vjust=c(.4,0,0,0,0,0,1.3,1.4,1.3,rep(0,5),1.3,0,-.2,0,0,0), size=2.5)+
    geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(Provenance == "Plantation"), aes(label="Plantation"), hjust = 1, vjust=-0.4, col="black", size=2.5)+
  theme(panel.grid = element_blank(), legend.position = "none", axis.title=element_blank(), axis.text = element_text(color="black", size=8))+
  # ggspatial::annotation_scale(
  #   location = "bl",
  #   bar_cols = c("black", "white"),
  #     height = unit(0.1, "cm"),
  #   text_cex = 0.5) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style=north_arrow_fancy_orienteering(text_size=8, line_width = 0.8),
    height=unit(.25, "in"),
    width=unit(.25, "in"))

ext(pipu_little_map_prj)
ext(pigl_little_map_prj)

# png("figures/map.png", width=3, height=3, res=300, units = "in")
 map
# dev.off()

pcaplot <- autoplot(clim_pca,x=1,y=2,colour=NA,loadings.colour="gray80", loadings=T, loadings.label=T, loadings.label.colour="darkgrey", scale=0, loadings.label.size=1.5, loadings.label.hjust=1, loadings.label.vjust=1)+
  geom_point(data=prov_pcapts_onlyprovs, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=prov_pcapts_onlyprovs, aes(x=PC1, y=PC2, label=code), size=2,
            vjust = c(rep(-1,5),1.4,-1,-1,0, 1.4, rep(-1,7),1.4,1.4,-1),
            hjust = c(rep(0,8),-.3,rep(0,11)))+
  theme(text=element_text(size=14, color="black"))+
  geom_point(data=prov_pcapts %>% filter(Provenance=="Plantation"), aes(x=PC1, y=PC2), col="black", size=1.5)+
  geom_text(data=prov_pcapts %>% filter(Provenance=="Plantation"), aes(x=PC1, y=PC2, label=Provenance), size=2, hjust=1, vjust=-1)+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))
#   
# png("figures/pcaplot.png", width=3, height=3, res=300, units = "in")
 pcaplot
# dev.off()
 
 pcaplot2 <- autoplot(clim_pca,x=1,y=3,colour=NA,loadings.colour="gray80", loadings=T, loadings.label=T, loadings.label.colour="darkgrey", scale=0, loadings.label.size=1.5, loadings.label.hjust=0, loadings.label.vjust=-1)+
  geom_point(data=prov_pcapts_onlyprovs, aes(x=PC1, y=PC3, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=prov_pcapts_onlyprovs, aes(x=PC1, y=PC3, label=code), size=2,
            hjust = 0,
            vjust = c(rep(-1,5),1.4,-1,1.4,1.4,-1,1.4,rep(-1,6),1.4,-1,-1))+
  theme(text=element_text(size=14, color="black"))+
  geom_point(data=prov_pcapts %>% filter(Provenance=="Plantation"), aes(x=PC1, y=PC3), col="black", size=1.5)+
  geom_text(data=prov_pcapts %>% filter(Provenance=="Plantation"), aes(x=PC1, y=PC3, label=Provenance), size=2, hjust=1, vjust=1)+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

pcaplot2

png("figures/map_and_pca.png", width=6, height=3.5, res=300, units = "in")
ggarrange(map,ggarrange(pcaplot, pcaplot2, nrow=2, ncol=1, labels=c("B)","C)")), labels=c("A)",""))
dev.off()

##PC3 vs. latitude 
prov_pcapts %>% dplyr::select(PC3, y) %>% cor()

require(raster)
require(geosphere)

r <- raster(extent(-180, 180, -90, 90), res=0.1)
lat <- lon <- r
xy <- coordinates(r)
lat[] <- xy[, 2]

# set day
day=182

dl <- calc(lat, fun = function(x) daylength(x,day))
dl <- rast(dl)

dl_182_provs <- terra::extract(dl, adjusted_provs, method="simple")

dl_182_provs %>% bind_cols(crds(adjusted_provs)) %>% bind_cols(as.data.frame(adjusted_provs)) %>% View()

```

```{r}
plantation_pc1<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC1)

plantation_pc2<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC2)

plantation_pc3<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC3)

matrix(c(plantation_pc1, plantation_pc2, plantation_pc3), ncol=3)

pca_dist_df1 <- prov_pcapts %>% 
  mutate(PC1diff = abs(PC1-plantation_pc1), PC2diff = abs(PC2 - plantation_pc2)) %>% 
  mutate(dist.to.plant = sqrt(PC1diff^2 + PC2diff^2)) %>% 
  arrange(dist.to.plant) %>% 
  filter(!Provenance=="Plantation") 

dist_df_3d<-matrix(nrow=nrow(pca_dist_df1), ncol=1)
for(i in 1:nrow(pca_dist_df1)){
dist_df_3d[i,] <- dist(as.matrix(bind_rows(data.frame(PC1 = plantation_pc1, PC2 = plantation_pc2, PC3 = plantation_pc3), pca_dist_df1[i, c("PC1", "PC2", "PC3")])))}
  
pca_dist_df<- pca_dist_df1 %>% 
  bind_cols(data.frame(dist.to.plant.3d = dist_df_3d))
```

##Frost

```{r}
tmindata_30 <- read.csv("tmindata_30.csv")
tmindata_31 <- read.csv("tmindata_31.csv")

head(tmindata_30)
head(tmindata_31)

tmin_all<- bind_rows(tmindata_30, tmindata_31) %>% 
  mutate(date=mdy(paste(month,day,year,sep="-"))) %>% 
  arrange(date)

frost_days<- tmin_all %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(n=n())

ggplot(frost_days, aes(x=year, y=n))+
  geom_point()+
  geom_smooth(method="lm")
  
fd_mod <- lm(n ~ year, data=frost_days)
par(mfrow=c(2,2))
plot(fd_mod)
summary(fd_mod)

tmin_aves<- tmin_all %>% 
  group_by(month,day) %>% 
  summarise(ave_tmin=mean(tmin), se=sd(tmin)/sqrt(n()), n=n()) %>% 
  mutate(doy = ymd(paste("2000",month,day,sep="-")))

tmin_all_spring <- tmin_all %>% 
  filter(month %in% c(5,6,7)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(last_spring_frost = max(date)) %>% 
  bind_rows(data.frame(year=2009, last_spring_frost=as.Date("2009-05-14"))) %>% 
  mutate(day_of_last_spring_frost = as.numeric(yday(last_spring_frost)))

tmin_all_fall <- tmin_all %>% 
  filter(month %in% c(8,9,10)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(first_fall_frost = min(date)) %>%
  bind_rows(data.frame(year=2015, first_fall_frost=as.Date("2015-10-14"))) %>% 
  mutate(day_of_first_fall_frost = as.numeric(yday(first_fall_frost)))

plantation_frost <- left_join(tmin_all_spring, tmin_all_fall) %>% 
  dplyr::select(year, day_of_first_fall_frost, day_of_last_spring_frost) %>% 
  mutate(CN="Plantation")

vlines<- prov_clim_adjusted_bi %>% 
  dplyr::select(Provenance,bFFP,eFFP) %>% 
    mutate(bFFP_date = as.Date(bFFP, origin = "1999-12-31"),
           eFFP_date = as.Date(eFFP, origin = "1999-12-31")) %>% 
  arrange(bFFP) %>% 
  mutate(num = seq(-3.6,8.4,.6)) 

hlines <- vlines %>% 
  pivot_longer(bFFP_date:eFFP_date)


ggplot(tmin_aves, aes(x=doy, y=ave_tmin))+
  # geom_vline(data=vlines, aes(xintercept=bFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  # geom_vline(data=vlines, aes(xintercept=eFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_line(data=hlines, aes(x=value, y=num, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=3)+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=hlines, aes(x=ymd("2000-08-01"), y=num+.2, label=Provenance))+
  geom_point()+
  geom_errorbar(aes(ymin=ave_tmin-se, ymax=ave_tmin+se ))+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  theme_bw()
```

##PIEN climate niche

```{r}
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps")
states=c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","Kansas")
interiorwest <- us[match(toupper(states),toupper(us$NAME_1)),]
Wstates <- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","Kansas","California","Oregon","Washington","Oklahoma","Texas")
colorado <- us[match(toupper("Colorado"),toupper(us$NAME_1)),]
westernus <- us[match(toupper(Wstates),toupper(us$NAME_1)),]

pien <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/pien_range.tif")

pien2 <- classify(pien, cbind(-Inf, 0, NA), right=TRUE)
plot(pien2)

pien_trim<- trim(pien2)
plot(pien_trim)

engelmann_points_usonly <- spatSample(pien_trim, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
engelmann_clim_us <- terra::extract(clim_raster_stack, engelmann_points_usonly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##get points for Canada distribution from Mathys study and limit to only those within the boundary established by Little.
pien_mathys <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Current and predicted range of Engelmann spruce under climate change in the Pacific Northwest/data/commondata/data0/es_5075/w001001.adf")

pien_little <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")

pien_mathys2 <- classify(pien_mathys, cbind(-Inf, 0, NA), right=TRUE)
pien_mathys_crop_ca <- crop(pien_mathys2 %>% project(crs(canada)), canada %>% filter(NAME_1%in%c("Alberta","British Columbia")) ) %>% crop(pien_little %>% project(crs(canada))) %>%
  trim()

pien_mathys_little_ca_points <- spatSample(pien_mathys_crop_ca, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
pien_mathys_little_ca_points_crop <- crop(pien_mathys_little_ca_points, pien_little %>% project(crs(pien_mathys_little_ca_points)))
pien_mathys_little_ca_clim <- terra::extract(clim_raster_stack, pien_mathys_little_ca_points_crop %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##combine US and Canada climates
clim_pien<- bind_rows(pien_mathys_little_ca_clim,engelmann_clim_us)

ggplot()+
  geom_spatvector(data=engelmann_points_usonly %>% project(crs(canada)),size=0.05)+
  geom_spatvector(data=pien_mathys_little_ca_points_crop %>% project(crs(canada)), size=0.05)+
  geom_spatvector(data = canada, fill=NA, color="red")+
  geom_spatvector(data=westernus, fill=NA, color="red")


#### plotting climate variables
plantation_only <- prov_pcapts %>% filter(Provenance == "Plantation") %>% 
  mutate(period="1970s")

ggplot()+
  geom_spatvector(data=pien_mathys_little_ca_points %>% project(crs(us)))+
  geom_spatvector(data=engelmann_points_usonly)

plantation_future <- prov_futures_long %>% filter(Provenance=="Plantation") %>% 
  pivot_wider(names_from=climvar, values_from=value, id_cols = c(ID,Provenance,carbon,period))

plantation_all<- bind_rows(plantation_only, plantation_future)

carbon.colors<- c("black",brewer.pal(6,"RdBu")[c(6,5,2,1)])

plantation_2dclim_groups<- plantation_2dclim %>% 
  mutate(group=case_when(decade%in%c("70s","80s","90s") ~ "80s",
                         decade %in% c("00s","10s","20s") ~ "10s")) %>% 
  group_by(group) %>% 
  summarise(MAT=mean(MAT),MAP_ave=mean(MAP_ave))

# ggplot(clim_pien, aes(x=MAT, y=MAP))+
#   #stat_density_2d(geom="raster", aes(fill=after_stat(count)), n=100, contour=FALSE)+
#   geom_hex(bins=75)+
#   scale_fill_gradientn(colors=c("lightgray","black"))+
#   geom_point(data=plantation_all, aes(x=MAT, y=MAP, shape=period), col="gold", size=5)+
#   geom_point(data=prov_pcapts %>% filter(!Provenance=="Plantation"), aes(x=MAT, y=MAP, color=factor(Provenance, levels=provs_bylat$Provenance)), size=4)+
#     scale_color_manual(values=unname(stepped()), name="Provenance")+
#   ggnewscale::new_scale_fill()+
#   geom_point(data=plantation_2dclim_groups, aes(x=MAT, y=MAP_ave, fill=factor(group, levels=c("80s","10s"))), shape=23, col="black", size=3)+
#   scale_fill_manual(values=hcl.colors(n=2, palette="Batlow"))+
#   ggrepel::geom_text_repel(data=prov_pcapts %>% filter(!Provenance=="Plantation"), aes(label=code))+
#   theme_bw()+
#   ylim(c(250,2500))+
#   theme(text = element_text(size=16, color="black"))
```

### second PCA

```{r}
#run the PCA

##have to take out smrpb if I want to project into the future...or calculate it from ClimateNA variables

clim_pien_cor<- clim_pien %>% 
  dplyr::select(-ID) %>% 
    mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  cor()

ggcorrplot(clim_pien_cor, outline.color="white", type="lower", hc.order=TRUE)

ggplot(prov_clim_adjusted_bi, aes(x=y, y=FFP))+
  geom_point()

cor.test(prov_clim_adjusted_bi %>% filter(!Provenance=="Gila NF") %>% pull(y), prov_clim_adjusted_bi %>% filter(!Provenance=="Gila NF") %>% pull(NFFD))

pca2_clim_vars <- c("CMD","MCMT","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","TD","SMRPB_NA")

env_vars_pien<- clim_pien %>% 
  mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  dplyr::select(all_of(pca2_clim_vars))

env_vars_pien %>% 
  cor()

env_vars_noplant<- prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Plantation") %>% 
    mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  dplyr::select(colnames(env_vars_pien))

big_pca_data <- bind_rows(env_vars_noplant, env_vars_pien)
big_pca_data %>% 
  cor()

hist(big_pca_data$CMD)

set.seed(83)
clim_pca_big <- prcomp(big_pca_data,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals_pcabig<- (clim_pca_big$sdev)^2
eigenvals_pcabig
sum(eigenvals_pcabig) #the sum of the eigenvalues = the number of variables (9)
eigenvals_pcabig/sum(eigenvals_pcabig)#this is the proportion variance explained
summary(clim_pca_big)
par(mfrow=c(1,1))
plot(clim_pca_big,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts_big <- clim_pca_big$x[1:nrow(env_vars_noplant),] %>% 
  cbind(prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation")) %>% 
  left_join(prov_names)

plantation_clim_vars <- plantation_all %>% 
    mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  dplyr::select(c(period,colnames(env_vars_pien)))

big_pca_data_sum <- big_pca_data %>% 
  as.data.frame() %>% 
  mutate(id=seq(1:nrow(big_pca_data))) %>% 
  pivot_longer(CMD:SMRPB_NA) %>% 
  group_by(name) %>% 
  summarise(mean = mean(value), sd=sd(value))

scaled_plantation_futures<- plantation_clim_vars %>% 
  pivot_longer(CMD:SMRPB_NA) %>% 
  left_join(big_pca_data_sum) %>% 
  mutate(scaledvalue = (value - mean)/sd) %>% 
  dplyr::select(period,name,scaledvalue) %>% 
  pivot_wider(names_from="name", values_from = "scaledvalue") %>% 
  dplyr::select(-period)

plant_pca_scores <- data.frame(Provenance="Plantation",
                               period = plantation_all$period,
                               PC1 = (clim_pca_big$rotation[,1] %*% t(scaled_plantation_futures))[1,],
                               PC2 = (clim_pca_big$rotation[,2] %*% t(scaled_plantation_futures))[1,],
                               PC3 = (clim_pca_big$rotation[,3] %*% t(scaled_plantation_futures))[1,])

clim_pca_big

library("factoextra")

is.numeric(clim_pca_big$center)
is.numeric(clim_pca_big$scale)

t(t(clim_pca_big$x %*% t(clim_pca_big$rotation)) * clim_pca_big$scale + clim_pca_big$center)

big_pca_data

get_eigenvalue(clim_pca_big)
fviz_eig(clim_pca_big, addlabels=TRUE)
var<-get_pca_var(clim_pca_big)
var$coord


fviz_pca_var(clim_pca_big, col.var="black")
fviz_cos2(clim_pca_big, choice = "var", axes = 1)
fviz_pca_var(clim_pca_big, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )
head(var$contrib, 3)
library("corrplot")
corrplot(var$contrib, is.corr=FALSE) 
contrib.plot<- ggarrange(fviz_contrib(clim_pca_big, choice="var", axes=1, fill="wheat3", color="wheat3", title="PC1"),fviz_contrib(clim_pca_big, choice="var", axes=2,fill="wheat3", color="wheat3", title="PC2"), nrow=1)

fviz_contrib(clim_pca_big, choice="var", axes=3)

ggplot(data=as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1))), aes(x=rowname, y=PC1))+
  geom_bar(stat="identity") +
  geom_hline(yintercept=(1/12), color="red")

as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1))) %>% dplyr::select(-rowname) %>% abs() %>% colSums()

pcaplot_big <- autoplot(clim_pca_big,x=1,y=2,colour=NA,loadings.colour="gray80", loadings=T, loadings.label=T, loadings.label.colour="darkgrey", scale=0, loadings.label.size=1.5, loadings.label.hjust=1, loadings.label.vjust=1)+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=prov_pcapts_big, aes(x=PC1, y=PC2, label=code), size=2,
            vjust = c(rep(-1,5),1.4,-1,-1,0, 1.4, rep(-1,7),1.4,1.4,-1),
            hjust = c(rep(0,8),-.3,rep(0,11)))+
  theme(text=element_text(size=14, color="black"))+
  geom_point(data=plant_pca_scores , aes(x=PC1, y=PC2), col="black", size=1.5)+
  geom_text(data=plant_pca_scores, aes(x=PC1, y=PC2, label=period), size=2, hjust=1, vjust=-1)+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))
#   
# png("figures/pcaplot.png", width=3, height=3, res=300, units = "in")
 pcaplot_big
# dev.off()
 
pcaplot2_big <- autoplot(clim_pca_big,x=1,y=3,colour=NA,loadings.colour="gray80", loadings=T, loadings.label=T, loadings.label.colour="darkgrey", scale=0, loadings.label.size=1.5, loadings.label.hjust=1, loadings.label.vjust=1)+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC3, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=prov_pcapts_big, aes(x=PC1, y=PC3, label=code), size=2,
            vjust = c(rep(-1,5),1.4,-1,-1,0, 1.4, rep(-1,7),1.4,1.4,-1),
            hjust = c(rep(0,8),-.3,rep(0,11)))+
  theme(text=element_text(size=14, color="black"))+
  geom_point(data=plant_pca_scores , aes(x=PC1, y=PC3), col="black", size=1.5)+
  geom_text(data=plant_pca_scores, aes(x=PC1, y=PC3, label=period), size=2, hjust=1, vjust=-1)+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))
#   
 
pcaplot2_big


###pien climate niche
scores1 <- data.frame(clim_pca_big$x[,1:3])
# scores <- lapply(scores1, function(x) x / sqrt(sum((x - mean(x))^2)))
loadings <- as.data.frame(clim_pca_big$rotation)[1:3]
loadings_pc1pc2 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","PPTwt","PPTsp","CMD","MCMT","NFFD","MWMT"),]
loadings_pc1pc3 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","TD","PPTsm","NFFD","MCMT"),]
scale <- min(max(abs(scores1$PC1))/max(abs(loadings$PC1)),
             max(abs(scores1$PC2))/max(abs(loadings$PC2))) * 0.8

###test -- this is how you manually calculate contribution of variables to each PC. 
var_cor_func <- function(var.loadings, comp.sdev){var.loadings*comp.sdev}
var.cor <- t(apply(clim_pca_big$rotation, 1, var_cor_func, clim_pca_big$sdev))
var.cor  ##correlation
var.cor^2 ##cos2
comp.cos2 <- apply(var.cor^2, 2, sum)
contrib <- function(var.cos2, comp.cos2){var.cos2*100/comp.cos2}
var.contrib <- t(apply(var.cor^2,1, contrib, comp.cos2))
###

pc1_pc2_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=c(.1,.1,.1,.1,1,-.1,-.2,-.3), vjust=c(1.2,1.2,1.2,-1.2,1,1,1,1))+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance", guide="none")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=2)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC2 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[2]*100,1),"%)",sep=""))+
   xlim(-5,5)+
   ylim(-3,7.5)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc2_niche_plot.png", width=5, height=4, res=300, units = "in")
pc1_pc2_niche_plot
dev.off()
 

pc1_pc3_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC3))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc3 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC3),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc3 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc3)),
               aes(x = PC1, y = PC3, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC3, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC3, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=1.5)+
   xlim(-5,5)+
   ylim(-3,6)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC3 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[3]*100,1),"%)",sep=""))+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc3_niche_plot.png", width=3, height=3, res=300, units = "in")
pc1_pc3_niche_plot
dev.off()
 

figpca_legend <- get_legend( ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  xlim(-10,8)+
  ylim(-3,6)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8)) )

png("figures/map_and_bigpca_bluewhite.png", width=8.2, height=6.5, res=300, units = "in")
ggarrange(map,ggarrange(pc1_pc2_niche_plot, contrib.plot, nrow=2, ncol=1, labels=c("B)","C)")), labels=c("A)",""), ncol=2, nrow=1)
dev.off()


```


#Response variables

##DBH

```{r}
##DBH data is in centimeters
moniger_data <- read.csv("past_moniger_data.csv")
moniger_data_ids <- read.csv("past_moniger_data_ids.csv")

head(moniger_data_ids)
head(moniger_data)

moniger_data_comb <- moniger_data %>% 
  left_join(moniger_data_ids, by=c("LOC" = "ID.Code")) %>% 
  mutate(Provenance = ifelse(Location == "Larimer County 1","Larimer 1",
                                    ifelse(Location == "Larimer County 2","Larimer 2",Location))) %>% 
  left_join(prov_pcapts_big)

dbh = moniger_data_comb %>% 
  dplyr::select(c(SORT, LOC, BLK, REP, DBH91, DBH96, DBH06, DBH14, Provenance, code)) %>% 
  mutate(Series = paste(LOC,BLK,REP,sep="")) 

name_conversion<- data.frame(oldname = dbh %>% arrange(Provenance) %>% pull(Provenance) %>% unique(),
           newname = prov_names %>% filter(!Provenance=="Plantation") %>%  arrange(Provenance) %>% pull(Provenance) %>% unique())

dbh_long<- dbh %>% 
  #left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  #dplyr::select(-Provenance) %>% 
  #rename(Provenance = newname) %>% 
  filter(!is.na(DBH91)) %>% 
  pivot_longer(DBH91:DBH14, names_to = 'year', values_to = 'DBH')

provs_arranged_lat<- prov_pcapts_big %>% 
  arrange(y) %>% 
  pull(Provenance)
provs_arranged_lat

dbh_clim_data <- dbh_long %>% 
  left_join(prov_pcapts_big) %>% 
  filter(!is.na(DBH)) %>% 
  filter(!DBH==0) ##there is one with a dbh value of 0 which seems like an error.


#arranging provenances by different variables to visually identify patterns in DBH
ggplot(dbh_long, aes(x=factor(Provenance, levels=provs_arranged_lat), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

ggplot(dbh_clim_data, aes(x=factor(NFFD), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

ggplot(dbh_clim_data, aes(x=factor(CMD), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

```

###growth each year

```{r}

dbh_growth_data<- dbh %>% 
  mutate(areagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/5, areagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/10, areagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/8) %>% 
  mutate(areagrowth96=case_when(DBH96 == 0 ~ NA,
                         is.na(DBH96) ~ NA,
                         .default=areagrowth96),
         areagrowth06=case_when(DBH06 == 0 ~ NA,
                         is.na(DBH06) ~ NA,
                         .default=areagrowth06),
         areagrowth14=case_when(DBH14 == 0 ~ NA,
                         is.na(DBH14) ~ NA,
                         .default=areagrowth14)) %>% 
  pivot_longer(areagrowth96:areagrowth14) %>% 
  filter(!value<0) ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)

dbh_increment_plot<- ggplot(dbh_growth_data, aes(x=factor(Provenance, provs_bylat$Provenance), y=value, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("areagrowth96","areagrowth06","areagrowth14"), labels=c("1991-96","1996-2006","2006-14")), scales="free")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

dbh_increment_plot

# ##relativize by original BA
# dbh_growth_data_rel<- dbh %>% 
#   mutate(relareagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/(pi*(DBH91/2)^2)*100, relareagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/(pi*(DBH96/2)^2)*100, relareagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/(pi*(DBH06/2)^2)*100) %>% 
#   mutate(relareagrowth96=case_when(DBH96 == 0 ~ NA,
#                          is.na(DBH96) ~ NA,
#                          .default=relareagrowth96),
#          relareagrowth06=case_when(DBH06 == 0 ~ NA,
#                          is.na(DBH06) ~ NA,
#                          .default=relareagrowth06),
#          relareagrowth14=case_when(DBH14 == 0 ~ NA,
#                          is.na(DBH14) ~ NA,
#                          .default=relareagrowth14)) %>% 
#   pivot_longer(relareagrowth96:relareagrowth14) %>% 
#   filter(!value<0) %>%  ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)
#   left_join(prov_pcapts_big)
#   
# relba_plot<- ggplot(dbh_growth_data_rel, aes(x=factor(Provenance, provs_bylat$Provenance), y=value, fill=factor(Provenance, provs_bylat$Provenance)))+
#   geom_boxplot()+
#   facet_wrap(~factor(name, levels=c("relareagrowth96","relareagrowth06","relareagrowth14"), labels=c("1991-96","1996-2006","2006-14")), scales="free")+
#   ylab("Relativized Basal Area Growth (%)")+
#   xlab("")+
#   scale_fill_manual(values=unname(stepped()), name="Provenance")+
#   theme(axis.text.x=element_text(angle=45, hjust=1))
# 
# relba_plot

###analyze basal area growth data
aov_rDBH <- lmer(value ~ name*Provenance + (1|BLK), data=dbh_growth_data)
anova(aov_rDBH)

dbh_growth_clim<- dbh_growth_data %>% 
  left_join(prov_pcapts_big)

options(na.action="na.fail")
#y
mod_reldbh_pca_y_randtime <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
plot(mod_reldbh_pca_y_randtime)
qqmath(mod_reldbh_pca_y_randtime)
summary(mod_reldbh_pca_y_randtime)
mod_reldbh_pca_y_randtime_dredge<- dredge(mod_reldbh_pca_y_randtime)
mod_reldbh_pca_y_randtime_dredge

bestmod_reldbh_pca_y_randtime <- lmer(sqrt(value) ~  (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
summary(bestmod_reldbh_pca_y_randtime)

#no gila
dbh_growth_clim_noG<- dbh_growth_clim %>% filter(!Provenance=="Gila NF")

mod_reldbh_pca_y_randtime_noG <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
plot(mod_reldbh_pca_y_randtime_noG)
qqmath(mod_reldbh_pca_y_randtime_noG)
summary(mod_reldbh_pca_y_randtime_noG)
mod_reldbh_pca_y_randtime_noG_dredge<- dredge(mod_reldbh_pca_y_randtime_noG)
mod_reldbh_pca_y_randtime_noG_dredge

bestmod_reldbh_pca_y_randtime_noG <- lmer(sqrt(value) ~ scale(y)+ I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
summary(bestmod_reldbh_pca_y_randtime_noG)

#x
mod_reldbh_pca_x_randtime <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
plot(mod_reldbh_pca_x_randtime)
qqmath(mod_reldbh_pca_x_randtime)
summary(mod_reldbh_pca_x_randtime)
mod_reldbh_pca_x_randtime_dredge<- dredge(mod_reldbh_pca_x_randtime)
mod_reldbh_pca_x_randtime_dredge ##null is best, but the next best model has delta = 0.14, so I will do that one. 

bestmod_reldbh_pca_x_randtime <- lmer(sqrt(value) ~  PC2 + scale(x) + (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
summary(bestmod_reldbh_pca_x_randtime)

#no gila
mod_reldbh_pca_x_randtime_noG <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
plot(mod_reldbh_pca_x_randtime_noG)
qqmath(mod_reldbh_pca_x_randtime_noG)
summary(mod_reldbh_pca_x_randtime_noG)
mod_reldbh_pca_x_randtime_noG_dredge<- dredge(mod_reldbh_pca_x_randtime_noG)
mod_reldbh_pca_x_randtime_noG_dredge #null model is best

bestmod_reldbh_pca_x_randtime_noG <- lmer(sqrt(value) ~ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
summary(bestmod_reldbh_pca_x_randtime_noG) 

AICc(mod_reldbh_pca_x_randtime, mod_reldbh_pca_y_randtime) ##long is better
AICc(mod_reldbh_pca_x_randtime_noG, mod_reldbh_pca_y_randtime_noG) ##without Gila, lat is better


####make plot for best final model
bestmod_reldbh_pca_y_randtime_noG_lm <- lm(sqrt(value) ~ scale(y) + I(scale(y)^2), data=dbh_growth_clim_noG)

newdata_reldbh_y <-  expand.grid(y=seq(min(dbh_growth_clim_noG$y), max(dbh_growth_clim_noG$y), length.out=50))
reldbh_predict_y <- predict(bestmod_reldbh_pca_y_randtime_noG_lm, newdata = newdata_reldbh_y, interval="confidence")

predictdata_reldbh_y <- cbind(newdata_reldbh_y, reldbh_predict_y) %>% mutate(var="Latitude")

reldbh_y_plot <- ggplot()+
  geom_ribbon(data=predictdata_reldbh_y, aes(x=y, ymin=lwr^2, ymax=upr^2), alpha=0.2)+
  geom_line(data=predictdata_reldbh_y, aes(x=y,y=fit^2), color="black")+
  geom_rug(data=dbh_growth_clim_noG %>% mutate(fit=5), aes(x=y,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance Latitude")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
reldbh_y_plot
```

###models

####ANOVA

```{r}
dbh_numeric <- dbh_clim_data %>% 
  mutate(num.yr = as.numeric(ifelse(year=="DBH91", 1,
                         ifelse(year=="DBH96", 6,
                                ifelse(year=="DBH06", 16,
                                       ifelse(year=="DBH14", 24, year))))))

dbh_aov <- lmer(DBH ~ year*Provenance + (1|BLK), data = dbh_numeric)
plot(dbh_aov)
summary(dbh_aov)
anova(dbh_aov) #no significant interaction
rand(dbh_aov)
Anova(dbh_aov, type="3")
dbh_aov_noint <- lmer(DBH ~ year + Provenance + (1|BLK), data = dbh_numeric)
Anova(dbh_aov_noint, type="2") #both year and provenance are significant but do not interact (relatively similar order of provenance DBH in each year measured)
summary(dbh_aov_noint)
rand(dbh_aov_noint)

prov_dbh_order<- dbh_numeric %>% 
  filter(year=="DBH14") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)
dbh_numeric %>% 
  filter(year=="DBH06") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)
dbh_numeric %>% 
  filter(year=="DBH96") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)
dbh_numeric %>% 
  filter(year=="DBH91") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)

dbh_early<- ggplot(dbh_numeric %>% filter(!year=="DBH14"), aes(x=factor(year, levels=c("DBH91","DBH96","DBH06"), labels=c(1991,1996,2006)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_x_discrete(name="Year")

dbh_2014<- ggplot(dbh_numeric %>% filter(year=="DBH14"), aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_x_discrete(name="Year")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()

ggarrange(dbh_early,dbh_2014, nrow=2, common.legend = TRUE)

dbh_plot<- ggplot(dbh_numeric %>% filter(year=="DBH14"), aes(x=factor(Provenance, levels=prov_dbh_order$Provenance), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  #geom_text(data=data.frame(Provenance = c("Gila NF","Dixie NF","Cutting Permit 31"), symbol = c("B","B","A")), aes(x=Provenance, y=25, label=symbol))+
  theme_bw()+
  theme(legend.position = "none", axis.text.x = element_text(angle=45, color="black", size=8, hjust=1), axis.title.x = element_blank(), axis.text.y = element_text(color="black", size=8), axis.title.y = element_text(color="black", size=10))

###model each year separately
dbh_aov91 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH91"))

plot(dbh_aov91)
anova(dbh_aov91)
rand(dbh_aov91)

dbh_aov91_marg = lsmeans(dbh_aov91, ~ Provenance)

CLD_dbh_aov91 = cld(dbh_aov91_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov91 #payette greater than 12, gila less than 10

dbh_aov96 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH96"))
plot(dbh_aov96)
anova(dbh_aov96)
dbh_aov96_marg = lsmeans(dbh_aov96, ~ Provenance)

CLD_dbh_aov96 = cld(dbh_aov96_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov96 #payette greater than 12, gila less than 10, cache less than 13

  
dbh_aov06 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH06"))
plot(dbh_aov06)
anova(dbh_aov06)
dbh_aov06_marg = lsmeans(dbh_aov06, ~ Provenance)

CLD_dbh_aov06 = cld(dbh_aov06_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov06 #payette greater than 13, gila less than 13

dbh_numeric14 <- dbh_numeric %>% filter(year=="DBH14") %>% 
  mutate(Provenance=as.factor(Provenance))

dbh_aov14 <- lmer(DBH ~ Provenance + (1|BLK), data =dbh_numeric14)
plot(dbh_aov14)
anova(dbh_aov14)
dbh_aov14_marg = lsmeans(dbh_aov14, ~ Provenance)

CLD_dbh_aov14 = cld(dbh_aov14_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov14 #payette greater than 15, gila less than 13

dbh14_letter_df<- as.data.frame(CLD_dbh_aov14) %>% 
  rename(letters = `.group`)

dbh_letters_plot<- ggplot(dbh_numeric14, aes(x=factor(Provenance, levels=prov_dbh_order$Provenance), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  geom_text(data=dbh14_letter_df, aes(x=Provenance, y= 30, label=letters), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("DBH (cm)")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=45, hjust=1, color="black",size=14), axis.text.y=element_text(color="black",size=14),axis.title.y=element_text(color="black",size=14), axis.title.x=element_blank(),legend.position = "none")
  

dbh_aves <- dbh_numeric %>% 
  group_by(Provenance,year) %>% 
  summarise(meanDBH=mean(DBH),se_DBH=sd(DBH)/sqrt(n())) %>% 
  mutate(year= case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996)) %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,1985), meanDBH=NA, se_DBH=NA))

dbh_means_fig <- ggplot(dbh_aves, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meanDBH, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meanDBH-se_DBH, ymax=meanDBH+se_DBH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean DBH (cm)")


```

####distance - cut
```{r, eval=FALSE}
##does DBH vary with climate vars?


#just get most recent DBH measurement 
dbh_num14 <- dbh_numeric %>% filter(year=="DBH14")
##distance in PCA space from plantation
dbh_num14_pcadist<- dbh_num14 %>% 
  left_join(pca_dist_df %>% dplyr::select(code, dist.to.plant, dist.to.plant.3d))


#distance models
dbh_num14_alldist <- dbh_num14_pcadist %>% 
  left_join(geo.dist.df)

dbh_num14_alldist %>% dplyr::select(PC1,PC2,dist.to.plant,geo.dist.to.plant.km,x,y) %>% cor()

dbh_num14_alldist_noG3 <- dbh_num14_alldist %>% 
  filter(!Provenance%in% c("Gila NF","Wenatchee NF","Okanogan NF"))

dbh_num14_alldist_noG <- dbh_num14_alldist %>% 
  filter(!Provenance%in% c("Gila NF"))

mod_dbh_dist <- lmer(DBH ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)
plot(mod_dbh_dist)
qqmath(mod_dbh_dist)
summary(mod_dbh_dist)
options(na.action="na.fail")
dredge(mod_dbh_dist)
# install.packages("influence.ME")
# infl_mod_dbh_dist<- influence(mod_dbh_dist, obs=TRUE)
# dbh_dist_cooks<- data.frame(cooks=cooks.distance(mod_dbh_dist), obs=seq(1,length(cooks.distance(mod_dbh_dist)),1)) %>% 
#   cbind(dbh_num14_alldist)
# 
# ggplot(dbh_dist_cooks, aes(x=factor(obs), y=cooks, col=Provenance))+
#   geom_point()
#   
# (2*3 +2)/655

mod_dbh_dist_nog <- lmer(DBH ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist_noG)
plot(mod_dbh_dist_nog)
qqmath(mod_dbh_dist_nog)
summary(mod_dbh_dist_nog)
dredge(mod_dbh_dist_nog)

mod_dbh_dist2 <- lmer(DBH ~ scale(geo.dist.to.plant.km) * scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)
plot(mod_dbh_dist2)
qqmath(mod_dbh_dist2)
summary(mod_dbh_dist2)

dbh_int_plot <- interact_plot(mod_dbh_dist2, pred=geo.dist.to.plant.km, modx=dist.to.plant.3d, plot.points=TRUE, interval = TRUE, int.type = "confidence", int.width=0.95, data=dbh_num14_alldist, x.label = "Geographic distance to plantation (km)", y.label = "DBH (cm)", legend.main = "Climatic Distance", colors="Greys")

mod_dbh_dist2_noG <- lmer(DBH ~ scale(geo.dist.to.plant.km) * scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist_noG)
plot(mod_dbh_dist2_noG)
qqmath(mod_dbh_dist2_noG)
summary(mod_dbh_dist2_noG)

ggplot(dbh_num14_alldist, aes(x=geo.dist.to.plant.km, y=DBH, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(dbh_num14_alldist, aes(x=dist.to.plant.3d, y=DBH, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

##predict model
mod_dbh_dist2_lm <- lm(DBH ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d), data=dbh_num14_alldist)
leveragePlots(mod_dbh_dist2_lm)

dbh_dist_newdata <- with(dbh_num14_alldist, data.frame(geo.dist.to.plant.km = seq(min(geo.dist.to.plant.km),max(geo.dist.to.plant.km),length.out=100), 
                                                       dist.to.plant.3d = mean(dist.to.plant.3d)))
dbh_dist_predict <- predict(mod_dbh_dist2_lm, newdata=dbh_dist_newdata, interval="confidence")

dbh_dist_pred_data <- cbind(dbh_dist_newdata,dbh_dist_predict)

dbh_dist_plot <- ggplot()+
  geom_point(data=dbh_num14_alldist, aes(x=geo.dist.to.plant.km, y=DBH, col=factor(Provenance, levels=factor(provs_bylat$Provenance))))+
  geom_ribbon(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km,y=fit), color="black")+
  xlab("Geographic distance to plantation (km)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position = "none")


```

####PCA
```{r}
#get data in order
dbh_num14 <- dbh_numeric %>% filter(year=="DBH14")
##distance in PCA space from plantation
dbh_num14_pcadist<- dbh_num14 %>% 
  left_join(pca_dist_df %>% dplyr::select(code, dist.to.plant, dist.to.plant.3d))

dbh_num14_alldist <- dbh_num14_pcadist %>% 
  left_join(geo.dist.df)

dbh_num14_alldist %>% dplyr::select(PC1,PC2,dist.to.plant,geo.dist.to.plant.km,x,y) %>% cor()

dbh_num14_alldist_noG3 <- dbh_num14_alldist %>% 
  filter(!Provenance%in% c("Gila NF","Wenatchee NF","Okanogan NF"))

dbh_num14_alldist_noG <- dbh_num14_alldist %>% 
  filter(!Provenance%in% c("Gila NF"))

##PCs and x 
mod_dbh_pca_x <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + + I(PC1^2) + I(PC2^2) + + I(scale(x)^2) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)
plot(mod_dbh_pca_x)
qqmath(mod_dbh_pca_x)
summary(mod_dbh_pca_x)
options(na.action="na.fail")
dredge(mod_dbh_pca_x)

bestmod_dbh_pca_x <- lmer(DBH ~ scale(x) + PC2 + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)

summary(bestmod_dbh_pca_x)

##PCs and y 
mod_dbh_pca_y <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)
plot(mod_dbh_pca_y)
qqmath(mod_dbh_pca_y)
summary(mod_dbh_pca_y)
dredge(mod_dbh_pca_y)

AICc(mod_dbh_pca_x, mod_dbh_pca_y) #long is better

bestmod_dbh_pca_y <- lmer(DBH ~ PC2 + scale(y) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)
summary(bestmod_dbh_pca_y)

AICc(bestmod_dbh_pca_x, bestmod_dbh_pca_y) #long is better

ggplot(dbh_num14_alldist, aes(x=PC2, y=DBH))+
  geom_point()+
  geom_smooth(method="glm")

ggplot(dbh_num14_alldist, aes(x=x, y=DBH))+
  geom_point()+
  geom_smooth(method="glm")

##no gila
mod_dbh_pca_x_nog <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist_noG)
plot(mod_dbh_pca_x_nog)
qqmath(mod_dbh_pca_x_nog)
summary(mod_dbh_pca_x_nog)
dredge(mod_dbh_pca_x_nog)

bestmod_dbh_pca_x_nog <- lmer(DBH ~ scale(x) + PC2 + (1|Provenance) + (1|BLK), data=dbh_num14_alldist_noG)
summary(bestmod_dbh_pca_x_nog) #x and PC2 still significant when you take out Gila. 
mod_dbh_pca_y_nog <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist_noG)

AICc(mod_dbh_pca_x_nog,mod_dbh_pca_y_nog)

###make plots

##long
#just use lm
bestmod_dbh_pca_x_lm <- lm(DBH ~ scale(x) + PC2, data=dbh_num14_alldist)
summary(bestmod_dbh_pca_x_lm)

newdata_dbh_lm <-  expand.grid(x=seq(min(dbh_num14_alldist$x),max(dbh_num14_alldist$x),length.out=50),
            PC2=mean(dbh_num14_alldist$PC2))
dbh_predict_lm <- predict(bestmod_dbh_pca_x_lm, newdata = newdata_dbh_lm, interval="confidence")

predictdatadbh_lm <- cbind(newdata_dbh_lm, dbh_predict_lm)

dbh_long_plot<- ggplot()+
  geom_point(data=dbh_num14_alldist, aes(x=x, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdatadbh_lm, aes(x=x, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdatadbh_lm, aes(x=x,y=fit))+
  xlab("Longitude")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position="none")
#

##pc2

##just use lm
newdata_dbh_pc2 <-  expand.grid(x=mean(dbh_num14_alldist$x),
            PC2=seq(min(dbh_num14_alldist$PC2),max(dbh_num14_alldist$PC2),length.out=50))
dbh_predict_pc2 <- predict(bestmod_dbh_pca_x_lm, newdata = newdata_dbh_pc2, interval="confidence")

predictdatadbh_pc2 <- cbind(newdata_dbh_pc2, dbh_predict_pc2)

dbh_pc2_plot <- ggplot()+
  geom_point(data=dbh_num14_alldist, aes(x=PC2, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdatadbh_pc2, aes(x=PC2, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdatadbh_pc2, aes(x=PC2,y=fit), color="black")+
  xlab("PC2 (cold to hot)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position="none")

ggarrange(dbh_long_plot, dbh_pc2_plot, common.legend = TRUE)
```

#####with year
```{r}

dbh_numeric_time <- dbh_numeric %>% 
  mutate(year=case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996))
dbh_numeric_time_noG <- dbh_numeric_time %>% filter(!Provenance=="Gila NF")


##PCs and x 
mod_dbh_pca_x_time <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + scale(year) + scale(year)*PC1 + scale(year)*PC2 + scale(year)*scale(x) + scale(year)*I(PC1^2) + scale(year)*I(PC2^2) + scale(year)*I(scale(x)^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time)
plot(mod_dbh_pca_x_time)
qqmath(mod_dbh_pca_x_time)
summary(mod_dbh_pca_x_time)
# mod_dbh_pca_x_time_dredge<- dredge(mod_dbh_pca_x_time)
# saveRDS(mod_dbh_pca_x_time_dredge,"mod_dbh_pca_x_time_dredge_011725.RDS")
mod_dbh_pca_x_time_dredge <- readRDS("mod_dbh_pca_x_time_dredge_011725.RDS")
mod_dbh_pca_x_time_dredge

bestmod_dbh_pca_x_time <- lmer(DBH ~ scale(year)*scale(x) + scale(year)*PC2 + (1|Provenance) + (1|BLK), data=dbh_numeric_time)
summary(bestmod_dbh_pca_x_time)

#####no Gila
mod_dbh_pca_x_time_noG <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + scale(year) + scale(year)*PC1 + scale(year)*PC2 + scale(year)*scale(x) + scale(year)*I(PC1^2) + scale(year)*I(PC2^2) + scale(year)*I(scale(x)^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_noG)
# mod_dbh_pca_x_time_noG_dredge<- dredge(mod_dbh_pca_x_time_noG)
# saveRDS(mod_dbh_pca_x_time_noG_dredge,"mod_dbh_pca_x_time_noG_dredge_012125.RDS")
mod_dbh_pca_x_time_noG_dredge <- readRDS("mod_dbh_pca_x_time_noG_dredge_012125.RDS")
mod_dbh_pca_x_time_noG_dredge

bestmod_dbh_pca_x_time_noG <- lmer(DBH ~ scale(year)+ scale(x) + PC2 + (1|Provenance) + (1|BLK), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_x_time_noG)


##PCs and y 
mod_dbh_pca_y_time <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + scale(year) + scale(year)*PC1 + scale(year)*PC2 + scale(year)*scale(y) + scale(year)*I(PC1^2) + scale(year)*I(PC2^2) + scale(year)*I(scale(y)^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time)
plot(mod_dbh_pca_y_time)
qqmath(mod_dbh_pca_y_time)
summary(mod_dbh_pca_y_time)
# mod_dbh_pca_y_time_dredge<- dredge(mod_dbh_pca_y_time)
# saveRDS(mod_dbh_pca_y_time_dredge,"mod_dbh_pca_y_time_dredge_011725.RDS")
mod_dbh_pca_y_time_dredge <- readRDS("mod_dbh_pca_y_time_dredge_011725.RDS")
mod_dbh_pca_y_time_dredge

bestmod_dbh_pca_y_time <- lmer(DBH ~ scale(year) + scale(y) + PC2 + (1|Provenance) + (1|BLK), data=dbh_numeric_time)
summary(bestmod_dbh_pca_y_time) 

#####no Gila
mod_dbh_pca_y_time_noG <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + scale(year) + scale(year)*PC1 + scale(year)*PC2 + scale(year)*scale(y) + scale(year)*I(PC1^2) + scale(year)*I(PC2^2) + scale(year)*I(scale(y)^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_noG)
# mod_dbh_pca_y_time_noG_dredge<- dredge(mod_dbh_pca_y_time_noG)
# saveRDS(mod_dbh_pca_y_time_noG_dredge,"mod_dbh_pca_y_time_noG_dredge_012125.RDS")
mod_dbh_pca_y_time_noG_dredge <- readRDS("mod_dbh_pca_y_time_noG_dredge_012125.RDS")
mod_dbh_pca_y_time_noG_dredge

bestmod_dbh_pca_y_time_noG <- lmer(DBH ~ I(scale(y)^2)*scale(year) + scale(y) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_y_time_noG) 

interact_plot(bestmod_dbh_pca_y_time_noG, pred = y, modx=year, plot.points=TRUE, interval=TRUE, int.width=0.95)

AICc(mod_dbh_pca_x_time, mod_dbh_pca_y_time) #long is better
AICc(mod_dbh_pca_x_time_noG, mod_dbh_pca_y_time_noG) #lat is better when Gila is removed

AICc(bestmod_dbh_pca_x_time, bestmod_dbh_pca_y_time) #long is better
AICc(bestmod_dbh_pca_x_time_noG, bestmod_dbh_pca_y_time_noG) #lat is better when Gila is removed

###try year as a random effect
#y
mod_dbh_pca_y_randtime <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
plot(mod_dbh_pca_y_randtime)
qqmath(mod_dbh_pca_y_randtime)
summary(mod_dbh_pca_y_randtime)
mod_dbh_pca_y_randtime_dredge<- dredge(mod_dbh_pca_y_randtime)
mod_dbh_pca_y_randtime_dredge

bestmod_dbh_pca_y_randtime <- lmer(DBH ~ scale(y) + PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
summary(bestmod_dbh_pca_y_randtime)

#no gila

mod_dbh_pca_y_randtime_noG <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_y_randtime_noG)
qqmath(mod_dbh_pca_y_randtime_noG)
summary(mod_dbh_pca_y_randtime_noG)
mod_dbh_pca_y_randtime_noG_dredge<- dredge(mod_dbh_pca_y_randtime_noG)
mod_dbh_pca_y_randtime_noG_dredge

bestmod_dbh_pca_y_randtime_noG <- lmer(DBH ~ I(scale(y)^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_y_randtime_noG)



#x
mod_dbh_pca_x_randtime <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
plot(mod_dbh_pca_x_randtime)
qqmath(mod_dbh_pca_x_randtime)
summary(mod_dbh_pca_x_randtime)
mod_dbh_pca_x_randtime_dredge<- dredge(mod_dbh_pca_x_randtime)
mod_dbh_pca_x_randtime_dredge

bestmod_dbh_pca_x_randtime <- lmer(DBH ~ scale(x) + PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
summary(bestmod_dbh_pca_x_randtime)

#no gila
mod_dbh_pca_x_randtime_noG <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_x_randtime_noG)
qqmath(mod_dbh_pca_x_randtime_noG)
summary(mod_dbh_pca_x_randtime_noG)
mod_dbh_pca_x_randtime_noG_dredge<- dredge(mod_dbh_pca_x_randtime_noG)
mod_dbh_pca_x_randtime_noG_dredge

bestmod_dbh_pca_x_randtime_noG <- lmer(DBH ~ scale(x) + PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_x_randtime_noG)


AICc(mod_dbh_pca_x_randtime, mod_dbh_pca_y_randtime)
AICc(bestmod_dbh_pca_x_randtime, bestmod_dbh_pca_y_randtime) ##long is better

AICc(mod_dbh_pca_x_randtime_noG, mod_dbh_pca_y_randtime_noG) ##without Gila, lat is better
AICc(bestmod_dbh_pca_x_randtime_noG, bestmod_dbh_pca_y_randtime_noG) 

###FINAL MODEL TO USE#####
summary(bestmod_dbh_pca_y_randtime_noG)

####make plot for best final model
bestmod_dbh_pca_y_randtime_noG_lm <- lm(DBH ~ I(scale(y)^2), data=dbh_numeric_time_noG)

newdata_dbh_y <-  expand.grid(y=seq(min(dbh_numeric_time_noG$y), max(dbh_numeric_time_noG$y), length.out=50))
dbh_predict_y <- predict(bestmod_dbh_pca_y_randtime_noG_lm, newdata = newdata_dbh_y, interval="confidence")

predictdatadbh_y <- cbind(newdata_dbh_y, dbh_predict_y) %>% mutate(var="Latitude")

dbh_y_plot <- ggplot()+
  geom_ribbon(data=predictdatadbh_y, aes(x=y, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdatadbh_y, aes(x=y,y=fit), color="black")+
  geom_rug(data=dbh_numeric_time_noG %>% mutate(fit=9), aes(x=y,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance Latitude")+
  ylab("DBH (cm)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
dbh_y_plot

```

```{r}
##all 3 PCs
mod_dbh_pcs <- lmer(DBH ~ PC1*PC2 + PC1*PC3 + PC2*PC3 + I(PC1^2) + I(PC2^2) + I(PC3^2) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist)
plot(mod_dbh_pcs)
qqmath(mod_dbh_pcs)
summary(mod_dbh_pcs)
dredge(mod_dbh_pcs)

AICc(mod_dbh_pca_x, mod_dbh_pca_y, mod_dbh_pcs) ##model with latitude has the lowest AICc

mod_dbh_pcs_nog <- lmer(DBH ~ PC1*PC2 + PC1*PC3 + PC2*PC3 + I(PC1^2) + I(PC2^2) + I(PC3^2) + (1|Provenance) + (1|BLK), data=dbh_num14_alldist_noG)
plot(mod_dbh_pcs_nog)
qqmath(mod_dbh_pcs_nog)
summary(mod_dbh_pcs_nog)
dredge(mod_dbh_pcs_nog) ##null model is best again
```

####individual climate var models
```{r}

colnames(dbh_num14)

provenance_climvars <- dbh_num14 %>% 
  dplyr::select(AHM:SHM, smrpb, monsoonality) %>% 
  colnames()

dbh_num14_long <- dbh_num14 %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality))

dbh_numeric_time_long <- dbh_numeric_time %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality))

dbh_mods<- data.frame()
dbh_num14_nog <- dbh_num14 %>% filter(!Provenance=="Gila NF")
for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

dbh_mods <- bind_rows(dbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

dbh_mods %>% arrange(pvalue_nog)

###quadratic

dbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_mods_quad <- bind_rows(dbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ggplot(dbh_num14_long %>% filter(!Provenance=="Gila NF"), aes(x=value, y=DBH, col=name))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~name, scales="free")

dbh_mods_quad %>% arrange(pvalue2_nog) #nothing significant
```

```{r}
##testing for each year separately

##1991
dbh_mods91<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + (1|Provenance)+(1|BLK) , data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i] & year=="1991"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_long %>% filter(!Provenance=="Gila NF") %>% filter(name==provenance_climvars[i]& year=="1991"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

dbh_mods91 <- bind_rows(dbh_mods91, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

dbh_mods91 %>% arrange(pvalue_nog) 
###quadratic

dbh_mods_quad91<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]& year=="1991"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_long %>% filter(!Provenance=="Gila NF")  %>% filter(name==provenance_climvars[i]& year=="1991"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_mods_quad91 <- bind_rows(dbh_mods_quad91, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

dbh_mods_quad91 %>% arrange(pvalue2_nog) 
##1996
dbh_mods96<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + (1|Provenance)+(1|BLK) , data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i] & year=="1996"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_long %>% filter(!Provenance=="Gila NF")  %>% filter(name==provenance_climvars[i]& year=="1996"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

dbh_mods96 <- bind_rows(dbh_mods96, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

dbh_mods96 %>% arrange(pvalue) 
###quadratic

dbh_mods_quad96<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]& year=="1996"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_long %>% filter(!Provenance=="Gila NF")  %>% filter(name==provenance_climvars[i]& year=="1996"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_mods_quad96 <- bind_rows(dbh_mods_quad96, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

dbh_mods_quad96 %>% arrange(pvalue2_nog) 



##2006
dbh_mods06<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + (1|Provenance)+(1|BLK) , data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i] & year=="2006"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_long %>% filter(!Provenance=="Gila NF")  %>% filter(name==provenance_climvars[i]& year=="2006"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

dbh_mods06 <- bind_rows(dbh_mods06, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

dbh_mods06 %>% arrange(pvalue)
###quadratic

dbh_mods_quad06<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]& year=="2006"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK), data=dbh_numeric_time_long %>% filter(!Provenance=="Gila NF")  %>% filter(name==provenance_climvars[i]& year=="2006"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_mods_quad06 <- bind_rows(dbh_mods_quad06, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

dbh_mods_quad06 %>% arrange(pvalue2_nog) 

```

#####growth increment
```{r}

provenance_climvars <- dbh_num14 %>% 
  dplyr::select(AHM:SHM, smrpb, monsoonality) %>% 
  colnames()

dbh_growth_clim_long <- dbh_growth_clim %>%
  rename(year=name, relDBH = value) %>% 
  pivot_longer(c(AHM:SHM,smrpb,monsoonality))

dbh_growth_clim_long_noG <- dbh_growth_clim_long %>% 
  filter(!Provenance=="Gila NF")

reldbh_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relDBH ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(relDBH ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long_noG %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

reldbh_mods <- bind_rows(reldbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

reldbh_mods %>% arrange(pvalue_nog) #nothing significant


###quadratic

reldbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relDBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(relDBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_clim_long_noG %>% filter(name==provenance_climvars[i]))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

reldbh_mods_quad <- bind_rows(reldbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

reldbh_mods_quad %>% arrange(pvalue2_nog) #nothing significant

```


##Height Growth

```{r}

colnames(moniger_data_comb)

ggplot(moniger_data_comb, aes(x=factor(CMD), y=HT14, fill=Provenance))+
  geom_boxplot()+
  theme(legend.position = 'right', axis.text.x = element_text(angle=45, hjust=1))

ht_data <- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  mutate(growth.m = (value-nursery_ht_m), rel.growth = (value-nursery_ht_m)/nursery_ht_m) %>% 
  filter(!is.na(value))

ht_data_clim <- ht_data %>% 
  left_join(prov_pcapts)

ht.order <- ht_data %>% 
  filter(name=="HT14") %>% 
  group_by(Provenance) %>% 
  summarise(med_rel_growth=median(rel.growth,na.rm=T), med_growth=median(growth.m, na.rm=T), meanht = mean(value, na.rm=T)) %>% 
  arrange(meanht)

#relative growth
ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(Provenance, levels=ht.order$Provenance), y=rel.growth, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), scales="free")+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")+
  theme(axis.text.x = element_blank())

#growth
ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(Provenance, levels=ht.order$Provenance), y=growth.m, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), scales="free")+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")+
  theme(axis.text.x = element_blank())


ht_data_aves <- ht_data %>% filter(!name=="HT74") %>% 
  group_by(name, Provenance,nursery_ht_m ) %>% 
  summarise(meangrowth = mean(growth.m), seRG = sd(growth.m)/sqrt(n()), meantotht = mean(value), seTH = sd(value)/sqrt(n()))

ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=growth.m, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meangrowth-seRG, ymax=meangrowth+seRG, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Average relative growth ratio")
 
nursery_ht_clim <- ht_data_clim %>% 
  dplyr::select(c(Provenance, nursery_ht_m, PC1,PC2, AHM:SHM, smrpb)) %>% 
  unique() %>% 
  pivot_longer(PC1:smrpb)
  
ggplot(nursery_ht_clim %>% filter(name %in% c("MAT","MCMT","NFFD","smrpb")), aes(x=value, y=nursery_ht_m))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~name, scales="free")

nursery_climvars <- unique(nursery_ht_clim$name)
nursery_lms <- data.frame()
for(i in 1:length(nursery_climvars)){
  mod <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == nursery_climvars[i]))
  pvalue <- as.data.frame(summary(mod)$coefficients)$`Pr(>|t|)`[2]
  mod_nog <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == nursery_climvars[i]) %>% filter(!Provenance == "Gila NF"))
  pvalue_nog <- as.data.frame(summary(mod_nog)$coefficients)$`Pr(>|t|)`[2]
  nursery_lms <- bind_rows(nursery_lms, data.frame(nursery_climvars=nursery_climvars[i],pvalue,pvalue_nog))
}
nursery_lms %>% arrange(pvalue)  


nursery_lms_nog <- data.frame()
for(i in 1:length(nursery_climvars)){
  mod <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == nursery_climvars[i]))
  pvalue <- as.data.frame(summary(mod)$coefficients)$`Pr(>|t|)`[2]
  nursery_lms_nog <- bind_rows(nursery_lms_nog, data.frame(nursery_climvars=nursery_climvars[i],pvalue))
}
nursery_lms_nog %>% arrange(pvalue)

##initial height effect on height growth -- looks like there isn't really one
ggplot(data=ht_data_aves, aes(x=nursery_ht_m, y=meangrowth))+
  geom_point()

ggplot(data=ht_data_aves, aes(x=nursery_ht_m, y=meantotht))+
  geom_point()

```

###growth each year

```{r}
ht_growth_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  mutate(growth79=HT79-HT74, growth85 = HT85-HT79, growth91 = HT91-HT85, growth96=HT96-HT91, growth06=HT06-HT96, growth14=HT14-HT06) %>% 
  mutate(growth79rel=(growth79/HT74*100)/5, growth85rel=(growth85/HT79*100)/6, growth91rel=(growth91/HT85*100)/6, growth96rel=(growth96/HT91*100)/5, growth06rel=(growth06/HT96*100)/10, growth14rel=(growth14/HT06*100)/8) %>% 
  pivot_longer(growth79:growth14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37)

ht_increment_plot<- ggplot(ht_growth_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79","growth85","growth91","growth96","growth06","growth14")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Height Increment")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

ht_growth_rel_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  mutate(growth79=HT79-HT74, growth85 = HT85-HT79, growth91 = HT91-HT85, growth96=HT96-HT91, growth06=HT06-HT96, growth14=HT14-HT06) %>% 
  mutate(growth79rel=(growth79/HT74*100)/5, growth85rel=(growth85/HT79*100)/6, growth91rel=(growth91/HT85*100)/6, growth96rel=(growth96/HT91*100)/5, growth06rel=(growth06/HT96*100)/10, growth14rel=(growth14/HT06*100)/8) %>% 
  pivot_longer(growth79rel:growth14rel) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  filter(!is.na(value))

ht_increment_rel_plot<- ggplot(ht_growth_rel_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")
ht_increment_rel_plot
###differences between provenances in height increment each year
##1979
HGmod79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth79rel"))
plot(HGmod79)
qqmath(HGmod79)
anova(HGmod79)
rand(HGmod79)
HGmod79_marg = lsmeans(HGmod79, ~Provenance)

CLD_HGmod79 = cld(HGmod79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod79

##1985
HGmod85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth85rel"))
plot(HGmod85)
qqmath(HGmod85)
anova(HGmod85)
rand(HGmod85)
HGmod85_marg = lsmeans(HGmod85, ~Provenance)

CLD_HGmod85 = cld(HGmod85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod85

##1991
HGmod91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth91rel"))
plot(HGmod91)
qqmath(HGmod91)
anova(HGmod91)
rand(HGmod91)
HGmod91_marg = lsmeans(HGmod91, ~Provenance)

CLD_HGmod91 = cld(HGmod91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod91

##1996
HGmod96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth96rel"))
plot(HGmod96)
qqmath(HGmod96)
anova(HGmod96)
rand(HGmod96)
HGmod96_marg = lsmeans(HGmod96, ~Provenance)

CLD_HGmod96 = cld(HGmod96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod96 ##Gila no longer in last place by 1996

##2006
HGmod06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth06rel"))
plot(HGmod06)
qqmath(HGmod06)
anova(HGmod06)
rand(HGmod06)
HGmod06_marg = lsmeans(HGmod06, ~Provenance)

CLD_HGmod06 = cld(HGmod06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod06 

##2014
HGmod14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth14rel"))
plot(HGmod14)
qqmath(HGmod14)
anova(HGmod14)
rand(HGmod14)
HGmod14_marg = lsmeans(HGmod14, ~Provenance)

CLD_HGmod14 = cld(HGmod14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod14
##########################

ht_growth_rel_data %>% 
  filter(!is.na(HT14))

ht_increment_rel_plot_survivorsonly<- ggplot(ht_growth_rel_data %>% filter(value<1000) %>% filter(!is.na(HT14)), aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relativized Height Increment")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")


ht_increment_plot
ht_increment_rel_plot
ht_increment_rel_plot_survivorsonly

###differences between provenances in height increment each year ***SURVIVORS ONLY***
##1979
HGmod_SO_79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth79rel"))
plot(HGmod_SO_79)
qqmath(HGmod_SO_79)
anova(HGmod_SO_79)
rand(HGmod_SO_79)
HGmod_SO_79_marg = lsmeans(HGmod_SO_79, ~Provenance)

CLD_HGmod_SO_79 = cld(HGmod_SO_79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_79

##1985
HGmod_SO_85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth85rel"))
plot(HGmod_SO_85)
qqmath(HGmod_SO_85)
anova(HGmod_SO_85)
rand(HGmod_SO_85)
HGmod_SO_85_marg = lsmeans(HGmod_SO_85, ~Provenance)

CLD_HGmod_SO_85 = cld(HGmod_SO_85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_85

##1991
HGmod_SO_91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth91rel"))
plot(HGmod_SO_91)
qqmath(HGmod_SO_91)
anova(HGmod_SO_91)
rand(HGmod_SO_91)
HGmod_SO_91_marg = lsmeans(HGmod_SO_91, ~Provenance)

CLD_HGmod_SO_91 = cld(HGmod_SO_91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_91

##1996
HGmod_SO_96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth96rel"))
plot(HGmod_SO_96)
qqmath(HGmod_SO_96)
anova(HGmod_SO_96)
rand(HGmod_SO_96)
HGmod_SO_96_marg = lsmeans(HGmod_SO_96, ~Provenance)

CLD_HGmod_SO_96 = cld(HGmod_SO_96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_96

##2006
HGmod_SO_06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth06rel"))
plot(HGmod_SO_06)
qqmath(HGmod_SO_06)
anova(HGmod_SO_06)
rand(HGmod_SO_06)
HGmod_SO_06_marg = lsmeans(HGmod_SO_06, ~Provenance)

CLD_HGmod_SO_06 = cld(HGmod_SO_06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_06 ##Gila no longer in last place by 2006

##2014
HGmod_SO_14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth14rel"))
plot(HGmod_SO_14)
qqmath(HGmod_SO_14)
anova(HGmod_SO_14)
rand(HGmod_SO_14)
HGmod_SO_14_marg = lsmeans(HGmod_SO_14, ~Provenance)

CLD_HGmod_SO_14 = cld(HGmod_SO_14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_14
#############################

gila_survivors<- ht_growth_rel_data %>% 
  filter(!is.na(HT14)) %>% 
    filter(Provenance=="Gila NF") %>% 
    mutate(year=case_when(name=="growth79rel" ~ 1979,
                          name=="growth85rel" ~1985,
                          name=="growth91rel"~1991,
                          name=="growth96rel"~1996,
                          name=="growth06rel"~2006,
                          name=="growth14rel"~2014),
           uid=paste(LOC,BLK,REP,sep=""))

ggplot(data=gila_survivors, aes(x=year, y=value, color=uid))+
  geom_point()+
  geom_line()+
  scale_color_manual(values=unname(stepped()))+
  facet_wrap(~uid)+
  geom_hline(yintercept=0, color="red")+
  ylab("Relativized Growth Increment Per Year")

survivors_ht_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  filter(!is.na(HT14)) %>% 
  filter(!HT14==0) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(uid=paste(LOC,BLK,REP, sep=""),
         year=case_when(name=="HT74" ~ 1974,
                        name=="HT79"~ 1979,
                        name=="HT85" ~1985,
                        name=="HT91" ~ 1991,
                        name=="HT96" ~1996,
                        name=="HT06" ~ 2006,
                        name=="HT14" ~ 2014))

ggplot(data=survivors_ht_data %>% filter(Provenance=="Gila NF"), aes(x=year, y=value, color=uid))+
  geom_point()+
  geom_line()+
  facet_wrap(~uid)+
  theme_bw()+
  ylab("Height (m)")

ggplot(data=survivors_ht_data %>% filter(Provenance=="Payette NF"), aes(x=year, y=value, color=uid))+
  geom_point()+
  geom_line()+
  facet_wrap(~uid)+
  geom_hline(yintercept=0, color="red")+
  theme_bw()

nonsurvivors_ht_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  filter(is.na(HT14)| HT14==0) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(uid=paste(LOC,BLK,REP, sep=""),
         year=case_when(name=="HT74" ~ 1974,
                        name=="HT79"~ 1979,
                        name=="HT85" ~1985,
                        name=="HT91" ~ 1991,
                        name=="HT96" ~1996,
                        name=="HT06" ~ 2006,
                        name=="HT14" ~ 2014))

ggplot(data=nonsurvivors_ht_data %>% filter(Provenance=="Gila NF"), aes(x=year, y=value, color=uid))+
  geom_point()+
  geom_line()+
  facet_wrap(~uid)+
  geom_hline(yintercept=0, color="red")

ggplot(data=nonsurvivors_ht_data, aes(x=year, y=value, color=uid))+
  geom_point(alpha=0.4)+
  geom_line()+
  facet_wrap(~Provenance)+
  geom_hline(yintercept=0, color="red")+
  theme(legend.position = "none")+
  ylab("Height (m)")
ggplot(data=survivors_ht_data, aes(x=year, y=value, color=uid))+
  geom_point(alpha=0.4)+
  geom_line()+
  facet_wrap(~Provenance)+
  geom_hline(yintercept=0, color="red")+
  theme(legend.position = "none")+
  ylab("Height (m)")

length(unique(nonsurvivors_ht_data$uid))


gila_nonsurvivors<- ht_growth_rel_data %>% 
  filter(is.na(HT14)) %>% 
    filter(Provenance=="Gila NF") %>% 
    mutate(year=case_when(name=="growth79rel" ~ 1979,
                          name=="growth85rel" ~1985,
                          name=="growth91rel"~1991,
                          name=="growth96rel"~1996,
                          name=="growth06rel"~2006,
                          name=="growth14rel"~2014),
           uid=paste(LOC,BLK,REP,sep=""))

ggplot(data=gila_nonsurvivors, aes(x=year, y=value, color=uid))+
  geom_point()+
  geom_line()+
  facet_wrap(~uid)+
  geom_hline(yintercept=0, color="red")


##analyze relative height increment instead of absolute height each year
aov_rHT <- lmer(value ~ name*Provenance + (1|BLK), data=ht_growth_rel_data)
anova(aov_rHT)

```

```{r}
##PC x latitude analysis
ht_growth_rel_clim<- ht_growth_rel_data %>% 
  left_join(prov_pcapts_big)

#y
mod_relht_pca_y_randtime <- lmer(value ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
plot(mod_relht_pca_y_randtime)
qqmath(mod_relht_pca_y_randtime)
summary(mod_relht_pca_y_randtime)
mod_relht_pca_y_randtime_dredge<- dredge(mod_relht_pca_y_randtime)
mod_relht_pca_y_randtime_dredge

bestmod_relht_pca_y_randtime <- lmer(value ~  PC2 + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
summary(bestmod_relht_pca_y_randtime)

#no gila
ht_growth_rel_clim_noG<- ht_growth_rel_clim %>% filter(!Provenance=="Gila NF")

mod_relht_pca_y_randtime_noG <- lmer(value ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG)
plot(mod_relht_pca_y_randtime_noG)
qqmath(mod_relht_pca_y_randtime_noG)
summary(mod_relht_pca_y_randtime_noG)
mod_relht_pca_y_randtime_noG_dredge<- dredge(mod_relht_pca_y_randtime_noG)
mod_relht_pca_y_randtime_noG_dredge

bestmod_relht_pca_y_randtime_noG <- lmer(value ~  scale(y) + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG)
summary(bestmod_relht_pca_y_randtime_noG)

#x
mod_relht_pca_x_randtime <- lmer(value ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
plot(mod_relht_pca_x_randtime)
qqmath(mod_relht_pca_x_randtime)
summary(mod_relht_pca_x_randtime)
mod_relht_pca_x_randtime_dredge<- dredge(mod_relht_pca_x_randtime)
mod_relht_pca_x_randtime_dredge

bestmod_relht_pca_x_randtime <- lmer(value ~ PC2 + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
summary(bestmod_relht_pca_x_randtime)

#no gila
mod_relht_pca_x_randtime_noG <- lmer(value ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG)
plot(mod_relht_pca_x_randtime_noG)
qqmath(mod_relht_pca_x_randtime_noG)
summary(mod_relht_pca_x_randtime_noG)
mod_relht_pca_x_randtime_noG_dredge<- dredge(mod_relht_pca_x_randtime_noG)
mod_relht_pca_x_randtime_noG_dredge

bestmod_relht_pca_x_randtime_noG <- lmer(value ~  scale(x) +  I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG)
summary(bestmod_relht_pca_x_randtime_noG) 

AICc(mod_relht_pca_x_randtime, mod_relht_pca_y_randtime) ##lat is better
AICc(mod_relht_pca_x_randtime_noG, mod_relht_pca_y_randtime_noG) ##without Gila, long is better


####make plot for best final model
bestmod_relht_pca_x_randtime_noG_lm <- lm(value ~  scale(x) +  I(scale(x)^2), data=ht_growth_rel_clim_noG)

newdata_relht_x <-  expand.grid(x=seq(min(ht_growth_rel_clim_noG$x), max(ht_growth_rel_clim_noG$x), length.out=50))
relht_predict_x <- predict(bestmod_relht_pca_x_randtime_noG_lm, newdata = newdata_relht_x, interval="confidence")

predictdata_relht_x <- cbind(newdata_relht_x, relht_predict_x) %>% mutate(var="Longitude")

relht_x_plot <- ggplot()+
  geom_ribbon(data=predictdata_relht_x, aes(x=x, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_relht_x, aes(x=x,y=fit), color="black")+
  geom_rug(data=ht_growth_rel_clim_noG %>% mutate(fit=10), aes(x=x,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance Longitude")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
relht_x_plot
```

```{r}

ht_growth_rel_clim_long <- ht_growth_rel_clim %>% 
  dplyr::rename(year=name, relht=value) %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality))

relht_mods<- data.frame()
ht_growth_rel_clim_long_nog <- ht_growth_rel_clim_long %>% filter(!Provenance=="Gila NF")
for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

relht_mods <- bind_rows(relht_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

relht_mods %>% arrange(pvalue_nog)

#####NFFD
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="NFFD")))
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="NFFD") %>% filter(!Provenance=="Gila NF") %>% filter(!Provenance=="Wenatchee NF")))

####make plot 
nffd_relht_mod_lm <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="NFFD"))

newdata_nffd_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$NFFD), max(ht_growth_rel_clim$NFFD), length.out=50))
nffd_relht_predict <- predict(nffd_relht_mod_lm, newdata = newdata_nffd_relht, interval="confidence")

predictdata_nffd_relht <- cbind(newdata_nffd_relht, nffd_relht_predict) %>% mutate(var="NFFD")

#no gila
nffd_relht_mod_lm_nog <- lm(relht ~  value, data=ht_growth_rel_clim_long_nog %>% filter(name=="NFFD") %>% filter(!Provenance=="Gila NF"))

newdata_nffd_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$NFFD), max(ht_growth_rel_clim_noG$NFFD), length.out=50))
nffd_relht_predict_nog <- predict(nffd_relht_mod_lm_nog, newdata = newdata_nffd_relht_nog, interval="confidence")

predictdata_nffd_relht_nog <- cbind(newdata_nffd_relht_nog, nffd_relht_predict_nog) %>% mutate(var="NFFD")
###

predictdata_nffd_relht_all <- predictdata_nffd_relht %>% 
  mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_nffd_relht_nog %>% mutate(model="without Gila NF"))

nffd_relht_plot <- ggplot()+
  geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="NFFD") %>% pull(value), col="steelblue")+
  geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="NFFD") %>% pull(value) + 12, y=12.5, label="plantation"), col="steelblue")+
  geom_ribbon(data=predictdata_nffd_relht_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_nffd_relht_all, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim %>% dplyr::select(c("NFFD","Provenance"))%>% mutate(fit=10), aes(x=NFFD,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance NFFD")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
nffd_relht_plot

#####SHM
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="SHM")))
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="SHM") %>% filter(!Provenance=="Gila NF")))
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="SHM") %>% filter(!Provenance=="Wenatchee NF"))) ##when Wenatchee is taken out, this is not longer significant. 

####make plot 
shm_relht_mod_lm <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="SHM"))

newdata_shm_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$SHM), max(ht_growth_rel_clim$SHM), length.out=50))
shm_relht_predict <- predict(shm_relht_mod_lm, newdata = newdata_shm_relht, interval="confidence")

predictdata_shm_relht <- cbind(newdata_shm_relht, shm_relht_predict) %>% mutate(var="SHM")

#no gila
shm_relht_mod_lm_nog <- lm(relht ~  value, data=ht_growth_rel_clim_long_nog %>% filter(name=="SHM") %>% filter(!Provenance=="Gila NF"))

newdata_shm_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$SHM), max(ht_growth_rel_clim_noG$SHM), length.out=50))
shm_relht_predict_nog <- predict(shm_relht_mod_lm_nog, newdata = newdata_shm_relht_nog, interval="confidence")

predictdata_shm_relht_nog <- cbind(newdata_shm_relht_nog, shm_relht_predict_nog) %>% mutate(var="SHM")
###

predictdata_shm_relht_all <- predictdata_shm_relht %>% 
  mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_shm_relht_nog %>% mutate(model="without Gila NF"))

shm_relht_plot <- ggplot()+
  geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="SHM") %>% pull(value), col="steelblue")+
  geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="SHM") %>% pull(value) + 12, y=12.5, label="plantation"), col="steelblue")+
  geom_ribbon(data=predictdata_shm_relht_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_shm_relht_all, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim %>% dplyr::select(c("SHM","Provenance"))%>% mutate(fit=10), aes(x=SHM,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance SHM")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
shm_relht_plot


#####EXT
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="EXT")))
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="EXT") %>% filter(!Provenance=="Gila NF")))

####make plot 
ext_relht_mod_lm <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="EXT"))

newdata_ext_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$EXT), max(ht_growth_rel_clim$EXT), length.out=50))
ext_relht_predict <- predict(ext_relht_mod_lm, newdata = newdata_ext_relht, interval="confidence")

predictdata_ext_relht <- cbind(newdata_ext_relht, ext_relht_predict) %>% mutate(var="EXT")

#no gila
ext_relht_mod_lm_nog <- lm(relht ~  value, data=ht_growth_rel_clim_long_nog %>% filter(name=="EXT") %>% filter(!Provenance=="Gila NF"))

newdata_ext_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$EXT), max(ht_growth_rel_clim_noG$EXT), length.out=50))
ext_relht_predict_nog <- predict(ext_relht_mod_lm_nog, newdata = newdata_ext_relht_nog, interval="confidence")

predictdata_ext_relht_nog <- cbind(newdata_ext_relht_nog, ext_relht_predict_nog) %>% mutate(var="EXT")
###

predictdata_ext_relht_all <- predictdata_ext_relht %>% 
  mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_ext_relht_nog %>% mutate(model="without Gila NF"))

ext_relht_plot <- ggplot()+
  geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="EXT") %>% pull(value), col="steelblue")+
  geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="EXT") %>% pull(value), y=12.5, label="plantation"), col="steelblue")+
  geom_ribbon(data=predictdata_ext_relht_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_ext_relht_all, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim %>% dplyr::select(c("EXT","Provenance"))%>% mutate(fit=10), aes(x=EXT,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance EXT")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
ext_relht_plot


#####MSP
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="MSP")))
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="MSP") %>% filter(!Provenance=="Gila NF")))

####make plot 
msp_relht_mod_lm <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="MSP"))

newdata_msp_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$MSP), max(ht_growth_rel_clim$MSP), length.out=50))
msp_relht_predict <- predict(msp_relht_mod_lm, newdata = newdata_msp_relht, interval="confidence")

predictdata_msp_relht <- cbind(newdata_msp_relht, msp_relht_predict) %>% mutate(var="MSP")

#no gila
msp_relht_mod_lm_nog <- lm(relht ~  value, data=ht_growth_rel_clim_long_nog %>% filter(name=="MSP") %>% filter(!Provenance=="Gila NF"))

newdata_msp_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$MSP), max(ht_growth_rel_clim_noG$MSP), length.out=50))
msp_relht_predict_nog <- predict(msp_relht_mod_lm_nog, newdata = newdata_msp_relht_nog, interval="confidence")

predictdata_msp_relht_nog <- cbind(newdata_msp_relht_nog, msp_relht_predict_nog) %>% mutate(var="MSP")
###

predictdata_msp_relht_all <- predictdata_msp_relht %>% 
  mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_msp_relht_nog %>% mutate(model="without Gila NF"))

msp_relht_plot <- ggplot()+
  geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="MSP") %>% pull(value), col="steelblue")+
  geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="MSP") %>% pull(value) + 12, y=12.5, label="plantation"), col="steelblue")+
  geom_ribbon(data=predictdata_msp_relht_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_msp_relht_all, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim %>% dplyr::select(c("MSP","Provenance"))%>% mutate(fit=10), aes(x=MSP,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance MSP")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
msp_relht_plot

relht_linear_mod_results<- bind_rows(predictdata_nffd_relht_all, predictdata_ext_relht_all, predictdata_msp_relht_all, predictdata_shm_relht_all)

relht_linear_mod_plot<- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(relht_linear_mod_results$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(relht_linear_mod_results$var)), aes(x=value, y=12.5, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=relht_linear_mod_results, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=relht_linear_mod_results, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim_long %>% dplyr::rename(var=name) %>% mutate(fit=10)%>% filter(var %in% unique(relht_linear_mod_results$var)), aes(x=value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_wrap(~factor(var, levels=c("NFFD","EXT","MSP","SHM")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
relht_linear_mod_plot

###quadratic

relht_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

relht_mods_quad <- bind_rows(relht_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))
}

relht_mods_quad %>% arrange(pvalue2_nog) 

##PPTsp
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="PPTsp")))
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="PPTsp") %>% filter(!Provenance=="Okanogan NF")))

####make plot 
##with Gila
pptsp_relht_mod_lm <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long %>% filter(name=="PPTsp"))

newdata_pptsp_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$PPTsp), max(ht_growth_rel_clim$PPTsp), length.out=50))
pptsp_relht_predict <- predict(pptsp_relht_mod_lm, newdata = newdata_pptsp_relht, interval="confidence")

predictdata_pptsp_relht <- cbind(newdata_pptsp_relht, pptsp_relht_predict) %>% mutate(var="PPTsp", model="with Gila NF")

##without Gila 
pptsp_relht_mod_lm_nog <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long_nog %>% filter(name=="PPTsp"))

newdata_pptsp_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$PPTsp), max(ht_growth_rel_clim_noG$PPTsp), length.out=50))
pptsp_relht_predict_nog <- predict(pptsp_relht_mod_lm_nog, newdata = newdata_pptsp_relht_nog, interval="confidence")

predictdata_pptsp_relht_nog <- cbind(newdata_pptsp_relht_nog, pptsp_relht_predict_nog) %>% mutate(var="PPTsp", model="without Gila NF")

x_max_pptsp_relht_quad_nog = -coef(pptsp_relht_mod_lm_nog)[2] / (2*coef(pptsp_relht_mod_lm_nog)[3])

y_max_pptsp_relht_quad_nog = coef(pptsp_relht_mod_lm_nog)[1] + coef(pptsp_relht_mod_lm_nog)[2]*x_max_pptsp_relht_quad_nog + coef(pptsp_relht_mod_lm_nog)[3]*(x_max_pptsp_relht_quad_nog^2)


####MCMT
##with Gila NF
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="MCMT")))
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="MCMT") %>% filter(!Provenance=="Gila NF")))
####make plot 
##with Gila
mcmt_relht_mod_lm <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long %>% filter(name=="MCMT"))

newdata_mcmt_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$MCMT), max(ht_growth_rel_clim$MCMT), length.out=50))
mcmt_relht_predict <- predict(mcmt_relht_mod_lm, newdata = newdata_mcmt_relht, interval="confidence")

predictdata_mcmt_relht <- cbind(newdata_mcmt_relht, mcmt_relht_predict) %>% mutate(var="MCMT", model="with Gila NF")

##without Gila 
mcmt_relht_mod_lm_nog <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long_nog %>% filter(name=="MCMT"))

newdata_mcmt_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$MCMT), max(ht_growth_rel_clim_noG$MCMT), length.out=50))
mcmt_relht_predict_nog <- predict(mcmt_relht_mod_lm_nog, newdata = newdata_mcmt_relht_nog, interval="confidence")

predictdata_mcmt_relht_nog <- cbind(newdata_mcmt_relht_nog, mcmt_relht_predict_nog) %>% mutate(var="MCMT", model="without Gila NF")

x_max_mcmt_relht_quad_nog = -coef(mcmt_relht_mod_lm_nog)[2] / (2*coef(mcmt_relht_mod_lm_nog)[3])

y_max_mcmt_relht_quad_nog = coef(mcmt_relht_mod_lm_nog)[1] + coef(mcmt_relht_mod_lm_nog)[2]*x_max_mcmt_relht_quad_nog + coef(mcmt_relht_mod_lm_nog)[3]*(x_max_mcmt_relht_quad_nog^2)


relht_quad_mod_results<- bind_rows(predictdata_mcmt_relht, predictdata_mcmt_relht_nog, predictdata_pptsp_relht, predictdata_pptsp_relht_nog)

relht_quad_mod_max <- data.frame(max=c(x_max_mcmt_relht_quad_nog,x_max_pptsp_relht_quad_nog), var=c("MCMT","PPTsp"))

relht_quad_mod_plot<- ggplot()+
  geom_vline(data=relht_quad_mod_max, aes(xintercept=max), col="black", linetype=2)+
  geom_text(data=relht_quad_mod_max, aes(x=max, y=12.5, label="max"), col="black", size=3)+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(relht_quad_mod_results$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(relht_quad_mod_results$var)), aes(x=value, y=12.5, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=relht_quad_mod_results, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=relht_quad_mod_results, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim_long %>% dplyr::rename(var=name) %>% mutate(fit=10)%>% filter(var %in% unique(relht_quad_mod_results$var)), aes(x=value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_wrap(~factor(var, levels=c("MCMT","PPTsp")), nrow=1, scales="free")+
  theme_bw()+
  theme(legend.position="right")
relht_quad_mod_plot

```


```{r}
View(ht_growth_rel_data)
ht_data_year <-  ht_data %>% mutate(year=case_when(
  name=="HT74" ~ 1974,
  name == "HT79" ~ 1979,
  name == "HT85" ~ 1985,
  name == "HT91" ~ 1991,
  name == "HT96" ~ 1996,
  name == "HT06" ~ 2006,
  name == "HT14" ~ 2014))

rel_abs_ht_data<- ht_growth_rel_data %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,name,value)) %>% 
  mutate(year=case_when(name == "growth79rel" ~ 1979,
  name == "growth85rel" ~ 1985,
  name == "growth91rel" ~ 1991,
  name == "growth96rel" ~ 1996,
  name == "growth06rel" ~ 2006,
  name == "growth14rel" ~ 2014)) %>% 
  rename(relht=value,period=name) %>% 
  left_join(ht_data_year %>% 
              rename(absht=value,measyear=name), by=c("year","LOC","BLK","REP","Provenance")) %>% 
  mutate(relht_peryr = case_when(year==1979 ~ relht/5,
                                year==1985 ~ relht/6,
                                year==1991 ~ relht/6,
                                year==1996 ~ relht/5,
                                year==2006 ~ relht/10,
                                year==2014 ~ relht/8))

rel_abs_ht_data_means<- rel_abs_ht_data %>% 
  group_by(Provenance, year) %>% 
  summarise(n=n(), meanabsht=mean(absht), meanrelht=mean(relht), meanrelht_peryr=mean(relht_peryr), seabsht=sd(absht)/sqrt(n()), serelht=sd(relht)/sqrt(n()), serelht_peryr=sd(relht_peryr)/sqrt(n()))

ggplot(rel_abs_ht_data_means)+
  geom_bar(aes(x=factor(Provenance, levels=ht.order$Provenance), y=meanabsht), stat = "identity")+
  geom_point(aes(x=factor(Provenance, levels=ht.order$Provenance),y=meanrelht/30, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  scale_color_manual(values=unname(stepped()))+
  facet_wrap(~year, scales="free")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

ggplot(rel_abs_ht_data_means)+
  geom_point(aes(x=factor(year),y=meanrelht_peryr, col=factor(Provenance, levels=provs_bylat$Provenance)),position=position_dodge(width=.6))+
  geom_errorbar(aes(x=factor(year), ymin=meanrelht_peryr-serelht_peryr, ymax=meanrelht_peryr+serelht_peryr,  col=factor(Provenance, levels=provs_bylat$Provenance)), position=position_dodge(width=.6), width=.1)+
  scale_color_manual(values=unname(stepped()))+
  ylab("Relative Height Growth Per Year (%)")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position="none")

```

##Total Height

###models

####nursery height

```{r}
##effect of initial nursery height


nurse_ht_mod <- lmer(log(value) ~ nursery_ht_m + (1|year) + (1|Provenance) + (1|BLK), data=ht_data_year)
plot(nurse_ht_mod)
qqmath(nurse_ht_mod)
summary(nurse_ht_mod)   #no effect of nursery height when Gila is included

##no Gila
nurse_ht_mod_nog <- lmer(log(value) ~ nursery_ht_m + (1|year) + (1|Provenance) + (1|BLK), data=ht_data_year %>% filter(!Provenance=="Gila NF"))
plot(nurse_ht_mod_nog)
qqmath(nurse_ht_mod_nog)
summary(nurse_ht_mod_nog)   #significant effect of nursery height when Gila is removed

#1974
nurse_ht_mod74 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT74"))
plot(nurse_ht_mod74)
qqmath(nurse_ht_mod74)
summary(nurse_ht_mod74)  ##significant 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT74") %>% filter(!Provenance=="Gila NF")))

#1979
nurse_ht_mod79 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT79"))
plot(nurse_ht_mod79)
qqmath(nurse_ht_mod79)
summary(nurse_ht_mod79)  ##no effect of nursery height on total height in 1979 
summary(lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT79") %>% filter(!Provenance=="Gila NF"))) ##there is an effect when Gila is removed

#1985
nurse_ht_mod85 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT85"))
plot(nurse_ht_mod85)
qqmath(nurse_ht_mod85)
summary(nurse_ht_mod85)  ##no effect of nursery height on total height in 1985 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT85") %>% filter(!Provenance=="Gila NF")))##there is an effect when Gila is removed

#1991
nurse_ht_mod91 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT91"))
plot(nurse_ht_mod91)
qqmath(nurse_ht_mod91)
summary(nurse_ht_mod91)  ##no effect of nursery height on total height in 1991 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT91") %>% filter(!Provenance=="Gila NF"))) ##there is an effect when Gila is removed

#1996
nurse_ht_mod96 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT96"))
plot(nurse_ht_mod96)
qqmath(nurse_ht_mod96)
summary(nurse_ht_mod96)  ##no effect of nursery height on total height in 1996 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT96") %>% filter(!Provenance=="Gila NF"))) ##there is an effect when Gila is removed

#2006
nurse_ht_mod06 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT06"))
plot(nurse_ht_mod06)
qqmath(nurse_ht_mod06)
summary(nurse_ht_mod06)  ##no effect of nursery height on total height in 2006 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT06") %>% filter(!Provenance=="Gila NF"))) #significant without Gila

#2014
nurse_ht_mod14 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT14"))
plot(nurse_ht_mod14)
qqmath(nurse_ht_mod14)
summary(nurse_ht_mod14)  ##no effect of nursery height on total height in 2014. 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT14") %>% filter(!Provenance=="Gila NF"))) #only marginally significant without Gila
```

#### ANOVA
```{r}
##effect of year * provenance
par(mfrow=c(2,2))
plot(lm(value ~ Provenance*name, data=ht_data))

totht_mod <- lmer(log(value) ~ Provenance*year + (1|BLK), data=ht_data_year)
plot(totht_mod)
qqmath(totht_mod)
Anova(totht_mod, type="3") ##there is a significant year by provenance interaction

#no gila
totht_mod_nog <- lmer(log(value) ~ Provenance*year + (1|BLK), data=ht_data_year %>% filter(!Provenance=="Gila NF"))
plot(totht_mod_nog)
qqmath(totht_mod_nog)
Anova(totht_mod_nog, type="3") ##there is a significant year by provenance interaction
####

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meantotht-seTH, ymax=meantotht+seTH, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Total Height (m)")

ggplot(ht_data_year, aes(x=name, y=value, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), "Provenance")

ht_data_aves_forfig <- ht_data_aves %>% 
  bind_rows(data.frame(name="HT74",Provenance="Gila NF", meantotht=NA, seTH=NA))

ht_means_fig <- ggplot(ht_data_aves_forfig, aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meantotht, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meantotht-seTH, ymax=meantotht+seTH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean Height (m)")

ggplot(ht_data_year %>% 
  left_join(provs_bylat) %>% 
  mutate(region = ifelse(y>43, "north", "south")), aes(x=factor(name, levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14")), y=value, fill=region))+
  geom_boxplot()+
  scale_fill_manual(values=c("steelblue","tomato"))+
  scale_color_manual(values=c("steelblue","tomato"))

#each year separately
totht_mod74 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
anova(totht_mod74)
rand(totht_mod74)
totht_mod74_marg = lsmeans(totht_mod74, ~ Provenance)

CLD_totht_mod74 = cld(totht_mod74_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod74

totht_mod79 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT79"))
plot(totht_mod79)
anova(totht_mod79)
rand(totht_mod79)
totht_mod79_marg = lsmeans(totht_mod79, ~ Provenance)

CLD_totht_mod79 = cld(totht_mod79_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod79

totht_mod85 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT85"))
plot(totht_mod85)
anova(totht_mod85)
rand(totht_mod85)
totht_mod85_marg = lsmeans(totht_mod85, ~ Provenance)

CLD_totht_mod85 = cld(totht_mod85_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod85

totht_mod91 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT91"))
plot(totht_mod91)
anova(totht_mod91)
rand(totht_mod91)
totht_mod91_marg = lsmeans(totht_mod91, ~ Provenance)

CLD_totht_mod91 = cld(totht_mod91_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod91

totht_mod96 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT96"))
plot(totht_mod96)
anova(totht_mod96)
rand(totht_mod96)
totht_mod96_marg = lsmeans(totht_mod96, ~ Provenance)

CLD_totht_mod96 = cld(totht_mod96_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod96

totht_mod06 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT06"))
plot(totht_mod06)
anova(totht_mod06)
rand(totht_mod06)
totht_mod06_marg = lsmeans(totht_mod06, ~ Provenance)

CLD_totht_mod06 = cld(totht_mod06_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod06

ht_data14<- ht_data %>% filter(name=="HT14") %>% 
  mutate(Provenance=as.factor(Provenance))

totht_mod14 <- lmer(value ~ Provenance + (1|BLK), data=ht_data14)
plot(totht_mod14)
anova(totht_mod14)
rand(totht_mod14)
totht_mod14_marg = lsmeans(totht_mod14, ~ Provenance)

CLD_totht_mod14 = cld(totht_mod14_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod14

totht14_letter_df<- as.data.frame(CLD_totht_mod14) %>% 
  rename(letters = `.group`)
#########

###2014 plot
prov_ht_order14<- ht_data14 %>% 
  group_by(Provenance) %>% 
  summarise(mean_ht = mean(value, na.rm=T)) %>% 
  arrange(mean_ht)

ht_letters_plot<- ggplot(ht_data14, aes(x=factor(Provenance, levels=prov_ht_order14$Provenance), y=value, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  geom_text(data=totht14_letter_df, aes(x=Provenance, y= 17, label=letters), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ylab("Height (m)")+
  theme(axis.text.x=element_text(angle=45, hjust=1, color="black",size=14), axis.text.y=element_text(color="black",size=14),axis.title.y=element_text(color="black",size=14), axis.title.x=element_blank(), legend.position = "none")
  
ggarrange(dbh_letters_plot, ht_letters_plot, nrow=2)

```


```{r}

ht_data_clim14 <- ht_data_clim %>% 
  filter(name=="HT14") %>% 
  left_join(pca_dist_df %>% dplyr::select(code, dist.to.plant,dist.to.plant.3d)) %>% 
  left_join(geo.dist.df)

ht_data_clim14_nog <- ht_data_clim14 %>% filter(!Provenance=="Gila NF")

ht_data_clim14 %>% 
  left_join(dbh_num14) %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,value,year, DBH)) %>%
  filter(!is.na(DBH)) %>% 
  dplyr::select(value,DBH) %>% 
  cor()
```

####distance - cut
```{r, eval=FALSE}
## Distance model
ht_dist_mod <- lmer(value ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=ht_data_clim14)
plot(ht_dist_mod)
qqmath(ht_dist_mod)
summary(ht_dist_mod)
dredge(ht_dist_mod)

best_ht_dist_mod <- lmer(value ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=ht_data_clim14)
summary(best_ht_dist_mod)

ggplot(data=ht_data_clim14, aes(x=dist.to.plant.3d, y=value))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(data=ht_data_clim14, aes(x=geo.dist.to.plant.km, y=value))+
  geom_point()+
  geom_smooth(method="lm")

ht_dist_mod_nog <- lmer(value ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=ht_data_clim14_nog)
plot(ht_dist_mod_nog)
qqmath(ht_dist_mod_nog)
summary(ht_dist_mod_nog)
dredge(ht_dist_mod_nog)

best_ht_dist_mod_nog <- lmer(value ~ scale(geo.dist.to.plant.km) + scale(dist.to.plant.3d) + (1|Provenance) + (1|BLK), data=ht_data_clim14_nog)
summary(best_ht_dist_mod_nog)

ggplot(data=ht_data_clim14_nog, aes(x=dist.to.plant.3d, y=value, col=geo.dist.to.plant.km>800))+
  geom_point()+
  geom_smooth(method="lm")

ggplot(data=ht_data_clim14_nog, aes(x=geo.dist.to.plant.km, y=value))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(data=ht_data_clim14_nog, aes(x=dist.to.plant.3d, y=value))+
  geom_point()+
  geom_smooth(method="lm")

ht_int_plot <- interact_plot(best_ht_dist_mod, pred = geo.dist.to.plant.km, modx=dist.to.plant.3d, plot.points=TRUE, interval=TRUE, int.width=0.95, data= ht_data_clim14, y.label="Height (m)", x.label=element_blank(), legend.main = "Climatic Distance", colors="Greys")

ggarrange(ht_int_plot, dbh_int_plot, common.legend = TRUE, nrow=2)

##predict model
mod_ht_dist_lm <- lm(value ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant.3d), data=ht_data_clim14)

ht_dist_newdata <- with(ht_data_clim14, data.frame(geo.dist.to.plant.km = seq(min(geo.dist.to.plant.km),max(geo.dist.to.plant.km),length.out=100), 
                                                       dist.to.plant.3d = mean(dist.to.plant.3d)))
ht_dist_predict <- predict(mod_ht_dist_lm, newdata=ht_dist_newdata, interval="confidence")

ht_dist_pred_data <- cbind(ht_dist_newdata,ht_dist_predict)


ggplot()+
  geom_point(data=ht_data_clim14, aes(x=geo.dist.to.plant.km, y=value, col=factor(Provenance, levels=factor(provs_bylat$Provenance))))+
  geom_ribbon(data=ht_dist_pred_data, aes(x=geo.dist.to.plant.km, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=ht_dist_pred_data, aes(x=geo.dist.to.plant.km,y=fit), color="black")+
    geom_point(data=dbh_num14_alldist, aes(x=geo.dist.to.plant.km, y=DBH, col=factor(Provenance, levels=factor(provs_bylat$Provenance))), shape=24)+
  geom_ribbon(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km, ymin=lwr, ymax=upr), fill="gray", alpha=0.2)+
  geom_line(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km,y=fit), color="gray")+
  scale_y_continuous(
    "DBH", 
    sec.axis = sec_axis(~ . , name = "Height"))+
  xlab("Geographic distance to plantation (km)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position = "none")


 ggplot()+
  geom_point(data=dbh_num14_alldist, aes(x=geo.dist.to.plant.km, y=DBH, col=factor(Provenance, levels=factor(provs_bylat$Provenance))))+
  geom_ribbon(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km,y=fit), color="black")+
  xlab("Geographic distance to plantation (km)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position = "none")

```

####PCA

```{r}

##PCs and x 
mod_ht_pca_x <- lmer(value ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance) + (1|BLK), data=ht_data_clim14)
plot(mod_ht_pca_x)
qqmath(mod_ht_pca_x)
summary(mod_ht_pca_x)
mod_ht_pca_x_dredge <- dredge(mod_ht_pca_x)
mod_ht_pca_x_dredge

bestmod_ht_pca_x <- lmer(value ~ PC1 + PC2 + I(PC2^2) + I(scale(x)^2) + scale(x) + (1|Provenance) + (1|BLK), data=ht_data_clim14)
summary(bestmod_ht_pca_x)

ggplot(data=ht_data_clim14, aes(x=x, y=value))+
  geom_point()

mod_ht_pca_x_nog <- lmer(value ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance) + (1|BLK), data=ht_data_clim14_nog)
plot(mod_ht_pca_x_nog)
qqmath(mod_ht_pca_x_nog)
summary(mod_ht_pca_x_nog)
dredge(mod_ht_pca_x_nog) ##null model is best when Gila is removed

bestmod_ht_pca_x_nog <- lmer(value ~ (1|Provenance) + (1|BLK), data=ht_data_clim14)
summary(bestmod_ht_pca_x_nog)

##PCs and y 
mod_ht_pca_y <- lmer(value ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance) + (1|BLK), data=ht_data_clim14)
plot(mod_ht_pca_y)
qqmath(mod_ht_pca_y)
summary(mod_ht_pca_y)
dredge(mod_ht_pca_y)

bestmod_ht_pca_y <- lmer(value ~ PC1 + PC2 + I(PC2^2) + scale(y) + (1|Provenance) + (1|BLK), data=ht_data_clim14)
summary(bestmod_ht_pca_y)

ggplot(ht_data_clim14, aes(x=y, y=value))+
  geom_point()
ggplot(ht_data_clim14, aes(x=PC2, y=value, col=Provenance))+
  geom_point()

mod_ht_pca_y_nog <- lmer(value ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance) + (1|BLK), data=ht_data_clim14_nog)
plot(mod_ht_pca_y_nog)
qqmath(mod_ht_pca_y_nog)
summary(mod_ht_pca_y_nog)
dredge(mod_ht_pca_y_nog)

bestmod_ht_pca_y_nog <- lmer(value ~ y + I(y^2) + (1|Provenance) + (1|BLK), data=ht_data_clim14_nog)
summary(bestmod_ht_pca_y_nog) #quadratic y effect only marginally significant when Gila is removed


AICc(mod_ht_pca_x, mod_ht_pca_y) #y is lower
AICc(bestmod_ht_pca_y_nog, bestmod_ht_pca_y, bestmod_ht_pca_x_nog, bestmod_ht_pca_x) #y without Gila is best

###make plot
bestmod_ht_pca_y_nog_lm <- lm(value ~ scale(y) + I(scale(y)^2), data=ht_data_clim14_nog)
newdata_ht <- with(ht_data_clim14_nog, data.frame(y=seq(min(y),max(y),length.out=100)))

ht_predict <- predict(bestmod_ht_pca_y_nog_lm, newdata = newdata_ht, interval="confidence")

predictdataht <- cbind(newdata_ht, ht_predict)

ht_lat_plot <- ggplot()+
  geom_point(data=ht_data_clim14, aes(x=y, y=value, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdataht, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdataht, aes(x=y,y=fit), color="black")+
  xlab("Latitude")+
  ylab("Height (m)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position="none")

# ht_dbh_lat_plot<- ggplot()+
#   geom_jitter(data=ht_data_clim14, aes(x=y, y=value), width=.5,height=0, alpha=0.3)+
#   geom_jitter(data=dbh_num14_alldist, shape=2, aes(x=y, y=DBH), width=.5, height=0, alpha=0.3)+
#   geom_ribbon(data=predictdataht, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
#   geom_line(data=predictdataht, aes(x=y,y=fit), color="black")+
#   geom_ribbon(data=predictdatadbh, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
#   geom_line(data=predictdatadbh, aes(x=y,y=fit), color="black", lty=2)+
#   xlab(paste("Latitude (","\u00B0","N)",sep=""))+
#   ylab("Height (m) / DBH (cm)")+
#   #scale_color_manual(values=unname(stepped()),name="Provenance")+
#   theme_bw()+
#   theme(legend.position="right")
# 
# 
# 
# prov.legend <- get_legend(ggplot()+
#   geom_point(data=ht_data_clim14, aes(x=y, y=value, col=factor(Provenance, levels=provs_bylat$Provenance)))+
#   geom_ribbon(data=predictdataht, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
#   geom_line(data=predictdataht, aes(x=y,y=fit), color="black")+
#   scale_color_manual(values=unname(stepped()),name="Provenance")+
#   theme_bw()+
#   theme(legend.position="right"))
# geo.legend <- get_legend(interact_plot(ht_dist_mod_nog, pred=dist.to.plant, modx=geo.dist.to.plant.km, plot.points = TRUE, interval = TRUE, int.width = 0.95, colors="blue2", data=ht_data_clim14)+
#   theme_bw()+
#   theme(legend.position = "right")
# )

#png("figures/dbh_height_fig.png", width=9,height=7, units="in", res=500)
#grid.arrange(grid.arrange(dbh_dist_plot,dbh_lat_plot,ht_dist_plot,ht_lat_plot),grid.arrange(prov.legend,geo.legend, nrow=2, heights=c(1,0.4)),widths=c(1,0.4))
#dev.off()

```


#####with year
```{r}
ht_data_year_clim<- ht_data_year %>% 
  left_join(prov_pcapts)

ht_data_year_clim_noG <- ht_data_year_clim %>% 
  filter(!Provenance=="Gila NF")

###try year as a random effect
#y
mod_ht_pca_y_randtime <- lmer(log(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim)
plot(mod_ht_pca_y_randtime)
qqmath(mod_ht_pca_y_randtime)
summary(mod_ht_pca_y_randtime)
mod_ht_pca_y_randtime_dredge<- dredge(mod_ht_pca_y_randtime)
mod_ht_pca_y_randtime_dredge

bestmod_ht_pca_y_randtime <- lmer(value ~ y + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim)
summary(bestmod_ht_pca_y_randtime) #with Gila, positive effect of latitude

#no gila

mod_ht_pca_y_randtime_noG <- lmer(log(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_noG)
plot(mod_ht_pca_y_randtime_noG)
qqmath(mod_ht_pca_y_randtime_noG)
summary(mod_ht_pca_y_randtime_noG)
mod_ht_pca_y_randtime_noG_dredge<- dredge(mod_ht_pca_y_randtime_noG)
mod_ht_pca_y_randtime_noG_dredge 

bestmod_ht_pca_y_randtime_noG <- lmer(value ~ y + I(y^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_noG)
summary(bestmod_ht_pca_y_randtime_noG) #Without Gila, quadratic effect of latitude


#x
mod_ht_pca_x_randtime <- lmer(log(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim)
plot(mod_ht_pca_x_randtime)
qqmath(mod_ht_pca_x_randtime)
summary(mod_ht_pca_x_randtime)
mod_ht_pca_x_randtime_dredge<- dredge(mod_ht_pca_x_randtime)
mod_ht_pca_x_randtime_dredge ##best is null model

bestmod_ht_pca_x_randtime <- lmer(log(value) ~ (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim)
summary(bestmod_ht_pca_x_randtime)

#no gila
mod_ht_pca_x_randtime_noG <- lmer(log(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_noG)
plot(mod_ht_pca_x_randtime_noG)
qqmath(mod_ht_pca_x_randtime_noG)
summary(mod_ht_pca_x_randtime_noG)
mod_ht_pca_x_randtime_noG_dredge<- dredge(mod_ht_pca_x_randtime_noG)
mod_ht_pca_x_randtime_noG_dredge #null is best

bestmod_ht_pca_x_randtime_noG <- lmer(log(value) ~  (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_noG)
summary(bestmod_ht_pca_x_randtime_noG)

AICc(mod_ht_pca_x_randtime, mod_ht_pca_y_randtime) #latitude is better with Gila
AICc(mod_ht_pca_x_randtime_noG, mod_ht_pca_y_randtime_noG) ##without Gila, lat is better
AICc(bestmod_ht_pca_x_randtime_noG,bestmod_ht_pca_y_randtime_noG)
AICc(bestmod_ht_pca_x_randtime,bestmod_ht_pca_y_randtime)

###FINAL MODEL TO USE#####
summary(bestmod_ht_pca_y_randtime_noG)

####make plot for best final model
bestmod_ht_pca_y_randtime_lm <- lm(log(value) ~ y + I(y^2), data=ht_data_year_clim_noG)

newdata_ht_y <-  expand.grid(y=seq(min(ht_data_year_clim_noG$y), max(ht_data_year_clim_noG$y), length.out=50))
ht_predict_y <- predict(bestmod_ht_pca_y_randtime_lm, newdata = newdata_ht_y, interval="confidence")

predictdataht_y <- cbind(newdata_ht_y, ht_predict_y) %>% mutate(var="Latitude")

ht_y_plot <- ggplot()+
  geom_ribbon(data=predictdataht_y, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdataht_y, aes(x=y,y=fit), color="black")+
    geom_rug(data=ht_data_year_clim_noG %>% mutate(fit=.9), aes(x=y,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance Latitude")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
ht_y_plot
```

####individual climate var models

```{r}
ht_data_year_clim_long <- ht_data_year_clim %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality), names_to = "climvar.name", values_to = "climvar.value")

ht_data_year_clim_long_noG <- ht_data_year_clim_noG %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality), names_to = "climvar.name", values_to = "climvar.value")
  
  
ht_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) + (1|year), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods <- bind_rows(ht_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods %>% arrange(pvalue) ##lots significant with Gila, but when it's taken out, nothing is significant

###quadratic

ht_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad <- bind_rows(ht_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad %>% arrange(pvalue2_nog) #nothing significant when Gila is taken out
```

```{r}
##testing for each year separately

##1974
ht_mods74<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) , data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i] & name=="HT74"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT74"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods74 <- bind_rows(ht_mods74, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods74 %>% arrange(pvalue) 
###quadratic

ht_mods_quad74<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]& name=="HT74"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT74"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad74 <- bind_rows(ht_mods_quad74, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad74 %>% arrange(pvalue2_nog) 

summary(lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name=="Eref"& name=="HT74")))


##1979
ht_mods79<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) , data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i] & name=="HT79"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT79"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods79 <- bind_rows(ht_mods79, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods79 %>% arrange(pvalue_nog) 

summary(lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name=="RH" & name=="HT79"))) #greater RH = greater DBH

###quadratic

ht_mods_quad79<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]& name=="HT79"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT79"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad79 <- bind_rows(ht_mods_quad79, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad79 %>% arrange(pvalue2_nog) 




##1985
ht_mods85<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) , data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i] & name=="HT85"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT85"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods85 <- bind_rows(ht_mods85, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods85 %>% arrange(pvalue) 
###quadratic

ht_mods_quad85<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]& name=="HT85"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT85"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad85 <- bind_rows(ht_mods_quad85, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad85 %>% arrange(pvalue2_nog) 




##1991
ht_mods91<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) , data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i] & name=="HT91"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT91"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods91 <- bind_rows(ht_mods91, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods91 %>% arrange(pvalue) 
###quadratic

ht_mods_quad91<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]& name=="HT91"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT91"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad91 <- bind_rows(ht_mods_quad91, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad91 %>% arrange(pvalue2_nog) 
##1996
ht_mods96<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) , data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i] & name=="HT96"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT96"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods96 <- bind_rows(ht_mods96, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods96 %>% arrange(pvalue) 
###quadratic

ht_mods_quad96<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]& name=="HT96"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT96"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad96 <- bind_rows(ht_mods_quad96, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad96 %>% arrange(pvalue2_nog) 



##2006
ht_mods06<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) , data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i] & name=="HT06"))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) , data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT06"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods06 <- bind_rows(ht_mods06, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods06 %>% arrange(pvalue)
###quadratic

ht_mods_quad06<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]& name=="HT06"))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]& name=="HT06"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad06 <- bind_rows(ht_mods_quad06, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad06 %>% arrange(pvalue2_nog) 

```

```{r}
##DBH, Height and survival plots


```

##Cones

```{r}
cone_data <- moniger_data_comb %>% 
  dplyr::select(c(SORT,BLK,Provenance,Cones85:Cones06)) %>% 
  pivot_longer(Cones85:Cones06) %>% 
  mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006)) %>%
  filter(!is.na(value))

cone_sum <- cone_data %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance,year) %>% 
  summarise(value=sum(value), n=n()) %>% 
  mutate(prop.w.cones = value/n)

years_to_cone<- cone_data %>% filter(SORT %in%
                                       c(cone_data %>% 
                                       filter(!is.na(value)) %>% 
                                       group_by(SORT) %>% 
                                       summarise(n=n()) %>% 
                                       filter(n==4) %>% pull(SORT))) %>%
  filter(value==1) %>% 
  group_by(SORT, BLK, Provenance) %>% 
  summarise(min_year=min(year)) %>% 
  rbind(cone_data %>% filter(SORT %in%
                                       c(cone_data %>% 
                                       filter(!is.na(value)) %>% 
                                       group_by(SORT) %>% 
                                       summarise(n=n()) %>% 
                                       filter(n==4) %>% pull(SORT))) %>% 
          filter(year==2006 & value==0) %>% 
          mutate(min_year=NA) %>% 
          dplyr::select(-c("value","name","year"))) %>% 
  mutate(years_in_field = min_year-1970) %>% 
  distinct(SORT, BLK, Provenance, .keep_all = TRUE)

mean(years_to_cone$years_in_field, na.rm=T)
median(years_to_cone$years_in_field, na.rm=T)
min(years_to_cone$years_in_field, na.rm=T)
max(years_to_cone$years_in_field, na.rm=T)
par(mfrow=c(1,1))
hist(years_to_cone$years_in_field)
years_to_cone %>% filter(min_year==1985) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991)) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991,1996)) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991, 1996, 2006)) %>% nrow() / nrow(years_to_cone)


ggplot(data=years_to_cone %>% 
  group_by(Provenance,years_in_field) %>% 
  summarise(n=n()), aes(x=years_in_field, y=n, fill=Provenance))+
  geom_histogram(stat="identity")

ave_dbhs <- moniger_data_comb %>% 
  dplyr::select(c(SORT,BLK,Provenance,DBH91:DBH06)) %>% 
  pivot_longer(DBH91:DBH06) %>% 
  mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>% 
  filter(!is.na(value)) %>% 
  group_by(Provenance, year) %>% 
  summarise(ave.dbh = mean(value), se.dbh = sd(value)/sqrt(n())) %>% 
  left_join(cone_sum)

ave_dbh <- moniger_data_comb %>% 
  dplyr::select(c(SORT,BLK,Provenance,DBH91:DBH06)) %>% 
  pivot_longer(DBH91:DBH06) %>% 
  mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance, year) %>% 
  summarise(ave.dbh = mean(value), se.dbh = sd(value)/sqrt(n())) %>% 
  left_join(cone_sum)

ggplot(ave_dbhs, aes(x=ave.dbh, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_errorbar(aes(xmin=ave.dbh - se.dbh, xmax=ave.dbh+se.dbh))

ggplot(moniger_data_comb, aes(x=DBH91, y=Cones91))+
  geom_jitter(width=0.1)
ggplot(moniger_data_comb, aes(x=DBH96, y=Cones96))+
  geom_jitter(width=0.1)
ggplot(moniger_data_comb, aes(x=DBH06, y=Cones06))+
  geom_jitter(width=0.1)

ggplot(cone_sum, aes(x=year, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_line()

cone_sum_forfig<- cone_sum %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,2014), prop.w.cones=NA))

cone_means_fig <- ggplot(cone_sum_forfig, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=prop.w.cones*100, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(size=3, position = position_dodge(width=0.8))+
  #geom_line(position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Trees with Cones (%)")


```

###models

####logistic
```{r}

cone_data_binom = cone_data %>% 
  group_by(Provenance, year, BLK) %>% 
  summarise(n_cones = sum(value), total=n()) 

logmod_cat1 <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(year)*Provenance + (1|BLK), data=cone_data_binom, family=binomial)
diagnose(logmod_cat1)
summary(logmod_cat1)
Anova(logmod_cat1, type="3")
confint(logmod_cat1)


##predictions
newdata1 <- with(cone_data_binom, data.frame(year = seq(min(year),max(year),1), Provenance = rep(unique(cone_data$Provenance), each=22)))

newdata1<- expand.grid(Provenance=unique(cone_data_binom$Provenance),
            year=unique(cone_data_binom$year),
            BLK = unique(cone_data_binom$BLK))

newdata2 <- cbind(newdata1, predict(logmod_cat1, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_fig<- ggplot(newdata3, aes(x = year, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(Provenance, levels=provs_bylat$Provenance)), alpha = 0.2) + geom_line(aes(colour = factor(Provenance, levels=provs_bylat$Provenance)),
    linewidth = 1)+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  scale_fill_manual(values=unname(stepped()),name="Provenance")+
  ylab("Predicted Probability")+
  facet_wrap(~BLK)+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=10),
        axis.title = element_text(color="black", size=10),
        legend.position = "none",
        legend.text = element_text(color="black", size=8),
        legend.title = element_text(color="black", size=10))

# png("figures/cone_fig.png", height=3, width=3, res=300, units="in")
 cone_fig
# dev.off()
```

####PCA

```{r}
moniger_subset <- left_join(moniger_data_comb %>% 
  dplyr::select(c(Provenance, SORT, BLK, HT85, HT91, HT96, HT06, code)) %>%
  pivot_longer(HT85:HT06, values_to = "height") %>% 
    mutate(year=case_when(name == "HT85" ~ 1985,
                        name == "HT91" ~ 1991,
                        name == "HT96" ~ 1996,
                        name == "HT06" ~ 2006)) %>% 
  dplyr::select(-name),
moniger_data_comb %>% 
  dplyr::select(c(Provenance, SORT, BLK, DBH91, DBH96, DBH06, code)) %>%
  pivot_longer(DBH91:DBH06, values_to = "DBH") %>% 
    mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>% 
  dplyr::select(-name)) %>% 
left_join(cone_data_binom) %>% 
left_join(moniger_data_comb %>% 
  dplyr::select(c(SORT, BLK, PC1, PC2, PC3, x, y, code))) %>% 
  filter(!(is.na(height)|is.na(DBH)|is.na(n_cones)))

cone_clim_mod_htx <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_clim_mod_htx)

cone_clim_mod_hty <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(y) + I(scale(y)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_clim_mod_hty)

cone_clim_mod_dbhx <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(DBH)*PC1 + I(PC1^2) + scale(DBH)*PC2 + I(PC2^2) + scale(DBH)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_clim_mod_dbhx)

cone_clim_mod_dbhy <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(DBH)*PC1 + I(PC1^2) + scale(DBH)*PC2 + I(PC2^2) + scale(DBH)*scale(y) + I(scale(y)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_clim_mod_dbhy)

AICc(cone_clim_mod_hty, cone_clim_mod_dbhx, cone_clim_mod_dbhy,cone_clim_mod_htx) #htx is lowest

 # dredge.cone.clim <- dredge(cone_clim_mod_htx)
 # saveRDS(dredge.cone.clim, "dredge.cone.clim.RDS")
dredge.cone.clim <- readRDS("dredge.cone.clim.RDS")
dredge.cone.clim

best.mod.cone.clim <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height) + PC1 + I(PC1^2) + (1|code) + (1|year) + (1|BLK), data= moniger_subset, family = binomial)
summary(best.mod.cone.clim)


##predictions
CCnewdata1_cone <- expand.grid(height=c(3,6,9),
                          PC1 = seq(min(moniger_subset %>% pull(PC1)),
                                    max(moniger_subset  %>% pull(PC1)),1))


cone_clim_mod_glm1 <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height) + PC1 + I(PC1^2), data= moniger_subset, family = binomial)

CCnewdata2_cone <- cbind(CCnewdata1_cone, predict(cone_clim_mod_glm1, newdata = CCnewdata1_cone, type = "link", se=TRUE))
CCnewdata3_cone <- within(CCnewdata2_cone, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(CCnewdata3_cone, aes(x = PC1, y = PredictedProb, col= factor(height))) + 
  geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(height)), alpha = 0.2, col=NA) + geom_line(aes(colour = factor(height)),
    linewidth = 1)+
  geom_line(aes(x=PC1, y=PredictedProb, col=factor(height)))+
  scale_color_manual(values=viridis::mako(n=6), name = "height")+
  scale_fill_manual(values=viridis::mako(n=6),name="height")+
  theme_bw()+
  xlab("PC1")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")

#no gila
moniger_subset_nog <- moniger_subset %>% filter(!code=="GiNF")

cone_clim_mod_htx_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset_nog, family=binomial)
summary(cone_clim_mod_htx_nog)

 # dredge.cone.clim.nog <- dredge(cone_clim_mod_htx_nog)
 # saveRDS(dredge.cone.clim.nog, "dredge.cone.clim.nog.RDS")
dredge.cone.clim.nog <- readRDS("dredge.cone.clim.nog.RDS")
dredge.cone.clim.nog

best.mod.cone.clim_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height) + scale(x) + (1|code) + (1|year) + (1|BLK), data= moniger_subset %>% filter(!code=="GiNF"), family = binomial)
summary(best.mod.cone.clim_nog)

##testing other no Gila models
cone_clim_mod_hty_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(y) + I(scale(y)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset_nog, family=binomial)
cone_clim_mod_dbhx_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(DBH)*PC1 + I(PC1^2) + scale(DBH)*PC2 + I(PC2^2) + scale(DBH)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset_nog, family=binomial)
cone_clim_mod_dbhy_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(DBH)*PC1 + I(PC1^2) + scale(DBH)*PC2 + I(PC2^2) + scale(DBH)*scale(y) + I(scale(y)^2)+ (1|code) + (1|year) + (1|BLK), data=moniger_subset_nog, family=binomial)

AICc(cone_clim_mod_htx_nog,cone_clim_mod_hty_nog,cone_clim_mod_dbhx_nog,cone_clim_mod_dbhy_nog)

 # dredge.cone.clim.hty.nog <- dredge(cone_clim_mod_hty_nog)
 # saveRDS(dredge.cone.clim.hty.nog, "dredge.cone.clim.hty.nog.RDS")
 dredge.cone.clim.hty.nog <- readRDS("dredge.cone.clim.hty.nog.RDS")
dredge.cone.clim.hty.nog

best.mod.cone.clim_hty_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height) + scale(y) + I(scale(y)^2) + (1|code) + (1|year) + (1|BLK), data= moniger_subset %>% filter(!code=="GiNF"), family = binomial)
summary(best.mod.cone.clim_hty_nog)


##predictions - no gila - latitude
CCnewdata1_cone_nog_lat <- expand.grid(height=mean(moniger_subset_nog$height),
                          y=seq(min(moniger_subset_nog$y),max(moniger_subset_nog$y),1))


cone_clim_mod_nog_glm <- glmmTMB(cbind(n_cones, total-n_cones) ~  scale(height) + scale(y) + I(scale(y)^2) , data= moniger_subset_nog, family = binomial)
summary(cone_clim_mod_nog_glm)

CCnewdata2_cone_nog_lat <- cbind(CCnewdata1_cone_nog_lat, predict(cone_clim_mod_nog_glm, newdata = CCnewdata1_cone_nog_lat, type = "link", se=TRUE))
CCnewdata3_cone_nog_lat <- within(CCnewdata2_cone_nog_lat, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_plot_lat<- ggplot(CCnewdata3_cone_nog_lat %>% mutate(var="Latitude"), aes(x = y, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2, col=NA) + geom_line(linewidth = 1)+
  geom_line(aes(x=y, y=PredictedProb))+
  geom_rug(data=moniger_subset_nog%>% mutate(PredictedProb=.8), aes(x=y, y=PredictedProb), sides="b", linewidth=1, col="black", alpha=0.5)+
  theme_bw()+
  ylim(c(0,1))+
  ylab("Latitude")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")+
  facet_grid(~var)

##predictions - no gila - height
scale.y = scale(moniger_subset_nog$y)
scale.ht = scale(moniger_subset_nog$height)

newmod <- glmmTMB(cbind(n_cones, total-n_cones) ~  scale.ht + scale.y + I(scale.y^2) , data= moniger_subset_nog, family = binomial)
summary(newmod)

CCnewdata1_cone_nog_height <- expand.grid(scale.y=mean(scale.y),
                          scale.ht=seq(min(scale.ht),max(scale.ht),0.1))

CCnewdata2_cone_nog_height <- cbind(CCnewdata1_cone_nog_height, predict(newmod, newdata = CCnewdata1_cone_nog_height, type="link", se.fit=TRUE))
CCnewdata3_cone_nog_height <- within(CCnewdata2_cone_nog_height, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
}) %>% 
  mutate(height.m = scale.ht * sd(moniger_subset_nog$height) + mean(moniger_subset_nog$height))

cone_plot_height<- ggplot(CCnewdata3_cone_nog_height %>% mutate(var="Height"), aes(x = height.m, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2, col=NA) + geom_line(linewidth = 1)+
  geom_line(aes(x=height.m, y=PredictedProb))+
    geom_rug(data=moniger_subset_nog%>% mutate(PredictedProb=.8), aes(x=height, y=PredictedProb), sides="b", linewidth=1, col="black", alpha=0.5)+
  theme_bw()+
  ylim(c(0,1))+
  xlab("Height (m)")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")+
  facet_grid(~var)

ggarrange(cone_plot_lat, cone_plot_height)


```

####distance - cut

```{r, eval=FALSE}
cone_dist_data <- moniger_subset %>% 
  left_join(pca_dist_df, by=c("code","Provenance")) %>% 
  left_join(geo.dist.df) %>% 
  filter(!is.na(total))

cone_dist_data_nog <- cone_dist_data %>% filter(!Provenance == "Gila NF")

cone_dist_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km)*scale(height) + (1|code) + (1|year) + (1|BLK), data=cone_dist_data, family=binomial)
summary(cone_dist_mod)

cone_dist_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km)*scale(height) + (1|code) + (1|year) + (1|BLK), data=cone_dist_data_nog, family=binomial)
summary(cone_dist_mod_nog)

dredge.cone.dist <- dredge(cone_dist_mod)
dredge.cone.dist

dredge.cone.dist.nog <- dredge(cone_dist_mod_nog)
dredge.cone.dist.nog

cone_dist_bestmod <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(dist.to.plant.3d)*scale(height) + (1|code) + (1|year) + (1|BLK), data=cone_dist_data, family=binomial)
summary(cone_dist_bestmod)

cone_dist_mod_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(dist.to.plant.3d)*scale(height), data=cone_dist_data, family=binomial)

##predictions
CDnewdata1 <- expand.grid(dist.to.plant.3d = seq(min(cone_dist_data$dist.to.plant.3d), max(cone_dist_data$dist.to.plant.3d),1),
                          height = seq(min(cone_dist_data$height),max(cone_dist_data$height),1))

CDnewdata2 <- cbind(CDnewdata1, predict(cone_dist_mod_glm, newdata = CDnewdata1, type = "link", se=TRUE))
CDnewdata3 <- within(CDnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(CDnewdata3, aes(x = height, y = PredictedProb, col=factor(dist.to.plant.3d))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill=factor(dist.to.plant.3d)), alpha = 0.2) + geom_line(linewidth = 1, aes(col=factor(dist.to.plant.3d)))+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)

#no g predictions
cone_dist_bestmod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(dist.to.plant.3d)*scale(height) + scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|code) + (1|year) + (1|BLK), data=cone_dist_data  %>% filter(!Provenance == "Gila NF"), family=binomial)
summary(cone_dist_bestmod_nog)

cone_dist_mod_glm_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(dist.to.plant.3d)*scale(height) + scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km), data=cone_dist_data  %>% filter(!Provenance == "Gila NF"), family=binomial)

CDNGnewdata1 <- expand.grid(geo.dist.to.plant.km=seq(80,1600,by=190), 
                   height=seq(min(cone_dist_data  %>% filter(!Provenance == "Gila NF") %>% pull(height)), max(cone_dist_data  %>% filter(!Provenance == "Gila NF") %>% pull(height)), length.out=50),
                   dist.to.plant.3d = mean(cone_dist_data$dist.to.plant.3d))

CDNGnewdata2 <- cbind(CDNGnewdata1, predict(cone_dist_mod_glm_nog, newdata = CDNGnewdata1, type = "link", se=TRUE))
CDNGnewdata3 <- within(CDNGnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_dist_plot<- ggplot(CDNGnewdata3, aes(x = height, y = PredictedProb, col=factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill=factor(geo.dist.to.plant.km)), alpha = 0.2, col=NA) + geom_line(linewidth = 1, aes(col=factor(geo.dist.to.plant.km)))+
  scale_color_viridis(discrete = TRUE, name="Geographic\ndistance (km)")+
  scale_fill_viridis(discrete = TRUE, name="Geographic\ndistance (km)")+
  xlab("Height (m)")+
  ylab("Predicted Probability of Cones")+
  theme_bw()+
  theme(legend.position = "bottom")
cone_dist_plot
```

####other
```{r}
moniger_provclim<- moniger_subset %>% 
  left_join(as.data.frame(moniger_data_comb) %>% dplyr::select(c(Provenance,SORT,BLK,code,PC1,PC2,AHM:SHM,smrpb,monsoonality))) %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value") %>% 
  filter(!is.na(total))

cone_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value + (1|year) + (1|code) + (1|BLK), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value + (1|year) + (1|code) + (1|BLK), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!code=="GiNF"), family=binomial)
pvalue_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]

cone_mods <- bind_rows(cone_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

cone_mods %>% arrange(pvalue) ##smrpb is significant for both. PPTsm and monsoonality are significant for no-Gila only 
cone_mods %>% arrange(pvalue_nog) 

###smrpb
cone_smrpb_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value + (1|year) + (1|code) + (1|BLK), data=moniger_provclim %>% filter(climvar.name=="smrpb"), family=binomial)
summary(cone_smrpb_mod)

cone_smrpb_data <- moniger_provclim %>% filter(climvar.name=="smrpb")

newdata_smrpb_cone <- data.frame(
    climvar.value = seq(min(cone_smrpb_data$climvar.value), 
                      max(cone_smrpb_data$climvar.value), 
                      length.out = 100
                      ))

##take random effect out to make predictions
cone_smrpb_mod_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value), data=moniger_provclim %>% filter(climvar.name=="smrpb"), family=binomial)

##predictions
conesmrpb_newdata1 <- with(cone_smrpb_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

conesmrpb_newdata2 <- cbind(conesmrpb_newdata1, predict(cone_smrpb_mod_glm, newdata = conesmrpb_newdata1, type = "link", se=TRUE))
conesmrpb_newdata3 <- within(conesmrpb_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(conesmrpb_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")

#without Gila is still significant, but in opposite direction
cone_smrpb_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value + (1|year) + (1|Provenance)+(1|BLK), data=moniger_provclim %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family=binomial)
summary(cone_smrpb_mod_nog)

cone_smrpb_data_nog <- moniger_provclim %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF")

#prediction
##take random effect out to make predictions
cone_smrpb_mod_nog_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value), data=cone_smrpb_data_nog, family=binomial)

##predictions
conesmrpb_nog_newdata1 <- with(cone_smrpb_data_nog, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

conesmrpb_nog_newdata2 <- cbind(conesmrpb_nog_newdata1, predict(cone_smrpb_mod_nog_glm, newdata = conesmrpb_nog_newdata1, type = "link", se=TRUE))
conesmrpb_nog_newdata3 <- within(conesmrpb_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

smrpb_cone_plot_nog <- ggplot(conesmrpb_nog_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("Summer/Spring precip ratio")+
  ylab("Predicted Probability")+
  theme_bw()

cone_smrpb_plot_data<- conesmrpb_newdata3 %>% 
  mutate(model="with Gila NF") %>% 
  bind_rows(conesmrpb_nog_newdata3 %>% mutate(model="without Gila NF")) %>% 
  mutate(var="Summer Precip Ratio")

cone_smrpb_plot<- ggplot(cone_smrpb_plot_data, aes(x = climvar.value, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL,ymax = UL, fill=model), alpha = 0.2) + 
  geom_line(linewidth = 1, aes(linetype=model))+
  geom_rug(data=moniger_provclim %>% filter(climvar.name=="smrpb") %>% mutate(PredictedProb=0.6), sides="b", linewidth=1, color="black", alpha=0.5)+
  scale_linetype_manual(values=c(2,1))+
  scale_fill_manual(values=c("darkgray","black"))+
  ylim(c(0,1))+
  xlab("Provenance summer/spring precip ratio")+
  ylab("Predicted Probability of Cones")+
  theme_bw()+
  facet_grid(~var)


###quadratic

cone_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|code) + (1|year) + (1|BLK), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalues<- as.data.frame(summary(mod)$coefficients$cond[2:3,])$`Pr(>|z|)`

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|code) + (1|year) + (1|BLK), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!code=="GiNF"), family=binomial)
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond[2:3,])$`Pr(>|z|)`

cone_mods_quad <- bind_rows(cone_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))
}

cone_mods_quad %>% arrange(pvalue2_nog) ##none significant 
```

###plots
```{r}

cone_plot<- ggarrange(ggarrange(cone_plot_lat, cone_plot_height, nrow=1), cone_smrpb_plot, nrow=2)

png("figures/cone_plot.png", width=5, height=6, units="in", res=300)
cone_plot
dev.off()

```

##Survival

###models

####Provenance
```{r}
#provenance affect on survival 
moniger_survival <- moniger_data_comb %>% 
  mutate(Stat14 = ifelse(Stat14==9,0,Stat14))

moniger_survival_byyr <- moniger_data_comb %>% 
  mutate(Stat79 = ifelse(Stat74 == 9, NA, Stat79)) %>% 
  mutate(Stat85 = ifelse(Stat79 %in% c(NA,9), NA, Stat85)) %>% 
  mutate(Stat91 = ifelse(Stat85 %in% c(NA,9), NA, Stat91)) %>% 
  mutate(Stat96 = ifelse(Stat91 %in% c(NA,9), NA, Stat96)) %>% 
  mutate(Stat06 = ifelse(Stat96 %in% c(NA,9), NA, Stat06)) %>% 
  mutate(Stat14 = ifelse(Stat06 %in% c(NA,9), NA, Stat14)) %>% 
  dplyr::select(c(SORT,BLK,Provenance,Stat74:Stat14)) %>% 
  pivot_longer(Stat74:Stat14) %>% 
  mutate(year=case_when(name == "Stat74" ~ 1974,
                        name == "Stat79" ~ 1979,
                        name == "Stat85" ~ 1985,
                        name == "Stat91" ~ 1991,
                        name == "Stat96" ~ 1996,
                        name == "Stat06" ~ 2006,
                        name == "Stat14" ~ 2014)) %>% 
  mutate(value = ifelse(value==9,0,value)) %>% 
  filter(!is.na(value))

moniger_survival_byyr_binom <- moniger_survival_byyr %>% 
  group_by(Provenance,BLK,year) %>% 
  summarise(n_surv=sum(value), total=n())

survmod_byyear<- glmmTMB(cbind(n_surv, total-n_surv) ~ scale(year)*Provenance + (1|BLK), data=moniger_survival_byyr_binom, family=binomial)
Anova(survmod_byyear, type="3")

diagnose(survmod_byyear)

##predictions by year
newdata1 <- expand.grid(year=seq(min(moniger_survival_byyr_binom$year),max(moniger_survival_byyr_binom$year),1),
                        Provenance=unique(moniger_survival_byyr_binom$Provenance),
                        BLK = unique(moniger_survival_byyr_binom$BLK))
newdata2 <- cbind(newdata1, predict(survmod_byyear, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(newdata3, aes(x = year, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(Provenance, levels=provs_bylat$Provenance)), alpha = 0.2) + geom_line(aes(colour = factor(Provenance, levels=provs_bylat$Provenance)),
    linewidth = 1)+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  scale_fill_manual(values=unname(stepped()),name="Provenance")+
  ylab("Predicted Probability")+
  facet_wrap(~BLK)+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=10),
        axis.title = element_text(color="black", size=10),
        legend.text = element_text(color="black", size=8),
        legend.title = element_text(color="black", size=10))

moniger_survival_byyr_sum <- moniger_survival_byyr %>% 
  group_by(Provenance,year) %>% 
  summarise(alive = sum(value), total=n()) %>% 
  mutate(surv = alive/total)

ggplot()+
  geom_bar(data=plantation_clim, aes(x=year, y=scale(value_sm_tmean)), stat="identity", col="darkgray")+
  geom_point(data = moniger_survival_byyr_sum, aes(x=year, y=surv, col=Provenance))+
  geom_line(data = moniger_survival_byyr_sum, aes(x=year, y=surv, col=Provenance))+
  theme_bw()

ggplot()+
  geom_bar(data=plantation_clim, aes(x=year, y=scale(cwd_sum)), stat="identity", col="darkgray")+
  geom_point(data = moniger_survival_byyr_sum, aes(x=year, y=surv, col=Provenance))+
  geom_line(data = moniger_survival_byyr_sum, aes(x=year, y=surv, col=Provenance))+
  theme_bw()

####ANOVAs for each year separately

survmod74 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1974), family=binomial)
Anova(survmod74, type="3")
confint(survmod74)

survmod79 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1979), family=binomial)
Anova(survmod79, type="3")
confint(survmod79)

survmod85 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1985), family=binomial)
Anova(survmod85, type="3")
confint(survmod85)

survmod91 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1991), family=binomial)
Anova(survmod91, type="3")
confint(survmod91)

survmod96 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1996), family=binomial)
Anova(survmod96, type="3")
confint(survmod96)

survmod06 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==2006), family=binomial)
Anova(survmod06, type="3")
confint(survmod06)

survmod14 <- glmmTMB(cbind(n_surv, total-n_surv) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==2014), family=binomial)
Anova(survmod14, type="3")
confint(survmod14)

survival_means <- left_join(
moniger_survival_byyr %>% 
  filter(name=="Stat74") %>% 
  group_by(Provenance) %>% 
  summarise(alltrees74=n()),
moniger_survival_byyr %>% 
  group_by(Provenance, year) %>% 
  summarise(n.trees=sum(value)) %>% 
  pivot_wider(names_from=year, values_from=n.trees), by="Provenance") %>% 
    mutate("1974" = `1974`/alltrees74, 
           "1979" = `1979`/alltrees74,
           "1985" = `1985`/alltrees74,
           "1991" = `1991`/alltrees74,
           "1996" = `1996`/alltrees74,
           "2006" = `2006`/alltrees74,
           "2014" = `2014`/alltrees74) %>% 
    pivot_longer(`1974`:`2014`, names_to="year", values_to="prop.surv.since.1970")

survival_means_fig <- ggplot(survival_means, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=prop.surv.since.1970*100, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(size=3, position = position_dodge(width=0.8))+
  #geom_line(position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Survival (%)")

#png("figure_summary.png", width=190, height=225, unit="mm", res=600)
ggarrange(dbh_means_fig, ht_means_fig, survival_means_fig, cone_means_fig, ncol=1, nrow=4, common.legend = TRUE)
#dev.off()
```

```{r}
##ranking provenances by dbh, height, survival

head(dbh_num14_alldist)
head(ht_data_clim14)

aveht14 <- ht_data_clim14 %>% 
  group_by(Provenance) %>% 
  summarise(meanht14=mean(value, na.rm=T), n.ht=n())

avedbh14<- dbh_num14_alldist %>% 
  group_by(Provenance) %>% 
  summarise(meandbh14 = mean(DBH, na.rm=T), n.dbh=n())

surv14<- left_join(
moniger_survival_byyr %>% 
  filter(name=="Stat74") %>% 
  group_by(Provenance) %>% 
  summarise(alivetrees74 = sum(value), alltrees74=n()),
moniger_survival_byyr %>% 
  filter(name=="Stat14") %>% 
  group_by(Provenance) %>% 
  summarise(alivetrees14 = sum(value))) %>% 
  mutate(prop.surv.74=alivetrees14/alivetrees74,
         prop.surv.70=alivetrees14/alltrees74)

ranking.table<- as.data.frame(left_join(aveht14, avedbh14) %>% 
  left_join(surv14))

cor.test(ranking.table$meanht14, ranking.table$meandbh14)
cor.test(ranking.table$meanht14, ranking.table$prop.surv.70)
cor.test(ranking.table$meandbh14, ranking.table$prop.surv.70)
cor.test(ranking.table$meanht14, ranking.table$prop.surv.74)
cor.test(ranking.table$meandbh14, ranking.table$prop.surv.74)

ranking.table.nog<- ranking.table %>% filter(!Provenance=="Gila NF")
cor.test(ranking.table.nog$meanht14, ranking.table.nog$meandbh14)
cor.test(ranking.table.nog$meanht14, ranking.table.nog$prop.surv.70)
cor.test(ranking.table.nog$meandbh14, ranking.table.nog$prop.surv.70)
cor.test(ranking.table.nog$meanht14, ranking.table.nog$prop.surv.74)
cor.test(ranking.table.nog$meandbh14, ranking.table.nog$prop.surv.74)

#write.csv(ranking.table, "ranking.table.csv")

```

####PCA
```{r}
surv_df_zero <- expand.grid(Provenance=unique(moniger_survival_byyr$Provenance),
                            BLK = unique(moniger_survival_byyr$BLK))

moniger_survival_byyr_binom_2014<- moniger_survival_byyr %>% 
  group_by(Provenance,BLK,year) %>% 
  summarise(alive=sum(value)) %>% 
  filter(year=="2014") %>% 
  mutate(died=4-alive) %>% 
  full_join(surv_df_zero) %>% 
  mutate(year=ifelse(is.na(year),2014,year),
         alive=ifelse(is.na(alive),0,alive),
         died=ifelse(is.na(died),4,died)) %>% 
  left_join(moniger_survival %>% dplyr::select(c(Provenance,BLK,PC1,PC2,AHM:SHM,x,y,smrpb,monsoonality)) %>% unique()) 

moniger_survival_byyr_binom<- moniger_survival_byyr %>% 
  group_by(Provenance,BLK,year) %>% 
  summarise(alive=sum(value)) %>% 
  mutate(died=4-alive) %>% 
  full_join(surv_df_zero) %>% 
  mutate(year=ifelse(is.na(year),2014,year),
         alive=ifelse(is.na(alive),0,alive),
         died=ifelse(is.na(died),4,died)) %>% 
  left_join(moniger_survival %>% dplyr::select(c(Provenance,BLK,PC1,PC2,AHM:SHM,x,y,smrpb,monsoonality)) %>% unique()) 

##
survmod_pcx<- glmmTMB(cbind(alive,died) ~  PC1*PC2 + scale(x)*PC1 + scale(x)*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_byyr_binom, family=binomial) 
summary(survmod_pcx)

survmod_pcy<- glmmTMB(cbind(alive,died) ~ PC1*PC2 + scale(y)*PC1 + scale(y)*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_byyr_binom, family=binomial)
summary(survmod_pcy)

AICc(survmod_pcx, survmod_pcy) #y is lower

# dredge_survmod_pcy <- dredge(survmod_pcy)
# saveRDS(dredge_survmod_pcy, "dredge_survmod_pcy.RDS")
dredge_survmod_pcy <- readRDS("dredge_survmod_pcy.RDS")
dredge_survmod_pcy
bestsurvmod_pcy <- glmmTMB(cbind(alive,died) ~ scale(y) + I(scale(y)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_byyr_binom, family=binomial)
summary(bestsurvmod_pcy)

bestsurvmod_pcy_glm <- glmmTMB(cbind(alive,died) ~ scale(y) + I(scale(y)^2), data=moniger_survival_byyr_binom, family=binomial)


## these plots don't work anymore ##
# surv_pc1_plot<- interact_plot(bestsurvmod_pcy, pred=y, modx=PC1, plot.points = TRUE, interval = TRUE, int.width = 0.95, data=moniger_survival, int.type="confidence", x.label=paste("Latitude (","\u00B0","N)",sep=""), y.label = "Survival Probability", colors="Oranges")
# surv_pc2_plot <- interact_plot(bestsurvmod_pcy, pred=y, modx=PC2, plot.points = TRUE, interval = TRUE, int.width = 0.95, data=moniger_survival, int.type="confidence", x.label=paste("Latitude (","\u00B0","N)",sep=""), y.label = "Survival Probability", colors="PuRd")


moniger_survival_nog <- moniger_survival_byyr_binom %>% filter(!Provenance%in%c("Gila NF"))

survmod_pcy_nog<- glmmTMB(cbind(alive,died) ~ PC1*PC2 + scale(y)*PC1 + scale(y)*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_nog, family=binomial)

survmod_pcx_nog<- glmmTMB(cbind(alive,died) ~ PC1*PC2 + scale(x)*PC1 + scale(x)*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_nog, family=binomial)

AICc(survmod_pcy_nog, survmod_pcx_nog)

summary(survmod_pcy_nog)
# dredge_survmod_pcy_nog <- dredge(survmod_pcy_nog)
# saveRDS(dredge_survmod_pcy_nog, "dredge_survmod_pcy_nog.RDS")
dredge_survmod_pcy_nog<- readRDS("dredge_survmod_pcy_nog.RDS")
dredge_survmod_pcy_nog

bestsurvmod_pcy_nog <- glmmTMB(cbind(alive,died) ~ scale(y) + I(scale(y)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_nog, family=binomial)
summary(bestsurvmod_pcy_nog)

#predict
bestsurvmod_pcy_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(y) + I(scale(y)^2), data=moniger_survival_nog, family=binomial)

newdata1 <- expand.grid(y = seq(min(moniger_survival_nog$y),max(moniger_survival_nog$y),.5))
newdata2_nog <- cbind(newdata1, predict(bestsurvmod_pcy_nog_glm, newdata = newdata1, type = "link", se=TRUE))
newdata3_nog <- within(newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
}) %>% 
  mutate(var="Latitude")


surv_y_plot<- ggplot() + 
  geom_ribbon(data=newdata3_nog, aes(x=y, ymin = LL, ymax = UL), alpha=0.2) +
  geom_line(data=newdata3_nog, aes(x = y, y = PredictedProb))+
  geom_rug(data=moniger_survival_nog %>% mutate(PredictedProb=.8), aes(x=y, y=PredictedProb), sides="b", linewidth=1, col="black")+
  xlab("Provenance Latitude")+
  ylab("Survival Probability")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
surv_y_plot

lat_plot_data<- bind_rows(
newdata3_nog %>% 
  mutate(var="Survival Probability") %>% 
  rename(lwr=LL, upr=UL),
predictdataht_y %>% 
  mutate(var="Height (m)", PredictedProb=fit),
predictdatadbh_y %>% 
   mutate(var="DBH (cm)", PredictedProb=fit))

sig.values.lat.plot <- data.frame(var=c("Survival Probability", "Height (m)", "DBH (cm)"), pvalue = c("p = 0.06", "p < 0.05","p < 0.01"), x=47.5, y=c(0.83,1.1,11.5))

lat_plot_rug_data<- bind_rows(
moniger_survival_nog %>% 
  mutate(var="Survival Probability"),
ht_data_year_clim_noG %>% 
  mutate(var="Height (m)"),
dbh_numeric_time_noG %>% 
   mutate(var="DBH (cm)"))


lat_plot <- ggplot() + 
  geom_ribbon(data=lat_plot_data, aes(x=y, ymin = lwr, ymax = upr), alpha=0.2) +
  geom_line(data=lat_plot_data, aes(x = y, y = PredictedProb))+
  geom_text(data=sig.values.lat.plot, aes(x=x,y=y,label=pvalue))+
  geom_rug(data=lat_plot_rug_data, aes(x=y), sides="b", linewidth=1)+
  xlab("Latitude")+
  ylab("")+
  facet_wrap(~var, scale="free")+
  theme_bw()+
  theme(legend.position="none")
lat_plot

##with gila
newdata2 <- cbind(newdata1, predict(bestsurvmod_pcy_glm, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(data=newdata3, aes(x = y, y = PredictedProb)) + 
  geom_line()+
  geom_ribbon(aes(ymin = LL, ymax = UL), alpha=0.5) +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

####distance - cut

```{r, eval=FALSE}
#distance
surv_pcadist_data <- moniger_survival_byyr_binom_2014 %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

survmod_dist<- glmmTMB(cbind(alive,died) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance) + (1|BLK), data=surv_pcadist_data, family = binomial)
summary(survmod_dist) 
dredge(survmod_dist)

bestmod_survmod_dist <-  glmmTMB(cbind(alive,died) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance) + (1|BLK), data=surv_pcadist_data, family = binomial)
summary(bestmod_survmod_dist)

# surv_int_plot<- interact_plot(bestmod_survmod_dist, pred=geo.dist.to.plant.km, modx=dist.to.plant.3d , plot.points = TRUE, interval = TRUE, int.width = 0.95, data=surv_pcadist_data, y.label="Survival Probability", x.label=element_blank(), legend.main="Climatic Distance", colors = "Greys")
# 
# ggarrange(ht_int_plot, surv_int_plot, dbh_int_plot, cone_int_plot, nrow=2, ncol=2, common.legend = TRUE)


###make plot for distance model
SDnewdata1 <- expand.grid(dist.to.plant.3d = seq(min(surv_pcadist_data$dist.to.plant.3d), max(surv_pcadist_data$dist.to.plant.3d),1),
                          geo.dist.to.plant.km = c(mean(surv_pcadist_data$geo.dist.to.plant.km) - sd(surv_pcadist_data$geo.dist.to.plant.km), mean(surv_pcadist_data$geo.dist.to.plant.km), mean(surv_pcadist_data$geo.dist.to.plant.km)+sd(surv_pcadist_data$geo.dist.to.plant.km)),
                          Provenance="Pike NF",
                          BLK = "C")

SDnewdata2 <- cbind(SDnewdata1, predict(bestmod_survmod_dist, newdata = SDnewdata1, type = "link", se=TRUE))
SDnewdata3 <- within(SDnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_dist_plot<-ggplot(SDnewdata3, aes(x = dist.to.plant.3d, y = PredictedProb, col= factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(geo.dist.to.plant.km)),col=NA, alpha = 0.2) + geom_line(aes(colour = factor(geo.dist.to.plant.km)),
    linewidth = 1)+
  geom_line()+
  scale_color_viridis(discrete=T, name="Geographic\ndistance (km)")+
  scale_fill_viridis(discrete=T, name="Geographic\ndistance (km)")+
  xlab("Climatic distance")+
  ylab("Predicted Probability of Survival")+
  theme_bw()+
  theme(legend.position = "bottom")

##no gila
surv_pcadist_data_nog <- surv_pcadist_data %>% filter(!Provenance=="Gila NF")

survmod_dist_nog<- glmmTMB(cbind(alive,died) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance) + (1|BLK), data=surv_pcadist_data_nog, family = binomial)
summary(survmod_dist_nog)
dredge(survmod_dist_nog)

best_survmod_dist_nog<- glmmTMB(cbind(alive,died) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance) + (1|BLK), data=surv_pcadist_data_nog, family = binomial)
summary(best_survmod_dist_nog)


###make plot for distance model
SDnewdata_nog1 <-  expand.grid(dist.to.plant.3d = seq(min(surv_pcadist_data_nog$dist.to.plant.3d), max(surv_pcadist_data_nog$dist.to.plant.3d),1),
                          geo.dist.to.plant.km = c(mean(surv_pcadist_data_nog$geo.dist.to.plant.km) - sd(surv_pcadist_data_nog$geo.dist.to.plant.km), mean(surv_pcadist_data_nog$geo.dist.to.plant.km), mean(surv_pcadist_data_nog$geo.dist.to.plant.km)+sd(surv_pcadist_data_nog$geo.dist.to.plant.km)),
                          Provenance="Pike NF",
                          BLK = "C")

SDnewdata_nog2 <- cbind(SDnewdata_nog1, predict(best_survmod_dist_nog, newdata = SDnewdata_nog1, type = "link", se=TRUE))
SDnewdata_nog3 <- within(SDnewdata_nog2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(SDnewdata_nog3, aes(x = dist.to.plant.3d, y = PredictedProb, col= factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(geo.dist.to.plant.km)),col=NA, alpha = 0.2) + geom_line(aes(colour = factor(geo.dist.to.plant.km)),
    linewidth = 1)+
  geom_line()+
  scale_color_viridis(discrete=T, name="Geographic distance (km)")+
  scale_fill_viridis(discrete=T, name="Geographic distance (km)")+
  xlab("Climatic distance")+
  ylab("Predicted Probability")+
  theme_bw()
```

####extra

```{r}
moniger_survival_long <- moniger_survival_byyr_binom %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

surv_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- as.data.frame(summary(mod)$coefficients$cond)[2,]$`Pr(>|z|)`

mod_nog <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family=binomial)
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2,]$`Pr(>|z|)`

surv_mods <- bind_rows(surv_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))}

surv_mods %>% arrange(pvalue_nog) ##length of growing season seems to be influential both with and without Gila, also smrpb


#FFP

#FFP
surv_FFP_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="FFP"), family="binomial")
summary(surv_FFP_mod)

surv_FFP_data <- moniger_survival_long %>% filter(climvar.name=="FFP")

newdata_FFP_surv <- data.frame(
    climvar.value = seq(min(surv_FFP_data$climvar.value), 
                      max(surv_FFP_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
survFFP_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_FFP_surv$climvar.value),max(newdata_FFP_surv$climvar.value),length.out=50))

surv_FFP_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="FFP"), family="binomial")

survFFP_newdata2 <- cbind(survFFP_newdata1, predict(surv_FFP_mod_glm, newdata = survFFP_newdata1, type = "link", se=TRUE))
survFFP_newdata3 <- within(survFFP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(survFFP_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("FFP")

#without Gila is still significant
surv_FFP_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_FFP_mod_nog)

surv_FFP_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_FFP_mod_nog)

##predictions
surv_FFP_data_nog <- moniger_survival_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF")

survFFP_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv_FFP_data_nog$climvar.value),max(surv_FFP_data_nog$climvar.value),length.out=50))

survFFP_nog_newdata2 <- cbind(survFFP_nog_newdata1, predict(surv_FFP_mod_nog_glm, newdata = survFFP_nog_newdata1, type = "link", se=TRUE))
survFFP_nog_newdata3 <- within(survFFP_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

survFFP_bothmod_data<- bind_rows(survFFP_newdata3 %>% mutate(model="with Gila NF"),
survFFP_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(survFFP_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("FFP")
#########
#########

#smrpb
surv_smrpb_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="smrpb"), family="binomial")
summary(surv_smrpb_mod)

surv_smrpb_data <- moniger_survival_long %>% filter(climvar.name=="smrpb")

newdata_smrpb_surv <- data.frame(
    climvar.value = seq(min(surv_smrpb_data$climvar.value), 
                      max(surv_smrpb_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
survsmrpb_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_smrpb_surv$climvar.value),max(newdata_smrpb_surv$climvar.value),length.out=50))

surv_smrpb_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="smrpb"), family="binomial")

survsmrpb_newdata2 <- cbind(survsmrpb_newdata1, predict(surv_smrpb_mod_glm, newdata = survsmrpb_newdata1, type = "link", se=TRUE))
survsmrpb_newdata3 <- within(survsmrpb_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(survsmrpb_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")

#without Gila is still significant
surv_smrpb_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_smrpb_mod_nog)

##predictions
surv_smrpb_data_nog <- moniger_survival_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF")

survsmrpb_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv_smrpb_data_nog$climvar.value),max(surv_smrpb_data_nog$climvar.value),length.out=50),
                                 Provenance = "Pike NF",
                                 BLK = "C",
                                 year=2006)

survsmrpb_nog_newdata2 <- cbind(survsmrpb_nog_newdata1, predict(surv_smrpb_mod_nog, newdata = survsmrpb_nog_newdata1, type = "link", se=TRUE))
survsmrpb_nog_newdata3 <- within(survsmrpb_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

survsmrpb_bothmod_data<- bind_rows(survsmrpb_newdata3 %>% mutate(model="with Gila NF"),
survsmrpb_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(survsmrpb_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")
#########

###quadratic

surv_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`

mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2:3,]$`Pr(>|z|)`

surv_mods_quad <- bind_rows(surv_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

surv_mods_quad %>% arrange(pvalue2_nog) ##MCMT, Eref, and CMD are significant both with and without Gila

##Eref
surv_Eref_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="Eref"), family="binomial")
summary(surv_Eref_mod)

surv_Eref_data <- moniger_survival_long %>% filter(climvar.name=="Eref")

##predictions
survEref_newdata1 <- expand.grid(climvar.value = seq(min(surv_Eref_data$climvar.value),max(surv_Eref_data$climvar.value),length.out=50))

surv_Eref_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="Eref"), family="binomial")

survEref_newdata2 <- cbind(survEref_newdata1, predict(surv_Eref_mod_glm, newdata = survEref_newdata1, type = "link", se=TRUE))
survEref_newdata3 <- within(survEref_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_Eref_plot<- ggplot(survEref_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_point()+
  xlab("Eref")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()


#without Gila is still significant
surv_eref_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_eref_mod_nog)

surv_eref_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surveref_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

surveref_newdata2_nog <- cbind(surveref_newdata1_nog, predict(surv_eref_mod_nog_glm, newdata = surveref_newdata1_nog, type = "link", se=TRUE))
surveref_newdata3_nog <- within(surveref_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_eref_bothmod <- bind_rows(survEref_newdata3 %>% mutate(model="with Gila NF"),surveref_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv_eref_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("Eref")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()
#########

##cmd
surv_cmd_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="CMD"), family="binomial")
summary(surv_cmd_mod)

surv_cmd_data <- moniger_survival_long %>% filter(climvar.name=="CMD")

##predictions
survcmd_newdata1 <- expand.grid(climvar.value = seq(min(surv_cmd_data$climvar.value),max(surv_cmd_data$climvar.value),length.out=50))

surv_cmd_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="CMD"), family="binomial")

survcmd_newdata2 <- cbind(survcmd_newdata1, predict(surv_cmd_mod_glm, newdata = survcmd_newdata1, type = "link", se=TRUE))
survcmd_newdata3 <- within(survcmd_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_cmd_plot<- ggplot(survcmd_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("CMD")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()

#without Gila is still significant
surv_cmd_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_cmd_mod_nog)

surv_cmd_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")


##predictions
survcmd_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

survcmd_newdata2_nog <- cbind(survcmd_newdata1_nog, predict(surv_cmd_mod_nog_glm, newdata = survcmd_newdata1_nog, type = "link", se=TRUE))
survcmd_newdata3_nog <- within(survcmd_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_cmd_bothmod <- bind_rows(survcmd_newdata3 %>% mutate(model="with Gila NF"),survcmd_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv_cmd_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("CMD")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()
```

####plots

```{r}
#plots

surv_ind_plot_data<- bind_rows(surv_cmd_bothmod %>% mutate(climvar.name="CMD"),
survFFP_bothmod_data %>% mutate(climvar.name="FFP"),
surv_eref_bothmod %>% mutate(climvar.name="Eref"),
survsmrpb_bothmod_data %>% mutate(climvar.name="smrpb"))

surv_ind_plot<- ggplot(surv_ind_plot_data, aes(x = climvar.value, y = PredictedProb)) + 
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(climvar.name=name)%>% filter(climvar.name %in% unique(surv_ind_plot_data$climvar.name)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(climvar.name=name)%>% filter(climvar.name %in% unique(surv_ind_plot_data$climvar.name)), aes(x=value, y=.7, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(aes(ymin = LL, ymax = UL, fill=model), alpha = 0.2) + 
  geom_line(linewidth = .5, aes(linetype=model))+
  geom_rug(data=moniger_survival_long %>% filter(climvar.name%in%c("Eref","CMD","FFP","smrpb")) %>% mutate(PredictedProb=.7), sides="b", linewidth=1)+
  scale_fill_manual(values=c("black","gray"))+
  ylab("Survival Probability")+
  xlab("Provenance Climate Value")+
  facet_wrap(~factor(climvar.name, levels=c("FFP","smrpb","CMD","Eref"), labels=c("Frost-Free Period (days)","Summer Precip Ratio","Climate Moisture Deficit (mm)","Hargreave's reference evaporation")), scales="free")+
  theme_bw()
surv_ind_plot

ht_dbh_surv_plot<- ggarrange(lat_plot,surv_ind_plot,nrow=2)
ht_dbh_surv_plot

png("figures/ht_dbh_surv_plot.png", width=7, height=7, units="in", res=300)
ht_dbh_surv_plot
dev.off()

#png("figures/survival_plot.png", width=9.5, height=7.5, units = "in", res=500)
#ggarrange(ggarrange(surv_byprov, surv_dist_plot, ncol=2, labels=c("A)","B)")),surv_sig_clim_plot,nrow=2, labels = c("","C)"), heights=c(1,0.8))
#dev.off()
```

##RWI

###Raw

```{r}
prov_all <- read.rwl("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Ring_widths_raw/prov_all.rwl")

rwi.stats(prov_all)
```

####exploration
```{r}
#plot raw data to look at timeseries length
par(mfrow=c(1,1))
plot.rwl(prov_all)

##compare timing of when trees reached 30cm tall (and thus had a growth ring measured)
dbh_age <- prov_all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(prov_all)) %>% 
  pivot_longer(!year, values_to = "rw", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")) %>% 
              left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
              mutate(Provenance = newname) %>% 
              dplyr::select(-newname), by="tree")
  
dbh_age_summary <- dbh_age %>%
  filter(!is.na(rw)) %>% 
  group_by(Provenance,tree) %>% 
  summarise(minyr = min(year), maxyr=max(year), n=n()) %>% 
  mutate(years.calc = maxyr-minyr+1)

#compare when time series started (min year)
ggplot(dbh_age_summary, aes(x=factor(Provenance, levels=prov_pcapts %>% arrange(y) %>% pull(Provenance)), y=minyr))+
  geom_boxplot()+
  geom_point(color="maroon")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#compare length of timeseries
ggplot(dbh_age_summary, aes(x=Provenance, y=n))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

dbh_age_summary2 <- dbh_age_summary %>% 
  left_join(dbh %>% mutate(Series=paste("X",Series,sep="")), by=c("tree"="Series","Provenance")) 

ggplot(dbh_age_summary2, aes(x=minyr, y=DBH14, col=Provenance))+
  geom_point() #there isn't a strong correlation between dbh and the length of the timeseries which makes me think that rings were just lost (not that the tree didn't reach DBH height until the min year)
###

##remove NAs from ring width series
prov_all_nona<- prov_all %>% na.omit()
colnames(prov_all_nona)

##raw
ggplot(dbh_age, aes(x=year, y=rw, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance)+
  theme(legend.position = "none")

hist(dbh_age$rw)
hist(dbh_age %>% filter(rw<0.5) %>% pull(rw))

###investigating series with really low ring width values
dbh_rwi_comp <- dbh_age %>% 
  filter(!tree=="X32A1") %>% 
  group_by(Provenance, tree) %>% 
  summarise(sum=sum(rw, na.rm = TRUE)) %>% 
  arrange(tree) %>% 
  bind_cols(dbh %>%
              filter(Series %in% unique(dbh_age$Series)) %>% 
              dplyr::select(-Provenance) %>% 
              arrange(Series) %>% 
  filter(!is.na(DBH14))) %>% 
  mutate(lowsum=ifelse(sum<16,"yes","no"))

dbh_rwi_comp %>% 
  filter(lowsum=="yes")

ggplot(dbh_rwi_comp)+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))

ggplot(dbh_rwi_comp %>% mutate(sum=ifelse(sum<15,sum*10,sum)))+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))+
  geom_abline(slope=1/10,intercept = 0)
###########
```

####remove bad data

```{r}
#find series that are likely off by an order of magnitude
off_trees<- dbh_rwi_comp %>% 
  filter(lowsum=="yes") %>% pull(tree) %>% c("X58A4") #this is the weird tree that's half and half

prov_good_nona <- prov_all_nona %>%dplyr::select(-all_of(substr(off_trees, 2,nchar(off_trees))))

###this cuts out sketchy trees and year = 2016
prov_good <- prov_all %>% dplyr::select(-all_of(substr(off_trees,2,nchar(off_trees)))) %>% 
  filter(!row.names(prov_all)=="2016")
```

####exploration of good data
```{r}
##some plots of the raw data averaged
dbh_age_good <- dbh_age %>% 
  filter(!tree %in% off_trees)

ave_rw_prov<- dbh_age_good %>% 
  na.omit() %>% 
  group_by(Provenance, year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n())) 

ggplot(ave_rw_prov, aes(x=year, y=ave_rw, col=Provenance))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se, col=Provenance))+
  geom_vline(xintercept = 1985)+
  facet_wrap(~Provenance)

ggplot(ave_rw_prov, aes(x=year, y=ave_rw, col=Provenance))+
  geom_point()+
  geom_line()+
  #geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se, col=Provenance))+
  geom_vline(xintercept = 1985)

ave_rw_all <- dbh_age_good %>%
  na.omit() %>% 
  group_by(year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n()))

plantation_clim <- plantation_clim %>% 
  mutate(aet_scale=scale(aet_sum))

ggplot(ave_rw_all, aes(x=year, y=ave_rw))+
  geom_bar(data=plantation_clim, aes(x=year, y=aet_scale), stat="identity")+
  geom_point()+
  geom_errorbar(aes(x=year, ymin=(ave_rw-se), ymax=(ave_rw+se)), col="red")+
  geom_line()
### it seems like the major deviation in the data is in response to the wet period right before the drought, rather than the 2002 drought. 

#ring width series statistics
par(mfrow=c(1,1))
plot(prov_good, plot.type="spag")
rwl.report(prov_good)
prov_good_stats<- summary(prov_good)
summary(prov_good_stats$ar1)
```

###Detrending

```{r}
##detrending with Spline method - using stiffness of 35 years
##need to figure out what age to start at based on how long the "young tree growth spurt" usually takes

growth.detrended.all = matrix(nrow=nrow(prov_good), ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.all[,i]<- obj
}
colnames(growth.detrended.all) = colnames(prov_good)
rownames(growth.detrended.all) = rownames(prov_good)

rwi.stats(growth.detrended.all, period="max")
chron(growth.detrended.all)
plot(chron(growth.detrended.all), add.spline=TRUE, nyrs=35)
sss(growth.detrended.all)

growth.detrended.df.all <- growth.detrended.all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.all)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df.all, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

##remove first 15 years of ring widths since they are missing for many trees and likely represent unusual growth patterns. 
growth.detrended.short = matrix(nrow=nrow(prov_good)-15, ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good %>% filter(!(row.names(prov_good) < 1985))  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.short[,i]<- obj
}
colnames(growth.detrended.short) = colnames(prov_good)
rownames(growth.detrended.short) = rownames(prov_good)[16:nrow(prov_good)]

rwi.stats(growth.detrended.short, period="max")
plot(chron(growth.detrended.short), add.spline=TRUE, nyrs=35)
sss(growth.detrended.short)
sens1(growth.detrended.short[,1])

##########

growth.detrended.df <- growth.detrended.short %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.short)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

growth.detrended.sum <- growth.detrended.df %>% 
  group_by(year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.sum, aes(x=year, y=meanrwi))+
  geom_point()+
  geom_errorbar(aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se), col="red")+
  geom_line()+
  geom_bar(data=plantation_clim, aes(x=year, y=aet_sum), stat="identity")+
  geom_hline(yintercept=1, linetype=2)

growth.detrended.byprov <- growth.detrended.df %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
    geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")+
  geom_point(aes( col=Provenance), size=2)+
  geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, col=Provenance), linewidth=1)+
  scale_color_manual(values=unname(stepped()))+
  geom_line(aes( col=Provenance), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())

plantation_clim_cut <- plantation_clim %>% 
  filter(year>1984 & year < 2016) %>% 
  mutate(aet_scale=scale(aet_sum))

plantation_clim_cut<- plantation_clim_cut %>% 
  mutate(aet_scale_1 = 2*((plantation_clim_cut$aet_sum  - min(plantation_clim_cut$aet_sum )) / (max(plantation_clim_cut$aet_sum) - min(plantation_clim_cut$aet_sum))) - 1)

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_clim_cut, aes(x=year, y=aet_scale_1), stat="identity")+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="AET (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  #geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, col=Provenance), linewidth=1)+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())


##look at whole time series
growth.detrended.all.byprov <- growth.detrended.df.all %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.all.byprov, aes(x=year, y=meanrwi))+
    geom_bar(data=plantation_clim, aes(x=year, y=aet_scale), stat="identity")+
  geom_point(aes( col=Provenance))+
  geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se, col=Provenance))+
  geom_line(aes( col=Provenance))+
  geom_hline(yintercept=1, linetype=2)

```

####Gini coefficient

```{r}
library(DescTools)

trees<- unique(growth.detrended.df$tree)

Gini(growth.detrended.df %>% filter(tree==trees[1]) %>% pull(rw_spline), weights=NULL, unbiased = TRUE, conf.level=TRUE, R=10000, type="perc", na.rm=TRUE)

###get time period with all trees included in all years (common period)
gini_df = data.frame()
for(i in 1:length(trees)){
gini = growth.detrended.df %>% filter(year > 1990 & year < 2011) %>% filter(tree==trees[i]) %>% pull(rw_spline) %>% 
  Gini(weights=NULL, unbiased = TRUE, conf.level=TRUE, R=10000, type="perc", na.rm=TRUE)
gini_df = bind_rows(gini_df, data.frame(gini=gini[1], lwr = gini[2], upr=gini[3], tree=trees[i]))
}

gini_byprov<- gini_df %>% 
  left_join(dbh_age_summary, by="tree")

ggplot(gini_byprov, aes(x=factor(Provenance, levels = provs_bylat$Provenance), y=gini, fill=factor(Provenance, levels = provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("Gini coefficient")+
  xlab("Provenance")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "none",
        axis.title = element_text(size=12, color="black"), axis.text = element_text(size = 12, color="black"))

gini_sum<- gini_byprov %>% 
  group_by(Provenance) %>% 
  summarise(mean=mean(gini), sd=sd(gini), se=sd(gini)/sqrt(n()))

gini_plot<- ggplot(gini_sum, aes(x=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code), y=mean, fill=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code), color=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code)))+
  geom_point(size=3)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), linewidth=1, width=0.5)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_y_continuous(breaks=c(0.1,0.2))+
  ylab("Gini coefficient")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8), legend.position = "none",
        axis.title = element_text(color="black"), axis.text = element_text(color="black"), axis.title.x = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())


rwi_gini_plot<- ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_clim_cut, aes(x=year, y=aet_scale_1), stat="identity")+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="AET (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())+
  annotation_custom(ggplotGrob(gini_plot), xmin=1983, xmax=1997, ymin=0.35, ymax=1.1)

png("figures/rwi_gini_plot.png", width=11,height=6, unit="in", res=300)
rwi_gini_plot
dev.off()


##ANOVA

gini_provmod <- aov(log(gini) ~ Provenance, data=gini_byprov)
par(mfrow=c(2,2))
plot(gini_provmod)
summary(gini_provmod)
TukeyHSD(gini_provmod)$Provenance %>% as.data.frame() %>% filter(`p adj` < 0.05)

gini_byprov %>% 
  summary()

mean(gini_byprov$gini)
sd(gini_byprov$gini)

##Model with climate as a predictor
unique(prov_pcapts$Provenance)
unique(gini_byprov$Provenance)

gini_clim_df <- gini_byprov %>% 
  left_join(prov_pcapts) 

#MAT
gini_byMAT <- lmer(log(gini) ~ MAT + (1|Provenance), data=gini_clim_df)
plot(gini_byMAT)
qqmath(gini_byMAT)
summary(gini_byMAT)

#map
gini_bymap <- lmer(log(gini) ~ MAP+ (1|Provenance), data=gini_clim_df)
plot(gini_bymap)
qqmath(gini_bymap)
summary(gini_bymap)

#TD
gini_byTD <- lmer(log(gini) ~ TD + (1|Provenance), data=gini_clim_df)
plot(gini_byTD)
qqmath(gini_byTD)
summary(gini_byTD)

#MCMT
gini_byMCMT <- lmer(log(gini) ~ MCMT + (1|Provenance), data=gini_clim_df)
plot(gini_byMCMT)
qqmath(gini_byMCMT)
summary(gini_byMCMT)

#MSP
gini_byMSP <- lmer(log(gini) ~ MSP + (1|Provenance), data=gini_clim_df)
plot(gini_byMSP)
qqmath(gini_byMSP)
summary(gini_byMSP)

#SHM
gini_bySHM <- lmer(log(gini) ~ SHM + (1|Provenance), data=gini_clim_df)
plot(gini_bySHM)
qqmath(gini_bySHM)
summary(gini_bySHM)

#NFFD
gini_byNFFD <- lmer(log(gini) ~ NFFD + (1|Provenance), data=gini_clim_df)
plot(gini_byNFFD)
qqmath(gini_byNFFD)
summary(gini_byNFFD)

#bFFP
gini_bybFFP <- lmer(log(gini) ~ bFFP + (1|Provenance), data=gini_clim_df)
plot(gini_bybFFP)
qqmath(gini_bybFFP)
summary(gini_bybFFP)

#eFFP
gini_byeFFP <- lmer(log(gini) ~ eFFP + (1|Provenance), data=gini_clim_df)
plot(gini_byeFFP)
qqmath(gini_byeFFP)
summary(gini_byeFFP)

#MWMT
gini_byMWMT <- lmer(log(gini) ~ MWMT + (1|Provenance), data=gini_clim_df)
plot(gini_byMWMT)
qqmath(gini_byMWMT)
summary(gini_byMWMT)

#dd_0
gini_bydd_0 <- lmer(log(gini) ~ DD0 + (1|Provenance), data=gini_clim_df)
plot(gini_bydd_0)
qqmath(gini_bydd_0)
summary(gini_bydd_0)

#dd5
gini_bydd5 <- lmer(log(gini) ~ DD5 + (1|Provenance), data=gini_clim_df)
plot(gini_bydd5)
qqmath(gini_bydd5)
summary(gini_bydd5)

#EMT
gini_byEMT <- lmer(log(gini) ~ EMT + (1|Provenance), data=gini_clim_df)
plot(gini_byEMT)
qqmath(gini_byEMT)
summary(gini_byEMT)

#cmd
gini_bycmd <- lmer(log(gini) ~ CMD + (1|Provenance), data=gini_clim_df)
plot(gini_bycmd)
qqmath(gini_bycmd)
summary(gini_bycmd)

#pas
gini_bypas <- lmer(log(gini) ~ PAS + (1|Provenance), data=gini_clim_df)
plot(gini_bypas)
qqmath(gini_bypas)
summary(gini_bypas)

#smrpb
gini_bysmrpb <- lmer(log(gini) ~ smrpb + (1|Provenance), data=gini_clim_df %>% filter(!Provenance=="Gila NF"))
plot(gini_bysmrpb)
qqmath(gini_bysmrpb)
summary(gini_bysmrpb) ##only significant with Gila included

#PC1
gini_byPC1 <- lmer(log(gini) ~ PC1 + (1|Provenance), data=gini_clim_df)
plot(gini_byPC1)
qqmath(gini_byPC1)
summary(gini_byPC1)
#PC2
gini_byPC2 <- lmer(log(gini) ~ PC2 + (1|Provenance), data=gini_clim_df)
plot(gini_byPC2)
qqmath(gini_byPC2)
summary(gini_byPC2) 
#PC3
gini_byPC3 <- lmer(log(gini) ~ PC3 + (1|Provenance), data=gini_clim_df)
plot(gini_byPC3)
qqmath(gini_byPC3)
summary(gini_byPC3)


###see if gini coefficient is related to survival and growth
tree_data_all <- growth.detrended.df %>% 
  dplyr::select(c(tree,SORT,LOC,BLK,REP)) %>% 
  left_join(moniger_data_comb, by=c("SORT","LOC","BLK","REP"))

gini_all_data<- gini_byprov %>% 
  left_join(unique(tree_data_all), by="tree")

gini_dbh14_mod <- lmer(DBH14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!is.na(DBH14)))
plot(gini_dbh14_mod)
qqmath(gini_dbh14_mod)
summary(gini_dbh14_mod)

gini_ht14_mod <- lmer(HT14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!is.na(HT14)))
plot(gini_ht14_mod)
qqmath(gini_ht14_mod)
summary(gini_ht14_mod)

gini_surv_df<- survival_means %>% 
  filter(year==2014) %>% 
  left_join(gini_sum, by="Provenance")

gini_surv14_mod <- lm(prop.surv.since.1970 ~ mean, data=gini_surv_df)
par(mfrow=c(2,2))
plot(gini_surv14_mod)
summary(gini_surv14_mod)

```

####treeclim

```{r}
library(treeclim)

ppt_comb_plantation_wide<-ppt_comb_plantation %>%
  dplyr::select(ppt,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=ppt) %>% 
  as.data.frame()

tmax_comb_plantation_wide<- tmax_comb_plantation %>%
  dplyr::select(tmax,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=tmax) %>% 
  as.data.frame()

tmin_comb_plantation_wide<-tmin_comb_plantation %>%
  dplyr::select(tmin,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=tmin) %>% 
  as.data.frame()

tmean_comb_plantation_wide<-tmean_comb_plantation %>%
  dplyr::select(tmean,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=tmean) %>% 
  as.data.frame()

vpdmax_comb_plantation_wide<- vpdmax_comb_plantation %>%
  dplyr::select(vpdmax,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=vpdmax) %>% 
  as.data.frame()

vpdmin_comb_plantation_wide<- vpdmin_comb_plantation %>%
  dplyr::select(vpdmin,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=vpdmin) %>% 
  as.data.frame()

growth.detrended.common <- growth.detrended.short %>% 
  as.data.frame() %>% 
  filter(row.names(growth.detrended.short) > 1990 & row.names(growth.detrended.short) < 2011) %>% 
  as.data.frame()

chron.growth.detrended.common<- chron(growth.detrended.common)
chron.growth.detrended.all <- chron(growth.detrended.all, prewhiten = TRUE)

all_resp_ppt<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(ppt_comb_plantation_wide),
    var_names = c("ppt"))
all_resp_tmin<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(tmin_comb_plantation_wide),
    var_names = c("tmin"))
all_resp_tmean<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(tmean_comb_plantation_wide),
    var_names = c("tmean"))
all_resp_tmax<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(tmax_comb_plantation_wide),
    var_names = c("tmax"))
all_resp_vpdmin<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(vpdmin_comb_plantation_wide),
    var_names = c("vpdmin"))
all_resp_vpdmax<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(vpdmax_comb_plantation_wide),
    var_names = c("vpdmax"))

dcc(chrono = chron.growth.detrended.all, 
    climate = list(ppt=ppt_comb_plantation_wide,tmin=tmin_comb_plantation_wide))

all_resp_ppt
all_resp_tmean
all_resp_tmin
all_resp_tmax
all_resp_vpdmin
all_resp_vpdmax

##just the common period

common_resp_ppt<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(ppt_comb_plantation_wide),
    var_names = c("ppt"))
common_resp_tmin<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(tmin_comb_plantation_wide),
    var_names = c("tmin"))
common_resp_tmean<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(tmean_comb_plantation_wide),
    var_names = c("tmean"))
common_resp_tmax<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(tmax_comb_plantation_wide),
    var_names = c("tmax"))
common_resp_vpdmin<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(vpdmin_comb_plantation_wide),
    var_names = c("vpdmin"))
common_resp_vpdmax<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(vpdmax_comb_plantation_wide),
    var_names = c("vpdmax"))
common_resp_ppt
common_resp_tmean
common_resp_tmin
common_resp_tmax
common_resp_vpdmin ##current august vpdmin (negative relationship) is the only significant one
common_resp_vpdmax

###do all climate vars for each provenance separately

##ppt
chron.list=list()
for(i in 1:length(provs_arranged_lat[-9])){
  
data<- growth.detrended.df %>% 
  filter(Provenance==provs_arranged_lat[-9][i]) %>% 
  dplyr::select(year,Series,rw_spline) %>% 
  pivot_wider(names_from = Series, id_cols = year, values_from=rw_spline) %>% 
  column_to_rownames(var="year") %>% 
  chron()

chron.list[[i]] = data }
names(chron.list) = provs_arranged_lat[-9]

ppt_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(ppt_comb_plantation_wide),
    var_names = c("ppt")) 
ppt_treeclim_list[[i]] = result$coef
}
names(ppt_treeclim_list) = provs_arranged_lat[-9]

bind_rows(ppt_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

##tmean
tmean_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(tmean_comb_plantation_wide),
    var_names = c("tmean")) 
tmean_treeclim_list[[i]] = result$coef
}
names(tmean_treeclim_list) = provs_arranged_lat[-9]

bind_rows(tmean_treeclim_list, .id="column_label") %>% 
  summary() #nothing significant

##tmin
tmin_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(tmin_comb_plantation_wide),
    var_names = c("tmin")) 
tmin_treeclim_list[[i]] = result$coef
}
names(tmin_treeclim_list) = provs_arranged_lat[-9]

bind_rows(tmin_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

##tmax
tmax_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(tmax_comb_plantation_wide),
    var_names = c("tmax")) 
tmax_treeclim_list[[i]] = result$coef
}
names(tmax_treeclim_list) = provs_arranged_lat[-9]

bind_rows(tmax_treeclim_list, .id="column_label") %>% 
  summary() #nothing significant

#vpdmin
vpdmin_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(vpdmin_comb_plantation_wide),
    var_names = c("vpdmin")) 
vpdmin_treeclim_list[[i]] = result$coef
}
names(vpdmin_treeclim_list) = provs_arranged_lat[-9]

bind_rows(vpdmin_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

##vpdmax
vpdmax_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(vpdmax_comb_plantation_wide),
    var_names = c("vpdmax")) 
vpdmax_treeclim_list[[i]] = result$coef
}
names(vpdmax_treeclim_list) = provs_arranged_lat[-9]

bind_rows(vpdmax_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

```

#####seasonal

```{r}

####seasonal with bioclimate vars
cwd_date <- plantation_cwd %>% 
  mutate(date=paste("1",month,year,sep="/")) %>% 
  as.data.frame()
  
bioclim_date <- plantation_spei_sum %>%
  mutate(date = paste(day(date),month(date),year(date),sep="/")) %>% 
  dplyr::select(date, spei) %>% 
  left_join(cwd_date, by="date")

spei_date_wide <- bioclim_date %>% 
  dplyr::select(year,month, spei) %>% 
  pivot_wider(id_cols=c(year), names_from=c(month), values_from = spei) %>% 
  as.data.frame()%>% 
  filter(!year==2016)

colnames(spei_date_wide)=c("YEAR","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC")
 
cwd_date_wide <- bioclim_date %>% 
  dplyr::select(year,month, cwd) %>% 
  pivot_wider(id_cols=c(year), names_from=c(month), values_from = cwd) %>% 
  as.data.frame()%>% 
  filter(!year==2016)

colnames(cwd_date_wide)=c("YEAR","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC")
 
aet_date_wide <- bioclim_date %>% 
  dplyr::select(year,month, aet) %>% 
  pivot_wider(id_cols=c(year), names_from=c(month), values_from = aet) %>% 
  as.data.frame() %>% 
  filter(!year==2016)

colnames(aet_date_wide)=c("YEAR","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC")

```

######aet - cwd
```{r, eval=FALSE}

aet_cwd_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(aet= aet_date_wide[2:47,], cwd = cwd_date_wide[2:47,]),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
aet_cwd_list[[i]]<- result
}

inner_result_aet_cwd<- list()
outer_result_aet_cwd<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(aet_cwd_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
aet_cwd_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_aet_cwd[[j]]<- result}

  inner_result_aet_cwd2 <- inner_result_aet_cwd[sapply(inner_result_aet_cwd, function(x) dim(x)[1])>0]
  inner_result_aet_cwd3 <- bind_rows(inner_result_aet_cwd2)
  outer_result_aet_cwd[[i]]<- inner_result_aet_cwd3}
names(outer_result_aet_cwd)<- provs_arranged_lat[-9]

aet_cwd_seas <- bind_rows(outer_result_aet_cwd, .id="Provenance") 

aet_cwd_seas_allp <- aet_cwd_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% aet_cwd_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(aet_cwd_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_aet","sec_cwd"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("aet, cwd")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_aet_cwd <- aet_cwd_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "AET", "CWD"))

ggplot(timeline_aet_cwd, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  geom_text(data=data.frame(date = my("11-1754"), Provenance = "Cache NF", label= "+", var="CWD"), aes(x=date, y=Provenance, label=label), size=4)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")
  
ggplot(timeline_aet_cwd, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")

season.labels = data.frame(date = c(my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")) %m+% months(1) + days(15),
                           season = rep(c("Sm","Sp","Wt","Fa"),2))

cor_analysis_plot_pc1_aet_cwd<- ggplot(timeline_aet_cwd, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("AET","CWD")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = AET")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(),strip.text = element_text(size=10, color="black"))

####practicing things
nor_seascorr <- seascorr(chrono = norw015,
                         climate=list(norway_temp, norway_prec),
                         var_names=c("temp","prec"))

skills(object = nor_seascorr,
       target = .mean("temp",6:8))


skills(object = aet_cwd_list[[20]],
       target = .mean("cwd", -12:3))

```

######aet - spei

```{r, eval=FALSE}

aet_spei_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(aet= aet_date_wide[2:47,], spei = spei_date_wide[2:47,]),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
aet_spei_list[[i]]<- result
}

inner_result_aet_spei<- list()
outer_result_aet_spei<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(aet_spei_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
aet_spei_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_aet_spei[[j]]<- result}

  inner_result_aet_spei2 <- inner_result_aet_spei[sapply(inner_result_aet_spei, function(x) dim(x)[1])>0]
  inner_result_aet_spei3 <- bind_rows(inner_result_aet_spei2)
  outer_result_aet_spei[[i]]<- inner_result_aet_spei3}
names(outer_result_aet_spei)<- provs_arranged_lat[-9]

aet_spei_seas <- bind_rows(outer_result_aet_spei, .id="Provenance") 

aet_spei_seas_allp <- aet_spei_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% aet_spei_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(aet_spei_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_aet","sec_spei"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("aet, spei")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_aet_spei <- aet_spei_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "AET", "SPEI"))

ggplot(timeline_aet_spei, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")
  
cor_analysis_plot_pc1_aet_spei<- ggplot(timeline_aet_spei, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("AET","SPEI")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = AET")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(),strip.text = element_text(size=10, color="black"))

# png("figures/cor_analysis_timeline_aet.png", width=9,height=10, units="in", res=500)
# ggarrange(cor_analysis_plot_pc1_aet_spei,
#           cor_analysis_plot_pc1_aet_cwd, nrow=2, common.legend = TRUE, labels = c("A)","B)"))
# dev.off()

```

#####precip & temp seasons

```{r, eval=FALSE}

temp_precip_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(temp= tmean_comb_plantation_wide[2:47,], precip = ppt_comb_plantation_wide[2:47,]),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
temp_precip_list[[i]]<- result
}

inner_result_temp_precip<- list()
outer_result_temp_precip<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(temp_precip_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
temp_precip_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_temp_precip[[j]]<- result}

  inner_result_temp_precip2 <- inner_result_temp_precip[sapply(inner_result_temp_precip, function(x) dim(x)[1])>0]
  inner_result_temp_precip3 <- bind_rows(inner_result_temp_precip2)
  outer_result_temp_precip[[i]]<- inner_result_temp_precip3}
names(outer_result_temp_precip)<- provs_arranged_lat[-9]

temp_precip_seas <- bind_rows(outer_result_temp_precip, .id="Provenance") 

temp_precip_seas_allp <- temp_precip_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% temp_precip_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(temp_precip_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_temp","sec_precip"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("temp, precip")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_temp_precip <- temp_precip_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "temp", "precip"))

ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")

prov_pcapts %>% arrange(PC1) %>% pull(Provenance)

ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")


  
cor_analysis_plot_pc1_temp<- ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("temp","precip")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = Temp")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(),strip.text = element_text(size=10, color="black"))

ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC2) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC2) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC2) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("temp","precip")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = Temp")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank())

```


```{r, eval=FALSE}

precip_temp_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(precip = ppt_comb_plantation_wide[2:47,],temp= tmean_comb_plantation_wide[2:47,]),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
precip_temp_list[[i]]<- result
}

inner_result_precip_temp<- list()
outer_result_precip_temp<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(precip_temp_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
precip_temp_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_precip_temp[[j]]<- result}

  inner_result_precip_temp2 <- inner_result_precip_temp[sapply(inner_result_precip_temp, function(x) dim(x)[1])>0]
  inner_result_precip_temp3 <- bind_rows(inner_result_precip_temp2)
  outer_result_precip_temp[[i]]<- inner_result_precip_temp3}
names(outer_result_precip_temp)<- provs_arranged_lat[-9]

precip_temp_seas <- bind_rows(outer_result_precip_temp, .id="Provenance") 

precip_temp_seas_allp <- precip_temp_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% precip_temp_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(precip_temp_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_temp","sec_precip"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("temp, precip")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_precip_temp <- precip_temp_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "temp", "precip"))

ggplot(timeline_precip_temp, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")

ggplot(timeline_precip_temp, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")
  
cor_analysis_plot_pc1_precip<- ggplot(timeline_precip_temp, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
    geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
    geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = Precip")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(), strip.text = element_text(size=10, color="black"))

png("figures/cor_analysis_timeline.png", width=9,height=10, units="in", res=500)
ggarrange(cor_analysis_plot_pc1_temp,
          cor_analysis_plot_pc1_precip, nrow=2, common.legend = TRUE, labels = c("A)","B)"))
dev.off()
```


####climwin

```{r, eval=FALSE}
rwi.stats(growth.detrended.all)

ppt_comb_plantation_update <- ppt_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

tmean_comb_plantation_update<- tmean_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

tmin_comb_plantation_update<- tmin_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

tmax_comb_plantation_update<- tmax_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

vpdmax_comb_plantation_update<- vpdmax_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))
  
vpdmin_comb_plantation_update<- vpdmin_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

rwi_test<- growth.detrended.common %>% 
  as.data.frame() %>% 
  mutate(year=(row.names(growth.detrended.common))) %>% 
  dplyr::select(year, `47C2`) %>% 
  rename(rw = `47C2`) %>% 
  mutate(date = paste("01/01/",year,sep=""))

growth.detrended.common.df <- growth.detrended.common %>% 
  mutate(year=row.names(growth.detrended.common)) %>% 
  pivot_longer(!year) %>% 
  left_join(dbh_age_summary %>% 
  dplyr::select(Provenance,tree) %>% 
  mutate(tree=substr(tree,2,length(tree))), by=c("name"="tree")) %>% 
  mutate(date = paste("01/01/",year,sep=""))
  

output <- slidingwin(exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ Provenance, data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month"
           )

# Examine tested combinations
 
output$combos
     
# View output for func = "lin"
 
head(output[[1]]$Dataset) 
plotdelta(output[[1]]$Dataset)

dataset_ppt <- output[[1]]$Dataset
ConfidenceSet_ppt <- dataset_ppt[which(cumsum(dataset_ppt$ModWeight) <= 0.95),]
sum(ConfidenceSet_ppt$ModelBeta*ConfidenceSet_ppt$ModWeight)

dataset_tmean <- output[[2]]$Dataset
ConfidenceSet_tmean <- dataset_tmean[which(cumsum(dataset_tmean$ModWeight) <= 0.95),]
sum(ConfidenceSet_tmean$ModelBeta*ConfidenceSet_tmean$ModWeight)
plotdelta(output[[2]]$Dataset)
medwin(output[[2]]$Dataset)

dataset_tmin <- output[[3]]$Dataset
ConfidenceSet_tmin <- dataset_tmin[which(cumsum(dataset_tmin$ModWeight) <= 0.95),]
sum(ConfidenceSet_tmin$ModelBeta*ConfidenceSet_tmin$ModWeight)
plotdelta(output[[3]]$Dataset)
summary(output[[3]]$BestModel)


dataset_tmax <- output[[4]]$Dataset
ConfidenceSet_tmax <- dataset_tmax[which(cumsum(dataset_tmax$ModWeight) <= 0.95),]
sum(ConfidenceSet_tmax$ModelBeta*ConfidenceSet_tmax$ModWeight)
plotdelta(output[[4]]$Dataset)
summary(output[[4]]$BestModel)


dataset_vpdmin <- output[[5]]$Dataset
ConfidenceSet_vpdmin <- dataset_vpdmin[which(cumsum(dataset_vpdmin$ModWeight) <= 0.95),]
sum(ConfidenceSet_vpdmin$ModelBeta*ConfidenceSet_vpdmin$ModWeight)
plotdelta(output[[5]]$Dataset)

dataset_vpdmax <- output[[6]]$Dataset
ConfidenceSet_vpdmax <- dataset_vpdmax[which(cumsum(dataset_vpdmax$ModWeight) <= 0.95),]
sum(ConfidenceSet_vpdmax$ModelBeta*ConfidenceSet_vpdmax$ModWeight)
plotdelta(output[[6]]$Dataset)


## To test if the climate signal could have occurred due to chance, we next run the randomisation procedure using the function randwin, with repeats = 5.

output.rand <- randwin(repeats = 5, 
                       exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ Provenance, data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month")


#The output of the randwin function can then be used to run the function pvalue to return a value of PC.

pvalue(dataset = output[[1]]$Dataset, datasetrand = output.rand[[1]], metric = "C", sample.size = 2720)  ##high pvalue means that this climate signal is not very strong (high probability that it occurred by chance)
pvalue(dataset = output[[2]]$Dataset, datasetrand = output.rand[[2]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[3]]$Dataset, datasetrand = output.rand[[3]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[4]]$Dataset, datasetrand = output.rand[[4]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[5]]$Dataset, datasetrand = output.rand[[5]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[6]]$Dataset, datasetrand = output.rand[[6]], metric = "C", sample.size = 2720)

##using cross validation
outputk <- slidingwin(xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = rwi_test$date,
           baseline = lm(rw ~ 1, data=rwi_test),
           range = c(24,0),
           type="absolute", refday = c(1,12),
           stat = "mean",
           func = c("lin","quad"),
           cmissing = FALSE,
           cinterval = "month",
           k=10)

outputk$combos

output.randk <- randwin(repeats = 5, 
                       exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ Provenance, data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month",
                       k=10)


pvalue(dataset = output[[1]]$Dataset, datasetrand = output.randk[[1]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[1]]$Dataset, datasetrand = output.randk[[1]], metric = "C", sample.size = 2720)

```


```{r, eval=FALSE}
#trying climwin without provenance as an effect

output_nop <- slidingwin(exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ 1 , data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month"
           )
output_nop$combos

```

```{r, eval=FALSE}
##try with bioclim vars

output_bioclim <- slidingwin(xvar=list(aet = bioclim_date$aet,
                               cwd = bioclim_date$cwd,
                               spei = bioclim_date$spei),
           cdate = bioclim_date$date,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ 1 , data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(01,10),
           stat = "sum",
           func = c("lin","quad"),
           cmissing = FALSE,
           cinterval = "month"
           )

output_bioclim$combos

plotdelta(output_bioclim[[1]]$Dataset)
summary(output_bioclim[[1]]$BestModel) #positive effect of aet on RWI

plotdelta(output_bioclim[[2]]$Dataset)
summary(output_bioclim[[2]]$BestModel) #positive effect of cwd on RWI

plotdelta(output_bioclim[[3]]$Dataset)
summary(output_bioclim[[3]]$BestModel) #positive effect of spei on RWI

plotdelta(output_bioclim[[4]]$Dataset)
summary(output_bioclim[[4]]$BestModel) 

plotdelta(output_bioclim[[5]]$Dataset)
summary(output_bioclim[[5]]$BestModel)

plotdelta(output_bioclim[[6]]$Dataset)
summary(output_bioclim[[6]]$BestModel) 

output_bioclim_rand <- randwin(repeats = 5, 
                       xvar=list(aet = bioclim_date$aet,
                               cwd = bioclim_date$cwd,
                               spei = bioclim_date$spei),
           cdate = bioclim_date$date,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ 1 , data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(01,10),
           stat = "sum",
           func = c("lin","quad"),
           cmissing = FALSE,
           cinterval = "month")


#The output of the randwin function can then be used to run the function pvalue to return a value of PC.

pvalue(dataset = output_bioclim[[1]]$Dataset, datasetrand = output_bioclim_rand[[1]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[2]]$Dataset, datasetrand = output_bioclim_rand[[2]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[3]]$Dataset, datasetrand = output_bioclim_rand[[3]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[4]]$Dataset, datasetrand = output_bioclim_rand[[4]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[5]]$Dataset, datasetrand = output_bioclim_rand[[5]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[6]]$Dataset, datasetrand = output_bioclim_rand[[6]], metric = "C", sample.size = 2720) 

```



###Resistance vs. Resilience

####Odd time periods

#####Raw ring widths

```{r}
#######
# calculate different time periods
#######
droughtyear = 2002
buffertime = seq(0,3,1)
raw_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))
}

rawmodlist_resistance<- list()
for(i in 1:length(raw_calcs_list)){
rawmodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=raw_calcs_list[[i]])
}
summary(rawmodlist_resistance[[1]])
summary(rawmodlist_resistance[[2]]) #3yr periods significant for resistance
TukeyHSD(rawmodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
ggplot(data=as.data.frame(raw_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(rawmodlist_resistance[[3]])
summary(rawmodlist_resistance[[4]]) 

rawmodlist_resilience<- list()
for(i in 1:length(raw_calcs_list)){
rawmodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=raw_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(rawmodlist_resilience[[1]])
summary(rawmodlist_resilience[[2]]) ##3 year periods marginally significant
TukeyHSD(rawmodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
summary(rawmodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05). Inlet creek is lower than Gila for resilience
TukeyHSD(rawmodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
RR_5yrs_0004 <- raw_calcs_list[[3]] %>% as.data.frame()
ggplot(RR_5yrs_0004, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(rawmodlist_resilience[[4]]) 

####
```


#####Detrended with spline

```{r}
###DETRENDED DATA
droughtyear = 2002
buffertime = seq(0,3,1)
spline_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rw = mean(rw_spline))

predrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rw = mean(rw_spline))

postdrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rw = mean(rw_spline))

spline_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")
}

splinemodlist_resistance<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=spline_calcs_list[[i]])
}
summary(splinemodlist_resistance[[1]])
summary(splinemodlist_resistance[[2]]) #3yr still significant but diff provs
TukeyHSD(splinemodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
ggplot(as.data.frame(spline_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resistance[[3]])
summary(splinemodlist_resistance[[4]]) 

splinemodlist_resilience<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=spline_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(splinemodlist_resilience[[1]])
summary(splinemodlist_resilience[[2]]) ##3 year periods is significant
TukeyHSD(splinemodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #all Gila
summary(splinemodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05)
TukeyHSD(splinemodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #Gila, in addition to Inlet Creek being lower than Larimer 2 and Pike
ggplot(as.data.frame(spline_calcs_list[[3]]), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resilience[[4]]) 

####

lapply(spline_calcs_list, summary)
spline_calcs_list[[1]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[2]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[3]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[4]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience,na.rm=T))

```

####Even time periods

#####Raw ring widths

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0102 <- left_join(drought_rw_0102,predrought_rw_0102) %>% left_join(postdrought_rw_0102) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0102 <- aov(resistance ~ Provenance, data=raw_calcs_0102)

summary(rawmodlist_resistance_0102)
TukeyHSD(rawmodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwise differences

rawmodlist_resilience_0102 <- aov(resilience ~ Provenance, data=raw_calcs_0102)

summary(rawmodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0203 <- left_join(drought_rw_0203,predrought_rw_0203) %>% left_join(postdrought_rw_0203) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))

rawmodlist_resistance_0203 <- aov(resistance ~ Provenance, data=raw_calcs_0203)

summary(rawmodlist_resistance_0203)

rawmodlist_resilience_0203 <- aov(resilience ~ Provenance, data=raw_calcs_0203)

summary(rawmodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0104 <- left_join(drought_rw_0104,predrought_rw_0104) %>% left_join(postdrought_rw_0104) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0104 <- aov(resistance ~ Provenance, data=raw_calcs_0104)

summary(rawmodlist_resistance_0104)

rawmodlist_resilience_0104 <- aov(resilience ~ Provenance, data=raw_calcs_0104)

summary(rawmodlist_resilience_0104)
TukeyHSD(rawmodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0104 <- raw_calcs_0104 %>% as.data.frame()
ggplot(RR_4yrs_0104, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0003 <- left_join(drought_rw_0003,predrought_rw_0003) %>% left_join(postdrought_rw_0003) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))

rawmodlist_resistance_0003 <- aov(resistance ~ Provenance, data=raw_calcs_0003)

summary(rawmodlist_resistance_0003)

rawmodlist_resilience_0003 <- aov(resilience ~ Provenance, data=raw_calcs_0003)

summary(rawmodlist_resilience_0003)
TukeyHSD(rawmodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0003 <- raw_calcs_0003 %>% as.data.frame()
ggplot(RR_4yrs_0003, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years not significant for either resistance or resilience

drought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0005 <- left_join(drought_rw_0005,predrought_rw_0005) %>% left_join(postdrought_rw_0005) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0005 <- aov(resistance ~ Provenance, data=raw_calcs_0005)

summary(rawmodlist_resistance_0005)

rawmodlist_resilience_0005 <- aov(resilience ~ Provenance, data=raw_calcs_0005 %>% filter(!is.na(resilience)))

summary(rawmodlist_resilience_0005)

#99-04 - 6 years not significant for either resistance or resilience

drought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_9904 <- left_join(drought_rw_9904,predrought_rw_9904) %>% left_join(postdrought_rw_9904) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_9904 <- aov(resistance ~ Provenance, data=raw_calcs_9904)

summary(rawmodlist_resistance_9904)

rawmodlist_resilience_9904 <- aov(resilience ~ Provenance, data=raw_calcs_9904)

summary(rawmodlist_resilience_9904)
TukeyHSD(rawmodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0003 <- raw_calcs_0003 %>% as.data.frame()
ggplot(RR_4yrs_0003, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

#####Detrended ring with spline

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0102 <- left_join(drought_rwi_0102,predrought_rwi_0102) %>% left_join(postdrought_rwi_0102) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0102 <- aov(resistance ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resistance_0102)
TukeyHSD(splinemodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwiise differences

splinemodlist_resilience_0102 <- aov(resilience ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rwi_0203<- growth.detrended.df %>%
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0203 <- left_join(drought_rwi_0203,predrought_rwi_0203) %>% left_join(postdrought_rwi_0203) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0203 <- aov(resistance ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resistance_0203)

splinemodlist_resilience_0203 <- aov(resilience ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0104 <- left_join(drought_rwi_0104,predrought_rwi_0104) %>% left_join(postdrought_rwi_0104) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0104 <- aov(resistance ~ Provenance, data=spline_calcs_0104)
TukeyHSD(splinemodlist_resistance_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


summary(splinemodlist_resistance_0104)

splinemodlist_resilience_0104 <- aov(resilience ~ Provenance, data=spline_calcs_0104)

summary(splinemodlist_resilience_0104)
TukeyHSD(splinemodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0003 <- left_join(drought_rwi_0003,predrought_rwi_0003) %>% left_join(postdrought_rwi_0003) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0003 <- aov(resistance ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resistance_0003)

splinemodlist_resilience_0003 <- aov(resilience ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resilience_0003)
TukeyHSD(splinemodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0003), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years 

drought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0005 <- left_join(drought_rwi_0005,predrought_rwi_0005) %>% left_join(postdrought_rwi_0005) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")


splinemodlist_resistance_0005 <- aov(resistance ~ Provenance, data=spline_calcs_0005)

summary(splinemodlist_resistance_0005)

splinemodlist_resilience_0005 <- aov(resilience ~ Provenance, data=spline_calcs_0005 %>% filter(!is.na(resilience)))

summary(splinemodlist_resilience_0005)
TukeyHSD(splinemodlist_resilience_0005)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0005), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#99-04 - 6 years not significant for either resistance or resilience

drought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_9904 <- left_join(drought_rwi_9904,predrought_rwi_9904) %>% left_join(postdrought_rwi_9904) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")


splinemodlist_resistance_9904 <- aov(resistance ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resistance_9904)

splinemodlist_resilience_9904 <- aov(resilience ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resilience_9904)
TukeyHSD(splinemodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_9904), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

###### summary stats
spline_calcs_0102 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0203 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0104 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0003 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0005 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience,na.rm=T), sd.resil = sd(resilience,na.rm=T))

spline_calcs_9904 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience, na.rm=T), sd.resil = sd(resilience, na.rm=T))
```

####Climate Trends in RR

#####resistance

```{r}
##I'm going to look at trends in resistance and resilience (spline detrended) due to provenance climate using the 4 year periods, where the drought period = 2001-2004 as this seems to be the period where there are the most differences between provenances in resistance and resilience.

RR4_clim<- spline_calcs_0104 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR4_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR4_clim)
plot(resis_mod_pcx)
qqmath(resis_mod_pcx)
summary(resis_mod_pcx) 

resis_mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_pcx_noG)
qqmath(resis_mod_pcx_noG)
summary(resis_mod_pcx_noG) #nothing significant when Gila removed

dredge(resis_mod_pcx) ##null model is the best

resis_mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR4_clim)
plot(resis_mod_pcy)
qqmath(resis_mod_pcy)
summary(resis_mod_pcy) 

resis_mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_pcy_noG)
qqmath(resis_mod_pcy_noG)
summary(resis_mod_pcy_noG) #nothing significant when Gila removed

dredge(resis_mod_pcy) ##null model is the best

#distance model
resis_mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim)
plot(resis_mod_dist)
qqmath(resis_mod_dist)
summary(resis_mod_dist) #geographic distance to the plantation is significant

resis_mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_dist_noG)
qqmath(resis_mod_dist_noG)
summary(resis_mod_dist_noG) #geographic distance to the plantation is marginally significant without Gila

dredge(resis_mod_dist) ##null model is best though...

##figure for effect of geo dist on resistance
newdata_geodist <- data.frame(
    geo.dist.to.plant.km = seq(min(RR4_clim$geo.dist.to.plant.km), 
                      max(RR4_clim$geo.dist.to.plant.km), length.out = 100), 
    dist.to.plant.3d = mean(RR4_clim$dist.to.plant.3d))

##take random effect out to make predictions
resis_mod_dist_lm <- lm(log(resistance) ~  scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km), data=RR4_clim)

predicted_scores <- predict(
  resis_mod_dist_lm, 
  newdata = newdata_geodist, interval='confidence') %>% as.data.frame()

newdata_geodist_pred <- bind_cols(newdata_geodist, predicted_scores)

ggplot()+
  geom_point(data=RR4_clim, aes(x=geo.dist.to.plant.km, y=log(resistance)))+
  geom_ribbon(data=newdata_geodist_pred, aes(x=geo.dist.to.plant.km,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_geodist_pred, aes(x=geo.dist.to.plant.km, y=fit), col="turquoise")
```

######all other time periods
```{r}

#####01-02
RR0102_clim<- spline_calcs_0102 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0102_clim, aes(x=PC2, y=resilience, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0102mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0102_clim)
plot(resis_0102mod_pcx)
qqmath(resis_0102mod_pcx)
summary(resis_0102mod_pcx) 

resis_0102mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_pcx_noG)
qqmath(resis_0102mod_pcx_noG)
summary(resis_0102mod_pcx_noG) #nothing significant when Gila removed

dredge(resis_0102mod_pcx) ##null model is the best

resis_0102mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0102_clim)
plot(resis_0102mod_pcy)
qqmath(resis_0102mod_pcy)
summary(resis_0102mod_pcy) 

resis_0102mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_pcy_noG)
qqmath(resis_0102mod_pcy_noG)
summary(resis_0102mod_pcy_noG) #nothing is significant when Gila removed

dredge(resis_0102mod_pcy) ##null model is the best still though 

#distance model
resis_0102mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0102_clim)
plot(resis_0102mod_dist)
qqmath(resis_0102mod_dist)
summary(resis_0102mod_dist) #geographic distance to the plantation is significant

resis_0102mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_dist_noG)
qqmath(resis_0102mod_dist_noG)
summary(resis_0102mod_dist_noG) #geographic distance to the plantation is not significant

dredge(resis_0102mod_dist) ##null model is best 
```

```{r}
#####02-03
RR0203_clim<- spline_calcs_0203 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0203_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0203mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0203_clim)
plot(resis_0203mod_pcx)
qqmath(resis_0203mod_pcx)
summary(resis_0203mod_pcx) 

resis_0203mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0203mod_pcx_noG)
qqmath(resis_0203mod_pcx_noG)
summary(resis_0203mod_pcx_noG) #nothing significant 

dredge(resis_0203mod_pcx) ##null model is the best

resis_0203mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0203_clim)
plot(resis_0203mod_pcy)
qqmath(resis_0203mod_pcy)
summary(resis_0203mod_pcy) 

resis_0203mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0203mod_pcy_noG)
qqmath(resis_0203mod_pcy_noG)
summary(resis_0203mod_pcy_noG) 

dredge(resis_0203mod_pcy) ##null model is the best 

#distance model
resis_0203mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0203_clim)
plot(resis_0203mod_dist)
qqmath(resis_0203mod_dist)
summary(resis_0203mod_dist) #climatic distance to the plantation is significant

resis_0203mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0203mod_dist_noG)
qqmath(resis_0203mod_dist_noG)
summary(resis_0203mod_dist_noG) #nothing significant when gila removed

dredge(resis_0203mod_dist) ##null model is best 
```

```{r}
#####00-03
RR0003_clim<- spline_calcs_0003 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0003_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0003mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0003_clim)
plot(resis_0003mod_pcx)
qqmath(resis_0003mod_pcx)
summary(resis_0003mod_pcx) 

resis_0003mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0003mod_pcx_noG)
qqmath(resis_0003mod_pcx_noG)
summary(resis_0003mod_pcx_noG) #nothing significant 

dredge(resis_0003mod_pcx) ##null model is the best

resis_0003mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0003_clim)
plot(resis_0003mod_pcy)
qqmath(resis_0003mod_pcy)
summary(resis_0003mod_pcy) 

resis_0003mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0003mod_pcy_noG)
qqmath(resis_0003mod_pcy_noG)
summary(resis_0003mod_pcy_noG) 

dredge(resis_0003mod_pcy) ##null model is the best 

#distance model
resis_0003mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0003_clim)
plot(resis_0003mod_dist)
qqmath(resis_0003mod_dist)
summary(resis_0003mod_dist) #nothing significant

resis_0003mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0003mod_dist_noG)
qqmath(resis_0003mod_dist_noG)
summary(resis_0003mod_dist_noG) #nothing significant when gila removed

dredge(resis_0003mod_dist) ##null model is best 
```

```{r}
#####00-05
RR0005_clim<- spline_calcs_0005 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0005_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0005mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0005_clim)
plot(resis_0005mod_pcx)
qqmath(resis_0005mod_pcx)
summary(resis_0005mod_pcx)#nothing significant

resis_0005mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0005mod_pcx_noG)
qqmath(resis_0005mod_pcx_noG)
summary(resis_0005mod_pcx_noG) #nothing significant 

dredge(resis_0005mod_pcx) ##null model is the best

resis_0005mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0005_clim)
plot(resis_0005mod_pcy)
qqmath(resis_0005mod_pcy)
summary(resis_0005mod_pcy) 

resis_0005mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0005mod_pcy_noG)
qqmath(resis_0005mod_pcy_noG)
summary(resis_0005mod_pcy_noG) 

dredge(resis_0005mod_pcy) ##null model is the best 

#distance model
resis_0005mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0005_clim)
plot(resis_0005mod_dist)
qqmath(resis_0005mod_dist)
summary(resis_0005mod_dist) #nothing significant

resis_0005mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0005mod_dist_noG)
qqmath(resis_0005mod_dist_noG)
summary(resis_0005mod_dist_noG) #nothing significant when gila removed

dredge(resis_0005mod_dist) ##null model is best 
```

```{r}
#####99-04
RR9904_clim<- spline_calcs_9904 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR9904_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_9904mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR9904_clim)
plot(resis_9904mod_pcx)
qqmath(resis_9904mod_pcx)
summary(resis_9904mod_pcx) 

resis_9904mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_9904mod_pcx_noG)
qqmath(resis_9904mod_pcx_noG)
summary(resis_9904mod_pcx_noG) #nothing significant 

dredge(resis_9904mod_pcx) ##null model is the best

resis_9904mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR9904_clim)
plot(resis_9904mod_pcy)
qqmath(resis_9904mod_pcy)
summary(resis_9904mod_pcy) 

resis_9904mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_9904mod_pcy_noG)
qqmath(resis_9904mod_pcy_noG)
summary(resis_9904mod_pcy_noG) 

dredge(resis_9904mod_pcy) ##null model is the best 

#distance model
resis_9904mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR9904_clim)
plot(resis_9904mod_dist)
qqmath(resis_9904mod_dist)
summary(resis_9904mod_dist) #nothing significant

resis_9904mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_9904mod_dist_noG)
qqmath(resis_9904mod_dist_noG)
summary(resis_9904mod_dist_noG) #nothing significant when gila removed

dredge(resis_9904mod_dist) ##null model is best 
```


```{r}
#####99-04
RR1_clim<- spline_calcs_list[[1]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR1_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_1mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR1_clim)
plot(resis_1mod_pcx)
qqmath(resis_1mod_pcx)
summary(resis_1mod_pcx) 

resis_1mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_1mod_pcx_noG)
qqmath(resis_1mod_pcx_noG)
summary(resis_1mod_pcx_noG) #nothing significant 

dredge(resis_1mod_pcx) ##null model is the best

resis_1mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR1_clim)
plot(resis_1mod_pcy)
qqmath(resis_1mod_pcy)
summary(resis_1mod_pcy) 

resis_1mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_1mod_pcy_noG)
qqmath(resis_1mod_pcy_noG)
summary(resis_1mod_pcy_noG) 

dredge(resis_1mod_pcy) ##null model is the best 

#distance model
resis_1mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR1_clim)
plot(resis_1mod_dist)
qqmath(resis_1mod_dist)
summary(resis_1mod_dist) 

resis_1mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_1mod_dist_noG)
qqmath(resis_1mod_dist_noG)
summary(resis_1mod_dist_noG) #nothing significant when gila removed

dredge(resis_1mod_dist) ##null model is best 
```

```{r}
#####3 year
RR2_clim<- spline_calcs_list[[2]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR2_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_2mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR2_clim)
plot(resis_2mod_pcx)
qqmath(resis_2mod_pcx)
summary(resis_2mod_pcx) 

resis_2mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_2mod_pcx_noG)
qqmath(resis_2mod_pcx_noG)
summary(resis_2mod_pcx_noG) #nothing significant 

dredge(resis_2mod_pcx) ##null model is the best

resis_2mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR2_clim)
plot(resis_2mod_pcy)
qqmath(resis_2mod_pcy)
summary(resis_2mod_pcy) 

resis_2mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_2mod_pcy_noG)
qqmath(resis_2mod_pcy_noG)
summary(resis_2mod_pcy_noG) 

dredge(resis_2mod_pcy) ##null model is the best 

#distance model
resis_2mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR2_clim)
plot(resis_2mod_dist)
qqmath(resis_2mod_dist)
summary(resis_2mod_dist) #geo distance is significant

resis_2mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_2mod_dist_noG)
qqmath(resis_2mod_dist_noG)
summary(resis_2mod_dist_noG) #geo distance is significant when gila removed

dredge(resis_2mod_dist) ##but null model is best 
```

```{r}
#####5 year
RR3_clim<- spline_calcs_list[[3]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR3_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_3mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR3_clim)
plot(resis_3mod_pcx)
qqmath(resis_3mod_pcx)
summary(resis_3mod_pcx) 

resis_3mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_pcx_noG)
qqmath(resis_3mod_pcx_noG)
summary(resis_3mod_pcx_noG) #nothing significant 

dredge(resis_3mod_pcx) ##null model is the best

resis_3mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR3_clim)
plot(resis_3mod_pcy)
qqmath(resis_3mod_pcy)
summary(resis_3mod_pcy) 

resis_3mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_pcy_noG)
qqmath(resis_3mod_pcy_noG)
summary(resis_3mod_pcy_noG) 

dredge(resis_3mod_pcy) ##null model is the best 

#distance model
resis_3mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR3_clim)
plot(resis_3mod_dist)
qqmath(resis_3mod_dist)
summary(resis_3mod_dist) 

resis_3mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_dist_noG)
qqmath(resis_3mod_dist_noG)
summary(resis_3mod_dist_noG) #nothing significant when gila removed

dredge(resis_3mod_dist) ##null model is best 
```

```{r}
#####7 year
RR7_clim<- spline_calcs_list[[4]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR7_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_7mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR7_clim)
plot(resis_7mod_pcx)
qqmath(resis_7mod_pcx)
summary(resis_7mod_pcx) 

resis_7mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_7mod_pcx_noG)
qqmath(resis_7mod_pcx_noG)
summary(resis_7mod_pcx_noG) #nothing significant 

dredge(resis_7mod_pcx) ##null model is the best

resis_7mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR7_clim)
plot(resis_7mod_pcy)
qqmath(resis_7mod_pcy)
summary(resis_7mod_pcy) 

resis_7mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_7mod_pcy_noG)
qqmath(resis_7mod_pcy_noG)
summary(resis_7mod_pcy_noG) 

dredge(resis_7mod_pcy) ##null model is the best 

#distance model
resis_7mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR7_clim)
plot(resis_7mod_dist)
qqmath(resis_7mod_dist)
summary(resis_7mod_dist) 

resis_7mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_7mod_dist_noG)
qqmath(resis_7mod_dist_noG)
summary(resis_7mod_dist_noG) #nothing significant when gila removed

dredge(resis_7mod_dist) ##null model is best 
```

#####resilience

```{r}
###resilience
resil_mod_pcx <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR4_clim)
plot(resil_mod_pcx)
qqmath(resil_mod_pcx)
summary(resil_mod_pcx)
ggplot(RR4_clim, aes(x=PC1, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

RR4_clim_noG <- RR4_clim %>% filter(!Provenance == "Gila NF")

resil_mod_pcx_noG <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR4_clim_noG)
plot(resil_mod_pcx_noG)
qqmath(resil_mod_pcx_noG)
summary(resil_mod_pcx_noG)

dredge(resil_mod_pcx) #null model is best when Gila is included
dredge(resil_mod_pcx_noG) #null is best when Gila is excluded

resil_mod_pcy <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR4_clim)
plot(resil_mod_pcy)
qqmath(resil_mod_pcy)
summary(resil_mod_pcy)
ggplot(RR4_clim, aes(x=PC1, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

resil_mod_pcy_noG <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR4_clim_noG)
plot(resil_mod_pcy_noG)
qqmath(resil_mod_pcy_noG)
summary(resil_mod_pcy_noG)

dredge(resil_mod_pcy) #null model is best when Gila is included
dredge(resil_mod_pcy_noG) #null is best when Gila is excluded, though model with just latitude has delta <2

ggplot(RR4_clim_noG, aes(x=y, y=resilience))+
  geom_point()+
  geom_smooth(method="glm")


##distance
resil_mod_dist <- lmer(resilience ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim)
plot(resil_mod_dist)
qqmath(resil_mod_dist)
summary(resil_mod_dist) #both significant
dredge(resil_mod_dist) #null is best, followed by climate distance only

resil_mod_dist_noG <- lmer(resilience ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim_noG)
plot(resil_mod_dist_noG)
qqmath(resil_mod_dist_noG)
summary(resil_mod_dist_noG) #only geo distance significant when Gila is excluded
dredge(resil_mod_dist_noG) #null model is better though

##figure for effect of geo dist on resilience
##take random effect out to make predictions
resil_mod_dist_lm_noG <- lm(resilience ~  scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km), data=RR4_clim_noG)

predicted_scores_resil <- predict(
  resil_mod_dist_lm_noG, 
  newdata = newdata_geodist, interval='confidence') %>% as.data.frame()

newdata_geodist_pred_resil <- bind_cols(newdata_geodist, predicted_scores_resil)

ggplot()+
  geom_point(data=RR4_clim_noG, aes(x=geo.dist.to.plant.km, y=resilience))+
  geom_ribbon(data=newdata_geodist_pred_resil, aes(x=geo.dist.to.plant.km,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_geodist_pred_resil, aes(x=geo.dist.to.plant.km, y=fit), col="turquoise")

```


######all other time periods
```{r}

#####01-02
##PCA models
resil_0102mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0102_clim)
plot(resil_0102mod_pcx)
qqmath(resil_0102mod_pcx)
summary(resil_0102mod_pcx) 

resil_0102mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0102mod_pcx_noG)
qqmath(resil_0102mod_pcx_noG)
summary(resil_0102mod_pcx_noG) #nothing significant when Gila removed

dredge(resil_0102mod_pcx) ##null model is the best

resil_0102mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0102_clim)
plot(resil_0102mod_pcy)
qqmath(resil_0102mod_pcy)
summary(resil_0102mod_pcy) 

resil_0102mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0102mod_pcy_noG)
qqmath(resil_0102mod_pcy_noG)
summary(resil_0102mod_pcy_noG) #nothing is significant when Gila removed

dredge(resil_0102mod_pcy) ##null model is the best still though 

#distance model
resil_0102mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0102_clim)
plot(resil_0102mod_dist)
qqmath(resil_0102mod_dist)
summary(resil_0102mod_dist) #geographic distance to the plantation is significant

resil_0102mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0102mod_dist_noG)
qqmath(resil_0102mod_dist_noG)
summary(resil_0102mod_dist_noG) #geographic distance to the plantation is still significant

dredge(resil_0102mod_dist) ##null model is still best though 
```

```{r}
#####02-03
RR0203_clim<- spline_calcs_0203 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0203_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_0203mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0203_clim)
plot(resil_0203mod_pcx)
qqmath(resil_0203mod_pcx)
summary(resil_0203mod_pcx) #PC1:PC2 is significant

resil_0203mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0203mod_pcx_noG)
qqmath(resil_0203mod_pcx_noG)
summary(resil_0203mod_pcx_noG) #nothing significant 

dredge(resil_0203mod_pcx) ##null model is the best

resil_0203mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0203_clim)
plot(resil_0203mod_pcy)
qqmath(resil_0203mod_pcy)
summary(resil_0203mod_pcy) 

resil_0203mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0203mod_pcy_noG)
qqmath(resil_0203mod_pcy_noG)
summary(resil_0203mod_pcy_noG) 

dredge(resil_0203mod_pcy) ##null model is the best 

#distance model
resil_0203mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0203_clim)
plot(resil_0203mod_dist)
qqmath(resil_0203mod_dist)
summary(resil_0203mod_dist) #both distances are significant

resil_0203mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0203mod_dist_noG)
qqmath(resil_0203mod_dist_noG)
summary(resil_0203mod_dist_noG) #nothing significant when gila removed

dredge(resil_0203mod_dist) ##null model is best 
```

```{r}
#####00-03
RR0003_clim<- spline_calcs_0003 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0003_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_0003mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0003_clim)
plot(resil_0003mod_pcx)
qqmath(resil_0003mod_pcx)
summary(resil_0003mod_pcx) #longitude significant

resil_0003mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0003mod_pcx_noG)
qqmath(resil_0003mod_pcx_noG)
summary(resil_0003mod_pcx_noG) #nothing significant 

dredge(resil_0003mod_pcx) ##null model is the best

resil_0003mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0003_clim)
plot(resil_0003mod_pcy)
qqmath(resil_0003mod_pcy)
summary(resil_0003mod_pcy) 

resil_0003mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0003mod_pcy_noG)
qqmath(resil_0003mod_pcy_noG)
summary(resil_0003mod_pcy_noG) 

dredge(resil_0003mod_pcy) ##null model is the best 

#distance model
resil_0003mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0003_clim)
plot(resil_0003mod_dist)
qqmath(resil_0003mod_dist)
summary(resil_0003mod_dist) #both distances are significant

resil_0003mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0003mod_dist_noG)
qqmath(resil_0003mod_dist_noG)
summary(resil_0003mod_dist_noG) #nothing significant when gila removed

dredge(resil_0003mod_dist) ##null model is best 
```

```{r}
#####00-05
RR0005_clim<- spline_calcs_0005 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df) %>% 
  filter(!is.na(resilience))

ggplot(RR0005_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_0005mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0005_clim)
plot(resil_0005mod_pcx)
qqmath(resil_0005mod_pcx)
summary(resil_0005mod_pcx)#nothing significant

resil_0005mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0005mod_pcx_noG)
qqmath(resil_0005mod_pcx_noG)
summary(resil_0005mod_pcx_noG) #nothing significant 

dredge(resil_0005mod_pcx) ##null model is the best

resil_0005mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0005_clim)
plot(resil_0005mod_pcy)
qqmath(resil_0005mod_pcy)
summary(resil_0005mod_pcy) 

resil_0005mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0005mod_pcy_noG)
qqmath(resil_0005mod_pcy_noG)
summary(resil_0005mod_pcy_noG) 

dredge(resil_0005mod_pcy) ##null model is the best 

#distance model
resil_0005mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0005_clim)
plot(resil_0005mod_dist)
qqmath(resil_0005mod_dist)
summary(resil_0005mod_dist) #both distances are significant

resil_0005mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0005mod_dist_noG)
qqmath(resil_0005mod_dist_noG)
summary(resil_0005mod_dist_noG) #nothing significant when gila removed

dredge(resil_0005mod_dist) ##null model is best 
```

```{r}
#####99-04
RR9904_clim<- spline_calcs_9904 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR9904_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_9904mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR9904_clim)
plot(resil_9904mod_pcx)
qqmath(resil_9904mod_pcx)
summary(resil_9904mod_pcx) 

resil_9904mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_9904mod_pcx_noG)
qqmath(resil_9904mod_pcx_noG)
summary(resil_9904mod_pcx_noG) #nothing significant 

dredge(resil_9904mod_pcx) ##null model is the best

resil_9904mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR9904_clim)
plot(resil_9904mod_pcy)
qqmath(resil_9904mod_pcy)
summary(resil_9904mod_pcy) 

resil_9904mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_9904mod_pcy_noG)
qqmath(resil_9904mod_pcy_noG)
summary(resil_9904mod_pcy_noG) 

dredge(resil_9904mod_pcy) ##null model is the best 

#distance model
resil_9904mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR9904_clim)
plot(resil_9904mod_dist)
qqmath(resil_9904mod_dist)
summary(resil_9904mod_dist) #climate distance significant

resil_9904mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_9904mod_dist_noG)
qqmath(resil_9904mod_dist_noG)
summary(resil_9904mod_dist_noG) #nothing significant when gila removed

dredge(resil_9904mod_dist) ##null model is best 
```


```{r}
#####99-04
RR1_clim<- spline_calcs_list[[1]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR1_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_1mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR1_clim)
plot(resil_1mod_pcx)
qqmath(resil_1mod_pcx)
summary(resil_1mod_pcx) 

resil_1mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_1mod_pcx_noG)
qqmath(resil_1mod_pcx_noG)
summary(resil_1mod_pcx_noG) #nothing significant 

dredge(resil_1mod_pcx) ##null model is the best

resil_1mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR1_clim)
plot(resil_1mod_pcy)
qqmath(resil_1mod_pcy)
summary(resil_1mod_pcy) #PC1:PC2 significant

resil_1mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_1mod_pcy_noG)
qqmath(resil_1mod_pcy_noG)
summary(resil_1mod_pcy_noG) #nothing significant

dredge(resil_1mod_pcy) ##null model is the best 

#distance model
resil_1mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR1_clim)
plot(resil_1mod_dist)
qqmath(resil_1mod_dist)
summary(resil_1mod_dist)  #climate distance significant

resil_1mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_1mod_dist_noG)
qqmath(resil_1mod_dist_noG)
summary(resil_1mod_dist_noG) #nothing significant when gila removed

dredge(resil_1mod_dist) ##null model is best 
```

```{r}
#####3 year
RR2_clim<- spline_calcs_list[[2]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

RR2_clim_nog <- RR2_clim %>% filter(!Provenance=="Gila NF")

ggplot(RR2_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_2mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR2_clim)
plot(resil_2mod_pcx)
qqmath(resil_2mod_pcx)
summary(resil_2mod_pcx) #longitude significant

resil_2mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_2mod_pcx_noG)
qqmath(resil_2mod_pcx_noG)
summary(resil_2mod_pcx_noG) #longitude still significant 

dredge(resil_2mod_pcx) ##null model is the best though

resil_2mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR2_clim)
plot(resil_2mod_pcy)
qqmath(resil_2mod_pcy)
summary(resil_2mod_pcy) 

resil_2mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR2_clim_nog)
plot(resil_2mod_pcy_noG)
qqmath(resil_2mod_pcy_noG)
summary(resil_2mod_pcy_noG) 

dredge(resil_2mod_pcy) ##model with just latitude is best, followed closely by the best model
dredge(resil_2mod_pcy_noG)

resil_2mod_pcy_bestmod <- lmer(log(resilience) ~ scale(y) + I(scale(y)^2) + (1|Provenance), data=RR2_clim)
plot(resil_2mod_pcy_bestmod)
qqmath(resil_2mod_pcy_bestmod)
summary(resil_2mod_pcy_bestmod) 


#distance model
resil_2mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR2_clim)
plot(resil_2mod_dist)
qqmath(resil_2mod_dist)
summary(resil_2mod_dist) #both distances are significant

resil_2mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_2mod_dist_noG)
qqmath(resil_2mod_dist_noG)
summary(resil_2mod_dist_noG) #geo distance is significant when gila removed

dredge(resil_2mod_dist) ##but null model is best 
```

```{r}
#####5 year
RR3_clim<- spline_calcs_list[[3]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR3_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_3mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR3_clim)
plot(resil_3mod_pcx)
qqmath(resil_3mod_pcx)
summary(resil_3mod_pcx) #longitude significant

resil_3mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_3mod_pcx_noG)
qqmath(resil_3mod_pcx_noG)
summary(resil_3mod_pcx_noG) #nothing significant 

dredge(resil_3mod_pcx) ##null model is the best

resil_3mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR3_clim)
plot(resil_3mod_pcy)
qqmath(resil_3mod_pcy)
summary(resil_3mod_pcy) 

resil_3mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_3mod_pcy_noG)
qqmath(resil_3mod_pcy_noG)
summary(resil_3mod_pcy_noG) 

dredge(resil_3mod_pcy) ##null model is the best 

#distance model
resil_3mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR3_clim)
plot(resil_3mod_dist)
qqmath(resil_3mod_dist)
summary(resil_3mod_dist) #both distances are significant

resil_3mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_3mod_dist_noG)
qqmath(resil_3mod_dist_noG)
summary(resil_3mod_dist_noG) #nothing significant when gila removed

dredge(resil_3mod_dist) ##null model is best 
```

```{r}
#####7 year
RR7_clim<- spline_calcs_list[[4]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df) %>% 
  filter(!is.na(resilience))

ggplot(RR7_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resil_7mod_pcx <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR7_clim)
plot(resil_7mod_pcx)
qqmath(resil_7mod_pcx)
summary(resil_7mod_pcx) 

resil_7mod_pcx_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_7mod_pcx_noG)
qqmath(resil_7mod_pcx_noG)
summary(resil_7mod_pcx_noG) #nothing significant 

dredge(resil_7mod_pcx) ##null model is the best

resil_7mod_pcy <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR7_clim)
plot(resil_7mod_pcy)
qqmath(resil_7mod_pcy)
summary(resil_7mod_pcy) #nothing significant

resil_7mod_pcy_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_7mod_pcy_noG)
qqmath(resil_7mod_pcy_noG)
summary(resil_7mod_pcy_noG) #nothing significant

dredge(resil_7mod_pcy) ##null model is the best 

#distance model
resil_7mod_dist <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR7_clim)
plot(resil_7mod_dist)
qqmath(resil_7mod_dist)
summary(resil_7mod_dist) 

resil_7mod_dist_noG <- lmer(log(resilience) ~ scale(dist.to.plant.3d)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_7mod_dist_noG)
qqmath(resil_7mod_dist_noG)
summary(resil_7mod_dist_noG) #nothing significant when gila removed

dredge(resil_7mod_dist) ##null model is best 
```


###Other Metrics

####long pre-drought

```{r}
###calculate resistance using all growth data from 1985 - 2001 as the pre-drought period
drought_new<- growth.detrended.df %>% 
  filter(year == 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2002) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs <- left_join(drought_new,predrought_new) %>% 
  mutate(resistance = drought_ave/predrought_ave) %>% 
  left_join(dbh_age %>% dplyr::select(tree,Provenance) %>% unique(), by="tree")

mean(new_calcs$resistance)

new_aov_resist <- aov(resistance ~ Provenance, data=new_calcs)
par(mfrow=c(2,2))
plot(new_aov_resist)
summary(new_aov_resist) #no difference in resistance when compared to average growth 1985-2002

ggplot(new_calcs, aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##drought year = 2003
drought03_new<- growth.detrended.df %>% 
  filter(year == 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought03_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2003) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs03 <- left_join(drought03_new,predrought03_new) %>% 
  mutate(resistance = drought_ave/predrought_ave) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

new_aov_resist03 <- aov(resistance ~ Provenance, data=new_calcs03)
par(mfrow=c(2,2))
plot(new_aov_resist03)
summary(new_aov_resist03) #no difference in resistance in 2003 when compared to average growth 1985-2002
```

####recovery time
```{r}
#####recovery time 

no_reduction<- growth.detrended.df %>% 
  filter(year == 2002) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff<0) ##50 trees didn't reduce growth in 2002

count_no_red<- growth.detrended.df %>%
  filter(year==2002) %>% 
  group_by(Provenance) %>% 
  summarise(ntrees=n()) %>% 
  left_join(no_reduction %>% group_by(Provenance) %>% summarise(nNR=n()))

ggplot(count_no_red, aes(x=Provenance, y=(nNR/ntrees)*100))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
  
recover_time<- growth.detrended.df %>%
  filter(!tree %in% no_reduction$tree) %>% 
  filter(year > 2001) %>%
  left_join(predrought_new) %>% 
  mutate(diff = rw_spline - predrought_ave) %>% 
  filter(diff>0) %>% 
  group_by(tree) %>% 
  summarise(minyr = min(year)) %>% 
  mutate(recoverytime = as.numeric(minyr) - 2002) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

aov.recover <- aov(log(recoverytime) ~ Provenance, data=recover_time)
par(mfrow=c(2,2))
plot(aov.recover)
summary(aov.recover)  #no difference in recovery time

ggplot(recover_time, aes(x=Provenance, y=recoverytime))+
  geom_boxplot()+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##climate model for recovery time
recover_time_clim <- recover_time %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

recov_mod_pcax <- lmer(log(recoverytime) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pcax)
qqmath(recov_mod_pcax)
summary(recov_mod_pcax)
dredge(recov_mod_pcax) #null model is best

recov_mod_pcay <- lmer(log(recoverytime) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pcay)
qqmath(recov_mod_pcay)
summary(recov_mod_pcay)
dredge(recov_mod_pcay) #null model is best

recov_mod_dist <- lmer(log(recoverytime) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_dist)
qqmath(recov_mod_dist)
summary(recov_mod_dist)
dredge(recov_mod_dist) #null model is best

###
not_recovered<- dbh_age_good %>% 
  filter(! tree %in% no_reduction$tree) %>% 
  filter(! tree %in% recover_time$tree) 
not_recovered ##all of the trees recovered

#total growth reduction
growth_red<- growth.detrended.df %>% 
  filter(!tree %in% no_reduction$tree) %>% 
  filter(!tree %in% unique(not_recovered$tree)) %>% 
  filter(year>2001) %>% 
  left_join(predrought_new) %>% 
  mutate(growth_red = predrought_ave-rw_spline) %>% 
  filter(growth_red>0)

growth_red_sum <- growth_red %>% 
  left_join(recover_time, by="tree") %>% 
  mutate(year_diff = minyr-year) %>% 
  filter(year_diff > 0) %>% 
  group_by(tree) %>% 
  summarise(max.growth.red = max(growth_red), sum.growth.red=sum(growth_red)) %>% 
  left_join(growth_red, by=c("max.growth.red" = "growth_red", "tree")) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  left_join(recover_time, by=c("newname"="Provenance", "tree")) %>% 
  left_join(left_join(prov_pcapts,pca_dist_df), by=c("newname"="Provenance")) %>% 
  left_join(geo.dist.df, by=c("newname"="Provenance"))

##max growth reduction models
#anova
aov.mgr <- aov(max.growth.red ~ Provenance, data=growth_red_sum)
par(mfrow=c(2,2))
plot(aov.mgr)
summary(aov.mgr)  #no significant difference in max growth reduction between provenances

#linear models
mgr.pcmodx <- lmer(max.growth.red ~ PC1*PC2 + scale(x) + I(scale(x)^2) + (1|Provenance), data=growth_red_sum)
plot(mgr.pcmodx)
qqmath(mgr.pcmodx)
summary(mgr.pcmodx)
dredge(mgr.pcmodx) #null is best

mgr.pcmody <- lmer(max.growth.red ~ PC1*PC2 + scale(y) + I(scale(y)^2) + (1|Provenance), data=growth_red_sum)
plot(mgr.pcmody)
qqmath(mgr.pcmody)
summary(mgr.pcmody)
dredge(mgr.pcmody) #null is best

mgr.distmod <- lmer(max.growth.red ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=growth_red_sum)
plot(mgr.distmod)
qqmath(mgr.distmod)
summary(mgr.distmod) #nothing significant

ggplot(growth_red_sum, aes(x=Provenance, y=max.growth.red))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


##sum growth reduction models
#anova
aov.sumgr <- aov(log(sum.growth.red) ~ Provenance, data=growth_red_sum)
par(mfrow=c(2,2))
plot(aov.sumgr)
summary(aov.sumgr)  #no significant difference in sum growth reduction between provenances

#linear models
sumgr.pcmodx <- lmer(log(sum.growth.red) ~ PC1*PC2 + scale(x) + I(scale(x)^2) + (1|Provenance), data=growth_red_sum)
plot(sumgr.pcmodx)
qqmath(sumgr.pcmodx)
summary(sumgr.pcmodx)
dredge(sumgr.pcmodx) #null is best

sumgr.pcmody <- lmer(log(sum.growth.red) ~ PC1*PC2 + scale(y) + I(scale(y)^2) + (1|Provenance), data=growth_red_sum)
plot(sumgr.pcmody)
qqmath(sumgr.pcmody)
summary(sumgr.pcmody)
dredge(sumgr.pcmody) #null is best

sumgr.distmod <- lmer(log(sum.growth.red) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=growth_red_sum)
plot(sumgr.distmod)
qqmath(sumgr.distmod)
summary(sumgr.distmod) #nothing significant

ggplot(growth_red_sum, aes(x=Provenance, y=sum.growth.red))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

```

##Cold tolerance

```{r}

growth_periods<- growth.detrended.df %>% 
  mutate(period = case_when(year < 1992 ~ "1986-1991",
                            year < 1997 & year > 1991 ~ "1992-1996",
                            year < 2007 & year > 1996 ~ "1997-2006",
                            year > 2006 ~ "2007-2014"))

growth_periods_sum <- growth_periods %>% 
  group_by(period, tree, Provenance) %>% 
  summarise(ave_rwi = mean(rw_spline))

ggplot(growth_periods_sum, aes(x=period, y=ave_rwi, fill=Provenance))+
  geom_boxplot()

#periods between survival measurements 1970-1974, 1975-1979, 1980-1985, 1986-1991, 1992-1996, 1997-2006, 2007-2014
frost_days
tmin_all
plantation_clim_coldxtremes
plantation_clim_long_qs

moniger_survival_byyr

fost_days_sum <- frost_days %>% 
  mutate(period = case_when(year < 1975 ~ "1970-1974",
                            year > 1974 & year < 1980 ~ "1975-1979",
                            year > 1979 & year < 1986 ~ "1980-1985",
                            year < 1992 ~ "1986-1991",
                            year < 1997 & year > 1991 ~ "1992-1996",
                            year < 2007 & year > 1996 ~ "1997-2006",
                            year > 2006 ~ "2007-2014")) %>% 
  group_by(period) %>% 
  summarise(n_days = sum(n), ave_days=mean(n))



p.died.byyr<- moniger_survival_byyr %>% 
  group_by(Provenance, year) %>% 
  summarise(n=n(), alive=sum(value)) %>% 
  mutate(dead=n-alive) %>% 
  mutate(prop.died = dead/n, prop.total=alive/48) %>% 
  mutate(period= case_when(year == 1974 ~ "1970-1974",
                           year == 1979 ~ "1975-1979",
                           year == 1985 ~ "1980-1985",
                           year == 1991 ~ "1986-1991",
                            year == 1996 ~ "1992-1996",
                            year == 2006 ~ "1997-2006",
                            year == 2014 ~ "2007-2014"))

ggplot(p.died.byyr, aes(x=year, y=prop.total, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  #geom_point(size=3,aes(x=year, y=prop.total, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_line(linewidth=2)+
  scale_color_manual(values=unname(stepped()), name="Provenance")

p.died.byyr.binom <-moniger_survival_byyr %>% 
    mutate(period= case_when(year == 1974 ~ "1970-1974",
                           year == 1979 ~ "1975-1979",
                           year == 1985 ~ "1980-1985",
                           year == 1991 ~ "1986-1991",
                            year == 1996 ~ "1992-1996",
                            year == 2006 ~ "1997-2006",
                            year == 2014 ~ "2007-2014"))

ggplot(p.died.byyr, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=prop.died, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_bar(stat = 'identity', position='dodge')+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~period)+
  theme(axis.text.x=element_text(angle=45, hjust=1))

plantation_clim_periods<- plantation_clim_long %>% 
  mutate(period = case_when(year < 1975 ~ "1970-1974",
                            year > 1974 & year < 1980 ~ "1975-1979",
                            year > 1979 & year < 1986 ~ "1980-1985",
                            year < 1992 ~ "1986-1991",
                            year < 1997 & year > 1991 ~ "1992-1996",
                            year < 2007 & year > 1996 ~ "1997-2006",
                            year > 2006 ~ "2007-2014")) %>% 
  group_by(period, name) %>% 
  summarise(mean=mean(value, na.rm=TRUE), sd=sd(value, na.rm=TRUE))
  
plantation_clim_periods_wide <- plantation_clim_periods %>% 
  dplyr::select(-sd) %>% 
  pivot_wider(names_from=name, values_from = mean)


survival_period_data<- plantation_clim_periods_wide %>%  left_join(p.died.byyr.binom)

surv_period_pvalues <- data.frame()
for(i in 1:length(unique(plantation_clim_periods$name))){
var <- unique(plantation_clim_periods$name)[i]
mod <- glmer(survival_period_data %>% pull(value) ~ survival_period_data %>% pull(var) + (1|Provenance) + (1|period), data=survival_period_data, family="binomial") 
summary<- as.data.frame(summary(mod)$coefficients) 
pvalue <- summary %>% slice(2) %>% pull(`Pr(>|z|)`)
surv_period_pvalues <- bind_rows(surv_period_pvalues, data.frame(var=var, pvalue=pvalue))
}

surv_period_pvalues %>% 
  arrange(pvalue)

wtvpd_surv_mod <- glmer(value ~ vpdmax_wt + (1|Provenance) + (1|period), data=survival_period_data, family="binomial") 
summary(wtvpd_surv_mod)


wtvpd_surv_mod_glm<- glm(value ~ vpdmax_wt, data=survival_period_data, family = "binomial")

###make plot for distance model
vpd_surv_newdata1 <- with(survival_period_data, data.frame(vpdmax_wt = seq(min(vpdmax_wt),max(vpdmax_wt), length.out=50)))

vpd_surv_newdata2 <- cbind(vpd_surv_newdata1, predict(wtvpd_surv_mod_glm, newdata = vpd_surv_newdata1, type = "link", se=TRUE))
vpd_surv_newdata3 <- within(vpd_surv_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(vpd_surv_newdata3, aes(x = vpdmax_wt, y=PredictedProb))+
  geom_ribbon(aes(ymin = LL, ymax = UL), alpha=0.5) + 
  geom_line()+
  xlab("Winter VPD max")+
  ylab("Predicted Probability of Survival")+
  theme_bw()+
  theme(legend.position = "bottom")


```
##Correlations

###climate x climate cors
```{r}
##look at correlation between current year and previous year climate variables at plantation

plantation_clim_minus1<- plantation_clim %>% mutate(year = year+1) %>% 
 dplyr::select(c(CN:year,PPTsm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum))

colnames(plantation_clim_minus1)<- paste("prior_",colnames(plantation_clim_minus1),sep="")

plantation_clim_cor<- plantation_clim %>% 
 dplyr::select(c(CN:year,PPTsm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
 dplyr::select(-c(CN,year)) %>% 
  cor()

plantation_clim_cor>0.7

ggcorrplot(plantation_clim_cor, type="lower", insig = "blank", lab=FALSE)

plantation_clim_cor_yrof<- plantation_clim %>% 
 dplyr::select(c(CN:year,PPTsm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  filter(! year %in% c(1970)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
 dplyr::select(-c(CN,year)) %>% 
  cor()

ggcorrplot(plantation_clim_cor_yrof, type="lower", insig = "blank", lab=TRUE)

##look at trends in climate over time at the plantation
plantation_clim_long<- plantation_clim %>% 
  dplyr::select(c(CN:vpdmax_sp, FDSI, ppt_sum, tmean_ave, aet_sum, cwd_sum, spei_sum)) %>% 
  pivot_longer(PPTsm:spei_sum)

ggplot(plantation_clim_long, aes(x=year, y=value, col=name, group=name))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~name, scales="free")

plantation_clim_long_studyperiod<- plantation_clim_long %>% 
  filter(!year > 2014) %>% 
  filter(!year < 1970) %>% 
  filter(!is.na(value))

plantation_climvars <- unique(plantation_clim_long_studyperiod$name)

plant_clim_mods <- data.frame()
for(i in 1:length(plantation_climvars)){
climvar = plantation_climvars[i]
data= plantation_clim_long_studyperiod %>% filter(name==climvar)
mod <- lm(value ~ year, data=data)
pvalue = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
plant_clim_mods <- bind_rows(plant_clim_mods, data.frame(climvar=climvar, pvalue=pvalue))
}

plant_clim_mods %>% filter(pvalue<0.05)

##sm tmin
mod_smtmin <- lm(value ~ year, data=plantation_clim_long_studyperiod %>% filter(name=="value_sm_tmin"))
par(mfrow=c(2,2))
plot(mod_smtmin)
summary(mod_smtmin)

##fa tmin
mod_fatmin <- lm(value ~ year, data=plantation_clim_long_studyperiod %>% filter(name=="value_fa_tmin"))
par(mfrow=c(2,2))
plot(mod_fatmin)
summary(mod_fatmin)

##aet
mod_aet <- lm(value ~ year, data=plantation_clim_long_studyperiod %>% filter(name=="aet_sum"))
par(mfrow=c(2,2))
plot(mod_aet)
summary(mod_aet)

ggplot(plantation_clim_long %>% filter(year > 1969 & year < 2015) %>% filter(name %in% c("aet_sum","value_sm_tmin","value_fa_tmin")), aes(x=year, y=value, col=name, group=name))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~name, scales="free")

```

###growth x climate cors

```{r}
##calculate correlations between detrended growth and climate at plantation

plantation_frost_minus1<- plantation_frost %>% mutate(year = year+1) 

colnames(plantation_frost_minus1)<- paste("prior_",colnames(plantation_frost_minus1),sep="")

growth_climate_df <- growth.detrended.df %>% 
  left_join(plantation_clim) %>% 
  left_join(plantation_frost) %>% 
 dplyr::select(c(CN:year,PPTsm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum, day_of_last_spring_frost, day_of_first_fall_frost)) %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  left_join(plantation_frost_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  filter(!is.na(rw_spline))

climvars <- colnames(growth_climate_df %>% dplyr::select(-c(CN:year)))
tree_ids <- unique(growth_climate_df$tree)

gc_cor_df<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i])
  tree <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline)
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df <- bind_rows(gc_cor_df, row)
  }}
gc_cor_df %>% group_by(V1) %>% summarise(n=n())

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  arrange(n) %>% 
  print(n=55) #number of trees with significant correlations between growth and each climate var

gc_cor_df %>% 
  group_by(V2) %>% 
  summarise(maxcor = max(rw_spline, na.rm=T)) %>% 
  left_join(gc_cor_df, by=c("maxcor"="rw_spline", "V2")) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>%
  arrange(n) %>%
  print(n=55) #number of trees whose maximum correlation value is with each climate var 

cor_clean <- gc_cor_df %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>%
  filter(!is.na(cor))

ggplot(cor_clean %>% filter(climvar %in% c("aet_sum" , "cwd_wy" , "PPTsm", "vpdmax_wt", "prior_aet_sum", "prior_cwd_wy", "prior_PPTsm" , "prior_vpdmax_wt")), aes(x=Provenance, y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_wrap(~factor(climvar, levels=c("aet_sum","cwd_wy","PPTsm","vpdmax_wt", "prior_aet_sum","prior_cwd_wy","prior_PPTsm","prior_vpdmax_wt")),nrow=2)+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))
  
##all the rest of the climate variables
ggplot(cor_clean %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=code, y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_wrap(~climvar)+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))
###

cor_summary<- gc_cor_df %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  filter(p.value<0.05) %>% 
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>%
  filter(!is.na(cor)) %>% 
  group_by(Provenance, climvar) %>% 
  summarise(n=n(), meancor = mean(cor), se=sd(cor)/sqrt(n())) %>% 
  ungroup() %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  rename(Provenance = newname) %>% 
  left_join(prov_names)

ggplot(cor_summary %>% filter(n > 1), aes(x=climvar, y=meancor, fill=meancor>0))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymax = meancor+se, ymin=meancor-se), width=0.2)+
  scale_fill_viridis(discrete=TRUE, direction=-1)+
  facet_grid(~code)+
  coord_flip()+
  geom_hline(yintercept=0)

allanovas<- data.frame()
for(i in 1:length(climvars)){
mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == climvars[i]))
modanova <- as.data.frame(Anova(mod, type="2"))
pvalue<- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Pr(>F)`)
provSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Sum Sq`)
provdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Df`)
residSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Sum Sq`)
residdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Df`)
allanovas <- bind_rows(allanovas, data.frame(climvar=climvars[i],pvalue=pvalue, provMS = provSS/provdf, residMS = residSS/residdf, provdf=provdf, residdf = residdf))
}

allanovas %>% mutate(diff = residMS - provMS) %>% arrange(diff) ##when residMS is greater than provMS (diff > 0)--> variation within provenances is greater than variation between them 
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff>0) %>% nrow()
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff<0) %>% nrow()

allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff>0)
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff<0) 

write.csv(allanovas %>% mutate(diff = residMS - provMS), "growth_climate_MS.csv")

allanovas %>% filter(pvalue<0.05) #no significant differences between provenances in how correlated RWI is to climate vars
min(allanovas$pvalue)
max(allanovas$pvalue)

ggplot(data=cor_clean, aes(x=Provenance, y=cor))+
  geom_boxplot()+
  facet_wrap(~climvar)

##T-TESTS
provs <- unique(cor_clean$Provenance)
ttestdata<- data.frame()

for(i in 1:length(climvars)){
  for(j in 1:length(provs)){
data <- cor_clean %>% 
  filter(climvar==climvars[i]) %>% 
  filter(Provenance == provs[j])

test<- t.test(data$cor, y = NULL,
       alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

row <- data.frame(climvar = climvars[i], Provenance = provs[j], lwr = test$conf.int[1], upr = test$conf.int[2], estimate = test$estimate, pvalue = test$p.value)

ttestdata <- bind_rows(ttestdata, row)}}

ttestdata %>% filter(pvalue < 0.05) %>% 
  group_by(climvar) %>% 
  summarise(n=n()) %>% 
arrange(n) %>% 
  print(n=56)

sig.cors.byprov <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(climvar %in% c("aet_sum" , "vpdmax_wt", "value_wt_tmean", "prior_aet_sum","prior_PPTsm", "prior_value_wt_tmean")) %>% 
  filter(!is.na(pvalue)) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

nonsig.provs <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(climvar %in% c("aet_sum" , "vpdmax_wt", "value_wt_tmean", "prior_aet_sum","prior_PPTsm", "prior_value_wt_tmean")) %>% 
  dplyr::select(climvar, Provenance, pvalue) %>% 
  unique() %>%
  group_by(Provenance) %>% 
  summarise(sum = sum(pvalue, na.rm=T)) %>% 
  filter(sum==0)%>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

selected_climvars <-  c("vpdmax_wt","value_wt_tmean", "aet_sum")

correlation_plot<- ggplot(data=sig.cors.byprov %>% filter(climvar %in% selected_climvars) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=estimate))+
    geom_jitter(data= cor_clean %>% filter(climvar %in% selected_climvars) %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% dplyr::select(-Provenance) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=cor), fill="gray", color="black", size=2, height=0, width=0.1, alpha=0.2)+
  geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_wrap(~factor(climvar, levels=selected_climvars, labels=c("VPDmax WT", "TMEAN WT", "AET annual")),ncol=1)+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=12, color="black"),
        axis.text.y = element_text(size=12, color="black"),
        axis.title = element_text(size=12, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=12),
        panel.grid = element_blank())

 # png("figures/correlation_plot.png", width=6.5, height=5, res = 300, units = "in")
 # correlation_plot
 # dev.off()
 # 
##correlation plot for current year variables
 
sig.cors.byprov.all <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(!is.na(pvalue)) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

nonsig.provs.all <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  dplyr::select(climvar, Provenance, pvalue) %>% 
  unique() %>%
  group_by(Provenance) %>% 
  summarise(sum = sum(pvalue, na.rm=T)) %>% 
  filter(sum==0)%>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))


current_climvars <- unique(cor_clean$climvar)[1:28]
current_climvars_order1 <- ttestdata %>% filter(pvalue < 0.05) %>% 
  group_by(climvar) %>% 
  summarise(n=n()) %>% 
  filter(climvar %in% current_climvars)
current_climvars_order<- current_climvars_order1 %>% 
  bind_rows(data.frame(climvar=current_climvars, n=0) %>% 
   filter(! climvar %in% current_climvars_order1$climvar)) %>% 
  arrange(n)

ggplot(data=sig.cors.byprov.all%>% filter(climvar %in% current_climvars) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=estimate))+
    geom_jitter(data= cor_clean %>% filter(climvar %in% current_climvars) %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% dplyr::select(-Provenance) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=cor), fill="gray", color="black", size=2, height=0, width=0.1, alpha=0.2)+
  geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_wrap(~factor(climvar, levels=current_climvars_order$climvar))+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8, color="black"),
        axis.text.y = element_text(size=10, color="black"),
        axis.title = element_text(size=10, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=10),
        panel.grid = element_blank())

ggplot(data=sig.cors.byprov.all%>% filter(climvar %in% current_climvars) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(climvar), y=estimate))+
    geom_jitter(data= cor_clean %>% filter(climvar %in% current_climvars) %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% dplyr::select(-Provenance) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(climvar), y=cor), fill="gray", color="black", size=2, height=0, width=0.1, alpha=0.2)+
  geom_errorbar(aes(x=factor(climvar), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(climvar), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_wrap(~factor(code, levels=provs_bylat$code))+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8, color="black"),
        axis.text.y = element_text(size=10, color="black"),
        axis.title = element_text(size=10, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=10),
        panel.grid = element_blank())

prior_climvars <- unique(cor_clean$climvar)[29:56]
prior_climvars_order1 <- ttestdata %>% filter(pvalue < 0.05) %>% 
  group_by(climvar) %>% 
  summarise(n=n()) %>% 
  filter(climvar %in% prior_climvars)
prior_climvars_order<- prior_climvars_order1 %>% 
  bind_rows(data.frame(climvar=prior_climvars, n=0) %>% 
   filter(! climvar %in% prior_climvars_order1$climvar)) %>% 
  arrange(n)

ggplot(data=sig.cors.byprov.all%>% filter(climvar %in% prior_climvars) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=estimate))+
    geom_jitter(data= cor_clean %>% filter(climvar %in% prior_climvars) %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% dplyr::select(-Provenance) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=cor), fill="gray", color="black", size=2, height=0, width=0.1, alpha=0.2)+
  geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_wrap(~factor(climvar, levels=prior_climvars_order$climvar))+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8, color="black"),
        axis.text.y = element_text(size=10, color="black"),
        axis.title = element_text(size=10, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=10),
        panel.grid = element_blank())
```

```{r}
climate_growth_table<- ttestdata %>% 
  left_join(prov_names) %>% 
  dplyr::select(climvar, code, estimate, pvalue) %>% 
  mutate(pvalue=ifelse(pvalue<0.05, "X", ""), estimate=ifelse(estimate > 0 , "+", "-")) %>% 
  mutate(estimate=ifelse(pvalue=="X", estimate, "")) %>% 
  dplyr::select(-pvalue) %>% 
  pivot_wider(names_from=code, values_from=estimate) %>% 
  dplyr::select(c("climvar", provs_bylat$code))

write.csv(climate_growth_table, "climate_growth_table.csv")

```


###linear models G x C
```{r}
######testing relationships between growth and climate across all trees with provenance as a random effect

all_lms<- data.frame()
for(i in 1:length(climvars)){
mod <- lmer(growth_climate_df %>% pull(rw_spline) ~ growth_climate_df %>% pull(climvars[i]) + (1|Provenance), data=growth_climate_df)
summary<- as.data.frame(summary(mod)$coefficients) 
pvalue <- summary %>% slice(2) %>% pull(`Pr(>|t|)`)
all_lms <- bind_rows(all_lms, data.frame(var=climvars[i], pvalue=pvalue))
}

all_lms %>% 
  filter(pvalue<0.05) %>% 
  pull(var) 

plantation_clim %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(year>1984&year<2016) %>% 
  ungroup() %>% 
  filter(year>1984&year<2016) %>% 
  dplyr::select(c(all_lms %>% 
  filter(pvalue<0.05) %>% 
    filter(!var %in% c("day_of_last_spring_frost","prior_day_of_last_spring_frost","day_of_first_fall_frost","prior_day_of_first_fall_frost")) %>% 
  pull(var) )) %>% 
  dplyr::select(-c("PPTsm","PPTsp","PPT_at","prior_PPTsm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean")) %>% 
  cor() %>% 
  ggcorrplot()

##getting rid of correlated variables
climcors<- plantation_clim %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(year>1984&year<2016) %>% 
  ungroup() %>% 
  filter(year>1984&year<2016) %>% 
  dplyr::select(c(all_lms %>% 
  filter(pvalue<0.05) %>% 
    filter(!var %in% c("day_of_last_spring_frost","prior_day_of_last_spring_frost","day_of_first_fall_frost","prior_day_of_first_fall_frost")) %>% 
  pull(var) )) %>% 
  dplyr::select(-c("PPTsm","PPTsp","PPT_at","prior_PPTsm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean","value_fa_tmean","value_fa_tmax","value_wt_tmean","value_wt_tmax","value_sp_tmean","value_sp_tmax","spei_sum","prior_value_fa_tmean","prior_value_fa_tmax","prior_value_wt_tmean","prior_value_wt_tmax","prior_spei_sum","prior_FDSI","value_sm_tmin","value_wt_tmin","value_sp_tmin","prior_value_fa_tmin","prior_value_wt_tmin","prior_value_sm_tmin")) %>% 
  cor() 

climcors>0.6


plantation_clim %>% 
  left_join(plantation_frost) %>% 
  filter(year > 1981 & year < 2016) %>% 
  ungroup() %>% 
  filter(year > 1981 & year < 2016) %>% 
  dplyr::select(c(all_lms %>% 
  filter(pvalue<0.05) %>% 
  pull(var))[1:25]) %>% 
  dplyr::select(-c("PPTsm","PPTsp","PPT_at")) %>% 
  cor() %>% 
  ggcorrplot()

all_lms %>% 
  filter(pvalue<0.05) %>% 
  filter(! var %in% c("PPTsm","PPTsp","PPT_at","prior_PPTsm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean"))


climmod_vars <-colnames(climcors)

climmod_cor <- lmer(log(rw_spline) ~ ppt_gs + ppt_wt + ppt  + value_fa_tmin  + vpdmax_sm + vpdmax_fa + vpdmax_wt + vpdmax_sp + aet_sum + cwd_wy + prior_ppt_gs + prior_ppt_wt   + prior_vpdmax_sm + prior_vpdmax_fa + prior_vpdmax_wt + prior_vpdmax_sp + prior_aet_sum + prior_cwd_wy + (1|Provenance), data=growth_climate_df)
plot(climmod_cor)
qqmath(climmod_cor)
summary(climmod_cor)
vif(climmod_cor)

##took out ppt here too
climmod_cor_current <- lmer(log(rw_spline) ~ ppt_gs + ppt_wt  + value_sm_tmin + value_fa_tmin + value_wt_tmin + value_sp_tmin + vpdmax_sm + vpdmax_fa + vpdmax_wt + vpdmax_sp + aet_sum + cwd_wy + (1|Provenance), data=growth_climate_df)
plot(climmod_cor_current)
qqmath(climmod_cor_current)
summary(climmod_cor_current)
vif(climmod_cor_current)

climmod_cor_prior <- lmer(log(rw_spline) ~ prior_ppt_gs + prior_ppt_wt + prior_value_sm_tmin + prior_value_fa_tmin + prior_value_wt_tmin + prior_vpdmax_sm + prior_vpdmax_fa + prior_vpdmax_wt + prior_vpdmax_sp + prior_aet_sum + prior_cwd_wy + (1|Provenance), data=growth_climate_df)
plot(climmod_cor_prior)
qqmath(climmod_cor_prior)
summary(climmod_cor_prior)
vif(climmod_cor_prior)


```

###provenance climate affect on Gx C correlation 
```{r}

##############################################

##make a big climate model

mod <- lmer(rw_spline ~ aet_sum + vpdmax_wt + prior_ppt_gs + prior_cwd_wy + prior_value_wt_tmin + prior_value_wt_tmean + (1|Provenance), data=growth_climate_df)
plot(mod)
qqmath(mod)
summary(mod) ##singular model means that provenance doesn't really matter when it comes to growth-climate correlations. 
## they're all correlated with the same things...but is the strength of the correlation weaker or stronger depending on provenance? How do I test this...

modclimprov <- lm(rw_spline ~ aet_sum*Provenance + vpdmax_wt*Provenance + prior_ppt_gs*Provenance + prior_cwd_wy*Provenance + prior_value_wt_tmin*Provenance + prior_value_wt_tmean*Provenance, data=growth_climate_df)
par(mfrow=c(2,2))
plot(modclimprov)
anova(modclimprov)

cor_provclim<- cor_clean %>%
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  dplyr::rename(Provenance = newname) %>% 
  left_join(
prov_pcapts %>% 
  dplyr::select(c(Provenance,PC1:PC2,AHM:SHM,smrpb)), by="Provenance")

cor_provclim_long <- pivot_longer(cor_provclim, PC1:smrpb)

# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
names <- unique(cor_provclim_long$name)
lmerdata <- data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(names)){
    data <- cor_provclim_long %>% filter(climvar==climvars[i] & name==names[j]) 
    mod <- lmer(cor ~ value + (1|Provenance), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    
lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvars[i], name=names[j], pvalue.lmer = pvalue.lmer)) 
  }}

lmerdata %>% filter(pvalue.lmer < 0.05)

names <- unique(cor_provclim_long$name)
lmerdata_pcs <- data.frame()
for(i in 1:length(climvars)){
    data <- cor_provclim %>% filter(climvar==climvars[i]) 
    mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=data)
    pc1pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[3,] %>% pull(`Pr(>|t|)`)
    pc1pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[4,] %>% pull(`Pr(>|t|)`)

    
lmerdata_pcs <- bind_rows(lmerdata_pcs, data.frame(climvar=climvars[i], pc1value.lmer = pc1pvalue.lmer, pc2value.lmer = pc2pvalue.lmer, pc1pc2value.lmer = pc1pc2pvalue.lmer)) 
}

lmerdata_pcs %>% 
  filter((pc1value.lmer < 0.05 | pc2value.lmer < 0.05 | pc1pc2value.lmer<0.05))

pc1_spT_mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=cor_provclim %>% filter(climvar=="prior_value_sp_tmean"))
plot(pc1_spT_mod)
qqmath(pc1_spT_mod)
summary(pc1_spT_mod) #strength of correlation with prior spring temperature increases towards hotter and drier provenances (higher PC1)

```

```{r}

annual_climvar <- lmerdata %>% filter(pvalue.lmer < 0.05) %>% filter(!climvar %in% c("value_wt_tmax","value_wt_tmin","value_sp_tmax","value_sp_tmean","prior_value_wt_tmax","prior_value_wt_tmin","prior_value_sp_tmax","prior_value_sp_tmean")) %>% pull(climvar)
prov_climvar <- lmerdata %>% filter(pvalue.lmer < 0.05) %>% filter(!climvar %in% c("value_wt_tmax","value_wt_tmin","value_sp_tmax","value_sp_tmean","prior_value_wt_tmax","prior_value_wt_tmin","prior_value_sp_tmax","prior_value_sp_tmean"))%>% pull(name)

correlation_strength_results <- data.frame()
for(i in 1:length(annual_climvar)){
    mod <- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar==annual_climvar[i] & name==prov_climvar[i]))
    mod_nog <- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar==annual_climvar[i] & name==prov_climvar[i]) %>% filter(!Provenance=="Gila NF"))
    
    correlation_strength_results <- bind_rows(correlation_strength_results, data.frame(annual_climvar = annual_climvar[i], prov_climvar = prov_climvar[i], pvalue_all = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`), pvalue_nog = as.data.frame(summary(mod_nog)$coefficients)[2,] %>% pull(`Pr(>|t|)`)))
}
correlation_strength_results %>% 
  filter(pvalue_nog<0.05)

write.csv(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), "sig_correlations.csv")

ggplot(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) , aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(annual_climvar~prov_climvar, scales="free")+
  geom_hline(yintercept=0, col="red")

##########individual model results

### WY CWD -- ppt_wt
wycwd_pptwt_mod<- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar=="cwd_wy" & name=="PPTwt") %>% filter(!Provenance=="Gila NF"))
plot(wycwd_pptwt_mod)
qqmath(wycwd_pptwt_mod)
summary(wycwd_pptwt_mod)

### First fall frost -- TD
fff_td_mod<- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar=="day_of_first_fall_frost" & name=="TD") %>% filter(!Provenance=="Gila NF"))
plot(fff_td_mod)
qqmath(fff_td_mod)
summary(fff_td_mod)

### Winter tmean -- CMD
wt_tmean_td_mod<- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar=="value_wt_tmean" & name=="CMD") %>% filter(!Provenance=="Gila NF"))
plot(wt_tmean_td_mod)
qqmath(wt_tmean_td_mod)
summary(wt_tmean_td_mod)


### Summer VPD -- MCMT
vpd_sm_td_mod<- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar=="vpdmax_sm" & name=="MCMT") %>% filter(!Provenance=="Gila NF"))
plot(vpd_sm_td_mod)
qqmath(vpd_sm_td_mod)
summary(vpd_sm_td_mod)


### Last spring frost -- bFFP
lsf_td_mod<- lmer(cor ~ value + (1|Provenance), data=cor_provclim_long %>% filter(climvar=="day_of_last_spring_frost" & name=="bFFP") %>% filter(!Provenance=="Gila NF"))
plot(lsf_td_mod)
qqmath(lsf_td_mod)
summary(lsf_td_mod)

```

```{r}
##pick 4 most representative plots to make figure

corplots4 <- ggarrange(
ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("cwd_wy") & prov_climvar=="PPTwt")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("cwd_wy") & prov_climvar=="PPTwt"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance Winter Precip (mm)")+ ylab("Correlation")+
  ggtitle("A) water year CWD X RWI")+
  theme_bw(),


ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("vpdmax_sm") & prov_climvar=="MCMT")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("vpdmax_sm") & prov_climvar=="MCMT")  , aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance MCMT (C)")+ ylab("Correlation")+
  ggtitle("B) summer max VPD x RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("vpdmax_sm") & prov_climvar=="MCMT")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("vpdmax_sm") & prov_climvar=="MCMT")  , aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance MCMT (C)")+ ylab("Correlation")+
  ggtitle("B) summer max VPD x RWI")+
  theme_bw(),
ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("value_wt_tmean") & prov_climvar=="CMD")  , aes(x=value, y=cor, col=factor(Provenance, levels= provs_bylat$Provenance)))+
  geom_smooth(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("value_wt_tmean") & prov_climvar=="CMD")  , aes(x=value, y=cor), method="lm", color="darkgrey")+
  xlab("Provenance CWD")+ ylab("Correlation")+
  ggtitle("C) winter tmean X RWI")+
  theme_bw()
# 
# ggplot()+
#     geom_hline(yintercept=0, col="black")+
#   scale_color_manual(values=unname(stepped()), name="Provenance")+
#   geom_point(data=left_join(correlation_strength_results %>% 
#   filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_sp_tmin") & prov_climvar=="PC1")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
#   geom_smooth(data=left_join(correlation_strength_results %>% 
#   filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_sp_tmin") & prov_climvar=="PC1")  , aes(x=value, y=cor), method="lm", col="darkgrey")+
#   xlab("Provenance PC1")+ ylab("Correlation")+
#   ggtitle("D) prior spring tmin x RWI")+
#   theme_bw()
, common.legend=TRUE, nrow=1)

png("figures/corplots4.png", width = 8.5, height=7.5, units="in", res=300)
corplots4
dev.off()


```

```{r}
##more plots
ggarrange(
ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("cwd_wy") & prov_climvar=="PPTwt")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("cwd_wy") & prov_climvar=="PPTwt"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance Winter Precip (mm)")+ ylab("Correlation")+
  ggtitle("A) water year CWD X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_first_fall_frost") & prov_climvar=="TD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_first_fall_frost") & prov_climvar=="TD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance TD")+ ylab("Correlation")+
  ggtitle("B) First Fall Frost Date X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("value_wt_tmean") & prov_climvar=="CMD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("value_wt_tmean") & prov_climvar=="CMD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance CMD")+ ylab("Correlation")+
  ggtitle("C) Winter Tmean X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_cwd_wy") & prov_climvar=="TD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_cwd_wy") & prov_climvar=="TD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance TD")+ ylab("Correlation")+
  ggtitle("D) Prior water year CWD X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_day_of_first_fall_frost") & prov_climvar=="TD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_day_of_first_fall_frost") & prov_climvar=="TD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance TD")+ ylab("Correlation")+
  ggtitle("E) Prior Year First Fall Frost Date X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_wt_tmean") & prov_climvar=="PAS")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_wt_tmean") & prov_climvar=="PAS"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance PAS")+ ylab("Correlation")+
  ggtitle("F) Prior Winter Tmean X RWI")+
  theme_bw(),
common.legend=TRUE, nrow=2,ncol=3)
```

```{r}
ggarrange(
  
ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_sp_tmin") & prov_climvar=="PC1")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_sp_tmin") & prov_climvar=="PC1"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance PC1")+ ylab("Correlation")+
  ggtitle("A) Prior Spring Tmin X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_sm_tmin") & prov_climvar=="RH")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_sm_tmin") & prov_climvar=="RH"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance RH")+ ylab("Correlation")+
  ggtitle("B) Prior Summer Tmin X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_wt_tmean") & prov_climvar=="PAS")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_value_wt_tmean") & prov_climvar=="PAS"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance PAS")+ ylab("Correlation")+
  ggtitle("C) Prior Winter Tmean X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_aet_sum") & prov_climvar=="EMT")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_aet_sum") & prov_climvar=="EMT"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance EMT")+ ylab("Correlation")+
  ggtitle("D) Prior Year AET X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_cwd_wy") & prov_climvar=="TD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_cwd_wy") & prov_climvar=="TD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance TD")+ ylab("Correlation")+
  ggtitle("E) Prior water year CWD X RWI")+
  theme_bw(),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_day_of_first_fall_frost") & prov_climvar=="TD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("prior_day_of_first_fall_frost") & prov_climvar=="TD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance TD")+ ylab("Correlation")+
  ggtitle("F) Prior Year First Fall Frost Date X RWI")+
  theme_bw(),

common.legend=TRUE, nrow=2,ncol=3)

```

```{r}

legend<- get_legend(ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_last_spring_frost") & prov_climvar=="bFFP")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance, labels=c(provs_bylat$Provenance[1:5],"Grand Mesa-\nUncompahgre",provs_bylat$Provenance[7:20]))))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_last_spring_frost") & prov_climvar=="bFFP"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance bFFP")+ ylab("Correlation")+
  ggtitle("E) Last Spring Frost Date X RWI")+
    guides(color=guide_legend(ncol=2))+
  theme_bw()+
    theme(legend.position = "right", legend.title.align=0.5))

ggarrange(
  ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("cwd_wy") & prov_climvar=="PPTwt")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("cwd_wy") & prov_climvar=="PPTwt"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance Winter Precip (mm)")+ ylab("Correlation")+
  ggtitle("A) Water year CWD X RWI")+
  theme_bw()+
  theme(legend.position = "none"),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_first_fall_frost") & prov_climvar=="TD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_first_fall_frost") & prov_climvar=="TD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance TD")+ ylab("Correlation")+
  ggtitle("B) First Fall Frost Date X RWI")+
  theme_bw()+
  theme(legend.position = "none"),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("value_wt_tmean") & prov_climvar=="CMD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("value_wt_tmean") & prov_climvar=="CMD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance CMD")+ ylab("Correlation")+
  ggtitle("C) Winter Tmean X RWI")+
  theme_bw()+
  theme(legend.position = "none"),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("vpdmax_sm") & prov_climvar=="MCMT")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("vpdmax_sm") & prov_climvar=="MCMT"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance MCMT")+ ylab("Correlation")+
  ggtitle("D) Summer VPD max X RWI")+
  theme_bw()+
  theme(legend.position = "none"),

ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_last_spring_frost") & prov_climvar=="bFFP")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("day_of_last_spring_frost") & prov_climvar=="bFFP"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance bFFP")+ ylab("Correlation")+
  ggtitle("E) Last Spring Frost Date X RWI")+
  theme_bw()+
  theme(legend.position = "none"),
legend, nrow=2,ncol=3)




ggplot()+
    geom_hline(yintercept=0, col="black")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("FDSI") & prov_climvar=="CMD")  , aes(x=value, y=cor, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_smooth(data= left_join(correlation_strength_results %>% 
  filter(pvalue_nog<0.05), cor_provclim_long, by=c("annual_climvar"="climvar", "prov_climvar"="name")) %>% filter(annual_climvar %in% c("FDSI") & prov_climvar=="CMD"), aes(x=value, y=cor), method="lm", col="darkgrey")+
  xlab("Provenance CMD")+ ylab("Correlation")+
  ggtitle("F) FDSI X RWI")+
  theme_bw()

```

```{r}
##plot with just bioclimate variables

##bioclim individual relationship plots
# png("figures/clim_cor_plot.png", width=6.5, height = 6, units="in", res=500)
# ggarrange(fdsi_cwd_plot, fdsi_pas_plot, aet_emt_plot, cwd_td_plot, labels=c("A)","B)","C)","D)"))
# dev.off()
```


###DBH as a predictor
```{r}
dbh_clim_data <- cor_provclim_long %>% 
  dplyr::select(-c(name,value)) %>% 
  unique() %>% 
  left_join(dbh %>% 
              mutate(tree=paste("X",Series, sep="")) %>% 
              dplyr::select(tree,DBH06,DBH14)) %>% 
  mutate(DBH_recent = case_when(is.na(DBH14) ~ DBH06,
                                .default = DBH14))

ggplot(dbh_clim_data, aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

dbhmods = data.frame()
for(i in 1:length(climvars)){
mod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar==climvars[i]))
dbhmods <- bind_rows(dbhmods, data.frame(climvar = climvars[i], pvalue = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)))}

dbhmods %>% filter(pvalue < 0.05)

##DBH x prior FDSI
DBH_priorFDSImod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_FDSI"))
plot(DBH_priorFDSImod)
qqmath(DBH_priorFDSImod)
summary(DBH_priorFDSImod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_FDSI"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior vpdmax_sm
DBH_priorvpdmaxmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_vpdmax_sm"))
plot(DBH_priorvpdmaxmod)
qqmath(DBH_priorvpdmaxmod)
summary(DBH_priorvpdmaxmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_vpdmax_sm"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior_value_sp_tmin 
DBH_prior_value_sp_tminmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_value_sp_tmin"))
plot(DBH_prior_value_sp_tminmod)
qqmath(DBH_prior_value_sp_tminmod)
summary(DBH_prior_value_sp_tminmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_value_sp_tmin"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior_value_sp_tmean 
DBH_prior_value_sp_tmeanmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_value_sp_tmean"))
plot(DBH_prior_value_sp_tmeanmod)
qqmath(DBH_prior_value_sp_tmeanmod)
summary(DBH_prior_value_sp_tmeanmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_value_sp_tmean"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior ppt wt
DBH_prior_ppt_wtmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_ppt_wt"))
plot(DBH_prior_ppt_wtmod)
qqmath(DBH_prior_ppt_wtmod)
summary(DBH_prior_ppt_wtmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_ppt_wt"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior ppt at
DBH_prior_PPT_atmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_PPT_at"))
plot(DBH_prior_PPT_atmod)
qqmath(DBH_prior_PPT_atmod)
summary(DBH_prior_PPT_atmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_PPT_at"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x ppt sm
DBH_PPTsmmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="PPTsm"))
plot(DBH_PPTsmmod)
qqmath(DBH_PPTsmmod)
summary(DBH_PPTsmmod)

ggplot(dbh_clim_data %>% filter(climvar=="PPTsm"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x ppt at
DBH_PPT_atmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="PPT_at"))
plot(DBH_PPT_atmod)
qqmath(DBH_PPT_atmod)
summary(DBH_PPT_atmod)

ggplot(dbh_clim_data %>% filter(climvar=="PPT_at"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

```


#extra


####Southern Region

#####height

Absolute Height 

```{r}
##Look at just southern Rockies, excluding Gila
ht_SR_long <- ht_data_year_clim_long_noG %>% filter(y < 44)

ht_SR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

ht_SR_mods <- bind_rows(ht_SR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

ht_SR_mods %>% arrange(pvalue) ##TD, RH, & smrpb are significant

##TD
ht_TD_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_SR_long %>% filter(climvar.name=="TD"))
plot(ht_TD_mod)
qqmath(ht_TD_mod)
summary(ht_TD_mod)

####make plot 
SR_TD_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_SR_long %>% filter(climvar.name=="TD"))

newdata_SR_TD_ht <-  expand.grid(climvar.value=seq(min(ht_SR_long %>% filter(climvar.name=="TD") %>% pull(climvar.value)), max(ht_SR_long %>% filter(climvar.name=="TD") %>% pull(climvar.value)),length.out=50))
SR_TD_ht_predict <- predict(SR_TD_ht_mod_lm, newdata = newdata_SR_TD_ht, interval="confidence")

predictdata_TD_ht <- cbind(newdata_SR_TD_ht, SR_TD_ht_predict) %>% mutate(var="TD")

SR_TD_ht_plot <- ggplot()+
  geom_ribbon(data=predictdata_TD_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_TD_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_SR_long %>% filter(climvar.name=="TD")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance TD")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
SR_TD_ht_plot

##RH
ht_RH_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_SR_long %>% filter(climvar.name=="RH"))
plot(ht_RH_mod)
qqmath(ht_RH_mod)
summary(ht_RH_mod)

####make plot 
SR_RH_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_SR_long %>% filter(climvar.name=="RH"))

newdata_SR_RH_ht <-  expand.grid(climvar.value=seq(min(ht_SR_long %>% filter(climvar.name=="RH") %>% pull(climvar.value)), max(ht_SR_long %>% filter(climvar.name=="RH") %>% pull(climvar.value)), length.out=50))
SR_RH_ht_predict <- predict(SR_RH_ht_mod_lm, newdata = newdata_SR_RH_ht, interval="confidence")

predicRHata_RH_ht <- cbind(newdata_SR_RH_ht, SR_RH_ht_predict) %>% mutate(var="RH")

SR_RH_ht_plot <- ggplot()+
  geom_ribbon(data=predicRHata_RH_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicRHata_RH_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_SR_long %>% filter(climvar.name=="RH")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance RH")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
SR_RH_ht_plot

##smrpb
ht_smrpb_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_SR_long %>% filter(climvar.name=="smrpb"))
plot(ht_smrpb_mod)
qqmath(ht_smrpb_mod)
summary(ht_smrpb_mod)

####make plot 
SR_smrpb_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_SR_long %>% filter(climvar.name=="smrpb"))

newdata_SR_smrpb_ht <-  expand.grid(climvar.value=seq(min(ht_SR_long %>% filter(climvar.name=="smrpb") %>% pull(climvar.value)), max(ht_SR_long %>% filter(climvar.name=="smrpb") %>% pull(climvar.value)), length.out=50))
SR_smrpb_ht_predict <- predict(SR_smrpb_ht_mod_lm, newdata = newdata_SR_smrpb_ht, interval="confidence")

predicsmrpbata_smrpb_ht <- cbind(newdata_SR_smrpb_ht, SR_smrpb_ht_predict) %>% mutate(var="smrpb")

SR_smrpb_ht_plot <- ggplot()+
  geom_ribbon(data=predicsmrpbata_smrpb_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicsmrpbata_smrpb_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_SR_long %>% filter(climvar.name=="smrpb")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance smrpb")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
SR_smrpb_ht_plot


##all plot
SR_absht_linear_mods_df<- bind_rows(predicsmrpbata_smrpb_ht,predicRHata_RH_ht,predictdata_TD_ht)

SR_absht_linear_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(SR_absht_linear_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(SR_absht_linear_mods_df$var)), aes(x=value, y=1, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=SR_absht_linear_mods_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=SR_absht_linear_mods_df, aes(x=climvar.value,y=fit))+
  geom_rug(data=ht_SR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=1)%>% filter(var %in% unique(SR_absht_linear_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Log(Height (m))")+
  ggtitle("Southern Region without Gila NF")+
  facet_wrap(~factor(var, levels=c("RH","TD","smrpb")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
SR_absht_linear_mod_plot


###quadratic

ht_SR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

ht_SR_mods_quad <- bind_rows(ht_SR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

ht_SR_mods_quad %>% arrange(pvalue2) #MAP & winter ppt have significant quadratic effect

##MAP
SR_htmap_quad <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_SR_long %>% filter(climvar.name=="MAP"))
plot(SR_htmap_quad)
qqmath(SR_htmap_quad)
summary(SR_htmap_quad)

SR_htmap_quad_lm <- lm(log(value) ~ climvar.value + I(climvar.value^2), data=ht_SR_long %>% filter(climvar.name=="MAP"))
newdata_SR_htmap <- with(ht_SR_long %>% filter(climvar.name=="MAP"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

SR_htmap_predict <- predict(SR_htmap_quad_lm, newdata = newdata_SR_htmap, interval="confidence")

predictdata_SR_htmap <- cbind(newdata_SR_htmap, SR_htmap_predict)

SR_MAP_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_htmap, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_htmap, aes(x=climvar.value,y=fit), color="black")+
  xlab("MAP")+
  ylab("Log(Height (m))")+
  geom_rug(data=ht_SR_long %>% filter(climvar.name=="MAP")%>% mutate(fit=.5), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_MAP_plot

##PPTwt
SR_ht_PPTwt_quad <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK)+(1|year), data=ht_SR_long %>% filter(climvar.name=="PPTwt"))
plot(SR_ht_PPTwt_quad)
qqmath(SR_ht_PPTwt_quad)
summary(SR_ht_PPTwt_quad)

SR_ht_PPTwt_quad_lm <- lm(log(value) ~ climvar.value + I(climvar.value^2), data=ht_SR_long %>% filter(climvar.name=="PPTwt"))
newdata_SR_ht_PPTwt <- with(ht_SR_long %>% filter(climvar.name=="PPTwt"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

SR_ht_PPTwt_predict <- predict(SR_ht_PPTwt_quad_lm, newdata = newdata_SR_ht_PPTwt, interval="confidence")

predictdata_SR_ht_PPTwt <- cbind(newdata_SR_ht_PPTwt, SR_ht_PPTwt_predict)

SR_PPTwt_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_ht_PPTwt, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_ht_PPTwt, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_SR_long %>% filter(climvar.name=="PPTwt")%>% mutate(fit=3), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("PPTwt")+
  ylab("log(Height)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()
SR_PPTwt_plot

##all plot
###PPTwt and MAP are highly correlated, just show winter precip
SR_absht_all_mods_df<- bind_rows(predictdata_SR_ht_PPTwt %>% mutate(var="PPTwt"),SR_absht_linear_mods_df)

SR_absht_all_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(SR_absht_all_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(SR_absht_all_mods_df$var)), aes(x=value, y=1, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=SR_absht_all_mods_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=SR_absht_all_mods_df, aes(x=climvar.value,y=fit))+
  geom_rug(data=ht_SR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=1)%>% filter(var %in% unique(SR_absht_all_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Log(Height (m))")+
  ggtitle("Southern Region without Gila NF")+
  facet_wrap(~factor(var, levels=c("RH","TD","smrpb","PPTwt")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
SR_absht_all_mod_plot

```

######relative height


```{r}
##Look at just southern Rockies, excluding Gila
relht_SR_long <- ht_growth_rel_clim_long %>% filter(y < 44 & y > 33)
  
relht_SR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=relht_SR_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

relht_SR_mods <- bind_rows(relht_SR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

relht_SR_mods %>% arrange(pvalue) ##nothing significant

###quadratic

relht_SR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_SR_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

relht_SR_mods_quad <- bind_rows(relht_SR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

relht_SR_mods_quad %>% arrange(pvalue2) #DD0, DD18, MAT, Tavewt are significant

cor(prov_clim_adjusted_bi %>% dplyr::select(c("AHM":"SHM","smrpb","monsoonality")))

##MAT
SR_relhtMAT_quad <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_SR_long %>% filter(name=="MAT"))
plot(SR_relhtMAT_quad)
qqmath(SR_relhtMAT_quad)
summary(SR_relhtMAT_quad)

SR_relhtMAT_quad_lm <- lm(relht ~ value + I(value^2), data=relht_SR_long %>% filter(name=="MAT"))
newdata_SR_relhtMAT <- with(relht_SR_long %>% filter(name=="MAT"), data.frame(value=seq(min(value),max(value),length.out=100)))

SR_relhtMAT_predict <- predict(SR_relhtMAT_quad_lm, newdata = newdata_SR_relhtMAT, interval="confidence")

predictdata_SR_relhtMAT <- cbind(newdata_SR_relhtMAT, SR_relhtMAT_predict)

SR_MAT_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_relhtMAT, aes(x=value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_relhtMAT, aes(x=value,y=fit), color="black")+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var == "MAT"), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var=="MAT"), aes(x=value, y=12.5, label="plantation"), col="steelblue", size=3)+
  xlab("MAT")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_SR_long %>% filter(name=="MAT")%>% mutate(fit=10), aes(x=value,y=fit,col=Provenance), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-1])+
  ggtitle("Southern Region without Gila NF")+
  facet_wrap(~var)+
  theme_bw()
SR_MAT_plot

```

######pca models

Absolute Height

```{r}
SR_ht_data_year_clim<- ht_data_year_clim %>% 
  filter(y < 44 & y > 33)

###try year as a random effect
#y
SR_mod_ht_pca_y_randtime <- lmer(log(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=SR_ht_data_year_clim)
plot(SR_mod_ht_pca_y_randtime)
qqmath(SR_mod_ht_pca_y_randtime)
summary(SR_mod_ht_pca_y_randtime)
SR_mod_ht_pca_y_randtime_dredge<- dredge(SR_mod_ht_pca_y_randtime)
SR_mod_ht_pca_y_randtime_dredge

bestSR_mod_ht_pca_y_randtime <- lmer(value ~ y + (1|Provenance) + (1|BLK) + (1|year), data=SR_ht_data_year_clim)
summary(bestSR_mod_ht_pca_y_randtime) #negative effect of latitude

#x
SR_mod_ht_pca_x_randtime <- lmer(log(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=SR_ht_data_year_clim)
plot(SR_mod_ht_pca_x_randtime)
qqmath(SR_mod_ht_pca_x_randtime)
summary(SR_mod_ht_pca_x_randtime)
SR_mod_ht_pca_x_randtime_dredge<- dredge(SR_mod_ht_pca_x_randtime)
SR_mod_ht_pca_x_randtime_dredge ##best is null 

bestSR_mod_ht_pca_x_randtime <- lmer(log(value) ~ (1|Provenance) + (1|BLK) + (1|year), data=SR_ht_data_year_clim)
summary(bestSR_mod_ht_pca_x_randtime)

AICc(bestSR_mod_ht_pca_x_randtime,bestSR_mod_ht_pca_y_randtime) ##null is best

```

Relative Height Growth

```{r}
##PC x latitude analysis
ht_growth_rel_clim_SR <- ht_growth_rel_clim %>% 
  filter(y < 44 & y > 33)
#y
SR_mod_relht_pca_y_randtime <- lmer(value ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_SR)
plot(SR_mod_relht_pca_y_randtime)
qqmath(SR_mod_relht_pca_y_randtime)
summary(SR_mod_relht_pca_y_randtime)
SR_mod_relht_pca_y_randtime_dredge<- dredge(SR_mod_relht_pca_y_randtime)
SR_mod_relht_pca_y_randtime_dredge ##null model is best

bestSR_mod_relht_pca_y_randtime <- lmer(value ~ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_SR)
summary(bestSR_mod_relht_pca_y_randtime)

#x
SR_mod_relht_pca_x_randtime <- lmer(value ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_SR)
plot(SR_mod_relht_pca_x_randtime)
qqmath(SR_mod_relht_pca_x_randtime)
summary(SR_mod_relht_pca_x_randtime)
SR_mod_relht_pca_x_randtime_dredge<- dredge(SR_mod_relht_pca_x_randtime)
SR_mod_relht_pca_x_randtime_dredge ##null model is best

bestSR_mod_relht_pca_x_randtime <- lmer(value ~  (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_SR)
summary(bestSR_mod_relht_pca_x_randtime)

##southern region relative growth not well explained by PC1, PC2, latitude or longitude. 


```


#####dbh
```{r}
##Look at just southern Rockies, excluding Gila
dbh_SR <- dbh_numeric_time %>% filter(y < 44 & y > 33)
  
dbh_SR_long <- dbh_SR %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

dbh_SR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK), data=dbh_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

dbh_SR_mods <- bind_rows(dbh_SR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))
}

dbh_SR_mods %>% arrange(pvalue) ##RH, TD, and smrpb significant

##RH
SR_dbhRH <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=dbh_SR_long %>% filter(climvar.name=="RH"))
plot(SR_dbhRH)
qqmath(SR_dbhRH)
summary(SR_dbhRH)

SR_dbhRH_lm <- lm(DBH ~ climvar.value, data=dbh_SR_long %>% filter(climvar.name=="RH"))
newdata_SR_dbhRH <- with(dbh_SR_long %>% filter(climvar.name=="RH"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

SR_dbhRH_predict <- predict(SR_dbhRH_lm, newdata = newdata_SR_dbhRH, interval="confidence")

predictdata_SR_dbhRH <- cbind(newdata_SR_dbhRH, SR_dbhRH_predict) %>% mutate(var="RH")

SR_RH_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_dbhRH, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_dbhRH, aes(x=climvar.value,y=fit), color="black")+
  xlab("RH")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_SR_long %>% filter(climvar.name=="RH")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_RH_plot

##TD
SR_dbhTD <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=dbh_SR_long %>% filter(climvar.name=="TD"))
plot(SR_dbhTD)
qqmath(SR_dbhTD)
summary(SR_dbhTD)

SR_dbhTD_lm <- lm(DBH ~ climvar.value, data=dbh_SR_long %>% filter(climvar.name=="TD"))
newdata_SR_dbhTD <- with(dbh_SR_long %>% filter(climvar.name=="TD"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

SR_dbhTD_predict <- predict(SR_dbhTD_lm, newdata = newdata_SR_dbhTD, interval="confidence")

predictdata_SR_dbhTD <- cbind(newdata_SR_dbhTD, SR_dbhTD_predict) %>% mutate(var="TD")

SR_TD_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_dbhTD, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_dbhTD, aes(x=climvar.value,y=fit), color="black")+
  xlab("TD")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_SR_long %>% filter(climvar.name=="TD")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_TD_plot

##smrpb
SR_dbhsmrpb <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=dbh_SR_long %>% filter(climvar.name=="smrpb"))
plot(SR_dbhsmrpb)
qqmath(SR_dbhsmrpb)
summary(SR_dbhsmrpb)

SR_dbhsmrpb_lm <- lm(DBH ~ climvar.value, data=dbh_SR_long %>% filter(climvar.name=="smrpb"))
newdata_SR_dbhsmrpb <- with(dbh_SR_long %>% filter(climvar.name=="smrpb"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

SR_dbhsmrpb_predict <- predict(SR_dbhsmrpb_lm, newdata = newdata_SR_dbhsmrpb, interval="confidence")

predictdata_SR_dbhsmrpb <- cbind(newdata_SR_dbhsmrpb, SR_dbhsmrpb_predict) %>% mutate(var="smrpb")

SR_smrpb_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_dbhsmrpb, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_dbhsmrpb, aes(x=climvar.value,y=fit), color="black")+
  xlab("smrpb")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_SR_long %>% filter(climvar.name=="smrpb")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_smrpb_plot

###quadratic

dbh_SR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=dbh_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_SR_mods_quad <- bind_rows(dbh_SR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

dbh_SR_mods_quad %>% arrange(pvalue2) #PPTwt significant

##PPTwt
pptwt_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=dbh_SR_long %>% filter(climvar.name=="PPTwt"))
plot(pptwt_dbh_quad)
qqmath(pptwt_dbh_quad)
summary(pptwt_dbh_quad)


pptwt_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_SR_long %>% filter(climvar.name=="PPTwt"))
newdata_dbh_pptwt <- with(dbh_SR_long %>% filter(climvar.name=="PPTwt"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_pptwt_predict <- predict(pptwt_dbh_quad_lm, newdata = newdata_dbh_pptwt, interval="confidence")

predictdata_dbh_pptwt <- cbind(newdata_dbh_pptwt, dbh_pptwt_predict) %>% mutate(var="PPTwt")

SR_PPTwt_plot<- ggplot()+
  geom_ribbon(data=predictdata_dbh_pptwt, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_pptwt, aes(x=climvar.value,y=fit), color="black")+
  xlab("PPTwt")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_SR_long %>% filter(climvar.name=="PPTwt")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_PPTwt_plot


##all plot
SR_absdbh_all_mods_df<- bind_rows(predictdata_dbh_pptwt,predictdata_SR_dbhsmrpb,predictdata_SR_dbhTD,predictdata_SR_dbhRH)

SR_absdbh_all_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(SR_absdbh_all_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(SR_absdbh_all_mods_df$var)), aes(x=value, y=10.5, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=SR_absdbh_all_mods_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=SR_absdbh_all_mods_df, aes(x=climvar.value,y=fit))+
  geom_rug(data=dbh_SR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=10)%>% filter(var %in% unique(SR_absdbh_all_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("DBH (cm)")+
  ggtitle("Southern Region without Gila NF")+
  facet_wrap(~factor(var, levels=c("RH","TD","smrpb","PPTwt")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
SR_absdbh_all_mod_plot


```

######basal area growth

```{r}
SR_dbh_growth_clim_long <- dbh_growth_clim_long %>% filter(y < 44 & y > 33)

SR_reldbh_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relDBH) ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=SR_dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

SR_reldbh_mods <- bind_rows(SR_reldbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

SR_reldbh_mods %>% arrange(pvalue) #RH and TD significant


##RH
SR_reldbhRH <- lmer(sqrt(relDBH) ~ value + (1|Provenance) + (1|BLK) + (1|year), data=SR_dbh_growth_clim_long %>% filter(name=="RH"))
plot(SR_reldbhRH)
qqmath(SR_reldbhRH)
summary(SR_reldbhRH)

SR_reldbhRH_lm <- lm(sqrt(relDBH) ~ value, data=SR_dbh_growth_clim_long %>% filter(name=="RH"))
newdata_SR_reldbhRH <- with(SR_dbh_growth_clim_long %>% filter(name=="RH"), data.frame(value=seq(min(value),max(value),length.out=100)))

SR_reldbhRH_predict <- predict(SR_reldbhRH_lm, newdata = newdata_SR_reldbhRH, interval="confidence")

predictdata_SR_reldbhRH <- cbind(newdata_SR_reldbhRH, SR_reldbhRH_predict) %>% mutate(var="RH")

SR_RH_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_reldbhRH, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_reldbhRH, aes(x=value,y=fit^2), color="black")+
  xlab("RH")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=SR_dbh_growth_clim_long %>% filter(name=="RH")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_RH_plot


##TD
SR_reldbhTD <- lmer(sqrt(relDBH) ~ value + (1|Provenance) + (1|BLK) + (1|year), data=SR_dbh_growth_clim_long %>% filter(name=="TD"))
plot(SR_reldbhTD)
qqmath(SR_reldbhTD)
summary(SR_reldbhTD)

SR_reldbhTD_lm <- lm(sqrt(relDBH) ~ value, data=SR_dbh_growth_clim_long %>% filter(name=="TD"))
newdata_SR_reldbhTD <- with(SR_dbh_growth_clim_long %>% filter(name=="TD"), data.frame(value=seq(min(value),max(value),length.out=100)))

SR_reldbhTD_predict <- predict(SR_reldbhTD_lm, newdata = newdata_SR_reldbhTD, interval="confidence")

predictdata_SR_reldbhTD <- cbind(newdata_SR_reldbhTD, SR_reldbhTD_predict) %>% mutate(var="TD")

SR_TD_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_reldbhTD, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_reldbhTD, aes(x=value,y=fit^2), color="black")+
  xlab("TD")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=SR_dbh_growth_clim_long %>% filter(name=="TD")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_TD_plot


###quadratic

SR_reldbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relDBH) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=SR_dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

SR_reldbh_mods_quad <- bind_rows(SR_reldbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

SR_reldbh_mods_quad %>% arrange(pvalue2) #PPTwt significant

##PPTwt
SR_reldbhPPTwt <- lmer(sqrt(relDBH) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=SR_dbh_growth_clim_long %>% filter(name=="PPTwt"))
plot(SR_reldbhPPTwt)
qqmath(SR_reldbhPPTwt)
summary(SR_reldbhPPTwt)

SR_reldbhPPTwt_lm <- lm(sqrt(relDBH) ~ value + I(value^2), data=SR_dbh_growth_clim_long %>% filter(name=="PPTwt"))
newdata_SR_reldbhPPTwt <- with(SR_dbh_growth_clim_long %>% filter(name=="PPTwt"), data.frame(value=seq(min(value),max(value),length.out=100)))

SR_reldbhPPTwt_predict <- predict(SR_reldbhPPTwt_lm, newdata = newdata_SR_reldbhPPTwt, interval="confidence")

predictdata_SR_reldbhPPTwt <- cbind(newdata_SR_reldbhPPTwt, SR_reldbhPPTwt_predict) %>% mutate(var="PPTwt")

SR_PPTwt_plot<- ggplot()+
  geom_ribbon(data=predictdata_SR_reldbhPPTwt, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_SR_reldbhPPTwt, aes(x=value,y=fit^2), color="black")+
  xlab("PPTwt")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=SR_dbh_growth_clim_long %>% filter(name=="PPTwt")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
SR_PPTwt_plot

##all plot
SR_reldbh_all_mods_df<- bind_rows(predictdata_SR_reldbhPPTwt,predictdata_SR_reldbhRH,predictdata_SR_reldbhTD)

SR_reldbh_all_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(SR_reldbh_all_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(SR_reldbh_all_mods_df$var)), aes(x=value, y=3, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=SR_reldbh_all_mods_df, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=SR_reldbh_all_mods_df, aes(x=value,y=fit))+
  geom_rug(data=dbh_SR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=2)%>% filter(var %in% unique(SR_reldbh_all_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Sqrt(Basal Area Growth Rate (cm^2/year))")+
  ggtitle("Southern Region without Gila NF")+
  facet_wrap(~factor(var, levels=c("RH","TD","PPTwt")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
SR_reldbh_all_mod_plot

```

#####survival
```{r}
SR_moniger_survival_long <- moniger_survival_long %>% filter(y < 44 & y > 33)

SR_surv_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- as.data.frame(summary(mod)$coefficients$cond)[2,]$`Pr(>|z|)`

SR_surv_mods <- bind_rows(SR_surv_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))}

SR_surv_mods %>% arrange(pvalue) ##eFFP and MSP significant

#eFFP
SR_surv_eFFP_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name=="eFFP"), family="binomial")
summary(SR_surv_eFFP_mod)

SR_surv_eFFP_data <- SR_moniger_survival_long %>% filter(climvar.name=="eFFP")

SR_newdata_eFFP_surv <- data.frame(
    climvar.value = seq(min(SR_surv_eFFP_data$climvar.value), 
                      max(SR_surv_eFFP_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
SR_surv_eFFP_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=SR_moniger_survival_long %>% filter(climvar.name=="eFFP"), family="binomial")

SR_surveFFP_newdata1 <-  expand.grid(climvar.value = seq(min(SR_newdata_eFFP_surv$climvar.value),max(SR_newdata_eFFP_surv$climvar.value),length.out=50))

SR_surveFFP_newdata2 <- cbind(SR_surveFFP_newdata1, predict(SR_surv_eFFP_mod_glm, newdata = SR_surveFFP_newdata1, type = "link", se=TRUE))

SR_surveFFP_newdata3 <- within(SR_surveFFP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

SR_effp_surv_plot<- ggplot(SR_surveFFP_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y<44 & y>33) %>% rename(climvar.value=eFFP) %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance eFFP")+
  ylab("Survival Probability")+
  theme_bw()

#MSP
SR_surv_MSP_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name=="MSP"), family="binomial")
summary(SR_surv_MSP_mod)

SR_surv_MSP_data <- SR_moniger_survival_long %>% filter(climvar.name=="MSP")

SR_newdata_MSP_surv <- data.frame(
    climvar.value = seq(min(SR_surv_MSP_data$climvar.value), 
                      max(SR_surv_MSP_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
SR_survMSP_newdata1 <-  expand.grid(climvar.value = seq(min(SR_newdata_MSP_surv$climvar.value),max(SR_newdata_MSP_surv$climvar.value),length.out=50))

SR_surv_MSP_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=SR_moniger_survival_long %>% filter(climvar.name=="MSP"), family="binomial")

SR_survMSP_newdata2 <- cbind(SR_survMSP_newdata1, predict(SR_surv_MSP_mod_glm, newdata = SR_survMSP_newdata1, type = "link", se=TRUE))
SR_survMSP_newdata3 <- within(SR_survMSP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

SR_MSP_surv_plot<- ggplot(SR_survMSP_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y<44 & y>33) %>% rename(climvar.value=MSP) %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance MSP")+
  ylab("Survival Probability")+
  theme_bw()
SR_MSP_surv_plot


###quadratic

SR_surv_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`

SR_surv_mods_quad <- bind_rows(SR_surv_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

SR_surv_mods_quad %>% arrange(pvalue2) ##MCMT, Eref, and CMD are significant both with and without Gila

##MSP
SRsurv_MSP_mod_quad <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name=="MSP"), family="binomial")
summary(SRsurv_MSP_mod_quad)

##predictions
SR_surv_MSP_mod_glm_quad <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=SR_moniger_survival_long %>% filter(climvar.name=="MSP"), family="binomial")

SR_survMSP_newdata2_quad <- cbind(SR_survMSP_newdata1, predict(SR_surv_MSP_mod_glm_quad, newdata = SR_survMSP_newdata1, type = "link", se=TRUE))
SR_survMSP_newdata3_quad <- within(SR_survMSP_newdata2_quad, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})


SR_survMSP_quad_plot<- ggplot(SR_survMSP_newdata3_quad, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y<44 & y>33) %>% rename(climvar.value=MSP) %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance MSP")+
  ylab("Survival Probability")+
  theme_bw()


##AHM
SRsurv_AHM_mod_quad <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name=="AHM"), family="binomial")
summary(SRsurv_AHM_mod_quad)

SR_surv_AHM_data <- SR_moniger_survival_long %>% filter(climvar.name=="AHM")

##predictions
SR_survAHM_newdata1 <-  expand.grid(climvar.value = seq(min(SR_surv_AHM_data$climvar.value),max(SR_surv_AHM_data$climvar.value),length.out=50))

SR_surv_AHM_mod_glm_quad <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=SR_moniger_survival_long %>% filter(climvar.name=="AHM"), family="binomial")

SR_survAHM_newdata2_quad <- cbind(SR_survAHM_newdata1, predict(SR_surv_AHM_mod_glm_quad, newdata = SR_survAHM_newdata1, type = "link", se=TRUE))
SR_survAHM_newdata3_quad <- within(SR_survAHM_newdata2_quad, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})


SR_survAHM_quad_plot<- ggplot(SR_survAHM_newdata3_quad, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y<44 & y>33) %>% rename(climvar.value=AHM) %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance AHM")+
  ylab("Survival Probability")+
  theme_bw()
SR_survAHM_quad_plot


##MAT
SRsurv_MAT_mod_quad <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=SR_moniger_survival_long %>% filter(climvar.name=="MAT"), family="binomial")
summary(SRsurv_MAT_mod_quad)

SR_surv_MAT_data <- SR_moniger_survival_long %>% filter(climvar.name=="MAT")

##predictions
SR_survMAT_newdata1 <-  expand.grid(climvar.value = seq(min(SR_surv_MAT_data$climvar.value),max(SR_surv_MAT_data$climvar.value),length.out=50))

SR_surv_MAT_mod_glm_quad <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=SR_moniger_survival_long %>% filter(climvar.name=="MAT"), family="binomial")

SR_survMAT_newdata2_quad <- cbind(SR_survMAT_newdata1, predict(SR_surv_MAT_mod_glm_quad, newdata = SR_survMAT_newdata1, type = "link", se=TRUE))
SR_survMAT_newdata3_quad <- within(SR_survMAT_newdata2_quad, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})


SR_survMAT_quad_plot<- ggplot(SR_survMAT_newdata3_quad, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y<44 & y>33) %>% rename(climvar.value=MAT) %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance MAT")+
  ylab("Survival Probability")+
  theme_bw()
SR_survMAT_quad_plot


SR_surv_results<- bind_rows(SR_survMSP_newdata3_quad %>% mutate(climvar.name="MSP"),
          SR_survAHM_newdata3_quad %>% mutate(climvar.name="AHM"),
          SR_survMAT_newdata3_quad %>% mutate(climvar.name="MAT"),
          SR_surveFFP_newdata3 %>% mutate(climvar.name="eFFP"))

SR_surv_all_plot <- ggplot(SR_surv_results, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,ymax = UL), alpha = 0.2) +
    geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(climvar.name=name)%>% filter(climvar.name %in% unique(SR_surv_results$climvar.name)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(climvar.name=name)%>% filter(climvar.name %in% unique(SR_surv_results$climvar.name)), aes(x=value, y=.7, label="plantation"), col="steelblue", size=3)+
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y<44 & y>33) %>% dplyr::select(c("Provenance","MSP","AHM","MAT","eFFP")) %>% pivot_longer(MSP:eFFP, names_to="climvar.name", values_to="climvar.value") %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("Provenance climate")+
  ylab("Survival Probability")+
  ggtitle("Southern Region excluding Gila NF")+
   facet_wrap(~climvar.name, scales="free")+
  theme_bw()

SR_surv_all_plot
```


#####provenance climate affect on Gx C correlation 
```{r}

##############################################

cor_provclim_SR<- cor_clean %>%
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  dplyr::rename(Provenance = newname) %>% 
  left_join(
prov_pcapts %>% 
  dplyr::select(c(Provenance,y,PC1:PC2,AHM:SHM,smrpb)), by="Provenance") %>% 
  filter(y> 33 & y <44)

cor_provclim_long_SR <- pivot_longer(cor_provclim_SR, PC1:smrpb)

# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
names <- unique(cor_provclim_long_SR$name)
lmerdata_SR <- data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(names)){
    data <- cor_provclim_long_SR %>% filter(climvar==climvars[i] & name==names[j]) 
    mod <- lmer(cor ~ value + (1|Provenance), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    
lmerdata_SR <- bind_rows(lmerdata_SR, data.frame(climvar=climvars[i], name=names[j], pvalue.lmer = pvalue.lmer)) 
  }}

lmerdata_SR %>% filter(pvalue.lmer < 0.05)

names <- unique(cor_provclim_long_SR$name)
lmerdata_pcs_SR <- data.frame()
for(i in 1:length(climvars)){
    data <- cor_provclim_SR %>% filter(climvar==climvars[i]) 
    mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=data)
    pc1pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[3,] %>% pull(`Pr(>|t|)`)
    pc1pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[4,] %>% pull(`Pr(>|t|)`)

    
lmerdata_pcs_SR <- bind_rows(lmerdata_pcs_SR, data.frame(climvar=climvars[i], pc1value.lmer = pc1pvalue.lmer, pc2value.lmer = pc2pvalue.lmer, pc1pc2value.lmer = pc1pc2pvalue.lmer)) 
}

lmerdata_pcs_SR %>% 
  filter((pc1value.lmer < 0.05 | pc2value.lmer < 0.05 | pc1pc2value.lmer<0.05))

pc1_spT_mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=cor_provclim_SR %>% filter(climvar=="prior_value_sp_tmean"))
plot(pc1_spT_mod)
qqmath(pc1_spT_mod)
summary(pc1_spT_mod) #strength of correlation with prior spring temperature increases towards hotter and drier provenances (higher PC1)

```

```{r}
#current year plantation climate
SR_cyear_trends<- ggplot(data=left_join(lmerdata_SR %>% filter(pvalue.lmer < 0.05), cor_provclim_long_SR, by=c("climvar","name")) %>% filter(!str_detect(climvar, "prior")) , aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  ggtitle("Southern Region")

#prior year plantation climate
SR_pyear_trends<- ggplot(data=left_join(lmerdata_SR %>% filter(pvalue.lmer < 0.05), cor_provclim_long_SR, by=c("climvar","name"))%>% filter(str_detect(climvar, "prior")) , aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  ggtitle("Southern Region")

pdf("figures/SR_cyear_trends.pdf", width=11, height=8.5)
SR_cyear_trends
dev.off()

pdf("figures/SR_pyear_trends.pdf", width=11, height=8.5)
SR_pyear_trends
dev.off()
##########individual model results
```

####Northern Region

```{r}
##Look at just northern Rockies, excluding Gila
ht_NR_long <- ht_data_year_clim_long_noG %>% filter(y > 44)

ht_NR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

ht_NR_mods <- bind_rows(ht_NR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

ht_NR_mods %>% arrange(pvalue) ##a bunch are significant, but not the 3 that were significant for the southern region.Let's look at NFFD, SHM, CMD, and PPTsm 

##SHM
NR_ht_SHM_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name=="SHM"))
plot(NR_ht_SHM_mod)
qqmath(NR_ht_SHM_mod)
summary(NR_ht_SHM_mod)

####make plot 
NR_SHM_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_NR_long %>% filter(climvar.name=="SHM"))

newdata_NR_SHM_ht <-  expand.grid(climvar.value=seq(min(ht_NR_long %>% filter(climvar.name=="SHM") %>% pull(climvar.value)), max(ht_NR_long %>% filter(climvar.name=="SHM") %>% pull(climvar.value)), length.out=50))
NR_SHM_ht_predict <- predict(NR_SHM_ht_mod_lm, newdata = newdata_NR_SHM_ht, interval="confidence")

predicSHMata_SHM_ht <- cbind(newdata_NR_SHM_ht, NR_SHM_ht_predict) %>% mutate(var="SHM")

NR_SHM_ht_plot <- ggplot()+
  geom_ribbon(data=predicSHMata_SHM_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicSHMata_SHM_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name=="SHM")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance SHM")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_SHM_ht_plot

##CMD
NR_ht_CMD_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name=="CMD"))
plot(NR_ht_CMD_mod)
qqmath(NR_ht_CMD_mod)
summary(NR_ht_CMD_mod)

####make plot 
NR_CMD_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_NR_long %>% filter(climvar.name=="CMD"))

newdata_NR_CMD_ht <-  expand.grid(climvar.value=seq(min(ht_NR_long %>% filter(climvar.name=="CMD") %>% pull(climvar.value)), max(ht_NR_long %>% filter(climvar.name=="CMD") %>% pull(climvar.value)), length.out=50))
NR_CMD_ht_predict <- predict(NR_CMD_ht_mod_lm, newdata = newdata_NR_CMD_ht, interval="confidence")

predicCMData_CMD_ht <- cbind(newdata_NR_CMD_ht, NR_CMD_ht_predict) %>% mutate(var="CMD")

NR_CMD_ht_plot <- ggplot()+
  geom_ribbon(data=predicCMData_CMD_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicCMData_CMD_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name=="CMD")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance CMD")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_CMD_ht_plot

##NFFD
ht_NFFD_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name=="NFFD"))
plot(ht_NFFD_mod)
qqmath(ht_NFFD_mod)
summary(ht_NFFD_mod)

####make plot 
NR_NFFD_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_NR_long %>% filter(climvar.name=="NFFD"))

newdata_NR_NFFD_ht <-  expand.grid(climvar.value=seq(min(ht_NR_long %>% filter(climvar.name=="NFFD") %>% pull(climvar.value)), max(ht_NR_long %>% filter(climvar.name=="NFFD") %>% pull(climvar.value)), length.out=50))
NR_NFFD_ht_predict <- predict(NR_NFFD_ht_mod_lm, newdata = newdata_NR_NFFD_ht, interval="confidence")

predicNFFData_NFFD_ht <- cbind(newdata_NR_NFFD_ht, NR_NFFD_ht_predict) %>% mutate(var="NFFD")

NR_NFFD_ht_plot <- ggplot()+
  geom_ribbon(data=predicNFFData_NFFD_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicNFFData_NFFD_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name=="NFFD")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance NFFD")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_NFFD_ht_plot

##PPTsm
ht_PPTsm_mod <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name=="PPTsm"))
plot(ht_PPTsm_mod)
qqmath(ht_PPTsm_mod)
summary(ht_PPTsm_mod)

####make plot 
NR_PPTsm_ht_mod_lm <- lm(log(value) ~  climvar.value, data=ht_NR_long %>% filter(climvar.name=="PPTsm"))

newdata_NR_PPTsm_ht <-  expand.grid(climvar.value=seq(min(ht_NR_long %>% filter(climvar.name=="PPTsm") %>% pull(climvar.value)), max(ht_NR_long %>% filter(climvar.name=="PPTsm") %>% pull(climvar.value)), length.out=50))
NR_PPTsm_ht_predict <- predict(NR_PPTsm_ht_mod_lm, newdata = newdata_NR_PPTsm_ht, interval="confidence")

predicPPTsmata_PPTsm_ht <- cbind(newdata_NR_PPTsm_ht, NR_PPTsm_ht_predict) %>% mutate(var="PPTsm")

NR_PPTsm_ht_plot <- ggplot()+
  geom_ribbon(data=predicPPTsmata_PPTsm_ht, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicPPTsmata_PPTsm_ht, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name=="PPTsm")%>% mutate(fit=1), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance PPTsm")+
  ylab("Height (m)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_PPTsm_ht_plot

##all linear plot
NR_linear_mod_df <- bind_rows(predicPPTsmata_PPTsm_ht, predicNFFData_NFFD_ht, predicCMData_CMD_ht, predicSHMata_SHM_ht)

NR_linear_ht_plot <- ggplot()+
    geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_linear_mod_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_linear_mod_df$var)), aes(x=value, y=1.2, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_linear_mod_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_linear_mod_df, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name %in% unique(NR_linear_mod_df$var))%>% mutate(fit=1) %>% rename(var=climvar.name), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("log(Height (m))")+
  ggtitle("Northern Region")+
  facet_wrap(~var, scales="free")+
  theme_bw()
NR_linear_ht_plot

###quadratic

ht_NR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

ht_NR_mods_quad <- bind_rows(ht_NR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

ht_NR_mods_quad %>% arrange(pvalue2) #a lot of precip vars have quadratic effects, let's look at MCMT and MAP
cor_prov_climvars<- prov_clim_adjusted_bi %>% dplyr::select(c("AHM":"SHM","smrpb","monsoonality")) %>% cor()

##MAP
NR_htmap_quad <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_NR_long %>% filter(climvar.name=="MAP"))
plot(NR_htmap_quad)
qqmath(NR_htmap_quad)
summary(NR_htmap_quad)

NR_htmap_quad_lm <- lm(log(value) ~ climvar.value + I(climvar.value^2), data=ht_NR_long %>% filter(climvar.name=="MAP"))
newdata_NR_htmap <- with(ht_NR_long %>% filter(climvar.name=="MAP"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

NR_htmap_predict <- predict(NR_htmap_quad_lm, newdata = newdata_NR_htmap, interval="confidence")

predictdata_NR_htmap <- cbind(newdata_NR_htmap, NR_htmap_predict) %>% mutate(var="MAP")

NR_MAP_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_htmap, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_htmap, aes(x=climvar.value,y=fit), color="black")+
  xlab("MAP")+
  ylab("Log(Height (m))")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name=="MAP")%>% mutate(fit=.5), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MAP_plot

##MCMT
NR_ht_MCMT_quad <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK)+(1|year), data=ht_NR_long %>% filter(climvar.name=="MCMT"))
plot(NR_ht_MCMT_quad)
qqmath(NR_ht_MCMT_quad)
summary(NR_ht_MCMT_quad)

NR_ht_MCMT_quad_lm <- lm(log(value) ~ climvar.value + I(climvar.value^2), data=ht_NR_long %>% filter(climvar.name=="MCMT"))
newdata_NR_ht_MCMT <- with(ht_NR_long %>% filter(climvar.name=="MCMT"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

NR_ht_MCMT_predict <- predict(NR_ht_MCMT_quad_lm, newdata = newdata_NR_ht_MCMT, interval="confidence")

predictdata_NR_ht_MCMT <- cbind(newdata_NR_ht_MCMT, NR_ht_MCMT_predict) %>% mutate(var="MCMT")

NR_MCMT_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_ht_MCMT, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_ht_MCMT, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name=="MCMT")%>% mutate(fit=3), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("MCMT")+
  ylab("log(Height)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()
NR_MCMT_plot


##all quad plot
NR_quad_mod_df <- bind_rows(predictdata_NR_ht_MCMT, predictdata_NR_htmap)

NR_quad_ht_plot <- ggplot()+
    geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_quad_mod_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_quad_mod_df$var)), aes(x=value, y=1.2, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_quad_mod_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_quad_mod_df, aes(x=climvar.value,y=fit), color="black")+
  geom_rug(data=ht_NR_long %>% filter(climvar.name %in% unique(NR_quad_mod_df$var))%>% mutate(fit=1) %>% rename(var=climvar.name), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("log(Height (m))")+
  ggtitle("Northern Region")+
  facet_wrap(~var, scales="free")+
  theme_bw()
NR_quad_ht_plot
```

######relative height

```{r}
##Look at just northern Rockies, excluding Gila
relht_NR_long <- ht_growth_rel_clim_long %>% filter(y > 44)
  
relht_NR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

relht_NR_mods <- bind_rows(relht_NR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

relht_NR_mods %>% arrange(pvalue) ##lots significant, let's go with same 4 as for absolute height


##NFFD
NR_relht_NFFD_mod <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name=="NFFD"))
plot(NR_relht_NFFD_mod)
qqmath(NR_relht_NFFD_mod)
summary(NR_relht_NFFD_mod)

####make plot 
NR_NFFD_relht_mod_lm <- lm(relht ~  value, data=relht_NR_long %>% filter(name=="NFFD"))

newdata_NR_NFFD_relht <-  expand.grid(value=seq(min(relht_NR_long %>% filter(name=="NFFD") %>% pull(value)), max(relht_NR_long %>% filter(name=="NFFD") %>% pull(value)), length.out=50))
NR_NFFD_relht_predict <- predict(NR_NFFD_relht_mod_lm, newdata = newdata_NR_NFFD_relht, interval="confidence")

predicNFFData_NFFD_relht <- cbind(newdata_NR_NFFD_relht, NR_NFFD_relht_predict) %>% mutate(var="NFFD")

NR_NFFD_relht_plot <- ggplot()+
  geom_ribbon(data=predicNFFData_NFFD_relht, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicNFFData_NFFD_relht, aes(x=value,y=fit), color="black")+
  geom_rug(data=relht_NR_long %>% filter(name=="NFFD")%>% mutate(fit=10), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance NFFD")+
  ylab("Relative Height Growth Rate (%/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_NFFD_relht_plot

##SHM
NR_relht_SHM_mod <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name=="SHM"))
plot(NR_relht_SHM_mod)
qqmath(NR_relht_SHM_mod)
summary(NR_relht_SHM_mod)

####make plot 
NR_SHM_relht_mod_lm <- lm(relht ~  value, data=relht_NR_long %>% filter(name=="SHM"))

newdata_NR_SHM_relht <-  expand.grid(value=seq(min(relht_NR_long %>% filter(name=="SHM") %>% pull(value)), max(relht_NR_long %>% filter(name=="SHM") %>% pull(value)), length.out=50))
NR_SHM_relht_predict <- predict(NR_SHM_relht_mod_lm, newdata = newdata_NR_SHM_relht, interval="confidence")

predicSHMata_SHM_relht <- cbind(newdata_NR_SHM_relht, NR_SHM_relht_predict) %>% mutate(var="SHM")

NR_SHM_relht_plot <- ggplot()+
  geom_ribbon(data=predicSHMata_SHM_relht, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicSHMata_SHM_relht, aes(x=value,y=fit), color="black")+
  geom_rug(data=relht_NR_long %>% filter(name=="SHM")%>% mutate(fit=10), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance SHM")+
  ylab("Relative Height Growth Rate (%/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_SHM_relht_plot


##PPTsm
NR_relht_PPTsm_mod <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name=="PPTsm"))
plot(NR_relht_PPTsm_mod)
qqmath(NR_relht_PPTsm_mod)
summary(NR_relht_PPTsm_mod)

####make plot 
NR_PPTsm_relht_mod_lm <- lm(relht ~  value, data=relht_NR_long %>% filter(name=="PPTsm"))

newdata_NR_PPTsm_relht <-  expand.grid(value=seq(min(relht_NR_long %>% filter(name=="PPTsm") %>% pull(value)), max(relht_NR_long %>% filter(name=="PPTsm") %>% pull(value)), length.out=50))
NR_PPTsm_relht_predict <- predict(NR_PPTsm_relht_mod_lm, newdata = newdata_NR_PPTsm_relht, interval="confidence")

predicPPTsmata_PPTsm_relht <- cbind(newdata_NR_PPTsm_relht, NR_PPTsm_relht_predict) %>% mutate(var="PPTsm")

NR_PPTsm_relht_plot <- ggplot()+
  geom_ribbon(data=predicPPTsmata_PPTsm_relht, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicPPTsmata_PPTsm_relht, aes(x=value,y=fit), color="black")+
  geom_rug(data=relht_NR_long %>% filter(name=="PPTsm")%>% mutate(fit=10), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance PPTsm")+
  ylab("Relative Height Growth Rate (%/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_PPTsm_relht_plot

##CMD
NR_relht_CMD_mod <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name=="CMD"))
plot(NR_relht_CMD_mod)
qqmath(NR_relht_CMD_mod)
summary(NR_relht_CMD_mod)

####make plot 
NR_CMD_relht_mod_lm <- lm(relht ~  value, data=relht_NR_long %>% filter(name=="CMD"))

newdata_NR_CMD_relht <-  expand.grid(value=seq(min(relht_NR_long %>% filter(name=="CMD") %>% pull(value)), max(relht_NR_long %>% filter(name=="CMD") %>% pull(value)), length.out=50))
NR_CMD_relht_predict <- predict(NR_CMD_relht_mod_lm, newdata = newdata_NR_CMD_relht, interval="confidence")

predicCMData_CMD_relht <- cbind(newdata_NR_CMD_relht, NR_CMD_relht_predict) %>% mutate(var="CMD")

NR_CMD_relht_plot <- ggplot()+
  geom_ribbon(data=predicCMData_CMD_relht, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predicCMData_CMD_relht, aes(x=value,y=fit), color="black")+
  geom_rug(data=relht_NR_long %>% filter(name=="CMD")%>% mutate(fit=10), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance CMD")+
  ylab("Relative Height Growth Rate (%/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
NR_CMD_relht_plot

##all linear plot
NR_linear_relht_mod_df <- bind_rows(predicPPTsmata_PPTsm_relht, predicNFFData_NFFD_relht, predicCMData_CMD_relht, predicSHMata_SHM_relht)

NR_linear_relht_plot <- ggplot()+
    geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_linear_relht_mod_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_linear_relht_mod_df$var)), aes(x=value, y=12.5, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_linear_relht_mod_df, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_linear_relht_mod_df, aes(x=value,y=fit), color="black")+
  geom_rug(data=relht_NR_long %>% filter(name %in% unique(NR_linear_relht_mod_df$var))%>% mutate(fit=10) %>% rename(var=name), aes(x=value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Relative Height Growth Rate (%/yr)")+
  ggtitle("Northern Region")+
  facet_wrap(~var, scales="free")+
  theme_bw()
NR_linear_relht_plot


###quadratic

relht_NR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

relht_NR_mods_quad <- bind_rows(relht_NR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

relht_NR_mods_quad %>% arrange(pvalue2) #lots significant, lets look at MAP and MCMT

##MAP
NR_relhtMAP_quad <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name=="MAP"))
plot(NR_relhtMAP_quad)
qqmath(NR_relhtMAP_quad)
summary(NR_relhtMAP_quad)

NR_relhtMAP_quad_lm <- lm(relht ~ value + I(value^2), data=relht_NR_long %>% filter(name=="MAP"))
newdata_NR_relhtMAP <- with(relht_NR_long %>% filter(name=="MAP"), data.frame(value=seq(min(value),max(value),length.out=100)))

NR_relhtMAP_predict <- predict(NR_relhtMAP_quad_lm, newdata = newdata_NR_relhtMAP, interval="confidence")

predictdata_NR_relhtMAP <- cbind(newdata_NR_relhtMAP, NR_relhtMAP_predict) %>% mutate(var="MAP")

NR_MAP_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_relhtMAP, aes(x=value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_relhtMAP, aes(x=value,y=fit), color="black")+
  xlab("MAP")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_NR_long %>% filter(name=="MAP")%>% mutate(fit=10), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MAP_plot

##MCMT
NR_relhtMCMT_quad <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_NR_long %>% filter(name=="MCMT"))
plot(NR_relhtMCMT_quad)
qqmath(NR_relhtMCMT_quad)
summary(NR_relhtMCMT_quad)

NR_relhtMCMT_quad_lm <- lm(relht ~ value + I(value^2), data=relht_NR_long %>% filter(name=="MCMT"))
newdata_NR_relhtMCMT <- with(relht_NR_long %>% filter(name=="MCMT"), data.frame(value=seq(min(value),max(value),length.out=100)))

NR_relhtMCMT_predict <- predict(NR_relhtMCMT_quad_lm, newdata = newdata_NR_relhtMCMT, interval="confidence")

predictdata_NR_relhtMCMT <- cbind(newdata_NR_relhtMCMT, NR_relhtMCMT_predict) %>% mutate(var="MCMT")

NR_MCMT_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_relhtMCMT, aes(x=value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_relhtMCMT, aes(x=value,y=fit), color="black")+
  xlab("MCMT")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_NR_long %>% filter(name=="MCMT")%>% mutate(fit=10), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MCMT_plot

##all quad plot
NR_quad_relht_mod_df <- bind_rows(predictdata_NR_relhtMCMT, predictdata_NR_relhtMAP)

NR_quad_relht_plot <- ggplot()+
    geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_quad_relht_mod_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_quad_relht_mod_df$var)), aes(x=value, y=12.5, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_quad_relht_mod_df, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_quad_relht_mod_df, aes(x=value,y=fit), color="black")+
  geom_rug(data=relht_NR_long %>% filter(name %in% unique(NR_quad_relht_mod_df$var))%>% mutate(fit=10) %>% rename(var=name), aes(x=value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Relative Height Growth Rate (%/yr)")+
  ggtitle("Northern Region")+
  facet_wrap(~var, scales="free")+
  theme_bw()
NR_quad_relht_plot

```

######pca models

Absolute Height

```{r}
NR_ht_data_year_clim<- ht_data_year_clim %>% 
  filter(y > 44)

###try year as a random effect
#y
NR_mod_ht_pca_y_randtime <- lmer(log(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=NR_ht_data_year_clim)
plot(NR_mod_ht_pca_y_randtime)
qqmath(NR_mod_ht_pca_y_randtime)
summary(NR_mod_ht_pca_y_randtime)
NR_mod_ht_pca_y_randtime_dredge<- dredge(NR_mod_ht_pca_y_randtime)
NR_mod_ht_pca_y_randtime_dredge

bestNR_mod_ht_pca_y_randtime <- lmer(log(value) ~  (1|Provenance) + (1|BLK) + (1|year), data=NR_ht_data_year_clim)
summary(bestNR_mod_ht_pca_y_randtime) #null is best

#x
NR_mod_ht_pca_x_randtime <- lmer(log(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=NR_ht_data_year_clim)
plot(NR_mod_ht_pca_x_randtime)
qqmath(NR_mod_ht_pca_x_randtime)
summary(NR_mod_ht_pca_x_randtime)
NR_mod_ht_pca_x_randtime_dredge<- dredge(NR_mod_ht_pca_x_randtime)
NR_mod_ht_pca_x_randtime_dredge ##best is null 

bestNR_mod_ht_pca_x_randtime <- lmer(log(value) ~ (1|Provenance) + (1|BLK) + (1|year), data=NR_ht_data_year_clim)
summary(bestNR_mod_ht_pca_x_randtime)

 ##null is best

```

Relative Height Growth

```{r}
##PC x latitude analysis
ht_growth_rel_clim_NR <- ht_growth_rel_clim %>% 
  filter(y > 44)
#y
NR_mod_relht_pca_y_randtime <- lmer(value ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_NR)
plot(NR_mod_relht_pca_y_randtime)
qqmath(NR_mod_relht_pca_y_randtime)
summary(NR_mod_relht_pca_y_randtime)
NR_mod_relht_pca_y_randtime_dredge<- dredge(NR_mod_relht_pca_y_randtime)
NR_mod_relht_pca_y_randtime_dredge ##null model is best

bestNR_mod_relht_pca_y_randtime <- lmer(value ~ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_NR)
summary(bestNR_mod_relht_pca_y_randtime)

#x
NR_mod_relht_pca_x_randtime <- lmer(value ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_NR)
plot(NR_mod_relht_pca_x_randtime)
qqmath(NR_mod_relht_pca_x_randtime)
summary(NR_mod_relht_pca_x_randtime)
NR_mod_relht_pca_x_randtime_dredge<- dredge(NR_mod_relht_pca_x_randtime)
NR_mod_relht_pca_x_randtime_dredge ##null model is best

bestNR_mod_relht_pca_x_randtime <- lmer(value ~  (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_NR)
summary(bestNR_mod_relht_pca_x_randtime)

##northern region relative growth not well explained by PC1, PC2, latitude or longitude. 
```

#####dbh

```{r}
##Look at just northern region
dbh_NR <- dbh_numeric_time %>% filter(y > 44)
  
dbh_NR_long <- dbh_NR %>% 
  pivot_longer(c(AHM:SHM, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

dbh_NR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK), data=dbh_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

dbh_NR_mods <- bind_rows(dbh_NR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

dbh_NR_mods %>% arrange(pvalue) ##many temperature vars significant, lets just look at MAT, its highly correlated with all others + SHM and CMD

##MAT
NR_dbhMAT <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=dbh_NR_long %>% filter(climvar.name=="MAT"))
plot(NR_dbhMAT)
qqmath(NR_dbhMAT)
summary(NR_dbhMAT)

NR_dbhMAT_lm <- lm(DBH ~ climvar.value, data=dbh_NR_long %>% filter(climvar.name=="MAT"))
newdata_NR_dbhMAT <- with(dbh_NR_long %>% filter(climvar.name=="MAT"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

NR_dbhMAT_predict <- predict(NR_dbhMAT_lm, newdata = newdata_NR_dbhMAT, interval="confidence")

predictdata_NR_dbhMAT <- cbind(newdata_NR_dbhMAT, NR_dbhMAT_predict) %>% mutate(var="MAT")

NR_MAT_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_dbhMAT, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_dbhMAT, aes(x=climvar.value,y=fit), color="black")+
  xlab("MAT")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_NR_long %>% filter(climvar.name=="MAT")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MAT_plot

##SHM
NR_dbhSHM <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=dbh_NR_long %>% filter(climvar.name=="SHM"))
plot(NR_dbhSHM)
qqmath(NR_dbhSHM)
summary(NR_dbhSHM)

NR_dbhSHM_lm <- lm(DBH ~ climvar.value, data=dbh_NR_long %>% filter(climvar.name=="SHM"))
newdata_NR_dbhSHM <- with(dbh_NR_long %>% filter(climvar.name=="SHM"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

NR_dbhSHM_predict <- predict(NR_dbhSHM_lm, newdata = newdata_NR_dbhSHM, interval="confidence")

predictdata_NR_dbhSHM <- cbind(newdata_NR_dbhSHM, NR_dbhSHM_predict) %>% mutate(var="SHM")

NR_SHM_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_dbhSHM, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_dbhSHM, aes(x=climvar.value,y=fit), color="black")+
  xlab("SHM")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_NR_long %>% filter(climvar.name=="SHM")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_SHM_plot

##CMD
NR_dbhCMD <- lmer(DBH ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=dbh_NR_long %>% filter(climvar.name=="CMD"))
plot(NR_dbhCMD)
qqmath(NR_dbhCMD)
summary(NR_dbhCMD)

NR_dbhCMD_lm <- lm(DBH ~ climvar.value, data=dbh_NR_long %>% filter(climvar.name=="CMD"))
newdata_NR_dbhCMD <- with(dbh_NR_long %>% filter(climvar.name=="CMD"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

NR_dbhCMD_predict <- predict(NR_dbhCMD_lm, newdata = newdata_NR_dbhCMD, interval="confidence")

predictdata_NR_dbhCMD <- cbind(newdata_NR_dbhCMD, NR_dbhCMD_predict) %>% mutate(var="CMD")

NR_CMD_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_dbhCMD, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_dbhCMD, aes(x=climvar.value,y=fit), color="black")+
  xlab("CMD")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_NR_long %>% filter(climvar.name=="CMD")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_CMD_plot

#all linear
##all plot
NR_absdbh_linear_mods_df<- bind_rows(predictdata_NR_dbhCMD,predictdata_NR_dbhSHM,predictdata_NR_dbhMAT)

NR_absdbh_linear_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_absdbh_linear_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_absdbh_linear_mods_df$var)), aes(x=value, y=10.5, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_absdbh_linear_mods_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_absdbh_linear_mods_df, aes(x=climvar.value,y=fit))+
  geom_rug(data=dbh_NR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=10)%>% filter(var %in% unique(NR_absdbh_linear_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("DBH (cm)")+
  ggtitle("Northern Region")+
  facet_wrap(~factor(var, levels=c("MAT","CMD","SHM")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
NR_absdbh_linear_mod_plot


###quadratic

dbh_NR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=dbh_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_NR_mods_quad <- bind_rows(dbh_NR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

dbh_NR_mods_quad %>% arrange(pvalue2) #MAP and others significant, lets look at PAS, MSP, MCMT

##PAS
PAS_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=dbh_NR_long %>% filter(climvar.name=="PAS"))
plot(PAS_dbh_quad)
qqmath(PAS_dbh_quad)
summary(PAS_dbh_quad)


PAS_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_NR_long %>% filter(climvar.name=="PAS"))
newdata_dbh_PAS <- with(dbh_NR_long %>% filter(climvar.name=="PAS"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_PAS_predict <- predict(PAS_dbh_quad_lm, newdata = newdata_dbh_PAS, interval="confidence")

predictdata_dbh_PAS <- cbind(newdata_dbh_PAS, dbh_PAS_predict) %>% mutate(var="PAS")

NR_PAS_plot<- ggplot()+
  geom_ribbon(data=predictdata_dbh_PAS, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_PAS, aes(x=climvar.value,y=fit), color="black")+
  xlab("PAS")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_NR_long %>% filter(climvar.name=="PAS")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_PAS_plot

##MSP
MSP_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=dbh_NR_long %>% filter(climvar.name=="MSP"))
plot(MSP_dbh_quad)
qqmath(MSP_dbh_quad)
summary(MSP_dbh_quad)


MSP_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_NR_long %>% filter(climvar.name=="MSP"))
newdata_dbh_MSP <- with(dbh_NR_long %>% filter(climvar.name=="MSP"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_MSP_predict <- predict(MSP_dbh_quad_lm, newdata = newdata_dbh_MSP, interval="confidence")

predictdata_dbh_MSP <- cbind(newdata_dbh_MSP, dbh_MSP_predict) %>% mutate(var="MSP")

NR_MSP_plot<- ggplot()+
  geom_ribbon(data=predictdata_dbh_MSP, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_MSP, aes(x=climvar.value,y=fit), color="black")+
  xlab("MSP")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_NR_long %>% filter(climvar.name=="MSP")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MSP_plot

##MCMT
MCMT_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=dbh_NR_long %>% filter(climvar.name=="MCMT"))
plot(MCMT_dbh_quad)
qqmath(MCMT_dbh_quad)
summary(MCMT_dbh_quad)


MCMT_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_NR_long %>% filter(climvar.name=="MCMT"))
newdata_dbh_MCMT <- with(dbh_NR_long %>% filter(climvar.name=="MCMT"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_MCMT_predict <- predict(MCMT_dbh_quad_lm, newdata = newdata_dbh_MCMT, interval="confidence")

predictdata_dbh_MCMT <- cbind(newdata_dbh_MCMT, dbh_MCMT_predict) %>% mutate(var="MCMT")

NR_MCMT_plot<- ggplot()+
  geom_ribbon(data=predictdata_dbh_MCMT, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_MCMT, aes(x=climvar.value,y=fit), color="black")+
  xlab("MCMT")+
  ylab("DBH (cm)")+
  geom_rug(data=dbh_NR_long %>% filter(climvar.name=="MCMT")%>% mutate(fit=10), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MCMT_plot

##all quadratic plot
NR_absdbh_quad_mods_df<- bind_rows(predictdata_dbh_MCMT,predictdata_dbh_PAS,predictdata_dbh_MSP)

NR_absdbh_quad_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_absdbh_quad_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_absdbh_quad_mods_df$var)), aes(x=value, y=8, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_absdbh_quad_mods_df, aes(x=climvar.value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_absdbh_quad_mods_df, aes(x=climvar.value,y=fit))+
  geom_rug(data=dbh_NR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=10)%>% filter(var %in% unique(NR_absdbh_quad_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("DBH (cm)")+
  ggtitle("Northern Region")+
  facet_wrap(~factor(var, levels=c("PAS","MSP","MCMT")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
NR_absdbh_quad_mod_plot


```


######basal area growth

```{r}
NR_dbh_growth_clim_long <- dbh_growth_clim_long %>% filter(y > 44)

NR_reldbh_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relDBH) ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=NR_dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

NR_reldbh_mods <- bind_rows(NR_reldbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

NR_reldbh_mods %>% arrange(pvalue) #many temp variables are significant. Lets look at MAT & CMD


##MAT
NR_reldbhMAT <- lmer(sqrt(relDBH) ~ value + (1|Provenance) + (1|BLK) + (1|year), data=NR_dbh_growth_clim_long %>% filter(name=="MAT"))
plot(NR_reldbhMAT)
qqmath(NR_reldbhMAT)
summary(NR_reldbhMAT)

NR_reldbhMAT_lm <- lm(sqrt(relDBH) ~ value, data=NR_dbh_growth_clim_long %>% filter(name=="MAT"))
newdata_NR_reldbhMAT <- with(NR_dbh_growth_clim_long %>% filter(name=="MAT"), data.frame(value=seq(min(value),max(value),length.out=100)))

NR_reldbhMAT_predict <- predict(NR_reldbhMAT_lm, newdata = newdata_NR_reldbhMAT, interval="confidence")

predictdata_NR_reldbhMAT <- cbind(newdata_NR_reldbhMAT, NR_reldbhMAT_predict) %>% mutate(var="MAT")

NR_MAT_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_reldbhMAT, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_reldbhMAT, aes(x=value,y=fit^2), color="black")+
  xlab("MAT")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=NR_dbh_growth_clim_long %>% filter(name=="MAT")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MAT_plot


##CMD
NR_reldbhCMD <- lmer(sqrt(relDBH) ~ value + (1|Provenance) + (1|BLK) + (1|year), data=NR_dbh_growth_clim_long %>% filter(name=="CMD"))
plot(NR_reldbhCMD)
qqmath(NR_reldbhCMD)
summary(NR_reldbhCMD)

NR_reldbhCMD_lm <- lm(sqrt(relDBH) ~ value, data=NR_dbh_growth_clim_long %>% filter(name=="CMD"))
newdata_NR_reldbhCMD <- with(NR_dbh_growth_clim_long %>% filter(name=="CMD"), data.frame(value=seq(min(value),max(value),length.out=100)))

NR_reldbhCMD_predict <- predict(NR_reldbhCMD_lm, newdata = newdata_NR_reldbhCMD, interval="confidence")

predictdata_NR_reldbhCMD <- cbind(newdata_NR_reldbhCMD, NR_reldbhCMD_predict) %>% mutate(var="CMD")

NR_CMD_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_reldbhCMD, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_reldbhCMD, aes(x=value,y=fit^2), color="black")+
  xlab("CMD")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=NR_dbh_growth_clim_long %>% filter(name=="CMD")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_CMD_plot


###quadratic

NR_reldbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relDBH) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=NR_dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

NR_reldbh_mods_quad <- bind_rows(NR_reldbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

NR_reldbh_mods_quad %>% arrange(pvalue2) #let's look at PAS and MCMT

##PAS
NR_reldbhPAS <- lmer(sqrt(relDBH) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=NR_dbh_growth_clim_long %>% filter(name=="PAS"))
plot(NR_reldbhPAS)
qqmath(NR_reldbhPAS)
summary(NR_reldbhPAS)

NR_reldbhPAS_lm <- lm(sqrt(relDBH) ~ value + I(value^2), data=NR_dbh_growth_clim_long %>% filter(name=="PAS"))
newdata_NR_reldbhPAS <- with(NR_dbh_growth_clim_long %>% filter(name=="PAS"), data.frame(value=seq(min(value),max(value),length.out=100)))

NR_reldbhPAS_predict <- predict(NR_reldbhPAS_lm, newdata = newdata_NR_reldbhPAS, interval="confidence")

predictdata_NR_reldbhPAS <- cbind(newdata_NR_reldbhPAS, NR_reldbhPAS_predict) %>% mutate(var="PAS")

NR_PAS_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_reldbhPAS, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_reldbhPAS, aes(x=value,y=fit^2), color="black")+
  xlab("PAS")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=NR_dbh_growth_clim_long %>% filter(name=="PAS")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_PAS_plot


##MCMT
NR_reldbhMCMT <- lmer(sqrt(relDBH) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=NR_dbh_growth_clim_long %>% filter(name=="MCMT"))
plot(NR_reldbhMCMT)
qqmath(NR_reldbhMCMT)
summary(NR_reldbhMCMT)

NR_reldbhMCMT_lm <- lm(sqrt(relDBH) ~ value + I(value^2), data=NR_dbh_growth_clim_long %>% filter(name=="MCMT"))
newdata_NR_reldbhMCMT <- with(NR_dbh_growth_clim_long %>% filter(name=="MCMT"), data.frame(value=seq(min(value),max(value),length.out=100)))

NR_reldbhMCMT_predict <- predict(NR_reldbhMCMT_lm, newdata = newdata_NR_reldbhMCMT, interval="confidence")

predictdata_NR_reldbhMCMT <- cbind(newdata_NR_reldbhMCMT, NR_reldbhMCMT_predict) %>% mutate(var="MCMT")

NR_MCMT_plot<- ggplot()+
  geom_ribbon(data=predictdata_NR_reldbhMCMT, aes(x=value, ymin=lwr^2, ymax=upr^2), fill="black", alpha=0.2)+
  geom_line(data=predictdata_NR_reldbhMCMT, aes(x=value,y=fit^2), color="black")+
  xlab("MCMT")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  geom_rug(data=NR_dbh_growth_clim_long %>% filter(name=="MCMT")%>% mutate(fit=40), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  theme_bw()
NR_MCMT_plot


##all plot
NR_reldbh_all_mods_df<- bind_rows(predictdata_NR_reldbhMCMT,predictdata_NR_reldbhPAS,predictdata_NR_reldbhCMD,predictdata_NR_reldbhMAT)

NR_reldbh_all_mod_plot <- ggplot()+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(NR_reldbh_all_mods_df$var)), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(NR_reldbh_all_mods_df$var)), aes(x=value, y=3, label="plantation"), col="steelblue", size=3)+
  geom_ribbon(data=NR_reldbh_all_mods_df, aes(x=value, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=NR_reldbh_all_mods_df, aes(x=value,y=fit))+
  geom_rug(data=dbh_NR_long %>% dplyr::rename(var=climvar.name) %>% mutate(fit=2)%>% filter(var %in% unique(NR_reldbh_all_mods_df$var)), aes(x=climvar.value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Sqrt(Basal Area Growth Rate (cm^2/year))")+
  ggtitle("Northern Region")+
  facet_wrap(~factor(var, levels=c("MAT","CMD","PAS","MCMT")), nrow=2, scales="free")+
  theme_bw()+
  theme(legend.position="right")
NR_reldbh_all_mod_plot



```



```{r}

##use PC1 and PC2 rather than climate variables

pca_cor_data<- cor_provclim_long %>% 
  left_join(prov_pcapts %>% dplyr::select(Provenance, PC1, PC2)) %>% 
  dplyr::select(-c(name,value)) %>% 
  unique() %>% 
    mutate(pc1diff = PC1 - prov_pcapts %>% 
  filter(Provenance == "Plantation") %>% 
  pull(PC1),
          pc2diff = PC2 - prov_pcapts %>% 
  filter(Provenance == "Plantation") %>% 
  pull(PC2)) %>% 
  mutate(pcadist = sqrt(pc1diff^2 + pc2diff^2))

unique(cor_provclim_long$climvar)

sig.cors20<- gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  filter(n>20) %>% 
  arrange(n)

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1), aes(x=Provenance, y=cor))+
  geom_boxplot()+
  geom_hline(yintercept = 0, color="red")+
  facet_wrap(~climvar)+
  theme(axis.text.x = element_text(angle=45, hjust=1))

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1) %>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1), aes(x=PC2, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

pca_cor_data_filtered <- pca_cor_data %>% filter(climvar%in%sig.cors20$V1)

clim_pcmod <- lmer(cor ~ climvar*PC1 +  climvar*PC2 + climvar*pcadist + (1|Provenance), data=pca_cor_data)
plot(clim_pcmod)
qqmath(clim_pcmod)
summary(clim_pcmod)
dredge.climpcmod <- dredge(clim_pcmod)
dredge.climpcmod ##the best model just has climvar in it meaning that all provenances regardless of their PC1 or PC2 position are more or less responding the same to the climate variables. 

##use distance in PC and geographic space between population and plantation
ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1) %>% filter(!Provenance=="Gila NF"), aes(x=pcadist, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

pca_cor_data_dist<- pca_cor_data %>% filter(climvar%in%sig.cors20$V1)  %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

pcadist_mod_vpd_data <- pca_cor_data_dist %>% filter(climvar=="vpdmax_wt") %>% filter(!Provenance=="Gila NF")
pcadist_mod_vpd <- lmer(cor ~ pcadist*geo.dist.to.plant.km + (1|Provenance), data=pcadist_mod_vpd_data)
plot(pcadist_mod_vpd)
qqmath(pcadist_mod_vpd)
summary(pcadist_mod_vpd)
dredge(pcadist_mod_vpd)

pcadist_mod_aet_data<- pca_cor_data_dist %>% filter(climvar=="aet_sum")%>% filter(!Provenance=="Gila NF")
pcadist_mod_aet <- lmer(cor ~ pcadist*geo.dist.to.plant.km + (1|Provenance), data=pcadist_mod_aet_data)
plot(pcadist_mod_aet)
qqmath(pcadist_mod_aet)
summary(pcadist_mod_aet)
dredge(pcadist_mod_aet)
##neither model is significant with or without Gila. 

```

#####survival
```{r}
NR_moniger_survival_long <- moniger_survival_long %>% filter(y > 44)

NR_surv_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=NR_moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- as.data.frame(summary(mod)$coefficients$cond)[2,]$`Pr(>|z|)`

NR_surv_mods <- bind_rows(NR_surv_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))}

NR_surv_mods %>% arrange(pvalue) ##smrpb significant

#smrpb
NR_surv_smrpb_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=NR_moniger_survival_long %>% filter(climvar.name=="smrpb"), family="binomial")
summary(NR_surv_smrpb_mod)

NR_surv_smrpb_data <- NR_moniger_survival_long %>% filter(climvar.name=="smrpb")

NR_newdata_smrpb_surv <- data.frame(
    climvar.value = seq(min(NR_surv_smrpb_data$climvar.value), 
                      max(NR_surv_smrpb_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
NR_surv_smrpb_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=NR_moniger_survival_long %>% filter(climvar.name=="smrpb"), family="binomial")

NR_survsmrpb_newdata1 <-  expand.grid(climvar.value = seq(min(NR_newdata_smrpb_surv$climvar.value),max(NR_newdata_smrpb_surv$climvar.value),length.out=50))

NR_survsmrpb_newdata2 <- cbind(NR_survsmrpb_newdata1, predict(NR_surv_smrpb_mod_glm, newdata = NR_survsmrpb_newdata1, type = "link", se=TRUE))

NR_survsmrpb_newdata3 <- within(NR_survsmrpb_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

NR_smrpb_surv_plot<- ggplot(NR_survsmrpb_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
   geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(climvar.name=name)%>% filter(climvar.name =="smrpb"), aes(xintercept = value), col="steelblue")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(climvar.name=name)%>% filter(climvar.name == "smrpb"), aes(x=value, y=.7, label="plantation"), col="steelblue", size=3)+
  geom_line(linewidth = 1)+
  geom_rug(data=prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation" & y>44) %>% rename(climvar.value=smrpb) %>% mutate(PredictedProb=.8), aes(x=climvar.value, y=PredictedProb, col=factor(Provenance, levels=provs_bylat$Provenance)),sides="b",linewidth=2)+
  scale_color_manual(values=unname(stepped())[-c(1:12)], name="Provenance")+
  xlab("Provenance summer precip ratio")+
  ylab("Survival Probability")+
  ggtitle("Northern Region")+
  theme_bw()
NR_smrpb_surv_plot

###quadratic

NR_surv_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=NR_moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`

NR_surv_mods_quad <- bind_rows(NR_surv_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

NR_surv_mods_quad %>% arrange(pvalue2) ##nothing significant

```

#####provenance climate affect on Gx C correlation 
```{r}

##############################################

cor_provclim_NR<- cor_clean %>%
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  dplyr::rename(Provenance = newname) %>% 
  left_join(
prov_pcapts %>% 
  dplyr::select(c(Provenance,y,PC1:PC2,AHM:SHM,smrpb)), by="Provenance") %>% 
  filter(y >44)

cor_provclim_long_NR <- pivot_longer(cor_provclim_NR, PC1:smrpb)

# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
names <- unique(cor_provclim_long_NR$name)
lmerdata_NR <- data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(names)){
    data <- cor_provclim_long_NR %>% filter(climvar==climvars[i] & name==names[j]) 
    mod <- lmer(cor ~ value + (1|Provenance), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    
lmerdata_NR <- bind_rows(lmerdata_NR, data.frame(climvar=climvars[i], name=names[j], pvalue.lmer = pvalue.lmer)) 
  }}

lmerdata_NR %>% filter(pvalue.lmer < 0.05)

names <- unique(cor_provclim_long_NR$name)
lmerdata_pcs_NR <- data.frame()
for(i in 1:length(climvars)){
    data <- cor_provclim_NR %>% filter(climvar==climvars[i]) 
    mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=data)
    pc1pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[3,] %>% pull(`Pr(>|t|)`)
    pc1pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[4,] %>% pull(`Pr(>|t|)`)

    
lmerdata_pcs_NR <- bind_rows(lmerdata_pcs_NR, data.frame(climvar=climvars[i], pc1value.lmer = pc1pvalue.lmer, pc2value.lmer = pc2pvalue.lmer, pc1pc2value.lmer = pc1pc2pvalue.lmer)) 
}

lmerdata_pcs_NR %>% 
  filter((pc1value.lmer < 0.05 | pc2value.lmer < 0.05 | pc1pc2value.lmer<0.05))

NR_pc1_spT_mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=cor_provclim_NR %>% filter(climvar=="prior_value_sp_tmean"))
plot(NR_pc1_spT_mod)
qqmath(NR_pc1_spT_mod)
summary(NR_pc1_spT_mod) #strength of correlation with prior spring temperature increases towards hotter and drier provenances (higher PC1)

```

```{r}
#current year plantation climate
NR_cyear_trends<- ggplot(data=left_join(lmerdata_NR %>% filter(pvalue.lmer < 0.05), cor_provclim_long_NR, by=c("climvar","name")) %>% filter(!str_detect(climvar, "prior")) , aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  ggtitle("Northern Region")

#prior year plantation climate
NR_pyear_trends<- ggplot(data=left_join(lmerdata_NR %>% filter(pvalue.lmer < 0.05), cor_provclim_long_NR, by=c("climvar","name"))%>% filter(str_detect(climvar, "prior")) , aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  ggtitle("Northern Region")

pdf("figures/NR_cyear_trends.pdf", width=11, height=8.5)
NR_cyear_trends
dev.off()

pdf("figures/NR_pyear_trends.pdf", width=11, height=8.5)
NR_pyear_trends
dev.off()
##########individual model results
```

#Transfer Functions

##Height growth rate

```{r}

relht_transfer_df <- ht_growth_rel_clim_long %>% 
  rename(provenance_value=value) %>% 
  left_join(prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% 
              rename(plantation_name=name, plantation_value=value) %>% 
              dplyr::select(-c(Provenance,type)),
            by=c("name"="plantation_name")) %>% 
  mutate(transfer = provenance_value - plantation_value)

relht_transfer_df_nog <- relht_transfer_df %>% filter(!Provenance=="Gila NF")
  
relht_transfer_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ transfer + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

relht_transfer_mods <- bind_rows(relht_transfer_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

relht_transfer_mods %>% arrange(pvalue) ##lots significant

###quadratic

relht_transfer_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df_nog %>% filter(name==provenance_climvars[i]))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

relht_transfer_mods_quad <- bind_rows(relht_transfer_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

relht_transfer_mods_quad %>% arrange(pvalue2) #DD0, DD18, MAT, Tavewt are significant

##DD0
transfer_relht_DD0_quad <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name=="DD0"))
plot(transfer_relht_DD0_quad)
qqmath(transfer_relht_DD0_quad)
summary(transfer_relht_DD0_quad)


transfer_relhtDD0_quad_lm <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df %>% filter(name=="DD0"))
newdata_transfer_relhtDD0 <- with(relht_transfer_df %>% filter(name=="DD0"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtDD0_predict <- predict(transfer_relhtDD0_quad_lm, newdata = newdata_transfer_relhtDD0, interval="confidence")

predictdata_transfer_relhtDD0 <- cbind(newdata_transfer_relhtDD0, transfer_relhtDD0_predict)

x_max_relht_DD0_quad = -coef(transfer_relhtDD0_quad_lm)[2] / (2*coef(transfer_relhtDD0_quad_lm)[3])

y_max_relht_DD0 = coef(transfer_relhtDD0_quad_lm)[1] + coef(transfer_relhtDD0_quad_lm)[2]*x_max_relht_DD0_quad + coef(transfer_relhtDD0_quad_lm)[3]*(x_max_relht_DD0_quad^2)

###no gila
transfer_relhtDD0_quad_lm_nog <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df_nog %>% filter(name=="DD0"))
newdata_transfer_relhtDD0_nog <- with(relht_transfer_df_nog %>% filter(name=="DD0"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtDD0_predict_nog <- predict(transfer_relhtDD0_quad_lm_nog, newdata = newdata_transfer_relhtDD0_nog, interval="confidence")

predictdata_transfer_relhtDD0_nog <- cbind(newdata_transfer_relhtDD0_nog, transfer_relhtDD0_predict_nog)

x_max_relht_DD0_quad_nog = -coef(transfer_relhtDD0_quad_lm_nog)[2] / (2*coef(transfer_relhtDD0_quad_lm_nog)[3])

y_max_relht_DD0_nog = coef(transfer_relhtDD0_quad_lm_nog)[1] + coef(transfer_relhtDD0_quad_lm_nog)[2]*x_max_relht_DD0_quad_nog + coef(transfer_relhtDD0_quad_lm_nog)[3]*(x_max_relht_DD0_quad_nog^2)
#################
predictdata_transfer_relhtDD0_all<- predictdata_transfer_relhtDD0 %>% mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_transfer_relhtDD0_nog %>% mutate(model="without Gila NF"))

transfer_DD0_plot<- ggplot()+
  geom_ribbon(data=predictdata_transfer_relhtDD0_all, aes(x=transfer, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  scale_fill_manual(values=c("#9a5ea1","#98823c"))+
  geom_line(data=predictdata_transfer_relhtDD0_all, aes(x=transfer,y=fit, linetype=model),linewidth=1)+
  scale_linetype_manual(values=c(1,2))+
  xlab("DD0")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_transfer_df %>% filter(name=="DD0")%>% mutate(fit=10), aes(x=transfer,y=fit), linewidth=1, col="black", sides="b")+
  geom_vline(xintercept = x_max_relht_DD0_quad, col="#9a5ea1", linewidth=1)+
  theme_bw()
transfer_DD0_plot
x_max_relht_DD0_quad
y_max_relht_DD0
x_max_relht_DD0_quad_nog
y_max_relht_DD0_nog

####make a without Gila line on the plot

##Tavewt
transfer_relht_Tavewt_quad <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name=="Tavewt"))
plot(transfer_relht_Tavewt_quad)
qqmath(transfer_relht_Tavewt_quad)
summary(transfer_relht_Tavewt_quad)

transfer_relhtTavewt_quad_lm <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df %>% filter(name=="Tavewt"))
newdata_transfer_relhtTavewt <- with(relht_transfer_df %>% filter(name=="Tavewt"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtTavewt_predict <- predict(transfer_relhtTavewt_quad_lm, newdata = newdata_transfer_relhtTavewt, interval="confidence")

predictdata_transfer_relhtTavewt <- cbind(newdata_transfer_relhtTavewt, transfer_relhtTavewt_predict)

x_max_relht_Tavewt_quad = -coef(transfer_relhtTavewt_quad_lm)[2] / (2*coef(transfer_relhtTavewt_quad_lm)[3])

y_max_relht_Tavewt_quad = coef(transfer_relhtTavewt_quad_lm)[1] + coef(transfer_relhtTavewt_quad_lm)[2]*x_max_relht_Tavewt_quad + coef(transfer_relhtTavewt_quad_lm)[3]*(x_max_relht_Tavewt_quad^2)

###no gila
transfer_relhtTavewt_quad_lm_nog <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df_nog %>% filter(name=="Tavewt"))
newdata_transfer_relhtTavewt_nog <- with(relht_transfer_df_nog %>% filter(name=="Tavewt"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtTavewt_predict_nog <- predict(transfer_relhtTavewt_quad_lm_nog, newdata = newdata_transfer_relhtTavewt_nog, interval="confidence")

predictdata_transfer_relhtTavewt_nog <- cbind(newdata_transfer_relhtTavewt_nog, transfer_relhtTavewt_predict_nog)

x_max_relht_Tavewt_quad_nog = -coef(transfer_relhtTavewt_quad_lm_nog)[2] / (2*coef(transfer_relhtTavewt_quad_lm_nog)[3])

y_max_relht_Tavewt_nog = coef(transfer_relhtTavewt_quad_lm_nog)[1] + coef(transfer_relhtTavewt_quad_lm_nog)[2]*x_max_relht_Tavewt_quad_nog + coef(transfer_relhtTavewt_quad_lm_nog)[3]*(x_max_relht_Tavewt_quad_nog^2)
#################
predictdata_transfer_relhtTavewt_all<- predictdata_transfer_relhtTavewt %>% mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_transfer_relhtTavewt_nog %>% mutate(model="without Gila NF"))

transfer_Tavewt_plot<- ggplot()+
  geom_ribbon(data=predictdata_transfer_relhtTavewt_all, aes(x=transfer, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  scale_fill_manual(values=c("#9a5ea1","#98823c"))+
  geom_line(data=predictdata_transfer_relhtTavewt_all, aes(x=transfer,y=fit, linetype=model),linewidth=1)+
  scale_linetype_manual(values=c(1,2))+
  xlab("Tavewt")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_transfer_df %>% filter(name=="Tavewt")%>% mutate(fit=10), aes(x=transfer,y=fit), linewidth=1, col="black", sides="b")+
  geom_vline(xintercept = x_max_relht_Tavewt_quad, col="#9a5ea1", linewidth=1)+
  theme_bw()
transfer_Tavewt_plot
x_max_relht_Tavewt_quad
y_max_relht_Tavewt_quad
x_max_relht_Tavewt_quad_nog
y_max_relht_Tavewt_nog

##Eref
transfer_relht_Eref_quad <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name=="Eref"))
plot(transfer_relht_Eref_quad)
qqmath(transfer_relht_Eref_quad)
summary(transfer_relht_Eref_quad)

transfer_relhtEref_quad_lm <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df %>% filter(name=="Eref"))
newdata_transfer_relhtEref <- with(relht_transfer_df %>% filter(name=="Eref"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtEref_predict <- predict(transfer_relhtEref_quad_lm, newdata = newdata_transfer_relhtEref, interval="confidence")

predictdata_transfer_relhtEref <- cbind(newdata_transfer_relhtEref, transfer_relhtEref_predict)

x_max_relht_Eref_quad = -coef(transfer_relhtEref_quad_lm)[2] / (2*coef(transfer_relhtEref_quad_lm)[3])

y_max_relht_Eref_quad = coef(transfer_relhtEref_quad_lm)[1] + coef(transfer_relhtEref_quad_lm)[2]*x_max_relht_Eref_quad + coef(transfer_relhtEref_quad_lm)[3]*(x_max_relht_Eref_quad^2)


###no gila
transfer_relhtEref_quad_lm_nog <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df_nog %>% filter(name=="Eref"))
newdata_transfer_relhtEref_nog <- with(relht_transfer_df_nog %>% filter(name=="Eref"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtEref_predict_nog <- predict(transfer_relhtEref_quad_lm_nog, newdata = newdata_transfer_relhtEref_nog, interval="confidence")

predictdata_transfer_relhtEref_nog <- cbind(newdata_transfer_relhtEref_nog, transfer_relhtEref_predict_nog)

x_max_relht_Eref_quad_nog = -coef(transfer_relhtEref_quad_lm_nog)[2] / (2*coef(transfer_relhtEref_quad_lm_nog)[3])

y_max_relht_Eref_nog = coef(transfer_relhtEref_quad_lm_nog)[1] + coef(transfer_relhtEref_quad_lm_nog)[2]*x_max_relht_Eref_quad_nog + coef(transfer_relhtEref_quad_lm_nog)[3]*(x_max_relht_Eref_quad_nog^2)
#################
predictdata_transfer_relhtEref_all<- predictdata_transfer_relhtEref %>% mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_transfer_relhtEref_nog %>% mutate(model="without Gila NF"))

transfer_Eref_plot<- ggplot()+
  geom_ribbon(data=predictdata_transfer_relhtEref_all, aes(x=transfer, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  scale_fill_manual(values=c("#9a5ea1","#98823c"))+
  geom_line(data=predictdata_transfer_relhtEref_all, aes(x=transfer,y=fit, linetype=model),linewidth=1)+
  scale_linetype_manual(values=c(1,2))+
  xlab("Eref")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_transfer_df %>% filter(name=="Eref")%>% mutate(fit=10), aes(x=transfer,y=fit), linewidth=1, col="black", sides="b")+
  geom_vline(xintercept = x_max_relht_Eref_quad, col="#9a5ea1", linewidth=1)+
  theme_bw()
transfer_Eref_plot
x_max_relht_Eref_quad
y_max_relht_Eref_quad
x_max_relht_Eref_quad_nog
y_max_relht_Eref_nog


##MCMT
transfer_relht_MCMT_quad <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name=="MCMT"))
plot(transfer_relht_MCMT_quad)
qqmath(transfer_relht_MCMT_quad)
summary(transfer_relht_MCMT_quad)

transfer_relhtMCMT_quad_lm <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df %>% filter(name=="MCMT"))
newdata_transfer_relhtMCMT <- with(relht_transfer_df %>% filter(name=="MCMT"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtMCMT_predict <- predict(transfer_relhtMCMT_quad_lm, newdata = newdata_transfer_relhtMCMT, interval="confidence")

predictdata_transfer_relhtMCMT <- cbind(newdata_transfer_relhtMCMT, transfer_relhtMCMT_predict)

x_max_relht_MCMT_quad = -coef(transfer_relhtMCMT_quad_lm)[2] / (2*coef(transfer_relhtMCMT_quad_lm)[3])

y_max_relht_MCMT_quad = coef(transfer_relhtMCMT_quad_lm)[1] + coef(transfer_relhtMCMT_quad_lm)[2]*x_max_relht_MCMT_quad + coef(transfer_relhtMCMT_quad_lm)[3]*(x_max_relht_MCMT_quad^2)

###no gila
transfer_relhtMCMT_quad_lm_nog <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df_nog %>% filter(name=="MCMT"))
newdata_transfer_relhtMCMT_nog <- with(relht_transfer_df_nog %>% filter(name=="MCMT"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtMCMT_predict_nog <- predict(transfer_relhtMCMT_quad_lm_nog, newdata = newdata_transfer_relhtMCMT_nog, interval="confidence")

predictdata_transfer_relhtMCMT_nog <- cbind(newdata_transfer_relhtMCMT_nog, transfer_relhtMCMT_predict_nog)

x_max_relht_MCMT_quad_nog = -coef(transfer_relhtMCMT_quad_lm_nog)[2] / (2*coef(transfer_relhtMCMT_quad_lm_nog)[3])

y_max_relht_MCMT_nog = coef(transfer_relhtMCMT_quad_lm_nog)[1] + coef(transfer_relhtMCMT_quad_lm_nog)[2]*x_max_relht_MCMT_quad_nog + coef(transfer_relhtMCMT_quad_lm_nog)[3]*(x_max_relht_MCMT_quad_nog^2)
#################
predictdata_transfer_relhtMCMT_all<- predictdata_transfer_relhtMCMT %>% mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_transfer_relhtMCMT_nog %>% mutate(model="without Gila NF"))

transfer_MCMT_plot<- ggplot()+
  geom_ribbon(data=predictdata_transfer_relhtMCMT_all, aes(x=transfer, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  scale_fill_manual(values=c("#9a5ea1","#98823c"))+
  geom_line(data=predictdata_transfer_relhtMCMT_all, aes(x=transfer,y=fit, linetype=model),linewidth=1)+
  scale_linetype_manual(values=c(1,2))+
  xlab("MCMT")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_transfer_df %>% filter(name=="MCMT")%>% mutate(fit=10), aes(x=transfer,y=fit), linewidth=1, col="black", sides="b")+
  geom_vline(xintercept = x_max_relht_MCMT_quad, col="#9a5ea1", linewidth=1)+
  theme_bw()
transfer_MCMT_plot
x_max_relht_MCMT_quad
y_max_relht_MCMT_quad
x_max_relht_MCMT_quad_nog
y_max_relht_MCMT_nog

##EMT
transfer_relht_EMT_quad <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name=="EMT"))
plot(transfer_relht_EMT_quad)
qqmath(transfer_relht_EMT_quad)
summary(transfer_relht_EMT_quad)

transfer_relhtEMT_quad_lm <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df %>% filter(name=="EMT"))
newdata_transfer_relhtEMT <- with(relht_transfer_df %>% filter(name=="EMT"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtEMT_predict <- predict(transfer_relhtEMT_quad_lm, newdata = newdata_transfer_relhtEMT, interval="confidence")

predictdata_transfer_relhtEMT <- cbind(newdata_transfer_relhtEMT, transfer_relhtEMT_predict)

x_max_relht_EMT_quad = -coef(transfer_relhtEMT_quad_lm)[2] / (2*coef(transfer_relhtEMT_quad_lm)[3])

y_max_relht_EMT_quad = coef(transfer_relhtEMT_quad_lm)[1] + coef(transfer_relhtEMT_quad_lm)[2]*x_max_relht_EMT_quad + coef(transfer_relhtEMT_quad_lm)[3]*(x_max_relht_EMT_quad^2)


###no gila
transfer_relhtEMT_quad_lm_nog <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df_nog %>% filter(name=="EMT"))
newdata_transfer_relhtEMT_nog <- with(relht_transfer_df_nog %>% filter(name=="EMT"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtEMT_predict_nog <- predict(transfer_relhtEMT_quad_lm_nog, newdata = newdata_transfer_relhtEMT_nog, interval="confidence")

predictdata_transfer_relhtEMT_nog <- cbind(newdata_transfer_relhtEMT_nog, transfer_relhtEMT_predict_nog)

x_max_relht_EMT_quad_nog = -coef(transfer_relhtEMT_quad_lm_nog)[2] / (2*coef(transfer_relhtEMT_quad_lm_nog)[3])

y_max_relht_EMT_nog = coef(transfer_relhtEMT_quad_lm_nog)[1] + coef(transfer_relhtEMT_quad_lm_nog)[2]*x_max_relht_EMT_quad_nog + coef(transfer_relhtEMT_quad_lm_nog)[3]*(x_max_relht_EMT_quad_nog^2)
#################
predictdata_transfer_relhtEMT_all<- predictdata_transfer_relhtEMT %>% mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_transfer_relhtEMT_nog %>% mutate(model="without Gila NF"))

transfer_EMT_plot<- ggplot()+
  geom_ribbon(data=predictdata_transfer_relhtEMT_all, aes(x=transfer, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  scale_fill_manual(values=c("#9a5ea1","#98823c"))+
  geom_line(data=predictdata_transfer_relhtEMT_all, aes(x=transfer,y=fit, linetype=model),linewidth=1)+
  scale_linetype_manual(values=c(1,2))+
  xlab("EMT")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_transfer_df %>% filter(name=="EMT")%>% mutate(fit=10), aes(x=transfer,y=fit), linewidth=1, col="black", sides="b")+
  geom_vline(xintercept = x_max_relht_EMT_quad, col="#9a5ea1", linewidth=1)+
  theme_bw()
transfer_EMT_plot
x_max_relht_EMT_quad
y_max_relht_EMT_quad
x_max_relht_EMT_quad_nog
y_max_relht_EMT_nog


##PPTsp
transfer_relht_PPTsp_quad <- lmer(relht ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=relht_transfer_df %>% filter(name=="PPTsp"))
plot(transfer_relht_PPTsp_quad)
qqmath(transfer_relht_PPTsp_quad)
summary(transfer_relht_PPTsp_quad)

transfer_relhtPPTsp_quad_lm <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df %>% filter(name=="PPTsp"))
newdata_transfer_relhtPPTsp <- with(relht_transfer_df %>% filter(name=="PPTsp"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtPPTsp_predict <- predict(transfer_relhtPPTsp_quad_lm, newdata = newdata_transfer_relhtPPTsp, interval="confidence")

predictdata_transfer_relhtPPTsp <- cbind(newdata_transfer_relhtPPTsp, transfer_relhtPPTsp_predict)

x_max_relht_PPTsp_quad = -coef(transfer_relhtPPTsp_quad_lm)[2] / (2*coef(transfer_relhtPPTsp_quad_lm)[3])

y_max_relht_PPTsp_quad = coef(transfer_relhtPPTsp_quad_lm)[1] + coef(transfer_relhtPPTsp_quad_lm)[2]*x_max_relht_PPTsp_quad + coef(transfer_relhtPPTsp_quad_lm)[3]*(x_max_relht_PPTsp_quad^2)

###no gila
transfer_relhtPPTsp_quad_lm_nog <- lm(relht ~  transfer + I(transfer^2) , data=relht_transfer_df_nog %>% filter(name=="PPTsp"))
newdata_transfer_relhtPPTsp_nog <- with(relht_transfer_df_nog %>% filter(name=="PPTsp"), data.frame(transfer=seq(min(transfer),max(transfer),length.out=100)))

transfer_relhtPPTsp_predict_nog <- predict(transfer_relhtPPTsp_quad_lm_nog, newdata = newdata_transfer_relhtPPTsp_nog, interval="confidence")

predictdata_transfer_relhtPPTsp_nog <- cbind(newdata_transfer_relhtPPTsp_nog, transfer_relhtPPTsp_predict_nog)

x_max_relht_PPTsp_quad_nog = -coef(transfer_relhtPPTsp_quad_lm_nog)[2] / (2*coef(transfer_relhtPPTsp_quad_lm_nog)[3])

y_max_relht_PPTsp_nog = coef(transfer_relhtPPTsp_quad_lm_nog)[1] + coef(transfer_relhtPPTsp_quad_lm_nog)[2]*x_max_relht_PPTsp_quad_nog + coef(transfer_relhtPPTsp_quad_lm_nog)[3]*(x_max_relht_PPTsp_quad_nog^2)
#################
predictdata_transfer_relhtPPTsp_all<- predictdata_transfer_relhtPPTsp %>% mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_transfer_relhtPPTsp_nog %>% mutate(model="without Gila NF"))

transfer_PPTsp_plot<- ggplot()+
  geom_ribbon(data=predictdata_transfer_relhtPPTsp_all, aes(x=transfer, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  scale_fill_manual(values=c("#9a5ea1","#98823c"))+
  geom_line(data=predictdata_transfer_relhtPPTsp_all, aes(x=transfer,y=fit, linetype=model),linewidth=1)+
  scale_linetype_manual(values=c(1,2))+
  xlab("PPTsp")+
  ylab("Relative Height Growth Rate (%/year)")+
  geom_rug(data=relht_transfer_df %>% filter(name=="PPTsp")%>% mutate(fit=10), aes(x=transfer,y=fit), linewidth=1, col="black", sides="b")+
  geom_vline(xintercept = x_max_relht_PPTsp_quad, col="#9a5ea1", linewidth=1)+
  theme_bw()
transfer_PPTsp_plot
x_max_relht_PPTsp_quad
y_max_relht_PPTsp_quad
x_max_relht_PPTsp_quad_nog
y_max_relht_PPTsp_nog

```

##Basal Area Growth Rate
```{r}
bag_transfer_df <- dbh_growth_clim_long %>% 
  rename(provenance_value=value) %>% 
  left_join(prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% 
              rename(plantation_name=name, plantation_value=value) %>% 
              dplyr::select(-c(Provenance,type)),
            by=c("name"="plantation_name")) %>% 
  mutate(transfer = provenance_value - plantation_value)

bag_transfer_df_nog <- bag_transfer_df %>% filter(!Provenance=="Gila NF")

transfer_reldbh_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relDBH ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=bag_transfer_df %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(relDBH ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=bag_transfer_df_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

transfer_reldbh_mods <- bind_rows(transfer_reldbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

transfer_reldbh_mods %>% arrange(pvalue_nog) #nothing significant


###quadratic

transfer_reldbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relDBH ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=bag_transfer_df %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(relDBH ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=bag_transfer_df_nog %>% filter(name==provenance_climvars[i]))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

transfer_reldbh_mods_quad <- bind_rows(transfer_reldbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

transfer_reldbh_mods_quad %>% arrange(pvalue2_nog) #nothing significant


```
