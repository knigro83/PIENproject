---
title: "PIEN analysis"
author: "Katie Nigro"
date: "2024-05-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up 

##Packages

```{r}
#load required packages
library(terra)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(dplyr)
library(stringr)
#library(ClimateNAr)
library(ggfortify)
library(RColorBrewer)
library(tidyr)
library(lme4)
library(lmerTest)
library(car)
library(viridis)
library(dplR)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(MuMIn)
library(vegan)
library(cluster)
library(MASS)
library(indicspecies)
library(SPEI)
library(lattice)
library(tibble)
library(pals)
library(aod)
library(interactions)
library(gridExtra)
library(climwin)
library(lubridate)
library(dichromat)
```

##Plot locations

```{r}
#read in site and provenance locations
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")
west_states<- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","California","Oregon","Washington","Kansas","Oklahoma","Texas")
westernus <- us[match(toupper(west_states),toupper(us$NAME_1)),]

canada <- geodata::gadm(country = "Canada",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")

##use coordinates adjusted based on elevation and google maps
adjusted_coords<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIEN_corrected_coords.csv")

adjusted_provs<- vect(adjusted_coords, geom=c("long_corrected","lat_corrected"), crs=crs(us))

geo.dist.df<- data.frame(Provenance = adjusted_provs$Provenance, geo.dist.to.plant.km = as.matrix(terra::distance(adjusted_provs))[,21]/1000)

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=canada)+
  geom_spatvector(data=adjusted_provs, color="maroon")

#make key for provenance names
prov_names<-adjusted_coords %>% dplyr::select(Provenance, no) %>% 
 separate_wider_delim(Provenance, delim=" ", names=c("first","second","third"), too_few = "align_start", cols_remove=FALSE) %>% 
  separate_wider_delim(first, delim= "-", names=c("first","2"), too_few="align_start") %>% 
    separate_wider_delim(second, delim= "-", names=c("second","3"), too_few="align_start") %>% 
  mutate(across(everything(), ~ replace(.x, is.na(.x), ""))) %>% 
  mutate(code=paste(substr(first,0,2),substr(`2`,0,1),substr(second,0,2),substr(`3`,0,1),third, sep="")) %>% 
  dplyr::select(c(Provenance,no,code)) %>% 
  mutate(no=as.integer(no))
```

#Climate

##ClimateNA

```{r}
#read in climate from climateNA

#first download climate normals from ClimateNA then read in to R
mastervarList <- c('mat', 'map','td','mcmt','msp','shm','nffd','bFFP','eFFP','mwmt','dd_0','dd5','emt','cmd','pas','PPT_sp','PPT_sm') #these are all the climate variables I want

# rasterDownload (region='NA',res='4000m',period='Normal_1961_1990',varList="PPT_sm",sDir='C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIENproject/ClimateNA')

normal_clim_rasters <- c()
for(i in 1:length(mastervarList)){
  normal_clim_rasters[i]<- paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIENproject/ClimateNA/NA/4000m/Normal_1961_1990/",mastervarList[i],".tif",sep="")
}

clim_raster_stack <- rast(normal_clim_rasters)

prov_clim_adjusted_bi <- terra::extract(clim_raster_stack, adjusted_provs, method='bilinear') %>% cbind(as.data.frame(adjusted_provs)) %>% cbind(crds(adjusted_provs)) %>% 
  mutate(smrpb = PPT_sm/PPT_sp, monsoonality = msp/map)

prov_clim_adjusted_bi_long<- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,MAT:PPT_sm, smrpb, monsoonality)) %>% 
  pivot_longer(MAT:monsoonality) %>% 
  mutate(type="adj bilinear") 

#nffd x map
ggplot()+
  geom_point(data=prov_clim_adjusted_bi, size=3, aes(x=nffd, y=map), col="aquamarine3")+
  geom_text(data=prov_clim_adjusted_bi, aes(x=nffd, y=map, label=Provenance), vjust=0.5, hjust=-.1)+
  theme_bw()+
  theme(legend.position = 'none')

#nffd x TD
ggplot()+
  geom_point(data=prov_clim_adjusted_bi, size=3, aes(x=nffd, y=TD), col="aquamarine3")+
  geom_text(data=prov_clim_adjusted_bi, aes(x=nffd, y=TD, label=Provenance), vjust=1)+
  theme_bw()+
  theme(legend.position = 'none')
```

```{r}
#compare climates of provenances
prov_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(Provenance,MAT:pas,smrpb)) %>% 
  left_join(prov_names) %>% 
  pivot_longer(MAT:smrpb, names_to = "var", values_to = "value")

order<- prov_clim_adjusted_bi %>% 
  arrange(y) %>% 
  pull(Provenance)

png("figures/prov_clim_plot.png", width=12, height=8, units="in", res=500)
ggplot(prov_vars, aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
dev.off()

```

##PRISM

```{r}
#read in files
ppt_comb_plantation<- read.csv("ppt_comb_plantation.csv")
tmax_comb_plantation<- read.csv("tmax_comb_plantation.csv")
tmin_comb_plantation<- read.csv("tmin_comb_plantation.csv")
tmean_comb_plantation<- read.csv("tmean_comb_plantation.csv")
vpdmax_comb_plantation<- read.csv("vpdmax_comb_plantation.csv")
vpdmin_comb_plantation<- read.csv("vpdmin_comb_plantation.csv")

ppt_comb_all<- read.csv("ppt_comb_all.csv")
tmax_comb_all<- read.csv("tmax_comb_all.csv")
tmin_comb_all<- read.csv("tmin_comb_all.csv")
tmean_comb_all<- read.csv("tmean_comb_all.csv")
vpdmax_comb_all<- read.csv("vpdmax_comb_all.csv")
vpdmin_comb_all<- read.csv("vpdmin_comb_all.csv")
```

```{r}
##calculate seasonal PRISM values

##ppt
ppt_summed <- as.data.frame(ppt_comb_plantation) %>% 
  mutate(ppt = as.numeric(ppt), year=as.integer(year)) %>%
  filter(!is.na(ppt)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(ppt = sum(ppt)) 

ggplot(ppt_summed %>% filter(CN=="Plantation"), aes(x=year, y=ppt)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(ppt_summed %>% filter(CN=="Plantation") %>% pull(ppt)), col="red")

##seasonal ppt
ppt_seasonal_plantation <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sm = sum(ppt)) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(5,6,7,8,9)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_gs = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(12,1,2)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_wt = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_fa = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sp = sum(ppt))) %>% 
  left_join(ppt_summed) 


##tmin
tmin_summed <- as.data.frame(tmin_comb_plantation) %>% 
  mutate(tmin = as.numeric(tmin), year=as.integer(year)) %>%
  filter(!is.na(tmin)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmin = mean(tmin)) 

ggplot(tmin_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmin)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmin_summed %>% filter(CN=="Plantation") %>% pull(tmin)), col="red")

##tmax
tmax_summed <- as.data.frame(tmax_comb_plantation) %>% 
  mutate(tmax = as.numeric(tmax), year=as.integer(year)) %>%
  filter(!is.na(tmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmax = mean(tmax))

ggplot(tmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmax_summed %>% filter(CN=="Plantation") %>% pull(tmax)), col="red")

##tmean
tmean_summed <- as.data.frame(tmean_comb_plantation) %>% 
  mutate(tmean = as.numeric(tmean), year=as.integer(year)) %>%
  filter(!is.na(tmean)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmean = mean(tmean)) 

ggplot(tmean_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmean)) +
  geom_point()+
  geom_hline(yintercept=mean(tmean_summed %>% filter(CN=="Plantation") %>% pull(tmean)), col="red")

##seasonal temps
all_temps <- bind_rows(tmean_comb_plantation %>% pivot_longer(tmean), tmin_comb_plantation %>% pivot_longer(tmin), tmax_comb_plantation %>% pivot_longer(tmax))

summertemps <- all_temps %>% filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sm =mean(value))
falltemps <- all_temps %>% filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_fa =mean(value))
wintertemps <- all_temps %>% filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month=="12",year+1,year)) %>% 
  filter(!year %in% c(1970,2017)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_wt =mean(value))
springtemps <- all_temps %>% filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sp =mean(value))

plantation_seasonal_temps <- left_join(summertemps,falltemps) %>% 
  left_join(wintertemps) %>% 
  left_join(springtemps)

plantation_seasonal_temps_wide<- plantation_seasonal_temps %>% 
  pivot_wider(values_from = c(value_sm,value_fa,value_wt,value_sp), names_from = name)

##vpdmax

vpdmax_summed <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(!is.na(vpdmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax = mean(vpdmax))

ggplot(vpdmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=vpdmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(vpdmax_summed %>% filter(CN=="Plantation") %>% pull(vpdmax)), col="red")

vpdmax_seasonal <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sm = mean(vpdmax)) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_fa = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month == "12", year+1, year)) %>% 
  filter(!year %in% c(1970,2017)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_wt = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sp = mean(vpdmax)))


##look at correlation in annual variables
left_join(tmean_summed,tmax_summed) %>% 
  left_join(tmin_summed) %>% 
  left_join(vpdmax_summed) %>% 
  left_join(ppt_summed) %>% 
  ungroup() %>% 
  dplyr::select(tmean:ppt) %>% 
  cor()

```
##FDSI calculation

```{r}
all_climate <- left_join(ppt_comb_plantation,tmax_comb_plantation) %>% 
  left_join(tmin_comb_plantation) %>% 
  left_join(tmean_comb_plantation) %>% 
  left_join(vpdmax_comb_plantation) %>% 
  left_join(vpdmin_comb_plantation) %>% 
  mutate(vpdmean=(vpdmin+vpdmax)/2)

nrow(all_climate)
nrow(tmin_comb_plantation)

all_climate_long <- all_climate %>% 
 dplyr::select(-X) %>% 
  pivot_longer(c("ppt","tmax","tmin","tmean","vpdmax","vpdmin","vpdmean"), names_to="climvar", values_to = "value") %>% 
  mutate(monthvar = paste(climvar,month,sep=""))

climate_minus1<- all_climate_long %>% 
  mutate(year=year+1) %>% 
  mutate(monthvar = paste("yr1",climvar,month,sep=""))

climate_minus2<- all_climate_long %>% 
  mutate(year=year+2) %>% 
  mutate(monthvar = paste("yr2",climvar,month,sep=""))

climate_allyears <- rbind(all_climate_long, climate_minus1, climate_minus2)


### FDSI CALC

### CALCULATIONS TAKEN FROM WILLIAMS ET AL., 2013 
# DOI: 10.1038/NCLIMATE1693
#https://www.nature.com/articles/nclimate1693
FDSI_C <- climate_allyears %>%
 dplyr::select(-c("date","month","climvar")) %>% 
  pivot_wider(id_cols=c("CN","year"), names_from = monthvar, values_from = value)

head(FDSI_C)

FDSI_raw<- FDSI_C %>% 
  group_by(CN, year) %>% 
  summarise(FDSIvpd=(((vpdmean5+vpdmean6+vpdmean7)/3)+(yr1vpdmean8+yr1vpdmean9+yr1vpdmean10)/3)/2, FDSIppt=log(yr1ppt11+yr1ppt12+ppt1+ppt2+ppt3))

meanVPD <- mean(FDSI_raw$FDSIvpd, na.rm=T)
meanppt <- mean(FDSI_raw$FDSIppt, na.rm=T)
SDVPD <- sd(FDSI_raw$FDSIvpd, na.rm=T)
SDppt <- sd(FDSI_raw$FDSIppt, na.rm=T)
FDSI_raw$zscoreppt <- ((FDSI_raw$FDSIppt-meanppt)/SDppt)
FDSI_raw$zscoreVPD <- ((FDSI_raw$FDSIvpd-meanVPD)/SDVPD)

FDSI_raw$FDSI <- (0.44*(FDSI_raw$zscoreppt)-0.56*(FDSI_raw$zscoreVPD))

ggplot(FDSI_raw, aes(x=year, y=FDSI))+
  geom_line()+
  geom_point()
#I think we need to consider the fact that FDSI was really high right before the drought of the early 2000's so that's why trees may not be showing equivalent growth rates after the drought (cause it was still relatively hot and dry)
```


##CWD calculation

```{r}
source("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/grad school/cwd_function_v3.r")

# #get dem
# dem_plantation <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/USGS_13_n40w107_20220216.tif")
# 
# slpasp <- terrain(dem_plantation, v = c("slope","aspect"))
# 
# slpasp_plantation <- terra::extract(slpasp, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# 
# plantation_cwd_data <- all_climate %>% left_join(as.data.frame(adjusted_provs) %>% bind_cols(crds(adjusted_provs)) %>% filter(Provenance=="Plantation"), by=c("CN"="Provenance")) %>% 
#   mutate(soilawc=116.5, foldedaspect = abs(180-abs(slpasp_plantation$aspect - 225)), slope=slpasp_plantation$slope)
# 
# write.csv(plantation_cwd_data, "plantation_cwd_data.csv")

plantation_cwd_data<- read.csv("plantation_cwd_data.csv")

plantation_cwd <- cwd_function(site="plantation",slope=plantation_cwd_data$slope, latitude=plantation_cwd_data$y, foldedaspect = plantation_cwd_data$foldedaspect, ppt = plantation_cwd_data$ppt, tmean = plantation_cwd_data$tmean, month = plantation_cwd_data$month, soilawc = plantation_cwd_data$soilawc, year = plantation_cwd_data$year, type="annual")

head(plantation_cwd)

cwd_year0 <- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month<9) %>% 
  group_by(site, year) %>% 
  summarise(cwd_1_9 = sum(cwd))

cwd_yearminus1 <-  plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month>8) %>%
  mutate(wateryear=year+1) %>% 
  group_by(site, wateryear) %>% 
  summarise(cwd_prev = sum(cwd))

wateryear_cwd<- cwd_year0 %>% 
  left_join(cwd_yearminus1, by=c("year" = "wateryear","site")) %>% 
  rowwise() %>% 
  mutate(cwd_wy = sum(cwd_1_9, cwd_prev))

sp_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd))

fa_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(cwd_fa = sum(cwd))

##water year drought
ggplot(wateryear_cwd, aes(x=year, y=cwd_wy))+
  geom_point()+
  geom_line()+
  geom_point(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_line(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_point(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")+
  geom_line(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")  ##1970s and 80s droughts were influenced more by fall lack of moisture than 2002 drought. 


##spring drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd)), aes(x=year, y=cwd_sp))+
  geom_point()+
  geom_line()

##fall drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)), aes(x=year, y=cwd_fa))+
  geom_point()+
  geom_line()

#summer drought
ggplot(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% filter(month%in%c(6,7,8)), aes(x=date, y=cwd))+
  geom_point(aes(col=factor(year)))+
  geom_line()

#number of times each month throughout the time series had CWD>0. July and August are most common times when CWD > 0, and it averages ~9mm
plantation_cwd %>% 
  filter(cwd>0) %>% 
  group_by(month) %>% 
  summarise(n=n(), mean=mean(cwd))

##summarise monthly climate on an annual basis
plantation_cwd_annual <- plantation_cwd %>% 
  group_by(site,year, soilawc) %>% 
  summarise(ppt_sum = sum(ppt), tmean_ave=mean(tmean), aet_sum=sum(aet), cwd_sum=sum(cwd))

plantation_cwd_annual_long<- plantation_cwd_annual %>% 
  left_join(FDSI_raw %>% dplyr::select(year,FDSI), by="year") %>% 
  dplyr::select(-CN) %>% 
  pivot_longer(ppt_sum:FDSI)

ggplot(plantation_cwd_annual_long %>% filter(name%in%c("cwd_sum","FDSI")), aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales = "free")
  
```

##SPEI

```{r}
##calculate SPEI - Standardized Precipitation Evapotranspiration Index
plantation_climatebalance <- plantation_cwd %>% 
  mutate(ppt_pet = ppt - petm)

plantation_spei <- spei(plantation_climatebalance %>% pull(ppt_pet), scale=1)
plantation_spei$fitted
summary(plantation_spei)

plantation_spei_sum <- data.frame(year=plantation_climatebalance$year, month=plantation_climatebalance$month, spei = plantation_spei$fitted, date = as.Date(paste(plantation_climatebalance$month,"01",plantation_climatebalance$year, sep="/"), "%m/%d/%Y"))

ggplot(plantation_spei_sum %>% filter(year > 1987 & year <2012), aes(x=date, y=spei, fill=spei>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

plantation_spei_annual<- plantation_spei_sum %>% 
  group_by(year) %>% 
  summarise(spei_mean = mean(spei), spei_sum=sum(spei))

ggplot(plantation_spei_annual %>% filter(year > 1987 & year <2012), aes(x=year, y=spei_sum, fill=spei_sum>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

##All climate vars

```{r}
#combine all climate vars

plantation_clim <- ppt_seasonal_plantation %>% 
  left_join(plantation_seasonal_temps_wide) %>% 
  left_join(vpdmax_seasonal) %>% 
  left_join(FDSI_raw) %>% 
  left_join(plantation_cwd_annual) %>% 
  left_join(wateryear_cwd) %>% 
  left_join(plantation_spei_annual)

colnames(plantation_clim)

plantation_clim_long <- plantation_clim %>% 
dplyr::select(c(CN:vpdmax_sp, FDSI, aet_sum, cwd_sum, cwd_wy, spei_sum)) %>% 
  pivot_longer(ppt_sm:spei_sum)
```

##Climate extremes

```{r}
plantation_clim_long_qs<- plantation_clim_long %>% 
  left_join(plantation_clim_long %>% 
  filter(!is.na(value)) %>% 
  group_by(name) %>% 
  summarise(q2.5 = quantile(value, 0.025), q97.5 = quantile(value, 0.975), out.hi = quantile(value, c(0.75))  + IQR(value)*1.5, out.low = quantile(value, c(0.75)) - IQR(value)*1.5))

data.frame(climvar = unique(plantation_clim_long_qs$name)) %>% write.csv("plantation_clim_vars.csv")
##look at years where each climate variable exceeded the 97.5th (or 2.5th) percentile - these are years of potentially extreme climate 
ggplot(plantation_clim_long_qs, aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.hi), col="black")

###############
## identify drought year
###############
unique(plantation_clim_long_qs$name)

plantation_clim_xtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("ppt_sm","ppt_gs","ppt_wt","ppt_fa","ppt_sp","ppt","FDSI","aet") & value < out.low, "yes",
                          ifelse(name %in% c("value_sm_tmax","value_sm_tmean","value_sm_tmin","value_fa_tmax","value_fa_tmean","value_fa_tmin","value_wt_tmax","value_wt_tmean","value_wt_tmin","value_sp_tmax","value_sp_tmean","value_sp_tmin","vpdmax_sm","vpdmax_fa","vpdmax_wt","vpdmax_sp","cwd_sum","cwd_wy","spei_sum") & value > out.hi, "yes", "no" 
  ))) %>% 
  filter(extreme=="yes")

View(plantation_clim_xtremes)

plantation_clim_xtremes %>% 
  group_by(year) %>% 
  summarise(n=n()) ##2002 has the highest # of climate vars outside the extreme.
```


##K Means

```{r}
##group provenances and plantation site into "climate groups"

#first look at correlations in climate variables
env_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(MAT:pas,smrpb))

prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Gila NF") %>% 
  dplyr::select(c(MAT:pas,smrpb,y)) %>% 
  cor()

env_vars %>% 
  cor() %>% 
  ggcorrplot()

env_vars %>% 
  cor() %>% 
  abs()>0.9

env_vars_cut <- env_vars %>% 
  dplyr::select(-c(bFFP, eFFP, EMT, pas, dd5, dd_0))

env_vars_cut %>%
  cor() %>% 
  abs()>0.9

#look at linearity of relationships

pairs(env_vars_cut, lower.panel = NULL)

prov_clim_adjusted_bi_wide <- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,MAT:PPT_sm, smrpb, monsoonality))

rownames(prov_clim_adjusted_bi_wide)<- prov_clim_adjusted_bi_wide$Provenance

adjbi_prov_clim_eucdist <- vegdist(prov_clim_adjusted_bi_wide %>% dplyr::select(colnames(env_vars_cut)) %>% as.data.frame(), method="euclidean")

pam4<-pam(adjbi_prov_clim_eucdist,k=4)
pam4
pam4$clustering #view cluster membership
pam4$clusinfo
plot(pam4)

pam5<-pam(adjbi_prov_clim_eucdist,k=5)
pam5
pam5$clustering #view cluster membership
pam5$clusinfo
plot(pam5)

pam6<-pam(adjbi_prov_clim_eucdist,k=6)
pam6
pam6$clustering #view cluster membership
pam6$clusinfo
plot(pam6)

pam7<-pam(adjbi_prov_clim_eucdist,k=7)
pam7
pam7$clustering #view cluster membership - I think this is the best
pam7$clusinfo
plot(pam7)

pam8<-pam(adjbi_prov_clim_eucdist,k=8)
pam8
pam8$clustering #view cluster membership
pam8$clusinfo
plot(pam8)

pam7$silinfo$avg.width #7 groups best by this metric
pam6$silinfo$avg.width 
pam5$silinfo$avg.width
pam8$silinfo$avg.width


```


##PCA

```{r, echo = FALSE}
#run the PCA 
set.seed(83)
clim_pca <- prcomp(env_vars_cut,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals <- (clim_pca$sdev)^2
eigenvals
sum(eigenvals) #the sum of the eigenvalues = the number of variables (9)
eigenvals/sum(eigenvals)#this is the proportion variance explained
summary(clim_pca)
par(mfrow=c(1,1))
plot(clim_pca,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca$rotation[,1:2]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca$rotation[,1:2]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts<- clim_pca$x %>% 
  cbind(prov_clim_adjusted_bi) %>% 
  left_join(prov_names) %>% 
  left_join(data.frame(cluster=pam7$clustering) %>% mutate(Provenance=rownames(data.frame(cluster=pam7$clustering))))

autoplot(clim_pca,x=1,y=2,colour="aquamarine3",loadings.colour="red", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.size=4)+
  geom_point(data=prov_pcapts, aes(x=PC1, y=PC2, col=factor(cluster)), size=5)+
  geom_text_repel(data=prov_pcapts, aes(x=PC1, y=PC2, label=code))+
  theme(text=element_text(size=14, color="black"))
  
autoplot(clim_pca,x=1,y=3,colour="aquamarine3",loadings.colour="red", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.size=6)+
  geom_point(data=prov_pcapts, aes(x=PC1, y=PC3, col=factor(cluster)), size=5)+
  geom_text_repel(data=prov_pcapts, aes(x=PC1, y=PC3, label=code))+
  theme(text=element_text(size=14, color="black"))
  
canada_crop <- crop(canada, ext(-126.92, -97.23, 41.6769, 52))

map<- ggplot()+
  geom_spatvector(data=westernus, col="grey", fill="gray100")+
  geom_spatvector(data=canada_crop, col="grey", fill="gray100")+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(!Provenance == "Plantation"), aes(fill=factor(Provenance, levels=provs_bylat$Provenance)), shape=24, size=1.5)+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(Provenance == "Plantation"), color="black", size=1.5)+
  geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(!Provenance == "Plantation"), aes(label=code), hjust=c(1.2,-.2,-.2,1.1,-.2,-.2,1,.1,0,1.2,-0.2,1.0, 1.1,1.0,0,1,-0.2,1.2,1,1.2), vjust=c(.4,0,0,0,0,0,1.3,1.4,1.3,rep(0,5),1.3,0,-.2,0,0,0), size=2.5)+
    geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(Provenance == "Plantation"), aes(label="Plantation"), hjust = 1, vjust=-0.4, col="black", size=2.5)+
  theme(panel.grid = element_blank(), legend.position = "none", axis.title=element_blank(), axis.text = element_text(color="black", size=6))+
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("black", "white"),
      height = unit(0.1, "cm"),
    text_cex = 0.5) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style=north_arrow_fancy_orienteering(text_size=8, line_width = 0.8),
    height=unit(.25, "in"),
    width=unit(.25, "in"))

# png("figures/map.png", width=3, height=3, res=300, units = "in")
# map
# dev.off()

prov_pcapts_onlyprovs<- prov_pcapts %>% 
  filter(!Provenance=="Plantation")

provs_bylat <- prov_pcapts_onlyprovs %>% arrange(y)


pcaplot <- autoplot(clim_pca,x=1,y=2,colour=NA,loadings.colour="gray80", loadings=T, loadings.label=T, loadings.label.colour="darkgrey", scale=0, loadings.label.size=2.5, loadings.label.hjust=1, loadings.label.vjust=1)+
  geom_point(data=prov_pcapts_onlyprovs, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=prov_pcapts_onlyprovs, aes(x=PC1, y=PC2, label=code), size=2,
            hjust = c(1.2,
                      0.5,
                      .5,
                      0.5,
                      0.5,
                      1.2,
                      0.7,
                      .2,
                      1,
                      1,
                      0,
                      1,
                      1,
                      -.2,
                      1.2,
                      0.5,
                      0,
                      -.4,
                      0.5,
                      -.2),
            vjust = c(0,
                      -1,
                      1.4,
                      1.4,
                      -1,
                      0,
                      1.4,
                      1.4,
                      0,
                      1.4,
                      -1,
                      1.4,
                      1.4,
                      0,
                      0,
                      1.4,
                      1.4,
                      .2,
                      -1,
                      0))+
  theme(text=element_text(size=14, color="black"))+
  geom_point(data=prov_pcapts %>% filter(Provenance=="Plantation"), aes(x=PC1, y=PC2), col="black", size=1.5)+
  geom_text(data=prov_pcapts %>% filter(Provenance=="Plantation"), aes(x=PC1, y=PC2, label=Provenance), size=2, hjust=0, vjust=1.4)+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))
#   
# png("figures/pcaplot.png", width=3, height=3, res=300, units = "in")
# pcaplot
# dev.off()

```

```{r}
plantation_pc1<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC1)

plantation_pc2<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC2)

pca_dist_df <- prov_pcapts %>% 
  mutate(PC1diff = abs(PC1-plantation_pc1), PC2diff = abs(PC2 - plantation_pc2)) %>% 
  mutate(dist.to.plant = sqrt(PC1diff^2 + PC2diff^2)) %>% 
  arrange(dist.to.plant) %>% 
  filter(!Provenance=="Plantation")
```


##PIEN climate niche

```{r}
pien <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/pien_range.tif")

us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps")
states=c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","Kansas")
interiorwest <- us[match(toupper(states),toupper(us$NAME_1)),]


pien2 <- classify(pien, cbind(-Inf, 0, NA), right=TRUE)
plot(pien2)

pien_trim<- trim(pien2)
plot(pien_trim)

pien_IW<- crop(pien_trim %>% project(crs(interiorwest)), interiorwest)
plot(pien_IW)

pien_uniform <- classify(pien_IW, cbind(-Inf,Inf,1))
plot(pien_uniform)

pien_poly <- as.polygons(pien_uniform)
plot(pien_poly)

# engelmann_clim <- terra::extract(clim_raster_stack, pien_poly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)
# 
# ##extract PRISM data for summer/spring precip ratio
# ppt_data_pien<-vector()
# for(j in 1:length(months)){
#   raster<-paste(climdir,'/PRISM_ppt_30yr_normal_800mM4_all_bil/PRISM_ppt_30yr_normal_800mM4_',months[j],'_bil.bil',sep="")
#   rast <- rast(raster)
#   ext.poly <- terra::extract(rast,pien_poly %>% project(crs(clim_raster_stack)), method="simple", weights = TRUE, df=TRUE)
#   ppt<-ext.poly[,2]
#   ID<- seq(1:nrow(ext.poly))
#   month <- rep(months[j],length(ext.poly[,2]))
#   ppt_CN<-cbind(ID,ppt,month)
#   ppt_data_pien<-rbind(ppt_data_pien,ppt_CN)}
# 
# pien_ppt_sum<- ppt_data_pien %>%
#   as.data.frame() %>%
#   unique() %>%
#   mutate(ppt=as.numeric(ppt), ID = as.numeric(ID)) %>%
#   pivot_wider(id_cols=ID, names_from=month, values_from = ppt) %>%
#   rowwise() %>%
#   mutate(JA_ppt = sum(`07`,`08`, na.rm=T), smrpb = sum(`07`,`08`,`09`,na.rm=T)/sum(`04`,`05`,`06`, na.rm=T))
# 
# saveRDS(pien_ppt_sum, "pien_ppt_sum.RDS")
# saveRDS(engelmann_clim, "engelmann_clim.RDS")

pien_ppt_sum <- readRDS("pien_ppt_sum.RDS")

#clim_pien <- left_join(engelmann_clim, pien_ppt_sum) ##not sure how to do this with polygons and weights

engelmann_clim <- readRDS("engelmann_clim.RDS")

plantation_only <- prov_pcapts %>% filter(Provenance == "Plantation")

ggplot(engelmann_clim, aes(x=MAT, y=map))+
  geom_hex(alpha=0.7)+
  scale_fill_gradientn(colors=c("gray","black"))+
  geom_point(data=prov_pcapts %>% filter(!Provenance=="Plantation"), aes(x=MAT, y=map, col=Provenance), size=4)+
  ggrepel::geom_text_repel(data=prov_pcapts %>% filter(!Provenance=="Plantation"), aes(label=code))+
  geom_point(data=plantation_only, aes(x=MAT, y=map), size=4, col="gold", shape=18)+
  ggrepel::geom_text_repel(data=plantation_only, aes(label=code))+
  scale_color_manual(values=unname(stepped()))+
  theme_bw()+
  theme(text = element_text(size=16, color="black"))
```

#Response variables

##DBH

```{r}
##DBH data is in centimeters
dbh <- read.csv("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Analysis/RWI_data/DBH_data.csv")

moniger_data <- read.csv("past_moniger_data.csv")
moniger_data_ids <- read.csv("past_moniger_data_ids.csv")

head(moniger_data_ids)
head(moniger_data)

moniger_data_comb <- moniger_data %>% 
  left_join(moniger_data_ids, by=c("LOC" = "ID.Code")) %>% 
  mutate(Provenance = ifelse(Location == "Larimer County 1","Larimer 1",
                                    ifelse(Location == "Larimer County 2","Larimer 2",Location))) %>% 
  left_join(prov_pcapts)

dbh = moniger_data_comb %>% 
  dplyr::select(c(SORT, LOC, BLK, REP, DBH91, DBH96, DBH06, DBH14, Provenance, code)) %>% 
  mutate(Series = paste(LOC,BLK,REP,sep="")) 

name_conversion<- data.frame(oldname = dbh %>% arrange(Provenance) %>% pull(Provenance) %>% unique(),
           newname = prov_names %>% filter(!Provenance=="Plantation") %>%  arrange(Provenance) %>% pull(Provenance) %>% unique())

dbh_long<- dbh %>% 
  #left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  #dplyr::select(-Provenance) %>% 
  #rename(Provenance = newname) %>% 
  filter(!is.na(DBH91)) %>% 
  pivot_longer(DBH91:DBH14, names_to = 'year', values_to = 'DBH')

provs_arranged_lat<- prov_pcapts %>% 
  arrange(y) %>% 
  pull(Provenance)
provs_arranged_lat

dbh_clim_data <- dbh_long %>% 
  left_join(prov_pcapts) %>% 
  filter(!is.na(DBH)) %>% 
  filter(!DBH==0) ##there is one with a dbh value of 0 which seems like an error.


#arranging provenances by different variables to visually identify patterns in DBH
ggplot(dbh_long, aes(x=factor(Provenance, levels=provs_arranged_lat), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

ggplot(dbh_clim_data, aes(x=factor(nffd), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

ggplot(dbh_clim_data, aes(x=factor(cmd), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

```

###models

####ANOVA

```{r}
dbh_numeric <- dbh_clim_data %>% 
  mutate(num.yr = as.numeric(ifelse(year=="DBH91", 1,
                         ifelse(year=="DBH96", 6,
                                ifelse(year=="DBH06", 16,
                                       ifelse(year=="DBH14", 24, year))))))

dbh_aov <- lm(DBH ~ year*Provenance, data = dbh_numeric)
par(mfrow=c(2,2))
plot(dbh_aov)
anova(dbh_aov) #no significant interaction
Anova(dbh_aov, type="3")
dbh_aov_noint <- lm(DBH ~ year + Provenance, data = dbh_numeric)
Anova(dbh_aov_noint, type="2") #both year and provenance are significant but do not interact (relatively similar order of provenance DBH in each year measured)

prov_dbh_order<- dbh_numeric %>% 
  filter(year=="DBH14") %>% 
  group_by(Provenance) %>% 
  summarise(med_DBH = median(DBH, na.rm=T)) %>% 
  arrange(med_DBH)

dbh_early<- ggplot(dbh_numeric %>% filter(!year=="DBH14"), aes(x=factor(year, levels=c("DBH91","DBH96","DBH06"), labels=c(1991,1996,2006)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_x_discrete(name="Year")

dbh_2014<- ggplot(dbh_numeric %>% filter(year=="DBH14"), aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_x_discrete(name="Year")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()

ggarrange(dbh_early,dbh_2014, nrow=2, common.legend = TRUE)

dbh_plot<- ggplot(dbh_numeric %>% filter(year=="DBH14"), aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  #geom_text(data=data.frame(Provenance = c("Gila NF","Dixie NF","Cutting Permit 31"), symbol = c("B","B","A")), aes(x=Provenance, y=25, label=symbol))+
  theme_bw()+
  theme(legend.position = "none", axis.text.x = element_text(angle=45, color="black", size=8, hjust=1), axis.title.x = element_blank(), axis.text.y = element_text(color="black", size=8), axis.title.y = element_text(color="black", size=10))

###model each year separately
dbh_aov91 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH91"))
plot(dbh_aov91)
summary(dbh_aov91)
TukeyHSD(dbh_aov91)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)
 
dbh_aov96 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH96"))
plot(dbh_aov96)
summary(dbh_aov96)
TukeyHSD(dbh_aov96)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)
  
dbh_aov06 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH06"))
plot(dbh_aov06)
summary(dbh_aov06)
TukeyHSD(dbh_aov06)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)
  
dbh_aov14 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH14"))
plot(dbh_aov14)
summary(dbh_aov14)
pairwise_dbh14 <- TukeyHSD(dbh_aov14)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05) %>% 
  mutate(comp=rownames(TukeyHSD(dbh_aov14)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05))) %>% 
  mutate(payette = grepl( "Payette", comp, fixed = TRUE),
         gila = grepl("Gila", comp, fixed = TRUE)) 

pairwise_dbh14 %>% 
  filter(payette == TRUE) %>% nrow()
pairwise_dbh14 %>% 
  filter(gila == TRUE) %>% nrow()

```

####distance
```{r}
##does DBH vary with climate vars?


#just get most recent DBH measurement 
dbh_num14 <- dbh_numeric %>% filter(year=="DBH14")
##distance in PCA space from plantation
dbh_num14_pcadist<- dbh_num14 %>% 
  left_join(pca_dist_df %>% dplyr::select(code, dist.to.plant))


#distance models
dbh_num14_alldist <- dbh_num14_pcadist %>% 
  left_join(geo.dist.df)

dbh_num14_alldist %>% dplyr::select(PC1,PC2,dist.to.plant,geo.dist.to.plant.km,x,y) %>% cor()

dbh_num14_alldist_noG <- dbh_num14_alldist %>% 
  filter(!Provenance=="Gila NF")

mod_dbh_dist <- lmer(DBH ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant) + (1|Provenance), data=dbh_num14_alldist)
plot(mod_dbh_dist)
qqmath(mod_dbh_dist)
summary(mod_dbh_dist)
options(na.action="na.fail")
dredge(mod_dbh_dist)

mod_dbh_dist2 <- lmer(DBH ~ scale(geo.dist.to.plant.km)+scale(dist.to.plant) + (1|Provenance), data=dbh_num14_alldist)
plot(mod_dbh_dist2)
qqmath(mod_dbh_dist2)
summary(mod_dbh_dist2)

mod_dbh_dist2_noG <- lmer(DBH ~ scale(geo.dist.to.plant.km)+scale(dist.to.plant) + (1|Provenance), data=dbh_num14_alldist_noG)
plot(mod_dbh_dist2_noG)
qqmath(mod_dbh_dist2_noG)
summary(mod_dbh_dist2_noG)

ggplot(dbh_num14_alldist, aes(x=geo.dist.to.plant.km, y=DBH, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(dbh_num14_alldist, aes(x=dist.to.plant, y=DBH, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

##predict model
mod_dbh_dist2_lm <- lm(DBH ~ scale(geo.dist.to.plant.km)+scale(dist.to.plant), data=dbh_num14_alldist)

dbh_dist_newdata <- with(dbh_num14_alldist, data.frame(geo.dist.to.plant.km = seq(min(geo.dist.to.plant.km),max(geo.dist.to.plant.km),length.out=100), 
                                                       dist.to.plant = mean(dist.to.plant)))
dbh_dist_predict <- predict(mod_dbh_dist2_lm, newdata=dbh_dist_newdata, interval="confidence")

dbh_dist_pred_data <- cbind(dbh_dist_newdata,dbh_dist_predict)

dbh_dist_plot <- ggplot()+
  geom_point(data=dbh_num14_alldist, aes(x=geo.dist.to.plant.km, y=DBH, col=factor(Provenance, levels=factor(provs_bylat$Provenance))))+
  geom_ribbon(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=dbh_dist_pred_data, aes(x=geo.dist.to.plant.km,y=fit), color="black")+
  xlab("Geographic distance to plantation (km)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position = "none")


```

####PCA
```{r}
##PCs and x 
mod_dbh_pca_x <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance), data=dbh_num14_alldist)
plot(mod_dbh_pca_x)
qqmath(mod_dbh_pca_x)
summary(mod_dbh_pca_x)
dredge(mod_dbh_pca_x)

bestmod_dbh_pca_x <- lmer(DBH ~ PC2 + I(PC2^2) + scale(x) + (1|Provenance), data=dbh_num14_alldist)
summary(bestmod_dbh_pca_x)

mod_dbh_pca_x_nog <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance), data=dbh_num14_alldist_noG)
plot(mod_dbh_pca_x_nog)
qqmath(mod_dbh_pca_x_nog)
summary(mod_dbh_pca_x_nog)
dredge(mod_dbh_pca_x_nog)

bestmod_dbh_pca_x_nog <- lmer(DBH ~ PC2 + I(PC2^2) + scale(x) + (1|Provenance), data=dbh_num14_alldist_noG)
summary(bestmod_dbh_pca_x_nog) #null model was better than this though so not a strong effect. 

##PCs and y 
mod_dbh_pca_y <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance), data=dbh_num14_alldist)
plot(mod_dbh_pca_y)
qqmath(mod_dbh_pca_y)
summary(mod_dbh_pca_y)
dredge(mod_dbh_pca_y)

AICc(mod_dbh_pca_x, mod_dbh_pca_y)

bestmod_dbh_pca_y <- lmer(DBH ~ PC1 + I(PC1^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=dbh_num14_alldist)
summary(bestmod_dbh_pca_y)

ggplot(dbh_num14_alldist, aes(x=y, y=DBH))+
  geom_point()

mod_dbh_pca_y_nog <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance), data=dbh_num14_alldist_noG)
plot(mod_dbh_pca_y_nog)
qqmath(mod_dbh_pca_y_nog)
summary(mod_dbh_pca_y_nog)
dredge(mod_dbh_pca_y_nog)

bestmod_dbh_pca_y_nog <- lmer(DBH ~ scale(y) + I(scale(y)^2) + (1|Provenance), data=dbh_num14_alldist_noG)
summary(bestmod_dbh_pca_y_nog) #quadratic y effect is significant when you take out Gila

###make plot
bestmod_dbh_pca_y_nog_lm <- lm(DBH ~ scale(y) + I(scale(y)^2), data=dbh_num14_alldist_noG)
newdata_dbh <- with(dbh_num14_alldist_noG, data.frame(y=seq(min(y),max(y),length.out=100)))

dbh_predict <- predict(bestmod_dbh_pca_y_nog_lm, newdata = newdata_dbh, interval="confidence")

predictdatadbh <- cbind(newdata_dbh, dbh_predict)

dbh_lat_plot <- ggplot()+
  geom_point(data=dbh_num14_alldist, aes(x=y, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdatadbh, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdatadbh, aes(x=y,y=fit), color="black")+
  xlab("Latitude")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position="none")

ggarrange(dbh_dist_plot, dbh_lat_plot, common.legend = TRUE)
```

####extra models
```{r}

colnames(dbh_num14)

provenance_climvars <- dbh_num14 %>% 
  dplyr::select(MAT:PPT_sm, smrpb, monsoonality) %>% 
  colnames()

dbh_num14_long <- dbh_num14 %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality))

dbh_mods<- data.frame()
dbh_num14_nog <- dbh_num14 %>% filter(!Provenance=="Gila NF")
for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + (1|Provenance), data=dbh_num14_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + (1|Provenance), data=dbh_num14_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

dbh_mods <- bind_rows(dbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

dbh_mods %>% arrange(pvalue)

###quadratic

dbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance), data=dbh_num14_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance), data=dbh_num14_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_mods_quad <- bind_rows(dbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

dbh_mods_quad %>% arrange(pvalue2_nog) #nothing significant
```

##Height Growth

```{r}

colnames(moniger_data_comb)

ggplot(moniger_data_comb, aes(x=factor(cmd), y=HT14, fill=Provenance))+
  geom_boxplot()+
  theme(legend.position = 'right', axis.text.x = element_text(angle=45, hjust=1))

ht_data <- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  mutate(growth.m = (value-nursery_ht_m), rel.growth = (value-nursery_ht_m)/nursery_ht_m) %>% 
  filter(!is.na(value))

ht_data_clim <- ht_data %>% 
  left_join(prov_pcapts)

ht.order <- ht_data %>% 
  filter(name=="HT14") %>% 
  group_by(Provenance) %>% 
  summarise(med_rel_growth=median(rel.growth,na.rm=T), med_growth=median(growth.m, na.rm=T), meanht = mean(value, na.rm=T)) %>% 
  arrange(meanht)

#relative growth
ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(Provenance, levels=ht.order$Provenance), y=rel.growth, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), scales="free")+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")+
  theme(axis.text.x = element_blank())

#growth
ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(Provenance, levels=ht.order$Provenance), y=growth.m, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), scales="free")+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")+
  theme(axis.text.x = element_blank())


ht_data_aves <- ht_data %>% filter(!name=="HT74") %>% 
  group_by(name, Provenance,nursery_ht_m ) %>% 
  summarise(meangrowth = mean(growth.m), seRG = sd(growth.m)/sqrt(n()), meantotht = mean(value), seTH = sd(value)/sqrt(n()))

ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=growth.m, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meangrowth-seRG, ymax=meangrowth+seRG, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Average relative growth ratio")

##initial height effect on height growth -- looks like there isn't really one
ggplot(data=ht_data_aves, aes(x=nursery_ht_m, y=meangrowth))+
  geom_point()

ggplot(data=ht_data_aves, aes(x=nursery_ht_m, y=meantotht))+
  geom_point()

```

##Total Height

###models

```{r}
##effect of initial nursery height
ht_data_year <-  ht_data %>% mutate(year=case_when(
  name=="HT74" ~ 1974,
  name == "HT79" ~ 1979,
  name == "HT85" ~ 1985,
  name == "HT91" ~ 1991,
  name == "HT96" ~ 1996,
  name == "HT06" ~ 2006,
  name == "HT14" ~ 2014))

nurse_ht_mod <- lmer(log(value) ~ nursery_ht_m*factor(year) + (1|Provenance), data=ht_data_year)
plot(nurse_ht_mod)
qqmath(nurse_ht_mod)
summary(nurse_ht_mod)  
Anova(nurse_ht_mod, type="3")

##predict
nurse_ht_mod_lm <- lm(log(value) ~ nursery_ht_m*factor(year), data=ht_data_year)

new_nurseht_data <- with(ht_data_year, data.frame(nursery_ht_m=seq(min(nursery_ht_m),max(nursery_ht_m), length.out=50), year = rep(unique(ht_data_year$year), each=50)))
nurse_predict <- predict(nurse_ht_mod_lm, newdata=new_nurseht_data, interval="confidence")

nurse_predict_data <- cbind(new_nurseht_data, nurse_predict)

ggplot()+
  geom_point(data=ht_data_year, aes(x=nursery_ht_m, y=log(value), col=factor(year)))+
  geom_ribbon(data=nurse_predict_data, aes(x=nursery_ht_m, ymin=lwr, ymax=upr, fill=factor(year)), alpha=0.5)+
  geom_line(data=nurse_predict_data, aes(x=nursery_ht_m, y=fit, col=factor(year)))
  #facet_wrap(~year)

##no Gila
nurse_ht_mod_nog <- lmer(log(value) ~ nursery_ht_m*factor(year) + (1|Provenance), data=ht_data_year %>% filter(!Provenance=="Gila NF"))
plot(nurse_ht_mod_nog)
qqmath(nurse_ht_mod_nog)
summary(nurse_ht_mod_nog)  

##predict
ht_data_year_nog <- ht_data_year %>% filter(!Provenance=="Gila NF")

nurse_ht_mod_nog_lm <- lm(log(value) ~ nursery_ht_m*factor(year), data=ht_data_year_nog)

new_nurseht_data_nog <- with(ht_data_year_nog, data.frame(nursery_ht_m=seq(min(nursery_ht_m),max(nursery_ht_m), length.out=50), year = rep(unique(ht_data_year$year), each=50)))
nurse_predict_nog <- predict(nurse_ht_mod_nog_lm, newdata=new_nurseht_data_nog, interval="confidence")

nurse_predict_data_nog <- cbind(new_nurseht_data_nog, nurse_predict_nog)

ggplot()+
  geom_point(data=ht_data_year, aes(x=nursery_ht_m, y=log(value)))+
  geom_ribbon(data=nurse_predict_data_nog, aes(x=nursery_ht_m, ymin=lwr, ymax=upr, fill=factor(year)), alpha=0.5)+
  geom_line(data=nurse_predict_data_nog, aes(x=nursery_ht_m, y=fit, col=factor(year)))+
  facet_wrap(~year)
#### 

#1974
nurse_ht_mod74 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT74"))
plot(nurse_ht_mod74)
qqmath(nurse_ht_mod74)
summary(nurse_ht_mod74)  ##significant 

#1979
nurse_ht_mod79 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT79"))
plot(nurse_ht_mod79)
qqmath(nurse_ht_mod79)
summary(nurse_ht_mod79)  ##no effect of nursery height on total height in 1979 

#1985
nurse_ht_mod85 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT85"))
plot(nurse_ht_mod85)
qqmath(nurse_ht_mod85)
summary(nurse_ht_mod85)  ##no effect of nursery height on total height in 1985 

#1991
nurse_ht_mod91 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT91"))
plot(nurse_ht_mod91)
qqmath(nurse_ht_mod91)
summary(nurse_ht_mod91)  ##no effect of nursery height on total height in 1991 

#1996
nurse_ht_mod96 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT96"))
plot(nurse_ht_mod96)
qqmath(nurse_ht_mod96)
summary(nurse_ht_mod96)  ##no effect of nursery height on total height in 1996 

#2006
nurse_ht_mod06 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT06"))
plot(nurse_ht_mod06)
qqmath(nurse_ht_mod06)
summary(nurse_ht_mod06)  ##no effect of nursery height on total height in 2006 

#2014
nurse_ht_mod14 <- lmer(value ~ nursery_ht_m + (1|Provenance), data=ht_data %>% filter(name=="HT14"))
plot(nurse_ht_mod14)
qqmath(nurse_ht_mod14)
summary(nurse_ht_mod14)  ##no effect of nursery height on total height in 2014. 

##effect of year * provenance
par(mfrow=c(2,2))
plot(lm(value ~ Provenance*name, data=ht_data))

totht_mod <- lm(log(value) ~ Provenance*name, data=ht_data)
par(mfrow=c(2,2))
plot(totht_mod)
anova(totht_mod) ##there is a significant year by provenance interaction

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meantotht-seTH, ymax=meantotht+seTH, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Total Height (m)")


#each year separately
totht_mod74 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
summary(totht_mod74)
TukeyHSD(totht_mod74)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod79 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT79"))
plot(totht_mod79)
summary(totht_mod79)
TukeyHSD(totht_mod79)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod85 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT85"))
plot(totht_mod85)
summary(totht_mod85)
TukeyHSD(totht_mod85)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod91 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
summary(totht_mod74)
TukeyHSD(totht_mod74)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod96 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT96"))
plot(totht_mod96)
summary(totht_mod96)
TukeyHSD(totht_mod96)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod06 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT06"))
plot(totht_mod06)
summary(totht_mod06)
TukeyHSD(totht_mod06)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod14 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT14"))
plot(totht_mod14)
summary(totht_mod14)
TukeyHSD(totht_mod14)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

```

####distance
```{r}

ht_data_clim14 <- ht_data_clim %>% 
  filter(name=="HT14") %>% 
  left_join(pca_dist_df %>% dplyr::select(code, dist.to.plant)) %>% 
  left_join(geo.dist.df)

ht_data_clim14_nog <- ht_data_clim14 %>% filter(!Provenance=="Gila NF")

## Distance model
ht_dist_mod <- lmer(value ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant) + (1|Provenance), data=ht_data_clim14)
plot(ht_dist_mod)
qqmath(ht_dist_mod)
summary(ht_dist_mod)

ggplot(data=ht_data_clim14, aes(x=dist.to.plant, y=value))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(data=ht_data_clim14, aes(x=geo.dist.to.plant.km, y=value))+
  geom_point()+
  geom_smooth(method="lm")

ht_dist_mod_nog <- lmer(value ~ scale(geo.dist.to.plant.km)*scale(dist.to.plant) + (1|Provenance), data=ht_data_clim14_nog)
plot(ht_dist_mod_nog)
qqmath(ht_dist_mod_nog)
summary(ht_dist_mod_nog)

ggplot(data=ht_data_clim14_nog, aes(x=dist.to.plant, y=value, col=geo.dist.to.plant.km>800))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(data=ht_data_clim14_nog, aes(x=geo.dist.to.plant.km, y=value))+
  geom_point()+
  geom_smooth(method="lm")
ggplot(data=ht_data_clim14_nog, aes(x=dist.to.plant, y=value))+
  geom_point()+
  geom_smooth(method="lm")

ht_dist_plot<- interact_plot(ht_dist_mod_nog, pred=dist.to.plant, modx=geo.dist.to.plant.km, plot.points = TRUE, interval = TRUE, int.width = 0.95, colors="blue2", data=ht_data_clim14)+
  xlab("Climatic distance to plantation")+
  ylab("Height (m)")+
  theme_bw()+
  theme(legend.position = "none")

```

####PCA

```{r}

##PCs and x 
mod_ht_pca_x <- lmer(value ~ PC1*PC2 + PC1*x + PC2*x + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance), data=ht_data_clim14)
plot(mod_ht_pca_x)
qqmath(mod_ht_pca_x)
summary(mod_ht_pca_x)
dredge(mod_ht_pca_x)

bestmod_ht_pca_x <- lmer(value ~ PC1 + I(PC1^2) + (1|Provenance), data=ht_data_clim14)
summary(bestmod_ht_pca_x)

ggplot(data=ht_data_clim14, aes(x=PC1, y=value))+
  geom_point()

mod_ht_pca_x_nog <- lmer(value ~ PC1*PC2 + PC1*x + PC2*x + I(PC1^2) + I(PC2^2) + I(scale(x)^2) + (1|Provenance), data=ht_data_clim14_nog)
plot(mod_ht_pca_x_nog)
qqmath(mod_ht_pca_x_nog)
summary(mod_ht_pca_x_nog)
dredge(mod_ht_pca_x_nog) ##null model is best when Gila is removed


##PCs and y 
mod_ht_pca_y <- lmer(value ~ PC1*PC2 + PC1*y + PC2*y + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance), data=ht_data_clim14)
plot(mod_ht_pca_y)
qqmath(mod_ht_pca_y)
summary(mod_ht_pca_y)
dredge(mod_ht_pca_y)

AICc(mod_ht_pca_x, mod_ht_pca_y) #y is lower

bestmod_ht_pca_y <- lmer(value ~ PC1 + I(PC1^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=ht_data_clim14)
summary(bestmod_ht_pca_y)

ggplot(ht_data_clim14, aes(x=y, y=value))+
  geom_point()
ggplot(ht_data_clim14, aes(x=PC1, y=value))+
  geom_point()

mod_ht_pca_y_nog <- lmer(value ~ PC1*PC2 + PC1*y + PC2*y + I(PC1^2) + I(PC2^2) + I(scale(y)^2) + (1|Provenance), data=ht_data_clim14_nog)
plot(mod_ht_pca_y_nog)
qqmath(mod_ht_pca_y_nog)
summary(mod_ht_pca_y_nog)
dredge(mod_ht_pca_y_nog)

bestmod_ht_pca_y_nog <- lmer(value ~ y + I(scale(y)^2) + (1|Provenance), data=ht_data_clim14_nog)
summary(bestmod_ht_pca_y_nog) #quadratic y effect still significant when you take out Gila

###make plot
bestmod_ht_pca_y_nog_lm <- lm(value ~ scale(y) + I(scale(y)^2), data=ht_data_clim14_nog)
newdata_ht <- with(ht_data_clim14_nog, data.frame(y=seq(min(y),max(y),length.out=100)))

ht_predict <- predict(bestmod_ht_pca_y_nog_lm, newdata = newdata_ht, interval="confidence")

predictdataht <- cbind(newdata_ht, ht_predict)

ht_lat_plot <- ggplot()+
  geom_point(data=ht_data_clim14, aes(x=y, y=value, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdataht, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdataht, aes(x=y,y=fit), color="black")+
  xlab("Latitude")+
  ylab("Height (m)")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position="none")

prov.legend <- get_legend(ggplot()+
  geom_point(data=ht_data_clim14, aes(x=y, y=value, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdataht, aes(x=y, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdataht, aes(x=y,y=fit), color="black")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()+
  theme(legend.position="right"))
geo.legend <- get_legend(interact_plot(ht_dist_mod_nog, pred=dist.to.plant, modx=geo.dist.to.plant.km, plot.points = TRUE, interval = TRUE, int.width = 0.95, colors="blue2", data=ht_data_clim14)+
  theme_bw()+
  theme(legend.position = "right")
)

library(cowplot)

png("figures/dbh_height_fig.png", width=9,height=7, units="in", res=500)
grid.arrange(grid.arrange(dbh_dist_plot,dbh_lat_plot,ht_dist_plot,ht_lat_plot),grid.arrange(prov.legend,geo.legend, nrow=2, heights=c(1,0.4)),widths=c(1,0.4))
dev.off()

```
 
####extra models

```{r}

ht_data_clim14_long <- ht_data_clim14 %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

ht_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(value ~ climvar.value + (1|Provenance), data=ht_data_clim14_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(value ~ climvar.value + (1|Provenance), data=ht_data_clim14_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods <- bind_rows(ht_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods %>% arrange(pvalue) ##lots significant with Gila, but when it's taken out, nothing is significant

###quadratic

ht_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(value ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=ht_data_clim14_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(value ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=ht_data_clim14_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad <- bind_rows(ht_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad %>% arrange(pvalue2_nog) #nothing significant when Gila is taken out
```

####Southern Region

#####height
```{r}
##Look at just southern Rockies, excluding Gila
ht_SR <- ht_data_clim14_nog %>% filter(y < 44)
  
ht_SR_long <- ht_SR %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

ht_SR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(value ~ climvar.value + (1|Provenance), data=ht_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

ht_SR_mods <- bind_rows(ht_SR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

ht_SR_mods %>% arrange(pvalue) ##TD is significant

cor(ht_SR %>% dplyr::select(c(MAT:PPT_sm,elev,x,y,smrpb,monsoonality)))
#TD is the main differentiating climate vactor in the southern rockies, this might be why it's coming out. 

##TD
ht_TD_mod <- lmer(value ~ climvar.value + (1|Provenance), data=ht_SR_long %>% filter(climvar.name=="TD"))
plot(ht_TD_mod)
qqmath(ht_TD_mod)
summary(ht_TD_mod)

ggplot(data=ht_SR_long %>% filter(climvar.name=="TD"), aes(x=climvar.value, y=value))+
  geom_point()+
  geom_smooth(method="lm")

###quadratic

ht_SR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(value ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=ht_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

ht_SR_mods_quad <- bind_rows(ht_SR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

ht_SR_mods_quad %>% arrange(pvalue2) #MAP has significant quadratic effect

##MAP
ht_map_quad <- lmer(value ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=ht_SR_long %>% filter(climvar.name=="map"))
plot(ht_map_quad)
qqmath(ht_map_quad)
summary(ht_map_quad)

ht_map_quad_lm <- lm(value ~ climvar.value + I(climvar.value^2), data=ht_SR_long %>% filter(climvar.name=="map"))
newdata_ht_map <- with(ht_SR_long %>% filter(climvar.name=="map"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

ht_map_predict <- predict(ht_map_quad_lm, newdata = newdata_ht_map, interval="confidence")

predictdata_ht_map <- cbind(newdata_ht_map, ht_map_predict)

ggplot()+
  geom_point(data=ht_SR_long %>% filter(climvar.name=="map"), aes(x=climvar.value, y=value, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdata_ht_map, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_ht_map, aes(x=climvar.value,y=fit), color="black")+
  xlab("MAP")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()

##Latitude
htmod_SR <- lmer(value ~ y + (1|Provenance), data=ht_SR)
plot(htmod_SR)
qqmath(htmod_SR)
summary(htmod_SR)

ggplot(data=ht_SR, aes(x=y, y=value, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")



#nursery height
totht_mod_nursery <- lmer(value ~ Seedling.Ht..from.Nursery + (1|Provenance), data=ht_data_clim14)
plot(totht_mod_nursery)
qqmath(totht_mod_nursery)
summary(totht_mod_nursery) ##significant effect of nursery height on total height in 2014 when Gila is removed

totht_mod_nursery_nog <- lmer(value ~ Seedling.Ht..from.Nursery + (1|Provenance), data=ht_data_clim14_nog)
plot(totht_mod_nursery_nog)
qqmath(totht_mod_nursery_nog)
summary(totht_mod_nursery_nog) ##significant effect of nursery height on total height in 2014 when Gila is removed

ggplot(data= ht_data_clim14, aes(x=Seedling.Ht..from.Nursery, y=value, col=Provenance))+
  geom_point()
```

#####dbh
```{r}
##Look at just southern Rockies, excluding Gila
dbh_SR <- dbh_num14_alldist %>% filter(!Provenance=="Gila NF") %>% filter(y < 44)
  
dbh_SR_long <- dbh_SR %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

dbh_SR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + (1|Provenance), data=dbh_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

dbh_SR_mods <- bind_rows(dbh_SR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

dbh_SR_mods %>% arrange(pvalue) ##nothing significant

###quadratic

dbh_SR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=dbh_SR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_SR_mods_quad <- bind_rows(dbh_SR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

dbh_SR_mods_quad %>% arrange(pvalue2) #dd_0 and MAT significant

##dd_0
dd0_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=dbh_SR_long %>% filter(climvar.name=="dd_0"))
plot(dd0_dbh_quad)
qqmath(dd0_dbh_quad)
summary(dd0_dbh_quad)


dd0_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_SR_long %>% filter(climvar.name=="dd_0"))
newdata_dbh_dd0 <- with(dbh_SR_long %>% filter(climvar.name=="dd_0"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_dd0_predict <- predict(dd0_dbh_quad_lm, newdata = newdata_dbh_dd0, interval="confidence")

predictdata_dbh_dd0 <- cbind(newdata_dbh_dd0, dbh_dd0_predict)

ggplot()+
  geom_point(data=dbh_SR_long %>% filter(climvar.name=="dd_0"), aes(x=climvar.value, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdata_dbh_dd0, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_dd0, aes(x=climvar.value,y=fit), color="black")+
  xlab("dd_0")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()

##MAT
MAT_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=dbh_SR_long %>% filter(climvar.name=="MAT"))
plot(MAT_dbh_quad)
qqmath(MAT_dbh_quad)
summary(MAT_dbh_quad)

MAT_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_SR_long %>% filter(climvar.name=="MAT"))
newdata_dbh_MAT <- with(dbh_SR_long %>% filter(climvar.name=="MAT"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_MAT_predict <- predict(MAT_dbh_quad_lm, newdata = newdata_dbh_MAT, interval="confidence")

predictdata_dbh_MAT <- cbind(newdata_dbh_MAT, dbh_MAT_predict)

ggplot()+
  geom_point(data=dbh_SR_long %>% filter(climvar.name=="MAT"), aes(x=climvar.value, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdata_dbh_MAT, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_MAT, aes(x=climvar.value,y=fit), color="black")+
  xlab("MAT")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()
```


####Northern Region

#####height
```{r}
##Look at just southern Rockies, excluding Gila
ht_NR <- ht_data_clim14_nog %>% filter(y > 44)
  
ht_NR_long <- ht_NR %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

ht_NR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(value ~ climvar.value + (1|Provenance), data=ht_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

ht_NR_mods <- bind_rows(ht_NR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

ht_NR_mods %>% arrange(pvalue) ##eFFP, SHM, EMT, PPT_sm, nffd

##TD
ht_SHM_mod <- lmer(value ~ climvar.value + (1|Provenance), data=ht_NR_long %>% filter(climvar.name=="SHM"))
plot(ht_SHM_mod)
qqmath(ht_SHM_mod)
summary(ht_SHM_mod)

ggplot(data=ht_NR_long %>% filter(climvar.name=="SHM"), aes(x=climvar.value, y=value))+
  geom_point()+
  geom_smooth(method="lm")

###quadratic

ht_NR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(value ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=ht_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

ht_NR_mods_quad <- bind_rows(ht_NR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

ht_NR_mods_quad %>% arrange(pvalue2) #MAP has significant quadratic effect


##Latitude
htmod_NR <- lmer(value ~ y + (1|Provenance), data=ht_NR)
plot(htmod_NR)
qqmath(htmod_NR)
summary(htmod_NR)

ggplot(data=ht_NR, aes(x=y, y=value, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")



#nursery height
totht_mod_nursery <- lmer(value ~ Seedling.Ht..from.Nursery + (1|Provenance), data=ht_data_clim14)
plot(totht_mod_nursery)
qqmath(totht_mod_nursery)
summary(totht_mod_nursery) ##significant effect of nursery height on total height in 2014 when Gila is removed

totht_mod_nursery_nog <- lmer(value ~ Seedling.Ht..from.Nursery + (1|Provenance), data=ht_data_clim14_nog)
plot(totht_mod_nursery_nog)
qqmath(totht_mod_nursery_nog)
summary(totht_mod_nursery_nog) ##significant effect of nursery height on total height in 2014 when Gila is removed

ggplot(data= ht_data_clim14, aes(x=Seedling.Ht..from.Nursery, y=value, col=Provenance))+
  geom_point()
```

#####dbh
```{r}
##Look at just southern Rockies, excluding Gila
dbh_NR <- dbh_num14_alldist %>% filter(!Provenance=="Gila NF") %>% filter(y > 44)
  
dbh_NR_long <- dbh_NR %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

dbh_NR_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + (1|Provenance), data=dbh_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

dbh_NR_mods <- bind_rows(dbh_NR_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue))

}

dbh_NR_mods %>% arrange(pvalue) ##nothing significant

###quadratic

dbh_NR_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=dbh_NR_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

dbh_NR_mods_quad <- bind_rows(dbh_NR_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2]))

}

dbh_NR_mods_quad %>% arrange(pvalue2) 

##dd_0
dd0_dbh_quad <- lmer(DBH ~ climvar.value + I(climvar.value^2) + (1|Provenance), data=dbh_NR_long %>% filter(climvar.name=="dd_0"))
plot(dd0_dbh_quad)
qqmath(dd0_dbh_quad)
summary(dd0_dbh_quad)

dd0_dbh_quad_lm <- lm(DBH ~ climvar.value + I(climvar.value^2), data=dbh_NR_long %>% filter(climvar.name=="dd_0"))
newdata_dbh_dd0 <- with(dbh_NR_long %>% filter(climvar.name=="dd_0"), data.frame(climvar.value=seq(min(climvar.value),max(climvar.value),length.out=100)))

dbh_dd0_predict <- predict(dd0_dbh_quad_lm, newdata = newdata_dbh_dd0, interval="confidence")

predictdata_dbh_dd0 <- cbind(newdata_dbh_dd0, dbh_dd0_predict)

ggplot()+
  geom_point(data=dbh_NR_long %>% filter(climvar.name=="dd_0"), aes(x=climvar.value, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(data=predictdata_dbh_dd0, aes(x=climvar.value, ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line(data=predictdata_dbh_dd0, aes(x=climvar.value,y=fit), color="black")+
  xlab("dd_0")+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  theme_bw()

##Latitude
dbhmod_NR <- lmer(DBH ~ y + (1|Provenance), data=dbh_NR)
plot(dbhmod_NR)
qqmath(dbhmod_NR)
summary(dbhmod_NR)

ggplot(data=dbh_NR, aes(x=y, y=DBH, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

```

##Cones

```{r}
cone_data <- moniger_data_comb %>% 
  dplyr::select(c(SORT,Provenance,Cones85:Cones06)) %>% 
  pivot_longer(Cones85:Cones06) %>% 
  mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006)) %>%
  filter(!is.na(value))

cone_sum <- cone_data %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance,year) %>% 
  summarise(value=sum(value), n=n()) %>% 
  mutate(prop.w.cones = value/n)

ave_dbhs <- moniger_data_comb %>% 
  dplyr::select(c(SORT,Provenance,DBH91:DBH06)) %>% 
  pivot_longer(DBH91:DBH06) %>% 
  mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>% 
  filter(!is.na(value)) %>% 
  group_by(Provenance, year) %>% 
  summarise(ave.dbh = mean(value), se.dbh = sd(value)/sqrt(n())) %>% 
  left_join(cone_sum)

ave_dbh <- moniger_data_comb %>% 
  dplyr::select(c(SORT,Provenance,DBH91:DBH06)) %>% 
  pivot_longer(DBH91:DBH06) %>% 
  mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance, year) %>% 
  summarise(ave.dbh = mean(value), se.dbh = sd(value)/sqrt(n())) %>% 
  left_join(cone_sum)

ggplot(ave_dbhs, aes(x=ave.dbh, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_errorbar(aes(xmin=ave.dbh - se.dbh, xmax=ave.dbh+se.dbh))

ggplot(moniger_data_comb, aes(x=DBH91, y=Cones91))+
  geom_jitter(heigdbh=0.1)
ggplot(moniger_data_comb, aes(x=DBH96, y=Cones96))+
  geom_jitter(heigdbh=0.1)
ggplot(moniger_data_comb, aes(x=DBH06, y=Cones06))+
  geom_jitter(heigdbh=0.1)

ggplot(cone_sum, aes(x=year, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_line()

```

###models

####logistic
```{r}
cone_data 

logmod_cat <- glm(value ~ year*Provenance, data= cone_data, family="binomial")
summary(logmod_cat)
confint(logmod_cat)
wald.test(b = coef(logmod_cat), Sigma = vcov(logmod_cat), Terms=2) ##year is significant
wald.test(b = coef(logmod_cat), Sigma = vcov(logmod_cat), Terms=3:21) ##Provenance is significant
wald.test(b = coef(logmod_cat), Sigma = vcov(logmod_cat), Terms=22:40) ##interaction is significant
coef(logmod_cat)

##predictions
newdata1 <- with(cone_data, data.frame(year = seq(min(year),max(year),1), Provenance = rep(unique(cone_data$Provenance), each=22)))

newdata2 <- cbind(newdata1, predict(logmod_cat, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_fig<- ggplot(newdata3, aes(x = year, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(Provenance, levels=provs_bylat$Provenance)), alpha = 0.2) + geom_line(aes(colour = factor(Provenance, levels=provs_bylat$Provenance)),
    linewidth = 1)+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  scale_fill_manual(values=unname(stepped()),name="Provenance")+
  ylab("Predicted Probability")+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=10),
        axis.title = element_text(color="black", size=10),
        legend.position = "none",
        legend.text = element_text(color="black", size=8),
        legend.title = element_text(color="black", size=10))

# png("figures/cone_fig.png", height=3, width=3, res=300, units="in")
# cone_fig
# dev.off()

```

####PCA

```{r}
moniger_subset <- left_join(moniger_data_comb %>% 
  dplyr::select(c(SORT, HT85, HT91, HT96, HT06, code)) %>%
  pivot_longer(HT85:HT06, values_to = "height") %>% 
    mutate(year=case_when(name == "HT85" ~ 1985,
                        name == "HT91" ~ 1991,
                        name == "HT96" ~ 1996,
                        name == "HT06" ~ 2006)) %>% 
  dplyr::select(-name),
moniger_data_comb %>% 
  dplyr::select(c(SORT, DBH91, DBH96, DBH06, code)) %>%
  pivot_longer(DBH91:DBH06, values_to = "DBH") %>% 
    mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>% 
  dplyr::select(-name)) %>% 
left_join(moniger_data_comb %>% 
  dplyr::select(c(SORT, Cones85, Cones91, Cones96, Cones06, code)) %>%
  pivot_longer(Cones85:Cones06, values_to = "Cones") %>% 
    mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006)) %>% 
  dplyr::select(-name)) %>% 
left_join(moniger_data_comb %>% 
  dplyr::select(c(SORT, PC1, PC2, x, y, code))) %>% 
  filter(!(is.na(height)|is.na(DBH)|is.na(Cones)))

cone_clim_mod_htx <- glmer(Cones ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year), data=moniger_subset, family="binomial")
summary(cone_clim_mod_htx)

cone_clim_mod_hty <- glmer(Cones ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(y) + I(scale(y)^2)+ (1|code) + (1|year), data=moniger_subset, family="binomial")
summary(cone_clim_mod_hty)

cone_clim_mod_dbhx <- glmer(Cones ~ scale(DBH)*PC1 + I(PC1^2) + scale(DBH)*PC2 + I(PC2^2) + scale(DBH)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year), data=moniger_subset, family="binomial")
summary(cone_clim_mod_dbhx)

cone_clim_mod_dbhy <- glmer(Cones ~ scale(DBH)*PC1 + I(PC1^2) + scale(DBH)*PC2 + I(PC2^2) + scale(DBH)*scale(y) + I(scale(y)^2)+ (1|code) + (1|year), data=moniger_subset, family="binomial")
summary(cone_clim_mod_dbhy)

AICc(cone_clim_mod_hty, cone_clim_mod_dbhx, cone_clim_mod_dbhy,cone_clim_mod_htx) #htx is lowest

# dredge.cone.clim <- dredge(cone_clim_mod_htx)
# saveRDS(dredge.cone.clim, "dredge.cone.clim.RDS")
dredge.cone.clim <- readRDS("dredge.cone.clim.RDS")
dredge.cone.clim

moniger_subset_nog <- moniger_subset %>% filter(!code=="GiNF")

cone_clim_mod_htx_nog <- glmer(Cones ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + scale(height)*scale(x) + I(scale(x)^2)+ (1|code) + (1|year), data=moniger_subset_nog, family="binomial")
summary(cone_clim_mod_htx_nog)

best.mod.cone.clim <- glmer(Cones ~ scale(height)*scale(x) + PC1 + I(PC1^2) + (1|code) + (1|year), data= moniger_subset, family = "binomial")
summary(best.mod.cone.clim)

best.mod.cone.clim_nog <- glmer(Cones ~ scale(height)*scale(x) + PC1 + I(PC1^2) + (1|code) + (1|year), data= moniger_subset %>% filter(!code=="GiNF"), family = "binomial")
summary(best.mod.cone.clim_nog)

##predictions
CCnewdata1 <- with(moniger_subset, data.frame(height = seq(min(height),max(height),length.out=50), PC1=mean(PC1), PC2 = mean(PC2), x = rep(seq(-121, -105, 2),each=50)))

cone_clim_mod_glm <- glm(Cones ~ scale(height)*scale(x) + PC1 + I(PC1^2), data= moniger_subset, family = "binomial")

CCnewdata2 <- cbind(CCnewdata1, predict(cone_clim_mod_glm, newdata = CCnewdata1, type = "link", se=TRUE))
CCnewdata3 <- within(CCnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_x_plot<- ggplot(CCnewdata3, aes(x = height, y = PredictedProb, col= factor(x))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(x)), alpha = 0.2, col=NA) + geom_line(aes(colour = factor(x)),
    linewidth = 1)+
  geom_line(aes(x=height, y=PredictedProb, col=factor(x)))+
  scale_color_manual(values=viridis::mako(n=10)[1:9], name = "Longitude")+
  scale_fill_manual(values=viridis::mako(n=10)[1:9],name="Longitude")+
  theme_bw()+
  xlab("Height (m)")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")


```

####distance

```{r}
cone_dist_data <- moniger_subset %>% 
  left_join(pca_dist_df, by="code") %>% 
  left_join(geo.dist.df) %>% 
  filter(!is.na(Cones))

cone_dist_data_nog <- cone_dist_data %>% filter(!Provenance == "Gila NF")

cone_dist_mod <- glmer(Cones ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km)*scale(height) + (1|code) + (1|year), data=cone_dist_data, family="binomial")
plot(cone_dist_mod)
summary(cone_dist_mod)

cone_dist_mod_nog <- glmer(Cones ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km)*scale(height) + (1|code) + (1|year), data=cone_dist_data_nog, family="binomial")
plot(cone_dist_mod_nog)
summary(cone_dist_mod_nog)

dredge.cone.dist <- dredge(cone_dist_mod)
dredge.cone.dist

dredge.cone.dist.nog <- dredge(cone_dist_mod_nog)
dredge.cone.dist.nog

cone_dist_bestmod <- glmer(Cones ~ scale(geo.dist.to.plant.km)*scale(height) + (1|code) + (1|year), data=cone_dist_data, family="binomial")
summary(cone_dist_bestmod)

cone_dist_mod_glm <- glm(Cones ~ scale(geo.dist.to.plant.km)*scale(height), data=cone_dist_data, family="binomial")

##predictions
CDnewdata1 <- with(cone_dist_data, data.frame(geo.dist.to.plant.km = rep(seq(80,1600, by=190), each=50), 
                                              dist.to.plant=mean(dist.to.plant), 
                   height=seq(min(height), max(height), length.out=50)))

CDnewdata2 <- cbind(CDnewdata1, predict(cone_dist_mod_glm, newdata = CDnewdata1, type = "link", se=TRUE))
CDnewdata3 <- within(CDnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(CDnewdata3, aes(x = height, y = PredictedProb, col=factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill=factor(geo.dist.to.plant.km)), alpha = 0.2) + geom_line(linewidth = 1, aes(col=factor(geo.dist.to.plant.km)))+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)

#no g predictions
cone_dist_bestmod_nog <- glmer(Cones ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km)*scale(height) + (1|code) + (1|year), data=cone_dist_data  %>% filter(!Provenance == "Gila NF"), family="binomial")
summary(cone_dist_bestmod_nog)

cone_dist_mod_glm_nog <- glm(Cones ~scale(dist.to.plant)*scale(geo.dist.to.plant.km)*scale(height) , data=cone_dist_data  %>% filter(!Provenance == "Gila NF"), family="binomial")

CDNGnewdata1 <- expand.grid(dist.to.plant = seq(0,6, by=2), 
                                              geo.dist.to.plant.km=seq(80,1600,by=190), 
                   height=seq(min(cone_dist_data  %>% filter(!Provenance == "Gila NF") %>% pull(height)), max(cone_dist_data  %>% filter(!Provenance == "Gila NF") %>% pull(height)), length.out=50))

CDNGnewdata2 <- cbind(CDNGnewdata1, predict(cone_dist_mod_glm_nog, newdata = CDNGnewdata1, type = "link", se=TRUE))
CDNGnewdata3 <- within(CDNGnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_dist_plot<- ggplot(CDNGnewdata3, aes(x = height, y = PredictedProb, col=factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill=factor(geo.dist.to.plant.km)), alpha = 0.2, col=NA) + geom_line(linewidth = 1, aes(col=factor(geo.dist.to.plant.km)))+
  scale_color_viridis(discrete = TRUE, name="Geographic\ndistance (km)")+
  scale_fill_viridis(discrete = TRUE, name="Geographic\ndistance (km)")+
  facet_wrap(~factor(dist.to.plant, labels=c("PCA distance = 0", "PCA distance = 2","PCA distance = 4", "PCA distance = 6")))+
  xlab("Height (m)")+
  ylab("Predicted Probability of Cones")+
  theme_bw()+
  theme(legend.position = "bottom")

```

####other
```{r}
moniger_provclim<- moniger_data_comb %>% 
  dplyr::select(c(SORT, Cones85, Cones91, Cones96, Cones06, code)) %>%
  pivot_longer(Cones85:Cones06, values_to = "Cones") %>% 
    mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006)) %>% 
  dplyr::select(-name) %>% 
  left_join(moniger_data_comb) %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value") %>% 
  filter(!is.na(Cones))

cone_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmer(Cones ~ climvar.value + (1|year) + (1|code), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|z|)`

mod_nog <- glmer(Cones ~ climvar.value + (1|year) + (1|code), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!code=="GiNF"), family="binomial")
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|z|)`

cone_mods <- bind_rows(cone_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

cone_mods %>% arrange(pvalue) ##smrpb is significant for both
cone_mods %>% arrange(pvalue_nog) 

###smrpb
cone_smrpb_mod <- glmer(Cones ~ climvar.value + (1|year) + (1|code), data=moniger_provclim %>% filter(climvar.name=="smrpb"), family="binomial")
summary(cone_smrpb_mod)

cone_smrpb_data <- moniger_provclim %>% filter(climvar.name=="smrpb")

newdata_smrpb_cone <- data.frame(
    climvar.value = seq(min(cone_smrpb_data$climvar.value), 
                      max(cone_smrpb_data$climvar.value), 
                      length.out = 100
                      ))

##take random effect out to make predictions
cone_smrpb_mod_glm <- glm(Cones ~ scale(climvar.value), data=moniger_provclim %>% filter(climvar.name=="smrpb"), family="binomial")

##predictions
conesmrpb_newdata1 <- with(cone_smrpb_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

conesmrpb_newdata2 <- cbind(conesmrpb_newdata1, predict(cone_smrpb_mod_glm, newdata = conesmrpb_newdata1, type = "link", se=TRUE))
conesmrpb_newdata3 <- within(conesmrpb_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(conesmrpb_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")

#without Gila is still significant, but in opposite direction
cone_smrpb_mod_nog <- glmer(Cones ~ climvar.value + (1|year) + (1|Provenance), data=moniger_provclim %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(cone_smrpb_mod_nog)

cone_smrpb_data_nog <- moniger_provclim %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF")

ggplot(data=moniger_provclim %>% filter(climvar.name=="smrpb"), aes(x=climvar.value, y=Cones))+
  geom_jitter()+
  facet_wrap(~year)
ggplot(data=moniger_provclim %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), aes(x=climvar.value, y=Cones))+
  geom_jitter()+
  facet_wrap(~year)

#prediction
##take random effect out to make predictions
cone_smrpb_mod_nog_glm <- glm(Cones ~ scale(climvar.value), data=cone_smrpb_data_nog, family="binomial")

##predictions
conesmrpb_nog_newdata1 <- with(cone_smrpb_data_nog, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

conesmrpb_nog_newdata2 <- cbind(conesmrpb_nog_newdata1, predict(cone_smrpb_mod_nog_glm, newdata = conesmrpb_nog_newdata1, type = "link", se=TRUE))
conesmrpb_nog_newdata3 <- within(conesmrpb_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

smrpb_cone_plot_nog <- ggplot(conesmrpb_nog_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("Summer/Spring precip ratio")+
  ylab("Predicted Probability")+
  theme_bw()+
  ggtitle("Cones")

###quadratic

cone_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmer(Cones ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|code) + (1|year), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|z|)`

mod_nog <- glmer(Cones ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|code) + (1|year), data=moniger_provclim %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!code=="GiNF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|z|)`

cone_mods_quad <- bind_rows(cone_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))
}

cone_mods_quad %>% arrange(pvalue2_nog) ##TD is only quadratic effect significant both with and without Gila

###TD
cone_TD_mod <- glmer(Cones ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|code) + (1|year), data=moniger_provclim %>% filter(climvar.name=="TD"), family="binomial")
summary(cone_TD_mod)

cone_TD_data <- moniger_provclim %>% filter(climvar.name=="TD")

newdata_TD_cone <- data.frame(
    climvar.value = seq(min(cone_TD_data$climvar.value), 
                      max(cone_TD_data$climvar.value), 
                      length.out = 100
                      ))

##take random effect out to make predictions
cone_TD_mod_glm <- glm(Cones ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_provclim %>% filter(climvar.name=="TD"), family="binomial")

##predictions
coneTD_newdata1 <- with(cone_TD_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

coneTD_newdata2 <- cbind(coneTD_newdata1, predict(cone_TD_mod_glm, newdata = coneTD_newdata1, type = "link", se=TRUE))
coneTD_newdata3 <- within(coneTD_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

td_cone_plot<- ggplot(coneTD_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("Temperature Differential")+
  ylab("Predicted Probability")+
  theme_bw()+
  ggtitle("Cones")

#without Gila is still significant
cone_TD_mod_nog <- glmer(Cones ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|code) + (1|year), data=moniger_provclim %>% filter(climvar.name=="TD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(cone_TD_mod_nog)

```

####plots
```{r}
cone_sig_clim_data<- bind_rows(
conesmrpb_nog_newdata3 %>% 
  mutate(var = "smrpb"),
coneTD_newdata3 %>% 
  mutate(var="TD"))

cone_sig_clim_plot<- ggplot(cone_sig_clim_data, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("value")+
  ylab("Predicted Probability of Cones")+
  theme_bw()+
  facet_grid(cols=vars(var), scales="free_x")

cone_x_plot
cone_dist_plot

png("figures/cone_plot.png", width=9.5, height=7, units = "in", res=500)
ggarrange(ggarrange(cone_x_plot, cone_dist_plot, ncol=2, labels=c("A)","B)")),cone_sig_clim_plot, nrow=2, heights=c(1,0.8), labels=c("","C)"))
dev.off()

```

##Survival

```{r}
##survival
tree.num <- ht_data %>% 
  filter(!is.na(rel.growth)) %>% 
  group_by(name, Provenance) %>% 
  summarise(n=n()) %>% 
  mutate(year = case_when(
    name=="HT74" ~ 1974,
    name=="HT79" ~ 1979,
    name=="HT85" ~ 1985,
    name=="HT91" ~ 1991,
    name=="HT96" ~ 1996,
    name=="HT06" ~ 2006,
    name=="HT14" ~ 2014))

trees.died<- tree.num %>% 
  left_join(tree.num %>% filter(year==1974) %>% ungroup() %>% dplyr::select(Provenance, n) %>% rename(n_74=n)) %>% 
  mutate(prop = n/n_74)

ggplot(tree.num, aes(x=year, y=n, col=Provenance))+
  geom_point()+
  geom_line()

ggplot(trees.died %>% filter(name=="HT14"), aes(x=factor(Provenance, levels=prov_clim_adjusted_bi %>% arrange(y) %>% pull(Provenance)), y=prop))+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

###models

####Provenance
```{r}
#provenance affect on survival 
moniger_survival <- moniger_data_comb %>% 
  mutate(Stat14 = ifelse(Stat14==9,0,Stat14))

survmod<- glm(Stat14 ~ Provenance, data=moniger_survival, family="binomial")
plot(survmod)
summary(survmod)
confint(survmod)
wald.test(b = coef(survmod), Sigma = vcov(survmod), Terms=2:20) ##Provenance is significant
coef(survmod)

##predictions
newdata1 <- with(moniger_survival, data.frame(Provenance = rep(unique(moniger_survival$Provenance))))

newdata2 <- cbind(newdata1, predict(survmod, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_byprov <- ggplot(newdata3, aes(x = factor(Provenance, levels=provs_bylat$Provenance), y = PredictedProb)) + 
  geom_errorbar(aes(ymin = LL, ymax = UL, col = factor(Provenance, levels=provs_bylat$Provenance))) + 
  geom_point(aes(colour = factor(Provenance, levels=provs_bylat$Provenance)))+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_color_manual(values=unname(stepped()))+
  ylab("Predicted Probability of Survival")+
  theme_bw()+
  theme(legend.position = "none", axis.text.x = element_text(color="black",angle=45, hjust=1), axis.title.x = element_blank())
```

####PCA
```{r}
##
survmod_pcx<- glmer(Stat14 ~  PC1+ I(PC1^2) + PC2 + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=moniger_survival, family="binomial") ##had to take out interactions because model wouldn't converge
plot(survmod_pcx)
summary(survmod_pcx)

survmod_pcy<- glmer(Stat14 ~ PC1*PC2 + scale(y)*PC1 + scale(y)*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=moniger_survival, family="binomial")
plot(survmod_pcy)
summary(survmod_pcy)

AICc(survmod_pcx, survmod_pcy) #y is lower

#dredge(survmod_pcy)
bestsurvmod_pcy <- glmer(Stat14 ~ PC1+ I(PC1^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=moniger_survival, family="binomial")
summary(bestsurvmod_pcy)

moniger_survival_nog <- moniger_survival %>% filter(!Provenance=="Gila NF")

survmod_pcy_nog<- glmer(Stat14 ~ PC1+ I(PC1^2) + PC2 + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=moniger_survival_nog, family="binomial")
plot(survmod_pcy_nog)
summary(survmod_pcy_nog)
dredge(survmod_pcy_nog)

bestsurvmod_pcy_nog <- glmer(Stat14 ~ PC1+ I(PC1^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=moniger_survival_nog, family="binomial")
summary(bestsurvmod_pcy_nog)

bestsurvmod_pcy_nog_glm <- glm(Stat14 ~ PC1+ I(PC1^2) + scale(y) + I(scale(y)^2), data=moniger_survival_nog, family="binomial")


#predict
newdata1 <- with(moniger_survival, data.frame(PC1 = mean(PC1),
                                              y = seq(min(y),max(y),length.out=50)))

newdata2 <- cbind(newdata1, predict(bestsurvmod_pcy_nog_glm, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(newdata3, aes(x = y, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL, ymax = UL), alpha=0.5) +
  geom_line(aes(x = y, y = PredictedProb))+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

####distance

```{r}
#distance
surv_pcadist_data <- moniger_survival %>% 
  left_join(pca_dist_df, by="Provenance") %>% 
  left_join(geo.dist.df)

survmod_dist<- glmer(Stat14 ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=surv_pcadist_data, family = "binomial")
plot(survmod_dist)
summary(survmod_dist) #significant

survmod_dist_glm<- glm(Stat14 ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km), data=surv_pcadist_data, family = "binomial")

###make plot for distance model
SDnewdata1 <- with(surv_pcadist_data, data.frame(dist.to.plant = seq(min(surv_pcadist_data$dist.to.plant), 
                      max(surv_pcadist_data$dist.to.plant), 
                      length.out = 50),
    geo.dist.to.plant.km = rep(seq(80,1600,190),each=50)))

SDnewdata2 <- cbind(SDnewdata1, predict(survmod_dist_glm, newdata = SDnewdata1, type = "link", se=TRUE))
SDnewdata3 <- within(SDnewdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_dist_plot<-ggplot(SDnewdata3, aes(x = dist.to.plant, y = PredictedProb, col= factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(geo.dist.to.plant.km)),col=NA, alpha = 0.2) + geom_line(aes(colour = factor(geo.dist.to.plant.km)),
    linewidth = 1)+
  geom_line()+
  scale_color_viridis(discrete=T, name="Geographic\ndistance (km)")+
  scale_fill_viridis(discrete=T, name="Geographic\ndistance (km)")+
  xlab("Climatic distance")+
  ylab("Predicted Probability of Survival")+
  theme_bw()+
  theme(legend.position = "bottom")

##no gila
surv_pcadist_data_nog <- surv_pcadist_data %>% filter(!Provenance=="Gila NF")

survmod_dist_nog<- glmer(Stat14 ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=surv_pcadist_data_nog, family = "binomial")
plot(survmod_dist_nog)
summary(survmod_dist_nog) 

survmod_dist_glm_nog<- glm(Stat14 ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km), data=surv_pcadist_data_nog, family = "binomial")

###make plot for distance model
SDnewdata_nog1 <- with(surv_pcadist_data_nog, data.frame(dist.to.plant = seq(min(dist.to.plant), 
                      max(dist.to.plant), 
                      length.out = 50),
    geo.dist.to.plant.km = rep(seq(80,1600,190),each=50)))

SDnewdata_nog2 <- cbind(SDnewdata_nog1, predict(survmod_dist_glm_nog, newdata = SDnewdata_nog1, type = "link", se=TRUE))
SDnewdata_nog3 <- within(SDnewdata_nog2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(SDnewdata_nog3, aes(x = dist.to.plant, y = PredictedProb, col= factor(geo.dist.to.plant.km))) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(geo.dist.to.plant.km)),col=NA, alpha = 0.2) + geom_line(aes(colour = factor(geo.dist.to.plant.km)),
    linewidth = 1)+
  geom_line()+
  scale_color_viridis(discrete=T, name="Geographic distance (km)")+
  scale_fill_viridis(discrete=T, name="Geographic distance (km)")+
  xlab("Climatic distance")+
  ylab("Predicted Probability")+
  theme_bw()
```

####extra

```{r}
moniger_survival_long <- moniger_survival %>% 
  pivot_longer(c(MAT:PPT_sm, smrpb, monsoonality), names_to="climvar.name", values_to = "climvar.value")

surv_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmer(Stat14 ~ climvar.value + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|z|)`

mod_nog <- glmer(Stat14 ~ climvar.value + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|z|)`

surv_mods <- bind_rows(surv_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))}

surv_mods %>% arrange(pvalue_nog) ##length of growing season seems to be influential both with and without Gila

#nffd
surv_nffd_mod <- glmer(Stat14 ~ scale(climvar.value) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="nffd"), family="binomial")
summary(surv_nffd_mod)

surv_nffd_data <- moniger_survival_long %>% filter(climvar.name=="nffd")

newdata_nffd_surv <- data.frame(
    climvar.value = seq(min(surv_nffd_data$climvar.value), 
                      max(surv_nffd_data$climvar.value), 
                      length.out = 100
                      ))

##take random effect out to make predictions
surv_nffd_mod_glm <- glm(Stat14 ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="nffd"), family="binomial")

##predictions
survnffd_newdata1 <- with(surv_nffd_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

survnffd_newdata2 <- cbind(survnffd_newdata1, predict(surv_nffd_mod_glm, newdata = survnffd_newdata1, type = "link", se=TRUE))
survnffd_newdata3 <- within(survnffd_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_nffd_plot<- ggplot(survnffd_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("NFFD")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()

#without Gila is still significant
surv_nffd_mod_nog <- glmer(Stat14 ~ scale(climvar.value) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="nffd") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_nffd_mod_nog)
############


#bFFP
surv_bFFP_mod <- glmer(Stat14 ~ scale(climvar.value) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="bFFP"), family="binomial")
summary(surv_bFFP_mod)

surv_bFFP_data <- moniger_survival_long %>% filter(climvar.name=="bFFP")

newdata_bFFP_surv <- data.frame(
    climvar.value = seq(min(surv_bFFP_data$climvar.value), 
                      max(surv_bFFP_data$climvar.value), 
                      length.out = 100
                      ))

##take random effect out to make predictions
surv_bFFP_mod_glm <- glm(Stat14 ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="bFFP"), family="binomial")

##predictions
survbFFP_newdata1 <- with(surv_bFFP_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

survbFFP_newdata2 <- cbind(survbFFP_newdata1, predict(surv_bFFP_mod_glm, newdata = survbFFP_newdata1, type = "link", se=TRUE))
survbFFP_newdata3 <- within(survbFFP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(survbFFP_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_point(aes(x=climvar.value, y=PredictedProb))+
  xlab("bFFP")

#without Gila is still significant
surv_bFFP_mod_nog <- glmer(Stat14 ~ scale(climvar.value) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="bFFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_bFFP_mod_nog)
#########

#eFFP
surv_eFFP_mod <- glmer(Stat14 ~ scale(climvar.value) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="eFFP"), family="binomial")
summary(surv_eFFP_mod)

surv_eFFP_data <- moniger_survival_long %>% filter(climvar.name=="eFFP")

newdata_eFFP_surv <- data.frame(
    climvar.value = seq(min(surv_eFFP_data$climvar.value), 
                      max(surv_eFFP_data$climvar.value), 
                      length.out = 100
                      ))

##take random effect out to make predictions
surv_eFFP_mod_glm <- glm(Stat14 ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="eFFP"), family="binomial")

##predictions
surveFFP_newdata1 <- with(surv_eFFP_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

surveFFP_newdata2 <- cbind(surveFFP_newdata1, predict(surv_eFFP_mod_glm, newdata = surveFFP_newdata1, type = "link", se=TRUE))
surveFFP_newdata3 <- within(surveFFP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(surveFFP_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_point(aes(x=climvar.value, y=PredictedProb))+
  xlab("eFFP")

#without Gila is still significant
surv_eFFP_mod_nog <- glmer(Stat14 ~ scale(climvar.value) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="eFFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_eFFP_mod_nog)
#########


###quadratic

surv_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmer(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|z|)`

mod_nog <- glmer(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|z|)`

surv_mods_quad <- bind_rows(surv_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

surv_mods_quad %>% arrange(pvalue2_nog) ##MWMT and CMD are significant both with and without Gila

##MWMT
surv_MWMT_mod <- glmer(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="MWMT"), family="binomial")
summary(surv_MWMT_mod)

surv_MWMT_data <- moniger_survival_long %>% filter(climvar.name=="MWMT")

##take random effect out to make predictions
surv_MWMT_mod_glm <- glm(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="MWMT"), family="binomial")

##predictions
survMWMT_newdata1 <- with(surv_MWMT_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

survMWMT_newdata2 <- cbind(survMWMT_newdata1, predict(surv_MWMT_mod_glm, newdata = survMWMT_newdata1, type = "link", se=TRUE))
survMWMT_newdata3 <- within(survMWMT_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_mwmt_plot<- ggplot(survMWMT_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("MWMT")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()

#without Gila is still significant
surv_MWMT_mod_nog <- glmer(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="MWMT") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_MWMT_mod_nog)
#########

##cmd
surv_cmd_mod <- glmer(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="cmd"), family="binomial")
summary(surv_cmd_mod)

surv_cmd_data <- moniger_survival_long %>% filter(climvar.name=="cmd")

##take random effect out to make predictions
surv_cmd_mod_glm <- glm(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="cmd"), family="binomial")

##predictions
survcmd_newdata1 <- with(surv_cmd_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50)))

survcmd_newdata2 <- cbind(survcmd_newdata1, predict(surv_cmd_mod_glm, newdata = survcmd_newdata1, type = "link", se=TRUE))
survcmd_newdata3 <- within(survcmd_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_cmd_plot<- ggplot(survcmd_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("cmd")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()

surv_sig_clim<- bind_rows(
survcmd_newdata3 %>% 
  mutate(var = "cmd"),
survnffd_newdata3 %>% 
  mutate(var="nffd"),
survMWMT_newdata3 %>% 
  mutate(var="mwmt"))

surv_sig_clim_plot <- ggplot(surv_sig_clim, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("value")+
    ylab("Predicted Probability of Survival")+
  theme_bw()+
   facet_grid(cols=vars(var), scales="free_x")+
  theme(strip.text = element_text(size=12))

#without Gila is still significant
surv_cmd_mod_nog <- glmer(Stat14 ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance), data=moniger_survival_long %>% filter(climvar.name=="cmd") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_cmd_mod_nog)
```

####plots

```{r}
#plots

png("figures/survival_plot.png", width=9.5, height=7.5, units = "in", res=500)
ggarrange(ggarrange(surv_byprov, surv_dist_plot, ncol=2, labels=c("A)","B)")),surv_sig_clim_plot,nrow=2, labels = c("","C)"), heights=c(1,0.8))
dev.off()
```

##RWI

###Raw

```{r}
prov_all <- read.rwl("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Ring_widths_raw/prov_all.rwl")

rwi.stats(prov_all)


```

####exploration
```{r}
#plot raw data to look at timeseries length
par(mfrow=c(1,1))
plot.rwl(prov_all)

##compare timing of when trees reached 30cm tall (and thus had a growth ring measured)
dbh_age <- prov_all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(prov_all)) %>% 
  pivot_longer(!year, values_to = "rw", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")) %>% 
              left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
              mutate(Provenance = newname) %>% 
              dplyr::select(-newname), by="tree")
  
dbh_age_summary <- dbh_age %>%
  filter(!is.na(rw)) %>% 
  group_by(Provenance,tree) %>% 
  summarise(minyr = min(year), maxyr=max(year), n=n()) %>% 
  mutate(years.calc = maxyr-minyr+1)

#compare when time series started (min year)
ggplot(dbh_age_summary, aes(x=factor(Provenance, levels=prov_pcapts %>% arrange(y) %>% pull(Provenance)), y=minyr))+
  geom_boxplot()+
  geom_point(color="maroon")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#compare length of timeseries
ggplot(dbh_age_summary, aes(x=Provenance, y=n))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

dbh_age_summary2 <- dbh_age_summary %>% 
  left_join(dbh %>% mutate(Series=paste("X",Series,sep="")), by=c("tree"="Series","Provenance")) 

ggplot(dbh_age_summary2, aes(x=minyr, y=DBH14, col=Provenance))+
  geom_point() #there isn't a strong correlation between dbh and the length of the timeseries which makes me think that rings were just lost (not that the tree didn't reach DBH height until the min year)
###

##remove NAs from ring width series
prov_all_nona<- prov_all %>% na.omit()
colnames(prov_all_nona)

##raw
ggplot(dbh_age, aes(x=year, y=rw, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance)+
  theme(legend.position = "none")

hist(dbh_age$rw)
hist(dbh_age %>% filter(rw<0.5) %>% pull(rw))

###investigating series with really low ring width values
dbh_rwi_comp <- dbh_age %>% 
  filter(!tree=="X32A1") %>% 
  group_by(Provenance, tree) %>% 
  summarise(sum=sum(rw, na.rm = TRUE)) %>% 
  arrange(tree) %>% 
  bind_cols(dbh %>%
              filter(Series %in% unique(dbh_age$Series)) %>% 
              dplyr::select(-Provenance) %>% 
              arrange(Series) %>% 
  filter(!is.na(DBH14))) %>% 
  mutate(lowsum=ifelse(sum<16,"yes","no"))

dbh_rwi_comp %>% 
  filter(lowsum=="yes")

ggplot(dbh_rwi_comp)+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))

ggplot(dbh_rwi_comp %>% mutate(sum=ifelse(sum<15,sum*10,sum)))+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))+
  geom_abline(slope=1/10,intercept = 0)
###########
```

####remove bad data

```{r}
#find series that are likely off by an order of magnitude
off_trees<- dbh_rwi_comp %>% 
  filter(lowsum=="yes") %>% pull(tree) %>% c("X58A4") #this is the weird tree that's half and half

prov_good_nona <- prov_all_nona %>%dplyr::select(-all_of(substr(off_trees, 2,nchar(off_trees))))

###this cuts out sketchy trees and year = 2016
prov_good <- prov_all %>% dplyr::select(-all_of(substr(off_trees,2,nchar(off_trees)))) %>% 
  filter(!row.names(prov_all)=="2016")
```

####exploration of good data
```{r}
##some plots of the raw data averaged
dbh_age_good <- dbh_age %>% 
  filter(!tree %in% off_trees)

ave_rw_prov<- dbh_age_good %>% 
  na.omit() %>% 
  group_by(Provenance, year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n())) 

ggplot(ave_rw_prov, aes(x=year, y=ave_rw, col=Provenance))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se, col=Provenance))+
  geom_vline(xintercept = 1985)+
  facet_wrap(~Provenance)

ggplot(ave_rw_prov, aes(x=year, y=ave_rw, col=Provenance))+
  geom_point()+
  geom_line()+
  #geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se, col=Provenance))+
  geom_vline(xintercept = 1985)

ave_rw_all <- dbh_age_good %>%
  na.omit() %>% 
  group_by(year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n()))

ggplot(ave_rw_all, aes(x=year, y=ave_rw))+
  geom_point()+
  geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se), col="red")+
  geom_line()+
  geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")
### it seems like the major deviation in the data is in response to the wet period right before the drought, rather than the 2002 drought. 

#ring width series statistics
par(mfrow=c(1,1))
plot(prov_good, plot.type="spag")
rwl.report(prov_good)
prov_good_stats<- summary(prov_good)
summary(prov_good_stats$ar1)
```

###Detrending

```{r}
##detrending with Spline method - using stiffness of 35 years
##need to figure out what age to start at based on how long the "young tree growth spurt" usually takes

growth.detrended.all = matrix(nrow=nrow(prov_good), ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.all[,i]<- obj
}
colnames(growth.detrended.all) = colnames(prov_good)
rownames(growth.detrended.all) = rownames(prov_good)

rwi.stats(growth.detrended.all, period="max")
chron(growth.detrended.all)
plot(chron(growth.detrended.all), add.spline=TRUE, nyrs=35)
sss(growth.detrended.all)

growth.detrended.df.all <- growth.detrended.all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.all)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df.all, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

##remove first 15 years of ring widths since they are missing for many trees and likely represent unusual growth patterns. 
growth.detrended.short = matrix(nrow=nrow(prov_good)-15, ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good %>% filter(!(row.names(prov_good) < 1985))  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.short[,i]<- obj
}
colnames(growth.detrended.short) = colnames(prov_good)
rownames(growth.detrended.short) = rownames(prov_good)[16:nrow(prov_good)]

rwi.stats(growth.detrended.short, period="max")
plot(chron(growth.detrended.short), add.spline=TRUE, nyrs=35)
sss(growth.detrended.short)
sens1(growth.detrended.short[,1])

##########

growth.detrended.df <- growth.detrended.short %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.short)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

growth.detrended.sum <- growth.detrended.df %>% 
  group_by(year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.sum, aes(x=year, y=meanrwi))+
  geom_point()+
  geom_errorbar(aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se), col="red")+
  geom_line()+
  geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")+
  geom_hline(yintercept=1, linetype=2)

growth.detrended.byprov <- growth.detrended.df %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
    geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")+
  geom_point(aes( col=Provenance), size=2)+
  geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, col=Provenance), linewidth=1)+
  scale_color_manual(values=unname(stepped()))+
  geom_line(aes( col=Provenance), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())

##look at whole time series
growth.detrended.all.byprov <- growth.detrended.df.all %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.all.byprov, aes(x=year, y=meanrwi))+
    geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")+
  geom_point(aes( col=Provenance))+
  geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se, col=Provenance))+
  geom_line(aes( col=Provenance))+
  geom_hline(yintercept=1, linetype=2)

```

####Gini coefficient

```{r}
library(DescTools)

trees<- unique(growth.detrended.df$tree)

Gini(growth.detrended.df %>% filter(tree==trees[1]) %>% pull(rw_spline), weights=NULL, unbiased = TRUE, conf.level=TRUE, R=10000, type="perc", na.rm=TRUE)

###get time period with all trees included in all years (common period)
gini_df = data.frame()
for(i in 1:length(trees)){
gini = growth.detrended.df %>% filter(year > 1990 & year < 2011) %>% filter(tree==trees[i]) %>% pull(rw_spline) %>% 
  Gini(weights=NULL, unbiased = TRUE, conf.level=TRUE, R=10000, type="perc", na.rm=TRUE)
gini_df = bind_rows(gini_df, data.frame(gini=gini[1], lwr = gini[2], upr=gini[3], tree=trees[i]))
}

gini_byprov<- gini_df %>% 
  left_join(dbh_age_summary, by="tree")

ggplot(gini_byprov, aes(x=factor(Provenance, levels = provs_bylat$Provenance), y=gini, fill=factor(Provenance, levels = provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("Gini coefficient")+
  xlab("Provenance")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "none",
        axis.title = element_text(size=12, color="black"), axis.text = element_text(size = 12, color="black"))

##ANOVA

gini_provmod <- aov(log(gini) ~ Provenance, data=gini_byprov)
par(mfrow=c(2,2))
plot(gini_provmod)
summary(gini_provmod)
TukeyHSD(gini_provmod)$Provenance %>% as.data.frame() %>% filter(`p adj` < 0.05)

gini_byprov %>% 
  summary()

mean(gini_byprov$gini)
sd(gini_byprov$gini)

##Model with climate as a predictor
unique(prov_pcapts$Provenance)
unique(gini_byprov$Provenance)

gini_clim_df <- gini_byprov %>% 
  left_join(prov_pcapts) 

#MAT
gini_byMAT <- lmer(log(gini) ~ MAT + (1|Provenance), data=gini_clim_df)
plot(gini_byMAT)
qqmath(gini_byMAT)
summary(gini_byMAT)

#map
gini_bymap <- lmer(log(gini) ~ map + (1|Provenance), data=gini_clim_df)
plot(gini_bymap)
qqmath(gini_bymap)
summary(gini_bymap)

#TD
gini_byTD <- lmer(log(gini) ~ TD + (1|Provenance), data=gini_clim_df)
plot(gini_byTD)
qqmath(gini_byTD)
summary(gini_byTD)

#MCMT
gini_byMCMT <- lmer(log(gini) ~ MCMT + (1|Provenance), data=gini_clim_df)
plot(gini_byMCMT)
qqmath(gini_byMCMT)
summary(gini_byMCMT)

#msp
gini_bymsp <- lmer(log(gini) ~ msp + (1|Provenance), data=gini_clim_df)
plot(gini_bymsp)
qqmath(gini_bymsp)
summary(gini_bymsp)

#SHM
gini_bySHM <- lmer(log(gini) ~ SHM + (1|Provenance), data=gini_clim_df)
plot(gini_bySHM)
qqmath(gini_bySHM)
summary(gini_bySHM)

#nffd
gini_bynffd <- lmer(log(gini) ~ nffd + (1|Provenance), data=gini_clim_df)
plot(gini_bynffd)
qqmath(gini_bynffd)
summary(gini_bynffd)

#bFFP
gini_bybFFP <- lmer(log(gini) ~ bFFP + (1|Provenance), data=gini_clim_df)
plot(gini_bybFFP)
qqmath(gini_bybFFP)
summary(gini_bybFFP)

#eFFP
gini_byeFFP <- lmer(log(gini) ~ eFFP + (1|Provenance), data=gini_clim_df)
plot(gini_byeFFP)
qqmath(gini_byeFFP)
summary(gini_byeFFP)

#MWMT
gini_byMWMT <- lmer(log(gini) ~ MWMT + (1|Provenance), data=gini_clim_df)
plot(gini_byMWMT)
qqmath(gini_byMWMT)
summary(gini_byMWMT)

#dd_0
gini_bydd_0 <- lmer(log(gini) ~ dd_0 + (1|Provenance), data=gini_clim_df)
plot(gini_bydd_0)
qqmath(gini_bydd_0)
summary(gini_bydd_0)

#dd5
gini_bydd5 <- lmer(log(gini) ~ dd5 + (1|Provenance), data=gini_clim_df)
plot(gini_bydd5)
qqmath(gini_bydd5)
summary(gini_bydd5)

#EMT
gini_byEMT <- lmer(log(gini) ~ EMT + (1|Provenance), data=gini_clim_df)
plot(gini_byEMT)
qqmath(gini_byEMT)
summary(gini_byEMT)

#cmd
gini_bycmd <- lmer(log(gini) ~ cmd + (1|Provenance), data=gini_clim_df)
plot(gini_bycmd)
qqmath(gini_bycmd)
summary(gini_bycmd)

#pas
gini_bypas <- lmer(log(gini) ~ pas + (1|Provenance), data=gini_clim_df)
plot(gini_bypas)
qqmath(gini_bypas)
summary(gini_bypas)

#smrpb
gini_bysmrpb <- lmer(log(gini) ~ smrpb + (1|Provenance), data=gini_clim_df %>% filter(!Provenance=="Gila NF"))
plot(gini_bysmrpb)
qqmath(gini_bysmrpb)
summary(gini_bysmrpb) ##only significant with Gila included

#PC1
gini_byPC1 <- lmer(log(gini) ~ PC1 + (1|Provenance), data=gini_clim_df)
plot(gini_byPC1)
qqmath(gini_byPC1)
summary(gini_byPC1)
#PC2
gini_byPC2 <- lmer(log(gini) ~ PC2 + (1|Provenance), data=gini_clim_df %>% filter(!Provenance == "Gila NF"))
plot(gini_byPC2)
qqmath(gini_byPC2)
summary(gini_byPC2) #only significant with Gila included

```

####treeclim

```{r}
library(treeclim)

ppt_comb_plantation_wide<-ppt_comb_plantation %>%
  dplyr::select(ppt,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=ppt) %>% 
  as.data.frame()

tmax_comb_plantation_wide<- tmax_comb_plantation %>%
  dplyr::select(tmax,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=tmax) %>% 
  as.data.frame()

tmin_comb_plantation_wide<-tmin_comb_plantation %>%
  dplyr::select(tmin,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=tmin) %>% 
  as.data.frame()

tmean_comb_plantation_wide<-tmean_comb_plantation %>%
  dplyr::select(tmean,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=tmean) %>% 
  as.data.frame()

vpdmax_comb_plantation_wide<- vpdmax_comb_plantation %>%
  dplyr::select(vpdmax,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=vpdmax) %>% 
  as.data.frame()

vpdmin_comb_plantation_wide<- vpdmin_comb_plantation %>%
  dplyr::select(vpdmin,year,month) %>% 
  mutate(month = case_when(month == 1 ~ "JAN",
                          month == 2 ~ "FEB",
                          month == 3 ~ "MAR",
                          month == 4 ~ "APR",
                          month == 5 ~ "MAY",
                          month == 6 ~ "JUN",
                          month == 7 ~ "JUL",
                          month == 8 ~ "AUG",
                          month == 9 ~ "SEP",
                          month == 10 ~ "OCT",
                          month == 11 ~ "NOV",
                          month == 12 ~ "DEC")) %>% 
  rename(YEAR = year) %>% 
  pivot_wider(id_cols = YEAR, names_from=month, values_from=vpdmin) %>% 
  as.data.frame()

growth.detrended.common <- growth.detrended.short %>% 
  as.data.frame() %>% 
  filter(row.names(growth.detrended.short) > 1990 & row.names(growth.detrended.short) < 2011) %>% 
  as.data.frame()

chron.growth.detrended.common<- chron(growth.detrended.common)
chron.growth.detrended.all <- chron(growth.detrended.all, prewhiten = TRUE)

all_resp_ppt<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(ppt_comb_plantation_wide),
    var_names = c("ppt"))
all_resp_tmin<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(tmin_comb_plantation_wide),
    var_names = c("tmin"))
all_resp_tmean<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(tmean_comb_plantation_wide),
    var_names = c("tmean"))
all_resp_tmax<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(tmax_comb_plantation_wide),
    var_names = c("tmax"))
all_resp_vpdmin<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(vpdmin_comb_plantation_wide),
    var_names = c("vpdmin"))
all_resp_vpdmax<- dcc(chrono = chron.growth.detrended.all, 
    climate = list(vpdmax_comb_plantation_wide),
    var_names = c("vpdmax"))

dcc(chrono = chron.growth.detrended.all, 
    climate = list(ppt=ppt_comb_plantation_wide,tmin=tmin_comb_plantation_wide))

all_resp_ppt
all_resp_tmean
all_resp_tmin
all_resp_tmax
all_resp_vpdmin
all_resp_vpdmax

##just the common period

common_resp_ppt<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(ppt_comb_plantation_wide),
    var_names = c("ppt"))
common_resp_tmin<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(tmin_comb_plantation_wide),
    var_names = c("tmin"))
common_resp_tmean<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(tmean_comb_plantation_wide),
    var_names = c("tmean"))
common_resp_tmax<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(tmax_comb_plantation_wide),
    var_names = c("tmax"))
common_resp_vpdmin<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(vpdmin_comb_plantation_wide),
    var_names = c("vpdmin"))
common_resp_vpdmax<- dcc(chrono = chron.growth.detrended.common, 
    climate = list(vpdmax_comb_plantation_wide),
    var_names = c("vpdmax"))
common_resp_ppt
common_resp_tmean
common_resp_tmin
common_resp_tmax
common_resp_vpdmin ##current august vpdmin (negative relationship) is the only significant one
common_resp_vpdmax

###do all climate vars for each provenance separately

##ppt
chron.list=list()
for(i in 1:length(provs_arranged_lat[-9])){
  
data<- growth.detrended.df %>% 
  filter(Provenance==provs_arranged_lat[-9][i]) %>% 
  dplyr::select(year,Series,rw_spline) %>% 
  pivot_wider(names_from = Series, id_cols = year, values_from=rw_spline) %>% 
  column_to_rownames(var="year") %>% 
  chron()

chron.list[[i]] = data }
names(chron.list) = provs_arranged_lat[-9]

ppt_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(ppt_comb_plantation_wide),
    var_names = c("ppt")) 
ppt_treeclim_list[[i]] = result$coef
}
names(ppt_treeclim_list) = provs_arranged_lat[-9]

bind_rows(ppt_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

##tmean
tmean_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(tmean_comb_plantation_wide),
    var_names = c("tmean")) 
tmean_treeclim_list[[i]] = result$coef
}
names(tmean_treeclim_list) = provs_arranged_lat[-9]

bind_rows(tmean_treeclim_list, .id="column_label") %>% 
  summary() #nothing significant

##tmin
tmin_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(tmin_comb_plantation_wide),
    var_names = c("tmin")) 
tmin_treeclim_list[[i]] = result$coef
}
names(tmin_treeclim_list) = provs_arranged_lat[-9]

bind_rows(tmin_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

##tmax
tmax_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(tmax_comb_plantation_wide),
    var_names = c("tmax")) 
tmax_treeclim_list[[i]] = result$coef
}
names(tmax_treeclim_list) = provs_arranged_lat[-9]

bind_rows(tmax_treeclim_list, .id="column_label") %>% 
  summary() #nothing significant

#vpdmin
vpdmin_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(vpdmin_comb_plantation_wide),
    var_names = c("vpdmin")) 
vpdmin_treeclim_list[[i]] = result$coef
}
names(vpdmin_treeclim_list) = provs_arranged_lat[-9]

bind_rows(vpdmin_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

##vpdmax
vpdmax_treeclim_list<- list()
for(i in 1:length(provs_arranged_lat[-9])){

result <- dcc(chrono = chron.list[[i]], 
    climate = list(vpdmax_comb_plantation_wide),
    var_names = c("vpdmax")) 
vpdmax_treeclim_list[[i]] = result$coef
}
names(vpdmax_treeclim_list) = provs_arranged_lat[-9]

bind_rows(vpdmax_treeclim_list, .id="column_label") %>% 
  filter(significant==TRUE)

```

#####seasonal

```{r}

####seasonal with bioclimate vars
cwd_date <- plantation_cwd %>% 
  mutate(date=paste("1",month,year,sep="/")) %>% 
  as.data.frame()
  
bioclim_date <- plantation_spei_sum %>%
  mutate(date = paste(day(date),month(date),year(date),sep="/")) %>% 
  dplyr::select(date, spei) %>% 
  left_join(cwd_date, by="date")

spei_date_wide <- bioclim_date %>% 
  dplyr::select(year,month, spei) %>% 
  pivot_wider(id_cols=c(year), names_from=c(month), values_from = spei) %>% 
  as.data.frame()%>% 
  filter(!year==2016)

colnames(spei_date_wide)=c("YEAR","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC")
 
cwd_date_wide <- bioclim_date %>% 
  dplyr::select(year,month, cwd) %>% 
  pivot_wider(id_cols=c(year), names_from=c(month), values_from = cwd) %>% 
  as.data.frame()%>% 
  filter(!year==2016)

colnames(cwd_date_wide)=c("YEAR","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC")
 
aet_date_wide <- bioclim_date %>% 
  dplyr::select(year,month, aet) %>% 
  pivot_wider(id_cols=c(year), names_from=c(month), values_from = aet) %>% 
  as.data.frame() %>% 
  filter(!year==2016)

colnames(aet_date_wide)=c("YEAR","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC")

```

######aet - cwd
```{r}

aet_cwd_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(aet= aet_date_wide, cwd = cwd_date_wide),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
aet_cwd_list[[i]]<- result
}

inner_result_aet_cwd<- list()
outer_result_aet_cwd<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(aet_cwd_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
aet_cwd_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_aet_cwd[[j]]<- result}

  inner_result_aet_cwd2 <- inner_result_aet_cwd[sapply(inner_result_aet_cwd, function(x) dim(x)[1])>0]
  inner_result_aet_cwd3 <- bind_rows(inner_result_aet_cwd2)
  outer_result_aet_cwd[[i]]<- inner_result_aet_cwd3}
names(outer_result_aet_cwd)<- provs_arranged_lat[-9]

aet_cwd_seas <- bind_rows(outer_result_aet_cwd, .id="Provenance") 

aet_cwd_seas_allp <- aet_cwd_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% aet_cwd_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(aet_cwd_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_aet","sec_cwd"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("aet, cwd")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_aet_cwd <- aet_cwd_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "AET", "CWD"))

ggplot(timeline_aet_cwd, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  geom_text(data=data.frame(date = my("11-1754"), Provenance = "Cache NF", label= "+", var="CWD"), aes(x=date, y=Provenance, label=label), size=4)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")
  
ggplot(timeline_aet_cwd, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")

cor_analysis_plot_pc1_aet_cwd<- ggplot(timeline_aet_cwd, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("AET","CWD")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = AET")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(),strip.text = element_text(size=10, color="black"))




####practicing things
nor_seascorr <- seascorr(chrono = norw015,
                         climate=list(norway_temp, norway_prec),
                         var_names=c("temp","prec"))

skills(object = nor_seascorr,
       target = .mean("temp",6:8))


skills(object = aet_cwd_list[[20]],
       target = .mean("cwd", -12:3))

```

######aet - spei

```{r}

aet_spei_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(aet= aet_date_wide, spei = spei_date_wide),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
aet_spei_list[[i]]<- result
}

inner_result_aet_spei<- list()
outer_result_aet_spei<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(aet_spei_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
aet_spei_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_aet_spei[[j]]<- result}

  inner_result_aet_spei2 <- inner_result_aet_spei[sapply(inner_result_aet_spei, function(x) dim(x)[1])>0]
  inner_result_aet_spei3 <- bind_rows(inner_result_aet_spei2)
  outer_result_aet_spei[[i]]<- inner_result_aet_spei3}
names(outer_result_aet_spei)<- provs_arranged_lat[-9]

aet_spei_seas <- bind_rows(outer_result_aet_spei, .id="Provenance") 

aet_spei_seas_allp <- aet_spei_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% aet_spei_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(aet_spei_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_aet","sec_spei"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("aet, spei")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_aet_spei <- aet_spei_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "AET", "SPEI"))

ggplot(timeline_aet_spei, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")
  
cor_analysis_plot_pc1_aet_spei<- ggplot(timeline_aet_spei, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("AET","SPEI")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = AET")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(),strip.text = element_text(size=10, color="black"))

png("figures/cor_analysis_timeline_aet.png", width=9,height=10, units="in", res=500)
ggarrange(cor_analysis_plot_pc1_aet_spei,
          cor_analysis_plot_pc1_aet_cwd, nrow=2, common.legend = TRUE, labels = c("A)","B)"))
dev.off()

```

#####precip & temp seasons

```{r}

temp_precip_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(temp= tmean_comb_plantation_wide, precip = ppt_comb_plantation_wide),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
temp_precip_list[[i]]<- result
}

inner_result_temp_precip<- list()
outer_result_temp_precip<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(temp_precip_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
temp_precip_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_temp_precip[[j]]<- result}

  inner_result_temp_precip2 <- inner_result_temp_precip[sapply(inner_result_temp_precip, function(x) dim(x)[1])>0]
  inner_result_temp_precip3 <- bind_rows(inner_result_temp_precip2)
  outer_result_temp_precip[[i]]<- inner_result_temp_precip3}
names(outer_result_temp_precip)<- provs_arranged_lat[-9]

temp_precip_seas <- bind_rows(outer_result_temp_precip, .id="Provenance") 

temp_precip_seas_allp <- temp_precip_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% temp_precip_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(temp_precip_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_temp","sec_precip"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("temp, precip")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_temp_precip <- temp_precip_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "temp", "precip"))

ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")

prov_pcapts %>% arrange(PC1) %>% pull(Provenance)

ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")

season.labels = data.frame(date = c(my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")) %m+% months(1) + days(15),
                           season = rep(c("Sm","Sp","Wt","Fa"),2))
  
cor_analysis_plot_pc1_temp<- ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("temp","precip")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = Temp")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(),strip.text = element_text(size=10, color="black"))

ggplot(timeline_temp_precip, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC2) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
      geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC2) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC2) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
  facet_wrap(~factor(var, levels=c("temp","precip")))+
  geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = Temp")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank())

```


```{r}

precip_temp_list <- list()
for(i in 1:length(provs_arranged_lat[-9])){
result <- seascorr(chrono = chron.list[[i]],
                         climate= list(precip = ppt_comb_plantation_wide,temp= tmean_comb_plantation_wide),
                         timespan = c(1985,2015),
                         complete= 9,
                         season_lengths=seq(4,12,1),
                         primary=1,
                         secondary=2,
                         ci=0.05)
precip_temp_list[[i]]<- result
}

inner_result_precip_temp<- list()
outer_result_precip_temp<- list()

for(i in 1:length(provs_arranged_lat[-9])){
for(j in 1:length(seq(4,12,1))){
result<- bind_rows(precip_temp_list[[i]]$coef[[j]]$primary %>% bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var="primary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE),
precip_temp_list[[i]]$coef[[j]]$secondary %>% 
bind_cols(data.frame(month=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP"), var = "secondary", seasonl = seq(4,12,1)[j])) %>% 
  filter(significant==TRUE) 
)
 inner_result_precip_temp[[j]]<- result}

  inner_result_precip_temp2 <- inner_result_precip_temp[sapply(inner_result_precip_temp, function(x) dim(x)[1])>0]
  inner_result_precip_temp3 <- bind_rows(inner_result_precip_temp2)
  outer_result_precip_temp[[i]]<- inner_result_precip_temp3}
names(outer_result_precip_temp)<- provs_arranged_lat[-9]

precip_temp_seas <- bind_rows(outer_result_precip_temp, .id="Provenance") 

precip_temp_seas_allp <- precip_temp_seas%>% 
  bind_rows(data.frame(Provenance = data.frame(Provenance=provs_arranged_lat[-9]) %>% filter(!Provenance %in% precip_temp_seas$Provenance),coef=0,significant=TRUE,month="AUG",var="primary",seasonl=4))

ggplot(precip_temp_seas_allp, aes(x=factor(month, levels=c("Aug","Sep","Oct","Nov","Dec","JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP")), y=coef, fill=factor(Provenance, levels=provs_arranged_lat[-9])))+
  geom_bar(stat="identity")+
  facet_grid(rows=vars(factor(var, levels=c("primary","secondary"),labels=c("pri_temp","sec_precip"))),cols=vars(seasonl), )+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ggtitle("temp, precip")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

timeline_precip_temp <- precip_temp_seas_allp %>% 
  mutate(year = ifelse(month %in% c("Aug","Sep","Oct","Nov","Dec"), 1754, 1755),
         month.num = case_when(month %in% c("Aug","AUG") ~ 08,
                               month %in% c("Sep","SEP") ~ 09,
                               month %in% c("Oct","OCT") ~ 10,
                               month %in% c("Nov","NOV") ~ 11,
                               month == "Dec" ~12,
                               month == "JAN" ~ 01,
                               month == "FEB" ~ 02,
                               month == "MAR"~ 03,
                               month == "APR" ~ 04,
                               month == "MAY" ~ 05,
                               month == "JUN" ~06,
                               month == "JUL" ~ 07)) %>% 
  mutate(date = my(paste(month.num,year, sep="-"))) %>% 
  mutate(startdate = date %m-% months(seasonl-1)) %>% 
  mutate(var = ifelse(var == "primary", "temp", "precip"))

ggplot(timeline_precip_temp, aes(y=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=provs_bylat$Provenance), yend=factor(Provenance, levels=provs_bylat$Provenance), col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")

ggplot(timeline_precip_temp, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))), linewidth=5, alpha=0.3)+
  scale_color_manual(values=unname(stepped()))+
  geom_vline(xintercept = c(my("09-1755"), my("05-1755")))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  theme(legend.position = "none")
  
cor_analysis_plot_pc1_precip<- ggplot(timeline_precip_temp, aes(y=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance))))+
  geom_rect(aes(xmin=my("09-1753"), xmax = my("09-1754"),ymax=Inf, ymin=-Inf), fill="gray90")+
    geom_rect(aes(xmin=my("06-1755"), xmax = my("09-1755"),ymax=Inf, ymin=-Inf), fill="lightyellow")+
  geom_segment(aes(x=startdate, xend = date, y = factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), yend=factor(Provenance, levels=prov_pcapts %>% arrange(PC1) %>% pull(Provenance)), col=coef), linewidth=5, alpha=0.3)+
  scale_color_gradientn(colors=c("red","white","blue"))+
  geom_vline(xintercept = c(my("09-1755"), my("06-1755"),my("03-1755"),my("12-1754"),my("09-1754"),my("06-1754"),my("03-1754"),my("12-1753"),my("09-1753")))+
    geom_text(data=season.labels, aes(x=date, y=0.7, label=season))+
  facet_wrap(~var)+
  theme_bw()+
  ylab("")+
  xlab("")+
  ggtitle("Primary = Precip")+
  theme(axis.text.x = element_blank(), panel.grid = element_blank(), axis.text.y = element_text(color="black", size=12), axis.ticks.x = element_blank(), strip.text = element_text(size=10, color="black"))

png("figures/cor_analysis_timeline.png", width=9,height=10, units="in", res=500)
ggarrange(cor_analysis_plot_pc1_temp,
          cor_analysis_plot_pc1_precip, nrow=2, common.legend = TRUE, labels = c("A)","B)"))
dev.off()
```


####climwin

```{r}
rwi.stats(growth.detrended.all)

ppt_comb_plantation_update <- ppt_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

tmean_comb_plantation_update<- tmean_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

tmin_comb_plantation_update<- tmin_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

tmax_comb_plantation_update<- tmax_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

vpdmax_comb_plantation_update<- vpdmax_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))
  
vpdmin_comb_plantation_update<- vpdmin_comb_plantation %>% 
  mutate(year = year(date), month=month(date), day=day(date)) %>% 
  mutate(newdate = paste(day,month,year,sep="/"))

rwi_test<- growth.detrended.common %>% 
  as.data.frame() %>% 
  mutate(year=(row.names(growth.detrended.common))) %>% 
  dplyr::select(year, `47C2`) %>% 
  rename(rw = `47C2`) %>% 
  mutate(date = paste("01/01/",year,sep=""))

growth.detrended.common.df <- growth.detrended.common %>% 
  mutate(year=row.names(growth.detrended.common)) %>% 
  pivot_longer(!year) %>% 
  left_join(dbh_age_summary %>% 
  dplyr::select(Provenance,tree) %>% 
  mutate(tree=substr(tree,2,length(tree))), by=c("name"="tree")) %>% 
  mutate(date = paste("01/01/",year,sep=""))
  

output <- slidingwin(exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ Provenance, data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month"
           )

# Examine tested combinations
 
output$combos
     
# View output for func = "lin"
 
head(output[[1]]$Dataset) 
plotdelta(output[[1]]$Dataset)
medwin(output[[1]]$Dataset)

dataset_ppt <- output[[1]]$Dataset
ConfidenceSet_ppt <- dataset_ppt[which(cumsum(dataset_ppt$ModWeight) <= 0.95),]
sum(ConfidenceSet_ppt$ModelBeta*ConfidenceSet_ppt$ModWeight)

dataset_tmean <- output[[2]]$Dataset
ConfidenceSet_tmean <- dataset_tmean[which(cumsum(dataset_tmean$ModWeight) <= 0.95),]
sum(ConfidenceSet_tmean$ModelBeta*ConfidenceSet_tmean$ModWeight)
plotdelta(output[[2]]$Dataset)
medwin(output[[2]]$Dataset)

dataset_tmin <- output[[3]]$Dataset
ConfidenceSet_tmin <- dataset_tmin[which(cumsum(dataset_tmin$ModWeight) <= 0.95),]
sum(ConfidenceSet_tmin$ModelBeta*ConfidenceSet_tmin$ModWeight)
plotdelta(output[[3]]$Dataset)
medwin(output[[3]]$Dataset)
summary(output[[3]]$BestModel)


dataset_tmax <- output[[4]]$Dataset
ConfidenceSet_tmax <- dataset_tmax[which(cumsum(dataset_tmax$ModWeight) <= 0.95),]
sum(ConfidenceSet_tmax$ModelBeta*ConfidenceSet_tmax$ModWeight)
plotdelta(output[[4]]$Dataset)
summary(output[[4]]$BestModel)


dataset_vpdmin <- output[[5]]$Dataset
ConfidenceSet_vpdmin <- dataset_vpdmin[which(cumsum(dataset_vpdmin$ModWeight) <= 0.95),]
sum(ConfidenceSet_vpdmin$ModelBeta*ConfidenceSet_vpdmin$ModWeight)
plotdelta(output[[5]]$Dataset)
medwin(output[[5]]$Dataset)

dataset_vpdmax <- output[[6]]$Dataset
ConfidenceSet_vpdmax <- dataset_vpdmax[which(cumsum(dataset_vpdmax$ModWeight) <= 0.95),]
sum(ConfidenceSet_vpdmax$ModelBeta*ConfidenceSet_vpdmax$ModWeight)
plotdelta(output[[6]]$Dataset)


## To test if the climate signal could have occurred due to chance, we next run the randomisation procedure using the function randwin, with repeats = 5.

output.rand <- randwin(repeats = 5, 
                       exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ Provenance, data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month")


#The output of the randwin function can then be used to run the function pvalue to return a value of PC.

pvalue(dataset = output[[1]]$Dataset, datasetrand = output.rand[[1]], metric = "C", sample.size = 2720)  ##high pvalue means that this climate signal is not very strong (high probability that it occurred by chance)
pvalue(dataset = output[[2]]$Dataset, datasetrand = output.rand[[2]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[3]]$Dataset, datasetrand = output.rand[[3]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[4]]$Dataset, datasetrand = output.rand[[4]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[5]]$Dataset, datasetrand = output.rand[[5]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[6]]$Dataset, datasetrand = output.rand[[6]], metric = "C", sample.size = 2720)

##using cross validation
outputk <- slidingwin(xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = rwi_test$date,
           baseline = lm(rw ~ 1, data=rwi_test),
           range = c(24,0),
           type="absolute", refday = c(1,12),
           stat = "mean",
           func = c("lin","quad"),
           cmissing = FALSE,
           cinterval = "month",
           k=10)

outputk$combos

output.randk <- randwin(repeats = 5, 
                       exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ Provenance, data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month",
                       k=10)


pvalue(dataset = output[[1]]$Dataset, datasetrand = output.randk[[1]], metric = "C", sample.size = 2720)
pvalue(dataset = output[[1]]$Dataset, datasetrand = output.randk[[1]], metric = "C", sample.size = 2720)

```


```{r}
#trying climwin without provenance as an effect

output_nop <- slidingwin(exclude = c(2,12),
          xvar=list(ppt = ppt_comb_plantation_update$ppt,
                               tmean = tmean_comb_plantation_update$tmean,
                               tmin = tmin_comb_plantation_update$tmin,
                               tmax = tmax_comb_plantation_update$tmax,
                               vpdmin = vpdmin_comb_plantation_update$vpdmin,
                               vpdmax = vpdmax_comb_plantation_update$vpdmax),
           cdate = ppt_comb_plantation_update$newdate,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ 1 , data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(1,10),
           stat = "mean",
           func = c("lin"),
           cmissing = FALSE,
           cinterval = "month"
           )
output_nop$combos

```

```{r}
##try with bioclim vars

output_bioclim <- slidingwin(xvar=list(aet = bioclim_date$aet,
                               cwd = bioclim_date$cwd,
                               spei = bioclim_date$spei),
           cdate = bioclim_date$date,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ 1 , data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(01,10),
           stat = "sum",
           func = c("lin","quad"),
           cmissing = FALSE,
           cinterval = "month"
           )

output_bioclim$combos

plotdelta(output_bioclim[[1]]$Dataset)
summary(output_bioclim[[1]]$BestModel) #positive effect of aet on RWI

plotdelta(output_bioclim[[2]]$Dataset)
summary(output_bioclim[[2]]$BestModel) #positive effect of cwd on RWI

plotdelta(output_bioclim[[3]]$Dataset)
summary(output_bioclim[[3]]$BestModel) #positive effect of spei on RWI

plotdelta(output_bioclim[[4]]$Dataset)
summary(output_bioclim[[4]]$BestModel) 

plotdelta(output_bioclim[[5]]$Dataset)
summary(output_bioclim[[5]]$BestModel)

plotdelta(output_bioclim[[6]]$Dataset)
summary(output_bioclim[[6]]$BestModel) 

output_bioclim_rand <- randwin(repeats = 5, 
                       xvar=list(aet = bioclim_date$aet,
                               cwd = bioclim_date$cwd,
                               spei = bioclim_date$spei),
           cdate = bioclim_date$date,
           bdate = growth.detrended.common.df$date,
           baseline = lm(value ~ 1 , data=growth.detrended.common.df),
           range = c(24,0),
           type="absolute", refday = c(01,10),
           stat = "sum",
           func = c("lin","quad"),
           cmissing = FALSE,
           cinterval = "month")


#The output of the randwin function can then be used to run the function pvalue to return a value of PC.

pvalue(dataset = output_bioclim[[1]]$Dataset, datasetrand = output_bioclim_rand[[1]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[2]]$Dataset, datasetrand = output_bioclim_rand[[2]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[3]]$Dataset, datasetrand = output_bioclim_rand[[3]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[4]]$Dataset, datasetrand = output_bioclim_rand[[4]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[5]]$Dataset, datasetrand = output_bioclim_rand[[5]], metric = "C", sample.size = 2720) 

pvalue(dataset = output_bioclim[[6]]$Dataset, datasetrand = output_bioclim_rand[[6]], metric = "C", sample.size = 2720) 

```



###Resistance vs. Resilience

####Odd time periods

#####Raw ring widths

```{r}
#######
# calculate different time periods
#######
droughtyear = 2002
buffertime = seq(0,3,1)
raw_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))
}

rawmodlist_resistance<- list()
for(i in 1:length(raw_calcs_list)){
rawmodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=raw_calcs_list[[i]])
}
summary(rawmodlist_resistance[[1]])
summary(rawmodlist_resistance[[2]]) #3yr periods significant for resistance
TukeyHSD(rawmodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
ggplot(data=as.data.frame(raw_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(rawmodlist_resistance[[3]])
summary(rawmodlist_resistance[[4]]) 

rawmodlist_resilience<- list()
for(i in 1:length(raw_calcs_list)){
rawmodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=raw_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(rawmodlist_resilience[[1]])
summary(rawmodlist_resilience[[2]]) ##3 year periods marginally significant
TukeyHSD(rawmodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
summary(rawmodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05). Inlet creek is lower than Gila for resilience
TukeyHSD(rawmodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
RR_5yrs_0004 <- raw_calcs_list[[3]] %>% as.data.frame()
ggplot(RR_5yrs_0004, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(rawmodlist_resilience[[4]]) 

####
```


#####Detrended with spline

```{r}
###DETRENDED DATA
droughtyear = 2002
buffertime = seq(0,3,1)
spline_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rw = mean(rw_spline))

predrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rw = mean(rw_spline))

postdrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rw = mean(rw_spline))

spline_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")
}

splinemodlist_resistance<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=spline_calcs_list[[i]])
}
summary(splinemodlist_resistance[[1]])
summary(splinemodlist_resistance[[2]]) #3yr still significant but diff provs
TukeyHSD(splinemodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
ggplot(as.data.frame(spline_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resistance[[3]])
summary(splinemodlist_resistance[[4]]) 

splinemodlist_resilience<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=spline_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(splinemodlist_resilience[[1]])
summary(splinemodlist_resilience[[2]]) ##3 year periods is significant
TukeyHSD(splinemodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #all Gila
summary(splinemodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05)
TukeyHSD(splinemodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #Gila, in addition to Inlet Creek being lower than Larimer 2 and Pike
ggplot(as.data.frame(spline_calcs_list[[3]]), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resilience[[4]]) 

####

lapply(spline_calcs_list, summary)
spline_calcs_list[[1]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[2]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[3]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[4]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience,na.rm=T))

```

####Even time periods

#####Raw ring widths

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0102 <- left_join(drought_rw_0102,predrought_rw_0102) %>% left_join(postdrought_rw_0102) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0102 <- aov(resistance ~ Provenance, data=raw_calcs_0102)

summary(rawmodlist_resistance_0102)
TukeyHSD(rawmodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwise differences

rawmodlist_resilience_0102 <- aov(resilience ~ Provenance, data=raw_calcs_0102)

summary(rawmodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0203 <- left_join(drought_rw_0203,predrought_rw_0203) %>% left_join(postdrought_rw_0203) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))

rawmodlist_resistance_0203 <- aov(resistance ~ Provenance, data=raw_calcs_0203)

summary(rawmodlist_resistance_0203)

rawmodlist_resilience_0203 <- aov(resilience ~ Provenance, data=raw_calcs_0203)

summary(rawmodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0104 <- left_join(drought_rw_0104,predrought_rw_0104) %>% left_join(postdrought_rw_0104) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0104 <- aov(resistance ~ Provenance, data=raw_calcs_0104)

summary(rawmodlist_resistance_0104)

rawmodlist_resilience_0104 <- aov(resilience ~ Provenance, data=raw_calcs_0104)

summary(rawmodlist_resilience_0104)
TukeyHSD(rawmodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0104 <- raw_calcs_0104 %>% as.data.frame()
ggplot(RR_4yrs_0104, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0003 <- left_join(drought_rw_0003,predrought_rw_0003) %>% left_join(postdrought_rw_0003) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))

rawmodlist_resistance_0003 <- aov(resistance ~ Provenance, data=raw_calcs_0003)

summary(rawmodlist_resistance_0003)

rawmodlist_resilience_0003 <- aov(resilience ~ Provenance, data=raw_calcs_0003)

summary(rawmodlist_resilience_0003)
TukeyHSD(rawmodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0003 <- raw_calcs_0003 %>% as.data.frame()
ggplot(RR_4yrs_0003, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years not significant for either resistance or resilience

drought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0005 <- left_join(drought_rw_0005,predrought_rw_0005) %>% left_join(postdrought_rw_0005) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0005 <- aov(resistance ~ Provenance, data=raw_calcs_0005)

summary(rawmodlist_resistance_0005)

rawmodlist_resilience_0005 <- aov(resilience ~ Provenance, data=raw_calcs_0005 %>% filter(!is.na(resilience)))

summary(rawmodlist_resilience_0005)

#99-04 - 6 years not significant for either resistance or resilience

drought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_9904 <- left_join(drought_rw_9904,predrought_rw_9904) %>% left_join(postdrought_rw_9904) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_9904 <- aov(resistance ~ Provenance, data=raw_calcs_9904)

summary(rawmodlist_resistance_9904)

rawmodlist_resilience_9904 <- aov(resilience ~ Provenance, data=raw_calcs_9904)

summary(rawmodlist_resilience_9904)
TukeyHSD(rawmodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0003 <- raw_calcs_0003 %>% as.data.frame()
ggplot(RR_4yrs_0003, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

#####Detrended ring with spline

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0102 <- left_join(drought_rwi_0102,predrought_rwi_0102) %>% left_join(postdrought_rwi_0102) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0102 <- aov(resistance ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resistance_0102)
TukeyHSD(splinemodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwiise differences

splinemodlist_resilience_0102 <- aov(resilience ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rwi_0203<- growth.detrended.df %>%
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0203 <- left_join(drought_rwi_0203,predrought_rwi_0203) %>% left_join(postdrought_rwi_0203) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0203 <- aov(resistance ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resistance_0203)

splinemodlist_resilience_0203 <- aov(resilience ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0104 <- left_join(drought_rwi_0104,predrought_rwi_0104) %>% left_join(postdrought_rwi_0104) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0104 <- aov(resistance ~ Provenance, data=spline_calcs_0104)
TukeyHSD(splinemodlist_resistance_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


summary(splinemodlist_resistance_0104)

splinemodlist_resilience_0104 <- aov(resilience ~ Provenance, data=spline_calcs_0104)

summary(splinemodlist_resilience_0104)
TukeyHSD(splinemodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0003 <- left_join(drought_rwi_0003,predrought_rwi_0003) %>% left_join(postdrought_rwi_0003) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0003 <- aov(resistance ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resistance_0003)

splinemodlist_resilience_0003 <- aov(resilience ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resilience_0003)
TukeyHSD(splinemodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0003), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years 

drought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0005 <- left_join(drought_rwi_0005,predrought_rwi_0005) %>% left_join(postdrought_rwi_0005) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")


splinemodlist_resistance_0005 <- aov(resistance ~ Provenance, data=spline_calcs_0005)

summary(splinemodlist_resistance_0005)

splinemodlist_resilience_0005 <- aov(resilience ~ Provenance, data=spline_calcs_0005 %>% filter(!is.na(resilience)))

summary(splinemodlist_resilience_0005)
TukeyHSD(splinemodlist_resilience_0005)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0005), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#99-04 - 6 years not significant for either resistance or resilience

drought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_9904 <- left_join(drought_rwi_9904,predrought_rwi_9904) %>% left_join(postdrought_rwi_9904) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")


splinemodlist_resistance_9904 <- aov(resistance ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resistance_9904)

splinemodlist_resilience_9904 <- aov(resilience ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resilience_9904)
TukeyHSD(splinemodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_9904), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

###### summary stats
spline_calcs_0102 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0203 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0104 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0003 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0005 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience,na.rm=T), sd.resil = sd(resilience,na.rm=T))

spline_calcs_9904 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience, na.rm=T), sd.resil = sd(resilience, na.rm=T))
```

####Climate Trends in RR

#####resistance

```{r}
##I'm going to look at trends in resistance and resilience (spline detrended) due to provenance climate using the 4 year periods, where the drought period = 2001-2004 as this seems to be the period where there are the most differences between provenances in resistance and resilience.

RR4_clim<- spline_calcs_0104 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR4_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

survmod_pcx<- glmer(Stat14 ~ PC1+ I(PC1^2) + PC2 + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=moniger_survival, family="binomial")


##PCA models
resis_mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR4_clim)
plot(resis_mod_pcx)
qqmath(resis_mod_pcx)
summary(resis_mod_pcx) 

resis_mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_pcx_noG)
qqmath(resis_mod_pcx_noG)
summary(resis_mod_pcx_noG) #nothing significant when Gila removed

dredge(resis_mod_pcx) ##null model is the best

resis_mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR4_clim)
plot(resis_mod_pcy)
qqmath(resis_mod_pcy)
summary(resis_mod_pcy) 

resis_mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_pcy_noG)
qqmath(resis_mod_pcy_noG)
summary(resis_mod_pcy_noG) #nothing significant when Gila removed

dredge(resis_mod_pcy) ##null model is the best


#distance model
resis_mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim)
plot(resis_mod_dist)
qqmath(resis_mod_dist)
summary(resis_mod_dist) #geographic distance to the plantation is significant

resis_mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_dist_noG)
qqmath(resis_mod_dist_noG)
summary(resis_mod_dist_noG) #geographic distance to the plantation is still significant

dredge(resis_mod_dist) ##null model is best though...

##figure for effect of geo dist on resistance
newdata_geodist <- data.frame(
    geo.dist.to.plant.km = seq(min(RR4_clim$geo.dist.to.plant.km), 
                      max(RR4_clim$geo.dist.to.plant.km), length.out = 100), 
    dist.to.plant = mean(RR4_clim$dist.to.plant))

##take random effect out to make predictions
resis_mod_dist_lm <- lm(log(resistance) ~  scale(dist.to.plant)*scale(geo.dist.to.plant.km), data=RR4_clim)

predicted_scores <- predict(
  resis_mod_dist_lm, 
  newdata = newdata_geodist, interval='confidence') %>% as.data.frame()

newdata_geodist_pred <- bind_cols(newdata_geodist, predicted_scores)

ggplot()+
  geom_point(data=RR4_clim, aes(x=geo.dist.to.plant.km, y=log(resistance)))+
  geom_ribbon(data=newdata_geodist_pred, aes(x=geo.dist.to.plant.km,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_geodist_pred, aes(x=geo.dist.to.plant.km, y=fit), col="turquoise")
```

######all other time periods
```{r}

#####01-02
RR0102_clim<- spline_calcs_0102 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0102_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0102mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0102_clim)
plot(resis_0102mod_pcx)
qqmath(resis_0102mod_pcx)
summary(resis_0102mod_pcx) 

resis_0102mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_pcx_noG)
qqmath(resis_0102mod_pcx_noG)
summary(resis_0102mod_pcx_noG) #nothing significant when Gila removed

dredge(resis_0102mod_pcx) ##null model is the best

resis_0102mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0102_clim)
plot(resis_0102mod_pcy)
qqmath(resis_0102mod_pcy)
summary(resis_0102mod_pcy) 

resis_0102mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_pcy_noG)
qqmath(resis_0102mod_pcy_noG)
summary(resis_0102mod_pcy_noG) #latitude is significant when Gila removed

dredge(resis_0102mod_pcy) ##null model is the best still though 

#distance model
resis_0102mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0102_clim)
plot(resis_0102mod_dist)
qqmath(resis_0102mod_dist)
summary(resis_0102mod_dist) #geographic distance to the plantation is significant

resis_0102mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_dist_noG)
qqmath(resis_0102mod_dist_noG)
summary(resis_0102mod_dist_noG) #geographic distance to the plantation is not significant

dredge(resis_0102mod_dist) ##null model is best 
```

```{r}
#####02-03
RR0203_clim<- spline_calcs_0203 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0203_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0203mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0203_clim)
plot(resis_0203mod_pcx)
qqmath(resis_0203mod_pcx)
summary(resis_0203mod_pcx) 

resis_0203mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0203mod_pcx_noG)
qqmath(resis_0203mod_pcx_noG)
summary(resis_0203mod_pcx_noG) #nothing significant 

dredge(resis_0203mod_pcx) ##null model is the best

resis_0203mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0203_clim)
plot(resis_0203mod_pcy)
qqmath(resis_0203mod_pcy)
summary(resis_0203mod_pcy) 

resis_0203mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0203mod_pcy_noG)
qqmath(resis_0203mod_pcy_noG)
summary(resis_0203mod_pcy_noG) 

dredge(resis_0203mod_pcy) ##null model is the best 

#distance model
resis_0203mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0203_clim)
plot(resis_0203mod_dist)
qqmath(resis_0203mod_dist)
summary(resis_0203mod_dist) #climatic distance to the plantation is significant

resis_0203mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0203_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0203mod_dist_noG)
qqmath(resis_0203mod_dist_noG)
summary(resis_0203mod_dist_noG) #nothing significant when gila removed

dredge(resis_0203mod_dist) ##null model is best 
```

```{r}
#####00-03
RR0003_clim<- spline_calcs_0003 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0003_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0003mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0003_clim)
plot(resis_0003mod_pcx)
qqmath(resis_0003mod_pcx)
summary(resis_0003mod_pcx) 

resis_0003mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0003mod_pcx_noG)
qqmath(resis_0003mod_pcx_noG)
summary(resis_0003mod_pcx_noG) #nothing significant 

dredge(resis_0003mod_pcx) ##null model is the best

resis_0003mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0003_clim)
plot(resis_0003mod_pcy)
qqmath(resis_0003mod_pcy)
summary(resis_0003mod_pcy) 

resis_0003mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0003mod_pcy_noG)
qqmath(resis_0003mod_pcy_noG)
summary(resis_0003mod_pcy_noG) 

dredge(resis_0003mod_pcy) ##null model is the best 

#distance model
resis_0003mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0003_clim)
plot(resis_0003mod_dist)
qqmath(resis_0003mod_dist)
summary(resis_0003mod_dist) #climatic distance to the plantation is significant

resis_0003mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0003mod_dist_noG)
qqmath(resis_0003mod_dist_noG)
summary(resis_0003mod_dist_noG) #nothing significant when gila removed

dredge(resis_0003mod_dist) ##null model is best 
```

```{r}
#####00-05
RR0005_clim<- spline_calcs_0005 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR0005_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_0005mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR0005_clim)
plot(resis_0005mod_pcx)
qqmath(resis_0005mod_pcx)
summary(resis_0005mod_pcx) 

resis_0005mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0005mod_pcx_noG)
qqmath(resis_0005mod_pcx_noG)
summary(resis_0005mod_pcx_noG) #PC2 significant 

dredge(resis_0005mod_pcx) ##null model is the best

resis_0005mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR0005_clim)
plot(resis_0005mod_pcy)
qqmath(resis_0005mod_pcy)
summary(resis_0005mod_pcy) 

resis_0005mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0005mod_pcy_noG)
qqmath(resis_0005mod_pcy_noG)
summary(resis_0005mod_pcy_noG) 

dredge(resis_0005mod_pcy) ##null model is the best 

#distance model
resis_0005mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0005_clim)
plot(resis_0005mod_dist)
qqmath(resis_0005mod_dist)
summary(resis_0005mod_dist) #climatic distance to the plantation is significant

resis_0005mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR0005_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0005mod_dist_noG)
qqmath(resis_0005mod_dist_noG)
summary(resis_0005mod_dist_noG) #nothing significant when gila removed

dredge(resis_0005mod_dist) ##null model is best 
```

```{r}
#####99-04
RR9904_clim<- spline_calcs_9904 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR9904_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_9904mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR9904_clim)
plot(resis_9904mod_pcx)
qqmath(resis_9904mod_pcx)
summary(resis_9904mod_pcx) 

resis_9904mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_9904mod_pcx_noG)
qqmath(resis_9904mod_pcx_noG)
summary(resis_9904mod_pcx_noG) #nothing significant 

dredge(resis_9904mod_pcx) ##null model is the best

resis_9904mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR9904_clim)
plot(resis_9904mod_pcy)
qqmath(resis_9904mod_pcy)
summary(resis_9904mod_pcy) 

resis_9904mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_9904mod_pcy_noG)
qqmath(resis_9904mod_pcy_noG)
summary(resis_9904mod_pcy_noG) 

dredge(resis_9904mod_pcy) ##null model is the best 

#distance model
resis_9904mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR9904_clim)
plot(resis_9904mod_dist)
qqmath(resis_9904mod_dist)
summary(resis_9904mod_dist) #climatic distance to the plantation is significant

resis_9904mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_9904mod_dist_noG)
qqmath(resis_9904mod_dist_noG)
summary(resis_9904mod_dist_noG) #nothing significant when gila removed

dredge(resis_9904mod_dist) ##null model is best 
```


```{r}
#####99-04
RR1_clim<- spline_calcs_list[[1]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR1_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_1mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR1_clim)
plot(resis_1mod_pcx)
qqmath(resis_1mod_pcx)
summary(resis_1mod_pcx) 

resis_1mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_1mod_pcx_noG)
qqmath(resis_1mod_pcx_noG)
summary(resis_1mod_pcx_noG) #nothing significant 

dredge(resis_1mod_pcx) ##null model is the best

resis_1mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR1_clim)
plot(resis_1mod_pcy)
qqmath(resis_1mod_pcy)
summary(resis_1mod_pcy) 

resis_1mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_1mod_pcy_noG)
qqmath(resis_1mod_pcy_noG)
summary(resis_1mod_pcy_noG) 

dredge(resis_1mod_pcy) ##null model is the best 

#distance model
resis_1mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR1_clim)
plot(resis_1mod_dist)
qqmath(resis_1mod_dist)
summary(resis_1mod_dist) 

resis_1mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR1_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_1mod_dist_noG)
qqmath(resis_1mod_dist_noG)
summary(resis_1mod_dist_noG) #nothing significant when gila removed

dredge(resis_1mod_dist) ##null model is best 
```

```{r}
#####3 year
RR2_clim<- spline_calcs_list[[2]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR2_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_2mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR2_clim)
plot(resis_2mod_pcx)
qqmath(resis_2mod_pcx)
summary(resis_2mod_pcx) 

resis_2mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_2mod_pcx_noG)
qqmath(resis_2mod_pcx_noG)
summary(resis_2mod_pcx_noG) #nothing significant 

dredge(resis_2mod_pcx) ##null model is the best

resis_2mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR2_clim)
plot(resis_2mod_pcy)
qqmath(resis_2mod_pcy)
summary(resis_2mod_pcy) 

resis_2mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_2mod_pcy_noG)
qqmath(resis_2mod_pcy_noG)
summary(resis_2mod_pcy_noG) 

dredge(resis_2mod_pcy) ##null model is the best 

#distance model
resis_2mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR2_clim)
plot(resis_2mod_dist)
qqmath(resis_2mod_dist)
summary(resis_2mod_dist) 

resis_2mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR2_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_2mod_dist_noG)
qqmath(resis_2mod_dist_noG)
summary(resis_2mod_dist_noG) #nothing significant when gila removed

dredge(resis_2mod_dist) ##null model is best 
```

```{r}
#####5 year
RR3_clim<- spline_calcs_list[[3]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR3_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_3mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR3_clim)
plot(resis_3mod_pcx)
qqmath(resis_3mod_pcx)
summary(resis_3mod_pcx) 

resis_3mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_pcx_noG)
qqmath(resis_3mod_pcx_noG)
summary(resis_3mod_pcx_noG) #nothing significant 

dredge(resis_3mod_pcx) ##null model is the best

resis_3mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR3_clim)
plot(resis_3mod_pcy)
qqmath(resis_3mod_pcy)
summary(resis_3mod_pcy) 

resis_3mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_pcy_noG)
qqmath(resis_3mod_pcy_noG)
summary(resis_3mod_pcy_noG) 

dredge(resis_3mod_pcy) ##null model is the best 

#distance model
resis_3mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR3_clim)
plot(resis_3mod_dist)
qqmath(resis_3mod_dist)
summary(resis_3mod_dist) 

resis_3mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_dist_noG)
qqmath(resis_3mod_dist_noG)
summary(resis_3mod_dist_noG) #nothing significant when gila removed

dredge(resis_3mod_dist) ##null model is best 
```

```{r}
#####7 year
RR7_clim<- spline_calcs_list[[4]] %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

ggplot(RR7_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_7mod_pcx <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR7_clim)
plot(resis_7mod_pcx)
qqmath(resis_7mod_pcx)
summary(resis_7mod_pcx) 

resis_7mod_pcx_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2)+ (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_7mod_pcx_noG)
qqmath(resis_7mod_pcx_noG)
summary(resis_7mod_pcx_noG) #nothing significant 

dredge(resis_7mod_pcx) ##null model is the best

resis_7mod_pcy <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR7_clim)
plot(resis_7mod_pcy)
qqmath(resis_7mod_pcy)
summary(resis_7mod_pcy) 

resis_7mod_pcy_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2)+ (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_7mod_pcy_noG)
qqmath(resis_7mod_pcy_noG)
summary(resis_7mod_pcy_noG) 

dredge(resis_7mod_pcy) ##null model is the best 

#distance model
resis_7mod_dist <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR7_clim)
plot(resis_7mod_dist)
qqmath(resis_7mod_dist)
summary(resis_7mod_dist) 

resis_7mod_dist_noG <- lmer(log(resistance) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR7_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_7mod_dist_noG)
qqmath(resis_7mod_dist_noG)
summary(resis_7mod_dist_noG) #nothing significant when gila removed

dredge(resis_7mod_dist) ##null model is best 
```

#####resilience

```{r}
###resilience
resil_mod_pcx <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR4_clim)
plot(resil_mod_pcx)
qqmath(resil_mod_pcx)
summary(resil_mod_pcx)
ggplot(RR4_clim, aes(x=PC1, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

RR4_clim_noG <- RR4_clim %>% filter(!Provenance == "Gila NF")

resil_mod_pcx_noG <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=RR4_clim_noG)
plot(resil_mod_pcx_noG)
qqmath(resil_mod_pcx_noG)
summary(resil_mod_pcx_noG)

dredge(resil_mod_pcx) #PC1 is only term when Gila is included
dredge(resil_mod_pcx_noG) #null is best when Gila is excluded

resil_mod_pcy <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR4_clim)
plot(resil_mod_pcy)
qqmath(resil_mod_pcy)
summary(resil_mod_pcy)
ggplot(RR4_clim, aes(x=PC1, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

resil_mod_pcy_noG <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=RR4_clim_noG)
plot(resil_mod_pcy_noG)
qqmath(resil_mod_pcy_noG)
summary(resil_mod_pcy_noG)

dredge(resil_mod_pcy) #PC1 is only term when Gila is included
dredge(resil_mod_pcy_noG) #null is best when Gila is excluded


##distance
resil_mod_dist <- lmer(resilience ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim)
plot(resil_mod_dist)
qqmath(resil_mod_dist)
summary(resil_mod_dist) #both significant
dredge(resil_mod_dist) #just pca distance is best model

resil_mod_dist_noG <- lmer(resilience ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=RR4_clim_noG)
plot(resil_mod_dist_noG)
qqmath(resil_mod_dist_noG)
summary(resil_mod_dist_noG) #only geo distance significant when Gila is excluded
dredge(resil_mod_dist_noG) #null model is better though

##figure for effect of geo dist on resilience
##take random effect out to make predictions
resil_mod_dist_lm_noG <- lm(resilience ~  scale(dist.to.plant)*scale(geo.dist.to.plant.km), data=RR4_clim_noG)

predicted_scores_resil <- predict(
  resil_mod_dist_lm_noG, 
  newdata = newdata_geodist, interval='confidence') %>% as.data.frame()

newdata_geodist_pred_resil <- bind_cols(newdata_geodist, predicted_scores_resil)

ggplot()+
  geom_point(data=RR4_clim_noG, aes(x=geo.dist.to.plant.km, y=resilience))+
  geom_ribbon(data=newdata_geodist_pred_resil, aes(x=geo.dist.to.plant.km,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_geodist_pred_resil, aes(x=geo.dist.to.plant.km, y=fit), col="turquoise")

```

###Other Metrics

####long pre-drought

```{r}
###calculate resistance using all growth data from 1985 - 2001 as the pre-drought period
drought_new<- growth.detrended.df %>% 
  filter(year == 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2002) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs <- left_join(drought_new,predrought_new) %>% 
  mutate(resistance = drought_ave/predrought_ave) %>% 
  left_join(dbh_age %>% dplyr::select(tree,Provenance) %>% unique(), by="tree")

mean(new_calcs$resistance)

new_aov_resist <- aov(resistance ~ Provenance, data=new_calcs)
par(mfrow=c(2,2))
plot(new_aov_resist)
summary(new_aov_resist) #no difference in resistance when compared to average growth 1985-2002

ggplot(new_calcs, aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##drought year = 2003
drought03_new<- growth.detrended.df %>% 
  filter(year == 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought03_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2003) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs03 <- left_join(drought03_new,predrought03_new) %>% 
  mutate(resistance = drought_ave/predrought_ave) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

new_aov_resist03 <- aov(resistance ~ Provenance, data=new_calcs03)
par(mfrow=c(2,2))
plot(new_aov_resist03)
summary(new_aov_resist03) #no difference in resistance in 2003 when compared to average growth 1985-2002
```

####recovery time
```{r}
#####recovery time 

no_reduction<- growth.detrended.df %>% 
  filter(year == 2002) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff<0) ##50 trees didn't reduce growth in 2002

count_no_red<- growth.detrended.df %>%
  filter(year==2002) %>% 
  group_by(Provenance) %>% 
  summarise(ntrees=n()) %>% 
  left_join(no_reduction %>% group_by(Provenance) %>% summarise(nNR=n()))

ggplot(count_no_red, aes(x=Provenance, y=(nNR/ntrees)*100))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
  
recover_time<- growth.detrended.df %>%
  filter(!tree %in% no_reduction$tree) %>% 
  filter(year > 2001) %>%
  left_join(predrought_new) %>% 
  mutate(diff = rw_spline - predrought_ave) %>% 
  filter(diff>0) %>% 
  group_by(tree) %>% 
  summarise(minyr = min(year)) %>% 
  mutate(recoverytime = as.numeric(minyr) - 2002) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

aov.recover <- aov(recoverytime ~ Provenance, data=recover_time)
summary(aov.recover)  #no difference in recovery time

ggplot(recover_time, aes(x=Provenance, y=recoverytime))+
  geom_boxplot()+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##climate model for recovery time
recover_time_clim <- recover_time %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

recov_mod_pcax <- lmer(log(recoverytime) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(x) + I(scale(x)^2) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pcax)
qqmath(recov_mod_pcax)
summary(recov_mod_pcax)
dredge(recov_mod_pcax) #null model is best

recov_mod_pcay <- lmer(log(recoverytime) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + scale(y) + I(scale(y)^2) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pcay)
qqmath(recov_mod_pcay)
summary(recov_mod_pcay)
dredge(recov_mod_pcay) #null model is best

recov_mod_dist <- lmer(log(recoverytime) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_dist)
qqmath(recov_mod_dist)
summary(recov_mod_dist)
dredge(recov_mod_dist) #null model is best

###
not_recovered<- dbh_age_good %>% 
  filter(! tree %in% no_reduction$tree) %>% 
  filter(! tree %in% recover_time$tree) 
not_recovered ##all of the trees recovered

#total growth reduction
growth_red<- growth.detrended.df %>% 
  filter(!tree %in% no_reduction$tree) %>% 
  filter(!tree %in% unique(not_recovered$tree)) %>% 
  filter(year>2001) %>% 
  left_join(predrought_new) %>% 
  mutate(growth_red = predrought_ave-rw_spline) %>% 
  filter(growth_red>0)

growth_red_sum <- growth_red %>% 
  left_join(recover_time, by="tree") %>% 
  mutate(year_diff = minyr-year) %>% 
  filter(year_diff > 0) %>% 
  group_by(tree) %>% 
  summarise(max.growth.red = max(growth_red), sum.growth.red=sum(growth_red)) %>% 
  left_join(growth_red, by=c("max.growth.red" = "growth_red", "tree")) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  left_join(recover_time, by=c("newname"="Provenance", "tree")) %>% 
  left_join(left_join(prov_pcapts,pca_dist_df), by=c("newname"="Provenance")) %>% 
  left_join(geo.dist.df, by=c("newname"="Provenance"))

##max growth reduction models
#anova
aov.mgr <- aov(max.growth.red ~ Provenance, data=growth_red_sum)
par(mfrow=c(2,2))
plot(aov.mgr)
summary(aov.mgr)  #no significant difference in max growth reduction between provenances

#linear models
mgr.pcmodx <- lmer(max.growth.red ~ PC1*PC2 + scale(x) + I(scale(x)^2) + (1|Provenance), data=growth_red_sum)
plot(mgr.pcmodx)
qqmath(mgr.pcmodx)
summary(mgr.pcmodx)
dredge(mgr.pcmodx) #null is best

mgr.pcmody <- lmer(max.growth.red ~ PC1*PC2 + scale(y) + I(scale(y)^2) + (1|Provenance), data=growth_red_sum)
plot(mgr.pcmody)
qqmath(mgr.pcmody)
summary(mgr.pcmody)
dredge(mgr.pcmody) #null is best

mgr.distmod <- lmer(max.growth.red ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=growth_red_sum)
plot(mgr.distmod)
qqmath(mgr.distmod)
summary(mgr.distmod) #nothing significant

ggplot(growth_red_sum, aes(x=Provenance, y=max.growth.red))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


##sum growth reduction models
#anova
aov.sumgr <- aov(log(sum.growth.red) ~ Provenance, data=growth_red_sum)
par(mfrow=c(2,2))
plot(aov.sumgr)
summary(aov.sumgr)  #no significant difference in sum growth reduction between provenances

#linear models
sumgr.pcmodx <- lmer(log(sum.growth.red) ~ PC1*PC2 + scale(x) + I(scale(x)^2) + (1|Provenance), data=growth_red_sum)
plot(sumgr.pcmodx)
qqmath(sumgr.pcmodx)
summary(sumgr.pcmodx)
dredge(sumgr.pcmodx) #null is best

sumgr.pcmody <- lmer(log(sum.growth.red) ~ PC1*PC2 + scale(y) + I(scale(y)^2) + (1|Provenance), data=growth_red_sum)
plot(sumgr.pcmody)
qqmath(sumgr.pcmody)
summary(sumgr.pcmody)
dredge(sumgr.pcmody) #null is best

sumgr.distmod <- lmer(log(sum.growth.red) ~ scale(dist.to.plant)*scale(geo.dist.to.plant.km) + (1|Provenance), data=growth_red_sum)
plot(sumgr.distmod)
qqmath(sumgr.distmod)
summary(sumgr.distmod) #nothing significant

ggplot(growth_red_sum, aes(x=Provenance, y=sum.growth.red))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

```


##Correlations

###climate x climate cors
```{r}
##look at correlation between current year and previous year climate variables at plantation

plantation_clim_minus1<- plantation_clim %>% mutate(year = year+1) %>% 
 dplyr::select(c(CN:year,ppt_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum))

colnames(plantation_clim_minus1)<- paste("prior_",colnames(plantation_clim_minus1),sep="")

plantation_clim_cor<- plantation_clim %>% 
 dplyr::select(c(CN:year,ppt_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
 dplyr::select(-c(CN,year)) %>% 
  cor()

plantation_clim_cor>0.7

ggcorrplot(plantation_clim_cor, type="lower", insig = "blank", lab=FALSE)

plantation_clim_cor_yrof<- plantation_clim %>% 
 dplyr::select(c(CN:year,ppt_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  filter(! year %in% c(1970)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
 dplyr::select(-c(CN,year)) %>% 
  cor()

ggcorrplot(plantation_clim_cor_yrof, type="lower", insig = "blank", lab=TRUE)
```

###growth x climate cors

```{r}
##calculate correlations between detrended growth and climate at plantation
growth_climate_df <- growth.detrended.df %>% 
  left_join(plantation_clim) %>% 
 dplyr::select(c(CN:year,ppt_sm:ppt_sp, vpdmax_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  filter(!is.na(rw_spline))



climvars <- colnames(growth_climate_df %>% dplyr::select(-c(CN:year)))
tree_ids <- unique(growth_climate_df$tree)

gc_cor_df<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i])
  tree <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline)
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df <- bind_rows(gc_cor_df, row)
  }}
gc_cor_df %>% dplyr::pull(V2) %>% unique() %>% length()

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  arrange(n) %>% 
  print(n=40) #number of trees with significant correlations between growth and each climate var

gc_cor_df %>% 
  group_by(V2) %>% 
  summarise(maxcor = max(rw_spline, na.rm=T)) %>% 
  left_join(gc_cor_df, by=c("maxcor"="rw_spline", "V2")) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% print(n=50) #number of trees whose maximum correlation value is with each climate var 

cor_clean <- gc_cor_df %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>%
  filter(!is.na(cor))

ggplot(cor_clean %>% filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")), aes(x=Provenance, y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_wrap(~factor(climvar, levels=c("aet_sum","cwd_wy","FDSI","spei_sum", "prior_aet_sum","prior_cwd_wy","prior_FDSI","prior_spei_sum")),nrow=2)+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))
  
##all the rest of the climate variables
ggplot(cor_clean %>% filter(!climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=code, y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_wrap(~climvar)+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))
###

cor_summary<- gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>%
  filter(!is.na(cor)) %>% 
  group_by(Provenance, climvar) %>% 
  summarise(n=n(), meancor = mean(cor), se=sd(cor)/sqrt(n())) %>% 
  ungroup() %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  rename(Provenance = newname) %>% 
  left_join(prov_names)

ggplot(cor_summary %>% filter(n > 1), aes(x=climvar, y=meancor, fill=meancor>0))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymax = meancor+se, ymin=meancor-se), width=0.2)+
  scale_fill_viridis(discrete=TRUE, direction=-1)+
  facet_grid(~code)+
  coord_flip()+
  geom_hline(yintercept=0)

allanovas<- data.frame()
for(i in 1:length(climvars)){
mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == climvars[i]))
modanova <- as.data.frame(Anova(mod, type="2"))
pvalue<- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Pr(>F)`)
provSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Sum Sq`)
provdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Df`)
residSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Sum Sq`)
residdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Df`)
allanovas <- bind_rows(allanovas, data.frame(climvar=climvars[i],pvalue=pvalue, provMS = provSS/provdf, residMS = residSS/residdf, provdf=provdf, residdf = residdf))
}

allanovas %>% mutate(diff = residMS - provMS) %>% arrange(diff) ##when residMS is greater than provMS (diff > 0)--> variation within provenances is greater than variation between them 
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff>0) %>% nrow()
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff<0) %>% nrow()

allanovas %>% filter(pvalue<0.05) #no significant differences between provenances in how correlated RWI is to climate vars

ggplot(data=cor_clean, aes(x=Provenance, y=cor))+
  geom_boxplot()+
  facet_wrap(~climvar)

##T-TESTS
provs <- unique(cor_clean$Provenance)
ttestdata<- data.frame()

for(i in 1:length(climvars)){
  for(j in 1:length(provs)){
data <- cor_clean %>% 
  filter(climvar==climvars[i]) %>% 
  filter(Provenance == provs[j])

test<- t.test(data$cor, y = NULL,
       alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

row <- data.frame(climvar = climvars[i], Provenance = provs[j], lwr = test$conf.int[1], upr = test$conf.int[2], estimate = test$estimate, pvalue = test$p.value)

ttestdata <- bind_rows(ttestdata, row)}}

sig.cors.byprov <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>% 
  filter(!is.na(pvalue)) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

nonsig.provs <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>% 
  dplyr::select(climvar, Provenance, pvalue) %>% 
  unique() %>%
  group_by(Provenance) %>% 
  summarise(sum = sum(pvalue, na.rm=T)) %>% 
  filter(sum==0)%>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

nonsig_data<- data.frame(climvar=rep(unique(sig.cors.byprov$climvar),2),newname=rep(nonsig.provs$newname, each=8), Provenance = rep(nonsig.provs$Provenance, each=8))

correlation_plot<- ggplot(data=sig.cors.byprov %>% bind_rows(nonsig_data) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=estimate))+
    geom_jitter(data= cor_clean %>% filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>% left_join(name_conversion, by=c("Provenance"="oldname")) %>% dplyr::select(-Provenance) %>% left_join(prov_names, by=c("newname"="Provenance")), aes(x=factor(code, levels=provs_bylat$code), y=cor), fill="gray", color="black", size=2, height=0, width=0.1, alpha=0.2)+
  geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_wrap(~factor(climvar, levels=c("aet_sum","prior_aet_sum","cwd_wy","prior_cwd_wy","FDSI","prior_FDSI","spei_sum","prior_spei_sum")),ncol=2)+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8, color="black"),
        axis.text.y = element_text(size=10, color="black"),
        axis.title = element_text(size=10, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=10),
        panel.grid = element_blank())

# png("figures/correlation_plot.png", width=6.5, height=5, res = 300, units = "in")
# correlation_plot
# dev.off()
```

###linear models G x C
```{r}
######testing relationships between growth and climate across all trees with provenance as a random effect

all_lms<- data.frame()
for(i in 1:length(climvars)){
mod <- lmer(growth_climate_df %>% pull(rw_spline) ~ growth_climate_df %>% pull(climvars[i]) + (1|Provenance), data=growth_climate_df)
summary<- as.data.frame(summary(mod)$coefficients) 
pvalue <- summary %>% slice(2) %>% pull(`Pr(>|t|)`)
all_lms <- bind_rows(all_lms, data.frame(var=climvars[i], pvalue=pvalue))
}

all_lms %>% 
  filter(pvalue<0.05) %>% 
  pull(var) 

plantation_clim %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  dplyr::select(c(all_lms %>% 
  filter(pvalue<0.05) %>% 
  pull(var) )) %>% 
  dplyr::select(-c("ppt_sm","ppt_sp","ppt_fa","prior_ppt_sm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean")) %>% 
  cor() %>% 
  ggcorrplot()

all_lms %>% 
  filter(pvalue<0.05) %>% 
  filter(! var %in% c("ppt_sm","ppt_sp","ppt_fa","prior_ppt_sm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean"))

climmod_cor <- lmer(log(rw_spline) ~ ppt_gs + ppt_wt + vpdmax_sm + vpdmax_fa + vpdmax_wt + vpdmax_sp + prior_ppt_gs + prior_ppt_wt + prior_value_sm_tmin + prior_value_fa_tmin + prior_value_wt_tmin + prior_vpdmax_sm + prior_vpdmax_fa + prior_vpdmax_wt + prior_vpdmax_sp + (1|Provenance), data=growth_climate_df)
plot(climmod_cor)
qqmath(climmod_cor)
summary(climmod_cor)
vif(climmod_cor)

##now model with all composite variables

climmod_cor_composite <- lmer(rw_spline ~ scale(aet_sum) + I(scale(aet_sum)^2) + scale(cwd_wy) + I(scale(cwd_wy)^2) + scale(spei_sum) + I(scale(spei_sum)^2)+ scale(prior_FDSI) + I(scale(prior_FDSI)^2) + scale(prior_aet_sum) + I(scale(prior_aet_sum)^2) + scale(prior_cwd_wy) + I(scale(prior_cwd_wy)^2) + scale(prior_spei_sum) + I(scale(prior_spei_sum)^2) + (1|Provenance), data=growth_climate_df)
plot(climmod_cor_composite)
qqmath(climmod_cor_composite)
summary(climmod_cor_composite)
vif(climmod_cor_composite)
#dredge.composite <- dredge(climmod_cor_composite) takes a long time ~30 min
#dredge.composite ##best model by far has aet_sum + aet_sum^2 + cwd_wy + cwd_wy^2 + prior_aet_sum + prior_aet_sum^2 + prior_FDSI + prior_spei_sum + prior_spei_sum^2 + spei_sum + spei_sum^2
best.model.comp <- lm(rw_spline ~ scale(aet_sum) + I(scale(aet_sum)^2) + scale(cwd_wy) + I(scale(cwd_wy)^2) + scale(prior_aet_sum) + I(scale(prior_aet_sum)^2) + scale(prior_FDSI) + scale(prior_spei_sum) + I(scale(prior_spei_sum)^2) + scale(spei_sum) + I(scale(spei_sum)^2), data=growth_climate_df)
par(mfrow=c(2,2))
plot(best.model.comp)
par(mfrow=c(1,1))
summary(best.model.comp)
vif(best.model.comp)

plantation_clim %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  dplyr::select(c("aet_sum" , "cwd_wy" , "prior_aet_sum", "prior_FDSI" , "prior_spei_sum", "spei_sum")) %>% 
  cor()

growth_climate_df %>% dplyr::select(aet_sum, prior_aet_sum, prior_FDSI) %>% summary()

growth_climate_df_forplot <- growth_climate_df %>% 
  mutate(aet_sum_cat = case_when(aet_sum < 295.4 ~ "low",
                                 aet_sum > 295.4 & aet_sum < 319.4 ~ "mid",
                                 aet_sum > 319.4 ~ "high"),
         prior_aet_sum_cat = case_when(prior_aet_sum < 306 ~ "low",
                                 #prior_aet_sum > 295.4 & prior_aet_sum < 319.4 ~ "mid",
                                 prior_aet_sum > 306 ~ "high"),
         prior_FDSI_cat = case_when(prior_FDSI < 0 ~ "low",
                                 #prior_FDSI > -0.54 & prior_FDSI < 0.59 ~ "mid",
                                 prior_FDSI > 0 ~ "high"))

ggplot(growth_climate_df_forplot, aes(x=aet_sum, y=rw_spline))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(prior_aet_sum_cat ~ prior_FDSI_cat)+
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "prior AET", breaks = NULL, labels = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "prior FDSI", breaks = NULL, labels = NULL))

ggplot(growth_climate_df_forplot, aes(x=aet_sum, y=rw_spline, col=prior_aet_sum_cat))+
  geom_point()+
  geom_smooth(method="lm")

ggplot(growth_climate_df_forplot, aes(x=aet_sum, y=rw_spline, col=prior_FDSI_cat))+
  geom_point()+
  geom_smooth(method="lm")
```

###provenance climate affect on Gx C correlation 
```{r}

##############################################

##make a big climate model

mod <- lmer(rw_spline ~ aet_sum + vpdmax_wt + prior_ppt_gs + prior_cwd_wy + prior_value_wt_tmin + prior_value_wt_tmean + (1|Provenance), data=growth_climate_df)
plot(mod)
qqmath(mod)
summary(mod) ##singular model means that provenance doesn't really matter when it comes to growth-climate correlations. 
## they're all correlated with the same things...but is the strength of the correlation weaker or stronger depending on provenance? How do I test this...

modclimprov <- lm(rw_spline ~ aet_sum*Provenance + vpdmax_wt*Provenance + prior_ppt_gs*Provenance + prior_cwd_wy*Provenance + prior_value_wt_tmin*Provenance + prior_value_wt_tmean*Provenance, data=growth_climate_df)
par(mfrow=c(2,2))
plot(modclimprov)
anova(modclimprov)

cor_provclim<- cor_clean %>%
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  dplyr::rename(Provenance = newname) %>% 
  left_join(
prov_pcapts %>% 
  dplyr::select(c(Provenance,PC1:PC2,MAT:pas,smrpb)), by="Provenance")

cor_provclim_long <- pivot_longer(cor_provclim, PC1:smrpb)

# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
names <- unique(cor_provclim_long$name)
lmerdata <- data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(names)){
    data <- cor_provclim_long %>% filter(climvar==climvars[i] & name==names[j]) 
    mod <- lmer(cor ~ value + (1|Provenance), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    
lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvars[i], name=names[j], pvalue.lmer = pvalue.lmer)) 
  }}

lmerdata %>% filter(pvalue.lmer < 0.05)

names <- unique(cor_provclim_long$name)
lmerdata_pcs <- data.frame()
for(i in 1:length(climvars)){
    data <- cor_provclim %>% filter(climvar==climvars[i]) 
    mod <- lmer(cor ~ PC1*PC2 + (1|Provenance), data=data)
    pc1pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[3,] %>% pull(`Pr(>|t|)`)
    pc1pc2pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[4,] %>% pull(`Pr(>|t|)`)

    
lmerdata_pcs <- bind_rows(lmerdata_pcs, data.frame(climvar=climvars[i], pc1value.lmer = pc1pvalue.lmer, pc2value.lmer = pc2pvalue.lmer, pc1pc2value.lmer = pc1pc2pvalue.lmer)) 
}

lmerdata_pcs %>% 
  filter((pc1pvalue.lmer < 0.05 | pc2pvalue.lmer < 0.05 | pc1pc2value.lmer<0.05))

#ppt_wt x msp
ggplot(data=cor_provclim_long %>% filter(climvar=="ppt_wt"& name=="msp"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("mean summer precip (mm)")+
  ggtitle("ppt_wt")

ppt_wt_msp<- cor_provclim_long %>% filter(climvar=="ppt_wt" & name=="msp") 

ppt_wt_msp_mod <- lmer(cor ~ value + (1|Provenance), data=ppt_wt_msp)
plot(ppt_wt_msp_mod)
qqmath(ppt_wt_msp_mod)
summary(ppt_wt_msp_mod)

#vpdmax_sm x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="vpdmax_sm"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("vpdmax_sm")

vpdmax_sm_PC1<- cor_provclim_long %>% filter(climvar=="vpdmax_sm" & name=="PC1") 

vpdmax_sm_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=vpdmax_sm_PC1)
plot(vpdmax_sm_PC1_mod)
qqmath(vpdmax_sm_PC1_mod)
summary(vpdmax_sm_PC1_mod)

vpdmax_sm_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=vpdmax_sm_PC1 %>% filter(!Provenance=="Gila NF"))
plot(vpdmax_sm_PC1_mod_noG)
qqmath(vpdmax_sm_PC1_mod_noG)
summary(vpdmax_sm_PC1_mod_noG) #still significant without Gila


#vpdmax_wt x smrpb
ggplot(data=cor_provclim_long %>% filter(climvar=="vpdmax_wt"& name=="smrpb"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("smrpb")+
  ggtitle("vpdmax_wt")

vpdmax_wt_smrpb<- cor_provclim_long %>% filter(climvar=="vpdmax_wt" & name=="smrpb") 

vpdmax_wt_smrpb_mod <- lmer(cor ~ value + (1|Provenance), data=vpdmax_wt_smrpb)
plot(vpdmax_wt_smrpb_mod)
qqmath(vpdmax_wt_smrpb_mod)
summary(vpdmax_wt_smrpb_mod)

vpdmax_wt_smrpb_mod_noG <- lmer(cor ~ value + (1|Provenance), data=vpdmax_wt_smrpb %>% filter(!Provenance=="Gila NF"))
plot(vpdmax_wt_smrpb_mod_noG)
qqmath(vpdmax_wt_smrpb_mod_noG)
summary(vpdmax_wt_smrpb_mod_noG) #not significant when Gila is taken out (probably not a real trend)

#FDSI x cmd
fdsi_cwd_plot<- ggplot(data=cor_provclim_long %>% filter(climvar=="FDSI"& name=="cmd"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm", col="royalblue", fill="royalblue", alpha=0.2)+
  xlab("Provenance Climatic Water Deficit")+
  ylab("Correlation")+
  ggtitle("FDSI x RWI")+
  theme_bw()

fdsi_cmd<- cor_provclim_long %>% filter(climvar=="FDSI" & name=="cmd") 

fdsi_cmd_mod <- lmer(cor ~ value + (1|Provenance), data=fdsi_cmd)
plot(fdsi_cmd_mod)
qqmath(fdsi_cmd_mod)
summary(fdsi_cmd_mod)

#FDSI x pas
fdsi_pas_plot <- ggplot(data=cor_provclim_long %>% filter(climvar=="FDSI"& name=="pas"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm", col="royalblue", fill="royalblue", alpha=0.2)+
  xlab("Provenance Precip as Snow (mm)")+
  ylab("Correlation")+
  ggtitle("FDSI x RWI")+
  theme_bw()

fdsi_pas<- cor_provclim_long %>% filter(climvar=="FDSI" & name=="pas") 

fdsi_pas_mod <- lmer(cor ~ value + (1|Provenance), data=fdsi_pas)
plot(fdsi_pas_mod)
qqmath(fdsi_pas_mod)
summary(fdsi_pas_mod)

fdsi_pas_mod_noO <- lmer(cor ~ value + (1|Provenance), data=fdsi_pas %>% filter(!Provenance=="Okanogan NF"))
plot(fdsi_pas_mod_noO)
qqmath(fdsi_pas_mod_noO)
summary(fdsi_pas_mod_noO) #still significant without Okanogan

#prior_value_fa_tmin x bFFP
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin"& name=="bFFP"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("bFFP")+
  ggtitle("prior_value_fa_tmin")

prifatmin_bffp<- cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin" & name=="bFFP") 

prifatmin_bffp_mod <- lmer(cor ~ value + (1|Provenance), data=prifatmin_bffp)
plot(prifatmin_bffp_mod)
qqmath(prifatmin_bffp_mod)
summary(prifatmin_bffp_mod) #significant

#prior_value_fa_tmin x EMT
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin"& name=="EMT"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("EMT")+
  ggtitle("prior_value_fa_tmin")

prifatmin_EMT<- cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin" & name=="EMT") 

prifatmin_EMT_mod <- lmer(cor ~ value + (1|Provenance), data=prifatmin_EMT)
plot(prifatmin_EMT_mod)
qqmath(prifatmin_EMT_mod)
summary(prifatmin_EMT_mod) ##warmer places benefit from prior fall being hotter. 

#prior_value_wt_tmean x map
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_wt_tmean"& name=="map"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("MAP")+
  ggtitle("prior_value_wt_tmean")

priwttmean_map<- cor_provclim_long %>% filter(climvar=="prior_value_wt_tmean" & name=="map") 

priwttmean_map_mod <- lmer(cor ~ value + (1|Provenance), data=priwttmean_map)
plot(priwttmean_map_mod)
qqmath(priwttmean_map_mod)
summary(priwttmean_map_mod) #significant

priwttmean_map_mod_noO <- lmer(cor ~ value + (1|Provenance), data=priwttmean_map %>% filter(!Provenance=="Okanogan NF"))
plot(priwttmean_map_mod_noO)
qqmath(priwttmean_map_mod_noO)
summary(priwttmean_map_mod_noO) #still significant without Okanogan


#prior_value_wt_tmin x map
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_wt_tmin"& name=="map"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("MAP")+
  ggtitle("prior_value_wt_tmin cor")

priwttmin_map<- cor_provclim_long %>% filter(climvar=="prior_value_wt_tmin" & name=="map") 

priwttmin_map_mod <- lmer(cor ~ value + (1|Provenance), data=priwttmin_map)
plot(priwttmin_map_mod)
qqmath(priwttmin_map_mod)
summary(priwttmin_map_mod) #significant

priwttmin_map_mod_noO <- lmer(cor ~ value + (1|Provenance), data=priwttmin_map %>% filter(!Provenance == "Okanogan NF"))
plot(priwttmin_map_mod_noO)
qqmath(priwttmin_map_mod_noO)
summary(priwttmin_map_mod_noO) #not significant when Okanogan is taken out

#prior_value_sp_tmax x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_sp_tmax"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("prior_value_sp_tmax cor")

prisptmax_PC1<- cor_provclim_long %>% filter(climvar=="prior_value_sp_tmax" & name=="PC1") 

prisptmax_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=prisptmax_PC1)
plot(prisptmax_PC1_mod)
qqmath(prisptmax_PC1_mod)
summary(prisptmax_PC1_mod) #significant

prisptmax_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=prisptmax_PC1 %>% filter(!Provenance == "Gila NF"))
plot(prisptmax_PC1_mod_noG)
qqmath(prisptmax_PC1_mod_noG)
summary(prisptmax_PC1_mod_noG) #not significant when Gila is taken out

#prior_value_sp_tmean x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_sp_tmean"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("prior_value_sp_tmean")

prisptmean_PC1<- cor_provclim_long %>% filter(climvar=="prior_value_sp_tmean" & name=="PC1") 

prisptmean_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=prisptmean_PC1)
plot(prisptmean_PC1_mod)
qqmath(prisptmean_PC1_mod)
summary(prisptmean_PC1_mod) #significant

prisptmean_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=prisptmean_PC1 %>% filter(!Provenance=="Gila NF"))
plot(prisptmean_PC1_mod_noG)
qqmath(prisptmean_PC1_mod_noG)
summary(prisptmean_PC1_mod_noG) #still significant when Gila is removed


#prior_value_sp_tmin x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_sp_tmin"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("prior_value_sp_tmin")

prisptmin_PC1<- cor_provclim_long %>% filter(climvar=="prior_value_sp_tmin" & name=="PC1") 

prisptmin_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=prisptmin_PC1)
plot(prisptmin_PC1_mod)
qqmath(prisptmin_PC1_mod)
summary(prisptmin_PC1_mod) #significant

prisptmin_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=prisptmin_PC1 %>% filter(!Provenance == "Gila NF"))
plot(prisptmin_PC1_mod_noG)
qqmath(prisptmin_PC1_mod_noG)
summary(prisptmin_PC1_mod_noG) #still significant when Gila is removed


#prior_vpdmax_sp x map
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp"& name=="map"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("MAP")+
  ggtitle("prior_vpdmax_sp")

prior_vpdmax_sp_map<- cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp" & name=="map") 

prior_vpdmax_sp_map_mod <- lmer(cor ~ value + (1|Provenance), data=prior_vpdmax_sp_map)
plot(prior_vpdmax_sp_map_mod)
qqmath(prior_vpdmax_sp_map_mod)
summary(prior_vpdmax_sp_map_mod)

prior_vpdmax_sp_map_mod_noO <- lmer(cor ~ value + (1|Provenance), data=prior_vpdmax_sp_map %>% filter(!Provenance == "Okanogan NF"))
plot(prior_vpdmax_sp_map_mod_noO)
qqmath(prior_vpdmax_sp_map_mod_noO)
summary(prior_vpdmax_sp_map_mod_noO) #still significant when Okanogan is removed

#prior_vpdmax_sp x pas
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp"& name=="pas"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("precip as snow")+
  ggtitle("prior_vpdmax_sp")

prior_vpdmax_sp_pas<- cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp" & name=="pas") 

prior_vpdmax_sp_pas_mod <- lmer(cor ~ value + (1|Provenance), data=prior_vpdmax_sp_pas)
plot(prior_vpdmax_sp_pas_mod)
qqmath(prior_vpdmax_sp_pas_mod)
summary(prior_vpdmax_sp_pas_mod)

#prior_aet_sum x EMT
aet_emt_plot <- ggplot(data=cor_provclim_long %>% filter(climvar=="prior_aet_sum"& name=="EMT"), aes(x=value/10, y=cor))+
  geom_point()+
  geom_smooth(method="lm", col="royalblue", fill="royalblue", alpha=0.2)+
  xlab("Provenance Extreme Min Temp")+
  ylab("Correlation")+
  ggtitle("Prior Year AET x RWI")+
  theme_bw()

prior_aet_sum_EMT<- cor_provclim_long %>% filter(climvar=="prior_aet_sum" & name=="EMT") 

prior_aet_sum_EMT_mod <- lmer(cor ~ value + (1|Provenance), data=prior_aet_sum_EMT)
plot(prior_aet_sum_EMT_mod)
qqmath(prior_aet_sum_EMT_mod)
summary(prior_aet_sum_EMT_mod)

#prior_cwd_wy x TD
cwd_td_plot<- ggplot(data=cor_provclim_long %>% filter(climvar=="prior_cwd_wy"& name=="TD"), aes(x=value/10, y=cor))+
  geom_point()+
  geom_smooth(method="lm", col="royalblue", fill="royalblue", alpha=0.2)+
  xlab("Provenance Temperature Differential")+
  ylab("Correlation")+
  ggtitle("Prior Water Year CWD x RWI")+
  theme_bw()

prior_cwd_wy_TD<- cor_provclim_long %>% filter(climvar=="prior_cwd_wy" & name=="TD") 

prior_cwd_wy_TD_mod <- lmer(cor ~ value + (1|Provenance), data=prior_cwd_wy_TD)
plot(prior_cwd_wy_TD_mod)
qqmath(prior_cwd_wy_TD_mod)
summary(prior_cwd_wy_TD_mod)
```

```{r}
##plot with just bioclimate variables
ggplot(data=cor_provclim_long %>% filter(climvar %in% c("FDSI","prior_aet_sum","prior_cwd_wy") & name=="msp"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("mean summer precip (mm)")+
  ggtitle("ppt_wt")

##bioclim individual relationship plots
# png("figures/clim_cor_plot.png", width=6.5, height = 6, units="in", res=500)
# ggarrange(fdsi_cwd_plot, fdsi_pas_plot, aet_emt_plot, cwd_td_plot, labels=c("A)","B)","C)","D)"))
# dev.off()
```


###DBH as a predictor
```{r}
dbh_clim_data <- cor_provclim_long %>% 
  dplyr::select(-c(name,value)) %>% 
  unique() %>% 
  left_join(dbh %>% 
              mutate(tree=paste("X",Series, sep="")) %>% 
              dplyr::select(tree,DBH06,DBH14)) %>% 
  mutate(DBH_recent = case_when(is.na(DBH14) ~ DBH06,
                                .default = DBH14))

ggplot(dbh_clim_data, aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

dbhmods = data.frame()
for(i in 1:length(climvars)){
mod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar==climvars[i]))
dbhmods <- bind_rows(dbhmods, data.frame(climvar = climvars[i], pvalue = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)))}

dbhmods %>% filter(pvalue < 0.05)

##DBH x prior FDSI
DBH_priorFDSImod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_FDSI"))
plot(DBH_priorFDSImod)
qqmath(DBH_priorFDSImod)
summary(DBH_priorFDSImod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_FDSI"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior vpdmax_sum
DBH_priorvpdmaxmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_vpdmax_sm"))
plot(DBH_priorvpdmaxmod)
qqmath(DBH_priorvpdmaxmod)
summary(DBH_priorvpdmaxmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_vpdmax_sm"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior_value_sp_tmin 
DBH_prior_value_sp_tminmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_value_sp_tmin"))
plot(DBH_prior_value_sp_tminmod)
qqmath(DBH_prior_value_sp_tminmod)
summary(DBH_prior_value_sp_tminmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_value_sp_tmin"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior_value_sp_tmean 
DBH_prior_value_sp_tmeanmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_value_sp_tmean"))
plot(DBH_prior_value_sp_tmeanmod)
qqmath(DBH_prior_value_sp_tmeanmod)
summary(DBH_prior_value_sp_tmeanmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_value_sp_tmean"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior ppt wt
DBH_prior_ppt_wtmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_ppt_wt"))
plot(DBH_prior_ppt_wtmod)
qqmath(DBH_prior_ppt_wtmod)
summary(DBH_prior_ppt_wtmod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_ppt_wt"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x prior ppt fa
DBH_prior_ppt_famod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_ppt_fa"))
plot(DBH_prior_ppt_famod)
qqmath(DBH_prior_ppt_famod)
summary(DBH_prior_ppt_famod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_ppt_fa"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x ppt sm
DBH_ppt_smmod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="ppt_sm"))
plot(DBH_ppt_smmod)
qqmath(DBH_ppt_smmod)
summary(DBH_ppt_smmod)

ggplot(dbh_clim_data %>% filter(climvar=="ppt_sm"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

##DBH x ppt fa
DBH_ppt_famod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="ppt_fa"))
plot(DBH_ppt_famod)
qqmath(DBH_ppt_famod)
summary(DBH_ppt_famod)

ggplot(dbh_clim_data %>% filter(climvar=="ppt_fa"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

```


#extra
```{r}

##use PC1 and PC2 rather than climate variables

pca_cor_data<- cor_provclim_long %>% 
  left_join(prov_pcapts %>% dplyr::select(Provenance, PC1, PC2)) %>% 
  dplyr::select(-c(name,value)) %>% 
  unique() %>% 
    mutate(pc1diff = PC1 - prov_pcapts %>% 
  filter(Provenance == "Plantation") %>% 
  pull(PC1),
          pc2diff = PC2 - prov_pcapts %>% 
  filter(Provenance == "Plantation") %>% 
  pull(PC2)) %>% 
  mutate(pcadist = sqrt(pc1diff^2 + pc2diff^2))

unique(cor_provclim_long$climvar)

sig.cors20<- gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  filter(n>20) %>% 
  arrange(n)

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1), aes(x=Provenance, y=cor))+
  geom_boxplot()+
  geom_hline(yintercept = 0, color="red")+
  facet_wrap(~climvar)+
  theme(axis.text.x = element_text(angle=45, hjust=1))

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1) %>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1), aes(x=PC2, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

pca_cor_data_filtered <- pca_cor_data %>% filter(climvar%in%sig.cors20$V1)

clim_pcmod <- lmer(cor ~ climvar*PC1 +  climvar*PC2 + climvar*pcadist + (1|Provenance), data=pca_cor_data)
plot(clim_pcmod)
qqmath(clim_pcmod)
summary(clim_pcmod)
dredge.climpcmod <- dredge(clim_pcmod)
dredge.climpcmod ##the best model just has climvar in it meaning that all provenances regardless of their PC1 or PC2 position are more or less responding the same to the climate variables. 

##use distance in PC and geographic space between population and plantation
ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1) %>% filter(!Provenance=="Gila NF"), aes(x=pcadist, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

pca_cor_data_dist<- pca_cor_data %>% filter(climvar%in%sig.cors20$V1)  %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

pcadist_mod_vpd_data <- pca_cor_data_dist %>% filter(climvar=="vpdmax_wt") %>% filter(!Provenance=="Gila NF")
pcadist_mod_vpd <- lmer(cor ~ pcadist*geo.dist.to.plant.km + (1|Provenance), data=pcadist_mod_vpd_data)
plot(pcadist_mod_vpd)
qqmath(pcadist_mod_vpd)
summary(pcadist_mod_vpd)
dredge(pcadist_mod_vpd)

pcadist_mod_aet_data<- pca_cor_data_dist %>% filter(climvar=="aet_sum")%>% filter(!Provenance=="Gila NF")
pcadist_mod_aet <- lmer(cor ~ pcadist*geo.dist.to.plant.km + (1|Provenance), data=pcadist_mod_aet_data)
plot(pcadist_mod_aet)
qqmath(pcadist_mod_aet)
summary(pcadist_mod_aet)
dredge(pcadist_mod_aet)
##neither model is significant with or without Gila. 

```