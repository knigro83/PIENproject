---
title: "PIEN analysis"
author: "Katie Nigro"
date: "2024-05-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up 

##Packages

```{r}
#load required packages
library(terra)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(dplyr)
library(stringr)
#library(ClimateNAr)
library(ggfortify)
library(RColorBrewer)
library(tidyr)
library(lme4)
library(lmerTest)
library(car)
library(viridis)
library(dplR)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(MuMIn)
library(vegan)
library(cluster)
library(MASS)
library(indicspecies)
library(SPEI)
library(lattice)
library(tibble)
```

##Plot locations

```{r}
#read in site and provenance locations
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")
west_states<- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","California","Oregon","Washington","Kansas","Oklahoma","Texas")
westernus <- us[match(toupper(west_states),toupper(us$NAME_1)),]

##use coordinates adjusted based on elevation and google maps
adjusted_coords<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIEN_corrected_coords.csv")

adjusted_provs<- vect(adjusted_coords, geom=c("long_corrected","lat_corrected"), crs=crs(us))

geo.dist.df<- data.frame(Provenance = adjusted_provs$Provenance, geo.dist.to.plant.km = as.matrix(terra::distance(adjusted_provs))[,21]/1000)

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=adjusted_provs, color="maroon")

#make key for provenance names
prov_names<-adjusted_coords %>% dplyr::select(Provenance, no) %>% 
 separate_wider_delim(Provenance, delim=" ", names=c("first","second","third"), too_few = "align_start", cols_remove=FALSE) %>% 
  separate_wider_delim(first, delim= "-", names=c("first","2"), too_few="align_start") %>% 
    separate_wider_delim(second, delim= "-", names=c("second","3"), too_few="align_start") %>% 
  mutate(across(everything(), ~ replace(.x, is.na(.x), ""))) %>% 
  mutate(code=paste(substr(first,0,2),substr(`2`,0,1),substr(second,0,2),substr(`3`,0,1),third, sep="")) %>% 
  dplyr::select(c(Provenance,no,code)) %>% 
  mutate(no=as.integer(no))
```

#Climate

##ClimateNA

```{r}
#read in climate from climateNA

#first download climate normals from ClimateNA then read in to R
mastervarList <- c('mat', 'map','td','mcmt','msp','shm','nffd','bFFP','eFFP','mwmt','dd_0','dd5','emt','cmd','pas','PPT_sp','PPT_sm') #these are all the climate variables I want

# rasterDownload (region='NA',res='4000m',period='Normal_1961_1990',varList="PPT_sm",sDir='C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIENproject/ClimateNA')

normal_clim_rasters <- c()
for(i in 1:length(mastervarList)){
  normal_clim_rasters[i]<- paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIENproject/ClimateNA/NA/4000m/Normal_1961_1990/",mastervarList[i],".tif",sep="")
}

clim_raster_stack <- rast(normal_clim_rasters)

prov_clim_adjusted_bi <- terra::extract(clim_raster_stack, adjusted_provs, method='bilinear') %>% cbind(as.data.frame(adjusted_provs)) %>% cbind(crds(adjusted_provs)) %>% 
  mutate(smrpb = PPT_sm/PPT_sp, monsoonality = msp/map)

prov_clim_adjusted_bi_long<- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,MAT:PPT_sm, smrpb, monsoonality)) %>% 
  pivot_longer(MAT:monsoonality) %>% 
  mutate(type="adj bilinear") 


#nffd x map
ggplot()+
  geom_point(data=prov_clim_adjusted_bi, size=3, aes(x=nffd, y=map), col="aquamarine3")+
  geom_text(data=prov_clim_adjusted_bi, aes(x=nffd, y=map, label=Provenance), vjust=0.5, hjust=-.1)+
  theme_bw()+
  theme(legend.position = 'none')

#nffd x TD
ggplot()+
  geom_point(data=prov_clim_adjusted_bi, size=3, aes(x=nffd, y=TD), col="aquamarine3")+
  geom_text(data=prov_clim_adjusted_bi, aes(x=nffd, y=TD, label=Provenance), vjust=1)+
  theme_bw()+
  theme(legend.position = 'none')
```

```{r}
#compare climates of provenances
prov_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(Provenance,MAT:pas,smrpb)) %>% 
  left_join(prov_names) %>% 
  pivot_longer(MAT:smrpb, names_to = "var", values_to = "value")

ggplot(prov_vars, aes(x=factor(Provenance), y=value))+
  geom_point(size=4)+
  facet_wrap(~var, scales="free")+
  scale_color_manual(values=heat.colors(21))+
  theme(axis.text.x = element_text(angle=45,hjust=1), legend.position = 'none')
```

##PRISM

```{r}
#read in files
ppt_comb_plantation<- read.csv("ppt_comb_plantation.csv")
tmax_comb_plantation<- read.csv("tmax_comb_plantation.csv")
tmin_comb_plantation<- read.csv("tmin_comb_plantation.csv")
tmean_comb_plantation<- read.csv("tmean_comb_plantation.csv")
vpdmax_comb_plantation<- read.csv("vpdmax_comb_plantation.csv")
vpdmin_comb_plantation<- read.csv("vpdmin_comb_plantation.csv")

ppt_comb_all<- read.csv("ppt_comb_all.csv")
tmax_comb_all<- read.csv("tmax_comb_all.csv")
tmin_comb_all<- read.csv("tmin_comb_all.csv")
tmean_comb_all<- read.csv("tmean_comb_all.csv")
vpdmax_comb_all<- read.csv("vpdmax_comb_all.csv")
vpdmin_comb_all<- read.csv("vpdmin_comb_all.csv")
```

```{r}
##calculate seasonal PRISM values

##ppt
ppt_summed <- as.data.frame(ppt_comb_plantation) %>% 
  mutate(ppt = as.numeric(ppt), year=as.integer(year)) %>%
  filter(!is.na(ppt)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(ppt = sum(ppt)) 

ggplot(ppt_summed %>% filter(CN=="Plantation"), aes(x=year, y=ppt)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(ppt_summed %>% filter(CN=="Plantation") %>% pull(ppt)), col="red")

##seasonal ppt
ppt_seasonal_plantation <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sm = sum(ppt)) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(5,6,7,8,9)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_gs = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(12,1,2)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_wt = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_fa = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sp = sum(ppt))) %>% 
  left_join(ppt_summed) 


##tmin
tmin_summed <- as.data.frame(tmin_comb_plantation) %>% 
  mutate(tmin = as.numeric(tmin), year=as.integer(year)) %>%
  filter(!is.na(tmin)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmin = mean(tmin)) 

ggplot(tmin_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmin)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmin_summed %>% filter(CN=="Plantation") %>% pull(tmin)), col="red")

##tmax
tmax_summed <- as.data.frame(tmax_comb_plantation) %>% 
  mutate(tmax = as.numeric(tmax), year=as.integer(year)) %>%
  filter(!is.na(tmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmax = mean(tmax))

ggplot(tmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmax_summed %>% filter(CN=="Plantation") %>% pull(tmax)), col="red")

##tmean
tmean_summed <- as.data.frame(tmean_comb_plantation) %>% 
  mutate(tmean = as.numeric(tmean), year=as.integer(year)) %>%
  filter(!is.na(tmean)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmean = mean(tmean)) 

ggplot(tmean_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmean)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmean_summed %>% filter(CN=="Plantation") %>% pull(tmean)), col="red")

##seasonal temps
all_temps <- bind_rows(tmean_comb_plantation %>% pivot_longer(tmean), tmin_comb_plantation %>% pivot_longer(tmin), tmax_comb_plantation %>% pivot_longer(tmax))

summertemps <- all_temps %>% filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sm =mean(value))
falltemps <- all_temps %>% filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_fa =mean(value))
wintertemps <- all_temps %>% filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month=="12",year+1,year)) %>% 
  filter(!year %in% c(1970,2017)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_wt =mean(value))
springtemps <- all_temps %>% filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sp =mean(value))

plantation_seasonal_temps <- left_join(summertemps,falltemps) %>% 
  left_join(wintertemps) %>% 
  left_join(springtemps)

plantation_seasonal_temps_wide<- plantation_seasonal_temps %>% 
  pivot_wider(values_from = c(value_sm,value_fa,value_wt,value_sp), names_from = name)

##vpdmax

vpdmax_summed <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(!is.na(vpdmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax = mean(vpdmax))

ggplot(vpdmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=vpdmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(vpdmax_summed %>% filter(CN=="Plantation") %>% pull(vpdmax)), col="red")

vpdmax_seasonal <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sm = mean(vpdmax)) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_fa = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month == "12", year+1, year)) %>% 
  filter(!year %in% c(1970,2017)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_wt = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sp = mean(vpdmax)))


```
##FDSI calculation

```{r}
all_climate <- left_join(ppt_comb_plantation,tmax_comb_plantation) %>% 
  left_join(tmin_comb_plantation) %>% 
  left_join(tmean_comb_plantation) %>% 
  left_join(vpdmax_comb_plantation) %>% 
  left_join(vpdmin_comb_plantation) %>% 
  mutate(vpdmean=(vpdmin+vpdmax)/2)

nrow(all_climate)
nrow(tmin_comb_plantation)

all_climate_long <- all_climate %>% 
 dplyr::select(-X) %>% 
  pivot_longer(c("ppt","tmax","tmin","tmean","vpdmax","vpdmin","vpdmean"), names_to="climvar", values_to = "value") %>% 
  mutate(monthvar = paste(climvar,month,sep=""))

climate_minus1<- all_climate_long %>% 
  mutate(year=year+1) %>% 
  mutate(monthvar = paste("yr1",climvar,month,sep=""))

climate_minus2<- all_climate_long %>% 
  mutate(year=year+2) %>% 
  mutate(monthvar = paste("yr2",climvar,month,sep=""))

climate_allyears <- rbind(all_climate_long, climate_minus1, climate_minus2)


### FDSI CALC

### CALCULATIONS TAKEN FROM WILLIAMS ET AL., 2013 
# DOI: 10.1038/NCLIMATE1693
#https://www.nature.com/articles/nclimate1693
FDSI_C <- climate_allyears %>%
 dplyr::select(-c("date","month","climvar")) %>% 
  pivot_wider(id_cols=c("CN","year"), names_from = monthvar, values_from = value)

head(FDSI_C)

FDSI_raw<- FDSI_C %>% 
  group_by(CN, year) %>% 
  summarise(FDSIvpd=(((vpdmean5+vpdmean6+vpdmean7)/3)+(yr1vpdmean8+yr1vpdmean9+yr1vpdmean10)/3)/2, FDSIppt=log(yr1ppt11+yr1ppt12+ppt1+ppt2+ppt3))

meanVPD <- mean(FDSI_raw$FDSIvpd, na.rm=T)
meanppt <- mean(FDSI_raw$FDSIppt, na.rm=T)
SDVPD <- sd(FDSI_raw$FDSIvpd, na.rm=T)
SDppt <- sd(FDSI_raw$FDSIppt, na.rm=T)
FDSI_raw$zscoreppt <- ((FDSI_raw$FDSIppt-meanppt)/SDppt)
FDSI_raw$zscoreVPD <- ((FDSI_raw$FDSIvpd-meanVPD)/SDVPD)

FDSI_raw$FDSI <- (0.44*(FDSI_raw$zscoreppt)-0.56*(FDSI_raw$zscoreVPD))

ggplot(FDSI_raw, aes(x=year, y=FDSI))+
  geom_line()+
  geom_point()
#I think we need to consider the fact that FDSI was really high right before the drought of the early 2000's so that's why trees may not be showing equivalent growth rates after the drought (cause it was still relatively hot and dry)
```


##CWD calculation

```{r}
source("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/grad school/cwd_function_v3.r")

#get dem
dem_plantation <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/USGS_13_n40w107_20220216.tif")

slpasp <- terrain(dem_plantation, v = c("slope","aspect"))

slpasp_plantation <- terra::extract(slpasp, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")

plantation_cwd_data <- all_climate %>% left_join(as.data.frame(adjusted_provs) %>% bind_cols(crds(adjusted_provs)) %>% filter(Provenance=="Plantation"), by=c("CN"="Provenance")) %>% 
  mutate(soilawc=116.5, foldedaspect = abs(180-abs(slpasp_plantation$aspect - 225)), slope=slpasp_plantation$slope)

plantation_cwd <- cwd_function(site="plantation",slope=plantation_cwd_data$slope, latitude=plantation_cwd_data$y, foldedaspect = plantation_cwd_data$foldedaspect, ppt = plantation_cwd_data$ppt, tmean = plantation_cwd_data$tmean, month = plantation_cwd_data$month, soilawc = plantation_cwd_data$soilawc, year = plantation_cwd_data$year, type="annual")

head(plantation_cwd)

cwd_year0 <- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month<9) %>% 
  group_by(site, year) %>% 
  summarise(cwd_1_9 = sum(cwd))

cwd_yearminus1 <-  plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month>8) %>%
  mutate(wateryear=year+1) %>% 
  group_by(site, wateryear) %>% 
  summarise(cwd_prev = sum(cwd))

wateryear_cwd<- cwd_year0 %>% 
  left_join(cwd_yearminus1, by=c("year" = "wateryear","site")) %>% 
  rowwise() %>% 
  mutate(cwd_wy = sum(cwd_1_9, cwd_prev))

sp_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd))

fa_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(cwd_fa = sum(cwd))

##water year drought
ggplot(wateryear_cwd, aes(x=year, y=cwd_wy))+
  geom_point()+
  geom_line()+
  geom_point(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_line(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_point(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")+
  geom_line(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")  ##1970s and 80s droughts were influenced more by fall lack of moisture than 2002 drought. 


wateryear_cwd %>% 
  filter(cwd_wy>quantile(wateryear_cwd$cwd_wy[-1], c(0.75))+ 1.5*IQR(wateryear_cwd$cwd_wy[-1]))

##spring drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd)), aes(x=year, y=cwd_sp))+
  geom_point()+
  geom_line()

##fall drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)), aes(x=year, y=cwd_fa))+
  geom_point()+
  geom_line()

#summer drought
ggplot(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% filter(month%in%c(6,7,8)), aes(x=date, y=cwd))+
  geom_point(aes(col=factor(year)))+
  geom_line()

#number of times each month throughout the time series had CWD>0. July and August are most common times when CWD > 0, and it averages ~9mm
plantation_cwd %>% 
  filter(cwd>0) %>% 
  group_by(month) %>% 
  summarise(n=n(), mean=mean(cwd))

##summarise monthly climate on an annual basis
plantation_cwd_annual <- plantation_cwd %>% 
  group_by(site,year, soilawc) %>% 
  summarise(ppt_sum = sum(ppt), tmean_ave=mean(tmean), aet_sum=sum(aet), cwd_sum=sum(cwd))

plantation_cwd_annual_long<- plantation_cwd_annual %>% 
  left_join(FDSI_raw %>% dplyr::select(year,FDSI), by="year") %>% 
  dplyr::select(-CN) %>% 
  pivot_longer(ppt_sum:FDSI)

ggplot(plantation_cwd_annual_long %>% filter(name%in%c("cwd_sum","FDSI")), aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales = "free")
  
```

##SPEI

```{r}
##calculate SPEI - Standardized Precipitation Evapotranspiration Index
plantation_climatebalance <- plantation_cwd %>% 
  mutate(ppt_pet = ppt - petm)

plantation_spei <- spei(plantation_climatebalance %>% pull(ppt_pet), scale=1)
plantation_spei$fitted
summary(plantation_spei)

plantation_spei_sum <- data.frame(year=plantation_climatebalance$year, month=plantation_climatebalance$month, spei = plantation_spei$fitted, date = as.Date(paste(plantation_climatebalance$month,"01",plantation_climatebalance$year, sep="/"), "%m/%d/%Y"))

ggplot(plantation_spei_sum %>% filter(year > 1987 & year <2012), aes(x=date, y=spei, fill=spei>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

plantation_spei_annual<- plantation_spei_sum %>% 
  group_by(year) %>% 
  summarise(spei_mean = mean(spei), spei_sum=sum(spei))

ggplot(plantation_spei_annual %>% filter(year > 1987 & year <2012), aes(x=year, y=spei_sum, fill=spei_sum>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

##All climate vars

```{r}
#combine all climate vars

plantation_clim <- ppt_seasonal_plantation %>% 
  left_join(plantation_seasonal_temps_wide) %>% 
  left_join(vpdmax_seasonal) %>% 
  left_join(FDSI_raw) %>% 
  left_join(plantation_cwd_annual) %>% 
  left_join(wateryear_cwd) %>% 
  left_join(plantation_spei_annual)

colnames(plantation_clim)

plantation_clim_long <- plantation_clim %>% 
dplyr::select(c(CN:vpdmax_sp, FDSI, aet_sum, cwd_sum, cwd_wy, spei_sum)) %>% 
  pivot_longer(ppt_sm:spei_sum)
```

##Climate extremes

```{r}
plantation_clim_long_qs<- plantation_clim_long %>% 
  left_join(plantation_clim_long %>% 
  filter(!is.na(value)) %>% 
  group_by(name) %>% 
  summarise(q2.5 = quantile(value, 0.025), q97.5 = quantile(value, 0.975), out.hi = quantile(value, c(0.75))  + IQR(value)*1.5, out.low = quantile(value, c(0.75)) - IQR(value)*1.5))

##look at years where each climate variable exceeded the 97.5th (or 2.5th) percentile - these are years of potentially extreme climate 
ggplot(plantation_clim_long_qs, aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.hi), col="black")

###############
## identify drought year
###############
unique(plantation_clim_long_qs$name)

plantation_clim_xtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("ppt_sm","ppt_gs","ppt_wt","ppt_fa","ppt_sp","ppt","FDSI","aet") & value < out.low, "yes",
                          ifelse(name %in% c("value_sm_tmax","value_sm_tmean","value_sm_tmin","value_fa_tmax","value_fa_tmean","value_fa_tmin","value_wt_tmax","value_wt_tmean","value_wt_tmin","value_sp_tmax","value_sp_tmean","value_sp_tmin","vpdmax_sm","vpdmax_fa","vpdmax_wt","vpdmax_sp","cwd_sum","cwd_wy","spei_sum") & value > out.hi, "yes", "no" 
  ))) %>% 
  filter(extreme=="yes")

View(plantation_clim_xtremes)

plantation_clim_xtremes %>% 
  group_by(year) %>% 
  summarise(n=n()) ##2002 has the highest # of climate vars outside the extreme.
```


##K Means

```{r}
##group provenances and plantation site into "climate groups"

#first look at correlations in climate variables
env_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(MAT:pas,smrpb))

prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Gila NF") %>% 
  dplyr::select(c(MAT:pas,smrpb,y)) %>% 
  cor()

env_vars %>% 
  cor() %>% 
  ggcorrplot()

env_vars %>% 
  cor() %>% 
  abs()>0.9

env_vars_cut <- env_vars %>% 
  dplyr::select(-c(bFFP, eFFP, EMT, pas, dd5, dd_0))

env_vars_cut %>%
  cor() %>% 
  abs()>0.9

#look at linearity of relationships

pairs(env_vars_cut, lower.panel = NULL)

prov_clim_adjusted_bi_wide <- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,MAT:PPT_sm, smrpb, monsoonality))

rownames(prov_clim_adjusted_bi_wide)<- prov_clim_adjusted_bi_wide$Provenance

adjbi_prov_clim_eucdist <- vegdist(prov_clim_adjusted_bi_wide %>% dplyr::select(colnames(env_vars_cut)) %>% as.data.frame(), method="euclidean")

pam4<-pam(adjbi_prov_clim_eucdist,k=4)
pam4
pam4$clustering #view cluster membership
pam4$clusinfo
plot(pam4)

pam5<-pam(adjbi_prov_clim_eucdist,k=5)
pam5
pam5$clustering #view cluster membership
pam5$clusinfo
plot(pam5)

pam6<-pam(adjbi_prov_clim_eucdist,k=6)
pam6
pam6$clustering #view cluster membership
pam6$clusinfo
plot(pam6)

pam7<-pam(adjbi_prov_clim_eucdist,k=7)
pam7
pam7$clustering #view cluster membership - I think this is the best
pam7$clusinfo
plot(pam7)

pam8<-pam(adjbi_prov_clim_eucdist,k=8)
pam8
pam8$clustering #view cluster membership
pam8$clusinfo
plot(pam8)

pam7$silinfo$avg.width #7 groups best by this metric
pam6$silinfo$avg.width 
pam5$silinfo$avg.width
pam8$silinfo$avg.width


```


##PCA

```{r, echo = FALSE}
#run the PCA 
set.seed(83)
clim_pca <- prcomp(env_vars_cut,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals <- (clim_pca$sdev)^2
eigenvals
sum(eigenvals) #the sum of the eigenvalues = the number of variables (9)
eigenvals/sum(eigenvals)#this is the proportion variance explained
summary(clim_pca)
par(mfrow=c(1,1))
plot(clim_pca,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca$rotation[,1:2]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca$rotation[,1:2]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts<- clim_pca$x %>% 
  cbind(prov_clim_adjusted_bi) %>% 
  left_join(prov_names) %>% 
  left_join(data.frame(cluster=pam7$clustering) %>% mutate(Provenance=rownames(data.frame(cluster=pam7$clustering))))

autoplot(clim_pca,x=1,y=2,colour="aquamarine3",loadings.colour="red", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.size=4)+
  geom_point(data=prov_pcapts, aes(x=PC1, y=PC2, col=factor(cluster)), size=5)+
  geom_text_repel(data=prov_pcapts, aes(x=PC1, y=PC2, label=code))+
  theme(text=element_text(size=14, color="black"))
  
autoplot(clim_pca,x=1,y=3,colour="aquamarine3",loadings.colour="red", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.size=6)+
  geom_point(data=prov_pcapts, aes(x=PC1, y=PC3, col=factor(cluster)), size=5)+
  geom_text_repel(data=prov_pcapts, aes(x=PC1, y=PC3, label=code))+
  theme(text=element_text(size=14, color="black"))
  

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names), color="maroon")+
  geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names), aes(label=code), hjust=c(rep(c(-0.2,1),2),-.2,-.2,-.2,0,rep(c(-.2,1),5),1,1,1))

```

```{r}
plantation_pc1<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC1)

plantation_pc2<- prov_pcapts %>% 
  filter(Provenance=="Plantation") %>% 
  pull(PC2)

pca_dist_df <- prov_pcapts %>% 
  mutate(PC1diff = abs(PC1-plantation_pc1), PC2diff = abs(PC2 - plantation_pc2)) %>% 
  mutate(dist.to.plant = sqrt(PC1diff^2 + PC2diff^2)) %>% 
  arrange(dist.to.plant) %>% 
  filter(!Provenance=="Plantation")
```


##PIEN climate niche

```{r}
pien <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/pien_range.tif")

us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps")
states=c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","Kansas")
interiorwest <- us[match(toupper(states),toupper(us$NAME_1)),]


pien2 <- classify(pien, cbind(-Inf, 0, NA), right=TRUE)
plot(pien2)

pien_trim<- trim(pien2)
plot(pien_trim)

pien_IW<- crop(pien_trim %>% project(crs(interiorwest)), interiorwest)
plot(pien_IW)

pien_uniform <- classify(pien_IW, cbind(-Inf,Inf,1))
plot(pien_uniform)

pien_poly <- as.polygons(pien_uniform)
plot(pien_poly)

# engelmann_clim <- terra::extract(clim_raster_stack, pien_poly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)
# 
# ##extract PRISM data for summer/spring precip ratio
# ppt_data_pien<-vector()
# for(j in 1:length(months)){
#   raster<-paste(climdir,'/PRISM_ppt_30yr_normal_800mM4_all_bil/PRISM_ppt_30yr_normal_800mM4_',months[j],'_bil.bil',sep="")
#   rast <- rast(raster)
#   ext.poly <- terra::extract(rast,pien_poly %>% project(crs(clim_raster_stack)), method="simple", weights = TRUE, df=TRUE)
#   ppt<-ext.poly[,2]
#   ID<- seq(1:nrow(ext.poly))
#   month <- rep(months[j],length(ext.poly[,2]))
#   ppt_CN<-cbind(ID,ppt,month)
#   ppt_data_pien<-rbind(ppt_data_pien,ppt_CN)}
# 
# pien_ppt_sum<- ppt_data_pien %>%
#   as.data.frame() %>%
#   unique() %>%
#   mutate(ppt=as.numeric(ppt), ID = as.numeric(ID)) %>%
#   pivot_wider(id_cols=ID, names_from=month, values_from = ppt) %>%
#   rowwise() %>%
#   mutate(JA_ppt = sum(`07`,`08`, na.rm=T), smrpb = sum(`07`,`08`,`09`,na.rm=T)/sum(`04`,`05`,`06`, na.rm=T))
# 
# saveRDS(pien_ppt_sum, "pien_ppt_sum.RDS")
# saveRDS(engelmann_clim, "engelmann_clim.RDS")

pien_ppt_sum <- readRDS("pien_ppt_sum.RDS")

#clim_pien <- left_join(engelmann_clim, pien_ppt_sum) ##not sure how to do this with polygons and weights

engelmann_clim <- readRDS("engelmann_clim.RDS")

ggplot(engelmann_clim, aes(x=MAT, y=map))+
  geom_hex(alpha=0.7)+
  scale_fill_gradientn(colors=c("aquamarine","gold","white"))+
  geom_point(data=prov_pcapts, aes(x=MAT, y=map, col=factor(cluster)), size=4)+
  ggrepel::geom_text_repel(data=prov_pcapts, aes(label=code))+
  theme_bw()+
  theme(text = element_text(size=16, color="black"))
```

#Response variables

##DBH

```{r}
##DBH data is in centimeters
dbh <- read.csv("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Analysis/RWI_data/DBH_data.csv")

name_conversion<- data.frame(oldname = dbh %>% arrange(Provenance) %>% pull(Provenance) %>% unique(),
           newname = prov_names %>% filter(!Provenance=="Plantation") %>%  arrange(Provenance) %>% pull(Provenance) %>% unique())

dbh_long<- dbh %>% 
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  rename(Provenance = newname) %>% 
  filter(!is.na(DBH91)) %>% 
  pivot_longer(DBH91:DBH14, names_to = 'year', values_to = 'DBH')

provs_arranged_lat<- prov_pcapts %>% 
  arrange(y) %>% 
  pull(Provenance)
provs_arranged_lat

dbh_clim_data <- dbh_long %>% 
  left_join(prov_pcapts) %>% 
  filter(!is.na(DBH))


#arranging provenances by different variables to visually identify patterns in DBH
ggplot(dbh_long, aes(x=factor(Provenance, levels=provs_arranged_lat), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

ggplot(dbh_clim_data, aes(x=factor(nffd), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

ggplot(dbh_clim_data, aes(x=factor(cmd), y=DBH, col=Provenance))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))

```

###models

```{r}
dbh_numeric <- dbh_clim_data %>% 
  mutate(num.yr = as.numeric(ifelse(year=="DBH91", 1,
                         ifelse(year=="DBH96", 6,
                                ifelse(year=="DBH06", 16,
                                       ifelse(year=="DBH14", 24, year))))))

dbh_aov <- lm(DBH ~ year*Provenance, data = dbh_numeric)
par(mfrow=c(2,2))
plot(dbh_aov)
anova(dbh_aov) #no significant interaction
dbh_aov_noint <- lm(DBH ~ year + Provenance, data = dbh_numeric)
Anova(dbh_aov_noint, type="2") #both year and provenance are significant but do not interact (relatively similar order of provenance DBH in each year measured)

prov_dbh_order<- dbh_numeric %>% 
  filter(year=="DBH14") %>% 
  group_by(Provenance) %>% 
  summarise(med_DBH = median(DBH, na.rm=T)) %>% 
  arrange(med_DBH)

dbh_early<- ggplot(dbh_numeric %>% filter(!year=="DBH14"), aes(x=factor(year, levels=c("DBH91","DBH96","DBH06"), labels=c(1991,1996,2006)), y=DBH, fill=factor(Provenance, levels=prov_dbh_order$Provenance)))+
  geom_boxplot()+
  scale_x_discrete(name="Year")+
  scale_fill_discrete(name="Provenance")
  
dbh_2014<- ggplot(dbh_numeric %>% filter(year=="DBH14"), aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y=DBH, fill=factor(Provenance, levels=prov_dbh_order$Provenance)))+
  geom_boxplot()+
  scale_x_discrete(name="Year")+
  scale_fill_discrete(name="Provenance")

ggarrange(dbh_early,dbh_2014, nrow=2, common.legend = TRUE)

###model each year separately
dbh_aov91 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH91"))
plot(dbh_aov91)
summary(dbh_aov91)
TukeyHSD(dbh_aov91)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)
 
dbh_aov96 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH96"))
plot(dbh_aov96)
summary(dbh_aov96)
TukeyHSD(dbh_aov96)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)
  
dbh_aov06 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH06"))
plot(dbh_aov06)
summary(dbh_aov06)
TukeyHSD(dbh_aov06)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)
  
dbh_aov14 <- aov(DBH ~ Provenance, data = dbh_numeric %>% filter(year=="DBH14"))
plot(dbh_aov14)
summary(dbh_aov14)
TukeyHSD(dbh_aov14)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj` < 0.05)

##does DBH vary with climate vars?

#just get most recent DBH measurement 
dbh_num14 <- dbh_numeric %>% filter(year=="DBH14")

#cmd
mod_dbh_cmd <- lmer(DBH ~ cmd + (1|Provenance), data=dbh_num14)
par(mfrow=c(1,1))
plot(mod_dbh_cmd)
qqmath(mod_dbh_cmd)
summary(mod_dbh_cmd) 
summary(lmer(DBH ~ cmd + (1|Provenance), data=dbh_num14 %>% filter(!Provenance=="Gila NF")))
##when Gila is taken out, CMD is not significant

ggplot(dbh_num14%>% filter(!Provenance=="Gila NF"), aes(x=cmd, y=DBH))+
  geom_point()+
  geom_smooth(method="lm")

#cluster
mod_dbh_cluster <- aov(DBH ~ cluster, data=dbh_num14)
par(mfrow=c(2,2))
plot(mod_dbh_cluster)
par(mfrow=c(1,1))
summary(mod_dbh_cluster) ##no significant difference between identified "clusters"

ggplot(dbh_num14, aes(x=factor(cluster), y=DBH))+
  geom_boxplot() 

#PC1
mod_dbh_pc1 <- lmer(DBH ~ PC1 + (1|Provenance), data=dbh_num14 %>% filter(!Provenance=="Gila NF"))
plot(mod_dbh_pc1)
qqmath(mod_dbh_pc1)
summary(mod_dbh_pc1) ##when Gila is taken out, PC1 is not significant

ggplot(dbh_num14 %>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=DBH))+
  geom_point()+
  geom_smooth(method="lm")

#PC2
mod_dbh_pc2 <- lmer(DBH ~ PC2 + (1|Provenance), data=dbh_num14)
plot(mod_dbh_pc2)
qqmath(mod_dbh_pc2)
summary(mod_dbh_pc2) 

ggplot(dbh_num14 , aes(x=PC2, y=DBH))+
  geom_point()+
  geom_smooth(method="lm")


ggplot(dbh_numeric %>% 
  filter(year=="DBH14"), aes(x=y, y=DBH))+
  geom_point()+
  geom_smooth(method="lm")

#Latitude
mod_dbh_lat <- lmer(DBH ~ y+ I(y^2) + (1|Provenance), data=dbh_num14)
plot(mod_dbh_lat)
qqmath(mod_dbh_lat)
summary(mod_dbh_lat) #there's a marginally significant quadratic effect of latitude

  #take out Gila
dbh_num14_nogila <- dbh_num14 %>% filter(!Provenance=="Gila NF")

mod_dbh_lat_nogila <- lmer(DBH ~ y+ I(y^2) + (1|Provenance), data=dbh_num14_nogila)
plot(mod_dbh_lat_nogila)
qqmath(mod_dbh_lat_nogila)
summary(mod_dbh_lat_nogila) #when Gila is removed, latitude is highly significant

newdata_lat <- data.frame(
    y = seq(min(dbh_num14_nogila$y), 
                      max(dbh_num14_nogila$y), 
                      length.out = 100
                      )
    )

##take random effect out to make predictions
mod_dbh_lat_nogila_lm <- lm(DBH ~ y+ I(y^2), data=dbh_num14_nogila)

predicted_scores <- predict(
  mod_dbh_lat_nogila_lm, 
  newdata = newdata_lat, interval='confidence') %>% as.data.frame()

newdata_lat_pred <- bind_cols(newdata_lat, predicted_scores)

ggplot()+
  geom_point(data=dbh_num14_nogila, aes(x=y, y=DBH))+
  geom_ribbon(data=newdata_lat_pred, aes(x=y,ymin=lwr,ymax=upr), alpha=0.4, fill="red")+
  geom_line(data=newdata_lat_pred, aes(x=y, y=fit), col="red")+
  geom_vline(xintercept = prov_clim_adjusted_bi %>% filter(Provenance=="Plantation") %>% pull(y))+
  xlab("Latitude")

#Longitude
mod_dbh_lon <- lmer(DBH ~ x+ I(x^2)+(1|Provenance), data=dbh_num14)
plot(mod_dbh_lon)
qqmath(mod_dbh_lon)
summary(mod_dbh_lon) #no significant effects of longitude

  #take out Gila
mod_dbh_lon_nogila <- lmer(DBH ~ x+ I(x^2) + (1|Provenance), data=dbh_num14_nogila)
summary(mod_dbh_lon_nogila) #still not significant


##distance in PCA space from plantation
dbh_num14_pcadist<- dbh_num14 %>% 
  left_join(pca_dist_df %>% dplyr::select(code, dist.to.plant))

mod_dbh_pcadist <- lmer(DBH ~ dist.to.plant + (1|Provenance), data=dbh_num14_pcadist)
plot(mod_dbh_pcadist)
qqmath(mod_dbh_pcadist)
summary(mod_dbh_pcadist) #no significant effects of distance to plantation in PCA space

#TD
mod_dbh_td <- lmer(DBH ~ TD + I(TD^2) + (1|Provenance), data=dbh_num14)
plot(mod_dbh_td)
qqmath(mod_dbh_td)
summary(mod_dbh_td) 
summary(lmer(DBH ~ TD + I(TD^2) + (1|Provenance), data=dbh_num14 %>% filter(!Provenance=="Gila NF")))

#PAS
mod_dbh_pas <- lmer(DBH ~ pas + I(pas^2) + (1|Provenance), data=dbh_num14)
plot(mod_dbh_pas)
qqmath(mod_dbh_pas)
summary(mod_dbh_pas) 
summary(lmer(DBH ~ pas + I(pas^2) + (1|Provenance), data=dbh_num14 %>% filter(!Provenance=="Gila NF")))


dbh_clim_data <- dbh_num14 %>% 
  dplyr::select(c(Series, Provenance, DBH, colnames(env_vars_cut)))

env_vars_cut %>% 
  cor()

dbh_clim_nogila<- dbh_clim_data %>% filter(!Provenance=="Gila NF")

mod_dbh_allclim <- lmer(DBH ~ MAT + I(MAT^2) + map + I(map^2) + TD + I(TD^2) + SHM + I(SHM^2) + nffd  + I(nffd^2) + smrpb + I(smrpb^2) + (1|Provenance), data=dbh_clim_nogila)
plot(mod_dbh_allclim)
qqmath(mod_dbh_allclim)
vif(mod_dbh_allclim)
summary(mod_dbh_allclim)

options(na.action = "na.fail")
mod_dbh_allclim_dredge <- dredge(mod_dbh_allclim)
mod_dbh_allclim_dredge

#smrpb
mod_dbh_smrpb <- lmer(DBH ~ smrpb + I(smrpb^2) + (1|Provenance), data=dbh_num14)
plot(mod_dbh_smrpb)
qqmath(mod_dbh_smrpb)
summary(mod_dbh_smrpb) 
summary(lmer(DBH ~ smrpb + I(smrpb^2) + (1|Provenance), data=dbh_num14 %>% filter(!Provenance=="Gila NF")))

#big model
dbh_num14_alldist <- dbh_num14_pcadist %>% 
  left_join(geo.dist.df)

mod_dbh_big1 <- lmer(DBH ~ dist.to.plant + x + (1|Provenance), data=dbh_num14_alldist)
summary(mod_dbh_big1)
vif(mod_dbh_big1)

dbh_num14_alldist %>% 
  dplyr::select(c(PC1, PC2, dist.to.plant, geo.dist.to.plant.km, x, y)) %>% cor()

mod_dbh_big <- lmer(DBH ~ dist.to.plant + x + I(x^2) + (1|Provenance), data=dbh_num14_alldist)
plot(mod_dbh_big)
qqmath(mod_dbh_big)
summary(mod_dbh_big)
vif(mod_dbh_big)
```

###dbh diff
```{r}
#difference between first and last DBH

dbh_diffs<- dbh %>% 
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  rename(Provenance = newname) %>% 
  mutate(diff_total = DBH14 - DBH91, 
         diff3 = DBH14 - DBH06,
         diff2 = DBH06 - DBH96,
         diff1 = DBH96 - DBH91)

dbh_diffs_long <- dbh_diffs %>% 
  pivot_longer(c(DBH91:DBH14,diff_total:diff1)) %>% 
  left_join(prov_pcapts, by="Provenance") %>% 
  filter(!is.na(value))
  
ggplot(dbh_diffs_long %>% filter(name %in% c("diff_total","diff1","diff2","diff3")), aes(x=factor(Provenance, levels=provs_arranged_lat), y=value, fill=Provenance))+
  geom_boxplot()+
  facet_wrap(~name, scales="free")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##models
diff_total_df <- dbh_diffs_long %>% 
  filter(name == "diff_total")

dbhdiff_mod <- lmer(value ~ PC1 * PC2 + (1|Provenance), data=diff_total_df)
plot(dbhdiff_mod)
lattice::qqmath(dbhdiff_mod)
summary(dbhdiff_mod)

ggplot(dbh_diffs_long, aes(x= PC1, y=value))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~name, scales="free")

```

##Height Growth

```{r}
moniger_data <- read.csv("past_moniger_data.csv")
moniger_data_ids <- read.csv("past_moniger_data_ids.csv")

head(moniger_data_ids)
head(moniger_data)

moniger_data_comb <- moniger_data %>% 
  left_join(moniger_data_ids, by=c("LOC" = "ID.Code")) %>% 
  mutate(Provenance = ifelse(Location == "Larimer County 1","Larimer 1",
                                    ifelse(Location == "Larimer County 2","Larimer 2",Location))) %>% 
  left_join(prov_pcapts)

colnames(moniger_data_comb)

ggplot(moniger_data_comb, aes(x=factor(cmd), y=HT14, fill=Provenance))+
  geom_boxplot()+
  theme(legend.position = 'right', axis.text.x = element_text(angle=45, hjust=1))

ht_data <- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  mutate(growth.m = (value-nursery_ht_m), rel.growth = (value-nursery_ht_m)/nursery_ht_m) %>% 
  filter(!is.na(value))

ht_data_clim <- ht_data %>% 
  left_join(prov_pcapts)

ht.order <- ht_data %>% 
  filter(name=="HT14") %>% 
  group_by(Provenance) %>% 
  summarise(med_rel_growth=median(rel.growth,na.rm=T), med_growth=median(growth.m, na.rm=T), meanht = mean(value, na.rm=T)) %>% 
  arrange(meanht)

#relative growth
ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(Provenance, levels=ht.order$Provenance), y=rel.growth, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), scales="free")+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")+
  theme(axis.text.x = element_blank())

#growth
ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(Provenance, levels=ht.order$Provenance), y=growth.m, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), scales="free")+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")+
  theme(axis.text.x = element_blank())


ht_data_aves <- ht_data %>% filter(!name=="HT74") %>% 
  group_by(name, Provenance,nursery_ht_m ) %>% 
  summarise(meangrowth = mean(growth.m), seRG = sd(growth.m)/sqrt(n()), meantotht = mean(value), seTH = sd(value)/sqrt(n()))

ggplot(ht_data %>% filter(!name=="HT74"), aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=growth.m, fill=factor(Provenance, levels=ht.order$Provenance)))+
  geom_boxplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_fill_discrete(name="Provenance")+
  scale_x_discrete(name="Provenance")

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meangrowth-seRG, ymax=meangrowth+seRG, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meangrowth, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Average relative growth ratio")

##initial height effect on height growth -- looks like there isn't really one
ggplot(data=ht_data_aves, aes(x=nursery_ht_m, y=meangrowth))+
  geom_point()

ggplot(data=ht_data_aves, aes(x=nursery_ht_m, y=meantotht))+
  geom_point()

nurse_ht_mod <- lm(meantotht ~ nursery_ht_m, data=ht_data_aves)
summary(nurse_ht_mod)  ##no effect of nursery height on total height in 2014. 

```

##Total Height

###models

```{r}
##effect of year * provenance
par(mfrow=c(2,2))
plot(lm(value ~ Provenance*name, data=ht_data))

totht_mod <- lm(log(value) ~ Provenance*name, data=ht_data)
par(mfrow=c(2,2))
plot(totht_mod)
anova(totht_mod) ##there is a significant year by provenance interaction

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meantotht-seTH, ymax=meantotht+seTH, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Total Height (m)")


#each year separately
totht_mod74 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
summary(totht_mod74)
TukeyHSD(totht_mod74)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod79 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT79"))
plot(totht_mod79)
summary(totht_mod79)
TukeyHSD(totht_mod79)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod85 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT85"))
plot(totht_mod85)
summary(totht_mod85)
TukeyHSD(totht_mod85)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod91 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
summary(totht_mod74)
TukeyHSD(totht_mod74)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod96 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT96"))
plot(totht_mod96)
summary(totht_mod96)
TukeyHSD(totht_mod96)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod06 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT06"))
plot(totht_mod06)
summary(totht_mod06)
TukeyHSD(totht_mod06)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

totht_mod14 <- aov(value ~ Provenance, data= ht_data %>% filter(name=="HT14"))
plot(totht_mod14)
summary(totht_mod14)
TukeyHSD(totht_mod14)$Provenance %>% 
  as.data.frame() %>% 
  filter(`p adj`<0.05)

```


```{r}
##continuous variable effects on height

ht_data_clim14 <- ht_data_clim %>% filter(name=="HT14")

#cmd
mod_totht_cmd <- lmer(value ~ cmd + (1|Provenance), data=ht_data_clim14)
par(mfrow=c(1,1))
plot(mod_totht_cmd)
qqmath(mod_totht_cmd)
summary(mod_totht_cmd) 
summary(lmer(value ~ cmd + (1|Provenance), data=ht_data_clim14 %>% filter(!Provenance=="Gila NF")))
##when Gila is taken out, CMD is not significant -- same as DBH model

ggplot(ht_data_clim14, aes(x=cmd, y=value, col=Provenance=="Gila NF"))+
  geom_point()+
  geom_smooth(method="lm")

#PC1
mod_totht_PC1 <- lmer(value ~ PC1 + (1|Provenance), data=ht_data_clim14)
par(mfrow=c(1,1))
plot(mod_totht_PC1)
qqmath(mod_totht_PC1)
summary(mod_totht_PC1) 
summary(lmer(value ~ PC1 + (1|Provenance), data=ht_data_clim14 %>% filter(!Provenance=="Gila NF")))
##when Gila is taken out, PC1 is not significant 

ggplot(ht_data_clim14%>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=value))+
  geom_point()+
  geom_smooth(method="lm")

#PC2
mod_totht_PC2 <- lmer(value ~ PC2 + (1|Provenance), data=ht_data_clim14)
par(mfrow=c(1,1))
plot(mod_totht_PC2)
qqmath(mod_totht_PC2)
summary(mod_totht_PC2) 
summary(lmer(value ~ PC2 + (1|Provenance), data=ht_data_clim14 %>% filter(!Provenance=="Gila NF")))
##neither is significant

#both PC1 and PC2
summary(lmer(value ~ PC1*PC2 + (1|Provenance), data=ht_data_clim14 %>% filter(!Provenance=="Gila NF")))

#Latitude
mod_totht_lat <- lmer(value ~ y+ I(y^2) + (1|Provenance), data=ht_data_clim14)
plot(mod_totht_lat)
qqmath(mod_totht_lat)
summary(mod_totht_lat) ##quadratic effect not significant
mod_totht_lat_simple <- lmer(value ~ y+ (1|Provenance), data=ht_data_clim14)
plot(mod_totht_lat_simple)
qqmath(mod_totht_lat_simple)
summary(mod_totht_lat_simple)

#take out Gila
ht_data_clim14_nogila <- ht_data_clim14 %>% filter(!Provenance=="Gila NF")
summary(lmer(value ~ y+ (1|Provenance), data=ht_data_clim14_nogila)) #latitude only signficant with Gila included

summary(lmer(value ~ y+ I(y^2)+ (1|Provenance), data=ht_data_clim14_nogila)) #BUT latitude quadratic effect is significant when Gila is excluded. Height lowest in middle latitudes. 

mod_totht_lat_noG <- lmer(value ~ y+ I(y^2)+ (1|Provenance), data=ht_data_clim14_nogila)
plot(mod_totht_lat_noG)
qqmath(mod_totht_lat_noG)
summary(mod_totht_lat_noG)

newdata_lat_totht <- data.frame(
    y = seq(min(ht_data_clim14_nogila$y), 
                      max(ht_data_clim14_nogila$y), 
                      length.out = 100
                      )
    )

##take random effect out to make predictions
mod_totht_lat_noG_lm <- lm(value ~ y+ I(y^2), data=ht_data_clim14_nogila)

predicted_scores_totht <- predict(
  mod_totht_lat_noG_lm, 
  newdata = newdata_lat_totht, interval='confidence') %>% as.data.frame()

newdata_lat_totht_pred <- bind_cols(newdata_lat_totht, predicted_scores_totht)

ggplot()+
  geom_point(data=ht_data_clim14_nogila, aes(x=y, y=value))+
  geom_ribbon(data=newdata_lat_totht_pred, aes(x=y,ymin=lwr,ymax=upr), alpha=0.4, fill="red")+
  geom_line(data=newdata_lat_totht_pred, aes(x=y, y=fit), col="red")+
  geom_vline(xintercept = prov_clim_adjusted_bi %>% filter(Provenance=="Plantation") %>% pull(y))+
  xlab("Latitude")+
  ylab("2014 Height (m)")


ggplot(data=ht_data_clim14, aes(x=y, y=value, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

#longitude
mod_totht_lon <- lmer(value ~ x + (1|Provenance), data=ht_data_clim14)
plot(mod_totht_lon)
qqmath(mod_totht_lon)
summary(mod_totht_lon) ##longitude is marginally significant
summary(lmer(value ~ x + (1|Provenance), data=ht_data_clim14_nogila)) 

ggplot(data=ht_data_clim14, aes(x=x, y=value, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

#TD
mod_totht_TD <- lmer(value ~ TD*map + (1|Provenance), data=ht_data_clim14)
plot(mod_totht_TD)
qqmath(mod_totht_TD)
summary(mod_totht_TD) 
summary(lmer(value ~ TD + (1|Provenance), data=ht_data_clim14_nogila)) 

summary(lmer(value ~ TD*map + (1|Provenance), data=ht_data_clim14_nogila)) 

ggplot(data=ht_data_clim14_nogila, aes(x=TD, y=value, col=map>700))+
  geom_point()+
  geom_smooth(method="lm") ##seems like there could be an interaction going on here. 

#nffd
mod_totht_nffd <- lmer(value ~ nffd + (1|Provenance), data=ht_data_clim14)
plot(mod_totht_nffd)
qqmath(mod_totht_nffd)
summary(mod_totht_nffd) 
summary(lmer(value ~ nffd*SHM + (1|Provenance), data=ht_data_clim14_nogila)) 


ht_data_clim14_noXT <- ht_data_clim14 %>% 
  filter(TD > 20 & TD < 23)

mod_totht_TD_noXT <- lmer(value ~ TD + I(TD^2) + (1|Provenance), data=ht_data_clim14_noXT)
plot(mod_totht_TD_noXT)
qqmath(mod_totht_TD_noXT)
summary(mod_totht_TD_noXT) 

ggplot(data=ht_data_clim14_noXT, aes(x=TD, y=value, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")


##Look at just southern Rockies, excluding Gila
ht_SR <- ht_data_clim14_nogila %>% filter(y < 44)
  
htmod_SR <- lmer(value ~ y + (1|Provenance), data=ht_SR)
plot(htmod_SR)
qqmath(htmod_SR)
summary(htmod_SR)

ggplot(data=ht_SR, aes(x=y, y=value, col=Provenance))+
  geom_point()+
  geom_smooth(method="lm")

colnames(ht_SR)

cor(ht_SR %>% dplyr::select(c(MAT:PPT_sm,elev,x,y,smrpb,monsoonality)))

#TD
TD_htmod_SR <- lmer(value ~ TD + (1|Provenance), data=ht_SR)
plot(TD_htmod_SR)
qqmath(TD_htmod_SR)
summary(TD_htmod_SR) ##Temperature differential is the main differntiating feature between latitude in the southern Rockies (excluding Gila)

#nursery height
totht_mod_nursery <- lmer(value ~ Seedling.Ht..from.Nursery + (1|Provenance), data=ht_data_clim14_nogila)
plot(totht_mod_nursery)
qqmath(totht_mod_nursery)
summary(totht_mod_nursery) ##significant effect of nursery height on total height in 2014 when Gila is removed

ggplot(data= ht_data_clim14, aes(x=Seedling.Ht..from.Nursery, y=value, col=Provenance))+
  geom_point()

###big model
totht_mod_allvars <- lmer(value ~  MAT + I(MAT^2) + map + I(map^2) + TD + I(TD^2) + SHM + I(SHM^2) + nffd  + I(nffd^2) + smrpb + I(smrpb^2) + Seedling.Ht..from.Nursery + (1|Provenance), data=ht_data_clim14)
plot(totht_mod_allvars)
qqmath(totht_mod_allvars)
summary(totht_mod_allvars)



```


##Survival

```{r}
##survival
tree.num <- ht_data %>% 
  filter(!is.na(rel.growth)) %>% 
  group_by(name, Provenance) %>% 
  summarise(n=n()) %>% 
  mutate(year = case_when(
    name=="HT74" ~ 1974,
    name=="HT79" ~ 1979,
    name=="HT85" ~ 1985,
    name=="HT91" ~ 1991,
    name=="HT96" ~ 1996,
    name=="HT06" ~ 2006,
    name=="HT14" ~ 2014))

trees.died<- tree.num %>% 
  left_join(tree.num %>% filter(year==1974) %>% ungroup() %>% dplyr::select(Provenance, n) %>% rename(n_74=n)) %>% 
  mutate(prop = n/n_74)

ggplot(tree.num, aes(x=year, y=n, col=Provenance))+
  geom_point()+
  geom_line()

ggplot(trees.died %>% filter(name=="HT14"), aes(x=factor(Provenance, levels=prov_clim_adjusted_bi %>% arrange(y) %>% pull(Provenance)), y=prop))+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

###models

```{r}
#provenance climate affect on survival linear models

survival_clim_data<- trees.died %>% 
  filter(name=="HT14") %>% 
  left_join(prov_pcapts, by="Provenance")

survmod_pc<- lm(prop ~ PC1*PC2, data=survival_clim_data %>% filter(!Provenance=="Gila NF"))
par(mfrow=c(2,2))
plot(survmod_pc)
summary(survmod_pc)

##just pc1
survmod_pc1<- lm(prop ~ PC1+ I(PC1^2), data=survival_clim_data %>% filter(!Provenance=="Gila NF"))
par(mfrow=c(2,2))
plot(survmod_pc1)
summary(survmod_pc1)

survival_clim_data_noG <- survival_clim_data %>% filter(!Provenance=="Gila NF")
survmod_pc_all <- lm(prop ~ PC1*PC2 + I(PC1^2) + I(PC2^2), data=survival_clim_data_noG)
dredge_survmod<- dredge(survmod_pc_all)
dredge_survmod #best model is quadratic effect of PC1


ggplot(data=survival_clim_data, aes(x=PC1, y=prop))+
  geom_point()+
  geom_smooth(method="lm")

#pca distance
surv_pcadist_data <- trees.died %>% 
  filter(name=="HT14") %>% 
  left_join(pca_dist_df, by="Provenance") %>% 
  left_join(geo.dist.df)

survmod_pcdist<- lm(prop ~ dist.to.plant, data=surv_pcadist_data)
par(mfrow=c(2,2))
plot(survmod_pcdist)
summary(survmod_pcdist) #significant

survmod_pc1dist<- lm(prop ~ PC1diff, data=surv_pcadist_data)
par(mfrow=c(2,2))
plot(survmod_pc1dist)
summary(survmod_pc1dist)

survmod_pc2dist<- lm(prop ~ PC2diff, data=surv_pcadist_data)
par(mfrow=c(2,2))
plot(survmod_pc2dist)
summary(survmod_pc2dist)

###make plot for pca distance model
newdata_pcdist_surv <- data.frame(
    dist.to.plant = seq(min(surv_pcadist_data$dist.to.plant), 
                      max(surv_pcadist_data$dist.to.plant), 
                      length.out = 100
                      )
    )

predicted_scores_surv <- predict(
  survmod_pcdist, 
  newdata = newdata_pcdist_surv, interval='confidence') %>% as.data.frame()

newdata_pcdist_surv_pred <- bind_cols(newdata_pcdist_surv, predicted_scores_surv)

ggplot()+
  geom_point(data=surv_pcadist_data, aes(x=dist.to.plant, y=prop))+
  geom_ribbon(data=newdata_pcdist_surv_pred, aes(x=dist.to.plant,ymin=lwr,ymax=upr), alpha=0.4, fill="red")+
  geom_line(data=newdata_pcdist_surv_pred, aes(x=dist.to.plant, y=fit), col="red")+
  xlab("PCA distance")+
  ylab("Proportion survival")

###I should look at geographic distance also just as a point of discussion
survmod_geodist<- lm(prop ~ geo.dist.to.plant.km, data=surv_pcadist_data)
par(mfrow=c(2,2))
plot(survmod_geodist)
summary(survmod_geodist) #significant

```

##Cones

```{r}
cone_data <- moniger_data_comb %>% 
  dplyr::select(c(SORT,Provenance,Cones85:Cones06)) %>% 
  pivot_longer(Cones85:Cones06) %>% 
  mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006))

cone_sum <- cone_data %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance,year) %>% 
  summarise(value=sum(value), n=n()) %>% 
  mutate(prop.w.cones = value/n)

ave_hts <- moniger_data_comb %>% 
  dplyr::select(c(SORT,Provenance,HT85:HT06)) %>% 
  pivot_longer(HT85:HT06) %>% 
  mutate(year=case_when(name == "HT85" ~ 1985,
                        name == "HT91" ~ 1991,
                        name == "HT96" ~ 1996,
                        name == "HT06" ~ 2006)) %>% 
  filter(!is.na(value)) %>% 
  group_by(Provenance, year) %>% 
  summarise(ave.ht = mean(value), se.ht = sd(value)/sqrt(n())) %>% 
  left_join(cone_sum)

ave_dbh <- moniger_data_comb %>% 
  dplyr::select(c(SORT,Provenance,DBH91:DBH06)) %>% 
  pivot_longer(DBH91:DBH06) %>% 
  mutate(year=case_when(name == "DBH91" ~ 1991,
                        name == "DBH96" ~ 1996,
                        name == "DBH06" ~ 2006)) %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance, year) %>% 
  summarise(ave.dbh = mean(value), se.dbh = sd(value)/sqrt(n())) %>% 
  left_join(cone_sum)

ggplot(ave_hts, aes(x=ave.ht, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_errorbar(aes(xmin=ave.ht - se.ht, xmax=ave.ht+se.ht))

ggplot(ave_dbh, aes(x=ave.dbh, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_errorbar(aes(xmin=ave.dbh-se.dbh, xmax=ave.dbh+se.dbh))

ggplot(moniger_data_comb, aes(x=HT85, y=Cones85))+
  geom_jitter(height=0.1)
ggplot(moniger_data_comb, aes(x=HT91, y=Cones91))+
  geom_jitter(height=0.1)
ggplot(moniger_data_comb, aes(x=HT96, y=Cones96))+
  geom_jitter(height=0.1)
ggplot(moniger_data_comb, aes(x=HT06, y=Cones06))+
  geom_jitter(height=0.1)

ggplot(moniger_data_comb, aes(x=DBH91, y=Cones91))+
  geom_jitter(height=0.1)
ggplot(moniger_data_comb, aes(x=DBH96, y=Cones96))+
  geom_jitter(height=0.1)
ggplot(moniger_data_comb, aes(x=DBH06, y=Cones06))+
  geom_jitter(height=0.1)

ggplot(cone_sum, aes(x=year, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_line()

##ANOVAs

ggplot(data=cone_sum, aes(x=year, y=prop.w.cones, col=Provenance))+
  geom_point()+
  geom_line()

cone_mod <- lm(prop.w.cones ~ year*Provenance, data=cone_sum)
plot(cone_mod)
anova(cone_mod)

cone_mod_simple <- aov(prop.w.cones ~ year+Provenance, data=cone_sum)
summary(cone_mod_simple)
TukeyHSD(cone_mod_simple)$Provenance %>% as.data.frame() %>% filter(`p adj` < 0.05)
Anova(cone_mod_simple, type="2")


```

###models

```{r}
#dbh/height affect on cones linear models

growth_cone_data<- left_join(ave_hts, ave_dbh) %>% 
  left_join(cone_sum) %>% 
  filter(!is.na(ave.dbh)) %>% 
  left_join(prov_pcapts)

growth_cone_mod <- lmer(prop.w.cones ~ year*ave.dbh + year*ave.ht + (1|Provenance), data=growth_cone_data %>% filter(!Provenance=="Gila NF"))
plot(growth_cone_mod)
qqmath(growth_cone_mod)
summary(growth_cone_mod)

ggarrange(
ggplot(data=growth_cone_data %>% filter(!Provenance=="Gila NF"), aes(x=ave.ht, y=prop.w.cones, col=factor(year)))+
  geom_point()+
  geom_smooth(method="lm")+
  ggtitle("Height"),
ggplot(data=growth_cone_data %>% filter(!Provenance=="Gila NF"), aes(x=ave.dbh, y=prop.w.cones, col=factor(year)))+
  geom_point()+
  geom_smooth(method="lm")+
  ggtitle("DBH"), common.legend = TRUE, nrow=1)

#climate
clim_cone_mod <- lmer(prop.w.cones ~ year*PC1 + year*PC2 + (1|Provenance), data=growth_cone_data %>% filter(!Provenance=="Gila NF"))
plot(clim_cone_mod)
qqmath(clim_cone_mod)
summary(clim_cone_mod)

#provenance differences - logistic regression

##get individual height, dbh and cone data
cones91<- moniger_data_comb %>%
  filter(!is.na(Cones91)) %>% 
  filter(!is.na(HT91)) %>% 
  filter(!is.na(DBH91))

cones96<- moniger_data_comb %>%
  filter(!is.na(Cones96)) %>% 
  filter(!is.na(HT96)) %>% 
  filter(!is.na(DBH96))

cones06<- moniger_data_comb %>%
  filter(!is.na(Cones06)) %>% 
  filter(!is.na(HT06)) %>% 
  filter(!is.na(DBH06))

library(MASS)
prov_cone_mod91 <- glmer(Cones91 ~ HT91*DBH91 + (1|Provenance), data=cones91, family=binomial(link="logit"))
qqmath(prov_cone_mod91)
summary(prov_cone_mod91)  ##DBH is significant in predicting cone presence in 1991. Provenance has a good amount of variance
dotplot(ranef(prov_cone_mod91, condVar=TRUE))
cor(cones91 %>% dplyr::select(DBH91,HT91)) #height and DBH are super correlated


prov_cone_mod96 <- glmer(Cones96 ~ HT96*DBH96 + (1|Provenance), data=cones96, family=binomial(link="logit"))
qqmath(prov_cone_mod96)
summary(prov_cone_mod96)  ##Height,DBH and interaction are all significant in predicting cone presence in 1996. Provenance has a good amount of variance
dotplot(ranef(prov_cone_mod96, condVar=TRUE))
cor(cones96 %>% dplyr::select(DBH96,HT96))



prov_cone_mod06 <- glmer(Cones06 ~ HT06*DBH06 + (1|Provenance), data=cones06, family=binomial(link="logit"))
qqmath(prov_cone_mod06)
summary(prov_cone_mod06)  ###Height,DBH and interaction are all significant in predicting cone presence in 2006. Provenance has a good amount of variance
dotplot(ranef(prov_cone_mod06, condVar=TRUE))
library(interactions)
interact_plot(prov_cone_mod06, pred=HT06, modx=DBH06)
interact_plot(prov_cone_mod06, pred=DBH06, modx=HT06)
cor(cones06 %>% dplyr::select(DBH06,HT06))

##looking for thresholds
cone_data_comb<- bind_rows(cones91 %>% dplyr::select(HT91,DBH91,Cones91, Provenance) %>% 
  mutate(year=1991) %>% 
  rename(HT=HT91, DBH=DBH91, Cones=Cones91),
  cones96 %>% dplyr::select(HT96,DBH96,Cones96, Provenance) %>% 
  mutate(year=1996) %>% 
  rename(HT=HT96, DBH=DBH96, Cones=Cones96),
  cones06 %>% dplyr::select(HT06,DBH06,Cones06, Provenance) %>% 
  mutate(year=2006) %>% 
  rename(HT=HT06, DBH=DBH06, Cones=Cones06))

ggplot(cone_data_comb, aes(x=HT, y=Cones, col=factor(year)))+
  geom_jitter(height=.1, width=0)+
  geom_smooth(method = "glm", method.args = list(family = "binomial"))+
  facet_wrap(~Provenance)

prov_cone_modall <- glmer(Cones ~ HT*factor(year) + (1|Provenance), data=cone_data_comb %>% filter(!Provenance=="Gila NF"),family=binomial(link="logit"))
summary(prov_cone_modall)

```

##RWI

###Raw

```{r}
prov_all <- read.rwl("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Ring_widths_raw/prov_all.rwl")
```


```{r}
#plot raw data to look at timeseries length
plot.rwl(prov_all)

##compare timing of when trees reached 30cm tall (and thus had a growth ring measured)
dbh_age <- prov_all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(prov_all)) %>% 
  pivot_longer(!year, values_to = "rw", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")) %>% 
              left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
              mutate(Provenance = newname) %>% 
              dplyr::select(-newname), by="tree")
  
dbh_age_summary <- dbh_age %>%
  filter(!is.na(rw)) %>% 
  group_by(Provenance,tree) %>% 
  summarise(minyr = min(year), maxyr=max(year), n=n()) %>% 
  mutate(years.calc = maxyr-minyr+1)

#compare when time series started (min year)
ggplot(dbh_age_summary, aes(x=factor(Provenance, levels=prov_pcapts %>% arrange(y) %>% pull(Provenance)), y=minyr))+
  geom_boxplot()+
  geom_point(color="maroon")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#compare length of timeseries
ggplot(dbh_age_summary, aes(x=Provenance, y=n))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

dbh_age_summary2 <- dbh_age_summary %>% 
  left_join(dbh %>% mutate(Series=paste("X",Series,sep="")), by=c("tree"="Series","Provenance")) 

ggplot(dbh_age_summary2, aes(x=minyr, y=DBH14, col=Provenance))+
  geom_point() #there isn't a strong correlation between dbh and the length of the timeseries which makes me think that rings were just lost (not that the tree didn't reach DBH height until the min year)
###

##remove NAs from ring width series
prov_all_nona<- prov_all %>% na.omit()
colnames(prov_all_nona)

##raw
ggplot(dbh_age, aes(x=year, y=rw, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance)+
  theme(legend.position = "none")

hist(dbh_age$rw)
hist(dbh_age %>% filter(rw<0.5) %>% pull(rw))


###investigating series with really low ring width values
dbh_rwi_comp <- dbh_age %>% 
  filter(!tree=="X32A1") %>% 
  group_by(Provenance, tree) %>% 
  summarise(sum=sum(rw, na.rm = TRUE)) %>% 
  arrange(tree) %>% 
  bind_cols(dbh %>% arrange(Series) %>% 
  filter(!is.na(DBH14))) %>% 
  mutate(lowsum=ifelse(sum<16,"yes","no"))

dbh_rwi_comp %>% 
  filter(lowsum=="yes")

ggplot(dbh_rwi_comp)+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))

ggplot(dbh_rwi_comp %>% mutate(sum=ifelse(sum<15,sum*10,sum)))+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))+
  geom_abline(slope=1/10,intercept = 0)
###########

#find series that are likely off by an order of magnitude
off_provs<- dbh_age %>% 
  filter(Provenance %in% c("Cache NF","Coconino NF", "Cutting Permit 31", "Dixie NF", "Gunnison NF","Larimer 2", "Okanogan NF","Powers Creek","Wallowa-Whitman NF","Wenatchee NF"))

ggplot(off_provs, aes(x=year, y=rw, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance)+
  theme(legend.position = "none")

off_trees<- dbh_rwi_comp %>% 
  filter(lowsum=="yes") %>% pull(tree) %>% c("X58A4") #this is the weird tree that's half and half

prov_good_nona <- prov_all_nona %>%dplyr::select(-all_of(substr(off_trees, 2,nchar(off_trees))))


###this cuts out sketchy trees and year = 2016
prov_good <- prov_all %>% dplyr::select(-all_of(substr(off_trees,2,nchar(off_trees)))) %>% 
  filter(!row.names(prov_all)=="2016")
```

```{r}
##some plots of the raw data averaged
dbh_age_good <- dbh_age %>% 
  filter(!tree %in% off_trees)

ave_rw_prov<- dbh_age_good %>% 
  na.omit() %>% 
  group_by(Provenance, year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n())) 

ggplot(ave_rw_prov, aes(x=year, y=ave_rw, col=Provenance))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se, col=Provenance))+
  geom_vline(xintercept = 1985)+
  facet_wrap(~Provenance)

ggplot(ave_rw_prov, aes(x=year, y=ave_rw, col=Provenance))+
  geom_point()+
  geom_line()+
  #geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se, col=Provenance))+
  geom_vline(xintercept = 1985)

ave_rw_all <- dbh_age_good %>%
  na.omit() %>% 
  group_by(year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n()))

ggplot(ave_rw_all, aes(x=year, y=ave_rw))+
  geom_point()+
  geom_errorbar(aes(x=year, ymin=ave_rw-se, ymax=ave_rw+se), col="red")+
  geom_line()+
  geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")
### it seems like the major deviation in the data is in response to the wet period right before the drought, rather than the 2002 drought. 

```

###Detrending

```{r}
##detrending with Spline method - using stiffness of 35 years
##need to figure out what age to start at based on how long the "young tree growth spurt" usually takes

###plot series to figure out where NAs are
par(mfrow=c(1,1))
plot(prov_good, plot.type="spag")
rwl.report(prov_good)
prov_good_stats<- summary(prov_good)
summary(prov_good_stats$ar1)

growth.detrended.all = matrix(nrow=nrow(prov_good), ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.all[,i]<- obj
}
colnames(growth.detrended.all) = colnames(prov_good)
rownames(growth.detrended.all) = rownames(prov_good)

rwi.stats(growth.detrended.all, period="max")
chron(growth.detrended.all)
plot(chron(growth.detrended.all), add.spline=TRUE, nyrs=35)

growth.detrended.df.all <- growth.detrended.all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.all)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df.all, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

##remove first 15 years of ring widths since they are missing for many trees and likely represent unusual growth patterns. 
growth.detrended.short = matrix(nrow=nrow(prov_good)-15, ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good %>% filter(!(row.names(prov_good) < 1985))  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.short[,i]<- obj
}
colnames(growth.detrended.short) = colnames(prov_good)
rownames(growth.detrended.short) = rownames(prov_good)[16:nrow(prov_good)]

rwi.stats(growth.detrended.short, period="max")
plot(chron(growth.detrended.short), add.spline=TRUE, nyrs=35)
##########

growth.detrended.df <- growth.detrended.short %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.short)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

growth.detrended.sum <- growth.detrended.df %>% 
  group_by(year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.sum, aes(x=year, y=meanrwi))+
  geom_point()+
  geom_errorbar(aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se), col="red")+
  geom_line()+
  geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")+
  geom_hline(yintercept=1, linetype=2)

growth.detrended.byprov <- growth.detrended.df %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi))+
    geom_bar(data=plantation_clim, aes(x=year, y=spei_sum/5), stat="identity")+
  geom_point(aes( col=Provenance))+
  geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se, col=Provenance))+
  geom_line(aes( col=Provenance))+
  geom_hline(yintercept=1, linetype=2)

##look at whole time series
growth.detrended.all.byprov <- growth.detrended.df.all %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

ggplot(growth.detrended.all.byprov, aes(x=year, y=meanrwi))+
    geom_bar(data=plantation_clim, aes(x=year, y=FDSI), stat="identity")+
  geom_point(aes( col=Provenance))+
  geom_errorbar(width=0.2,aes(x=year, ymin=meanrwi-se, ymax=meanrwi+se, col=Provenance))+
  geom_line(aes( col=Provenance))+
  geom_hline(yintercept=1, linetype=2)

```

###Resistance vs. Resilience

####Odd time periods

#####Raw ring widths

```{r}
#######
# calculate different time periods
#######
droughtyear = 2002
buffertime = seq(0,3,1)
raw_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))
}

rawmodlist_resistance<- list()
for(i in 1:length(raw_calcs_list)){
rawmodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=raw_calcs_list[[i]])
}
summary(rawmodlist_resistance[[1]])
summary(rawmodlist_resistance[[2]]) #3yr periods significant for resistance
TukeyHSD(rawmodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
ggplot(data=as.data.frame(raw_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(rawmodlist_resistance[[3]])
summary(rawmodlist_resistance[[4]]) 

rawmodlist_resilience<- list()
for(i in 1:length(raw_calcs_list)){
rawmodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=raw_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(rawmodlist_resilience[[1]])
summary(rawmodlist_resilience[[2]]) ##3 year periods marginally significant
TukeyHSD(rawmodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
summary(rawmodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05). Inlet creek is lower than Gila for resilience
TukeyHSD(rawmodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
RR_5yrs_0004 <- raw_calcs_list[[3]] %>% as.data.frame()
ggplot(RR_5yrs_0004, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(rawmodlist_resilience[[4]]) 

####
```

#####Detrended with spline

```{r}
###DETRENDED DATA
droughtyear = 2002
buffertime = seq(0,3,1)
spline_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rw = mean(rw_spline))

predrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rw = mean(rw_spline))

postdrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rw = mean(rw_spline))

spline_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")
}

splinemodlist_resistance<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=spline_calcs_list[[i]])
}
summary(splinemodlist_resistance[[1]])
summary(splinemodlist_resistance[[2]]) #3yr still significant but diff provs
TukeyHSD(splinemodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
ggplot(as.data.frame(spline_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resistance[[3]])
summary(splinemodlist_resistance[[4]]) 

splinemodlist_resilience<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=spline_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(splinemodlist_resilience[[1]])
summary(splinemodlist_resilience[[2]]) ##3 year periods is significant
TukeyHSD(splinemodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #all Gila
summary(splinemodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05)
TukeyHSD(splinemodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #Gila, in addition to Inlet Creek being lower than Larimer 2 and Pike
ggplot(as.data.frame(spline_calcs_list[[3]]), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resilience[[4]]) 

####
```

####Even time periods

#####Raw ring widths

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0102<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0102 <- left_join(drought_rw_0102,predrought_rw_0102) %>% left_join(postdrought_rw_0102) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0102 <- aov(resistance ~ Provenance, data=raw_calcs_0102)

summary(rawmodlist_resistance_0102)
TukeyHSD(rawmodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwise differences

rawmodlist_resilience_0102 <- aov(resilience ~ Provenance, data=raw_calcs_0102)

summary(rawmodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0203<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0203 <- left_join(drought_rw_0203,predrought_rw_0203) %>% left_join(postdrought_rw_0203) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))

rawmodlist_resistance_0203 <- aov(resistance ~ Provenance, data=raw_calcs_0203)

summary(rawmodlist_resistance_0203)

rawmodlist_resilience_0203 <- aov(resilience ~ Provenance, data=raw_calcs_0203)

summary(rawmodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0104<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0104 <- left_join(drought_rw_0104,predrought_rw_0104) %>% left_join(postdrought_rw_0104) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0104 <- aov(resistance ~ Provenance, data=raw_calcs_0104)

summary(rawmodlist_resistance_0104)

rawmodlist_resilience_0104 <- aov(resilience ~ Provenance, data=raw_calcs_0104)

summary(rawmodlist_resilience_0104)
TukeyHSD(rawmodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0104 <- raw_calcs_0104 %>% as.data.frame()
ggplot(RR_4yrs_0104, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0003<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0003 <- left_join(drought_rw_0003,predrought_rw_0003) %>% left_join(postdrought_rw_0003) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))

rawmodlist_resistance_0003 <- aov(resistance ~ Provenance, data=raw_calcs_0003)

summary(rawmodlist_resistance_0003)

rawmodlist_resilience_0003 <- aov(resilience ~ Provenance, data=raw_calcs_0003)

summary(rawmodlist_resilience_0003)
TukeyHSD(rawmodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0003 <- raw_calcs_0003 %>% as.data.frame()
ggplot(RR_4yrs_0003, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years not significant for either resistance or resilience

drought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_0005<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_0005 <- left_join(drought_rw_0005,predrought_rw_0005) %>% left_join(postdrought_rw_0005) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_0005 <- aov(resistance ~ Provenance, data=raw_calcs_0005)

summary(rawmodlist_resistance_0005)

rawmodlist_resilience_0005 <- aov(resilience ~ Provenance, data=raw_calcs_0005 %>% filter(!is.na(resilience)))

summary(rawmodlist_resilience_0005)

#99-04 - 6 years not significant for either resistance or resilience

drought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(name) %>% 
  summarise(drought_ave_rw = mean(value))

predrought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(name) %>% 
  summarise(predrought_ave_rw = mean(value))

postdrought_rw_9904<- prov_good %>% 
  mutate(year = rownames(prov_good)) %>% 
  pivot_longer(-year) %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(name) %>% 
  summarise(postdrought_ave_rw = mean(value))

raw_calcs_9904 <- left_join(drought_rw_9904,predrought_rw_9904) %>% left_join(postdrought_rw_9904) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  mutate(name=paste("X",name,sep="")) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by=c("name" = "tree"))


rawmodlist_resistance_9904 <- aov(resistance ~ Provenance, data=raw_calcs_9904)

summary(rawmodlist_resistance_9904)

rawmodlist_resilience_9904 <- aov(resilience ~ Provenance, data=raw_calcs_9904)

summary(rawmodlist_resilience_9904)
TukeyHSD(rawmodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
RR_4yrs_0003 <- raw_calcs_0003 %>% as.data.frame()
ggplot(RR_4yrs_0003, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

#####Detrended ring with spline

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0102 <- left_join(drought_rwi_0102,predrought_rwi_0102) %>% left_join(postdrought_rwi_0102) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0102 <- aov(resistance ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resistance_0102)
TukeyHSD(splinemodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwiise differences

splinemodlist_resilience_0102 <- aov(resilience ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rwi_0203<- growth.detrended.df %>%
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0203 <- left_join(drought_rwi_0203,predrought_rwi_0203) %>% left_join(postdrought_rwi_0203) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0203 <- aov(resistance ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resistance_0203)

splinemodlist_resilience_0203 <- aov(resilience ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0104 <- left_join(drought_rwi_0104,predrought_rwi_0104) %>% left_join(postdrought_rwi_0104) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0104 <- aov(resistance ~ Provenance, data=spline_calcs_0104)
TukeyHSD(splinemodlist_resistance_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


summary(splinemodlist_resistance_0104)

splinemodlist_resilience_0104 <- aov(resilience ~ Provenance, data=spline_calcs_0104)

summary(splinemodlist_resilience_0104)
TukeyHSD(splinemodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0003 <- left_join(drought_rwi_0003,predrought_rwi_0003) %>% left_join(postdrought_rwi_0003) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0003 <- aov(resistance ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resistance_0003)

splinemodlist_resilience_0003 <- aov(resilience ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resilience_0003)
TukeyHSD(splinemodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0003), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years 

drought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0005 <- left_join(drought_rwi_0005,predrought_rwi_0005) %>% left_join(postdrought_rwi_0005) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")


splinemodlist_resistance_0005 <- aov(resistance ~ Provenance, data=spline_calcs_0005)

summary(splinemodlist_resistance_0005)

splinemodlist_resilience_0005 <- aov(resilience ~ Provenance, data=spline_calcs_0005 %>% filter(!is.na(resilience)))

summary(splinemodlist_resilience_0005)
TukeyHSD(splinemodlist_resilience_0005)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0005), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#99-04 - 6 years not significant for either resistance or resilience

drought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_9904 <- left_join(drought_rwi_9904,predrought_rwi_9904) %>% left_join(postdrought_rwi_9904) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")


splinemodlist_resistance_9904 <- aov(resistance ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resistance_9904)

splinemodlist_resilience_9904 <- aov(resilience ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resilience_9904)
TukeyHSD(splinemodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_9904), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

####Climate Trends in RR

```{r}
##I'm going to look at trends in resistance and resilience (spline detrended) due to provenance climate using the 4 year periods, where the drought period = 2001-2004 as this seems to be the period where there are the most differences between provenances in resistance and resilience.

RR4_clim<- spline_calcs_0104 %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

RR4_clim_nogila <- RR4_clim %>% 
  filter(!Provenance=="Gila NF")


ggplot(RR4_clim, aes(x=PC2, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

##PCA models
resis_mod_pc <- lmer(log(resistance) ~ PC1*PC2 + (1|Provenance), data=RR4_clim %>% filter(!Provenance == "Gila NF"))
plot(resis_mod_pc)
qqmath(resis_mod_pc)
summary(resis_mod_pc) #when Gila is removed, PC1 is significantly negatively predictive of resistance 
ggplot(RR4_clim %>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=resistance))+
  geom_point()+
  geom_smooth(method="lm")

resis_mod_pc1 <- lmer(log(resistance) ~ PC1 + I(PC1^2) + (1|Provenance), data=RR4_clim %>% filter(!Provenance == "Gila NF"))
plot(resis_mod_pc1)
qqmath(resis_mod_pc1)
summary(resis_mod_pc1) #quadratic effect is not significant. 

##figure for effect of PC1 on resistance
newdata_pc1 <- data.frame(
    PC1 = seq(min(RR4_clim_nogila$PC1), 
                      max(RR4_clim_nogila$PC1), length.out = 100), 
    PC2 = mean(RR4_clim_nogila$PC2))

##take random effect out to make predictions
resis_mod_pc_lm <- lm(resistance ~ PC1*PC2, data=RR4_clim_nogila)

predicted_scores <- predict(
  resis_mod_pc_lm, 
  newdata = newdata_pc1, interval='confidence') %>% as.data.frame()

newdata_pc1_pred <- bind_cols(newdata_pc1, predicted_scores)

ggplot()+
  geom_point(data=RR4_clim_nogila, aes(x=PC1, y=resistance))+
  geom_ribbon(data=newdata_pc1_pred, aes(x=PC1,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_pc1_pred, aes(x=PC1, y=fit), col="turquoise")

#distance model
resis_mod_dist <- lmer(log(resistance) ~ dist.to.plant+geo.dist.to.plant.km + (1|Provenance), data=RR4_clim %>% filter(!Provenance == "Gila NF"))
plot(resis_mod_dist)
qqmath(resis_mod_dist)
summary(resis_mod_dist) #geographic distance to the plantation is significant

##figure for effect of geo dist on resistance
newdata_geodist <- data.frame(
    geo.dist.to.plant.km = seq(min(RR4_clim_nogila$geo.dist.to.plant.km), 
                      max(RR4_clim_nogila$geo.dist.to.plant.km), length.out = 100), 
    dist.to.plant = mean(RR4_clim_nogila$dist.to.plant))

##take random effect out to make predictions
resis_mod_dist_lm <- lm(resistance ~  dist.to.plant+geo.dist.to.plant.km, data=RR4_clim_nogila)

predicted_scores <- predict(
  resis_mod_dist_lm, 
  newdata = newdata_geodist, interval='confidence') %>% as.data.frame()

newdata_geodist_pred <- bind_cols(newdata_geodist, predicted_scores)

ggplot()+
  geom_point(data=RR4_clim_nogila, aes(x=geo.dist.to.plant.km, y=resistance))+
  geom_ribbon(data=newdata_geodist_pred, aes(x=geo.dist.to.plant.km,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_geodist_pred, aes(x=geo.dist.to.plant.km, y=fit), col="turquoise")

cor(RR4_clim_nogila %>% dplyr::select(geo.dist.to.plant.km, PC1)) ##PC1 and geo dist to plant are not correlated

###resilience
resil_mod_pc <- lmer(resilience ~ PC1*PC2 + (1|Provenance), data=RR4_clim %>% filter(!Provenance == "Gila NF"))
plot(resil_mod_pc)
qqmath(resil_mod_pc)
summary(resil_mod_pc) #when Gila is removed, PC1 is marginally significant
ggplot(RR4_clim %>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

resil_mod_pc1 <- lmer(resilience ~ PC1 + I(PC1^2) + (1|Provenance), data=RR4_clim %>% filter(!Provenance == "Gila NF"))
plot(resil_mod_pc1)
qqmath(resil_mod_pc1)
summary(resil_mod_pc1) #quadratic effect is not significant. 

resil_mod_dist <- lmer(resilience ~ dist.to.plant + geo.dist.to.plant.km + (1|Provenance), data=RR4_clim %>% filter(!Provenance == "Gila NF"))
plot(resil_mod_dist)
qqmath(resil_mod_dist)
summary(resil_mod_dist) #geographic distance to the plantation is significant again

##figure for effect of geo dist on resilience
##take random effect out to make predictions
resil_mod_dist_lm <- lm(resilience ~  dist.to.plant+geo.dist.to.plant.km, data=RR4_clim_nogila)

predicted_scores_resil <- predict(
  resil_mod_dist_lm, 
  newdata = newdata_geodist, interval='confidence') %>% as.data.frame()

newdata_geodist_pred_resil <- bind_cols(newdata_geodist, predicted_scores_resil)

ggplot()+
  geom_point(data=RR4_clim_nogila, aes(x=geo.dist.to.plant.km, y=resilience))+
  geom_ribbon(data=newdata_geodist_pred_resil, aes(x=geo.dist.to.plant.km,ymin=lwr,ymax=upr), alpha=0.4, fill="turquoise")+
  geom_line(data=newdata_geodist_pred_resil, aes(x=geo.dist.to.plant.km, y=fit), col="turquoise")

summary(lmer(resistance ~ PC1*geo.dist.to.plant.km + (1|Provenance), data=RR4_clim_nogila))

ggplot(RR4_clim_nogila, aes(x=PC1, y=resistance, col=geo.dist.to.plant.km>800))+
  geom_point()+
  geom_smooth(method="lm")

```

###Other Metrics

####detrended

```{r}
drought_new<- growth.detrended.df %>% 
  filter(year == 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2002) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs <- left_join(drought_new,predrought_new) %>% 
  mutate(resistance = drought_ave/predrought_ave) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

new_aov_resist <- aov(resistance ~ Provenance, data=new_calcs)
par(mfrow=c(2,2))
plot(new_aov_resist)
summary(new_aov_resist) #no difference in resistance when compared to average growth 1985-2002

ggplot(new_calcs, aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#####recovery time 

no_reduction<- growth.detrended.df %>% 
  filter(year == 2002) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff<0) ##50 trees didn't reduce growth in 2002

count_no_red<- growth.detrended.df %>%
  filter(year==2002) %>% 
  group_by(Provenance) %>% 
  summarise(ntrees=n()) %>% 
  left_join(no_reduction %>% group_by(Provenance) %>% summarise(nNR=n()))

ggplot(count_no_red, aes(x=Provenance, y=(nNR/ntrees)*100))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
  

recover_time<- growth.detrended.df %>%
  filter(!tree %in% no_reduction$tree) %>% 
  filter(year > 2001) %>%
  left_join(predrought_new) %>% 
  mutate(diff = rw_spline - predrought_ave) %>% 
  filter(diff>0) %>% 
  group_by(tree) %>% 
  summarise(minyr = min(year)) %>% 
  mutate(recoverytime = as.numeric(minyr) - 2002) %>% 
  left_join(dbh_age %>%dplyr::select(tree,Provenance) %>% unique(), by="tree")

aov.recover <- aov(recoverytime ~ Provenance, data=recover_time)
summary(aov.recover)  #no difference in recovery time

ggplot(recover_time, aes(x=Provenance, y=recoverytime))+
  geom_boxplot()+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##climate model for recovery time
recover_time_clim <- recover_time %>% 
  left_join(prov_pcapts) %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

recov_mod_pca <- lmer(log(recoverytime) ~ PC1*PC2 + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pca)
qqmath(recov_mod_pca)
summary(recov_mod_pca)

recov_mod_dist <- lmer(log(recoverytime) ~ dist.to.plant + geo.dist.to.plant.km + (1|Provenance), data=recover_time_clim)
plot(recov_mod_dist)
qqmath(recov_mod_dist)
summary(recov_mod_dist)

###
not_recovered<- dbh_age_good %>% 
  filter(! tree %in% no_reduction$tree) %>% 
  filter(! tree %in% recover_time$tree) ##all of the trees recovered

#total growth reduction
growth_red<- growth.detrended.df %>% 
  filter(!tree %in% no_reduction$tree) %>% 
  filter(!tree %in% unique(not_recovered$tree)) %>% 
  filter(year>2001) %>% 
  left_join(predrought_new) %>% 
  mutate(growth_red = predrought_ave-rw_spline) %>% 
  filter(growth_red>0)

growth_red_sum <- growth_red %>% 
  left_join(recover_time, by="tree") %>% 
  mutate(year_diff = minyr-year) %>% 
  filter(year_diff > 0) %>% 
  group_by(tree) %>% 
  summarise(max.growth.red = max(growth_red), sum.growth.red=sum(growth_red)) %>% 
  left_join(growth_red, by=c("max.growth.red" = "growth_red", "tree")) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  left_join(recover_time, by=c("newname"="Provenance", "tree")) %>% 
  left_join(left_join(prov_pcapts,pca_dist_df), by=c("newname"="Provenance")) %>% 
  left_join(geo.dist.df, by=c("newname"="Provenance"))

##max growth reduction models
#anova
aov.mgr <- aov(max.growth.red ~ Provenance, data=growth_red_sum)
par(mfrow=c(2,2))
plot(aov.mgr)
summary(aov.mgr)  #no significant difference in max growth reduction between provenances

#linear models
mgr.pcmod <- lmer(max.growth.red ~ PC1*PC2 + (1|Provenance), data=growth_red_sum)
plot(mgr.pcmod)
qqmath(mgr.pcmod)
summary(mgr.pcmod)

mgr.distmod <- lmer(max.growth.red ~ dist.to.plant + geo.dist.to.plant.km + (1|Provenance), data=growth_red_sum)
plot(mgr.distmod)
qqmath(mgr.distmod)
summary(mgr.distmod) #nothing significant


ggplot(growth_red_sum, aes(x=Provenance, y=max.growth.red))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

```


##Correlations

```{r}
##look at correlation between current year and previous year climate variables at plantation

plantation_clim_minus1<- plantation_clim %>% mutate(year = year+1) %>% 
 dplyr::select(c(CN:year,ppt_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum))

colnames(plantation_clim_minus1)<- paste("prior_",colnames(plantation_clim_minus1),sep="")

plantation_clim_cor<- plantation_clim %>% 
 dplyr::select(c(CN:year,ppt_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
 dplyr::select(-c(CN,year)) %>% 
  cor()

plantation_clim_cor>0.7

ggcorrplot(plantation_clim_cor, type="lower", insig = "blank", lab=FALSE)

plantation_clim_cor_yrof<- plantation_clim %>% 
 dplyr::select(c(CN:year,ppt_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  filter(! year %in% c(1970)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
 dplyr::select(-c(CN,year)) %>% 
  cor()

ggcorrplot(plantation_clim_cor_yrof, type="lower", insig = "blank", lab=TRUE)


##calculate correlations between detrended growth and climate at plantation
growth_climate_df <- growth.detrended.df %>% 
  left_join(plantation_clim) %>% 
 dplyr::select(c(CN:year,ppt_sm:ppt_sp, vpdmax_sm:vpdmax_sp, FDSI, aet_sum, cwd_wy, spei_sum)) %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  filter(!is.na(rw_spline))

climvars <- colnames(growth_climate_df %>% dplyr::select(-c(CN:year)))
tree_ids <- unique(growth_climate_df$tree)

gc_cor_df<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i])
  tree <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline)
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df <- bind_rows(gc_cor_df, row)
  }}
gc_cor_df %>% dplyr::pull(V2) %>% unique() %>% length()

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  arrange(n) %>% 
  print(n=40)

gc_cor_df %>% 
  group_by(V2) %>% 
  summarise(maxcor = max(rw_spline, na.rm=T)) %>% 
  left_join(gc_cor_df, by=c("maxcor"="rw_spline", "V2")) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% print(n=50)

cor_clean <- gc_cor_df %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>% 
  filter(!is.na(cor))

ggplot(cor_clean %>% filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")), aes(x=Provenance, y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_wrap(~factor(climvar, levels=c("aet_sum","cwd_wy","FDSI","spei_sum", "prior_aet_sum","prior_cwd_wy","prior_FDSI","prior_spei_sum")),nrow=2)+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))
  
##all the rest of the climate variables
ggplot(cor_clean %>% filter(!climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")), aes(x=Provenance, y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_wrap(~climvar)+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))
###

cor_summary<- gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>% 
  filter(!is.na(cor)) %>% 
  group_by(Provenance, climvar) %>% 
  summarise(n=n(), meancor = mean(cor), se=sd(cor)/sqrt(n())) %>% 
  ungroup() %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  rename(Provenance = newname) %>% 
  left_join(prov_names)

ggplot(cor_summary %>% filter(n > 1), aes(x=climvar, y=meancor, fill=meancor>0))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymax = meancor+se, ymin=meancor-se), width=0.2)+
  scale_fill_viridis(discrete=TRUE, direction=-1)+
  facet_grid(~code)+
  coord_flip()+
  geom_hline(yintercept=0)

cor_summary2<- gc_cor_df %>% 
   rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance) %>% unique(), by="tree") %>% 
  filter(!is.na(cor)) %>% 
  group_by(Provenance, climvar) %>% 
  summarise(n=n(), meancor = mean(cor), se=sd(cor)/sqrt(n())) %>% 
  ungroup() %>% 
  left_join(name_conversion, by=c("Provenance"="oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  rename(Provenance = newname) %>% 
  left_join(prov_names)

ggplot(data= cor_summary2 %>% 
  group_by(Provenance, climvar) %>% 
  summarise(n=n()), aes(x=Provenance, fill=climvar, y=n)) +
    geom_bar(stat="identity")+
  facet_wrap(~climvar)

ggplot(cor_clean %>% inner_join(cor_summary2 %>% dplyr::select(climvar, Provenance) %>% unique()), aes(x=climvar, y=cor, fill=climvar))+
  geom_boxplot()+
  geom_point()+
  scale_fill_viridis(discrete=TRUE)+
  facet_grid(~Provenance)+
  coord_flip()+
  geom_hline(yintercept=0)


allanovas<- data.frame()
for(i in 1:length(climvars)){
mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == climvars[i]))
modanova <- as.data.frame(Anova(mod, type="2"))
pvalue<- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Pr(>F)`)
provSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Sum Sq`)
provdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Df`)
residSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Sum Sq`)
residdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Df`)
allanovas <- bind_rows(allanovas, data.frame(climvar=climvars[i],pvalue=pvalue, provMS = provSS/provdf, residMS = residSS/residdf))
}

allanovas %>% mutate(diff = residMS - provMS) %>% arrange(diff) ##when residMS is greater than provMS (diff > 0)--> variation within provenances is greater than variation between them 
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff>0) %>% nrow()
allanovas %>% mutate(diff = residMS - provMS) %>% filter(diff<0) %>% nrow()


allanovas %>% filter(pvalue<0.05) #no significant differences between provenances in how correlated RWI is to climate vars

ggplot(data=cor_clean, aes(x=Provenance, y=cor))+
  geom_boxplot()+
  facet_wrap(~climvar)

##T-TESTS
provs <- unique(cor_clean$Provenance)
ttestdata<- data.frame()

for(i in 1:length(climvars)){
  for(j in 1:length(provs)){
data <- cor_clean %>% 
  filter(climvar==climvars[i]) %>% 
  filter(Provenance == provs[j])

test<- t.test(data$cor, y = NULL,
       alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

row <- data.frame(climvar = climvars[i], Provenance = provs[j], lwr = test$conf.int[1], upr = test$conf.int[2], estimate = test$estimate, pvalue = test$p.value)

ttestdata <- bind_rows(ttestdata, row)}}

sig.cors.byprov <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>% 
  filter(!is.na(pvalue)) %>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

nonsig.provs <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>% 
  dplyr::select(climvar, Provenance, pvalue) %>% 
  unique() %>%
  group_by(Provenance) %>% 
  summarise(sum = sum(pvalue, na.rm=T)) %>% 
  filter(sum==0)%>% 
  left_join(name_conversion, by=c("Provenance"="oldname"))

ggplot(data=sig.cors.byprov, aes(x=factor(newname, levels=provs_arranged_lat), y=estimate, col=Provenance))+
  geom_point(size=4, alpha=0.5)+
  geom_errorbar(aes(x=factor(newname, levels=provs_arranged_lat), ymin=lwr, ymax=upr),width=0.5, linewidth=2, alpha=0.5)+
  geom_hline(yintercept=0, col="red")+
  geom_jitter(data= cor_clean %>% filter(climvar %in% c("aet_sum" , "cwd_wy" , "FDSI", "spei_sum", "prior_aet_sum", "prior_cwd_wy", "prior_FDSI" , "prior_spei_sum")) %>%   left_join(name_conversion, by=c("Provenance"="oldname")), aes(x=factor(newname, levels=provs_arranged_lat), y=cor), fill="gray", color="black", size=2, height=0, width=0.1, alpha=0.2)+
  geom_point(data=nonsig.provs, aes(x=factor(newname, levels=provs_arranged_lat), y=sum), shape=4, size=6, color="red")+
  facet_wrap(~factor(climvar, levels=c("aet_sum","prior_aet_sum","cwd_wy","prior_cwd_wy","FDSI","prior_FDSI","spei_sum","prior_spei_sum")),ncol=2)+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=14, color="black"),
        axis.text.y = element_text(size=14, color="black"),
        axis.title = element_text(size=14, color="black"),
        legend.text = element_text(size=12, color="black"),
        legend.title = element_text(size=14, color="black"))

######testing relationships between growth and climate across all trees with provenance as a random effect

all_lms<- data.frame()
for(i in 1:length(climvars)){
mod <- lmer(growth_climate_df %>% pull(rw_spline) ~ growth_climate_df %>% pull(climvars[i]) + (1|Provenance), data=growth_climate_df)
summary<- as.data.frame(summary(mod)$coefficients) 
pvalue <- summary %>% slice(2) %>% pull(`Pr(>|t|)`)
all_lms <- bind_rows(all_lms, data.frame(var=climvars[i], pvalue=pvalue))
}

all_lms %>% 
  filter(pvalue<0.05) %>% 
  pull(var) 

plantation_clim %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  dplyr::select(c(all_lms %>% 
  filter(pvalue<0.05) %>% 
  pull(var) )) %>% 
  dplyr::select(-c("ppt_sm","ppt_sp","ppt_fa","prior_ppt_sm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean")) %>% 
  cor() %>% 
  ggcorrplot()

all_lms %>% 
  filter(pvalue<0.05) %>% 
  filter(! var %in% c("ppt_sm","ppt_sp","ppt_fa","prior_ppt_sm","prior_ppt","prior_value_fa_tmax","prior_value_fa_tmean","prior_value_wt_tmax","prior_value_wt_tmean"))

climmod_cor <- lmer(rw_spline ~ ppt_gs + ppt_wt + vpdmax_sm + vpdmax_fa + vpdmax_wt + vpdmax_sp + prior_ppt_gs + prior_ppt_wt + prior_value_sm_tmin + prior_value_fa_tmin + prior_value_wt_tmin + prior_vpdmax_sm + prior_vpdmax_fa + prior_vpdmax_wt + prior_vpdmax_sp + (1|Provenance), data=growth_climate_df)
plot(climmod_cor)
qqmath(climmod_cor)
summary(climmod_cor)
vif(climmod_cor)

##now model with all composite variables

climmod_cor_composite <- lmer(rw_spline ~ aet_sum + I(aet_sum^2) + cwd_wy + I(cwd_wy^2) + spei_sum + I(spei_sum^2)+ prior_FDSI + I(prior_FDSI^2) + prior_aet_sum + I(prior_aet_sum^2) + prior_cwd_wy + I(prior_cwd_wy^2) + prior_spei_sum + I(prior_spei_sum^2) + (1|Provenance), data=growth_climate_df)
plot(climmod_cor_composite)
qqmath(climmod_cor_composite)
summary(climmod_cor_composite)
vif(climmod_cor_composite)
#dredge.composite <- dredge(climmod_cor_composite) takes a long time ~30 min
#dredge.composite ##best model by far has aet_sum + aet_sum^2 + cwd_wy + cwd_wy^2 + prior_aet_sum + prior_aet_sum^2 + prior_FDSI + prior_spei_sum + prior_spei_sum^2 + spei_sum + spei_sum^2
best.model.comp <- lm(rw_spline ~ aet_sum + I(aet_sum^2) + cwd_wy + I(cwd_wy^2) + prior_aet_sum + I(prior_aet_sum^2) + prior_FDSI + prior_spei_sum + I(prior_spei_sum^2) + spei_sum + I(spei_sum^2), data=growth_climate_df)
par(mfrow=c(2,2))
plot(best.model.comp)
par(mfrow=c(1,1))
summary(best.model.comp)
vif(best.model.comp)

plantation_clim %>% 
  left_join(plantation_clim_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  filter(! year %in% c(1971)) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  dplyr::select(c("aet_sum" , "cwd_wy" , "prior_aet_sum", "prior_FDSI" , "prior_spei_sum", "spei_sum")) %>% 
  cor()


growth_climate_df %>% dplyr::select(aet_sum, prior_aet_sum, prior_FDSI) %>% summary()

growth_climate_df_forplot <- growth_climate_df %>% 
  mutate(aet_sum_cat = case_when(aet_sum < 295.4 ~ "low",
                                 aet_sum > 295.4 & aet_sum < 319.4 ~ "mid",
                                 aet_sum > 319.4 ~ "high"),
         prior_aet_sum_cat = case_when(prior_aet_sum < 306 ~ "low",
                                 #prior_aet_sum > 295.4 & prior_aet_sum < 319.4 ~ "mid",
                                 prior_aet_sum > 306 ~ "high"),
         prior_FDSI_cat = case_when(prior_FDSI < 0 ~ "low",
                                 #prior_FDSI > -0.54 & prior_FDSI < 0.59 ~ "mid",
                                 prior_FDSI > 0 ~ "high"))

ggplot(growth_climate_df_forplot, aes(x=aet_sum, y=rw_spline))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(prior_aet_sum_cat ~ prior_FDSI_cat)+
  scale_y_continuous(sec.axis = sec_axis(~ . , name = "prior AET", breaks = NULL, labels = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = "prior FDSI", breaks = NULL, labels = NULL))

ggplot(growth_climate_df_forplot, aes(x=aet_sum, y=rw_spline, col=prior_aet_sum_cat))+
  geom_point()+
  geom_smooth(method="lm")

ggplot(growth_climate_df_forplot, aes(x=aet_sum, y=rw_spline, col=prior_FDSI_cat))+
  geom_point()+
  geom_smooth(method="lm")


```


```{r}

##############################################

##make a big climate model

mod <- lmer(rw_spline ~ aet_sum + vpdmax_wt + prior_ppt_gs + prior_cwd_wy + prior_value_wt_tmin + prior_value_wt_tmean + (1|Provenance), data=growth_climate_df)
plot(mod)
qqmath(mod)
summary(mod) ##singular model means that provenance doesn't really matter when it comes to growth-climate correlations. 
## they're all correlated with the same things...but is the strength of the correlation weaker or stronger depending on provenance? How do I test this...

modclimprov <- lm(rw_spline ~ aet_sum*Provenance + vpdmax_wt*Provenance + prior_ppt_gs*Provenance + prior_cwd_wy*Provenance + prior_value_wt_tmin*Provenance + prior_value_wt_tmean*Provenance, data=growth_climate_df)
par(mfrow=c(2,2))
plot(modclimprov)
anova(modclimprov)

cor_provclim<- cor_clean %>%
  left_join(name_conversion, by=c("Provenance" = "oldname")) %>% 
  dplyr::select(-Provenance) %>% 
  dplyr::rename(Provenance = newname) %>% 
  left_join(
prov_pcapts %>% 
  dplyr::select(c(Provenance,PC1:PC2,MAT:pas,smrpb)), by="Provenance")


provmatmod<- lmer(cor ~ MAT + (1|Provenance), data=cor_provclim %>% filter(climvar=="prior_FDSI"))
plot(provmatmod)
qqmath(provmatmod)
summary(provmatmod)

cor_provclim_long <- pivot_longer(cor_provclim, PC1:smrpb)

# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
names <- unique(cor_provclim_long$name)
lmerdata <- data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(names)){
    data <- cor_provclim_long %>% filter(climvar==climvars[i] & name==names[j]) 
    mod <- lmer(cor ~ value + (1|Provenance), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    
lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvars[i], name=names[j], pvalue.lmer = pvalue.lmer)) 
  }}

lmerdata %>% filter(pvalue.lmer < 0.05)

#ppt_wt x msp
ggplot(data=cor_provclim_long %>% filter(climvar=="ppt_wt"& name=="msp"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("mean summer precip (mm)")+
  ggtitle("ppt_wt")

ppt_wt_msp<- cor_provclim_long %>% filter(climvar=="ppt_wt" & name=="msp") 

ppt_wt_msp_mod <- lmer(cor ~ value + (1|Provenance), data=ppt_wt_msp)
plot(ppt_wt_msp_mod)
qqmath(ppt_wt_msp_mod)
summary(ppt_wt_msp_mod)

#vpdmax_sm x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="vpdmax_sm"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("vpdmax_sm")

vpdmax_sm_PC1<- cor_provclim_long %>% filter(climvar=="vpdmax_sm" & name=="PC1") 

vpdmax_sm_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=vpdmax_sm_PC1)
plot(vpdmax_sm_PC1_mod)
qqmath(vpdmax_sm_PC1_mod)
summary(vpdmax_sm_PC1_mod)

vpdmax_sm_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=vpdmax_sm_PC1 %>% filter(!Provenance=="Gila NF"))
plot(vpdmax_sm_PC1_mod_noG)
qqmath(vpdmax_sm_PC1_mod_noG)
summary(vpdmax_sm_PC1_mod_noG) #still significant without Gila


#vpdmax_wt x smrpb
ggplot(data=cor_provclim_long %>% filter(climvar=="vpdmax_wt"& name=="smrpb"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("smrpb")+
  ggtitle("vpdmax_wt")

vpdmax_wt_smrpb<- cor_provclim_long %>% filter(climvar=="vpdmax_wt" & name=="smrpb") 

vpdmax_wt_smrpb_mod <- lmer(cor ~ value + (1|Provenance), data=vpdmax_wt_smrpb)
plot(vpdmax_wt_smrpb_mod)
qqmath(vpdmax_wt_smrpb_mod)
summary(vpdmax_wt_smrpb_mod)

vpdmax_wt_smrpb_mod_noG <- lmer(cor ~ value + (1|Provenance), data=vpdmax_wt_smrpb %>% filter(!Provenance=="Gila NF"))
plot(vpdmax_wt_smrpb_mod_noG)
qqmath(vpdmax_wt_smrpb_mod_noG)
summary(vpdmax_wt_smrpb_mod_noG) #not significant when Gila is taken out (probably not a real trend)

#FDSI x cmd
ggplot(data=cor_provclim_long %>% filter(climvar=="FDSI"& name=="cmd"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("CMD")+
  ggtitle("FDSI")

fdsi_cmd<- cor_provclim_long %>% filter(climvar=="FDSI" & name=="cmd") 

fdsi_cmd_mod <- lmer(cor ~ value + (1|Provenance), data=fdsi_cmd)
plot(fdsi_cmd_mod)
qqmath(fdsi_cmd_mod)
summary(fdsi_cmd_mod)

#FDSI x pas
ggplot(data=cor_provclim_long %>% filter(climvar=="FDSI"& name=="pas"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("precip as snow")+
  ggtitle("FDSI")

fdsi_pas<- cor_provclim_long %>% filter(climvar=="FDSI" & name=="pas") 

fdsi_pas_mod <- lmer(cor ~ value + (1|Provenance), data=fdsi_pas)
plot(fdsi_pas_mod)
qqmath(fdsi_pas_mod)
summary(fdsi_pas_mod)

fdsi_pas_mod_noO <- lmer(cor ~ value + (1|Provenance), data=fdsi_pas %>% filter(!Provenance=="Okanogan NF"))
plot(fdsi_pas_mod_noO)
qqmath(fdsi_pas_mod_noO)
summary(fdsi_pas_mod_noO) #still significant without Okanogan

#prior_value_fa_tmin x bFFP
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin"& name=="bFFP"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("bFFP")+
  ggtitle("prior_value_fa_tmin")

prifatmin_bffp<- cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin" & name=="bFFP") 

prifatmin_bffp_mod <- lmer(cor ~ value + (1|Provenance), data=prifatmin_bffp)
plot(prifatmin_bffp_mod)
qqmath(prifatmin_bffp_mod)
summary(prifatmin_bffp_mod) #significant

#prior_value_fa_tmin x EMT
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin"& name=="EMT"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("EMT")+
  ggtitle("prior_value_fa_tmin")

prifatmin_EMT<- cor_provclim_long %>% filter(climvar=="prior_value_fa_tmin" & name=="EMT") 

prifatmin_EMT_mod <- lmer(cor ~ value + (1|Provenance), data=prifatmin_EMT)
plot(prifatmin_EMT_mod)
qqmath(prifatmin_EMT_mod)
summary(prifatmin_EMT_mod) ##warmer places benefit from prior fall being hotter. 

#prior_value_wt_tmean x map
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_wt_tmean"& name=="map"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("MAP")+
  ggtitle("prior_value_wt_tmean")

priwttmean_map<- cor_provclim_long %>% filter(climvar=="prior_value_wt_tmean" & name=="map") 

priwttmean_map_mod <- lmer(cor ~ value + (1|Provenance), data=priwttmean_map)
plot(priwttmean_map_mod)
qqmath(priwttmean_map_mod)
summary(priwttmean_map_mod) #significant

priwttmean_map_mod_noO <- lmer(cor ~ value + (1|Provenance), data=priwttmean_map %>% filter(!Provenance=="Okanogan NF"))
plot(priwttmean_map_mod_noO)
qqmath(priwttmean_map_mod_noO)
summary(priwttmean_map_mod_noO) #still significant without Okanogan


#prior_value_wt_tmin x map
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_wt_tmin"& name=="map"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("MAP")+
  ggtitle("prior_value_wt_tmin cor")

priwttmin_map<- cor_provclim_long %>% filter(climvar=="prior_value_wt_tmin" & name=="map") 

priwttmin_map_mod <- lmer(cor ~ value + (1|Provenance), data=priwttmin_map)
plot(priwttmin_map_mod)
qqmath(priwttmin_map_mod)
summary(priwttmin_map_mod) #significant

priwttmin_map_mod_noO <- lmer(cor ~ value + (1|Provenance), data=priwttmin_map %>% filter(!Provenance == "Okanogan NF"))
plot(priwttmin_map_mod_noO)
qqmath(priwttmin_map_mod_noO)
summary(priwttmin_map_mod_noO) #not significant when Okanogan is taken out

#prior_value_sp_tmax x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_sp_tmax"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("prior_value_sp_tmax cor")

prisptmax_PC1<- cor_provclim_long %>% filter(climvar=="prior_value_sp_tmax" & name=="PC1") 

prisptmax_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=prisptmax_PC1)
plot(prisptmax_PC1_mod)
qqmath(prisptmax_PC1_mod)
summary(prisptmax_PC1_mod) #significant

prisptmax_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=prisptmax_PC1 %>% filter(!Provenance == "Gila NF"))
plot(prisptmax_PC1_mod_noG)
qqmath(prisptmax_PC1_mod_noG)
summary(prisptmax_PC1_mod_noG) #not significant when Gila is taken out

#prior_value_sp_tmean x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_sp_tmean"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("prior_value_sp_tmean")

prisptmean_PC1<- cor_provclim_long %>% filter(climvar=="prior_value_sp_tmean" & name=="PC1") 

prisptmean_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=prisptmean_PC1)
plot(prisptmean_PC1_mod)
qqmath(prisptmean_PC1_mod)
summary(prisptmean_PC1_mod) #significant

prisptmean_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=prisptmean_PC1 %>% filter(!Provenance=="Gila NF"))
plot(prisptmean_PC1_mod_noG)
qqmath(prisptmean_PC1_mod_noG)
summary(prisptmean_PC1_mod_noG) #still significant when Gila is removed


#prior_value_sp_tmin x PC1
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_value_sp_tmin"& name=="PC1"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("PC1")+
  ggtitle("prior_value_sp_tmin")

prisptmin_PC1<- cor_provclim_long %>% filter(climvar=="prior_value_sp_tmin" & name=="PC1") 

prisptmin_PC1_mod <- lmer(cor ~ value + (1|Provenance), data=prisptmin_PC1)
plot(prisptmin_PC1_mod)
qqmath(prisptmin_PC1_mod)
summary(prisptmin_PC1_mod) #significant

prisptmin_PC1_mod_noG <- lmer(cor ~ value + (1|Provenance), data=prisptmin_PC1 %>% filter(!Provenance == "Gila NF"))
plot(prisptmin_PC1_mod_noG)
qqmath(prisptmin_PC1_mod_noG)
summary(prisptmin_PC1_mod_noG) #still significant when Gila is removed


#prior_vpdmax_sp x map
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp"& name=="map"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("MAP")+
  ggtitle("prior_vpdmax_sp")

prior_vpdmax_sp_map<- cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp" & name=="map") 

prior_vpdmax_sp_map_mod <- lmer(cor ~ value + (1|Provenance), data=prior_vpdmax_sp_map)
plot(prior_vpdmax_sp_map_mod)
qqmath(prior_vpdmax_sp_map_mod)
summary(prior_vpdmax_sp_map_mod)

prior_vpdmax_sp_map_mod_noO <- lmer(cor ~ value + (1|Provenance), data=prior_vpdmax_sp_map %>% filter(!Provenance == "Okanogan NF"))
plot(prior_vpdmax_sp_map_mod_noO)
qqmath(prior_vpdmax_sp_map_mod_noO)
summary(prior_vpdmax_sp_map_mod_noO) #still significant when Okanogan is removed

#prior_vpdmax_sp x pas
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp"& name=="pas"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("precip as snow")+
  ggtitle("prior_vpdmax_sp")

prior_vpdmax_sp_pas<- cor_provclim_long %>% filter(climvar=="prior_vpdmax_sp" & name=="pas") 

prior_vpdmax_sp_pas_mod <- lmer(cor ~ value + (1|Provenance), data=prior_vpdmax_sp_pas)
plot(prior_vpdmax_sp_pas_mod)
qqmath(prior_vpdmax_sp_pas_mod)
summary(prior_vpdmax_sp_pas_mod)

#prior_aet_sum x EMT
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_aet_sum"& name=="EMT"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("EMT")+
  ggtitle("prior_aet_sum")

prior_aet_sum_EMT<- cor_provclim_long %>% filter(climvar=="prior_aet_sum" & name=="EMT") 

prior_aet_sum_EMT_mod <- lmer(cor ~ value + (1|Provenance), data=prior_aet_sum_EMT)
plot(prior_aet_sum_EMT_mod)
qqmath(prior_aet_sum_EMT_mod)
summary(prior_aet_sum_EMT_mod)

#prior_cwd_wy x TD
ggplot(data=cor_provclim_long %>% filter(climvar=="prior_cwd_wy"& name=="TD"), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  xlab("TD")+
  ggtitle("prior_cwd_wy")

prior_cwd_wy_TD<- cor_provclim_long %>% filter(climvar=="prior_cwd_wy" & name=="TD") 

prior_cwd_wy_TD_mod <- lmer(cor ~ value + (1|Provenance), data=prior_cwd_wy_TD)
plot(prior_cwd_wy_TD_mod)
qqmath(prior_cwd_wy_TD_mod)
summary(prior_cwd_wy_TD_mod)
```

###DBH as a predictor
```{r}
dbh_clim_data <- cor_provclim_long %>% 
  dplyr::select(-c(name,value)) %>% 
  unique() %>% 
  left_join(dbh %>% 
              mutate(tree=paste("X",Series, sep="")) %>% 
              dplyr::select(tree,DBH06,DBH14)) %>% 
  mutate(DBH_recent = case_when(is.na(DBH14) ~ DBH06,
                                .default = DBH14))

ggplot(dbh_clim_data, aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

dbhmods = data.frame()
for(i in 1:length(climvars)){
mod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar==climvars[i]))
dbhmods <- bind_rows(dbhmods, data.frame(climvar = climvars[i], pvalue = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)))}

dbhmods %>% filter(pvalue < 0.05)

##DBH x prior FDSI
DBH_priorFDSImod <- lmer(cor ~ DBH_recent + (1|Provenance), data=dbh_clim_data %>% filter(climvar=="prior_FDSI"))
plot(DBH_priorFDSImod)
qqmath(DBH_priorFDSImod)
summary(DBH_priorFDSImod)

ggplot(dbh_clim_data %>% filter(climvar=="prior_FDSI"), aes(x=DBH14, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar)

```


#multivariate

```{r}
data1 <- cor_provclim_long %>% 
  dplyr::select(-p.value) %>% 
  pivot_wider(names_from = climvar, values_from = cor) %>% 
  filter(name=="PC1")

data2<- data1 %>%
  remove_rownames() %>% 
  column_to_rownames("tree") %>% 
  dplyr::select(ppt_sm:prior_spei_sum)

scale(data2)
```



#extra
```{r}

##use PC1 and PC2 rather than climate variables

pca_cor_data<- cor_provclim_long %>% 
  left_join(prov_pcapts %>% dplyr::select(Provenance, PC1, PC2)) %>% 
  dplyr::select(-c(name,value)) %>% 
  unique() %>% 
    mutate(pc1diff = PC1 - prov_pcapts %>% 
  filter(Provenance == "Plantation") %>% 
  pull(PC1),
          pc2diff = PC2 - prov_pcapts %>% 
  filter(Provenance == "Plantation") %>% 
  pull(PC2)) %>% 
  mutate(pcadist = sqrt(pc1diff^2 + pc2diff^2))

unique(cor_provclim_long$climvar)

sig.cors20<- gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  filter(n>20) %>% 
  arrange(n)

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1), aes(x=Provenance, y=cor))+
  geom_boxplot()+
  geom_hline(yintercept = 0, color="red")+
  facet_wrap(~climvar)+
  theme(axis.text.x = element_text(angle=45, hjust=1))

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1) %>% filter(!Provenance=="Gila NF"), aes(x=PC1, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1), aes(x=PC2, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

pca_cor_data_filtered <- pca_cor_data %>% filter(climvar%in%sig.cors20$V1)

clim_pcmod <- lmer(cor ~ climvar*PC1 +  climvar*PC2 + climvar*pcadist + (1|Provenance), data=pca_cor_data)
plot(clim_pcmod)
qqmath(clim_pcmod)
summary(clim_pcmod)
dredge.climpcmod <- dredge(clim_pcmod)
dredge.climpcmod ##the best model just has climvar in it meaning that all provenances regardless of their PC1 or PC2 position are more or less responding the same to the climate variables. 

##use distance in PC and geographic space between population and plantation
ggplot(pca_cor_data %>% filter(climvar%in%sig.cors20$V1) %>% filter(!Provenance=="Gila NF"), aes(x=pcadist, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~climvar, scales="free")

pca_cor_data_dist<- pca_cor_data %>% filter(climvar%in%sig.cors20$V1)  %>% 
  left_join(pca_dist_df) %>% 
  left_join(geo.dist.df)

pcadist_mod_vpd_data <- pca_cor_data_dist %>% filter(climvar=="vpdmax_wt") %>% filter(!Provenance=="Gila NF")
pcadist_mod_vpd <- lmer(cor ~ pcadist*geo.dist.to.plant.km + (1|Provenance), data=pcadist_mod_vpd_data)
plot(pcadist_mod_vpd)
qqmath(pcadist_mod_vpd)
summary(pcadist_mod_vpd)
dredge(pcadist_mod_vpd)

pcadist_mod_aet_data<- pca_cor_data_dist %>% filter(climvar=="aet_sum")%>% filter(!Provenance=="Gila NF")
pcadist_mod_aet <- lmer(cor ~ pcadist*geo.dist.to.plant.km + (1|Provenance), data=pcadist_mod_aet_data)
plot(pcadist_mod_aet)
qqmath(pcadist_mod_aet)
summary(pcadist_mod_aet)
dredge(pcadist_mod_aet)
##neither model is significant with or without Gila. 

```