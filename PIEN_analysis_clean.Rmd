---
title: "Engelmann Spruce Provenance Study"
author: "Katie Nigro"
date: "2025-04-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Set up 

##Packages

```{r}
#load required packages
library(terra)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(dplyr)
library(stringr)
library(ClimateNAr)
library(ggfortify)
library(RColorBrewer)
library(tidyr)
library(lme4)
library(lmerTest)
library(car)
library(viridis)
library(dplR)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(MuMIn)
library(vegan)
library(cluster)
library(MASS)
library(indicspecies)
library(SPEI)
library(lattice)
library(tibble)
library(pals)
library(aod)
library(interactions)
library(gridExtra)
library(climwin)
library(lubridate)
library(dichromat)
library(prism)
library(multcomp)
library(multcompView)
library(lsmeans)
library(cowplot)
library(glmm)
library(glmmTMB)
library(colorspace)
library(performance)
library("factoextra")
library("corrplot")
```

##Plot locations

```{r}
#read in site and provenance locations
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")
west_states<- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","California","Oregon","Washington","Kansas","Oklahoma","Texas")
westernus <- us[match(toupper(west_states),toupper(us$NAME_1)),]

canada <- geodata::gadm(country = "Canada",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")

##use coordinates adjusted based on elevation and google maps
adjusted_coords<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIEN_corrected_coords.csv")

adjusted_provs<- vect(adjusted_coords, geom=c("long_corrected","lat_corrected"), crs=crs(us))

geo.dist.df<- data.frame(Provenance = adjusted_provs$Provenance, geo.dist.to.plant.km = as.matrix(terra::distance(adjusted_provs))[,21]/1000)

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=canada)+
  geom_spatvector(data=adjusted_provs, color="maroon")

#make key for provenance names
prov_names<-adjusted_coords %>% dplyr::select(Provenance, no) %>% 
 separate_wider_delim(Provenance, delim=" ", names=c("first","second","third"), too_few = "align_start", cols_remove=FALSE) %>% 
  separate_wider_delim(first, delim= "-", names=c("first","2"), too_few="align_start") %>% 
    separate_wider_delim(second, delim= "-", names=c("second","3"), too_few="align_start") %>% 
  mutate(across(everything(), ~ replace(.x, is.na(.x), ""))) %>%
  mutate(`3` = ifelse(second=="NF","F",`3`)) %>% 
  mutate(code=paste(substr(first,0,1),substr(`2`,0,1),substr(second,0,1),substr(`3`,0,1),third, sep="")) %>% 
  dplyr::select(c(Provenance,no,code)) %>% 
  mutate(no=as.integer(no)) %>% 
  mutate(code=case_when(Provenance == "Roosevelt NF" ~ "RoNF",
                        Provenance == "Pike NF" ~ "PiNF",
                        Provenance == "Gunnison NF" ~ "GuNF",
                        Provenance == "Coconino NF" ~ "CoNF",
                        Provenance == "Payette NF" ~ "PaNF",
                        Provenance == "Cache NF" ~ "CaNF",
                        Provenance == "Gila NF" ~ "GiNF",
                        TRUE ~ code))

provs_bylat <- as.data.frame(adjusted_provs) %>% 
  bind_cols(crds(adjusted_provs)) %>% 
  left_join(prov_names) %>% 
  arrange(y)
```

#Climate

##ClimateNA

```{r}
#read in climate from climateNA

filenames <- c("AHM","bFFP","CMD","DD_18","DD_0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPT_sm","PPT_sp","PPT_at","PPT_wt","RH","Tave_sm","Tave_wt","TD","SHM")

filenames_edited <- c("AHM","bFFP","CMD","DD18","DD0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","Tavesm","Tavewt","TD","SHM")

clim_raster_stack <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1961_1990_bioclim/Normal_1961_1990/Normal_1961_1990_bioclim/Normal_1961_1990_",filenames,".tif",sep=""))

names(clim_raster_stack)<- filenames_edited

prov_clim_adjusted_bi <- terra::extract(clim_raster_stack, adjusted_provs, method='bilinear') %>% cbind(as.data.frame(adjusted_provs)) %>% cbind(crds(adjusted_provs)) %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP)

prov_clim_adjusted_bi_long<- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,AHM:SHM, smrpb, monsoonality)) %>% 
  pivot_longer(AHM:monsoonality) %>% 
  mutate(type="adj bilinear") 

##making provenance climate table for paper
prov_clim_table<- prov_clim_adjusted_bi %>% 
  left_join(prov_names %>% dplyr::select(Provenance, code)) %>% 
  dplyr::select(Provenance, y, x, elev, MAT, MAP, NFFD,PAS) %>% 
  arrange(desc(y))

#write.csv(prov_clim_table,"prov_clim_table.csv")  
```

###Rehfeldt comparison

```{r}
##compare White River to Rehfeldt 2004 planting sites
idacreek<- c(48.364002, -116.822747)
canyoncreek<- c(48.370716, -116.799922)
high <- c(48.353759, -116.760290)
highest <- c(48.344491, -116.714165)
preistriver<- data.frame(rbind(idacreek, canyoncreek, high,highest))
colnames(preistriver)<- c("y","x")

preistriver_vect <- vect(preistriver, geom=c("x","y"), crs=crs(us))

preistriver_clim <- terra::extract(clim_raster_stack, preistriver_vect, method="simple", df=TRUE)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MAT, y=MAP), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MAT, y=MAP), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=NFFD, y=SHM), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=NFFD, y=SHM), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MCMT, y=RH), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MCMT, y=RH), col="black", size=3)
```

```{r}
#monthly normals

months = c("01","02","03","04","05","06","07","08","09","10","11","12")

monthly_ppt<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/ppt/PPT",months[i],".tif",sep=""))
ppt <- terra::extract(raster, adjusted_provs)
monthly_ppt <- left_join(monthly_ppt, ppt)}


monthly_tave<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/tave/Tave",months[i],".tif",sep=""))
tave <- terra::extract(raster, adjusted_provs)
monthly_tave <- left_join(monthly_tave, tave)}

monthly_clim <- monthly_ppt %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(PPT01:PPT12) %>% 
  bind_rows(monthly_tave %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(Tave01:Tave12)) %>% 
  mutate(month=substr(name,nchar(name)-1,nchar(name)),
         var = substr(name,0,nchar(name)-2))

monthly_clim_wide <- monthly_clim %>% 
  dplyr::select(c(Provenance, no, elev, value, month, var)) %>% 
  pivot_wider(values_from=value, names_from=var)

#png("figures/prov_temp_precip.png", width=8,height=8, res=300, units="in")
ggplot()+
  geom_bar(data=monthly_clim_wide, aes(x=as.numeric(month), y=PPT), stat="identity", fill="grey")+
  geom_line(data=monthly_clim_wide, aes(x=as.numeric(month), y=Tave*10), col="black", lwd=1)+
  scale_y_continuous(
    "PPT (mm)", 
    sec.axis = sec_axis(~ . / 10, name = "Temp (C)"), limits=c(-150,350))+
  scale_x_continuous(breaks=seq(1,12,1), labels=seq(1,12,1), name="Month")+
  facet_wrap(~factor(Provenance))+
  theme_bw()+
  theme(panel.grid.minor=element_blank())
#dev.off()

ggplot(monthly_clim %>% filter(var=="Tave") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="Tave") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="red",size=2)+
    facet_wrap(~factor(Provenance))

ggplot(monthly_clim %>% filter(var=="PPT") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="PPT") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="green",size=3)+
    facet_wrap(~factor(Provenance))
```


```{r}
#compare climates of provenances
prov_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(Provenance,AHM:SHM,smrpb)) %>% 
  left_join(prov_names) %>% 
  pivot_longer(AHM:smrpb, names_to = "var", values_to = "value")

order<- prov_clim_adjusted_bi %>% 
  arrange(y) %>% 
  pull(Provenance)

# png("figures/prov_clim_plot.png", width=12, height=8, units="in", res=500)
ggplot(prov_vars, aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
# dev.off()

ggplot(prov_vars %>% filter(!Provenance=="Gila NF"), aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
```


###future climate

```{r}
##get future projections from ClimateNA

#2000's normal
clim2000s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1991_2020_bioclim/Normal_1991_2020_bioclim/Normal_1991_2020_",filenames,".tif",sep=""))

names(clim2000s) <- paste(filenames_edited,"_ssp585_2000s", sep="") 

##2020's projections
clim2020s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040_",filenames,".tif",sep=""))

names(clim2020s) <- paste(filenames_edited,"_ssp585_2020s", sep="")  

##2050's projections
clim2050s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070_",filenames,".tif",sep=""))

names(clim2050s) <- paste(filenames_edited,"_ssp585_2050s", sep="") 

##2080's projections
clim2080s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100_",filenames,".tif",sep=""))

names(clim2080s) <- paste(filenames_edited,"_ssp585_2080s", sep="")  

future_clim_raster_stack <- c(clim2020s,clim2050s,clim2080s)

prov_futures<- terra::extract(future_clim_raster_stack, adjusted_provs, weights=T)

prov_futures_long<- prov_futures %>%
  left_join(data.frame(ID=seq(1,21,1), Provenance =adjusted_provs$Provenance)) %>% 
  dplyr::select(ID,Provenance,everything()) %>% 
  pivot_longer(cols=AHM_ssp585_2020s:SHM_ssp585_2080s) %>% 
  separate(name, into=c("climvar","carbon","period"), remove=TRUE) 
```

##PRISM

```{r}
#read in files
ppt_comb_plantation<- read.csv("ppt_comb_plantation.csv") 
tmax_comb_plantation<- read.csv("tmax_comb_plantation.csv")
tmin_comb_plantation<- read.csv("tmin_comb_plantation.csv")
tmean_comb_plantation<- read.csv("tmean_comb_plantation.csv")
vpdmax_comb_plantation<- read.csv("vpdmax_comb_plantation.csv")
vpdmin_comb_plantation<- read.csv("vpdmin_comb_plantation.csv")

ppt_comb_all<- read.csv("ppt_comb_all.csv")
tmax_comb_all<- read.csv("tmax_comb_all.csv")
tmin_comb_all<- read.csv("tmin_comb_all.csv")
tmean_comb_all<- read.csv("tmean_comb_all.csv")
vpdmax_comb_all<- read.csv("vpdmax_comb_all.csv")
vpdmin_comb_all<- read.csv("vpdmin_comb_all.csv")

##add in 1969 to plantation data
 months<- c("01","02","03","04","05","06","07","08","09","10","11","12")
# 
# # set location of climate data
climdir <- "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/PRISM"
# 
ppt_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_ppt_stable_4kmM3_198101_202305_bil/PRISM_ppt_stable_4kmM2_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  ppt<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  ppt_CN<-cbind(CN,ppt,year,month)
  ppt_data_1969<-rbind(ppt_data_1969,ppt_CN)}

tmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmin_stable_4kmM3_198101_202305_bil/PRISM_tmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmin_CN<-cbind(CN,tmin,year,month)
  tmin_data_1969<-rbind(tmin_data_1969,tmin_CN)}

tmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmax_stable_4kmM3_198101_202305_bil/PRISM_tmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmax_CN<-cbind(CN,tmax,year,month)
  tmax_data_1969<-rbind(tmax_data_1969,tmax_CN)}

tmean_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmean_stable_4kmM3_198101_202305_bil/PRISM_tmean_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmean<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmean_CN<-cbind(CN,tmean,year,month)
  tmean_data_1969<-rbind(tmean_data_1969,tmean_CN)}

vpdmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmax_stable_4kmM3_198101_202305_bil/PRISM_vpdmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmax_CN<-cbind(CN,vpdmax,year,month)
  vpdmax_data_1969<-rbind(vpdmax_data_1969,vpdmax_CN)}

vpdmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmin_stable_4kmM3_198101_202305_bil/PRISM_vpdmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmin_CN<-cbind(CN,vpdmin,year,month)
  vpdmin_data_1969<-rbind(vpdmin_data_1969,vpdmin_CN)}

##append 1969
ppt_comb_plantation <- bind_rows(as.data.frame(ppt_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), ppt=as.numeric(ppt), year=as.integer(year), month=as.integer(month)), ppt_comb_plantation %>% dplyr::select(-c(X.1, X))) 

tmax_comb_plantation <- bind_rows(as.data.frame(tmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmax=as.numeric(tmax), year=as.integer(year), month=as.integer(month)), tmax_comb_plantation %>% dplyr::select(-X))

tmean_comb_plantation <- bind_rows(as.data.frame(tmean_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmean=as.numeric(tmean), year=as.integer(year), month=as.integer(month)), tmean_comb_plantation %>% dplyr::select(-X)) 

tmin_comb_plantation <- bind_rows(as.data.frame(tmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmin=as.numeric(tmin), year=as.integer(year), month=as.integer(month)), tmin_comb_plantation%>% dplyr::select(-X)) 

vpdmax_comb_plantation <- bind_rows(as.data.frame(vpdmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmax=as.numeric(vpdmax), year=as.integer(year), month=as.integer(month)), vpdmax_comb_plantation%>% dplyr::select(-X)) 

vpdmin_comb_plantation <- bind_rows(as.data.frame(vpdmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmin=as.numeric(vpdmin), year=as.integer(year), month=as.integer(month)), vpdmin_comb_plantation%>% dplyr::select(-X))

```

###Plantation summary

```{r}
###site climate summary
ppt_plantation_yearly <- ppt_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(ppt_sum = sum(ppt))

mean(ppt_plantation_yearly$ppt_sum)
sd(ppt_plantation_yearly$ppt_sum)

tmin_plantation_dailyave <- tmin_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(tmin_ave=mean(tmin))
mean(tmin_plantation_dailyave$tmin_ave)

##plotting site climate over time
tmean_sum<- tmean_comb_plantation %>% 
  filter(year>1969) %>% 
  mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(decade) %>% 
  summarise(MAT = mean(tmean), se_MAT=sd(tmean)/sqrt(n()))

ppt_sum <- ppt_comb_plantation %>% 
  filter(year > 1969) %>% 
    mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(year,decade) %>% 
  summarise(MAP=sum(ppt)) %>% 
  group_by(decade) %>% 
  summarise(MAP_ave = mean(MAP), se_MAP=sd(MAP)/sqrt(n()))

plantation_2dclim <- left_join(tmean_sum, ppt_sum)

ggplot(plantation_2dclim, aes(x=MAT, y=MAP_ave, col=decade))+
         geom_point()

tmean_mod <- lm(tmean ~ year, data=tmean_comb_plantation %>% group_by(year) %>% summarise(tmean=mean(tmean)))
par(mfrow=c(2,2))
plot(tmean_mod)
summary(tmean_mod)

0.015728*45

tmin_mod <- lm(tmin ~ year, data=tmin_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmin=mean(tmin)))
par(mfrow=c(2,2))
plot(tmin_mod)
summary(tmin_mod)

tmax_mod <- lm(tmax ~ year, data=tmax_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmax=mean(tmax)))
par(mfrow=c(2,2))
plot(tmax_mod)
summary(tmax_mod)

ppt_mod <- lm(ppt ~ year, data=ppt_comb_plantation %>%  filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(ppt=sum(ppt)))
par(mfrow=c(2,2))
plot(ppt_mod)
summary(ppt_mod)

0.021181*46
```

###seasonal

```{r}
##calculate seasonal PRISM values

##ppt
ppt_summed <- as.data.frame(ppt_comb_plantation) %>% 
  mutate(ppt = as.numeric(ppt), year=as.integer(year)) %>%
  filter(!is.na(ppt)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(ppt = sum(ppt)) 

ggplot(ppt_summed %>% filter(CN=="Plantation"), aes(x=year, y=ppt)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(ppt_summed %>% filter(CN=="Plantation") %>% pull(ppt)), col="red")

##seasonal ppt
ppt_seasonal_plantation <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
  summarise(PPTsm = sum(ppt)) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(5,6,7,8,9)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_gs = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(12,1,2)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_wt = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
  summarise(PPT_at = sum(ppt))) %>% 
  left_join(ppt_comb_plantation %>% 
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
  summarise(PPTsp = sum(ppt))) %>% 
  left_join(ppt_summed) 

##tmin
tmin_summed <- as.data.frame(tmin_comb_plantation) %>% 
  mutate(tmin = as.numeric(tmin), year=as.integer(year)) %>%
  filter(!is.na(tmin)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmin = mean(tmin)) 

ggplot(tmin_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmin)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmin_summed %>% filter(CN=="Plantation") %>% pull(tmin)), col="red")

##tmax
tmax_summed <- as.data.frame(tmax_comb_plantation) %>% 
  mutate(tmax = as.numeric(tmax), year=as.integer(year)) %>%
  filter(!is.na(tmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmax = mean(tmax))

ggplot(tmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmax_summed %>% filter(CN=="Plantation") %>% pull(tmax)), col="red")

##tmean
tmean_summed <- as.data.frame(tmean_comb_plantation) %>% 
  mutate(tmean = as.numeric(tmean), year=as.integer(year)) %>%
  filter(!is.na(tmean)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmean = mean(tmean)) 

ggplot(tmean_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmean)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmean_summed %>% filter(CN=="Plantation") %>% pull(tmean)), col="red")

##seasonal temps
all_temps <- bind_rows(tmean_comb_plantation %>% pivot_longer(tmean), tmin_comb_plantation %>% pivot_longer(tmin), tmax_comb_plantation %>% pivot_longer(tmax))

summertemps <- all_temps %>% filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sm =mean(value))
falltemps <- all_temps %>% filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_fa =mean(value))
wintertemps <- all_temps %>% filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month=="12",year+1,year)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_wt =mean(value))
springtemps <- all_temps %>% filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year, name) %>% 
  summarise(value_sp =mean(value))

plantation_seasonal_temps <- left_join(summertemps,falltemps) %>% 
  left_join(wintertemps) %>% 
  left_join(springtemps)

plantation_seasonal_temps_wide<- plantation_seasonal_temps %>% 
  pivot_wider(values_from = c(value_sm,value_fa,value_wt,value_sp), names_from = name)

##vpdmax

vpdmax_summed <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(!is.na(vpdmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax = mean(vpdmax))

ggplot(vpdmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=vpdmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(vpdmax_summed %>% filter(CN=="Plantation") %>% pull(vpdmax)), col="red")

vpdmax_seasonal <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sm = mean(vpdmax)) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_fa = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month == "12", year+1, year)) %>% 
  filter(!year %in% c(1970,2017)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_wt = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sp = mean(vpdmax)))


##look at correlation in annual variables
left_join(tmean_summed,tmax_summed) %>% 
  left_join(tmin_summed) %>% 
  left_join(vpdmax_summed) %>% 
  left_join(ppt_summed) %>% 
  ungroup() %>% 
  dplyr::select(tmean:ppt) %>% 
  cor()

```

##FDSI calculation

High FDSI value = less droughty

```{r}
all_climate <- left_join(ppt_comb_plantation,tmax_comb_plantation) %>% 
  left_join(tmin_comb_plantation) %>% 
  left_join(tmean_comb_plantation) %>% 
  left_join(vpdmax_comb_plantation) %>% 
  left_join(vpdmin_comb_plantation) %>% 
  mutate(vpdmean=(vpdmin+vpdmax)/2)

nrow(all_climate)
nrow(tmin_comb_plantation)

all_climate_long <- all_climate %>% 
  pivot_longer(c("ppt","tmax","tmin","tmean","vpdmax","vpdmin","vpdmean"), names_to="climvar", values_to = "value") %>% 
  mutate(monthvar = paste(climvar,month,sep=""))

climate_minus1<- all_climate_long %>% 
  mutate(year=year+1) %>% 
  mutate(monthvar = paste("yr1",climvar,month,sep=""))

climate_minus2<- all_climate_long %>% 
  mutate(year=year+2) %>% 
  mutate(monthvar = paste("yr2",climvar,month,sep=""))

climate_allyears <- rbind(all_climate_long, climate_minus1, climate_minus2)

### FDSI CALC

### CALCULATIONS TAKEN FROM WILLIAMS ET AL., 2013 
# DOI: 10.1038/NCLIMATE1693
#https://www.nature.com/articles/nclimate1693
FDSI_C <- climate_allyears %>%
 dplyr::select(-c("date","month","climvar")) %>% 
  pivot_wider(id_cols=c("CN","year"), names_from = monthvar, values_from = value)

head(FDSI_C)

FDSI_raw<- FDSI_C %>% 
  group_by(CN, year) %>% 
  summarise(FDSIvpd=(((vpdmean5+vpdmean6+vpdmean7)/3)+(yr1vpdmean8+yr1vpdmean9+yr1vpdmean10)/3)/2, FDSIppt=log(yr1ppt11+yr1ppt12+ppt1+ppt2+ppt3))

meanVPD <- mean(FDSI_raw$FDSIvpd, na.rm=T)
meanppt <- mean(FDSI_raw$FDSIppt, na.rm=T)
SDVPD <- sd(FDSI_raw$FDSIvpd, na.rm=T)
SDppt <- sd(FDSI_raw$FDSIppt, na.rm=T)
FDSI_raw$zscoreppt <- ((FDSI_raw$FDSIppt-meanppt)/SDppt)
FDSI_raw$zscoreVPD <- ((FDSI_raw$FDSIvpd-meanVPD)/SDVPD)

FDSI_raw$FDSI <- (0.44*(FDSI_raw$zscoreppt)-0.56*(FDSI_raw$zscoreVPD))

ggplot(FDSI_raw, aes(x=year, y=FDSI))+
  geom_line()+
  geom_point()
#I think we need to consider the fact that FDSI was really high right before the drought of the early 2000's so that's why trees may not be showing equivalent growth rates after the drought (cause it was still relatively hot and dry)
```

##CWD calculation

```{r}
source("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/grad school/cwd_function_v3.r")
# 
# #get dem
# dem_plantation <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/USGS_13_n40w107_20220216.tif")
# 
# slpasp <- terrain(dem_plantation, v = c("slope","aspect"))
# 
# slpasp_plantation <- terra::extract(slpasp, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# 
# plantation_cwd_data <- all_climate %>% left_join(as.data.frame(adjusted_provs) %>% bind_cols(crds(adjusted_provs)) %>% filter(Provenance=="Plantation"), by=c("CN"="Provenance")) %>%
#   mutate(soilawc=116.5, foldedaspect = abs(180-abs(slpasp_plantation$aspect - 225)), slope=slpasp_plantation$slope)
# 
# write.csv(plantation_cwd_data, "plantation_cwd_data.csv")

plantation_cwd_data<- read.csv("plantation_cwd_data.csv")

plantation_cwd <- cwd_function(site="plantation",slope=plantation_cwd_data$slope, latitude=plantation_cwd_data$y, foldedaspect = plantation_cwd_data$foldedaspect, ppt = plantation_cwd_data$ppt, tmean = plantation_cwd_data$tmean, month = plantation_cwd_data$month, soilawc = plantation_cwd_data$soilawc, year = plantation_cwd_data$year, type="annual")

head(plantation_cwd)

cwd_year0 <- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month<9) %>% 
  group_by(site, year) %>% 
  summarise(cwd_1_9 = sum(cwd))

cwd_yearminus1 <-  plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month>8) %>%
  mutate(wateryear=year+1) %>% 
  group_by(site, wateryear) %>% 
  summarise(cwd_prev = sum(cwd))

wateryear_cwd<- cwd_year0 %>% 
  left_join(cwd_yearminus1, by=c("year" = "wateryear","site")) %>% 
  rowwise() %>% 
  mutate(cwd_wy = sum(cwd_1_9, cwd_prev))

sp_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd))

fa_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(cwd_fa = sum(cwd))

##water year drought
ggplot(wateryear_cwd, aes(x=year, y=cwd_wy))+
  geom_point()+
  geom_line()+
  geom_point(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_line(data= sp_cwd, aes(x=year, y=cwd_sp),col="green4")+
  geom_point(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")+
  geom_line(data= fa_cwd, aes(x=year, y=cwd_fa),col="orange")  ##1970s and 80s droughts were influenced more by fall lack of moisture than 2002 drought. 


##spring drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd)), aes(x=year, y=cwd_sp))+
  geom_point()+
  geom_line()

##fall drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)), aes(x=year, y=cwd_fa))+
  geom_point()+
  geom_line()

#summer drought
ggplot(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% filter(month%in%c(6,7,8)), aes(x=date, y=cwd))+
  geom_point(aes(col=factor(year)))+
  geom_line()

#number of times each month throughout the time series had CWD>0. July and August are most common times when CWD > 0, and it averages ~10mm
plantation_cwd %>% 
  filter(cwd>0) %>% 
  group_by(month) %>% 
  summarise(n=n(), mean=mean(cwd))

##summarise monthly climate on an annual basis
plantation_cwd_annual <- plantation_cwd %>% 
  group_by(site,year, soilawc) %>% 
  summarise(ppt_sum = sum(ppt), tmean_ave=mean(tmean), aet_sum=sum(aet), cwd_sum=sum(cwd))

plantation_cwd_annual_long<- plantation_cwd_annual %>% 
  left_join(FDSI_raw %>% dplyr::select(year,FDSI), by="year") %>% 
  dplyr::select(-CN) %>% 
  pivot_longer(ppt_sum:FDSI)

ggplot(plantation_cwd_annual_long %>% filter(name%in%c("cwd_sum","FDSI")), aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales = "free")
  
```

##SPEI

```{r}
##calculate SPEI - Standardized Precipitation Evapotranspiration Index (higher is wetter, lower is drier)
plantation_climatebalance <- plantation_cwd %>% 
  mutate(ppt_pet = ppt - petm)

plantation_spei <- spei(plantation_climatebalance %>% pull(ppt_pet), scale=1)
summary(plantation_spei)

plantation_spei_sum <- data.frame(year=plantation_climatebalance$year, month=plantation_climatebalance$month, spei = plantation_spei$fitted, date = as.Date(paste(plantation_climatebalance$month,"01",plantation_climatebalance$year, sep="/"), "%m/%d/%Y"))

ggplot(plantation_spei_sum %>% filter(year > 1987 & year <2024), aes(x=date, y=spei, fill=spei>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

plantation_spei_annual<- plantation_spei_sum %>% 
  group_by(year) %>% 
  summarise(spei_mean = mean(spei), spei_sum=sum(spei))

ggplot(plantation_spei_annual %>% filter(year > 1987 & year <2024), aes(x=year, y=spei_sum, fill=spei_sum>0))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

##RAWS
This data is from Dowd Junction weather station, located at 39.626944, -106.451667 - just down the mountain from the White River Plantation site. 

```{r}
DJ <- read.csv("DowdJunction_monthlydata.csv")

DJ[ DJ == "-9999"] <- NA

DJ_seasonal<- DJ %>% 
  separate(date, into=c("month","day","year"), sep="/", remove=TRUE) %>% 
  mutate(month=as.numeric(month), day=as.numeric(day), year=as.numeric(year)) %>% 
  mutate(season = case_when(month %in% c(12,1,2) ~ "winter",
                            month %in% c(3,4,5) ~ "spring",
                            month %in% c(6,7,8) ~ "summer",
                            month %in% c(9,10,11) ~ "fall"),
         seasonyear = ifelse(month==12, year+1, year)) %>% 
  filter(seasonyear>1985) %>% 
  group_by(seasonyear, season) %>% 
  summarise(ave_mean_air_temp_C = mean(mean_air_temp_C, na.rm=TRUE),
            ave_daily_max_temp_C = mean(mean_daily_max_temp_C, na.rm=TRUE),
            ave_daily_min_temp_C = mean(mean_daily_min_temp_C, na.rm=TRUE),
            ave_mean_RH = mean(mean_RH, na.rm=TRUE),
            total_season_precip_mm = sum(total_precip_mm, na.rm=TRUE))

##looks pretty similar
ggplot()+
  geom_point(data=DJ_seasonal %>% filter(season=="summer" & seasonyear>1986), aes(x=seasonyear, y=ave_mean_air_temp_C), color="orange")+
  geom_line(data=DJ_seasonal %>% filter(season=="summer" & seasonyear>1986), aes(x=seasonyear, y=ave_mean_air_temp_C), color="orange")+
  geom_point(data=summertemps %>% filter(name=="tmean"), aes(x=year, y=value_sm), color="red")+
  geom_line(data=summertemps %>% filter(name=="tmean"), aes(x=year, y=value_sm), color="red")
```

##All climate vars

```{r}
#combine all climate vars

plantation_clim <- ppt_seasonal_plantation %>% 
  left_join(plantation_seasonal_temps_wide) %>% 
  left_join(vpdmax_seasonal) %>% 
  left_join(FDSI_raw) %>% 
  left_join(plantation_cwd_annual) %>% 
  left_join(wateryear_cwd) %>% 
  left_join(plantation_spei_annual)

colnames(plantation_clim)

plantation_clim_long <- plantation_clim %>% 
dplyr::select(c(CN:vpdmax_sp, FDSI, aet_sum, cwd_sum, cwd_wy, spei_sum)) %>% 
  pivot_longer(PPTsm:spei_sum) %>% 
  mutate(type = ifelse(name %in% c("PPTsp","PPTsm","PPT_at","ppt_wt"), "PPT",
                       ifelse(name %in% c("value_sp_tmean","value_sm_tmean","value_fa_tmean","value_wt_tmean","value_sp_tmin","value_sm_tmin","value_fa_tmin","value_wt_tmin","value_sp_tmax","value_sm_tmax","value_fa_tmax","value_wt_tmax"),"TEMP",NA)),
         season = ifelse(name %in% c("PPTsp","value_sp_tmean","value_sp_tmin","value_sp_tmax"), "Spring", 
                         ifelse(name %in% c("PPTsm","value_sm_tmean","value_sm_tmin","value_sm_tmax"), "Summer",
                                ifelse(name %in% c("ppt_wt","value_wt_tmean","value_wt_tmin","value_wt_tmax"),"Winter",
                                                   ifelse(name %in% c("PPT_at","value_fa_tmean","value_fa_tmin","value_fa_tmax"),"Fall",NA))))) %>% 
  separate(name, into=c("name1","name2","name3"), sep="_",remove=FALSE) %>% 
  mutate(statistic = case_when(name3=="tmax" ~ "max",
                               name3=="tmin"~ "min",
                               name3=="tmean" ~ "mean",
                               type=="PPT" ~ "sum",
                               TRUE ~ NA))

ggplot(plantation_clim_long %>% filter(name %in% c("PPTsp","PPTsm","PPT_at","ppt_wt","value_sp_tmean","value_sm_tmean","value_fa_tmean","value_wt_tmean","value_sp_tmin","value_sm_tmin","value_fa_tmin","value_wt_tmin","value_sp_tmax","value_sm_tmax","value_fa_tmax","value_wt_tmax")), aes(x=year, y=value, col=type))+
  scale_color_manual(values=c("skyblue4","firebrick"))+
  geom_line(aes(lty=factor(statistic, levels=c("mean","max","min","sum"))))+
  scale_linetype(name="Statistic")+
  geom_smooth(method="lm", aes(lty=factor(statistic, levels=c("mean","max","min","sum"))))+
  facet_wrap(type~factor(season,levels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=2)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))

###models

##spring ppt

spppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="PPTsp"))
plot(spppt_mod)
summary(spppt_mod) #NS

##summer ppt

smppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="PPTsm"))
plot(smppt_mod)
summary(smppt_mod) #NS

##fall ppt

atppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="PPT_at"))
plot(atppt_mod)
summary(atppt_mod) #NS

##winter ppt

wtppt_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="ppt_wt"))
plot(wtppt_mod)
summary(wtppt_mod) #NS

##spring tmean

sptmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sp_tmean"))
plot(sptmean_mod)
summary(sptmean_mod) #NS

sptmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sp_tmin"))
plot(sptmin_mod)
summary(sptmin_mod) #significant

sptmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sp_tmax"))
plot(sptmax_mod)
summary(sptmax_mod) #NS

##summer tmean

smtmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sm_tmean"))
plot(smtmean_mod)
summary(smtmean_mod) #Significant

smtmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sm_tmin"))
plot(smtmin_mod)
summary(smtmin_mod) #significant

smtmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_sm_tmax"))
plot(smtmax_mod)
summary(smtmax_mod) #significant

##fall tmean

attmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_fa_tmean"))
plot(attmean_mod)
summary(attmean_mod) #Significant

fatmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_fa_tmin"))
plot(fatmin_mod)
summary(fatmin_mod) #significant

fatmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_fa_tmax"))
plot(fatmax_mod)
summary(fatmax_mod) #significant

##winter tmean

wttmean_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_wt_tmean"))
plot(wttmean_mod)
summary(wttmean_mod) #NS

wttmin_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_wt_tmin"))
plot(wttmin_mod)
summary(wttmin_mod) #NS

wttmax_mod <- lm(value~year, data=plantation_clim_long %>% filter(name=="value_wt_tmax"))
plot(wttmax_mod)
summary(wttmax_mod) #NS
```


##Climate extremes

```{r}
plantation_clim_long_qs<- plantation_clim_long %>% 
  left_join(plantation_clim_long %>% 
  filter(!is.na(value)) %>% 
  group_by(name) %>% 
  summarise(q2.5 = quantile(value, 0.025), q97.5 = quantile(value, 0.975), out.hi = quantile(value, c(0.75))  + IQR(value)*1.5, out.low = quantile(value, c(0.75)) - IQR(value)*1.5))

##look at years where each climate variable exceeded the 97.5th (or 2.5th) percentile - these are years of potentially extreme climate 
ggplot(plantation_clim_long_qs, aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.hi), col="black")

###############
## identify drought year
###############
unique(plantation_clim_long_qs$name)

plantation_clim_xtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet") & value < out.low, "yes",
                          ifelse(name %in% c("value_sm_tmax","value_sm_tmean","value_sm_tmin","value_fa_tmax","value_fa_tmean","value_fa_tmin","value_wt_tmax","value_wt_tmean","value_wt_tmin","value_sp_tmax","value_sp_tmean","value_sp_tmin","vpdmax_sm","vpdmax_fa","vpdmax_wt","vpdmax_sp","cwd_sum","cwd_wy","spei_sum") & value > out.hi, "yes", "no" 
  ))) %>% 
  filter(extreme=="yes")

xtreme_d_byyr<- plantation_clim_xtremes %>% 
  group_by(year) %>% 
  summarise(n=n()) %>% 
  as.data.frame()

ggplot(xtreme_d_byyr, aes(x=year, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("gold","brown"))

###########
## identify cold years
#############
plantation_clim_coldxtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("value_sm_tmax","value_sm_tmean","value_sm_tmin","value_fa_tmax","value_fa_tmean","value_fa_tmin","value_wt_tmax","value_wt_tmean","value_wt_tmin","value_sp_tmax","value_sp_tmean","value_sp_tmin","vpdmax_sm","vpdmax_fa","vpdmax_wt","vpdmax_sp","cwd_sum","cwd_wy") & value < out.low, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

xtreme_c_byyr<- plantation_clim_coldxtremes %>% 
  group_by(year) %>% 
  summarise(n=n()) 

ggplot(xtreme_c_byyr, aes(x=year, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("lightblue","navy"))

plantation_clim_wetextremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum") & value > out.hi, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

ggplot(plantation_clim_long_qs %>% 
  filter(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum")), aes(x=year, y=value, color=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales="free")+
  geom_line(data=plantation_clim_long_qs %>% 
  filter(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum")), aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs %>% 
  filter(name %in% c("PPTsm","ppt_gs","ppt_wt","PPT_at","PPTsp","ppt","FDSI","aet_sum","spei_sum")), aes(x=year, y=out.hi), col="black")+
  geom_hline(yintercept=0)

```

##Frost

```{r}
tmindata_30 <- read.csv("tmindata_30.csv")
tmindata_31 <- read.csv("tmindata_31.csv")

head(tmindata_30)
head(tmindata_31)

tmin_all<- bind_rows(tmindata_30, tmindata_31) %>% 
  mutate(date=mdy(paste(month,day,year,sep="-"))) %>% 
  arrange(date)

frost_days<- tmin_all %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(n=n())

ggplot(frost_days, aes(x=year, y=n))+
  geom_point()+
  geom_smooth(method="lm")
  
fd_mod <- lm(n ~ year, data=frost_days)
par(mfrow=c(2,2))
plot(fd_mod)
summary(fd_mod)

tmin_aves<- tmin_all %>% 
  group_by(month,day) %>% 
  summarise(ave_tmin=mean(tmin), se=sd(tmin)/sqrt(n()), n=n()) %>% 
  mutate(doy = ymd(paste("2000",month,day,sep="-")))

tmin_all_spring <- tmin_all %>% 
  filter(month %in% c(5,6,7)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(last_spring_frost = max(date)) %>% 
  bind_rows(data.frame(year=2009, last_spring_frost=as.Date("2009-05-14"))) %>% 
  mutate(day_of_last_spring_frost = as.numeric(yday(last_spring_frost)))

tmin_all_fall <- tmin_all %>% 
  filter(month %in% c(8,9,10)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(first_fall_frost = min(date)) %>%
  bind_rows(data.frame(year=2015, first_fall_frost=as.Date("2015-10-14"))) %>% 
  mutate(day_of_first_fall_frost = as.numeric(yday(first_fall_frost)))

plantation_frost <- left_join(tmin_all_spring, tmin_all_fall) %>% 
  dplyr::select(year, day_of_first_fall_frost, day_of_last_spring_frost) %>% 
  mutate(CN="Plantation")

vlines<- prov_clim_adjusted_bi %>% 
  dplyr::select(Provenance,bFFP,eFFP) %>% 
    mutate(bFFP_date = as.Date(bFFP, origin = "1999-12-31"),
           eFFP_date = as.Date(eFFP, origin = "1999-12-31")) %>% 
  arrange(bFFP) %>% 
  mutate(num = seq(-3.6,8.4,.6)) 

hlines <- vlines %>% 
  pivot_longer(bFFP_date:eFFP_date)


ggplot(tmin_aves, aes(x=doy, y=ave_tmin))+
  # geom_vline(data=vlines, aes(xintercept=bFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  # geom_vline(data=vlines, aes(xintercept=eFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_line(data=hlines, aes(x=value, y=num, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=3)+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=hlines, aes(x=ymd("2000-08-01"), y=num+.2, label=Provenance))+
  geom_point()+
  geom_errorbar(aes(ymin=ave_tmin-se, ymax=ave_tmin+se ))+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  theme_bw()
```

##PIEN climate niche

```{r}
pien <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/pien_range.tif")

pien2 <- classify(pien, cbind(-Inf, 0, NA), right=TRUE)
pien_trim<- trim(pien2)
par(mfrow=c(1,1))
plot(pien_trim)

engelmann_points_usonly <- spatSample(pien_trim, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
engelmann_clim_us <- terra::extract(clim_raster_stack, engelmann_points_usonly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##get points for Canada distribution from Mathys study and limit to only those within the boundary established by Little.
pien_mathys <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Current and predicted range of Engelmann spruce under climate change in the Pacific Northwest/data/commondata/data0/es_5075/w001001.adf")

pien_little <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")

pien_mathys2 <- classify(pien_mathys, cbind(-Inf, 0, NA), right=TRUE)
pien_mathys_crop_ca <- crop(pien_mathys2 %>% project(crs(canada)), canada %>% filter(NAME_1%in%c("Alberta","British Columbia")) ) %>% crop(pien_little %>% project(crs(canada))) %>%
  trim()

pien_mathys_little_ca_points <- spatSample(pien_mathys_crop_ca, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
pien_mathys_little_ca_points_crop <- crop(pien_mathys_little_ca_points, pien_little %>% project(crs(pien_mathys_little_ca_points)))
pien_mathys_little_ca_clim <- terra::extract(clim_raster_stack, pien_mathys_little_ca_points_crop %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##combine US and Canada climates
clim_pien<- bind_rows(pien_mathys_little_ca_clim,engelmann_clim_us)

ggplot()+
  geom_spatvector(data=engelmann_points_usonly %>% project(crs(canada)),size=0.05)+
  geom_spatvector(data=pien_mathys_little_ca_points_crop %>% project(crs(canada)), size=0.05)+
  geom_spatvector(data = canada, fill=NA, color="red")+
  geom_spatvector(data=westernus, fill=NA, color="red")
```


## PCA

```{r}
#run the PCA

##have to take out smrpb if I want to project into the future...or calculate it from ClimateNA variables

clim_pien_cor<- clim_pien %>% 
  dplyr::select(-ID) %>% 
    mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  cor()

ggcorrplot(clim_pien_cor, outline.color="white", type="lower", hc.order=TRUE)

pca2_clim_vars <- c("CMD","MCMT","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","TD","SMRPB_NA")

env_vars_pien<- clim_pien %>% 
  mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  dplyr::select(all_of(pca2_clim_vars))

env_vars_pien %>% 
  cor()

env_vars_noplant<- prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Plantation") %>% 
    mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  dplyr::select(colnames(env_vars_pien))

big_pca_data <- bind_rows(env_vars_noplant, env_vars_pien)
big_pca_data %>% 
  cor()

set.seed(83)
clim_pca_big <- prcomp(big_pca_data,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals_pcabig<- (clim_pca_big$sdev)^2
eigenvals_pcabig
sum(eigenvals_pcabig) #the sum of the eigenvalues = the number of variables (9)
eigenvals_pcabig/sum(eigenvals_pcabig)#this is the proportion variance explained
summary(clim_pca_big)
par(mfrow=c(1,1))
plot(clim_pca_big,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts_big <- clim_pca_big$x[1:nrow(env_vars_noplant),] %>% 
  cbind(prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation")) %>% 
  left_join(prov_names)

plantation_only <- prov_clim_adjusted_bi %>% filter(Provenance == "Plantation") %>% 
  mutate(period="1970s")

plantation_future <- prov_futures_long %>% filter(Provenance=="Plantation") %>% 
  pivot_wider(names_from=climvar, values_from=value, id_cols = c(ID,Provenance,carbon,period))

plantation_all<- bind_rows(plantation_only, plantation_future)

carbon.colors<- c("black",brewer.pal(6,"RdBu")[c(6,5,2,1)])

plantation_clim_vars <- plantation_all %>% 
    mutate(SMRPB_NA = PPTsm/PPTsp) %>% 
  dplyr::select(c(period,colnames(env_vars_pien)))

big_pca_data_sum <- big_pca_data %>% 
  as.data.frame() %>% 
  mutate(id=seq(1:nrow(big_pca_data))) %>% 
  pivot_longer(CMD:SMRPB_NA) %>% 
  group_by(name) %>% 
  summarise(mean = mean(value), sd=sd(value))

scaled_plantation_futures<- plantation_clim_vars %>% 
  pivot_longer(CMD:SMRPB_NA) %>% 
  left_join(big_pca_data_sum) %>% 
  mutate(scaledvalue = (value - mean)/sd) %>% 
  dplyr::select(period,name,scaledvalue) %>% 
  pivot_wider(names_from="name", values_from = "scaledvalue") %>% 
  dplyr::select(-period)

plant_pca_scores <- data.frame(Provenance="Plantation",
                               period = plantation_all$period,
                               PC1 = (clim_pca_big$rotation[,1] %*% t(scaled_plantation_futures))[1,],
                               PC2 = (clim_pca_big$rotation[,2] %*% t(scaled_plantation_futures))[1,],
                               PC3 = (clim_pca_big$rotation[,3] %*% t(scaled_plantation_futures))[1,])

##### playing with factoextra visualizations #####

get_eigenvalue(clim_pca_big)
fviz_eig(clim_pca_big, addlabels=TRUE)
var<-get_pca_var(clim_pca_big)
var$coord

fviz_pca_var(clim_pca_big, col.var="black")
fviz_cos2(clim_pca_big, choice = "var", axes = 1)
fviz_pca_var(clim_pca_big, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )
head(var$contrib, 3)
corrplot(var$contrib, is.corr=FALSE) 
contrib.plot<- ggarrange(fviz_contrib(clim_pca_big, choice="var", axes=1, fill="wheat3", color="wheat3", title="PC1"),fviz_contrib(clim_pca_big, choice="var", axes=2,fill="wheat3", color="wheat3", title="PC2"), nrow=1)

contrib.plot

###pien climate niche
scores1 <- data.frame(clim_pca_big$x[,1:3])
# scores <- lapply(scores1, function(x) x / sqrt(sum((x - mean(x))^2)))
loadings <- as.data.frame(clim_pca_big$rotation)[1:3]
loadings_pc1pc2 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","PPTwt","PPTsp","CMD","MCMT","NFFD","MWMT"),]
loadings_pc1pc3 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","TD","PPTsm","NFFD","MCMT"),]
scale <- min(max(abs(scores1$PC1))/max(abs(loadings$PC1)),
             max(abs(scores1$PC2))/max(abs(loadings$PC2))) * 0.8

###test -- this is how you manually calculate contribution of variables to each PC. 
var_cor_func <- function(var.loadings, comp.sdev){var.loadings*comp.sdev}
var.cor <- t(apply(clim_pca_big$rotation, 1, var_cor_func, clim_pca_big$sdev))
var.cor  ##correlation
var.cor^2 ##cos2
comp.cos2 <- apply(var.cor^2, 2, sum)
contrib <- function(var.cos2, comp.cos2){var.cos2*100/comp.cos2}
var.contrib <- t(apply(var.cor^2,1, contrib, comp.cos2))
###

pc1_pc2_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=c(.1,.1,.1,.1,1,-.1,-.2,-.3), vjust=c(1.2,1.2,1.2,-1.2,1,1,1,1))+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance", guide="none")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=2)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC2 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[2]*100,1),"%)",sep=""))+
   xlim(-5,5)+
   ylim(-3,7.5)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc2_niche_plot.png", width=5, height=4, res=300, units = "in")
pc1_pc2_niche_plot
dev.off()
 

pc1_pc3_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC3))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc3 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC3),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc3 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc3)),
               aes(x = PC1, y = PC3, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC3, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC3, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=1.5)+
   xlim(-5,5)+
   ylim(-3,6)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC3 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[3]*100,1),"%)",sep=""))+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc3_niche_plot.png", width=3, height=3, res=300, units = "in")
pc1_pc3_niche_plot
dev.off()
 
figpca_legend <- get_legend( ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  xlim(-10,8)+
  ylim(-3,6)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8)) )
```

Put it all together with a map of the provenances

```{r}

###put pien distribution on map
pien_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")
pigl_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/White spruce (Picea glauca) extent, North America/data/commondata/data0/piceglau.shp")
pipu_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Blue spruce (Picea pungens) extent, North America/data/commondata/data0/picepung.shp")
pien_little_map_prj <- project(pien_little_map, crs(westernus))
pien_little_map_prj_crop <- crop(pien_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pigl_little_map_prj <- project(pigl_little_map, crs(westernus))
pigl_little_map_prj_crop <- crop(pigl_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pipu_little_map_prj <- project(pipu_little_map, crs(westernus))
pipu_little_map_prj_crop <- crop(pipu_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )

canada_crop <- crop(canada, ext(-126.92, -97.23, 41.6769, 52))

map <- ggplot()+
  geom_spatvector(data=westernus, col="grey", fill="gray100")+
  geom_spatvector(data=canada_crop, col="grey", fill="gray100")+
  geom_spatvector(data=pien_little_map_prj_crop, fill="wheat", col="wheat")+
  geom_spatvector(data=pigl_little_map_prj_crop, fill="thistle", col="thistle", alpha=0.6)+
  geom_spatvector(data=pipu_little_map_prj_crop, fill="paleturquoise", col="paleturquoise",alpha=.6)+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(!Provenance == "Plantation"), aes(fill=factor(Provenance, levels=provs_bylat$Provenance)), shape=24, size=1.5)+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(Provenance == "Plantation"), color="black", size=1.5)+
  geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(!Provenance == "Plantation"), aes(label=code), hjust=c(1.2,-.2,-.2,1.1,-.2,-.2,1,.1,0,1.2,-0.2,1.0, 1.1,1.0,0,1,-0.2,1.2,1,1.2), vjust=c(.4,0,0,0,0,0,1.3,1.4,1.3,rep(0,5),1.3,0,-.2,0,0,0), size=2.5)+
    geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(Provenance == "Plantation"), aes(label="Plantation"), hjust = 1, vjust=-0.4, col="black", size=2.5)+
  theme(panel.grid = element_blank(), legend.position = "none", axis.title=element_blank(), axis.text = element_text(color="black", size=8))+
  # ggspatial::annotation_scale(
  #   location = "bl",
  #   bar_cols = c("black", "white"),
  #     height = unit(0.1, "cm"),
  #   text_cex = 0.5) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style=north_arrow_fancy_orienteering(text_size=8, line_width = 0.8),
    height=unit(.25, "in"),
    width=unit(.25, "in"))

# png("figures/map.png", width=3, height=3, res=300, units = "in")
 map
# dev.off()

png("figures/map_and_bigpca_bluewhite.png", width=8.2, height=6.5, res=300, units = "in")
ggarrange(map,ggarrange(pc1_pc2_niche_plot, contrib.plot, nrow=2, ncol=1, labels=c("B)","C)")), labels=c("A)",""), ncol=2, nrow=1)
dev.off()
```


#Response variables

##DBH

```{r}
##DBH data is in centimeters
moniger_data <- read.csv("past_moniger_data.csv")
moniger_data_ids <- read.csv("past_moniger_data_ids.csv")

moniger_data_comb <- moniger_data %>% 
  left_join(moniger_data_ids, by=c("LOC" = "ID.Code")) %>% 
  mutate(Provenance = ifelse(Location == "Larimer County 1","Larimer 1",
                                    ifelse(Location == "Larimer County 2","Larimer 2",Location))) %>% 
  left_join(prov_pcapts_big)

dbh <- moniger_data_comb %>% 
  dplyr::select(c(SORT, LOC, BLK, REP, DBH91, DBH96, DBH06, DBH14, Provenance, code)) %>% 
  mutate(Series = paste(LOC,BLK,REP,sep="")) 

dbh_long<- dbh %>% 
  filter(!is.na(DBH91)) %>% 
  pivot_longer(DBH91:DBH14, names_to = 'year', values_to = 'DBH')

dbh_clim_data <- dbh_long %>% 
  left_join(prov_pcapts_big) %>% 
  filter(!is.na(DBH)) %>% 
  filter(!DBH==0) ##there is one with a dbh value of 0 which seems like an error.

#arranging provenances by different variables to visually identify patterns in DBH
dbh_by_lat_plot<- ggplot(dbh_long, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by Latitude")

dbh_by_nffd_plot <-ggplot(dbh_clim_data, aes(x=factor(round(NFFD,2)), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by NFFD")

dbh_by_cmd_plot <-ggplot(dbh_clim_data, aes(x=factor(round(CMD,0)), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by CMD")

```


###absolute DBH

####ANOVA

```{r}
dbh_numeric <- dbh_clim_data %>% 
  mutate(num.yr = as.numeric(ifelse(year=="DBH91", 1,
                         ifelse(year=="DBH96", 6,
                                ifelse(year=="DBH06", 16,
                                       ifelse(year=="DBH14", 24, year))))))

dbh_aov <- lmer(DBH ~ year*Provenance + (1|BLK), data = dbh_numeric)
plot(dbh_aov)
qqmath(dbh_aov)
summary(dbh_aov)
anova(dbh_aov) #no significant interaction
rand(dbh_aov)
dbh_aov_noint <- lmer(DBH ~ year + Provenance + (1|BLK), data = dbh_numeric)
Anova(dbh_aov_noint, type="2") #both year and provenance are significant but do not interact (relatively similar order of provenance DBH in each year measured)
summary(dbh_aov_noint)
rand(dbh_aov_noint)

###model each year separately
dbh_aov91 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH91"))

plot(dbh_aov91)
anova(dbh_aov91)
rand(dbh_aov91)

dbh_aov91_marg = lsmeans(dbh_aov91, ~ Provenance)

CLD_dbh_aov91 = cld(dbh_aov91_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov91 #payette greater than 12, gila less than 10

dbh_aov96 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH96"))
plot(dbh_aov96)
anova(dbh_aov96)
dbh_aov96_marg = lsmeans(dbh_aov96, ~ Provenance)

CLD_dbh_aov96 = cld(dbh_aov96_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov96 #payette greater than 12, gila less than 10, cache less than 13

  
dbh_aov06 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH06"))
plot(dbh_aov06)
anova(dbh_aov06)
dbh_aov06_marg = lsmeans(dbh_aov06, ~ Provenance)

CLD_dbh_aov06 = cld(dbh_aov06_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov06 #payette greater than 13, gila less than 13

dbh_numeric14 <- dbh_numeric %>% filter(year=="DBH14") %>% 
  mutate(Provenance=as.factor(Provenance))

dbh_aov14 <- lmer(DBH ~ Provenance + (1|BLK), data =dbh_numeric14)
plot(dbh_aov14)
anova(dbh_aov14)
dbh_aov14_marg = lsmeans(dbh_aov14, ~ Provenance)

CLD_dbh_aov14 = cld(dbh_aov14_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov14 #payette greater than 15, gila less than 13

dbh14_letter_df<- as.data.frame(CLD_dbh_aov14) %>% 
  rename(letters = `.group`) %>% 
  mutate(year="DBH14")


prov_dbh_order<- dbh_numeric %>% 
  filter(year=="DBH14") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)

dbh_early<- ggplot(dbh_numeric %>% filter(!year=="DBH14"), aes(x=factor(year, levels=c("DBH91","DBH96","DBH06"), labels=c(1991,1996,2006)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_x_discrete(name="Year")

dbh_2014<-ggplot(dbh_numeric14, aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance), group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot(position=position_dodge(width=1))+
  geom_text(data=dbh14_letter_df, aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y= 35, label=letters, group=factor(Provenance, levels=provs_bylat$Provenance)), position=position_dodge(width=1), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("DBH (cm)")+
    scale_x_discrete(name="Year")+
  theme_bw()

ggarrange(dbh_early,dbh_2014, nrow=2, common.legend = TRUE)

dbh_aves <- dbh_numeric %>% 
  group_by(Provenance,year) %>% 
  summarise(meanDBH=mean(DBH),se_DBH=sd(DBH)/sqrt(n())) %>% 
  mutate(year= case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996)) %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,1985), meanDBH=NA, se_DBH=NA))

dbh_means_fig <- ggplot(dbh_aves, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meanDBH, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meanDBH-se_DBH, ymax=meanDBH+se_DBH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean DBH (cm)")

dbh_means_fig
```

####PC-geo models

```{r}
###using year as a random effect
#y
mod_dbh_pca_y_randtime <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
plot(mod_dbh_pca_y_randtime)
qqmath(mod_dbh_pca_y_randtime)
summary(mod_dbh_pca_y_randtime)
mod_dbh_pca_y_randtime_dredge<- dredge(mod_dbh_pca_y_randtime)
mod_dbh_pca_y_randtime_dredge

bestmod_dbh_pca_y_randtime <- lmer(DBH ~ scale(y) + PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
summary(bestmod_dbh_pca_y_randtime)
r2(bestmod_dbh_pca_y_randtime)

#no gila

mod_dbh_pca_y_randtime_noG <- lmer(DBH ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_y_randtime_noG)
qqmath(mod_dbh_pca_y_randtime_noG)
summary(mod_dbh_pca_y_randtime_noG)
mod_dbh_pca_y_randtime_noG_dredge<- dredge(mod_dbh_pca_y_randtime_noG)
mod_dbh_pca_y_randtime_noG_dredge

bestmod_dbh_pca_y_randtime_noG <- lmer(DBH ~ I(scale(y)^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_y_randtime_noG)
r2(bestmod_dbh_pca_y_randtime_noG)


#x
mod_dbh_pca_x_randtime <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
plot(mod_dbh_pca_x_randtime)
qqmath(mod_dbh_pca_x_randtime)
summary(mod_dbh_pca_x_randtime)
mod_dbh_pca_x_randtime_dredge<- dredge(mod_dbh_pca_x_randtime)
mod_dbh_pca_x_randtime_dredge

bestmod_dbh_pca_x_randtime <- lmer(DBH ~ scale(x) + PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
summary(bestmod_dbh_pca_x_randtime)
r2(bestmod_dbh_pca_x_randtime)

#no gila
mod_dbh_pca_x_randtime_noG <- lmer(DBH ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_x_randtime_noG)
qqmath(mod_dbh_pca_x_randtime_noG)
summary(mod_dbh_pca_x_randtime_noG)
mod_dbh_pca_x_randtime_noG_dredge<- dredge(mod_dbh_pca_x_randtime_noG)
mod_dbh_pca_x_randtime_noG_dredge

bestmod_dbh_pca_x_randtime_noG <- lmer(DBH ~ scale(x) + PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_x_randtime_noG)
r2(bestmod_dbh_pca_x_randtime_noG)

AICc(mod_dbh_pca_x_randtime, mod_dbh_pca_y_randtime) #with Gila long is better, best long model has fixed effects of long and PC2
AICc(bestmod_dbh_pca_x_randtime, bestmod_dbh_pca_y_randtime) ##long is better

AICc(mod_dbh_pca_x_randtime_noG, mod_dbh_pca_y_randtime_noG) ##without Gila, lat is better, best lat model has fixed quadratic effect of lat
AICc(bestmod_dbh_pca_x_randtime_noG, bestmod_dbh_pca_y_randtime_noG) 

###FINAL MODEL TO USE#####
summary(bestmod_dbh_pca_y_randtime_noG)
r2(bestmod_dbh_pca_y_randtime_noG)

####make plot for best final model
bestmod_dbh_pca_y_randtime_noG_lm <- lm(DBH ~ I(scale(y)^2), data=dbh_numeric_time_noG)

newdata_dbh_y <-  expand.grid(y=seq(min(dbh_numeric_time_noG$y), max(dbh_numeric_time_noG$y), length.out=50))
dbh_predict_y <- predict(bestmod_dbh_pca_y_randtime_noG_lm, newdata = newdata_dbh_y, interval="confidence")

predictdatadbh_y <- cbind(newdata_dbh_y, dbh_predict_y) %>% mutate(var="Latitude")

dbh_y_plot <- ggplot()+
  geom_ribbon(data=predictdatadbh_y, aes(x=y, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdatadbh_y, aes(x=y,y=fit), color="black")+
  geom_rug(data=dbh_numeric_time_noG %>% mutate(fit=9), aes(x=y,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance Latitude")+
  ylab("DBH (cm)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
dbh_y_plot
```

####PC only models

```{r}
###using year as a random effect
mod_dbh_pca <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
plot(mod_dbh_pca)
qqmath(mod_dbh_pca)
summary(mod_dbh_pca)
mod_dbh_pca_dredge<- dredge(mod_dbh_pca)
mod_dbh_pca_dredge

bestmod_dbh_pca <- lmer(DBH ~ PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
summary(bestmod_dbh_pca)
r2(bestmod_dbh_pca)

#no gila

mod_dbh_pca_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_noG)
qqmath(mod_dbh_pca_noG)
summary(mod_dbh_pca_noG)
mod_dbh_pca_noG_dredge<- dredge(mod_dbh_pca_noG)
mod_dbh_pca_noG_dredge #null is best

bestmod_dbh_pca_noG <- lmer(DBH ~ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
summary(bestmod_dbh_pca_y_randtime_noG)
r2(bestmod_dbh_pca_y_randtime_noG)

```

#####each year separate


```{r}
###2014
dbh_numeric_time_2014 <- dbh_numeric_time %>% filter(year==2014)

mod_dbh_pca_2014 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014)
plot(mod_dbh_pca_2014)
qqmath(mod_dbh_pca_2014)
summary(mod_dbh_pca_2014)
mod_dbh_pca_2014_dredge<- dredge(mod_dbh_pca_2014)
mod_dbh_pca_2014_dredge

bestmod_dbh_pca_2014 <- lmer(DBH ~ PC2 + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014)
summary(bestmod_dbh_pca_2014)
r2(bestmod_dbh_pca_2014)

#2014 - no gila
dbh_numeric_time_2014_nog <- dbh_numeric_time %>% filter(year==2014) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_2014_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014_nog)
plot(mod_dbh_pca_2014_noG)
qqmath(mod_dbh_pca_2014_noG)
summary(mod_dbh_pca_2014_noG)
mod_dbh_pca_2014_noG_dredge<- dredge(mod_dbh_pca_2014_noG)
mod_dbh_pca_2014_noG_dredge #null is best

bestmod_dbh_pca_2014_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014_nog)
summary(bestmod_dbh_pca_2014_noG)
r2(bestmod_dbh_pca_2014_noG)
```

```{r}
###2006
dbh_numeric_time_2006 <- dbh_numeric_time %>% filter(year==2006)

mod_dbh_pca_2006 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006)
plot(mod_dbh_pca_2006)
qqmath(mod_dbh_pca_2006)
summary(mod_dbh_pca_2006)
mod_dbh_pca_2006_dredge<- dredge(mod_dbh_pca_2006)
mod_dbh_pca_2006_dredge

bestmod_dbh_pca_2006 <- lmer(DBH ~ PC2 + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006)
summary(bestmod_dbh_pca_2006)
r2(bestmod_dbh_pca_2006)

#2006 - no gila
dbh_numeric_time_2006_nog <- dbh_numeric_time %>% filter(year==2006) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_2006_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006_nog)
plot(mod_dbh_pca_2006_noG)
qqmath(mod_dbh_pca_2006_noG)
summary(mod_dbh_pca_2006_noG)
mod_dbh_pca_2006_noG_dredge<- dredge(mod_dbh_pca_2006_noG)
mod_dbh_pca_2006_noG_dredge #null is best

bestmod_dbh_pca_2006_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006_nog)
summary(bestmod_dbh_pca_2006_noG)
r2(bestmod_dbh_pca_2006_noG)
```

```{r}
###1996
dbh_numeric_time_1996 <- dbh_numeric_time %>% filter(year==1996)

mod_dbh_pca_1996 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996)
plot(mod_dbh_pca_1996)
qqmath(mod_dbh_pca_1996)
summary(mod_dbh_pca_1996)
mod_dbh_pca_1996_dredge<- dredge(mod_dbh_pca_1996)
mod_dbh_pca_1996_dredge #null is best

bestmod_dbh_pca_1996 <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996)
summary(bestmod_dbh_pca_1996)
r2(bestmod_dbh_pca_1996)

#1996 - no gila
dbh_numeric_time_1996_nog <- dbh_numeric_time %>% filter(year==1996) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_1996_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996_nog)
plot(mod_dbh_pca_1996_noG)
qqmath(mod_dbh_pca_1996_noG)
summary(mod_dbh_pca_1996_noG)
mod_dbh_pca_1996_noG_dredge<- dredge(mod_dbh_pca_1996_noG)
mod_dbh_pca_1996_noG_dredge #null is best

bestmod_dbh_pca_1996_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996_nog)
summary(bestmod_dbh_pca_1996_noG)
r2(bestmod_dbh_pca_1996_noG)
```

```{r}
###1991
dbh_numeric_time_1991 <- dbh_numeric_time %>% filter(year==1991)

mod_dbh_pca_1991 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991)
plot(mod_dbh_pca_1991)
qqmath(mod_dbh_pca_1991)
summary(mod_dbh_pca_1991)
mod_dbh_pca_1991_dredge<- dredge(mod_dbh_pca_1991)
mod_dbh_pca_1991_dredge #null is best

bestmod_dbh_pca_1991 <- lmer(DBH ~ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991)
summary(bestmod_dbh_pca_1991)
r2(bestmod_dbh_pca_1991)

#1991 - no gila
dbh_numeric_time_1991_nog <- dbh_numeric_time %>% filter(year==1991) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_1991_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991_nog)
plot(mod_dbh_pca_1991_noG)
qqmath(mod_dbh_pca_1991_noG)
summary(mod_dbh_pca_1991_noG)
mod_dbh_pca_1991_noG_dredge<- dredge(mod_dbh_pca_1991_noG)
mod_dbh_pca_1991_noG_dredge #null is best

bestmod_dbh_pca_1991_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991_nog)
summary(bestmod_dbh_pca_1991_noG)
r2(bestmod_dbh_pca_1991_noG)
```

###growth each year

```{r}

dbh_growth_data<- dbh %>% 
  mutate(areagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/5, areagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/10, areagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/8) %>% 
  mutate(areagrowth96=case_when(DBH96 == 0 ~ NA,
                         is.na(DBH96) ~ NA,
                         .default=areagrowth96),
         areagrowth06=case_when(DBH06 == 0 ~ NA,
                         is.na(DBH06) ~ NA,
                         .default=areagrowth06),
         areagrowth14=case_when(DBH14 == 0 ~ NA,
                         is.na(DBH14) ~ NA,
                         .default=areagrowth14)) %>% 
  pivot_longer(areagrowth96:areagrowth14) %>% 
  filter(!value<0) ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)

dbh_increment_plot<- ggplot(dbh_growth_data, aes(x=factor(Provenance, provs_bylat$Provenance), y=value, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("areagrowth96","areagrowth06","areagrowth14"), labels=c("1991-96","1996-2006","2006-14")), scales="free")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

ggarrange(dbh_by_lat_plot,dbh_increment_plot, nrow=2, common.legend = TRUE)
```

When you relativize by the basal area in the intial year, the pattern is much different. Smaller trees are growing a higher percentage of their original basal area each year, despite putting on less total basal area. I think the way this is calculated favors small trees too much, because ultimately bigger trees are doing better in terms of growth, even if they are not putting on a higher percentage of their initial basal area. I guess this would imply that they were taller to begin with.   

```{r}
# ##relativize by original BA
dbh_growth_data_rel<- dbh %>%
  mutate(relareagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/(pi*(DBH91/2)^2)*100/5, relareagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/(pi*(DBH96/2)^2)*100/10, relareagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/(pi*(DBH06/2)^2)*100/8) %>%
  mutate(relareagrowth96=case_when(DBH96 == 0 ~ NA,
                         is.na(DBH96) ~ NA,
                         .default=relareagrowth96),
         relareagrowth06=case_when(DBH06 == 0 ~ NA,
                         is.na(DBH06) ~ NA,
                         .default=relareagrowth06),
         relareagrowth14=case_when(DBH14 == 0 ~ NA,
                         is.na(DBH14) ~ NA,
                         .default=relareagrowth14)) %>%
  pivot_longer(relareagrowth96:relareagrowth14) %>%
  filter(!value<0) %>%  ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)
  left_join(prov_pcapts_big)

relba_plot<- ggplot(dbh_growth_data_rel, aes(x=factor(Provenance, provs_bylat$Provenance), y=value, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("relareagrowth96","relareagrowth06","relareagrowth14"), labels=c("1991-96","1996-2006","2006-14")), scales="free")+
  ylab("Relativized Basal Area Growth (%/yr)")+
  xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

relba_plot

ggarrange(dbh_by_lat_plot,dbh_increment_plot,relba_plot, nrow=3, common.legend = TRUE)
```

####ANOVA
```{r}
###analyze basal area growth data
aov_rDBH <- lmer(value ~ name*Provenance + (1|BLK), data=dbh_growth_data)
anova(aov_rDBH) ##basal area growth differs by provenance and year, but not by the interaction of the two. 
```

####PC-geo models
```{r}
dbh_growth_clim<- dbh_growth_data %>% 
  left_join(prov_pcapts_big)

options(na.action="na.fail")
#y - square root transformed
mod_reldbh_pca_y_randtime <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
plot(mod_reldbh_pca_y_randtime)
qqmath(mod_reldbh_pca_y_randtime)
summary(mod_reldbh_pca_y_randtime)
mod_reldbh_pca_y_randtime_dredge<- dredge(mod_reldbh_pca_y_randtime)
mod_reldbh_pca_y_randtime_dredge

bestmod_reldbh_pca_y_randtime <- lmer(sqrt(value) ~  (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim) ##null model is best
summary(bestmod_reldbh_pca_y_randtime)

#no gila
dbh_growth_clim_noG<- dbh_growth_clim %>% filter(!Provenance=="Gila NF")

mod_reldbh_pca_y_randtime_noG <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(y) + PC2*scale(y) + I(PC1^2) + I(PC2^2) + I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
plot(mod_reldbh_pca_y_randtime_noG)
qqmath(mod_reldbh_pca_y_randtime_noG)
summary(mod_reldbh_pca_y_randtime_noG)
mod_reldbh_pca_y_randtime_noG_dredge<- dredge(mod_reldbh_pca_y_randtime_noG)
mod_reldbh_pca_y_randtime_noG_dredge

bestmod_reldbh_pca_y_randtime_noG <- lmer(sqrt(value) ~ scale(y)+ I(scale(y)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
summary(bestmod_reldbh_pca_y_randtime_noG)
r2(bestmod_reldbh_pca_y_randtime_noG)

#x
mod_reldbh_pca_x_randtime <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
plot(mod_reldbh_pca_x_randtime)
qqmath(mod_reldbh_pca_x_randtime)
summary(mod_reldbh_pca_x_randtime)
mod_reldbh_pca_x_randtime_dredge<- dredge(mod_reldbh_pca_x_randtime)
mod_reldbh_pca_x_randtime_dredge ##null is best, but the next best model has delta = 0.14, so I will do that one. 

bestmod_reldbh_pca_x_randtime <- lmer(sqrt(value) ~  PC2 + scale(x) + (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
summary(bestmod_reldbh_pca_x_randtime)
r2(bestmod_reldbh_pca_x_randtime)

#no gila
mod_reldbh_pca_x_randtime_noG <- lmer(sqrt(value) ~ PC1*PC2 + PC1*scale(x) + PC2*scale(x) + I(PC1^2) + I(PC2^2) + I(scale(x)^2)+ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
plot(mod_reldbh_pca_x_randtime_noG)
qqmath(mod_reldbh_pca_x_randtime_noG)
summary(mod_reldbh_pca_x_randtime_noG)
mod_reldbh_pca_x_randtime_noG_dredge<- dredge(mod_reldbh_pca_x_randtime_noG)
mod_reldbh_pca_x_randtime_noG_dredge #null model is best

bestmod_reldbh_pca_x_randtime_noG <- lmer(sqrt(value) ~ (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
summary(bestmod_reldbh_pca_x_randtime_noG) 

AICc(mod_reldbh_pca_x_randtime, mod_reldbh_pca_y_randtime) ##long is better with Gila, best long model had PC2 and long as fixed effects, but null model was just as good. 
AICc(mod_reldbh_pca_x_randtime_noG, mod_reldbh_pca_y_randtime_noG) ##without Gila, lat is better, best lat model has quadratic effect of y as only fixed effect


####make plot for best final model
bestmod_reldbh_pca_y_randtime_noG_lm <- lm(sqrt(value) ~ scale(y) + I(scale(y)^2), data=dbh_growth_clim_noG)

newdata_reldbh_y <-  expand.grid(y=seq(min(dbh_growth_clim_noG$y), max(dbh_growth_clim_noG$y), length.out=50))
reldbh_predict_y <- predict(bestmod_reldbh_pca_y_randtime_noG_lm, newdata = newdata_reldbh_y, interval="confidence")

predictdata_reldbh_y <- cbind(newdata_reldbh_y, reldbh_predict_y) %>% mutate(var="Latitude")

reldbh_y_plot <- ggplot()+
  geom_ribbon(data=predictdata_reldbh_y, aes(x=y, ymin=lwr^2, ymax=upr^2), alpha=0.2)+
  geom_line(data=predictdata_reldbh_y, aes(x=y,y=fit^2), color="black")+
  geom_rug(data=dbh_growth_clim_noG %>% mutate(fit=5), aes(x=y,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Provenance Latitude")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")
reldbh_y_plot
```
