---
title: "Engelmann Spruce Provenance Study"
author: "Katie Nigro"
date: "2025-04-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Set up 

##Packages

```{r}
#load required packages
library(terra)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(dplyr)
library(stringr)
# library(ClimateNAr)
library(ggfortify)
library(RColorBrewer)
library(tidyr)
library(lme4)
library(lmerTest)
library(car)
library(viridis)
library(dplR)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(MuMIn)
library(vegan)
library(cluster)
library(MASS)
library(indicspecies)
library(SPEI)
library(lattice)
library(tibble)
library(pals)
library(aod)
library(interactions)
library(gridExtra)
library(climwin)
library(lubridate)
library(dichromat)
library(prism)
library(multcomp)
library(multcompView)
library(lsmeans)
library(cowplot)
library(glmm)
library(glmmTMB)
library(colorspace)
library(performance)
library("factoextra")
library("corrplot")
library(DescTools)
library(DHARMa)
library(ggeffects)
```

##Plot locations

```{r}
#read in site and provenance locations
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")
west_states<- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","California","Oregon","Washington","Kansas","Oklahoma","Texas")
westernus <- us[match(toupper(west_states),toupper(us$NAME_1)),]

canada <- geodata::gadm(country = "Canada",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")

##use coordinates adjusted based on elevation and google maps
adjusted_coords<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIEN_corrected_coords.csv")

adjusted_provs<- vect(adjusted_coords, geom=c("long_corrected","lat_corrected"), crs=crs(us))

geo.dist.df<- data.frame(Provenance = adjusted_provs$Provenance, geo.dist.to.plant.km = as.matrix(terra::distance(adjusted_provs))[,21]/1000)

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=canada)+
  geom_spatvector(data=adjusted_provs, color="maroon")

#make key for provenance names
prov_names<-adjusted_coords %>% dplyr::select(Provenance, no) %>% 
 separate_wider_delim(Provenance, delim=" ", names=c("first","second","third"), too_few = "align_start", cols_remove=FALSE) %>% 
  separate_wider_delim(first, delim= "-", names=c("first","2"), too_few="align_start") %>% 
    separate_wider_delim(second, delim= "-", names=c("second","3"), too_few="align_start") %>% 
  mutate(across(everything(), ~ replace(.x, is.na(.x), ""))) %>%
  mutate(`3` = ifelse(second=="NF","F",`3`)) %>% 
  mutate(code=paste(substr(first,0,1),substr(`2`,0,1),substr(second,0,1),substr(`3`,0,1),third, sep="")) %>% 
  dplyr::select(c(Provenance,no,code)) %>% 
  mutate(no=as.integer(no)) %>% 
  mutate(code=case_when(Provenance == "Roosevelt NF" ~ "RoNF",
                        Provenance == "Pike NF" ~ "PiNF",
                        Provenance == "Gunnison NF" ~ "GuNF",
                        Provenance == "Coconino NF" ~ "CoNF",
                        Provenance == "Payette NF" ~ "PaNF",
                        Provenance == "Cache NF" ~ "CaNF",
                        Provenance == "Gila NF" ~ "GiNF",
                        TRUE ~ code))

provs_bylat <- as.data.frame(adjusted_provs) %>% 
  bind_cols(crds(adjusted_provs)) %>% 
  left_join(prov_names) %>% 
  arrange(y)
```

#Climate

##ClimateNA

```{r}
#read in climate from climateNA

filenames <- c("AHM","bFFP","CMD","DD_18","DD_0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPT_sm","PPT_sp","PPT_at","PPT_wt","RH","Tave_sm","Tave_wt","TD","SHM")

filenames_edited <- c("AHM","bFFP","CMD","DD18","DD0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","Tavesm","Tavewt","TD","SHM")

clim_raster_stack <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1961_1990_bioclim/Normal_1961_1990/Normal_1961_1990_bioclim/Normal_1961_1990_",filenames,".tif",sep=""))

names(clim_raster_stack)<- filenames_edited

prov_clim_adjusted_bi <- terra::extract(clim_raster_stack, adjusted_provs, method='bilinear') %>% cbind(as.data.frame(adjusted_provs)) %>% cbind(crds(adjusted_provs)) %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP)

prov_clim_adjusted_bi_long<- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,AHM:SHM, smrpb, monsoonality)) %>% 
  pivot_longer(AHM:monsoonality) %>% 
  mutate(type="adj bilinear") 

##making provenance climate table for paper
prov_clim_table<- prov_clim_adjusted_bi %>% 
  left_join(prov_names %>% dplyr::select(Provenance, code)) %>% 
  dplyr::select(Provenance, y, x, elev, MAT, MAP, NFFD,PAS) %>% 
  arrange(desc(y))

#write.csv(prov_clim_table,"prov_clim_table.csv")  
```

###Rehfeldt comparison

```{r}
##compare White River to Rehfeldt 2004 planting sites
idacreek<- c(48.364002, -116.822747)
canyoncreek<- c(48.370716, -116.799922)
high <- c(48.353759, -116.760290)
highest <- c(48.344491, -116.714165)
preistriver<- data.frame(rbind(idacreek, canyoncreek, high,highest))
colnames(preistriver)<- c("y","x")

preistriver_vect <- vect(preistriver, geom=c("x","y"), crs=crs(us))

preistriver_clim <- terra::extract(clim_raster_stack, preistriver_vect, method="simple", df=TRUE)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MAT, y=MAP), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MAT, y=MAP), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=NFFD, y=SHM), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=NFFD, y=SHM), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MCMT, y=RH), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MCMT, y=RH), col="black", size=3)
```

```{r}
#monthly normals

months = c("01","02","03","04","05","06","07","08","09","10","11","12")

monthly_ppt<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/ppt/PPT",months[i],".tif",sep=""))
ppt <- terra::extract(raster, adjusted_provs)
monthly_ppt <- left_join(monthly_ppt, ppt)}


monthly_tave<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/tave/Tave",months[i],".tif",sep=""))
tave <- terra::extract(raster, adjusted_provs)
monthly_tave <- left_join(monthly_tave, tave)}

monthly_clim <- monthly_ppt %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(PPT01:PPT12) %>% 
  bind_rows(monthly_tave %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(Tave01:Tave12)) %>% 
  mutate(month=substr(name,nchar(name)-1,nchar(name)),
         var = substr(name,0,nchar(name)-2))

monthly_clim_wide <- monthly_clim %>% 
  dplyr::select(c(Provenance, no, elev, value, month, var)) %>% 
  pivot_wider(values_from=value, names_from=var)

#png("figures/prov_temp_precip.png", width=8,height=8, res=300, units="in")
ggplot()+
  geom_bar(data=monthly_clim_wide, aes(x=as.numeric(month), y=PPT), stat="identity", fill="grey")+
  geom_line(data=monthly_clim_wide, aes(x=as.numeric(month), y=Tave*10), col="black", lwd=1)+
  scale_y_continuous(
    "PPT (mm)", 
    sec.axis = sec_axis(~ . / 10, name = "Temp (C)"), limits=c(-150,350))+
  scale_x_continuous(breaks=seq(1,12,1), labels=seq(1,12,1), name="Month")+
  facet_wrap(~factor(Provenance))+
  theme_bw()+
  theme(panel.grid.minor=element_blank())
#dev.off()

ggplot(monthly_clim %>% filter(var=="Tave") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="Tave") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="red",size=2)+
    facet_wrap(~factor(Provenance))

ggplot(monthly_clim %>% filter(var=="PPT") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="PPT") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="green",size=3)+
    facet_wrap(~factor(Provenance))
```


```{r}
#compare climates of provenances
prov_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(Provenance,AHM:SHM,x:monsoonality)) %>% 
  left_join(prov_names) %>% 
  pivot_longer(AHM:monsoonality, names_to = "var", values_to = "value")

order<- prov_clim_adjusted_bi %>% 
  arrange(y) %>% 
  pull(Provenance)

# png("figures/prov_clim_plot.png", width=12, height=8, units="in", res=500)
ggplot(prov_vars, aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
# dev.off()

ggplot(prov_vars %>% filter(!Provenance=="Gila NF") %>% filter(var=="smrpb"), aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation")%>% filter(var=="smrpb"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())+
  theme_bw()+
  theme(legend.position="none", axis.text.x = element_text(angle=45, hjust=1, color="black", size=12))+
  xlab("Provenance")+
  ylab("Summer to Spring Precip Ratio")
```


###future climate

```{r}
##get future projections from ClimateNA

#2000's normal
clim2000s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1991_2020_bioclim/Normal_1991_2020_bioclim/Normal_1991_2020_",filenames,".tif",sep=""))

names(clim2000s) <- paste(filenames_edited,"_ssp585_2000s", sep="") 

##2020's projections
clim2020s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040_",filenames,".tif",sep=""))

names(clim2020s) <- paste(filenames_edited,"_ssp585_2020s", sep="")  

##2050's projections
clim2050s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070_",filenames,".tif",sep=""))

names(clim2050s) <- paste(filenames_edited,"_ssp585_2050s", sep="") 

##2080's projections
clim2080s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100_",filenames,".tif",sep=""))

names(clim2080s) <- paste(filenames_edited,"_ssp585_2080s", sep="")  

future_clim_raster_stack <- c(clim2020s,clim2050s,clim2080s)

prov_futures<- terra::extract(future_clim_raster_stack, adjusted_provs, weights=T)

prov_futures_long<- prov_futures %>%
  left_join(data.frame(ID=seq(1,21,1), Provenance =adjusted_provs$Provenance)) %>% 
  mutate(smrpb_ssp585_2020s = PPTsm_ssp585_2020s/PPTsp_ssp585_2020s, monsoonality_ssp585_2020s = MSP_ssp585_2020s/MAP_ssp585_2020s, smrpb_ssp585_2050s = PPTsm_ssp585_2050s/PPTsp_ssp585_2050s, monsoonality_ssp585_2050s = MSP_ssp585_2050s/MAP_ssp585_2050s, smrpb_ssp585_2080s = PPTsm_ssp585_2080s/PPTsp_ssp585_2080s, monsoonality_ssp585_2080s = MSP_ssp585_2080s/MAP_ssp585_2080s) %>% 
  dplyr::select(ID,Provenance,everything()) %>% 
  pivot_longer(cols=AHM_ssp585_2020s:monsoonality_ssp585_2080s) %>% 
  separate(name, into=c("climvar","carbon","period"), remove=TRUE) 
```

##PRISM

```{r}
#read in files
ppt_comb_plantation<- read.csv("ppt_comb_plantation.csv") 
tmax_comb_plantation<- read.csv("tmax_comb_plantation.csv")
tmin_comb_plantation<- read.csv("tmin_comb_plantation.csv")
tmean_comb_plantation<- read.csv("tmean_comb_plantation.csv")
vpdmax_comb_plantation<- read.csv("vpdmax_comb_plantation.csv")
vpdmin_comb_plantation<- read.csv("vpdmin_comb_plantation.csv")

ppt_comb_all<- read.csv("ppt_comb_all.csv")
tmax_comb_all<- read.csv("tmax_comb_all.csv")
tmin_comb_all<- read.csv("tmin_comb_all.csv")
tmean_comb_all<- read.csv("tmean_comb_all.csv")
vpdmax_comb_all<- read.csv("vpdmax_comb_all.csv")
vpdmin_comb_all<- read.csv("vpdmin_comb_all.csv")

##add in 1969 to plantation data
 months<- c("01","02","03","04","05","06","07","08","09","10","11","12")
# 
# # set location of climate data
climdir <- "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/PRISM"
# 
ppt_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_ppt_stable_4kmM3_198101_202305_bil/PRISM_ppt_stable_4kmM2_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  ppt<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  ppt_CN<-cbind(CN,ppt,year,month)
  ppt_data_1969<-rbind(ppt_data_1969,ppt_CN)}

tmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmin_stable_4kmM3_198101_202305_bil/PRISM_tmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmin_CN<-cbind(CN,tmin,year,month)
  tmin_data_1969<-rbind(tmin_data_1969,tmin_CN)}

tmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmax_stable_4kmM3_198101_202305_bil/PRISM_tmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmax_CN<-cbind(CN,tmax,year,month)
  tmax_data_1969<-rbind(tmax_data_1969,tmax_CN)}

tmean_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmean_stable_4kmM3_198101_202305_bil/PRISM_tmean_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmean<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmean_CN<-cbind(CN,tmean,year,month)
  tmean_data_1969<-rbind(tmean_data_1969,tmean_CN)}

vpdmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmax_stable_4kmM3_198101_202305_bil/PRISM_vpdmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmax_CN<-cbind(CN,vpdmax,year,month)
  vpdmax_data_1969<-rbind(vpdmax_data_1969,vpdmax_CN)}

vpdmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmin_stable_4kmM3_198101_202305_bil/PRISM_vpdmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmin_CN<-cbind(CN,vpdmin,year,month)
  vpdmin_data_1969<-rbind(vpdmin_data_1969,vpdmin_CN)}

##append 1969
ppt_comb_plantation <- bind_rows(as.data.frame(ppt_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), ppt=as.numeric(ppt), year=as.integer(year), month=as.integer(month)), ppt_comb_plantation %>% dplyr::select(-c(X.1, X))) 

tmax_comb_plantation <- bind_rows(as.data.frame(tmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmax=as.numeric(tmax), year=as.integer(year), month=as.integer(month)), tmax_comb_plantation %>% dplyr::select(-X))

tmean_comb_plantation <- bind_rows(as.data.frame(tmean_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmean=as.numeric(tmean), year=as.integer(year), month=as.integer(month)), tmean_comb_plantation %>% dplyr::select(-X)) 

tmin_comb_plantation <- bind_rows(as.data.frame(tmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmin=as.numeric(tmin), year=as.integer(year), month=as.integer(month)), tmin_comb_plantation%>% dplyr::select(-X)) 

vpdmax_comb_plantation <- bind_rows(as.data.frame(vpdmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmax=as.numeric(vpdmax), year=as.integer(year), month=as.integer(month)), vpdmax_comb_plantation%>% dplyr::select(-X)) 

vpdmin_comb_plantation <- bind_rows(as.data.frame(vpdmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmin=as.numeric(vpdmin), year=as.integer(year), month=as.integer(month)), vpdmin_comb_plantation%>% dplyr::select(-X))

```

###Plantation summary

```{r}
###site climate summary
ppt_plantation_yearly <- ppt_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(ppt_sum = sum(ppt))

mean(ppt_plantation_yearly$ppt_sum)
sd(ppt_plantation_yearly$ppt_sum)

tmin_plantation_dailyave <- tmin_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(tmin_ave=mean(tmin))
mean(tmin_plantation_dailyave$tmin_ave)

##plotting site climate over time
tmean_sum<- tmean_comb_plantation %>% 
  filter(year>1969) %>% 
  mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(decade) %>% 
  summarise(MAT = mean(tmean), se_MAT=sd(tmean)/sqrt(n()))

ppt_sum <- ppt_comb_plantation %>% 
  filter(year > 1969) %>% 
    mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(year,decade) %>% 
  summarise(MAP=sum(ppt)) %>% 
  group_by(decade) %>% 
  summarise(MAP_ave = mean(MAP), se_MAP=sd(MAP)/sqrt(n()))

plantation_2dclim <- left_join(tmean_sum, ppt_sum)

ggplot(plantation_2dclim, aes(x=MAT, y=MAP_ave, col=decade))+
         geom_point()

tmean_mod <- lm(tmean ~ year, data=tmean_comb_plantation %>% group_by(year) %>% summarise(tmean=mean(tmean)))
par(mfrow=c(2,2))
plot(tmean_mod)
summary(tmean_mod)

0.015728*45

tmin_mod <- lm(tmin ~ year, data=tmin_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmin=mean(tmin)))
par(mfrow=c(2,2))
plot(tmin_mod)
summary(tmin_mod)

tmax_mod <- lm(tmax ~ year, data=tmax_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmax=mean(tmax)))
par(mfrow=c(2,2))
plot(tmax_mod)
summary(tmax_mod)

ppt_mod <- lm(ppt ~ year, data=ppt_comb_plantation %>%  filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(ppt=sum(ppt)))
par(mfrow=c(2,2))
plot(ppt_mod)
summary(ppt_mod)

0.021181*46
```

###seasonal

```{r}
##calculate seasonal PRISM values

##ppt
ppt_summed <- as.data.frame(ppt_comb_plantation) %>% 
  mutate(ppt = as.numeric(ppt), year=as.integer(year)) %>%
  filter(!is.na(ppt)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(ppt = sum(ppt)) 

ggplot(ppt_summed %>% filter(CN=="Plantation"), aes(x=year, y=ppt)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(ppt_summed %>% filter(CN=="Plantation") %>% pull(ppt)), col="red")

##seasonal ppt
 
prior_ppt_sm <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_ppt_sm = sum(ppt)) %>% 
  filter(year>1969)
  
prior_ppt_fa <- ppt_comb_plantation %>% 
  filter(month %in% c(9,10,11)) %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_ppt_fa = sum(ppt)) %>% 
  filter(year>1969)
  
prior_ppt_wt <- ppt_comb_plantation %>% 
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month==12, year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_ppt_wt = sum(ppt)) %>% 
  filter(year>1969)

ppt_sp <- ppt_comb_plantation %>% 
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sp = sum(ppt)) %>% 
  filter(year>1969)
  
ppt_sm <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sm = sum(ppt)) %>% 
  filter(year>1969)

ppt_seasonal_plantation <- left_join(prior_ppt_sm,prior_ppt_fa) %>% 
  left_join(prior_ppt_wt) %>% 
  left_join(ppt_sp) %>% 
  left_join(ppt_sm)
  
##tmin
tmin_summed <- as.data.frame(tmin_comb_plantation) %>% 
  mutate(tmin = as.numeric(tmin), year=as.integer(year)) %>%
  filter(!is.na(tmin)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmin = mean(tmin)) 

ggplot(tmin_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmin)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmin_summed %>% filter(CN=="Plantation") %>% pull(tmin)), col="red")

##tmax
tmax_summed <- as.data.frame(tmax_comb_plantation) %>% 
  mutate(tmax = as.numeric(tmax), year=as.integer(year)) %>%
  filter(!is.na(tmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmax = mean(tmax))

ggplot(tmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmax_summed %>% filter(CN=="Plantation") %>% pull(tmax)), col="red")

##tmean
tmean_summed <- as.data.frame(tmean_comb_plantation) %>% 
  mutate(tmean = as.numeric(tmean), year=as.integer(year)) %>%
  filter(!is.na(tmean)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmean = mean(tmean)) 

ggplot(tmean_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmean)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmean_summed %>% filter(CN=="Plantation") %>% pull(tmean)), col="red")

##seasonal temps
all_temps <- bind_rows(tmean_comb_plantation %>% pivot_longer(tmean), tmin_comb_plantation %>% pivot_longer(tmin), tmax_comb_plantation %>% pivot_longer(tmax))

prior_tmean_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmean") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmean_sm = mean(value))
prior_tmin_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmin") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmin_sm = mean(value))
prior_tmax_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmax") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmax_sm = mean(value))

prior_tmean_fa <- all_temps %>% filter(month %in% c(9,10,11) & name=="tmean") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmean_fa = mean(value))
prior_tmin_fa <- all_temps %>% filter(month %in% c(9,10,11) & name=="tmin") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmin_fa = mean(value))
prior_tmax_fa <- all_temps %>% filter(month %in% c(9,10,11) & name=="tmax") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmax_fa = mean(value))

prior_tmean_wt <- all_temps %>% filter(month %in% c(12,1,2) & name=="tmean") %>% 
  mutate(year = ifelse(year==12,year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmean_wt = mean(value))
prior_tmin_wt <- all_temps %>% filter(month %in% c(12,1,2) & name=="tmin") %>% 
  mutate(year = ifelse(year==12,year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmin_wt = mean(value))
prior_tmax_wt <- all_temps %>% filter(month %in% c(12,1,2) & name=="tmax") %>% 
  mutate(year = ifelse(year==12,year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmax_wt = mean(value))

tmean_sp <- all_temps %>% filter(month %in% c(3,4,5) & name=="tmean") %>% 
  group_by(CN, year) %>% 
  summarise(tmean_sp = mean(value))
tmin_sp <- all_temps %>% filter(month %in% c(3,4,5) & name=="tmin") %>% 
  group_by(CN, year) %>% 
  summarise(tmin_sp = mean(value))
tmax_sp <- all_temps %>% filter(month %in% c(3,4,5) & name=="tmax") %>% 
  group_by(CN, year) %>% 
  summarise(tmax_sp = mean(value))

tmean_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmean") %>% 
  group_by(CN, year) %>% 
  summarise(tmean_sm = mean(value))
tmin_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmin") %>% 
  group_by(CN, year) %>% 
  summarise(tmin_sm = mean(value))
tmax_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmax") %>% 
  group_by(CN, year) %>% 
  summarise(tmax_sm = mean(value))

plantation_seasonal_temps<- plyr::join_all(list(prior_tmean_sm,prior_tmin_sm,prior_tmax_sm,prior_tmean_fa,prior_tmin_fa,prior_tmax_fa,prior_tmean_wt,prior_tmin_wt,prior_tmax_wt,tmean_sp,tmin_sp,tmax_sp,tmean_sm,tmin_sm,tmax_sm), type="left")

##vpdmax

vpdmax_summed <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(!is.na(vpdmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax = mean(vpdmax))

ggplot(vpdmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=vpdmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(vpdmax_summed %>% filter(CN=="Plantation") %>% pull(vpdmax)), col="red")

vpdmax_seasonal <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sm = mean(vpdmax)) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year+1)) %>%
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(prior_vpdmax_fa = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month == "12", year+1, year)) %>% 
  filter(!year %in% c(1969,2024)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(prior_vpdmax_wt = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sp = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year+1)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(prior_vpdmax_sm = mean(vpdmax)))


##look at correlation in annual variables
left_join(tmean_summed,tmax_summed) %>% 
  left_join(tmin_summed) %>% 
  left_join(vpdmax_summed) %>% 
  left_join(ppt_summed) %>% 
  ungroup() %>% 
  dplyr::select(tmean:ppt) %>% 
  cor()

```

##FDSI calculation

High FDSI value = less droughty

```{r}
all_climate <- left_join(ppt_comb_plantation,tmax_comb_plantation) %>% 
  left_join(tmin_comb_plantation) %>% 
  left_join(tmean_comb_plantation) %>% 
  left_join(vpdmax_comb_plantation) %>% 
  left_join(vpdmin_comb_plantation) %>% 
  mutate(vpdmean=(vpdmin+vpdmax)/2)

nrow(all_climate)
nrow(tmin_comb_plantation)

all_climate_long <- all_climate %>% 
  pivot_longer(c("ppt","tmax","tmin","tmean","vpdmax","vpdmin","vpdmean"), names_to="climvar", values_to = "value") %>% 
  mutate(monthvar = paste(climvar,month,sep=""))

climate_minus1<- all_climate_long %>% 
  mutate(year=year+1) %>% 
  mutate(monthvar = paste("yr1",climvar,month,sep=""))

climate_minus2<- all_climate_long %>% 
  mutate(year=year+2) %>% 
  mutate(monthvar = paste("yr2",climvar,month,sep=""))

climate_allyears <- rbind(all_climate_long, climate_minus1, climate_minus2)

### FDSI CALC

### CALCULATIONS TAKEN FROM WILLIAMS ET AL., 2013 
# DOI: 10.1038/NCLIMATE1693
#https://www.nature.com/articles/nclimate1693
FDSI_C <- climate_allyears %>%
 dplyr::select(-c("date","month","climvar")) %>% 
  pivot_wider(id_cols=c("CN","year"), names_from = monthvar, values_from = value)

head(FDSI_C)

FDSI_raw<- FDSI_C %>% 
  group_by(CN, year) %>% 
  summarise(FDSIvpd=(((vpdmean5+vpdmean6+vpdmean7)/3)+(yr1vpdmean8+yr1vpdmean9+yr1vpdmean10)/3)/2, FDSIppt=log(yr1ppt11+yr1ppt12+ppt1+ppt2+ppt3))

meanVPD <- mean(FDSI_raw$FDSIvpd, na.rm=T)
meanppt <- mean(FDSI_raw$FDSIppt, na.rm=T)
SDVPD <- sd(FDSI_raw$FDSIvpd, na.rm=T)
SDppt <- sd(FDSI_raw$FDSIppt, na.rm=T)
FDSI_raw$zscoreppt <- ((FDSI_raw$FDSIppt-meanppt)/SDppt)
FDSI_raw$zscoreVPD <- ((FDSI_raw$FDSIvpd-meanVPD)/SDVPD)

FDSI_raw$FDSI <- (0.44*(FDSI_raw$zscoreppt)-0.56*(FDSI_raw$zscoreVPD))

ggplot(FDSI_raw, aes(x=year, y=FDSI))+
  geom_line()+
  geom_point()
#I think we need to consider the fact that FDSI was really high right before the drought of the early 2000's so that's why trees may not be showing equivalent growth rates after the drought (cause it was still relatively hot and dry)
```

##CWD calculation

```{r}
source("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/grad school/cwd_function_v3.r")
# 
# #get dem
# dem_plantation <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/USGS_13_n40w107_20220216.tif")
# 
# slpasp <- terrain(dem_plantation, v = c("slope","aspect"))
# 
# slpasp_plantation <- terra::extract(slpasp, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# 
# plantation_cwd_data <- all_climate %>% left_join(as.data.frame(adjusted_provs) %>% bind_cols(crds(adjusted_provs)) %>% filter(Provenance=="Plantation"), by=c("CN"="Provenance")) %>%
#   mutate(soilawc=116.5, foldedaspect = abs(180-abs(slpasp_plantation$aspect - 225)), slope=slpasp_plantation$slope)
# 
# write.csv(plantation_cwd_data, "plantation_cwd_data.csv")

plantation_cwd_data<- read.csv("plantation_cwd_data.csv")

plantation_cwd <- cwd_function(site="plantation",slope=plantation_cwd_data$slope, latitude=plantation_cwd_data$y, foldedaspect = plantation_cwd_data$foldedaspect, ppt = plantation_cwd_data$ppt, tmean = plantation_cwd_data$tmean, month = plantation_cwd_data$month, soilawc = plantation_cwd_data$soilawc, year = plantation_cwd_data$year, type="annual")

head(plantation_cwd)


priorsm_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(prior_cwd_sm = sum(cwd)) %>% 
  mutate(year=year+1)%>% 
  filter(year>1970)

priorfa_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)) %>% 
  mutate(year=year+1, prior_cwd_fa=cwd_fa) %>% 
  dplyr::select(-cwd_fa)%>% 
  filter(year>1970)

wt_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(1,2)) %>%
  group_by(site, year) %>% 
  summarise(cwd_wt12 = sum(cwd)) %>% 
  left_join(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(12)) %>% 
  group_by(site, year) %>% 
  summarise(cwd_wtdec = sum(cwd)) %>% 
  mutate(year=year+1)) %>% 
  mutate(prior_cwd_wt = cwd_wt12+cwd_wtdec)%>% 
  dplyr::select(-c(cwd_wt12, cwd_wtdec)) %>% 
  filter(year>1970)

sp_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd))%>% 
  filter(year>1970)

sm_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(cwd_sm = sum(cwd))%>% 
  filter(year>1970)

cwd_seasonal <- left_join(priorsm_cwd,priorfa_cwd) %>% 
  left_join(wt_cwd) %>% 
  left_join(sp_cwd) %>% 
  left_join(sm_cwd)

##spring drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd)), aes(x=year, y=cwd_sp))+
  geom_point()+
  geom_line()

##fall drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)), aes(x=year, y=cwd_fa))+
  geom_point()+
  geom_line()

#summer drought
ggplot(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% filter(month%in%c(6,7,8)), aes(x=date, y=cwd))+
  geom_point(aes(col=factor(year)))+
  geom_line()

#number of times each month throughout the time series had CWD>0. July and August are most common times when CWD > 0, and it averages ~10mm
plantation_cwd %>% 
  filter(cwd>0) %>% 
  group_by(month) %>% 
  summarise(n=n(), mean=mean(cwd))

##summarise monthly climate on an annual basis
plantation_cwd_annual <- plantation_cwd %>% 
  group_by(site,year, soilawc) %>% 
  summarise(ppt_sum = sum(ppt), tmean_ave=mean(tmean), aet_sum=sum(aet), cwd_sum=sum(cwd))

plantation_cwd_annual_long<- plantation_cwd_annual %>% 
  left_join(FDSI_raw %>% dplyr::select(year,FDSI), by="year") %>% 
  dplyr::select(-CN) %>% 
  pivot_longer(ppt_sum:FDSI)

ggplot(plantation_cwd_annual_long %>% filter(name%in%c("cwd_sum","FDSI")), aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales = "free")
  
```

##AET

```{r}
priorsm_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(prior_aet_sm = sum(aet)) %>% 
  mutate(year=year+1)%>% 
  filter(year>1970)

priorfa_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(aet_fa = sum(aet)) %>% 
  mutate(year=year+1, prior_aet_fa=aet_fa) %>% 
  dplyr::select(-aet_fa)%>% 
  filter(year>1970)

wt_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(1,2)) %>%
  group_by(site, year) %>% 
  summarise(aet_wt12 = sum(aet)) %>% 
  left_join(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(12)) %>% 
  group_by(site, year) %>% 
  summarise(aet_wtdec = sum(aet)) %>% 
  mutate(year=year+1)) %>% 
  mutate(prior_aet_wt = aet_wt12+aet_wtdec)%>% 
  dplyr::select(-c(aet_wt12, aet_wtdec)) %>% 
  filter(year>1970)

sp_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(aet_sp = sum(aet))%>% 
  filter(year>1970)

sm_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(aet_sm = sum(aet))%>% 
  filter(year>1970)

aet_seasonal <- left_join(priorsm_aet,priorfa_aet) %>% 
  left_join(wt_aet) %>% 
  left_join(sp_aet) %>% 
  left_join(sm_aet)

```

##RAWS
This data is from Dowd Junction weather station, located at 39.626944, -106.451667 - just down the mountain from the White River Plantation site. 

```{r}
DJ <- read.csv("DowdJunction_monthlydata.csv")

DJ[ DJ == "-9999"] <- NA

DJ_seasonal<- DJ %>% 
  separate(date, into=c("month","day","year"), sep="/", remove=TRUE) %>% 
  mutate(month=as.numeric(month), day=as.numeric(day), year=as.numeric(year)) %>% 
  mutate(season = case_when(month %in% c(12,1,2) ~ "winter",
                            month %in% c(3,4,5) ~ "spring",
                            month %in% c(6,7,8) ~ "summer",
                            month %in% c(9,10,11) ~ "fall"),
         seasonyear = ifelse(month==12, year+1, year)) %>% 
  filter(seasonyear>1985) %>% 
  group_by(seasonyear, season) %>% 
  summarise(ave_mean_air_temp_C = mean(mean_air_temp_C, na.rm=TRUE),
            ave_daily_max_temp_C = mean(mean_daily_max_temp_C, na.rm=TRUE),
            ave_daily_min_temp_C = mean(mean_daily_min_temp_C, na.rm=TRUE),
            ave_mean_RH = mean(mean_RH, na.rm=TRUE),
            total_season_precip_mm = sum(total_precip_mm, na.rm=TRUE))

##looks pretty similar
ggplot()+
  geom_point(data=DJ_seasonal %>% filter(season=="summer" & seasonyear>1986), aes(x=seasonyear, y=ave_mean_air_temp_C), color="orange")+
  geom_line(data=DJ_seasonal %>% filter(season=="summer" & seasonyear>1986), aes(x=seasonyear, y=ave_mean_air_temp_C), color="orange")+
  geom_point(data=plantation_seasonal_temps %>% dplyr::select(year,tmean_sm), aes(x=year, y=tmean_sm), color="red")+
  geom_line(data=plantation_seasonal_temps %>% dplyr::select(year,tmean_sm), aes(x=year, y=tmean_sm), color="red")
```

##All climate vars

```{r}
#combine all climate vars

plantation_clim <- ppt_seasonal_plantation %>% 
  left_join(plantation_seasonal_temps) %>% 
  left_join(vpdmax_seasonal) %>% 
  left_join(cwd_seasonal) %>% 
  left_join(aet_seasonal) 

colnames(plantation_clim)

plantation_clim_long <- plantation_clim %>% 
  dplyr::select(-site) %>% 
  pivot_longer(prior_ppt_sm:aet_sm) %>% 
  separate(name, into=c("name1","name2","name3"), sep="_",remove=FALSE, fill="left") %>% 
  mutate(statistic = case_when(name2 %in% c("tmax","vpdmax") ~ "max",
                               name2=="tmin"~ "min",
                               name2=="tmean" ~ "mean",
                               name2%in%c("ppt","aet","cwd") ~ "sum",
                               TRUE ~ NA),
         type = case_when(name2=="tmax" ~ "TEMP (C)",
                               name2=="tmin"~ "TEMP (C)",
                               name2=="tmean" ~ "TEMP (C)",
                               name2=="ppt" ~ "PPT (mm)",
                               name2=="vpdmax"~"VPD",
                               name2=="aet"~"AET",
                               name2=="cwd"~"CWD",
                               TRUE ~ NA))

plantation_clim_long_currentyr<- plantation_clim_long %>%
  mutate(time_season=paste(name1, name3, sep="_")) %>% 
  dplyr::filter(! time_season == "prior_sm") %>% 
  mutate(currentyr = case_when(time_season=="prior_fa" ~ year-1,
                               TRUE ~ year)) %>% 
  filter(currentyr>1969) %>% 
  filter(currentyr<2016)

ggplot(plantation_clim_long_currentyr %>% filter(name2 %in% c("ppt","tmin","tmean","tmax")), aes(x=currentyr, y=value, col=type))+
  scale_color_manual(values=c("skyblue4","firebrick"))+
  ggnewscale::new_scale_color()+
    geom_line(aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  geom_smooth(method="lm", aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  scale_color_manual(values = c("skyblue4","#6B1717","firebrick","#E79191"), name="Statistic")+
  facet_wrap(type~factor(name3, levels=c("sp","sm","fa","wt"), labels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=2)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))+
  xlab("year")


ggplot(plantation_clim_long_currentyr, aes(x=currentyr, y=value, col=name2))+
  ggnewscale::new_scale_color()+
  geom_line(aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  geom_smooth(method="lm", aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  facet_wrap(type~factor(name3, levels=c("sp","sm","fa","wt"), labels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=5)+
  geom_vline(xintercept=2002, linewidth=1)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))

###models

##spring ppt

spppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="ppt_sp"))
plot(spppt_mod)
summary(spppt_mod) #NS

##summer ppt

smppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="ppt_sm"))
plot(smppt_mod)
summary(smppt_mod) #NS

##fall ppt

atppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_ppt_fa"))
plot(atppt_mod)
summary(atppt_mod) #NS

##winter ppt

wtppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_ppt_wt"))
plot(wtppt_mod)
summary(wtppt_mod) #NS

##spring temp

sptmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmean_sp"))
plot(sptmean_mod)
summary(sptmean_mod) #NS

sptmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmin_sp"))
plot(sptmin_mod)
summary(sptmin_mod) #significant, NS for 1970-2015

sptmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmax_sp"))
plot(sptmax_mod)
summary(sptmax_mod) #NS

##summer temp

smtmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmean_sm"))
plot(smtmean_mod)
summary(smtmean_mod) #Significant

smtmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmin_sm"))
plot(smtmin_mod)
summary(smtmin_mod) #significant

smtmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmax_sm"))
plot(smtmax_mod)
summary(smtmax_mod) #NS

##fall temp

attmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmean_fa"))
plot(attmean_mod)
summary(attmean_mod) #Significant

fatmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmin_fa"))
plot(fatmin_mod)
summary(fatmin_mod) #significant

fatmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmax_fa"))
plot(fatmax_mod)
summary(fatmax_mod) #significant, NS for 1970-2015

##winter temp

wttmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmean_wt"))
plot(wttmean_mod)
summary(wttmean_mod) #NS

wttmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmin_wt"))
plot(wttmin_mod)
summary(wttmin_mod) #significant, NS for 1970-2015

wttmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmax_wt"))
plot(wttmax_mod)
summary(wttmax_mod) #NS
```

```{r}
##look at trends in climate over time at the plantation just for 1970-2015

plantation_clim_all_studyperiod<- plantation_clim_long_currentyr %>% 
  filter(currentyr < 2016) %>% 
  filter(!currentyr < 1970) %>% 
  filter(!is.na(value)) %>% 
  mutate(name=paste(name2,name3,sep="_"))

ggplot(plantation_clim_all_studyperiod, aes(x=currentyr, y=value, col=name2, group=name2))+
  geom_point()+
  geom_smooth(method="lm",col="black")+
  facet_wrap(type~factor(name3, levels=c("sp","sm","fa","wt"), labels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=5)

plantation_climvars <- unique(plantation_clim_all_studyperiod$name)

plant_clim_mods <- data.frame()
for(i in 1:length(plantation_climvars)){
climvar = plantation_climvars[i]
data= plantation_clim_all_studyperiod %>% filter(name==climvar)
mod <- lm(value ~ currentyr, data=data)
pvalue = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
plant_clim_mods <- bind_rows(plant_clim_mods, data.frame(climvar=climvar, pvalue=pvalue))
}

plant_clim_mods %>% filter(pvalue<0.05)  ###fall and summer tmin and fall aet significantly increased during the study period

```

##Climate extremes

```{r}
plantation_clim_long_qs<- plantation_clim_long_currentyr %>% 
  left_join(plantation_clim_long_currentyr %>% 
              mutate(var_season=paste(name2,name3,sep="_")) %>% 
              filter(!is.na(value)) %>% 
              group_by(name2, name3, var_season) %>% 
              summarise(q2.5 = quantile(value, 0.025), q97.5 = quantile(value, 0.975), out.hi = quantile(value, c(0.75))  + IQR(value)*1.5, out.low = quantile(value, c(0.75)) - IQR(value)*1.5)) %>% 
  mutate(name=paste(name2,name3,sep="_")) %>% 
  filter(currentyr > 1969) %>% 
  filter(currentyr < 2016)

##look at years where each climate variable exceeded the 97.5th (or 2.5th) percentile - these are years of potentially extreme climate 
ggplot(plantation_clim_long_qs, aes(x=currentyr, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_grid(name2~name3, scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.hi), col="black")

###############
## identify drought year
###############
unique(plantation_clim_long_qs$name)

plantation_clim_xtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = case_when(name2 %in% c("ppt","aet") & value < out.low ~ "yes",
                             name2 %in% c("cwd","spei","tmax","tmean","tmin","vpdmax") & value > out.hi ~"yes",
                             TRUE ~ "no")) %>% 
  filter(extreme=="yes")

ggplot(plantation_clim_long_qs %>% 
  mutate(extreme = case_when(name2 %in% c("ppt","aet") & value < out.low ~ "yes",
                             name2 %in% c("cwd","spei","tmax","tmean","tmin","vpdmax") & value > out.hi ~"yes",
                             TRUE ~ "no")), aes(x=currentyr, y=value))+
  geom_vline(xintercept=2002, col="orange")+
  scale_color_manual(values=c("black","red"), name="Dry extreme")+
  geom_line()+
  geom_point(aes(col=extreme))+
  facet_grid(factor(name2, levels=c("aet","cwd","ppt","tmax","tmean","tmin","vpdmax"), labels = c("AET (mm)","CWD (mm)","ppt (mm)","tmax (C)","tmean (C)","tmin (C)","vpdmax (hPa)"))~factor(name3, levels=c("sp","sm","fa","wt")), scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.low), col="gray20")+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.hi), col="gray20")+
  theme_bw()+
  xlab("year")+
  theme(strip.text=element_text(size=12), legend.text=element_text(size=12))


xtreme_d_byyr<- plantation_clim_xtremes %>% 
  group_by(currentyr) %>% 
  summarise(n=n()) %>% 
  as.data.frame()

ggplot(xtreme_d_byyr, aes(x=currentyr, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("gold","brown"))+
  ylab("# of extreme variables")+
  theme_bw()

###########
## identify cold years
#############
plantation_clim_coldxtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name2 %in% c("tmax","tmean","tmin","vpdmax","cwd") & value < out.low, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

xtreme_c_byyr<- plantation_clim_coldxtremes %>% 
  group_by(currentyr) %>% 
  summarise(n=n()) 

ggplot(xtreme_c_byyr, aes(x=currentyr, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("lightblue","navy")) #1984 was really cold

plantation_clim_wetextremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name2 %in% c("ppt","aet","spei") & value > out.hi, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

ggplot(plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name2 %in% c("tmax","tmean","tmin","vpdmax","cwd") & value < out.low, "yes", "no" 
  )), aes(x=currentyr, y=value))+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.low), col="gray20")+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.hi), col="gray20")+
  scale_color_manual(values=c("black","#B097FF"))+
  geom_vline(xintercept = 1984, col="blue")+
  geom_line()+
  geom_point(aes(color=extreme))+
  facet_grid(name2~factor(name3, levels=c("sp","sm","fa","wt")), scales="free")+
  theme_bw()

```

##Frost

```{r}
tmindata_30 <- read.csv("tmindata_30.csv")
tmindata_31 <- read.csv("tmindata_31.csv")

head(tmindata_30)
head(tmindata_31)

tmin_all<- bind_rows(tmindata_30, tmindata_31) %>% 
  mutate(date=mdy(paste(month,day,year,sep="-"))) %>% 
  arrange(date)

frost_days<- tmin_all %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(n=n())

ggplot(frost_days, aes(x=year, y=n))+
  geom_point()+
  geom_smooth(method="lm")
  
fd_mod <- lm(n ~ year, data=frost_days)
par(mfrow=c(2,2))
plot(fd_mod)
summary(fd_mod)

tmin_aves<- tmin_all %>% 
  group_by(month,day) %>% 
  summarise(ave_tmin=mean(tmin), se=sd(tmin)/sqrt(n()), n=n()) %>% 
  mutate(doy = ymd(paste("2000",month,day,sep="-")))

tmin_all_spring <- tmin_all %>% 
  filter(month %in% c(5,6,7)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(last_spring_frost = max(date)) %>% 
  bind_rows(data.frame(year=2009, last_spring_frost=as.Date("2009-05-14"))) %>% 
  mutate(day_of_last_spring_frost = as.numeric(yday(last_spring_frost)))

tmin_all_fall <- tmin_all %>% 
  filter(month %in% c(8,9,10)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(first_fall_frost = min(date)) %>%
  bind_rows(data.frame(year=2015, first_fall_frost=as.Date("2015-10-14"))) %>% 
  mutate(day_of_first_fall_frost = as.numeric(yday(first_fall_frost)))

plantation_frost <- left_join(tmin_all_spring, tmin_all_fall) %>% 
  dplyr::select(year, day_of_first_fall_frost, day_of_last_spring_frost) %>% 
  mutate(CN="Plantation")

vlines<- prov_clim_adjusted_bi %>% 
  dplyr::select(Provenance,bFFP,eFFP) %>% 
    mutate(bFFP_date = as.Date(bFFP, origin = "1999-12-31"),
           eFFP_date = as.Date(eFFP, origin = "1999-12-31")) %>% 
  arrange(bFFP) %>% 
  mutate(num = seq(-3.6,8.4,.6)) 

hlines <- vlines %>% 
  pivot_longer(bFFP_date:eFFP_date)


ggplot(tmin_aves, aes(x=doy, y=ave_tmin))+
  # geom_vline(data=vlines, aes(xintercept=bFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  # geom_vline(data=vlines, aes(xintercept=eFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_line(data=hlines, aes(x=value, y=num, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=3)+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=hlines, aes(x=ymd("2000-08-01"), y=num+.2, label=Provenance))+
  geom_point()+
  geom_errorbar(aes(ymin=ave_tmin-se, ymax=ave_tmin+se ))+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  theme_bw()
```

##PIEN climate niche

```{r}
pien <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/pien_range.tif")

pien2 <- classify(pien, cbind(-Inf, 0, NA), right=TRUE)
pien_trim<- trim(pien2)
par(mfrow=c(1,1))
plot(pien_trim)

engelmann_points_usonly <- spatSample(pien_trim, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
engelmann_clim_us <- terra::extract(clim_raster_stack, engelmann_points_usonly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##get points for Canada distribution from Mathys study and limit to only those within the boundary established by Little.
pien_mathys <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Current and predicted range of Engelmann spruce under climate change in the Pacific Northwest/data/commondata/data0/es_5075/w001001.adf")

pien_little <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")

pien_mathys2 <- classify(pien_mathys, cbind(-Inf, 0, NA), right=TRUE)
pien_mathys_crop_ca <- crop(pien_mathys2 %>% project(crs(canada)), canada %>% filter(NAME_1%in%c("Alberta","British Columbia")) ) %>% crop(pien_little %>% project(crs(canada))) %>%
  trim()

pien_mathys_little_ca_points <- spatSample(pien_mathys_crop_ca, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
pien_mathys_little_ca_points_crop <- crop(pien_mathys_little_ca_points, pien_little %>% project(crs(pien_mathys_little_ca_points)))
pien_mathys_little_ca_clim <- terra::extract(clim_raster_stack, pien_mathys_little_ca_points_crop %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##combine US and Canada climates
clim_pien<- bind_rows(pien_mathys_little_ca_clim,engelmann_clim_us)

ggplot()+
  geom_spatvector(data=engelmann_points_usonly %>% project(crs(canada)),size=0.05)+
  geom_spatvector(data=pien_mathys_little_ca_points_crop %>% project(crs(canada)), size=0.05)+
  geom_spatvector(data = canada, fill=NA, color="red")+
  geom_spatvector(data=westernus, fill=NA, color="red")
```

## PCA

```{r}
#run the PCA

##have to take out smrpb if I want to project into the future...or calculate it from ClimateNA variables

clim_pien_cor<- clim_pien %>% 
  dplyr::select(-ID) %>% 
  filter(!is.na(AHM)) %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP) %>% 
  cor()

ggcorrplot(clim_pien_cor, outline.color="white", type="lower", hc.order=TRUE)

pca2_clim_vars <- c("CMD","MCMT","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","TD","smrpb","monsoonality")

env_vars_pien<- clim_pien %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP) %>% 
    filter(!is.na(AHM)) %>% 
  dplyr::select(all_of(pca2_clim_vars))

env_vars_pien %>% 
  cor()

env_vars_noplant<- prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Plantation") %>% 
  dplyr::select(colnames(env_vars_pien))

big_pca_data <- bind_rows(env_vars_noplant, env_vars_pien)
big_pca_data %>% 
  cor()

set.seed(83)
clim_pca_big <- prcomp(big_pca_data,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals_pcabig<- (clim_pca_big$sdev)^2
eigenvals_pcabig
sum(eigenvals_pcabig) #the sum of the eigenvalues = the number of variables (13)
eigenvals_pcabig/sum(eigenvals_pcabig)#this is the proportion variance explained
summary(clim_pca_big)
par(mfrow=c(1,1))
plot(clim_pca_big,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts_big <- clim_pca_big$x[1:nrow(env_vars_noplant),] %>% 
  cbind(prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation")) %>% 
  left_join(prov_names) 

plantation_only <- prov_clim_adjusted_bi %>% filter(Provenance == "Plantation") %>% 
  mutate(period="1970s")

plantation_future <- prov_futures_long %>% filter(Provenance=="Plantation") %>% 
  pivot_wider(names_from=climvar, values_from=value, id_cols = c(ID,Provenance,carbon,period)) 

plantation_all<- bind_rows(plantation_only, plantation_future)

carbon.colors<- c("black",brewer.pal(6,"RdBu")[c(6,5,2,1)])

plantation_clim_vars <- plantation_all %>% 
  dplyr::select(c(period,colnames(env_vars_pien)))

big_pca_data_sum <- big_pca_data %>% 
  as.data.frame() %>% 
  mutate(id=seq(1:nrow(big_pca_data))) %>% 
  pivot_longer(CMD:monsoonality) %>% 
  group_by(name) %>% 
  summarise(mean = mean(value), sd=sd(value))

scaled_plantation_futures<- plantation_clim_vars %>% 
  pivot_longer(CMD:monsoonality) %>% 
  left_join(big_pca_data_sum) %>% 
  mutate(scaledvalue = (value - mean)/sd) %>% 
  dplyr::select(period,name,scaledvalue) %>% 
  pivot_wider(names_from="name", values_from = "scaledvalue") %>% 
  dplyr::select(-period)

plant_pca_scores <- data.frame(Provenance="Plantation",
                               period = plantation_all$period,
                               PC1 = (clim_pca_big$rotation[,1] %*% t(scaled_plantation_futures))[1,],
                               PC2 = (clim_pca_big$rotation[,2] %*% t(scaled_plantation_futures))[1,],
                               PC3 = (clim_pca_big$rotation[,3] %*% t(scaled_plantation_futures))[1,])

##### playing with factoextra visualizations #####

get_eigenvalue(clim_pca_big)
fviz_eig(clim_pca_big, addlabels=TRUE)
var<-get_pca_var(clim_pca_big)
var$coord

fviz_pca_var(clim_pca_big, col.var="black")
fviz_cos2(clim_pca_big, choice = "var", axes = 1)
fviz_pca_var(clim_pca_big, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )
head(var$contrib, 3)
corrplot(var$contrib, is.corr=FALSE) 
contrib.plot<- ggarrange(fviz_contrib(clim_pca_big, choice="var", axes=1, fill="wheat3", color="wheat3", title="PC1",xtickslab.rt = 90),fviz_contrib(clim_pca_big, choice="var", axes=2,fill="wheat3", color="wheat3", title="PC2", xtickslab.rt = 90), nrow=1)

contrib.plot

###pien climate niche
scores1 <- data.frame(clim_pca_big$x[,1:3])
# scores <- lapply(scores1, function(x) x / sqrt(sum((x - mean(x))^2)))
loadings <- as.data.frame(clim_pca_big$rotation)[1:3]
loadings_pc1pc2 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","PPTwt","PPTsp","monsoonality","smrpb","CMD","MCMT","NFFD","MWMT"),]
loadings_pc1pc3 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","PPTwt","PPTsp","monsoonality","smrpb","CMD","MCMT","NFFD","MWMT"),]
scale <- min(max(abs(scores1$PC1))/max(abs(loadings$PC1)),
             max(abs(scores1$PC2))/max(abs(loadings$PC2))) * 0.8

###test -- this is how you manually calculate contribution of variables to each PC. 
var_cor_func <- function(var.loadings, comp.sdev){var.loadings*comp.sdev}
var.cor <- t(apply(clim_pca_big$rotation, 1, var_cor_func, clim_pca_big$sdev))
var.cor  ##correlation
var.cor^2 ##cos2
comp.cos2 <- apply(var.cor^2, 2, sum)
contrib <- function(var.cos2, comp.cos2){var.cos2*100/comp.cos2}
var.contrib <- t(apply(var.cor^2,1, contrib, comp.cos2))
###

pc1_pc2_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=c(.1,.1,.1,.1,.1,.1,1,-.1,-.2,-.3), vjust=c(1.2,1.2,1.2,-1.2,1.2,1.2,1,1,1,1))+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance", guide="none")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=2)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC2 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[2]*100,1),"%)",sep=""))+
   xlim(-5,5.5)+
   ylim(-4.5,8)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc2_niche_plot.png", width=5, height=4, res=300, units = "in")
pc1_pc2_niche_plot
dev.off()
 

pc1_pc3_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC3))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc3 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC3),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc3 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc3)),
               aes(x = PC1, y = PC3, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC3, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC3, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=1.5)+
   xlim(-5,5.5)+
   ylim(-4.5,8)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC3 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[3]*100,1),"%)",sep=""))+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc3_niche_plot.png", width=3, height=3, res=300, units = "in")
pc1_pc3_niche_plot
dev.off()
 
figpca_legend <- get_legend( ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  xlim(-10,8)+
  ylim(-3,6)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8)) )
```


Put it all together with a map of the provenances

```{r}

###put pien distribution on map
pien_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")
pigl_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/White spruce (Picea glauca) extent, North America/data/commondata/data0/piceglau.shp")
pipu_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Blue spruce (Picea pungens) extent, North America/data/commondata/data0/picepung.shp")
pien_little_map_prj <- project(pien_little_map, crs(westernus))
pien_little_map_prj_crop <- crop(pien_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pigl_little_map_prj <- project(pigl_little_map, crs(westernus))
pigl_little_map_prj_crop <- crop(pigl_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pipu_little_map_prj <- project(pipu_little_map, crs(westernus))
pipu_little_map_prj_crop <- crop(pipu_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )

canada_crop <- crop(canada, ext(-126.92, -97.23, 41.6769, 52))

map <- ggplot()+
  geom_spatvector(data=westernus, col="grey", fill="gray100")+
  geom_spatvector(data=canada_crop, col="grey", fill="gray100")+
  geom_spatvector(data=pien_little_map_prj_crop, fill="wheat", col="wheat")+
  geom_spatvector(data=pigl_little_map_prj_crop, fill="thistle", col="thistle", alpha=0.6)+
  geom_spatvector(data=pipu_little_map_prj_crop, fill="paleturquoise", col="paleturquoise",alpha=.6)+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(!Provenance == "Plantation"), aes(fill=factor(Provenance, levels=provs_bylat$Provenance)), shape=24, size=1.5)+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(Provenance == "Plantation"), color="black", size=1.5)+
  geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(!Provenance == "Plantation"), aes(label=code), hjust=c(1.2,-.2,-.2,1.1,-.2,-.2,1,.1,0,1.2,-0.2,1.0, 1.1,1.0,0,1,-0.2,1.2,1,1.2), vjust=c(.4,0,0,0,0,0,1.3,1.4,1.3,rep(0,5),1.3,0,-.2,0,0,0), size=2.5)+
    geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(Provenance == "Plantation"), aes(label="Plantation"), hjust = 1, vjust=-0.4, col="black", size=2.5)+
  theme(panel.grid = element_blank(), legend.position = "none", axis.title=element_blank(), axis.text = element_text(color="black", size=8))+
  # ggspatial::annotation_scale(
  #   location = "bl",
  #   bar_cols = c("black", "white"),
  #     height = unit(0.1, "cm"),
  #   text_cex = 0.5) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style=north_arrow_fancy_orienteering(text_size=8, line_width = 0.8),
    height=unit(.25, "in"),
    width=unit(.25, "in"))

# png("figures/map.png", width=3, height=3, res=300, units = "in")
 map
# dev.off()

png("figures/map_and_bigpca_bluewhite.png", width=8.3, height=6.5, res=300, units = "in")
ggarrange(map,ggarrange(pc1_pc2_niche_plot, contrib.plot, nrow=2, ncol=1, labels=c("B)","C)")), labels=c("A)",""), ncol=2, nrow=1)
dev.off()
```

```{r}
###how well does the plantation represent typical Engelmann spruce habitat?

lines(x= plant_pca_scores %>% filter(period=="1970s") %>% pull(PC1))

prov_pcapts_big

pien_clim_niche<- as.data.frame(clim_pca_big$x[-(1:5),])

ggarrange(
ggplot()+
  geom_histogram(data=pien_clim_niche, aes(x=PC1), fill="gray", col="black")+
  geom_vline(xintercept = plant_pca_scores %>% filter(period=="1970s") %>% pull(PC1), col="darkorange2", linewidth=2)+
  theme_bw(),
ggplot()+
  geom_histogram(data=pien_clim_niche, aes(x=PC2), fill="gray", col="black")+
  geom_vline(xintercept = plant_pca_scores %>% filter(period=="1970s") %>% pull(PC2), col="darkorange2", linewidth=2)+
  theme_bw())

##future
plantation_future
clim_pien

future_engelmann_clim_us <- terra::extract(future_clim_raster_stack, engelmann_points_usonly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

future_pien_mathys_little_ca_clim <- terra::extract(future_clim_raster_stack, pien_mathys_little_ca_points_crop %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

future_clim_pien<- bind_rows(future_pien_mathys_little_ca_clim,future_engelmann_clim_us)

future_clim_pien_long <- future_clim_pien %>% 
  pivot_longer(AHM_ssp585_2020s:SHM_ssp585_2080s) %>% 
  separate(name, sep="_", into=c("var","carbon","period"))

clim_pien_long <- clim_pien %>% 
  pivot_longer(AHM:SHM, names_to=c("var")) %>% 
  mutate(period="1970s")
  
clim_pien_all <- bind_rows(future_clim_pien_long, clim_pien_long)

clim_pien_all %>% 
  filter(var=="NFFD") %>% 
  group_by(period) %>% 
  summarise(n=n())
nrow(clim_pien)
future_clim_pien_long %>% filter(var=="NFFD") %>% nrow()
clim_pien_long %>% filter(var=="NFFD") %>% nrow()
clim_pien_all %>% filter(var=="NFFD") %>% nrow()

ggplot()+
  geom_histogram(data=clim_pien_all %>% filter(var=="NFFD"), aes(x=value, fill=period), alpha=0.3, binwidth = 10, position="identity")+
  scale_fill_manual(values=c("blue","green","orange","red"))+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(NFFD), col="black", linewidth=1.5)+
  geom_text(aes(x=75, y=6000, label="1970's \n plantation"))+
  labs(x="NFFD", y="Count")+
  theme_bw()

ggplot()+
  geom_histogram(data=clim_pien_all %>% filter(var=="MAP"), aes(x=value, fill=period), alpha=0.3, binwidth = 100, position="identity")+
  scale_fill_manual(values=c("blue","green","orange","red"))+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(MAP), col="black", linewidth=1.5)+
  geom_text(aes(x=1200, y=4500, label="1970's \n plantation"))+
  labs(x="MAP", y="Count")+
  theme_bw()



ggplot()+
  geom_histogram(data=clim_pien, aes(x=MCMT), fill="blue", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MCMT_ssp585_2020s), fill="yellow", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MCMT_ssp585_2050s), fill="orange", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MCMT_ssp585_2080s), fill="red", alpha=0.3)+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(MCMT), col="black", linewidth=2)

ggplot()+
  geom_histogram(data=clim_pien, aes(x=MAP), fill="blue", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MAP_ssp585_2020s), fill="yellow", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MAP_ssp585_2050s), fill="orange", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MAP_ssp585_2080s), fill="red", alpha=0.3)+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(MAP), col="black", linewidth=2)


```

#Response variables

##DBH

```{r}
##DBH data is in centimeters
moniger_data <- read.csv("past_moniger_data.csv")
moniger_data_ids <- read.csv("past_moniger_data_ids.csv")

moniger_data_comb <- moniger_data %>% 
  left_join(moniger_data_ids, by=c("LOC" = "ID.Code")) %>% 
  mutate(Provenance = ifelse(Location == "Larimer County 1","Larimer 1",
                                    ifelse(Location == "Larimer County 2","Larimer 2",Location))) %>% 
  left_join(prov_pcapts_big) 

dbh <- moniger_data_comb %>% 
  dplyr::select(c(SORT, LOC, BLK, REP, DBH91, DBH96, DBH06, DBH14, Provenance, code)) %>% 
  mutate(Series = paste(LOC,BLK,REP,sep="")) 

dbh_long<- dbh %>% 
  filter(!is.na(DBH91)) %>% 
  pivot_longer(DBH91:DBH14, names_to = 'year', values_to = 'DBH')

dbh_clim_data <- dbh_long %>% 
  left_join(prov_pcapts_big) %>% 
  filter(!is.na(DBH)) %>% 
  filter(!DBH==0) ##there is one with a dbh value of 0 which seems like an error.

#arranging provenances by different variables to visually identify patterns in DBH
dbh_by_lat_plot<- ggplot(dbh_long, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by Latitude")

dbh_by_nffd_plot <-ggplot(dbh_clim_data, aes(x=factor(round(NFFD,2)), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by NFFD")

dbh_by_cmd_plot <-ggplot(dbh_clim_data, aes(x=factor(round(CMD,0)), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by CMD")

```


###absolute DBH

####ANOVA

```{r}
dbh_numeric <- dbh_clim_data %>% 
  mutate(num.yr = as.numeric(ifelse(year=="DBH91", 1,
                         ifelse(year=="DBH96", 6,
                                ifelse(year=="DBH06", 16,
                                       ifelse(year=="DBH14", 24, year))))))

dbh_aov <- lmer(DBH ~ year*Provenance + (1|BLK), data = dbh_numeric)
plot(dbh_aov)
qqmath(dbh_aov)
summary(dbh_aov)
anova(dbh_aov) #no significant interaction
rand(dbh_aov)
dbh_aov_noint <- lmer(DBH ~ year + Provenance + (1|BLK), data = dbh_numeric)
Anova(dbh_aov_noint, type="2") #both year and provenance are significant but do not interact (relatively similar order of provenance DBH in each year measured)
summary(dbh_aov_noint)
rand(dbh_aov_noint)

###model each year separately
dbh_aov91 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH91"))

plot(dbh_aov91)
anova(dbh_aov91)
rand(dbh_aov91)

dbh_aov91_marg = lsmeans(dbh_aov91, ~ Provenance)

CLD_dbh_aov91 = cld(dbh_aov91_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov91 #payette greater than 12, gila less than 10

dbh_aov96 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH96"))
plot(dbh_aov96)
anova(dbh_aov96)
dbh_aov96_marg = lsmeans(dbh_aov96, ~ Provenance)

CLD_dbh_aov96 = cld(dbh_aov96_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov96 #payette greater than 12, gila less than 10, cache less than 13

  
dbh_aov06 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH06"))
plot(dbh_aov06)
anova(dbh_aov06)
dbh_aov06_marg = lsmeans(dbh_aov06, ~ Provenance)

CLD_dbh_aov06 = cld(dbh_aov06_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov06 #payette greater than 13, gila less than 13

dbh_numeric14 <- dbh_numeric %>% filter(year=="DBH14") %>% 
  mutate(Provenance=as.factor(Provenance))

dbh_aov14 <- lmer(DBH ~ Provenance + (1|BLK), data =dbh_numeric14)
plot(dbh_aov14)
Anova(dbh_aov14, type="3")
dbh_aov14_marg = lsmeans(dbh_aov14, ~ Provenance)

CLD_dbh_aov14 = cld(dbh_aov14_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov14 #payette greater than 15, gila less than 13

dbh14_letter_df<- as.data.frame(CLD_dbh_aov14) %>% 
  rename(letters = `.group`) %>% 
  mutate(year="DBH14")


prov_dbh_order<- dbh_numeric %>% 
  filter(year=="DBH14") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)

dbh_early<- ggplot(dbh_numeric %>% filter(!year=="DBH14"), aes(x=factor(year, levels=c("DBH91","DBH96","DBH06"), labels=c(1991,1996,2006)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_x_discrete(name="Year")

dbh_2014<-ggplot(dbh_numeric14, aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance), group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot(position=position_dodge(width=1))+
  #geom_text(data=dbh14_letter_df, aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y= 35, label=letters, group=factor(Provenance, levels=provs_bylat$Provenance)), position=position_dodge(width=1), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("DBH (cm)")+
    scale_x_discrete(name="Year")+
  theme_bw()+
  theme(axis.text=element_text(color="black", size=12),
        axis.title=element_text(color="black", size=12))

ggarrange(dbh_early,dbh_2014, nrow=2, common.legend = TRUE)

dbh_aves <- dbh_numeric %>% 
  group_by(Provenance,year) %>% 
  summarise(meanDBH=mean(DBH),se_DBH=sd(DBH)/sqrt(n())) %>% 
  mutate(year= case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996)) %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,1985), meanDBH=NA, se_DBH=NA))

dbh_means_fig <- ggplot(dbh_aves, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meanDBH, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meanDBH-se_DBH, ymax=meanDBH+se_DBH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean DBH (cm)")

dbh_means_fig

##just for 2014
 ggplot(dbh_aves %>% filter(year==2014), aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meanDBH, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meanDBH-se_DBH, ymax=meanDBH+se_DBH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean DBH (cm)")+
  theme(axis.text=element_text(color="black", size=12), axis.title=element_text(color="black", size=12))

##look for outliers
ggplot(dbh_numeric, aes(x=num.yr, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance), group=Series))+
  geom_line()+
  geom_point()+
    scale_color_manual(values=unname(stepped()), "")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))
```

####PC only models

```{r}

dbh_numeric_time <- dbh_numeric %>% 
  mutate(year=case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996))
dbh_numeric_time_noG <- dbh_numeric_time %>% filter(!Provenance=="Gila NF")

###using year as a random effect
mod_dbh_pca <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
plot(mod_dbh_pca)
qqmath(mod_dbh_pca)
summary(mod_dbh_pca)
options(na.action="na.fail")
# mod_dbh_pca_dredge<- dredge(mod_dbh_pca)
# mod_dbh_pca_dredge

bestmod_dbh_pca <- lmer(DBH ~ PC2 + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
summary(bestmod_dbh_pca)
r2(bestmod_dbh_pca)

#no gila

mod_dbh_pca_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_noG)
qqmath(mod_dbh_pca_noG)
summary(mod_dbh_pca_noG)
# mod_dbh_pca_noG_dredge<- dredge(mod_dbh_pca_noG)
# mod_dbh_pca_noG_dredge #null is best

```

#####each year separate


```{r}
###2014
dbh_numeric_time_2014 <- dbh_numeric_time %>% filter(year==2014)

mod_dbh_pca_2014 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014)
plot(mod_dbh_pca_2014)
qqmath(mod_dbh_pca_2014)
summary(mod_dbh_pca_2014)
# mod_dbh_pca_2014_dredge<- dredge(mod_dbh_pca_2014)
# mod_dbh_pca_2014_dredge

bestmod_dbh_pca_2014 <- lmer(DBH ~ PC2 + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014)
summary(bestmod_dbh_pca_2014)
r2(bestmod_dbh_pca_2014)

#2014 - no gila
dbh_numeric_time_2014_nog <- dbh_numeric_time %>% filter(year==2014) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_2014_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014_nog)
plot(mod_dbh_pca_2014_noG)
qqmath(mod_dbh_pca_2014_noG)
summary(mod_dbh_pca_2014_noG)
# mod_dbh_pca_2014_noG_dredge<- dredge(mod_dbh_pca_2014_noG)
# mod_dbh_pca_2014_noG_dredge #null is best

bestmod_dbh_pca_2014_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2014_nog)
summary(bestmod_dbh_pca_2014_noG)
r2(bestmod_dbh_pca_2014_noG)
```

```{r}
###2006
dbh_numeric_time_2006 <- dbh_numeric_time %>% filter(year==2006)

mod_dbh_pca_2006 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006)
plot(mod_dbh_pca_2006)
qqmath(mod_dbh_pca_2006)
summary(mod_dbh_pca_2006)
# mod_dbh_pca_2006_dredge<- dredge(mod_dbh_pca_2006)
# mod_dbh_pca_2006_dredge

bestmod_dbh_pca_2006 <- lmer(DBH ~ PC2 + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006)
summary(bestmod_dbh_pca_2006)
r2(bestmod_dbh_pca_2006)

#2006 - no gila
dbh_numeric_time_2006_nog <- dbh_numeric_time %>% filter(year==2006) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_2006_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006_nog)
plot(mod_dbh_pca_2006_noG)
qqmath(mod_dbh_pca_2006_noG)
summary(mod_dbh_pca_2006_noG)
# mod_dbh_pca_2006_noG_dredge<- dredge(mod_dbh_pca_2006_noG)
# mod_dbh_pca_2006_noG_dredge #null is best

bestmod_dbh_pca_2006_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_2006_nog)
summary(bestmod_dbh_pca_2006_noG)
r2(bestmod_dbh_pca_2006_noG)
```

```{r}
###1996
dbh_numeric_time_1996 <- dbh_numeric_time %>% filter(year==1996)

mod_dbh_pca_1996 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996)
plot(mod_dbh_pca_1996)
qqmath(mod_dbh_pca_1996)
summary(mod_dbh_pca_1996)
# mod_dbh_pca_1996_dredge<- dredge(mod_dbh_pca_1996)
# mod_dbh_pca_1996_dredge #null is best

bestmod_dbh_pca_1996 <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996)
summary(bestmod_dbh_pca_1996)
r2(bestmod_dbh_pca_1996)

#1996 - no gila
dbh_numeric_time_1996_nog <- dbh_numeric_time %>% filter(year==1996) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_1996_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996_nog)
plot(mod_dbh_pca_1996_noG)
qqmath(mod_dbh_pca_1996_noG)
summary(mod_dbh_pca_1996_noG)
# mod_dbh_pca_1996_noG_dredge<- dredge(mod_dbh_pca_1996_noG)
# mod_dbh_pca_1996_noG_dredge #null is best

bestmod_dbh_pca_1996_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1996_nog)
summary(bestmod_dbh_pca_1996_noG)
r2(bestmod_dbh_pca_1996_noG)
```

```{r}
###1991
dbh_numeric_time_1991 <- dbh_numeric_time %>% filter(year==1991)

mod_dbh_pca_1991 <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991)
plot(mod_dbh_pca_1991)
qqmath(mod_dbh_pca_1991)
summary(mod_dbh_pca_1991)
# mod_dbh_pca_1991_dredge<- dredge(mod_dbh_pca_1991)
# mod_dbh_pca_1991_dredge #null is best

bestmod_dbh_pca_1991 <- lmer(DBH ~ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991)
summary(bestmod_dbh_pca_1991)
r2(bestmod_dbh_pca_1991)

#1991 - no gila
dbh_numeric_time_1991_nog <- dbh_numeric_time %>% filter(year==1991) %>% filter(!Provenance=="Gila NF")

mod_dbh_pca_1991_noG <- lmer(DBH ~ PC1*PC2 + I(PC1^2) + I(PC2^2)+ (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991_nog)
plot(mod_dbh_pca_1991_noG)
qqmath(mod_dbh_pca_1991_noG)
summary(mod_dbh_pca_1991_noG)
# mod_dbh_pca_1991_noG_dredge<- dredge(mod_dbh_pca_1991_noG)
# mod_dbh_pca_1991_noG_dredge #null is best

bestmod_dbh_pca_1991_noG <- lmer(DBH ~  (1|Provenance) + (1|BLK) , data=dbh_numeric_time_1991_nog)
summary(bestmod_dbh_pca_1991_noG)
r2(bestmod_dbh_pca_1991_noG)
```


####individual climate var models
```{r}
dbh_numeric_time_long <- dbh_numeric_time %>% 
  pivot_longer(c(PC1, PC2, AHM:SHM, x:monsoonality))
provenance_climvars <- unique(dbh_numeric_time_long$name)


dbh_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
    
mod_nog <- lmer(DBH ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal


dbh_mods <- bind_rows(dbh_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, cr2= Cr2, mr2 = Mr2, pvalue_nog = pvalue_nog, cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_mods %>% arrange(pvalue_nog)

###quadratic

dbh_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

dbh_mods_quad <- bind_rows(dbh_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_mods_quad %>% arrange(pvalue2_nog) #y is significant

##latitude model
lat_dbh_mod_nog <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y"))
plot(lat_dbh_mod_nog)
qqmath(lat_dbh_mod_nog)
summary(lat_dbh_mod_nog)
r2(lat_dbh_mod_nog)

lat_dbh_mod_nog_lm <- lm(DBH ~ value + I(value^2), data=dbh_numeric_time_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y"))

newdata_lat_dbh_nog <-  expand.grid(value=seq(dbh_numeric_time_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% min(), dbh_numeric_time_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% max(),1))
lat_dbh_predict_nog <- predict(lat_dbh_mod_nog_lm, newdata = newdata_lat_dbh_nog, interval="confidence")

predictdata_lat_dbh_nog <- cbind(newdata_lat_dbh_nog, lat_dbh_predict_nog) %>% mutate(var="Latitude")

##latitude model - with Gila
lat_dbh_mod <- lmer(DBH ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_long %>% filter(name=="y"))
plot(lat_dbh_mod)
qqmath(lat_dbh_mod)
summary(lat_dbh_mod)

lat_dbh_mod_lm <- lm(DBH ~ value + I(value^2), data=dbh_numeric_time_long %>% filter(name=="y"))

newdata_lat_dbh <-  expand.grid(value=seq(dbh_numeric_time_long %>% filter(name=="y") %>% pull(value) %>% min(), dbh_numeric_time_long %>% filter(name=="y") %>% pull(value) %>% max(),1))
lat_dbh_predict <- predict(lat_dbh_mod_lm, newdata = newdata_lat_dbh, interval="confidence")

predictdata_lat_dbh <- cbind(newdata_lat_dbh, lat_dbh_predict) %>% mutate(var="Latitude")

lat_dbh_predictdata_all <- bind_rows(predictdata_lat_dbh %>% mutate(model="with Gila NF", pvalue=summary(lat_dbh_mod)$coefficient[3,5]), predictdata_lat_dbh_nog %>% mutate(model="without Gila NF", pvalue=summary(lat_dbh_mod_nog)$coefficient[3,5]))

ggplot()+
  geom_ribbon(data=lat_dbh_predictdata_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=lat_dbh_predictdata_all, aes(x=value,y=fit, col=model))+
  geom_rug(data=dbh_numeric_time_long %>% filter(name=="y") %>% mutate(fit=9), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  scale_color_manual(values=c("darkgrey","black"))+
  scale_fill_manual(values=c("darkgrey","black"))+
  xlab("Provenance Latitude")+
  ylab("Absolute DBH")+
  facet_grid(~var)+
  theme_bw()

```

#####transfer distance
```{r}
plantation_climNA <- prov_vars %>% 
  filter(Provenance=="Plantation") %>% 
  dplyr::select(var,value) %>% 
  rename(plant_value = value) %>% 
  bind_rows(data.frame(var=c("PC1","PC2"), plant_value=c(plant_pca_scores %>% filter(period=="1970s") %>% pull(PC1),plant_pca_scores %>% filter(period=="1970s") %>% pull(PC2)) ))

dbh_clim_long_transfer <- dbh_numeric_time_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - value))

dbh_clim_long_transfer_nog <- dbh_clim_long_transfer %>% filter(!Provenance=="Gila NF")

dbh_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(DBH ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_clim_long_transfer %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(DBH ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_clim_long_transfer_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

dbh_mods_transfer <- bind_rows(dbh_mods_transfer, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

dbh_mods_transfer %>% arrange(pvalue_nog) #just lat significant without Gila


#latitude
ggplot(data = dbh_clim_long_transfer_nog %>% filter(name=="y"), aes(x=diff_plant, y=DBH))+
  geom_point()+
  facet_wrap(~year)

dbh_y_transfermod_nog <- lmer(DBH ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))
plot(dbh_y_transfermod_nog)
qqmath(dbh_y_transfermod_nog)
summary(dbh_y_transfermod_nog) #further away from plantation in latitude = bigger DBH

dbh_y_transfermod_nog_lm <- lm(DBH ~ diff_plant, data=dbh_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))

newdata_lat_dbh_transfer <-  expand.grid(diff_plant=seq(dbh_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(diff_plant) %>% min(), dbh_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(diff_plant) %>% max(),1))
dbh_y_transfer_predict <- predict(dbh_y_transfermod_nog_lm, newdata = newdata_lat_dbh_transfer, interval="confidence")

predictdata_lat_dbh_transfer <- cbind(newdata_lat_dbh_transfer, dbh_y_transfer_predict) %>% mutate(var="Latitude")

ggplot()+
  geom_ribbon(data=predictdata_lat_dbh_transfer, aes(x=diff_plant, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_lat_dbh_transfer, aes(x=diff_plant,y=fit), color="black")+
  geom_rug(data=dbh_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% mutate(fit=9), aes(x=diff_plant,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Difference in latitude from plantation")+
  ylab("Absolute DBH")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")


###each year separately
##2014
dbh_y_transfermod_nog14 <- lmer(DBH ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_clim_long_transfer_nog %>% filter(name=="y" & year=="2014") %>% filter(!Provenance=="Gila NF"))
summary(dbh_y_transfermod_nog14) ##significant
#2006
dbh_y_transfermod_nog06 <- lmer(DBH ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_clim_long_transfer_nog %>% filter(name=="y" & year=="2006") %>% filter(!Provenance=="Gila NF"))
summary(dbh_y_transfermod_nog06) ##marginally significant
#1996
dbh_y_transfermod_nog96 <- lmer(DBH ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_clim_long_transfer_nog %>% filter(name=="y" & year=="1996") %>% filter(!Provenance=="Gila NF"))
summary(dbh_y_transfermod_nog96) ##significant

##distance in 2d climate space

dbh_climdist_df <- dbh_clim_long_transfer %>% 
  dplyr::select(Provenance, LOC,BLK, REP, year, DBH, name, diff_plant) %>% 
  filter(name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
dbh_climdist_mod <- lmer(DBH ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_climdist_df)
plot(dbh_climdist_mod)
qqmath(dbh_climdist_mod)
summary(dbh_climdist_mod) #not significant 

```

###growth rate

```{r}

dbh_growth_data<- dbh %>% 
  mutate(areagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/5, areagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/10, areagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/8) %>% 
  mutate(areagrowth96=case_when(DBH96 == 0 ~ NA,
                         is.na(DBH96) ~ NA,
                         .default=areagrowth96),
         areagrowth06=case_when(DBH06 == 0 ~ NA,
                         is.na(DBH06) ~ NA,
                         .default=areagrowth06),
         areagrowth14=case_when(DBH14 == 0 ~ NA,
                         is.na(DBH14) ~ NA,
                         .default=areagrowth14)) %>% 
  pivot_longer(areagrowth96:areagrowth14) %>% 
  filter(!value<0) ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)

dbh_increment_plot<- ggplot(dbh_growth_data, aes(x=factor(Provenance, provs_bylat$Provenance), y=value, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("areagrowth96","areagrowth06","areagrowth14"), labels=c("1991-96","1996-2006","2006-14")), scales="free")+
  ylab("Basal Area Growth Rate (cm^2/yr)")+
  xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

ggarrange(dbh_by_lat_plot,dbh_increment_plot, nrow=2, common.legend = TRUE)
```


####ANOVA
```{r}
###analyze basal area growth data
aov_DBHgr <- lmer(sqrt(value) ~ name*Provenance + (1|BLK), data=dbh_growth_data)
plot(aov_DBHgr)
qqmath(aov_DBHgr)
anova(aov_DBHgr) ##basal area growth differs by provenance and year, but not by the interaction of the two. 
```

####PC only models
```{r}
dbh_growth_clim <- dbh_growth_data %>% 
  left_join(prov_pcapts_big)
dbh_growth_clim_noG <- dbh_growth_clim %>% 
  filter(!Provenance=="Gila NF")
#
mod_dbhgr_pca <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim)
plot(mod_dbhgr_pca)
qqmath(mod_dbhgr_pca)
summary(mod_dbhgr_pca)
# mod_dbhgr_pca_dredge<- dredge(mod_dbhgr_pca)
# mod_dbhgr_pca_dredge #null is best

#no gila
mod_dbhgr_pca_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_clim_noG)
plot(mod_dbhgr_pca_noG)
qqmath(mod_dbhgr_pca_noG)
summary(mod_dbhgr_pca_noG)
# mod_dbhgr_pca_noG_dredge<- dredge(mod_dbhgr_pca_noG)
# mod_dbhgr_pca_noG_dredge #null is best
```

#####each year separate

```{r}

#1991-96
dbh_growth_clim_96 <- dbh_growth_clim %>% filter(name=="areagrowth96")
dbh_growth_clim_96_noG <- dbh_growth_clim_96 %>% filter(!Provenance=="Gila NF")

mod_dbhgr_pca_96 <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_clim_96)
plot(mod_dbhgr_pca_96)
qqmath(mod_dbhgr_pca_96)
summary(mod_dbhgr_pca_96)
# mod_dbhgr_pca_96_dredge<- dredge(mod_dbhgr_pca_96)
# mod_dbhgr_pca_96_dredge #null is best

#no gila

mod_dbhgr_pca_96_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_clim_96_noG)
plot(mod_dbhgr_pca_96_noG)
qqmath(mod_dbhgr_pca_96_noG)
summary(mod_dbhgr_pca_96_noG)
# mod_dbhgr_pca_96_noG_dredge<- dredge(mod_dbhgr_pca_96_noG)
# mod_dbhgr_pca_96_noG_dredge #null is best

```

```{r}

#1996-2006
dbh_growth_clim_06 <- dbh_growth_clim %>% filter(name=="areagrowth06")
dbh_growth_clim_06_noG <- dbh_growth_clim_06 %>% filter(!Provenance=="Gila NF")

mod_dbhgr_pca_06 <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_clim_06)
plot(mod_dbhgr_pca_06)
qqmath(mod_dbhgr_pca_06)
summary(mod_dbhgr_pca_06)
# mod_dbhgr_pca_06_dredge<- dredge(mod_dbhgr_pca_06)
# mod_dbhgr_pca_06_dredge #null is best

#no gila

mod_dbhgr_pca_06_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_clim_06_noG)
plot(mod_dbhgr_pca_06_noG)
qqmath(mod_dbhgr_pca_06_noG)
summary(mod_dbhgr_pca_06_noG)
# mod_dbhgr_pca_06_noG_dredge<- dredge(mod_dbhgr_pca_06_noG)
# mod_dbhgr_pca_06_noG_dredge #null is best

```

```{r}

#2006-14
dbh_growth_clim_14 <- dbh_growth_clim %>% filter(name=="areagrowth14")
dbh_growth_clim_14_noG <- dbh_growth_clim_14 %>% filter(!Provenance=="Gila NF")

mod_dbhgr_pca_14 <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_clim_14)
plot(mod_dbhgr_pca_14)
qqmath(mod_dbhgr_pca_14)
summary(mod_dbhgr_pca_14)
# mod_dbhgr_pca_14_dredge<- dredge(mod_dbhgr_pca_14)
# mod_dbhgr_pca_14_dredge #null is best

#no gila

mod_dbhgr_pca_14_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_clim_14_noG)
plot(mod_dbhgr_pca_14_noG)
qqmath(mod_dbhgr_pca_14_noG)
summary(mod_dbhgr_pca_14_noG)
# mod_dbhgr_pca_14_noG_dredge<- dredge(mod_dbhgr_pca_14_noG)
# mod_dbhgr_pca_14_noG_dredge #null is best

```


####individual climate var models
```{r}
dbh_growth_clim_long <- dbh_growth_clim %>% 
  rename(year=name, growth=value) %>% 
  pivot_longer(c(PC1, PC2, AHM:SHM, x:monsoonality))
provenance_climvars <- unique(dbh_growth_clim_long$name)

dbh_gr_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(growth) ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
    
mod_nog <- lmer(sqrt(growth) ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal


dbh_gr_mods <- bind_rows(dbh_gr_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, cr2= Cr2, mr2 = Mr2, pvalue_nog = pvalue_nog, cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_gr_mods %>% arrange(pvalue_nog)

###quadratic

dbh_gr_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(growth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(sqrt(growth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

dbh_gr_mods_quad <- bind_rows(dbh_gr_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_gr_mods_quad %>% arrange(pvalue2_nog) #just y significant

##latitude model
lat_dbh_gr_mod_nog <- lmer(sqrt(growth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y"))
plot(lat_dbh_gr_mod_nog)
qqmath(lat_dbh_gr_mod_nog)
summary(lat_dbh_gr_mod_nog)
r2(lat_dbh_gr_mod_nog)

lat_dbh_gr_mod_nog_lm <- lm(sqrt(growth) ~ value + I(value^2), data=dbh_growth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y"))

newdata_lat_dbh_gr_nog <-  expand.grid(value=seq(dbh_growth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% min(), dbh_growth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% max(),1))
lat_dbh_gr_predict_nog <- predict(lat_dbh_gr_mod_nog_lm, newdata = newdata_lat_dbh_gr_nog, interval="confidence")

predictdata_lat_dbh_gr_nog <- cbind(newdata_lat_dbh_gr_nog, lat_dbh_gr_predict_nog) %>% mutate(var="Latitude")

##latitude model - with Gila
lat_dbh_gr_mod <- lmer(sqrt(growth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_clim_long  %>% filter(name=="y"))
plot(lat_dbh_gr_mod)
qqmath(lat_dbh_gr_mod)
summary(lat_dbh_gr_mod)
r2(lat_dbh_gr_mod)

lat_dbh_gr_mod_lm <- lm(sqrt(growth) ~ value + I(value^2), data=dbh_growth_clim_long %>% filter(name=="y"))

newdata_lat_dbh_gr <-  expand.grid(value=seq(dbh_growth_clim_long  %>% filter(name=="y") %>% pull(value) %>% min(), dbh_growth_clim_long %>% filter(name=="y") %>% pull(value) %>% max(),1))
lat_dbh_gr_predict <- predict(lat_dbh_gr_mod_lm, newdata = newdata_lat_dbh_gr, interval="confidence")

predictdata_lat_dbh_gr <- cbind(newdata_lat_dbh_gr, lat_dbh_gr_predict) %>% mutate(var="Latitude")

predictdata_lat_dbh_gr_all <- bind_rows(predictdata_lat_dbh_gr %>% mutate(model="with Gila NF", pvalue=summary(lat_dbh_gr_mod)$coefficient[3,5]), predictdata_lat_dbh_gr_nog %>% mutate(model="without Gila NF",pvalue=summary(lat_dbh_gr_mod_nog)$coefficient[3,5]))

ggplot()+
  geom_ribbon(data=predictdata_lat_dbh_gr_all, aes(x=value, ymin=lwr^2, ymax=upr^2, fill=model), alpha=0.2)+
  geom_line(data=predictdata_lat_dbh_gr_all, aes(x=value,y=fit^2, color=model))+
  geom_rug(data=dbh_growth_clim_long %>% filter(name=="y") %>% mutate(fit=6), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  scale_color_manual(values=c("darkgrey","black"))+
  scale_fill_manual(values=c("darkgrey","black"))+
  xlab("Provenance Latitude")+
  ylab("DBH growth rate")+
  facet_grid(~var)+
  theme_bw()
```

#####transfer distance
```{r}

dbh_growth_clim_long_transfer <- dbh_growth_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - value))

dbh_growth_clim_long_transfer_nog <- dbh_growth_clim_long_transfer %>% filter(!Provenance=="Gila NF")

dbh_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(growth) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long_transfer %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(sqrt(growth) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long_transfer_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

dbh_mods_transfer <- bind_rows(dbh_mods_transfer, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

dbh_mods_transfer %>% arrange(pvalue_nog) #just lat significant without Gila


#latitude
ggplot(data = dbh_growth_clim_long_transfer_nog %>% filter(name=="y"), aes(x=diff_plant, y=growth))+
  geom_point()+
  facet_wrap(~year)

dbhg_y_transfermod_nog <- lmer(sqrt(growth) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))
plot(dbhg_y_transfermod_nog)
qqmath(dbhg_y_transfermod_nog)
summary(dbhg_y_transfermod_nog) #further away from plantation in latitude = bigger growth

dbhg_y_transfermod_nog_lm <- lm(sqrt(growth) ~ diff_plant, data=dbh_growth_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))

newdata_lat_dbhg_transfer <-  expand.grid(diff_plant=seq(dbh_growth_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(diff_plant) %>% min(), dbh_growth_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(diff_plant) %>% max(),1))
dbhg_y_transfer_predict <- predict(dbhg_y_transfermod_nog_lm, newdata = newdata_lat_dbhg_transfer, interval="confidence")

predictdata_lat_dbhg_transfer <- cbind(newdata_lat_dbhg_transfer, dbhg_y_transfer_predict) %>% mutate(var="Latitude")

ggplot()+
  geom_ribbon(data=predictdata_lat_dbhg_transfer, aes(x=diff_plant, ymin=lwr^2, ymax=upr^2), alpha=0.2)+
  geom_line(data=predictdata_lat_dbhg_transfer, aes(x=diff_plant,y=fit^2), color="black")+
  geom_rug(data=dbh_growth_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% mutate(fit=7), aes(x=diff_plant,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Difference in latitude from plantation")+
  ylab("DBH growth rate")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")

###each year separately
##2014
dbhg_y_transfermod_nog14 <- lmer(sqrt(growth) ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_growth_clim_long_transfer_nog %>% filter(name=="y" & year=="areagrowth14") %>% filter(!Provenance=="Gila NF"))
summary(dbhg_y_transfermod_nog14) ##significant
#2006
dbhg_y_transfermod_nog06 <- lmer(sqrt(growth) ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_growth_clim_long_transfer_nog %>% filter(name=="y" & year=="areagrowth06") %>% filter(!Provenance=="Gila NF"))
summary(dbhg_y_transfermod_nog06) ## not significant
#1996
dbhg_y_transfermod_nog96 <- lmer(sqrt(growth) ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_growth_clim_long_transfer_nog %>% filter(name=="y" & year=="areagrowth96") %>% filter(!Provenance=="Gila NF"))
summary(dbhg_y_transfermod_nog96) ## marginally significant

##distance in 2d climate space

dbh_growth_climdist_df <- dbh_growth_clim_long_transfer %>% 
  dplyr::select(Provenance, LOC,BLK, REP, year, growth, name, diff_plant) %>% 
  filter(name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
dbh_growth_climdist_mod <- lmer(sqrt(growth) ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_growth_climdist_df)
plot(dbh_growth_climdist_mod)
qqmath(dbh_growth_climdist_mod)
summary(dbh_growth_climdist_mod) #not significant 

```


###relativized growth rate
When you relativize by the basal area in the intial year, the pattern is much different. Smaller trees are growing a higher percentage of their original basal area each year, despite putting on less total basal area. I think the way this is calculated favors small trees too much, because ultimately bigger trees are doing better in terms of growth, even if they are not putting on a higher percentage of their initial basal area. I guess this would imply that they were taller to begin with.   

```{r}
# ##relativize by original BA
dbh_growth_data_rel<- dbh %>%
  mutate(relareagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/(pi*(DBH91/2)^2)*100/5, relareagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/(pi*(DBH96/2)^2)*100/10, relareagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/(pi*(DBH06/2)^2)*100/8) %>%
  mutate(relareagrowth96=case_when(DBH96 == 0 ~ NA,
                         is.na(DBH96) ~ NA,
                         .default=relareagrowth96),
         relareagrowth06=case_when(DBH06 == 0 ~ NA,
                         is.na(DBH06) ~ NA,
                         .default=relareagrowth06),
         relareagrowth14=case_when(DBH14 == 0 ~ NA,
                         is.na(DBH14) ~ NA,
                         .default=relareagrowth14)) %>%
  pivot_longer(relareagrowth96:relareagrowth14) %>%
  filter(!value<0) %>%  ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)
  filter(!is.infinite(value)) %>% ##gets rid of the 3 values that were infinite because dbh was recorded as 0 instead of NA in 2006.
  left_join(prov_pcapts_big)

relba_plot<- ggplot(dbh_growth_data_rel, aes(x=factor(Provenance, provs_bylat$Provenance), y=value, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("relareagrowth96","relareagrowth06","relareagrowth14"), labels=c("1991-96","1996-2006","2006-14")), scales="free")+
  ylab("Relativized Basal Area Growth (%/yr)")+
  xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

relba_plot

ggarrange(dbh_by_lat_plot,dbh_increment_plot,relba_plot, nrow=3, common.legend = TRUE)
```

####ANOVA
```{r}
###analyze basal area growth data
aov_DBHrel <- lmer(sqrt(value) ~ name*Provenance + (1|BLK), data=dbh_growth_data_rel)
plot(aov_DBHrel)
qqmath(aov_DBHrel)
anova(aov_DBHrel) ##basal area growth differs by provenance and year, and has significant interaction
```

####PC only models
```{r}
dbh_growth_rel_clim<- dbh_growth_data_rel %>% 
  left_join(prov_pcapts_big)
dbh_growth_rel_clim_noG<- dbh_growth_data_rel %>% 
  left_join(prov_pcapts_big) %>% 
  filter(!Provenance=="Gila NF")
#
mod_DBHrel_pca <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_rel_clim)
plot(mod_DBHrel_pca)
qqmath(mod_DBHrel_pca)
summary(mod_DBHrel_pca)
# mod_DBHrel_pca_dredge<- dredge(mod_DBHrel_pca)
# mod_DBHrel_pca_dredge #null is best

#no gila

mod_DBHrel_pca_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=dbh_growth_rel_clim_noG)
plot(mod_DBHrel_pca_noG)
qqmath(mod_DBHrel_pca_noG)
summary(mod_DBHrel_pca_noG)
# mod_DBHrel_pca_noG_dredge<- dredge(mod_DBHrel_pca_noG)
# mod_DBHrel_pca_noG_dredge #null is best

```

#####each year separate

```{r}

#1991-96
dbh_growth_rel_clim_96 <- dbh_growth_rel_clim %>% filter(name=="relareagrowth96")
dbh_growth_rel_clim_96_noG <- dbh_growth_rel_clim_96 %>% filter(!Provenance=="Gila NF")

mod_DBHrel_pca_96 <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_rel_clim_96)
plot(mod_DBHrel_pca_96)
qqmath(mod_DBHrel_pca_96)
summary(mod_DBHrel_pca_96)
# mod_DBHrel_pca_96_dredge<- dredge(mod_DBHrel_pca_96)
# mod_DBHrel_pca_96_dredge #null is best

#no gila

mod_DBHrel_pca_96_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_rel_clim_96_noG)
plot(mod_DBHrel_pca_96_noG)
qqmath(mod_DBHrel_pca_96_noG)
summary(mod_DBHrel_pca_96_noG)
# mod_DBHrel_pca_96_noG_dredge<- dredge(mod_DBHrel_pca_96_noG)
# mod_DBHrel_pca_96_noG_dredge #null is best

```

```{r}

#1996-2006
dbh_growth_rel_clim_06 <- dbh_growth_rel_clim %>% filter(name=="relareagrowth06")
dbh_growth_rel_clim_06_noG <- dbh_growth_rel_clim_06 %>% filter(!Provenance=="Gila NF")

mod_DBHrel_pca_06 <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_rel_clim_06)
plot(mod_DBHrel_pca_06)
qqmath(mod_DBHrel_pca_06)
summary(mod_DBHrel_pca_06)
# mod_DBHrel_pca_06_dredge<- dredge(mod_DBHrel_pca_06)
# mod_DBHrel_pca_06_dredge #null is best

#no gila

mod_DBHrel_pca_06_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_rel_clim_06_noG)
plot(mod_DBHrel_pca_06_noG)
qqmath(mod_DBHrel_pca_06_noG)
summary(mod_DBHrel_pca_06_noG)
# mod_DBHrel_pca_06_noG_dredge<- dredge(mod_DBHrel_pca_06_noG)
# mod_DBHrel_pca_06_noG_dredge #null is best

```

```{r}

#2006-14
dbh_growth_rel_clim_14 <- dbh_growth_rel_clim %>% filter(name=="relareagrowth14")
dbh_growth_rel_clim_14_noG <- dbh_growth_rel_clim_14 %>% filter(!Provenance=="Gila NF")

mod_DBHrel_pca_14 <- lmer(sqrt(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_rel_clim_14)
plot(mod_DBHrel_pca_14)
qqmath(mod_DBHrel_pca_14)
summary(mod_DBHrel_pca_14)
# mod_DBHrel_pca_14_dredge<- dredge(mod_DBHrel_pca_14)
# mod_DBHrel_pca_14_dredge #null is best

#no gila

mod_DBHrel_pca_14_noG <- lmer(sqrt(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=dbh_growth_rel_clim_14_noG)
plot(mod_DBHrel_pca_14_noG)
qqmath(mod_DBHrel_pca_14_noG)
summary(mod_DBHrel_pca_14_noG)
# mod_DBHrel_pca_14_noG_dredge<- dredge(mod_DBHrel_pca_14_noG)
# mod_DBHrel_pca_14_noG_dredge #null is best

```


####individual climate var models
```{r}
dbh_relgrowth_clim_long <- dbh_growth_rel_clim %>% 
  rename(year=name, relgrowth=value) %>% 
  pivot_longer(c(PC1, PC2, AHM:SHM, x:monsoonality))
provenance_climvars <- unique(dbh_relgrowth_clim_long$name)

dbh_relgro_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relgrowth) ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
    
mod_nog <- lmer(sqrt(relgrowth) ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal


dbh_relgro_mods <- bind_rows(dbh_relgro_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, cr2= Cr2, mr2 = Mr2, pvalue_nog = pvalue_nog, cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_relgro_mods %>% arrange(pvalue_nog)

###quadratic

dbh_relgro_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relgrowth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_relgrowth_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(sqrt(relgrowth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_relgrowth_clim_long %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

dbh_relgro_mods_quad <- bind_rows(dbh_relgro_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_relgro_mods_quad %>% arrange(pvalue2_nog) #just y significant


##latitude model
lat_dbh_relgrowth_mod_nog <- lmer(sqrt(relgrowth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_relgrowth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y"))
plot(lat_dbh_relgrowth_mod_nog)
qqmath(lat_dbh_relgrowth_mod_nog)
summary(lat_dbh_relgrowth_mod_nog)
r2(lat_dbh_relgrowth_mod_nog)

lat_dbh_relgrowth_mod_nog_lm <- lm(sqrt(relgrowth) ~ value + I(value^2), data=dbh_relgrowth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y"))

newdata_lat_dbh_relgrowth_nog <-  expand.grid(value=seq(dbh_relgrowth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% min(), dbh_relgrowth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% max(),1))
lat_dbh_relgrowth_predict_nog <- predict(lat_dbh_relgrowth_mod_nog_lm, newdata = newdata_lat_dbh_relgrowth_nog, interval="confidence")

predictdata_lat_dbh_relgrowth_nog <- cbind(newdata_lat_dbh_relgrowth_nog, lat_dbh_relgrowth_predict_nog) %>% mutate(var="Latitude")

##latitude model - with Gila NF
lat_dbh_relgrowth_mod <- lmer(sqrt(relgrowth) ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_relgrowth_clim_long %>% filter(name=="y"))
plot(lat_dbh_relgrowth_mod)
qqmath(lat_dbh_relgrowth_mod)
summary(lat_dbh_relgrowth_mod)
r2(lat_dbh_relgrowth_mod)

lat_dbh_relgrowth_mod_lm <- lm(sqrt(relgrowth) ~ value + I(value^2), data=dbh_relgrowth_clim_long %>% filter(name=="y"))

newdata_lat_dbh_relgrowth <-  expand.grid(value=seq(dbh_relgrowth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% min(), dbh_relgrowth_clim_long %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(value) %>% max(),1))
lat_dbh_relgrowth_predict <- predict(lat_dbh_relgrowth_mod_lm, newdata = newdata_lat_dbh_relgrowth, interval="confidence")

predictdata_lat_dbh_relgrowth <- cbind(newdata_lat_dbh_relgrowth, lat_dbh_relgrowth_predict) %>% mutate(var="Latitude")

predictdata_lat_dbh_relgrowth_all <- bind_rows(predictdata_lat_dbh_relgrowth %>% mutate(model="with Gila NF", pvalue=summary(lat_dbh_relgrowth_mod)$coefficient[3,5]), predictdata_lat_dbh_relgrowth_nog %>% mutate(model="without Gila NF", pvalue=summary(lat_dbh_relgrowth_mod_nog)$coefficient[3,5]))

ggplot()+
  geom_ribbon(data=predictdata_lat_dbh_relgrowth_all, aes(x=value, ymin=lwr^2, ymax=upr^2, fill=model), alpha=0.2)+
  geom_line(data=predictdata_lat_dbh_relgrowth_all, aes(x=value,y=fit^2, color=model))+
  geom_rug(data=dbh_relgrowth_clim_long %>% filter(name=="y") %>% mutate(fit=15), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  scale_color_manual(values=c("darkgrey","black"))+
  scale_fill_manual(values = c("darkgrey","black"))+
  xlab("Provenance Latitude")+
  ylab("Relative DBH growth rate (%/yr)")+
  facet_grid(~var)+
  theme_bw()

```

#####transfer distance
```{r}

dbh_relgrowth_clim_long_transfer <- dbh_relgrowth_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - value))

dbh_relgrowth_clim_long_transfer_nog <- dbh_relgrowth_clim_long_transfer %>% filter(!Provenance=="Gila NF")

dbh_relgrowth_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(sqrt(relgrowth) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(sqrt(relgrowth) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

dbh_relgrowth_mods_transfer <- bind_rows(dbh_relgrowth_mods_transfer, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

dbh_relgrowth_mods_transfer %>% arrange(pvalue_nog) #just lat significant without Gila


#latitude
ggplot(data = dbh_relgrowth_clim_long_transfer_nog %>% filter(name=="y"), aes(x=diff_plant, y=relgrowth))+
  geom_point()+
  facet_wrap(~year)

dbh_relgrowth_y_transfermod_nog <- lmer(sqrt(relgrowth) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))
plot(dbh_relgrowth_y_transfermod_nog)
qqmath(dbh_relgrowth_y_transfermod_nog)
summary(dbh_relgrowth_y_transfermod_nog) #further away from plantation in latitude = less relative growth


dbh_relgrowth_y_transfermod_nog_lm <- lm(sqrt(relgrowth) ~ diff_plant, data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))

newdata_lat_dbh_relgrowth_transfer <-  expand.grid(diff_plant=seq(dbh_relgrowth_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(diff_plant) %>% min(), dbh_relgrowth_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% pull(diff_plant) %>% max(),1))
dbh_relgrowth_y_transfer_predict <- predict(dbh_relgrowth_y_transfermod_nog_lm, newdata = newdata_lat_dbh_relgrowth_transfer, interval="confidence")

predictdata_lat_dbh_relgrowth_transfer <- cbind(newdata_lat_dbh_relgrowth_transfer, dbh_relgrowth_y_transfer_predict) %>% mutate(var="Latitude")

ggplot()+
  geom_ribbon(data=predictdata_lat_dbh_relgrowth_transfer, aes(x=diff_plant, ymin=lwr^2, ymax=upr^2), alpha=0.2)+
  geom_line(data=predictdata_lat_dbh_relgrowth_transfer, aes(x=diff_plant,y=fit^2), color="black")+
  geom_rug(data=dbh_relgrowth_clim_long_transfer_nog %>% filter(!Provenance == "Gila NF") %>% filter(name=="y") %>% mutate(fit=20), aes(x=diff_plant,y=fit), linewidth=1, col="black", sides="b")+
  xlab("Difference in latitude from plantation")+
  ylab("Relativized DBH growth rate (%/yr)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")

#####look at latitude effect for each growth period separately
dbh_relgrowth_y_transfermod_nog14 <- lmer(sqrt(relgrowth) ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name=="y"&year=="relareagrowth14") %>% filter(!Provenance=="Gila NF"))
summary(dbh_relgrowth_y_transfermod_nog14) ###no significant effect of latitude difference in 2014.

dbh_relgrowth_y_transfermod_nog06 <- lmer(sqrt(relgrowth) ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name=="y"&year=="relareagrowth06") %>% filter(!Provenance=="Gila NF"))
summary(dbh_relgrowth_y_transfermod_nog06)

dbh_relgrowth_y_transfermod_nog96 <- lmer(sqrt(relgrowth) ~ diff_plant + (1|Provenance)+ (1|BLK), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name=="y"&year=="relareagrowth96") %>% filter(!Provenance=="Gila NF"))
summary(dbh_relgrowth_y_transfermod_nog96)


##distance in 2d climate space

dbh_relgrowth_climdist_df <- dbh_relgrowth_clim_long_transfer %>% 
  dplyr::select(Provenance, LOC,BLK, REP, year, relgrowth, name, diff_plant) %>% 
  filter(name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
dbh_relgrowth_climdist_mod <- lmer(sqrt(relgrowth) ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_climdist_df)
plot(dbh_relgrowth_climdist_mod)
qqmath(dbh_relgrowth_climdist_mod)
summary(dbh_relgrowth_climdist_mod) #not significant 

```


##Height 

```{r}

ht_data <- moniger_data_comb %>% 
  filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  mutate(growth.m = (value-nursery_ht_m), rel.growth = (value-nursery_ht_m)/nursery_ht_m) %>% 
  filter(!is.na(value))

ht_data_clim <- ht_data %>% 
  left_join(prov_pcapts_big)

ht.order <- ht_data %>% 
  filter(name=="HT14") %>% 
  group_by(Provenance) %>% 
  summarise(med_rel_growth=median(rel.growth,na.rm=T), med_growth=median(growth.m, na.rm=T), meanht = mean(value, na.rm=T)) %>% 
  arrange(meanht)

ht_data_aves <- ht_data %>% filter(!name=="HT74") %>% 
  group_by(name, Provenance,nursery_ht_m ) %>% 
  summarise(meangrowth = mean(growth.m), seRG = sd(growth.m)/sqrt(n()), meantotht = mean(value), seTH = sd(value)/sqrt(n()))

```

```{r}
ht_data_year <-  ht_data %>% mutate(year=case_when(
  name=="HT74" ~ 1974,
  name == "HT79" ~ 1979,
  name == "HT85" ~ 1985,
  name == "HT91" ~ 1991,
  name == "HT96" ~ 1996,
  name == "HT06" ~ 2006,
  name == "HT14" ~ 2014))
```


###nursery height

```{r}

nursery_ht_clim <- ht_data_clim %>% 
  dplyr::select(c(Provenance, nursery_ht_m, PC1,PC2, AHM:SHM, x:monsoonality)) %>% 
  unique() %>% 
  pivot_longer(PC1:monsoonality)

nursery_climvars <- unique(nursery_ht_clim$name)
nursery_lms <- data.frame()
for(i in 1:length(nursery_climvars)){
  mod <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == nursery_climvars[i]))
  pvalue <- as.data.frame(summary(mod)$coefficients)$`Pr(>|t|)`[2]
  mod_nog <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == nursery_climvars[i]) %>% filter(!Provenance == "Gila NF"))
  pvalue_nog <- as.data.frame(summary(mod_nog)$coefficients)$`Pr(>|t|)`[2]
  nursery_lms <- bind_rows(nursery_lms, data.frame(nursery_climvars=nursery_climvars[i],pvalue,pvalue_nog))
}
nursery_lms %>% arrange(pvalue)  #smrpb significant with and without Gila NF

##smrpb
smrpb_nht_mod <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == "smrpb"))
summary(smrpb_nht_mod)
par(mfrow=c(2,2))
plot(smrpb_nht_mod)

smrpb_nht_point_data <- nursery_ht_clim %>% filter(name == "smrpb")  %>% rename(predicted=nursery_ht_m)
  
plot(ggpredict(smrpb_nht_mod))+
  geom_point(data=smrpb_nht_point_data, aes(x=value, y=predicted))+
  theme_bw()+
  theme(axis.text=element_text(color="black", size=12), axis.title=element_text(color="black", size=12))+
  xlab("Summer to Spring Precip Ratio")+
  ylab("Nursery Height (m)")+
  ggtitle("Nursery Height")
  

smrpb_nht_mod_nog <- lm(nursery_ht_m ~ value, data=nursery_ht_clim %>% filter(name == "smrpb") %>% filter(!Provenance=="Gila NF"))
summary(smrpb_nht_mod_nog)
par(mfrow=c(2,2))
plot(smrpb_nht_mod_nog)
plot(ggpredict(smrpb_nht_mod_nog))


ggarrange(ggplot(data=nursery_ht_clim %>% filter(name=="smrpb"), aes(x=value, y=nursery_ht_m))+
  geom_point()+
  geom_smooth(method="lm")+
  theme_bw()+
  xlab("Summer Precip Ratio")+
  ylab("Nursery Height (m)")+
    ggtitle("with Gila"),
ggplot(data=nursery_ht_clim %>% filter(name=="smrpb" & !Provenance=="Gila NF"), aes(x=value, y=nursery_ht_m))+
  geom_point()+
  geom_smooth(method="lm")+
  theme_bw()+
  xlab("Summer Precip Ratio")+
  ylab("Nursery Height (m)")+
  ggtitle("without Gila"), nrow=2)

nursery_lms_quad <- data.frame()
for(i in 1:length(nursery_climvars)){
  mod <- lm(nursery_ht_m ~ value + I(value^2), data=nursery_ht_clim %>% filter(name == nursery_climvars[i]))
  pvalue <- as.data.frame(summary(mod)$coefficients)$`Pr(>|t|)`[2:3]
  mod_nog <- lm(nursery_ht_m ~ value + I(value^2), data=nursery_ht_clim %>% filter(name == nursery_climvars[i]) %>% filter(!Provenance == "Gila NF"))
  pvalue_nog <- as.data.frame(summary(mod_nog)$coefficients)$`Pr(>|t|)`[2:3]
  nursery_lms_quad <- bind_rows(nursery_lms_quad, data.frame(nursery_climvars=nursery_climvars[i],pvalue=pvalue[1], pvalue2 = pvalue[2],pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2]))
}
nursery_lms_quad %>% arrange(pvalue_nog2) #just y has quadratic effect

```


```{r}
##effect of initial nursery height

ggplot(data=ht_data_year %>% filter(!Provenance=="Gila NF"), aes(x=nursery_ht_m, y=log(value)))+
  geom_smooth(method="lm")+
  theme_bw()+
  ylab("Log(Height)")+
  xlab("Nursery Height(m)")


#1974
nurse_ht_mod74 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT74"))
plot(nurse_ht_mod74)
qqmath(nurse_ht_mod74)
summary(nurse_ht_mod74)  ##significant 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT74") %>% filter(!Provenance=="Gila NF")))

#1979
nurse_ht_mod79 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT79"))
plot(nurse_ht_mod79)
qqmath(nurse_ht_mod79)
summary(nurse_ht_mod79)  ##no effect of nursery height on total height in 1979 
summary(lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT79") %>% filter(!Provenance=="Gila NF"))) ##there is an effect when Gila is removed
r2(lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT79") %>% filter(!Provenance=="Gila NF"))) ##marginal r2 is very low

#1985
nurse_ht_mod85 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT85"))
plot(nurse_ht_mod85)
qqmath(nurse_ht_mod85)
summary(nurse_ht_mod85)  ##no effect of nursery height on total height in 1985 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT85") %>% filter(!Provenance=="Gila NF")))##there is an effect when Gila is removed

#1991
nurse_ht_mod91 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT91"))
plot(nurse_ht_mod91)
qqmath(nurse_ht_mod91)
summary(nurse_ht_mod91)  ##no effect of nursery height on total height in 1991 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT91") %>% filter(!Provenance=="Gila NF"))) ##there is an effect when Gila is removed

#1996
nurse_ht_mod96 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT96"))
plot(nurse_ht_mod96)
qqmath(nurse_ht_mod96)
summary(nurse_ht_mod96)  ##no effect of nursery height on total height in 1996 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT96") %>% filter(!Provenance=="Gila NF"))) ##there is an effect when Gila is removed

#2006
nurse_ht_mod06 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT06"))
plot(nurse_ht_mod06)
qqmath(nurse_ht_mod06)
summary(nurse_ht_mod06)  ##no effect of nursery height on total height in 2006 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT06") %>% filter(!Provenance=="Gila NF"))) #significant without Gila

#2014
nurse_ht_mod14 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT14"))
plot(nurse_ht_mod14)
qqmath(nurse_ht_mod14)
summary(nurse_ht_mod14)  ##no effect of nursery height on total height in 2014. 
summary(lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT14") %>% filter(!Provenance=="Gila NF"))) #only marginally significant without Gila
```

###absolute height

#### ANOVA
```{r}
##effect of year * provenance
totht_mod <- lmer(log(value) ~ Provenance*year + (1|BLK), data=ht_data_year)
plot(totht_mod)
qqmath(totht_mod)
Anova(totht_mod, type="3") ##there is a significant year by provenance interaction

totht_mod_lm <- lm(log(value) ~ Provenance*year, data=ht_data_year)

#no gila
totht_mod_nog <- lmer(log(value) ~ Provenance*year + (1|BLK), data=ht_data_year %>% filter(!Provenance=="Gila NF"))
plot(totht_mod_nog)
qqmath(totht_mod_nog)
Anova(totht_mod_nog, type="3") ##there is a significant year by provenance interaction
####

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meantotht-seTH, ymax=meantotht+seTH, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Total Height (m)")

ht_data_aves_forfig <- ht_data_aves %>% 
  bind_rows(data.frame(name="HT74",Provenance="Gila NF", meantotht=NA, seTH=NA))

ht_means_fig <- ggplot(ht_data_aves_forfig, aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meantotht, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meantotht-seTH, ymax=meantotht+seTH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean Height (m)")

##just 2014
ggplot(ht_data_aves_forfig %>% filter(name=="HT14"), aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meantotht, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meantotht-seTH, ymax=meantotht+seTH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean Height (m)")+
  theme_bw()+
  theme(axis.text=element_text(color="black", size=12), axis.title=element_text(color="black", size=12))
#######
#each year separately
totht_mod74 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
anova(totht_mod74)
rand(totht_mod74)
totht_mod74_marg = lsmeans(totht_mod74, ~ Provenance)

CLD_totht_mod74 = cld(totht_mod74_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod74

totht_mod79 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT79"))
plot(totht_mod79)
anova(totht_mod79)
rand(totht_mod79)
totht_mod79_marg = lsmeans(totht_mod79, ~ Provenance)

CLD_totht_mod79 = cld(totht_mod79_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod79

totht_mod85 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT85"))
plot(totht_mod85)
anova(totht_mod85)
rand(totht_mod85)
totht_mod85_marg = lsmeans(totht_mod85, ~ Provenance)

CLD_totht_mod85 = cld(totht_mod85_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod85

totht_mod91 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT91"))
plot(totht_mod91)
anova(totht_mod91)
rand(totht_mod91)
totht_mod91_marg = lsmeans(totht_mod91, ~ Provenance)

CLD_totht_mod91 = cld(totht_mod91_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod91

totht_mod96 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT96"))
plot(totht_mod96)
anova(totht_mod96)
rand(totht_mod96)
totht_mod96_marg = lsmeans(totht_mod96, ~ Provenance)

CLD_totht_mod96 = cld(totht_mod96_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod96

totht_mod06 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT06"))
plot(totht_mod06)
anova(totht_mod06)
rand(totht_mod06)
totht_mod06_marg = lsmeans(totht_mod06, ~ Provenance)

CLD_totht_mod06 = cld(totht_mod06_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod06

ht_data14<- ht_data %>% filter(name=="HT14") %>% 
  mutate(Provenance=as.factor(Provenance))

totht_mod14 <- lmer(value ~ Provenance + (1|BLK), data=ht_data14)
plot(totht_mod14)
Anova(totht_mod14, type="3")
rand(totht_mod14)
totht_mod14_marg = lsmeans(totht_mod14, ~ Provenance)

CLD_totht_mod14 = cld(totht_mod14_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod14

totht14_letter_df<- as.data.frame(CLD_totht_mod14) %>% 
  rename(letters = `.group`)
#########

###2014 plot
prov_ht_order14<- ht_data14 %>% 
  group_by(Provenance) %>% 
  summarise(mean_ht = mean(value, na.rm=T)) %>% 
  arrange(mean_ht)

ht_letters_plot<- ggplot(ht_data14, aes(x=factor(Provenance, levels=prov_ht_order14$Provenance), y=value, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  geom_text(data=totht14_letter_df, aes(x=Provenance, y= 17, label=letters), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ylab("Height (m)")+
  theme(axis.text.x=element_text(angle=45, hjust=1, color="black",size=14), axis.text.y=element_text(color="black",size=14),axis.title.y=element_text(color="black",size=14), axis.title.x=element_blank(), legend.position = "none")
  
ht_letters_plot
```

####PC only mods
```{r}
ht_data_year_clim <- ht_data_year %>% 
  left_join(prov_pcapts_big)
ht_data_year_clim_noG <- ht_data_year_clim %>% 
  filter(!Provenance=="Gila NF"
         )
mod_ht_pca <- lmer(log(value) ~ PC1*PC2 +  I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim)
plot(mod_ht_pca)
qqmath(mod_ht_pca)
summary(mod_ht_pca)
# mod_ht_pca_dredge<- dredge(mod_ht_pca)
# mod_ht_pca_dredge #null is best

#no gila

mod_ht_pca_noG <- lmer(log(value) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_noG)
plot(mod_ht_pca_noG)
qqmath(mod_ht_pca_noG)
summary(mod_ht_pca_noG)
# mod_ht_pca_noG_dredge<- dredge(mod_ht_pca_noG)
# mod_ht_pca_noG_dredge #null is best
```


####individual climate var models

```{r}
ht_data_year_clim_long <- ht_data_year_clim %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality), names_to = "climvar.name", values_to = "climvar.value")

ht_data_year_clim_long_noG <- ht_data_year_clim_noG %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality), names_to = "climvar.name", values_to = "climvar.value")

provenance_climvars <- unique(ht_data_year_clim_long$climvar.name)   
  
ht_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + (1|Provenance)+(1|BLK) + (1|year), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`

ht_mods <- bind_rows(ht_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, pvalue_nog = pvalue_nog))

}

ht_mods %>% arrange(pvalue_nog) ##y significant

###quadratic

ht_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long %>% filter(climvar.name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`

mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK), data=ht_data_year_clim_long_noG %>% filter(climvar.name==provenance_climvars[i]))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`

ht_mods_quad <- bind_rows(ht_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2]))

}

ht_mods_quad %>% arrange(pvalue2_nog) #nothing significant when Gila is taken out, except y

##latitude model
lat_ht_mod_nog <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_long_noG %>% filter(climvar.name=="y"))
plot(lat_ht_mod_nog)
qqmath(lat_ht_mod_nog)
summary(lat_ht_mod_nog)
r2(lat_ht_mod_nog)

lat_ht_mod_nog_lm <- lm(log(value) ~ climvar.value + I(climvar.value^2), data=ht_data_year_clim_long_noG %>% filter(climvar.name=="y"))

newdata_lat_ht_nog <-  expand.grid(climvar.value=seq(ht_data_year_clim_long_noG %>% filter(climvar.name=="y") %>% pull(climvar.value) %>% min(), ht_data_year_clim_long_noG %>% filter(climvar.name=="y") %>% pull(climvar.value) %>% max(),1))
lat_ht_predict_nog <- predict(lat_ht_mod_nog_lm, newdata = newdata_lat_ht_nog, interval="confidence")

predictdata_lat_ht_nog <- cbind(newdata_lat_ht_nog, lat_ht_predict_nog) %>% mutate(var="Latitude")

##latitude model - with Gila NF
lat_ht_mod <- lmer(log(value) ~ climvar.value + I(climvar.value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_long %>% filter(climvar.name=="y"))
plot(lat_ht_mod)
qqmath(lat_ht_mod)
summary(lat_ht_mod)
r2(lat_ht_mod)

lat_ht_mod_lm <- lm(log(value) ~ climvar.value + I(climvar.value^2), data=ht_data_year_clim_long %>% filter(climvar.name=="y"))

newdata_lat_ht <-  expand.grid(climvar.value=seq(ht_data_year_clim_long %>% filter(climvar.name=="y") %>% pull(climvar.value) %>% min(), ht_data_year_clim_long %>% filter(climvar.name=="y") %>% pull(climvar.value) %>% max(),1))
lat_ht_predict <- predict(lat_ht_mod_lm, newdata = newdata_lat_ht, interval="confidence")

predictdata_lat_ht <- cbind(newdata_lat_ht, lat_ht_predict) %>% mutate(var="Latitude")

predictdata_lat_ht_all <- bind_rows(predictdata_lat_ht_nog %>% mutate(model="without Gila NF", pvalue = summary(lat_ht_mod_nog)$coefficient[3,5]), predictdata_lat_ht %>% mutate(model="with Gila NF", pvalue = summary(lat_ht_mod)$coefficient[3,5]))

ggplot()+
  geom_ribbon(data=predictdata_lat_ht_all, aes(x=climvar.value, ymin=exp(lwr), ymax=exp(upr), fill=model), alpha=0.2)+
  geom_line(data=predictdata_lat_ht_all, aes(x=climvar.value,y=exp(fit), color=model))+
  geom_rug(data=ht_data_year_clim_long_noG %>% filter(climvar.name=="y") %>% mutate(fit=2), aes(x=climvar.value,y=fit), linewidth=1, col="black", sides="b")+
  scale_color_manual(values=c("darkgrey","black"))+
  scale_fill_manual(values=c("darkgrey","black"))+
  xlab("Provenance Latitude")+
  ylab("Absolute Height")+
  facet_grid(~var)+
  theme_bw()

```


#####transfer distance
```{r}

ht_clim_long_transfer <- ht_data_year_clim_long %>%
  left_join(plantation_climNA, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value))

ht_clim_long_transfer_nog <- ht_clim_long_transfer %>% filter(!Provenance=="Gila NF")

ht_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(value) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=ht_clim_long_transfer %>% filter(climvar.name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(value) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=ht_clim_long_transfer_nog %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

ht_mods_transfer <- bind_rows(ht_mods_transfer, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

ht_mods_transfer %>% arrange(pvalue_nog) #just latitude without Gila, but not significant with Gila

#latitude
ggplot(data = ht_clim_long_transfer_nog%>% filter(climvar.name=="y"), aes(x=diff_plant, y=value))+
  geom_point()+
  facet_wrap(~year)

ht_lat_transfermod_nog <- lmer(log(value) ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=ht_clim_long_transfer_nog %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF"))
plot(ht_lat_transfermod_nog)
qqmath(ht_lat_transfermod_nog)
summary(ht_lat_transfermod_nog) #further away from plantation in latitude = taller

ggplot(data = ht_clim_long_transfer_nog%>% filter(climvar.name=="y"), aes(x=diff_plant, y=value))+
  geom_smooth(method="lm")+
  theme_bw()+
  xlab("Difference in latitude from plantation")+
  ylab("Absolute Height")


##distance in 2d climate space

ht_climdist_df <- ht_clim_long_transfer %>% 
  dplyr::select(Provenance, LOC,BLK, REP, year, value, climvar.name, diff_plant) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  rename(ht = value) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
ht_climdist_mod <- lmer(log(ht) ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=ht_climdist_df)
plot(ht_climdist_mod)
qqmath(ht_climdist_mod)
summary(ht_climdist_mod) #not significant

```

### height growth

```{r}
# growth

ht_growth_data<- moniger_data_comb %>% 
    filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  mutate(growth79=(HT79-HT74)/5, growth85 = (HT85-HT79)/6, growth91 = (HT91-HT85)/6, growth96=(HT96-HT91)/5, growth06=(HT06-HT96)/10, growth14=(HT14-HT06)/8) %>% 
  pivot_longer(growth79:growth14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  filter(!is.na(value))

ggplot(ht_growth_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79","growth85","growth91","growth96","growth06","growth14"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab(" Height Growth Per Year (m)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##who had overall highest  growth rates across years?
ggplot(ht_growth_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab(" Height Growth Per Year (m)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##look at trend in  height growth rate over time for trees that survived until 2014
ggplot(ht_growth_data %>% filter(!is.na(HT14)), aes(x=factor(name, levels=c("growth79","growth85","growth91","growth96","growth06","growth14"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(Provenance,levels=provs_bylat$Provenance))+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab(" Height Growth Per Year (m)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##look at trend over time for each provenance
htgrowth_time<- ht_growth_data %>% 
  mutate(period = case_when(name=="growth79" ~ 1,
                            name=="growth85" ~ 2,
                            name=="growth91" ~ 3,
                            name=="growth96" ~ 4,
                            name=="growth06" ~ 5,
                            name=="growth14" ~ 6))

htgrowth_overtime <- lmer(value ~ period*Provenance + (1|BLK), data=htgrowth_time)
summary(htgrowth_overtime)
anova(htgrowth_overtime)

gila_htgrowth_mod <- lmer(value ~ period + (1|BLK), data=htgrowth_time %>% filter(Provenance=="Gila NF"))
summary(gila_htgrowth_mod) #positive trend over time in  growth for Gila
```

####ANOVA
```{r}
hg <- lmer(value ~ Provenance*name + (1|BLK), data=ht_growth_data)
anova(hg)

###differences between provenances in height increment each year
##1979
HGmod79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(name=="growth79"))
plot(HGmod79)
qqmath(HGmod79)
anova(HGmod79)
rand(HGmod79)
HGmod79_marg = lsmeans(HGmod79, ~Provenance)

CLD_HGmod79 = cld(HGmod79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod79

##1985
HGmod85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(name=="growth85"))
plot(HGmod85)
qqmath(HGmod85)
anova(HGmod85)
rand(HGmod85)
HGmod85_marg = lsmeans(HGmod85, ~Provenance)

CLD_HGmod85 = cld(HGmod85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod85

##1991
HGmod91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(name=="growth91"))
plot(HGmod91)
qqmath(HGmod91)
anova(HGmod91)
rand(HGmod91)
HGmod91_marg = lsmeans(HGmod91, ~Provenance)

CLD_HGmod91 = cld(HGmod91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod91

##1996
HGmod96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(name=="growth96"))
plot(HGmod96)
qqmath(HGmod96)
anova(HGmod96) 
rand(HGmod96)
HGmod96_marg = lsmeans(HGmod96, ~Provenance)

CLD_HGmod96 = cld(HGmod96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod96 

##2006
HGmod06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(name=="growth06"))
plot(HGmod06)
qqmath(HGmod06)
anova(HGmod06)
rand(HGmod06)
HGmod06_marg = lsmeans(HGmod06, ~Provenance)

CLD_HGmod06 = cld(HGmod06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod06 

##2014
HGmod14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(name=="growth14"))
plot(HGmod14)
qqmath(HGmod14)
anova(HGmod14)
rand(HGmod14)
HGmod14_marg = lsmeans(HGmod14, ~Provenance)

CLD_HGmod14 = cld(HGmod14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod14 ##most are gaining around the same height by 2014 (perhaps because they are slowing down?)
```

#####survivors only

```{r}
##########################

###differences between provenances in height increment each year ***SURVIVORS ONLY***
##1979
HGmod_SO_79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(!is.na(HT14)) %>% filter(name=="growth79"))
plot(HGmod_SO_79)
qqmath(HGmod_SO_79)
anova(HGmod_SO_79)
rand(HGmod_SO_79)
HGmod_SO_79_marg = lsmeans(HGmod_SO_79, ~Provenance)

CLD_HGmod_SO_79 = cld(HGmod_SO_79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_79

##1985
HGmod_SO_85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(!is.na(HT14)) %>% filter(name=="growth85"))
plot(HGmod_SO_85)
qqmath(HGmod_SO_85)
anova(HGmod_SO_85)
rand(HGmod_SO_85)
HGmod_SO_85_marg = lsmeans(HGmod_SO_85, ~Provenance)

CLD_HGmod_SO_85 = cld(HGmod_SO_85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_85

##1991
HGmod_SO_91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(!is.na(HT14)) %>% filter(name=="growth91"))
plot(HGmod_SO_91)
qqmath(HGmod_SO_91)
anova(HGmod_SO_91)
rand(HGmod_SO_91)
HGmod_SO_91_marg = lsmeans(HGmod_SO_91, ~Provenance)

CLD_HGmod_SO_91 = cld(HGmod_SO_91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_91

##1996
HGmod_SO_96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(!is.na(HT14)) %>% filter(name=="growth96"))
plot(HGmod_SO_96)
qqmath(HGmod_SO_96)
anova(HGmod_SO_96)
rand(HGmod_SO_96)
HGmod_SO_96_marg = lsmeans(HGmod_SO_96, ~Provenance)

CLD_HGmod_SO_96 = cld(HGmod_SO_96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_96

##2006
HGmod_SO_06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(!is.na(HT14)) %>% filter(name=="growth06"))
plot(HGmod_SO_06)
qqmath(HGmod_SO_06)
anova(HGmod_SO_06)
rand(HGmod_SO_06)
HGmod_SO_06_marg = lsmeans(HGmod_SO_06, ~Provenance)

CLD_HGmod_SO_06 = cld(HGmod_SO_06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_06 

##2014
HGmod_SO_14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_data %>% filter(!is.na(HT14)) %>% filter(name=="growth14"))
plot(HGmod_SO_14)
qqmath(HGmod_SO_14)
anova(HGmod_SO_14)
rand(HGmod_SO_14)
HGmod_SO_14_marg = lsmeans(HGmod_SO_14, ~Provenance)

CLD_HGmod_SO_14 = cld(HGmod_SO_14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_14
```

####PC only mods
```{r}
ht_growth_clim<- ht_growth_data %>% 
  left_join(prov_pcapts_big)

mod_ht_pca <- lmer(value ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_clim)
plot(mod_ht_pca)
qqmath(mod_ht_pca)
summary(mod_ht_pca)
 # mod_ht_pca_dredge<- dredge(mod_ht_pca)
 # mod_ht_pca_dredge  ##null is best

#no gila
ht_growth_clim_noG<- ht_growth_clim %>% filter(!Provenance=="Gila NF")

mod_ht_pca_noG <- lmer(value ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_clim_noG)
plot(mod_ht_pca_noG)
qqmath(mod_ht_pca_noG)
summary(mod_ht_pca_noG)
# mod_ht_pca_noG_dredge<- dredge(mod_ht_pca_noG)
# mod_ht_pca_noG_dredge #null is best
```

####individual climate variables

```{r}

ht_growth_clim_long <- ht_growth_clim %>% 
  dplyr::rename(year=name, htgrowth=value) %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality))

ht_growth_clim_long_nog <- ht_growth_clim_long %>% filter(!Provenance=="Gila NF")

htgrowth_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(htgrowth ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(htgrowth ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_clim_long_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

htgrowth_mods <- bind_rows(htgrowth_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

htgrowth_mods %>% arrange(pvalue_nog) #nothing significant
```

```{r}
###quadratic

htgrowth_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(htgrowth ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(htgrowth ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_clim_long_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

htgrowth_mods_quad <- bind_rows(htgrowth_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))
}

htgrowth_mods_quad %>% arrange(pvalue2_nog) #just y

##y
y_htgrowth_mod <- lmer(htgrowth ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_clim_long %>% filter(name=="y"))
plot(y_htgrowth_mod)
qqmath(y_htgrowth_mod)
y_htgrowth_mod_nog <- lmer(htgrowth ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_clim_long_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))
plot(y_htgrowth_mod_nog)
qqmath(y_htgrowth_mod_nog)

####make plot 
##with Gila
y_htgrowth_mod_lm <- lm(htgrowth ~  value + I(value^2), data=ht_growth_clim_long %>% filter(name=="y"))

newdata_y_htgrowth <-  expand.grid(value=seq(min(ht_growth_clim$y), max(ht_growth_clim$y), length.out=50))
y_htgrowth_predict <- predict(y_htgrowth_mod_lm, newdata = newdata_y_htgrowth, interval="confidence")

predictdata_y_htgrowth <- cbind(newdata_y_htgrowth, y_htgrowth_predict) %>% mutate(var="y", model="with Gila NF", pvalue=summary(y_htgrowth_mod)$coefficient[3,5])

##without Gila 
y_htgrowth_mod_lm_nog <- lm(htgrowth ~  value + I(value^2), data=ht_growth_clim_long_nog %>% filter(name=="y"))

newdata_y_htgrowth_nog <-  expand.grid(value=seq(min(ht_growth_clim_noG$y), max(ht_growth_clim_noG$y), length.out=50))
y_htgrowth_predict_nog <- predict(y_htgrowth_mod_lm_nog, newdata = newdata_y_htgrowth_nog, interval="confidence")

predictdata_y_htgrowth_nog <- cbind(newdata_y_htgrowth_nog, y_htgrowth_predict_nog) %>% mutate(var="y", model="without Gila NF", pvalue=summary(y_htgrowth_mod_nog)$coefficient[3,5])

predictdata_y_htgrowth_all <- bind_rows(predictdata_y_htgrowth,predictdata_y_htgrowth_nog)

ggplot()+
  geom_ribbon(data=predictdata_y_htgrowth_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_y_htgrowth_all, aes(x=value,y=fit, color=model))+
  geom_rug(data=ht_growth_clim_long %>% filter(name=="y") %>% mutate(fit=.2), aes(x=value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab(" Height Growth Rate (m/year)")+
  theme_bw()+
  theme(legend.position="right")
```

#####transfer distance
```{r}

htgrowth_clim_long_transfer <- ht_growth_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - value))

htgrowth_clim_long_transfer_nog <- htgrowth_clim_long_transfer %>% filter(!Provenance=="Gila NF")

htgrowth_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(htgrowth ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=htgrowth_clim_long_transfer %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(htgrowth ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=htgrowth_clim_long_transfer_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

htgrowth_mods_transfer <- bind_rows(htgrowth_mods_transfer, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

htgrowth_mods_transfer %>% arrange(pvalue_nog) #y

#y
htgrowth_y_transfermod_nog <- lmer(htgrowth ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=htgrowth_clim_long_transfer_nog %>% filter(name=="y"))
plot(htgrowth_y_transfermod_nog)
qqmath(htgrowth_y_transfermod_nog)
summary(htgrowth_y_transfermod_nog) #provenances with similar y to the plantation had lower growth rates

##distance in 2d climate space

htgrowth_climdist_df <- htgrowth_clim_long_transfer %>% 
  dplyr::select(Provenance, LOC,BLK, REP, year, htgrowth, name, diff_plant) %>% 
  filter(name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
htgrowth_climdist_mod <- lmer(htgrowth ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=htgrowth_climdist_df)
plot(htgrowth_climdist_mod)
qqmath(htgrowth_climdist_mod)
summary(htgrowth_climdist_mod) #not significant

```

###relative height growth

```{r}
#relative growth

ht_growth_rel_data<- moniger_data_comb %>% 
    filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  mutate(growth79=HT79-HT74, growth85 = HT85-HT79, growth91 = HT91-HT85, growth96=HT96-HT91, growth06=HT06-HT96, growth14=HT14-HT06) %>% 
  mutate(growth79rel=(growth79/HT74*100)/5, growth85rel=(growth85/HT79*100)/6, growth91rel=(growth91/HT85*100)/6, growth96rel=(growth96/HT91*100)/5, growth06rel=(growth06/HT96*100)/10, growth14rel=(growth14/HT06*100)/8) %>% 
  pivot_longer(growth79rel:growth14rel) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  filter(!is.na(value))

ht_increment_rel_plot<- ggplot(ht_growth_rel_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")
ht_increment_rel_plot

##who had overall highest relative growth rates across years?
ggplot(ht_growth_rel_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##look at trend in relative height growth rate over time for trees that survived until 2014
ggplot(ht_growth_rel_data %>% filter(!is.na(HT14)), aes(x=factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(Provenance,levels=provs_bylat$Provenance))+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##look at trend over time for each provenance
relhtgrowth_time<- ht_growth_rel_data %>% 
  mutate(period = case_when(name=="growth79rel" ~ 1,
                            name=="growth85rel" ~ 2,
                            name=="growth91rel" ~ 3,
                            name=="growth96rel" ~ 4,
                            name=="growth06rel" ~ 5,
                            name=="growth14rel" ~ 6))

relht_overtime <- lmer(value ~ period*Provenance + (1|BLK), data=relhtgrowth_time)
summary(relht_overtime)
anova(relht_overtime)

gila_relht_mod <- lmer(value ~ period + (1|BLK), data=relhtgrowth_time %>% filter(Provenance=="Gila NF"))
summary(gila_relht_mod) #no trend over time in relative growth for Gila
```

####ANOVA
```{r}
relhg <- lmer(value ~ Provenance*name + (1|BLK), data=ht_growth_rel_data)
anova(relhg)

###differences between provenances in height increment each year
##1979
HGmod79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth79rel"))
plot(HGmod79)
qqmath(HGmod79)
anova(HGmod79)
rand(HGmod79)
HGmod79_marg = lsmeans(HGmod79, ~Provenance)

CLD_HGmod79 = cld(HGmod79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod79

##1985
HGmod85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth85rel"))
plot(HGmod85)
qqmath(HGmod85)
anova(HGmod85)
rand(HGmod85)
HGmod85_marg = lsmeans(HGmod85, ~Provenance)

CLD_HGmod85 = cld(HGmod85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod85

##1991
HGmod91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth91rel"))
plot(HGmod91)
qqmath(HGmod91)
anova(HGmod91)
rand(HGmod91)
HGmod91_marg = lsmeans(HGmod91, ~Provenance)

CLD_HGmod91 = cld(HGmod91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod91

##1996
HGmod96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth96rel"))
plot(HGmod96)
qqmath(HGmod96)
anova(HGmod96) ##1996 not significantly different between provenances
rand(HGmod96)
HGmod96_marg = lsmeans(HGmod96, ~Provenance)

CLD_HGmod96 = cld(HGmod96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod96 ##Gila no longer in last place by 1996

##2006
HGmod06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth06rel"))
plot(HGmod06)
qqmath(HGmod06)
anova(HGmod06)
rand(HGmod06)
HGmod06_marg = lsmeans(HGmod06, ~Provenance)

CLD_HGmod06 = cld(HGmod06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod06 

##2014
HGmod14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth14rel"))
plot(HGmod14)
qqmath(HGmod14)
anova(HGmod14)
rand(HGmod14)
HGmod14_marg = lsmeans(HGmod14, ~Provenance)

CLD_HGmod14 = cld(HGmod14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod14
```

#####survivors only

```{r}

relhg_SO <- lmer(value ~ Provenance*name + (1|BLK), data=ht_growth_rel_data %>% filter(!is.na(HT14)))
anova(relhg_SO)

##########################

ht_increment_rel_plot_survivorsonly<- ggplot(ht_growth_rel_data %>% filter(!is.na(HT14)), aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relativized Height Increment")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")


ht_increment_rel_plot
ht_increment_rel_plot_survivorsonly

###differences between provenances in height increment each year ***SURVIVORS ONLY***
##1979
HGmod_SO_79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth79rel"))
plot(HGmod_SO_79)
qqmath(HGmod_SO_79)
anova(HGmod_SO_79)
rand(HGmod_SO_79)
HGmod_SO_79_marg = lsmeans(HGmod_SO_79, ~Provenance)

CLD_HGmod_SO_79 = cld(HGmod_SO_79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_79

##1985
HGmod_SO_85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth85rel"))
plot(HGmod_SO_85)
qqmath(HGmod_SO_85)
anova(HGmod_SO_85)
rand(HGmod_SO_85)
HGmod_SO_85_marg = lsmeans(HGmod_SO_85, ~Provenance)

CLD_HGmod_SO_85 = cld(HGmod_SO_85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_85

##1991
HGmod_SO_91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth91rel"))
plot(HGmod_SO_91)
qqmath(HGmod_SO_91)
anova(HGmod_SO_91)
rand(HGmod_SO_91)
HGmod_SO_91_marg = lsmeans(HGmod_SO_91, ~Provenance)

CLD_HGmod_SO_91 = cld(HGmod_SO_91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_91

##1996
HGmod_SO_96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth96rel"))
plot(HGmod_SO_96)
qqmath(HGmod_SO_96)
anova(HGmod_SO_96)
rand(HGmod_SO_96)
HGmod_SO_96_marg = lsmeans(HGmod_SO_96, ~Provenance)

CLD_HGmod_SO_96 = cld(HGmod_SO_96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_96

##2006
HGmod_SO_06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth06rel"))
plot(HGmod_SO_06)
qqmath(HGmod_SO_06)
anova(HGmod_SO_06)
rand(HGmod_SO_06)
HGmod_SO_06_marg = lsmeans(HGmod_SO_06, ~Provenance)

CLD_HGmod_SO_06 = cld(HGmod_SO_06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_06 

##2014
HGmod_SO_14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth14rel"))
plot(HGmod_SO_14)
qqmath(HGmod_SO_14)
anova(HGmod_SO_14)
rand(HGmod_SO_14)
HGmod_SO_14_marg = lsmeans(HGmod_SO_14, ~Provenance)

CLD_HGmod_SO_14 = cld(HGmod_SO_14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_14
```

####PC only mods
```{r}
ht_growth_rel_clim<- ht_growth_rel_data %>% 
  left_join(prov_pcapts_big)

mod_relht_pca <- lmer(value ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
plot(mod_relht_pca)
qqmath(mod_relht_pca)
summary(mod_relht_pca)
# mod_relht_pca_dredge<- dredge(mod_relht_pca)
# mod_relht_pca_dredge

bestmod_relht_pca <- lmer(value ~  PC2 + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
summary(bestmod_relht_pca)

#no gila
ht_growth_rel_clim_noG<- ht_growth_rel_clim %>% filter(!Provenance=="Gila NF")

mod_relht_pca_noG <- lmer(value ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG)
plot(mod_relht_pca_noG)
qqmath(mod_relht_pca_noG)
summary(mod_relht_pca_noG)
# mod_relht_pca_noG_dredge<- dredge(mod_relht_pca_noG)
# mod_relht_pca_noG_dredge #null is best, then PC2
summary(lmer(value ~ PC2 + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG))
r2(lmer(value ~ PC2 + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG))


####make plot for best final model - with Gila
bestmod_relht_pca_lm <- lm(value ~  PC2, data=ht_growth_rel_clim)

newdata_relht <-  expand.grid(PC2=seq(min(ht_growth_rel_clim$PC2), max(ht_growth_rel_clim$PC2), length.out=50))
relht_predict <- predict(bestmod_relht_pca_lm, newdata = newdata_relht, interval="confidence")

predictdata_relht <- cbind(newdata_relht, relht_predict) %>% mutate(var="PC2")

ggplot()+
  geom_ribbon(data=predictdata_relht, aes(x=PC2, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_relht, aes(x=PC2,y=fit), color="black")+
  geom_rug(data=ht_growth_rel_clim %>% mutate(fit=10), aes(x=PC2,y=fit), linewidth=1, col="black", sides="b")+
  #geom_point(data=ht_growth_rel_clim, aes(x=PC2, y=value, color=Provenance))+
  scale_color_manual(values=unname(stepped()))+
  xlab("Provenance PC2")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="none")

```

####individual climate variables

```{r}

ht_growth_rel_clim_long <- ht_growth_rel_clim %>% 
  dplyr::rename(year=name, relht=value) %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality))

ht_growth_rel_clim_long_nog <- ht_growth_rel_clim_long %>% filter(!Provenance=="Gila NF")

relht_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

relht_mods <- bind_rows(relht_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

relht_mods %>% arrange(pvalue_nog)
relht_mods %>% 
  filter(pvalue_nog<0.05 & pvalue < 0.05) %>% 
  arrange(desc(Mr2_nog))

######
relht_sigvars <-relht_mods %>% filter(pvalue_nog<0.05) %>% pull(var)
# relht_mods_coeffs<- data.frame()
# relht_mods_coeffs_nog <- data.frame()
# for(i in 1:length(relht_sigvars)){
# mod <- lmer(relht ~ value + (1|Provenance) +  (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name==relht_sigvars[i]))
# pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
# estimate <- as.data.frame(summary(mod)$coefficients)[2,]$Estimate
# lwr <- confint(mod)[6,1]
# upr <- confint(mod)[6,2]
# 
# mod_nog <- lmer(relht ~ value + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name==relht_sigvars[i]))
# pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
# estimate_nog <- as.data.frame(summary(mod_nog)$coefficients)[2,]$Estimate
# lwr_nog <- confint(mod_nog)[6,1]
# upr_nog <- confint(mod_nog)[6,2]
# 
# relht_mods_coeffs <- bind_rows(relht_mods_coeffs, data.frame(var=relht_sigvars[i], p.value = p.value, estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
# relht_mods_coeffs_nog <- bind_rows(relht_mods_coeffs_nog, data.frame(var=relht_sigvars[i],  p.value = p.value_nog, estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
# }
# 
# relht_mods_coeffs_all<- bind_rows(relht_mods_coeffs, relht_mods_coeffs_nog)
# saveRDS(relht_mods_coeffs_all, "relht_mods_coeffs_all.RDS")
relht_mods_coeffs_all <- readRDS("relht_mods_coeffs_all.RDS")

######

#####FFP
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="FFP")))
summary(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="FFP") %>% filter(!Provenance=="Gila NF")))
r2(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="FFP")))
r2(lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="FFP") %>% filter(!Provenance=="Gila NF") %>% filter(!Provenance=="Wenatchee NF")))

####make plot 
FFP_relht_mod_lm <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="FFP"))

newdata_FFP_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$FFP), max(ht_growth_rel_clim$FFP), length.out=50))
FFP_relht_predict <- predict(FFP_relht_mod_lm, newdata = newdata_FFP_relht, interval="confidence")

predictdata_FFP_relht <- cbind(newdata_FFP_relht, FFP_relht_predict) %>% mutate(var="FFP")

#no gila
FFP_relht_mod_lm_nog <- lm(relht ~  value, data=ht_growth_rel_clim_long_nog %>% filter(name=="FFP") %>% filter(!Provenance=="Gila NF"))

newdata_FFP_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$FFP), max(ht_growth_rel_clim_noG$FFP), length.out=50))
FFP_relht_predict_nog <- predict(FFP_relht_mod_lm_nog, newdata = newdata_FFP_relht_nog, interval="confidence")

predictdata_FFP_relht_nog <- cbind(newdata_FFP_relht_nog, FFP_relht_predict_nog) %>% mutate(var="FFP")
###

#no wenatchee - still significant
FFP_relht_mod_lm_now <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="FFP") %>% filter(!Provenance=="Wenatchee NF"))
summary(FFP_relht_mod_lm_now)
###

predictdata_FFP_relht_all <- predictdata_FFP_relht %>% 
  mutate(model="with Gila NF") %>% 
  bind_rows(predictdata_FFP_relht_nog %>% mutate(model="without Gila NF"))

FFP_relht_plot <- ggplot()+
  geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="FFP") %>% pull(value), col="darkorange2")+
  geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="FFP") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_FFP_relht_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_FFP_relht_all, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim %>% dplyr::select(c("FFP","Provenance"))%>% mutate(fit=10), aes(x=FFP,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance FFP")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
FFP_relht_plot

#####y
y_relht_mod <- lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="y"))
plot(y_relht_mod)
qqmath(y_relht_mod)
y_relht_mod_nog <- lmer(relht ~ value + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))

####make plot 
y_relht_mod_lm <- lm(relht ~  value, data=ht_growth_rel_clim_long %>% filter(name=="y"))

newdata_y_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$y), max(ht_growth_rel_clim$y), length.out=50))
y_relht_predict <- predict(y_relht_mod_lm, newdata = newdata_y_relht, interval="confidence")

predictdata_y_relht <- cbind(newdata_y_relht, y_relht_predict) %>% mutate(var="y")

#no gila
y_relht_mod_lm_nog <- lm(relht ~  value, data=ht_growth_rel_clim_long_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))

newdata_y_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$y), max(ht_growth_rel_clim_noG$y), length.out=50))
y_relht_predict_nog <- predict(y_relht_mod_lm_nog, newdata = newdata_y_relht_nog, interval="confidence")

predictdata_y_relht_nog <- cbind(newdata_y_relht_nog, y_relht_predict_nog) %>% mutate(var="y")
###

predictdata_y_relht_all <- predictdata_y_relht %>% 
  mutate(model="with Gila NF", pvalue = summary(y_relht_mod)$coefficient[2,5]) %>% 
  bind_rows(predictdata_y_relht_nog %>% mutate(model="without Gila NF", pvalue = summary(y_relht_mod_nog)$coefficient[2,5]))

ggplot()+
  geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="y") %>% pull(value), col="darkorange2")+
  geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="y") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_y_relht_all, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=predictdata_y_relht_all, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim %>% dplyr::select(c("y","Provenance"))%>% mutate(fit=10), aes(x=y,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance y")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
```

```{r}
###quadratic

relht_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

relht_mods_quad <- bind_rows(relht_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))
}

relht_mods_quad %>% arrange(pvalue2_nog) 
relht_mods_quad %>% 
  filter(pvalue2_nog<0.05 & pvalue2 < 0.05) %>% 
  arrange(desc(Mr2_nog))

######
relht_quad_sigvars <-relht_mods_quad %>% filter(pvalue2_nog<0.05) %>% pull(var)
# relht_quad_mods_coeffs<- data.frame()
# relht_quad_mods_coeffs_nog <- data.frame()
# for(i in 1:length(relht_quad_sigvars)){
# mod <- lmer(relht ~ value + I(value^2) + (1|Provenance) +  (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name==relht_quad_sigvars[i]))
# pvalue2<- as.data.frame(summary(mod)$coefficients)[3,]$`Pr(>|t|)`
# estimate2 <- as.data.frame(summary(mod)$coefficients)[3,]$Estimate
# CI <- confint(mod)
# lwr2 <- CI[7,1]
# upr2 <- CI[7,2]
# 
# mod_nog <- lmer(relht ~  value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name==relht_quad_sigvars[i]))
# pvalue2_nog<- as.data.frame(summary(mod_nog)$coefficients)[3,]$`Pr(>|t|)`
# estimate2_nog <- as.data.frame(summary(mod_nog)$coefficients)[3,]$Estimate
# CI_nog <- confint(mod_nog)
# lwr2_nog <- CI_nog[7,1]
# upr2_nog <- CI_nog[7,2]
# 
# relht_quad_mods_coeffs <- bind_rows(relht_quad_mods_coeffs, data.frame(var=paste0(relht_quad_sigvars[i],"^2"), pvalue2 = pvalue2, estimate2 = estimate2, lwr2 = lwr2, upr2 = upr2, model = "with Gila NF"))
# relht_quad_mods_coeffs_nog <- bind_rows(relht_quad_mods_coeffs_nog, data.frame(var=paste0(relht_quad_sigvars[i], "^2"),  pvalue2 = pvalue2_nog, estimate2 = estimate2_nog, lwr2 = lwr2_nog, upr2 = upr2_nog, model="without Gila NF"))
# }
# 
# relht_quad_mods_coeffs_all<- bind_rows(relht_quad_mods_coeffs, relht_quad_mods_coeffs_nog)
# saveRDS(relht_quad_mods_coeffs_all, "relht_quad_mods_coeffs_all.RDS")
relht_quad_mods_coeffs_all <- readRDS("relht_quad_mods_coeffs_all.RDS")

##Eref
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="Eref")))
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="Eref") %>% filter(!Provenance=="Gila NF")))
r2(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="Eref")))
r2(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="Eref") %>% filter(!Provenance=="Gila NF")))

####make plot 
##with Gila
Eref_relht_mod_lm <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long %>% filter(name=="Eref"))

newdata_Eref_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$Eref), max(ht_growth_rel_clim$Eref), length.out=50))
Eref_relht_predict <- predict(Eref_relht_mod_lm, newdata = newdata_Eref_relht, interval="confidence")

predictdata_Eref_relht <- cbind(newdata_Eref_relht, Eref_relht_predict) %>% mutate(var="Eref", model="with Gila NF")

##without Gila 
Eref_relht_mod_lm_nog <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long_nog %>% filter(name=="Eref"))

newdata_Eref_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$Eref), max(ht_growth_rel_clim_noG$Eref), length.out=50))
Eref_relht_predict_nog <- predict(Eref_relht_mod_lm_nog, newdata = newdata_Eref_relht_nog, interval="confidence")

predictdata_Eref_relht_nog <- cbind(newdata_Eref_relht_nog, Eref_relht_predict_nog) %>% mutate(var="Eref", model="without Gila NF")

x_max_Eref_relht_quad_nog = -coef(Eref_relht_mod_lm_nog)[2] / (2*coef(Eref_relht_mod_lm_nog)[3])

y_max_Eref_relht_quad_nog = coef(Eref_relht_mod_lm_nog)[1] + coef(Eref_relht_mod_lm_nog)[2]*x_max_Eref_relht_quad_nog + coef(Eref_relht_mod_lm_nog)[3]*(x_max_Eref_relht_quad_nog^2)


##PPTsp
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="PPTsp")))
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="PPTsp") %>% filter(!Provenance=="Okanogan NF")))
r2(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="PPTsp")))
r2(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="PPTsp") %>% filter(!Provenance=="Okanogan NF")))

####make plot 
##with Gila
PPTsp_relht_mod_lm <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long %>% filter(name=="PPTsp"))

newdata_PPTsp_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$PPTsp), max(ht_growth_rel_clim$PPTsp), length.out=50))
PPTsp_relht_predict <- predict(PPTsp_relht_mod_lm, newdata = newdata_PPTsp_relht, interval="confidence")

predictdata_PPTsp_relht <- cbind(newdata_PPTsp_relht, PPTsp_relht_predict) %>% mutate(var="PPTsp", model="with Gila NF")

##without Gila 
PPTsp_relht_mod_lm_nog <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long_nog %>% filter(name=="PPTsp"))

newdata_PPTsp_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$PPTsp), max(ht_growth_rel_clim_noG$PPTsp), length.out=50))
PPTsp_relht_predict_nog <- predict(PPTsp_relht_mod_lm_nog, newdata = newdata_PPTsp_relht_nog, interval="confidence")

predictdata_PPTsp_relht_nog <- cbind(newdata_PPTsp_relht_nog, PPTsp_relht_predict_nog) %>% mutate(var="PPTsp", model="without Gila NF")

x_max_PPTsp_relht_quad_nog = -coef(PPTsp_relht_mod_lm_nog)[2] / (2*coef(PPTsp_relht_mod_lm_nog)[3])

y_max_PPTsp_relht_quad_nog = coef(PPTsp_relht_mod_lm_nog)[1] + coef(PPTsp_relht_mod_lm_nog)[2]*x_max_PPTsp_relht_quad_nog + coef(PPTsp_relht_mod_lm_nog)[3]*(x_max_PPTsp_relht_quad_nog^2)


####Tavewt
##with Gila NF
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="Tavewt")))
summary(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="Tavewt") %>% filter(!Provenance=="Gila NF")))
r2(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long %>% filter(name=="Tavewt")))
r2(lmer(relht ~ value + I(value^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_nog %>% filter(name=="Tavewt") %>% filter(!Provenance=="Gila NF")))

####make plot 
##with Gila
Tavewt_relht_mod_lm <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long %>% filter(name=="Tavewt"))

newdata_Tavewt_relht <-  expand.grid(value=seq(min(ht_growth_rel_clim$Tavewt), max(ht_growth_rel_clim$Tavewt), length.out=50))
Tavewt_relht_predict <- predict(Tavewt_relht_mod_lm, newdata = newdata_Tavewt_relht, interval="confidence")

predictdata_Tavewt_relht <- cbind(newdata_Tavewt_relht, Tavewt_relht_predict) %>% mutate(var="Tavewt", model="with Gila NF")

##without Gila 
Tavewt_relht_mod_lm_nog <- lm(relht ~  value + I(value^2), data=ht_growth_rel_clim_long_nog %>% filter(name=="Tavewt"))

newdata_Tavewt_relht_nog <-  expand.grid(value=seq(min(ht_growth_rel_clim_noG$Tavewt), max(ht_growth_rel_clim_noG$Tavewt), length.out=50))
Tavewt_relht_predict_nog <- predict(Tavewt_relht_mod_lm_nog, newdata = newdata_Tavewt_relht_nog, interval="confidence")

predictdata_Tavewt_relht_nog <- cbind(newdata_Tavewt_relht_nog, Tavewt_relht_predict_nog) %>% mutate(var="Tavewt", model="without Gila NF")

x_max_Tavewt_relht_quad_nog = -coef(Tavewt_relht_mod_lm_nog)[2] / (2*coef(Tavewt_relht_mod_lm_nog)[3])

y_max_Tavewt_relht_quad_nog = coef(Tavewt_relht_mod_lm_nog)[1] + coef(Tavewt_relht_mod_lm_nog)[2]*x_max_Tavewt_relht_quad_nog + coef(Tavewt_relht_mod_lm_nog)[3]*(x_max_Tavewt_relht_quad_nog^2)


relht_quad_mod_results<- bind_rows(predictdata_Tavewt_relht, predictdata_Tavewt_relht_nog, predictdata_PPTsp_relht, predictdata_PPTsp_relht_nog, predictdata_Eref_relht, predictdata_Eref_relht_nog)

relht_quad_mod_max <- data.frame(max=c(x_max_Tavewt_relht_quad_nog,x_max_PPTsp_relht_quad_nog,x_max_Eref_relht_quad_nog), var=c("Tavewt","PPTsp","Eref"))

relht_quad_mod_plot<- ggplot()+
  geom_vline(data=relht_quad_mod_max, aes(xintercept=max), col="black", linetype=2)+
  geom_text(data=relht_quad_mod_max, aes(x=max, y=12.5, label="max"), col="black", size=3)+
  geom_vline(data= prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% rename(var=name) %>% filter(var %in% unique(relht_quad_mod_results$var)), aes(xintercept = value), col="darkorange2")+
  geom_text(data=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation")  %>% rename(var=name)%>% filter(var %in% unique(relht_quad_mod_results$var)), aes(x=value, y=12.5, label="plantation"), col="darkorange2", size=3)+
  geom_ribbon(data=relht_quad_mod_results, aes(x=value, ymin=lwr, ymax=upr, fill=model), alpha=0.2)+
  geom_line(data=relht_quad_mod_results, aes(x=value,y=fit, linetype=model))+
  geom_rug(data=ht_growth_rel_clim_long %>% dplyr::rename(var=name) %>% mutate(fit=10)%>% filter(var %in% unique(relht_quad_mod_results$var)), aes(x=value,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_fill_manual(values=c("black","gray"))+
  scale_linetype_manual(values=c(1,2))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance Climate Value")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_wrap(~factor(var, levels=c("Tavewt","PPTsp","Eref")), nrow=1, scales="free_x")+
  theme_bw()+
  theme(legend.position="right")
relht_quad_mod_plot

#####coefficient plot

relht_clim_mods_coeffs_all<- relht_quad_mods_coeffs_all %>% 
  rename(p.value = pvalue2, estimate = estimate2, lwr=lwr2, upr=upr2) %>% 
  bind_rows(relht_mods_coeffs_all)

```

#####transfer distance
```{r}

relht_clim_long_transfer <- ht_growth_rel_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - value))

relht_clim_long_transfer_nog <- relht_clim_long_transfer %>% filter(!Provenance=="Gila NF")

relht_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(relht ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=relht_clim_long_transfer %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(relht ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=relht_clim_long_transfer_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

relht_mods_transfer <- bind_rows(relht_mods_transfer, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

summary(lmer(relht ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=relht_clim_long_transfer %>% filter(name=="TD")))

relht_mods_transfer %>% arrange(pvalue_nog) #lots significant both with and without Gila
relht_mods_transfer %>% filter(pvalue_nog<0.05) %>% arrange(Mr2_nog) #lots significant both with and without Gila


###create data frame with coefficients of the significant models
relht_transfer_sigvars <-relht_mods_transfer %>% filter(pvalue_nog<0.05) %>% pull(var)
# relht_mods_transfer_coeffs<- data.frame()
# relht_mods_transfer_coeffs_nog <- data.frame()
# for(i in 1:length(relht_transfer_sigvars)){
# mod <- lmer(relht ~ diff_plant + (1|Provenance) +  (1|BLK) + (1|year), data=relht_clim_long_transfer %>% filter(name==relht_transfer_sigvars[i]))
# pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
# estimate <- as.data.frame(summary(mod)$coefficients)[2,]$Estimate
# lwr <- confint(mod)[6,1]
# upr <- confint(mod)[6,2]
# 
# mod_nog <- lmer(relht ~ diff_plant + (1|Provenance) + (1|BLK) + (1|year), data=relht_clim_long_transfer_nog %>% filter(name==relht_transfer_sigvars[i]))
# pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
# estimate_nog <- as.data.frame(summary(mod_nog)$coefficients)[2,]$Estimate
# lwr_nog <- confint(mod_nog)[6,1]
# upr_nog <- confint(mod_nog)[6,2]
# 
# relht_mods_transfer_coeffs <- bind_rows(relht_mods_transfer_coeffs, data.frame(var=relht_transfer_sigvars[i], pvalue = pvalue, estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
# relht_mods_transfer_coeffs_nog <- bind_rows(relht_mods_transfer_coeffs_nog, data.frame(var=relht_transfer_sigvars[i],  pvalue = pvalue_nog, estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
# }
# 
# relht_mods_transfer_coeffs_all<- bind_rows(relht_mods_transfer_coeffs, relht_mods_transfer_coeffs_nog)
# saveRDS(relht_mods_transfer_coeffs_all, "relht_mods_transfer_coeffs_all.RDS")
relht_mods_transfer_coeffs_all <- readRDS("relht_mods_transfer_coeffs_all.RDS")

relht_transfer_coef_plot <- ggplot(relht_mods_transfer_coeffs_all %>% filter(!var=="monsoonality"), aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.5,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.5, position = position_dodge(width=1))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  ggtitle("Relative Height Growth - Transfer Distance")

######

#MWMT
ggplot(data = relht_clim_long_transfer_nog %>% filter(name=="MWMT"), aes(x=diff_plant, y=relht))+
  geom_point()+
  facet_wrap(~year)

relht_mwmt_transfermod_nog <- lmer(relht ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=relht_clim_long_transfer_nog %>% filter(name=="MWMT") %>% filter(!Provenance=="Gila NF"))
plot(relht_mwmt_transfermod_nog)
qqmath(relht_mwmt_transfermod_nog)
summary(relht_mwmt_transfermod_nog) #provenances with similar MWMT to the plantation had higher relative growth rates

#y
ggplot(data = relht_clim_long_transfer_nog %>% filter(name=="y"), aes(x=diff_plant, y=relht))+
  geom_point()+
  facet_wrap(~year)

relht_y_transfermod_nog <- lmer(relht ~ diff_plant + (1|Provenance)+ (1|BLK) + (1|year), data=relht_clim_long_transfer_nog %>% filter(name=="y") %>% filter(!Provenance=="Gila NF"))
plot(relht_y_transfermod_nog)
qqmath(relht_y_transfermod_nog)
summary(relht_y_transfermod_nog) #provenances with similar y to the plantation had higher relative growth rates

##distance in 2d climate space

relht_climdist_df <- relht_clim_long_transfer %>% 
  dplyr::select(Provenance, LOC,BLK, REP, year, relht, name, diff_plant) %>% 
  filter(name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
relht_climdist_mod <- lmer(relht ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=relht_climdist_df)
plot(relht_climdist_mod)
qqmath(relht_climdist_mod)
summary(relht_climdist_mod) #climatically closer to the plantation = greater relative height growth

relht_climdist_mod_nog <- lmer(relht ~ dist_2d + (1|Provenance)+ (1|BLK) + (1|year), data=relht_climdist_df %>% filter(!Provenance=="Gila NF"))
plot(relht_climdist_mod_nog)
qqmath(relht_climdist_mod_nog)
summary(relht_climdist_mod_nog) #climatically closer to the plantation = greater relative height growth
summary(relht_climdist_mod_nog)$coefficients[2,1]

ggplot(relht_climdist_df, aes(x=dist_2d, y=relht))+
  geom_smooth(method="lm")+
  xlab("Distance in PCA biplot from plantation")+
  ylab("Relative height Growth Rate (%/yr)")+
  theme_bw()

#final figure

relht_allmods<- bind_rows(relht_clim_mods_coeffs_all %>% 
  mutate(type = "provenance climate"),
relht_mods_transfer_coeffs_all %>% 
  mutate(type = "transfer distance")) %>% 
  bind_rows(data.frame(var = "2D PCA", estimate = summary(relht_climdist_mod)$coefficients[2,1], lwr = confint(relht_climdist_mod)[6,1], upr = confint(relht_climdist_mod)[6,2], model="with Gila NF", type="transfer distance")) %>% 
  bind_rows(data.frame(var = "2D PCA", estimate = summary(relht_climdist_mod_nog)$coefficients[2,1], lwr = confint(relht_climdist_mod_nog)[6,1], upr = confint(relht_climdist_mod_nog)[6,2], model="without Gila NF", type="transfer distance"))

ggplot(relht_allmods %>% filter(!var %in% c("x","y")), aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.8,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.8, position = position_dodge(width=1))+
  scale_color_manual(values=c("darkgrey","black"))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  facet_wrap(~type, scales="free_x")+
  ggtitle("Relative Height Growth (% per yr)")

```


####survivors only relht

```{r}
##just some visuals for height growth in survivors vs. non-survivors to help contextualize results.
###absolute height
survivors_ht_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  filter(!is.na(HT14)) %>% 
  filter(!HT14==0) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(uid=paste(LOC,BLK,REP, sep=""),
         year=case_when(name=="HT74" ~ 1974,
                        name=="HT79"~ 1979,
                        name=="HT85" ~1985,
                        name=="HT91" ~ 1991,
                        name=="HT96" ~1996,
                        name=="HT06" ~ 2006,
                        name=="HT14" ~ 2014))

nonsurvivors_ht_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  filter(is.na(HT14)| HT14==0) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(uid=paste(LOC,BLK,REP, sep=""),
         year=case_when(name=="HT74" ~ 1974,
                        name=="HT79"~ 1979,
                        name=="HT85" ~1985,
                        name=="HT91" ~ 1991,
                        name=="HT96" ~1996,
                        name=="HT06" ~ 2006,
                        name=="HT14" ~ 2014))

ggplot(data=nonsurvivors_ht_data, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, color="red")+
  theme(legend.position = "none")+
  ylab("Height (m)")+
  ggtitle("Non-survivors")

ggplot(data=survivors_ht_data, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, color="red")+
  theme(legend.position = "none")+
  ylab("Height (m)")+
  ggtitle("Survivors")

####relative height growth rate
survivors_relht <- ht_growth_rel_data %>% 
  filter(!is.na(HT14)) %>% 
    mutate(year=case_when(name=="growth79rel" ~ 1979,
                          name=="growth85rel" ~1985,
                          name=="growth91rel"~1991,
                          name=="growth96rel"~1996,
                          name=="growth06rel"~2006,
                          name=="growth14rel"~2014),
           uid=paste(LOC,BLK,REP,sep=""))
nonsurvivors_relht <- ht_growth_rel_data %>% 
  filter(is.na(HT14)) %>% 
    mutate(year=case_when(name=="growth79rel" ~ 1979,
                          name=="growth85rel" ~1985,
                          name=="growth91rel"~1991,
                          name=="growth96rel"~1996,
                          name=="growth06rel"~2006,
                          name=="growth14rel"~2014),
           uid=paste(LOC,BLK,REP,sep=""))

ggplot(data=survivors_relht, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  geom_hline(yintercept=0, color="red")+
  ylab("Relativized Height Growth Per Year")+
  ggtitle("Survivors")+
  theme_bw()+
  theme(legend.position = "none")


ggplot(data=nonsurvivors_relht, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  geom_hline(yintercept=0, color="red")+
  ylab("Relativized Height Growth Per Year")+
  ggtitle("Non-Survivors")+
  theme_bw()+
  theme(legend.position = "none")
```


##Cones

```{r}
cone_data <- moniger_data_comb %>% 
  dplyr::select(c(BLK,REP,Provenance,Cones85:Cones06)) %>% 
  pivot_longer(Cones85:Cones06) %>% 
  mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006)) %>%
  filter(!is.na(value))

cone_sum <- cone_data %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance,year) %>% 
  summarise(value=sum(value), n=n()) %>% 
  mutate(prop.w.cones = value/n)

years_to_cone<- cone_data %>% 
  filter(value==1) %>% 
  group_by( BLK, Provenance) %>% 
  summarise(min_year=min(year)) %>% 
  rbind(cone_data %>% 
          filter(year==2006 & value==0) %>% 
          mutate(min_year=NA) %>% 
          dplyr::select(-c("value","name","year"))) %>% 
  mutate(years_in_field = min_year-1970) %>% 
  distinct(BLK, Provenance, .keep_all = TRUE)

mean(years_to_cone$years_in_field, na.rm=T)
median(years_to_cone$years_in_field, na.rm=T)
min(years_to_cone$years_in_field, na.rm=T)
max(years_to_cone$years_in_field, na.rm=T)
par(mfrow=c(1,1))
hist(years_to_cone$years_in_field)
years_to_cone %>% filter(min_year==1985) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991)) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991,1996)) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991, 1996, 2006)) %>% nrow() / nrow(years_to_cone)

cone_sum_forfig<- cone_sum %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,2014), prop.w.cones=NA))

cone_means_fig <- ggplot(cone_sum_forfig, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=prop.w.cones*100, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(size=3, position = position_dodge(width=0.8))+
  geom_text(data= data.frame(year=2014, prop.w.cones=.5, Provenance="Lariimer 2", label="not \n sampled"), aes(label=label), color="black")+
  #geom_line(position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Trees with Cones (%)")
```

###ANOVA
```{r}

cone_data_binom <- cone_data %>% 
  group_by(Provenance, year, BLK, REP) %>% 
  summarise(n_cones = sum(value), total=n()) 

logmod_cat1 <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(year)*Provenance + (1|BLK), data=cone_data_binom, family=binomial)
diagnose(logmod_cat1)
summary(logmod_cat1)
Anova(logmod_cat1, type="3")
confint(logmod_cat1)

##predictions
newdata1 <- with(cone_data_binom, data.frame(year = seq(min(year),max(year),1), Provenance = rep(unique(cone_data$Provenance), each=22)))

newdata1<- expand.grid(Provenance=unique(cone_data_binom$Provenance),
            year=unique(cone_data_binom$year),
            BLK = unique(cone_data_binom$BLK))

newdata2 <- cbind(newdata1, predict(logmod_cat1, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_fig<- ggplot(newdata3, aes(x = year, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(Provenance, levels=provs_bylat$Provenance)), alpha = 0.2) + geom_line(aes(colour = factor(Provenance, levels=provs_bylat$Provenance)),
    linewidth = 1)+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  scale_fill_manual(values=unname(stepped()),name="Provenance")+
  ylab("Predicted Probability")+
  facet_wrap(~BLK)+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=10),
        axis.title = element_text(color="black", size=10),
        legend.position = "none",
        legend.text = element_text(color="black", size=8),
        legend.title = element_text(color="black", size=10))

# png("figures/cone_fig.png", height=3, width=3, res=300, units="in")
 cone_fig
# dev.off()
```

###PC only mods

```{r}
moniger_subset <- moniger_data_comb %>% 
  filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(Provenance, BLK, REP, HT85, HT91, HT96, HT06, code)) %>%
  pivot_longer(HT85:HT06, values_to = "height") %>% 
    mutate(year=case_when(name == "HT85" ~ 1985,
                        name == "HT91" ~ 1991,
                        name == "HT96" ~ 1996,
                        name == "HT06" ~ 2006)) %>% 
  dplyr::select(-name) %>% 
left_join(cone_data_binom) %>% 
left_join(moniger_data_comb %>% 
  filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(BLK, REP, PC1, PC2, PC3, x, y, code))) %>% 
  filter(!(is.na(height)|is.na(n_cones)))

cone_clim_mod_ht <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + (1|code) + (1|year) + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_clim_mod_ht)

# dredge.cone.clim <- dredge(cone_clim_mod_ht)
# dredge.cone.clim

best.mod.cone.clim <- glmmTMB(cbind(n_cones, total-n_cones) ~ PC1 + I(PC1^2) + scale(height)+ (1|code) + (1|year) + (1|BLK), data= moniger_subset, family = binomial)
summary(best.mod.cone.clim)
r2(best.mod.cone.clim)
plot(simulateResiduals(best.mod.cone.clim))

##predictions
CCnewdata1_cone <- expand.grid(height=c(3,6,9),
                          PC1 = seq(min(moniger_subset %>% pull(PC1)),
                                    max(moniger_subset  %>% pull(PC1)),1))


cone_clim_mod_glm1 <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height) + PC1 + I(PC1^2), data= moniger_subset, family = binomial)

CCnewdata2_cone <- cbind(CCnewdata1_cone, predict(cone_clim_mod_glm1, newdata = CCnewdata1_cone, type = "link", se=TRUE))
CCnewdata3_cone <- within(CCnewdata2_cone, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(CCnewdata3_cone, aes(x = PC1, y = PredictedProb, col= factor(height))) + 
  geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(height)), alpha = 0.2, col=NA) + geom_line(aes(colour = factor(height)),
    linewidth = 1)+
  geom_line(aes(x=PC1, y=PredictedProb, col=factor(height)))+
  scale_color_manual(values=viridis::mako(n=6), name = "height")+
  scale_fill_manual(values=viridis::mako(n=6),name="height")+
  theme_bw()+
  xlab("PC1")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")

#no gila
moniger_subset_nog <- moniger_subset %>% filter(!code=="GiNF")

cone_clim_mod_ht_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1 + I(PC1^2) + scale(height)*PC2 + I(PC2^2) + (1|code) + (1|year) + (1|BLK), data=moniger_subset_nog, family=binomial)
summary(cone_clim_mod_ht_nog)
r2(cone_clim_mod_ht_nog)

# dredge.cone.clim.nog <- dredge(cone_clim_mod_ht_nog)
# dredge.cone.clim.nog

best.mod.cone.clim_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ height + (1|code) + (1|year) + (1|BLK), data= moniger_subset_nog, family = binomial)
summary(best.mod.cone.clim_nog)
plot(simulateResiduals(best.mod.cone.clim_nog))

##predictions - no gila - height

newmod <- glmmTMB(cbind(n_cones, total-n_cones) ~  height, data= moniger_subset_nog, family = binomial)
summary(newmod)
plot(simulateResiduals(newmod))

CCnewdata1_cone_nog_height <- expand.grid(height=seq(min(moniger_subset_nog$height),max(moniger_subset_nog$height),0.1))

CCnewdata2_cone_nog_height <- cbind(CCnewdata1_cone_nog_height, predict(newmod, newdata = CCnewdata1_cone_nog_height, type="link", se.fit=TRUE))
CCnewdata3_cone_nog_height <- within(CCnewdata2_cone_nog_height, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_plot_height<- ggplot(CCnewdata3_cone_nog_height %>% mutate(var="Height"), aes(x = height, y = PredictedProb)) +
  geom_segment(aes(x=3.859648, y = 0, xend=3.859648, yend=.5), col="red")+
  geom_segment(aes(x=0, y = 0.5, xend=3.859648, yend=.5), col="red")+
  geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2, col=NA) + geom_line(linewidth = 1)+
  geom_line(aes(x=height, y=PredictedProb))+
    geom_rug(data=moniger_subset_nog%>% mutate(PredictedProb=.8), aes(x=height, y=PredictedProb), sides="b", linewidth=1, col="black", alpha=0.5)+
  theme_bw()+
  ylim(c(0,1))+
  xlab("Height (m)")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")+
  facet_grid(~var)

cone_plot_height

###height needed for 50% chance of having cones
summary(newmod)
predict(newmod, newdata=data.frame(height=3.85),type="response")

#log(p/(1-p)) = b0 + b1*height

b0 = summary(newmod)$coefficients$cond[1,"Estimate"]
b1 = summary(newmod)$coefficients$cond[2,"Estimate"]

#25%
p=0.25
height = (log(p/(1-p))-b0)/b1
height

#50%
p=0.5
height = (log(p/(1-p))-b0)/b1
height

#75%
p=0.75
height = (log(p/(1-p))-b0)/b1
height

#95%
p=0.95
height = (log(p/(1-p))-b0)/b1
height
```

```{r}
moniger_subset

cone_ht_anova <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(year)*Provenance*height + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_ht_anova)
Anova(cone_ht_anova, type="3")
```

####individual climate variables

######height

```{r}
moniger_provclim_ht<- cone_data_binom %>% 
  left_join(as.data.frame(moniger_data_comb) %>% dplyr::select(c(Provenance,BLK, REP, code,PC1,PC2,AHM:SHM,x:monsoonality))) %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality), names_to="climvar.name", values_to = "climvar.value") %>% 
  filter(!is.na(total)) %>% 
  left_join(moniger_subset %>% dplyr::select(Provenance:year)) %>% 
  filter(!is.na(height)) #this removes Gila tree that was outlier for height in 96

cone_ht_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2=r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!code=="GiNF"), family=binomial)
pvalue_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2_nog=r2(mod_nog)$R2_marginal

cone_ht_mods <- bind_rows(cone_ht_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog = Mr2_nog))

}

cone_ht_mods %>% arrange(pvalue_nog) 
cone_ht_mods %>% 
  filter(pvalue_nog<0.05) %>% 
  arrange(desc(Mr2_nog))
cone_ht_mods %>% arrange(pvalue) 

###PPTsm
cone_ht_pptsm_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name=="PPTsm"), family=binomial)
summary(cone_ht_pptsm_mod)
r2(cone_ht_pptsm_mod)

cone_ht_pptsm_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(!Provenance=="Gila NF") %>% filter(climvar.name=="PPTsm"), family=binomial)
summary(cone_ht_pptsm_mod_nog)
r2(cone_ht_pptsm_mod_nog)

cone_ht_pptsm_data_nog <- moniger_provclim_ht %>% filter(!Provenance=="Gila NF") %>% filter(climvar.name=="PPTsm")

#prediction
##take random effect out to make predictions
cone_ht_pptsm_nog_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height, data=cone_ht_pptsm_data_nog, family=binomial)

##predictions - 3.9m
cone_ht_pptsm_nog_newdata1 <- with(cone_ht_pptsm_data_nog, expand.grid(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50), height=c(2.6,5.1,3.9)))

cone_ht_pptsm_nog_newdata2 <- cbind(cone_ht_pptsm_nog_newdata1, predict(cone_ht_pptsm_nog_glm, newdata = cone_ht_pptsm_nog_newdata1, type = "link", se=TRUE))
cone_ht_pptsm_nog_newdata3 <- within(cone_ht_pptsm_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})


#prediction - with Gila
cone_ht_pptsm_data <- moniger_provclim_ht %>% filter(climvar.name=="PPTsm")

##take random effect out to make predictions
cone_ht_pptsm_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height, data=cone_ht_pptsm_data, family=binomial)

##predictions - 3.9m
cone_ht_pptsm_newdata1 <- with(cone_ht_pptsm_data, expand.grid(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50), height=c(2.6,5.1,3.9)))

cone_ht_pptsm_newdata2 <- cbind(cone_ht_pptsm_newdata1, predict(cone_ht_pptsm_glm, newdata = cone_ht_pptsm_newdata1, type = "link", se=TRUE))
cone_ht_pptsm_newdata3 <- within(cone_ht_pptsm_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_ht_pptsm_newdata3_all <- bind_rows(cone_ht_pptsm_newdata3 %>% mutate(model="with Gila NF"), cone_ht_pptsm_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(cone_ht_pptsm_newdata3_all %>% filter(height==3.9), aes(x = climvar.value, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL,ymax = UL, fill=factor(model)), alpha = 0.2) + 
  geom_line(aes(col=factor(model)), linewidth = 1)+
  geom_rug(data=moniger_provclim_ht %>% filter(climvar.name=="PPTsm") %>% mutate(PredictedProb=0.6), sides="b", linewidth=1, color="black", alpha=0.5)+
  scale_linetype_manual(values=c(2,1))+
  scale_fill_manual(values=c("darkgray","black"))+
  scale_color_manual(values=c("darkgray","black"))+
  ylim(c(0,1))+
  xlab("Provenance summer precip")+
  ylab("Predicted Probability of Cones")+
  theme_bw()


###TD
cone_ht_TD_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name=="TD"), family=binomial)
summary(cone_ht_TD_mod) 
r2(cone_ht_TD_mod)

cone_ht_TD_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name=="TD") %>% filter(!Provenance=="Gila NF"), family=binomial)
summary(cone_ht_TD_mod_nog) 
r2(cone_ht_TD_mod_nog)

cone_ht_td_data_nog<- moniger_provclim_ht %>% filter(climvar.name=="TD") %>% filter(!Provenance=="Gila NF")

##predictions
cone_ht_td_nog_glm <-  glmmTMB(cbind(n_cones,total-n_cones) ~ climvar.value*height, data=cone_ht_td_data_nog, family=binomial)

cone_ht_td_nog_newdata1 <- expand.grid(climvar.value = with(cone_ht_td_data_nog, seq(min(climvar.value),max(climvar.value),length.out=50)), height=c(2.6,5.1,3.9))

cone_ht_td_nog_newdata2 <- cbind(cone_ht_td_nog_newdata1, predict(cone_ht_td_nog_glm, newdata = cone_ht_td_nog_newdata1, type = "link", se=TRUE))
cone_ht_td_nog_newdata3 <- within(cone_ht_td_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cones_TD_plot<- ggplot() + 
  geom_ribbon(data=cone_ht_td_nog_newdata3, aes(ymin = LL,ymax = UL, x = climvar.value, col=factor(height, levels=c(5.1,3.9,2.6)), fill=factor(height, levels=c(5.1,3.9,2.6))), alpha = 0.2) + 
  geom_line(data=cone_ht_td_nog_newdata3, aes(x = climvar.value, y = PredictedProb, col=factor(height, levels=c(5.1,3.9,2.6)), fill=factor(height, levels=c(5.1,3.9,2.6))), linewidth = 1)+
  geom_rug(data=moniger_provclim_ht %>% filter(climvar.name=="TD") %>% mutate(PredictedProb=0.6) %>% dplyr::select(-height), aes(x=climvar.value), sides="b", linewidth=1, color="black", alpha=0.5)+
  geom_vline(xintercept=plantation_only$TD, col="darkorange2", linewidth=1)+
  scale_color_viridis(discrete=T, name="Height (m)")+
  scale_fill_viridis(discrete=T, name="Height (m)")+
  ylim(c(0,1))+
  xlab("Provenance TD")+
  ylab("Predicted Probability of Cones")+
  theme_bw()+
  theme(legend.position="top")

###quadratic

cone_ht_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value)*height + I(scale(climvar.value)^2) + (1|code) + (1|year) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalues<- as.data.frame(summary(mod)$coefficients$cond[c(2,4),])$`Pr(>|z|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value)*height + I(scale(climvar.value)^2) + (1|code) + (1|year) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!code=="GiNF"), family=binomial)
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond[c(2,4),])$`Pr(>|z|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

cone_ht_mods_quad <- bind_rows(cone_ht_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))
}

cone_ht_mods_quad %>% arrange(pvalue2_nog) ##PPTsm significant again


###PPTsm
cone_ht_pptsm_quad_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value)*height + I(scale(climvar.value)^2) + (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(climvar.name=="PPTsm"), family=binomial)
summary(cone_ht_pptsm_quad_mod)
r2(cone_ht_pptsm_quad_mod)

cone_ht_pptsm_quad_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~  scale(climvar.value)*height + I(scale(climvar.value)^2)+ (1|year) + (1|code) + (1|BLK), data=moniger_provclim_ht %>% filter(!Provenance=="Gila NF") %>% filter(climvar.name=="PPTsm"), family=binomial)
summary(cone_ht_pptsm_quad_mod_nog)
r2(cone_ht_pptsm_quad_mod_nog)


#prediction
##take random effect out to make predictions
cone_ht_pptsm_quad_nog_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value)*height + I(scale(climvar.value)^2), data=cone_ht_pptsm_data_nog, family=binomial)

##predictions 
cone_ht_pptsm_quad_nog_newdata1 <- with(cone_ht_pptsm_data_nog, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50), height=3.9))

cone_ht_pptsm_quad_nog_newdata2 <- cbind(cone_ht_pptsm_quad_nog_newdata1, predict(cone_ht_pptsm_quad_nog_glm, newdata = cone_ht_pptsm_quad_nog_newdata1, type = "link", se=TRUE))
cone_ht_pptsm_quad_nog_newdata3 <- within(cone_ht_pptsm_quad_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#with Gila 
cone_ht_pptsm_quad_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(climvar.value)*height + I(scale(climvar.value)^2), data=cone_ht_pptsm_data, family=binomial)

##predictions 
cone_ht_pptsm_quad_newdata1 <- with(cone_ht_pptsm_data, data.frame(climvar.value = seq(min(climvar.value),max(climvar.value),length.out=50), height=3.9))

cone_ht_pptsm_quad_newdata2 <- cbind(cone_ht_pptsm_quad_newdata1, predict(cone_ht_pptsm_quad_glm, newdata = cone_ht_pptsm_quad_newdata1, type = "link", se=TRUE))
cone_ht_pptsm_quad_newdata3 <- within(cone_ht_pptsm_quad_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_ht_pptsm_quad_newdata3_all <- bind_rows(cone_ht_pptsm_quad_newdata3 %>% mutate(model="with Gila NF"), cone_ht_pptsm_quad_nog_newdata3 %>% mutate(model="without Gila NF"))


cones_pptsm_plot<- ggplot(cone_ht_pptsm_quad_newdata3_all, aes(x = climvar.value, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL,ymax = UL, fill=model), alpha = 0.2) + 
  geom_line(linewidth = 1, aes(color=model))+
  geom_rug(data=moniger_provclim_ht %>% filter(climvar.name=="PPTsm") %>% mutate(PredictedProb=0.6), sides="b", linewidth=1, color="black", alpha=0.5)+
  scale_linetype_manual(values=c(2,1))+
  scale_fill_manual(values=c("darkgray","black"))+
  scale_color_manual(values=c("darkgray","black"))+
  geom_vline(xintercept=plantation_only$PPTsm, col="darkorange2", linewidth=1)+
  ylim(c(0,1))+
  xlab("Provenance summer precip")+
  ylab("Predicted Probability of Cones at 3.9m")+
  theme_bw()+
  theme(legend.position="top")


ggarrange(cone_plot_height, ggarrange(cones_pptsm_plot, cones_TD_plot, ncol=2, labels=c("B)","C)")),nrow=2, labels="A)")
```

#####transfer distance
```{r}

cone_clim_long_transfer <- moniger_provclim_ht %>%
  left_join(plantation_climNA, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value))

cone_clim_long_transfer_nog <- cone_clim_long_transfer %>% filter(!Provenance=="Gila NF")

cone_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ diff_plant*height + (1|code) + (1|year) + (1|BLK), data=cone_clim_long_transfer %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
p.value<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ diff_plant*height + (1|code) + (1|year) + (1|BLK), data=cone_clim_long_transfer_nog %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
p.value_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2_nog <- r2(mod_nog)$R2_marginal

cone_mods_transfer <- bind_rows(cone_mods_transfer, data.frame(var=provenance_climvars[i], p.value = p.value, Mr2=Mr2, p.value_nog = p.value_nog, Mr2_nog=Mr2_nog))

}

cone_mods_transfer %>% arrange(p.value_nog) #PPTsm and smrpb
cone_mods_transfer %>% filter(p.value_nog<0.05) %>% arrange(Mr2_nog) 

#PPTsm
cone_pptsm_mod_nog_transfer <- glmmTMB(cbind(n_cones,total-n_cones) ~ diff_plant*height + (1|year) + (1|code)+(1|BLK), data=cone_clim_long_transfer_nog %>% filter(climvar.name=="PPTsm"), family=binomial)
summary(cone_pptsm_mod_nog_transfer) #provenances with summer precip more different from the plantation have higher likelihood of cones.
r2(cone_pptsm_mod_nog_transfer)

#smrpb
cone_smrpb_mod_nog_transfer <- glmmTMB(cbind(n_cones,total-n_cones) ~ diff_plant*height + (1|year) + (1|code)+(1|BLK), data=cone_clim_long_transfer_nog %>% filter(climvar.name=="smrpb"), family=binomial)
summary(cone_smrpb_mod_nog_transfer) #provenances with smrpb more different from the plantation have higher probability of cones. 
r2(cone_smrpb_mod_nog_transfer)

##distance in 2d climate space

cone_climdist_df <- cone_clim_long_transfer %>% 
  dplyr::select(Provenance, BLK, REP, year, n_cones, total, climvar.name, diff_plant, height) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
cone_climdist_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ dist_2d*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_climdist_df, family=binomial)
summary(cone_climdist_mod) # not significant 
r2(cone_climdist_mod)
summary(cone_climdist_mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ dist_2d*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_climdist_df %>% filter(!Provenance=="Gila NF"), family=binomial))#not significant

##look at distance to different projections for the plantation
#2020's
plantation_climNA_20s <- prov_vars %>% 
  filter(Provenance=="Plantation") %>% 
  dplyr::select(var,value) %>% 
  rename(plant_value = value) %>% 
  bind_rows(data.frame(var=c("PC1","PC2"), plant_value=c(plant_pca_scores %>% filter(period=="2020s") %>% pull(PC1),plant_pca_scores %>% filter(period=="2020s") %>% pull(PC2)) ))

cone_climdist_df_2020s <- moniger_provclim_ht %>%
  left_join(plantation_climNA_20s, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value)) %>% 
  dplyr::select(Provenance,BLK, REP, year, n_cones, total, climvar.name, diff_plant,height) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
cone_climdist_mod_20s <- glmmTMB(cbind(n_cones,total-n_cones) ~ dist_2d*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_climdist_df_2020s, family=binomial)
summary(cone_climdist_mod_20s) # the closer in climate to the plantation, the higher probability of cones. 
r2(cone_climdist_mod_20s)

#2050's
plantation_climNA_50s <- prov_vars %>% 
  filter(Provenance=="Plantation") %>% 
  dplyr::select(var,value) %>% 
  rename(plant_value = value) %>% 
  bind_rows(data.frame(var=c("PC1","PC2"), plant_value=c(plant_pca_scores %>% filter(period=="2050s") %>% pull(PC1),plant_pca_scores %>% filter(period=="2050s") %>% pull(PC2)) ))

cone_climdist_df_2050s <- moniger_provclim_ht %>%
  left_join(plantation_climNA_50s, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value)) %>% 
  dplyr::select(Provenance,BLK, REP, year, n_cones, total, climvar.name, diff_plant, height) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
cone_climdist_mod_50s <- glmmTMB(cbind(n_cones,total-n_cones) ~ dist_2d*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_climdist_df_2050s, family=binomial)
summary(cone_climdist_mod_50s) # not significant

#2080's
plantation_climNA_80s <- prov_vars %>% 
  filter(Provenance=="Plantation") %>% 
  dplyr::select(var,value) %>% 
  rename(plant_value = value) %>% 
  bind_rows(data.frame(var=c("PC1","PC2"), plant_value=c(plant_pca_scores %>% filter(period=="2080s") %>% pull(PC1),plant_pca_scores %>% filter(period=="2080s") %>% pull(PC2)) ))

cone_climdist_df_2080s <- moniger_provclim_ht %>%
  left_join(plantation_climNA_80s, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value)) %>% 
  dplyr::select(Provenance,BLK, REP, year, n_cones, total, climvar.name, diff_plant, height) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
cone_climdist_mod_80s <- glmmTMB(cbind(n_cones,total-n_cones) ~ dist_2d*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_climdist_df_2080s, family=binomial)
summary(cone_climdist_mod_80s) # not significant

```


##Survival by year

####ANOVA
```{r}
#provenance affect on survival 
##these analyses use data that only includes trees alive in the prior period's data to assess whether they survived or not. So, survival in 1991 is only survival of the trees that were alive in 1985 and made it to 1991.  

moniger_survival <- moniger_data_comb %>% 
  mutate(Stat14 = ifelse(Stat14==9,0,Stat14))

moniger_survival %>% 
  group_by(BLK, Provenance) %>% 
  summarise(n=n())

moniger_survival_byyr <- moniger_data_comb %>% 
  mutate(Stat79 = ifelse(Stat74 == 9, NA, Stat79)) %>% 
  mutate(Stat85 = ifelse(Stat79 %in% c(NA,9), NA, Stat85)) %>% 
  mutate(Stat91 = ifelse(Stat85 %in% c(NA,9), NA, Stat91)) %>% 
  mutate(Stat96 = ifelse(Stat91 %in% c(NA,9), NA, Stat96)) %>% 
  mutate(Stat06 = ifelse(Stat96 %in% c(NA,9), NA, Stat06)) %>% 
  mutate(Stat14 = ifelse(Stat06 %in% c(NA,9), NA, Stat14)) %>% 
  dplyr::select(c(SORT,LOC,BLK,REP,Provenance,Stat74:Stat14)) %>% 
  pivot_longer(Stat74:Stat14) %>% 
  mutate(year=case_when(name == "Stat74" ~ 1974,
                        name == "Stat79" ~ 1979,
                        name == "Stat85" ~ 1985,
                        name == "Stat91" ~ 1991,
                        name == "Stat96" ~ 1996,
                        name == "Stat06" ~ 2006,
                        name == "Stat14" ~ 2014)) %>% 
  mutate(value = ifelse(value==9,0,value)) %>%  
  filter(!is.na(value))

surv_df_zero <- expand.grid(Provenance=unique(moniger_survival_byyr$Provenance),
                            BLK = unique(moniger_survival_byyr$BLK))

alive_blk_yr <- moniger_survival_byyr %>% 
  group_by(Provenance,BLK,year) %>% 
  summarise(alive=sum(value)) %>% 
  mutate(prev.yr = case_when(year == 1974 ~ 1970,
                             year == 1979 ~ 1974,
                             year == 1985 ~ 1979,
                             year == 1991 ~ 1985,
                             year == 1996 ~ 1991,
                             year == 2006 ~ 1996,
                             year == 2014 ~ 2006)) 

prop.died.df <- alive_blk_yr %>% 
  left_join(alive_blk_yr, by=c("prev.yr"="year", "Provenance", "BLK")) %>% 
  mutate(alive.y=ifelse(is.na(alive.y), 4, alive.y)) %>% 
  mutate(died = alive.y - alive.x, prop.died = ((alive.y - alive.x)/alive.y)) %>% 
  dplyr::select(-c(prev.yr.y)) %>% 
  rename(prev.yr.alive=alive.y, alive=alive.x)

ggplot(prop.died.df %>% group_by(Provenance, year) %>% summarise(prev.yr.alive=sum(prev.yr.alive), died=sum(died)) %>% mutate(prop.died = died/prev.yr.alive), aes(x=year, y=prop.died, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(position=position_dodge(2))+
  scale_color_manual(values=unname(stepped()))

moniger_survival_byyr_binom<- prop.died.df %>% 
  full_join(surv_df_zero) %>% 
  left_join(moniger_survival %>% dplyr::select(c(Provenance,BLK,PC1,PC2,AHM:SHM,x,y,smrpb,monsoonality)) %>% unique()) 

survmod_byyear<- glmmTMB(cbind(alive, died) ~ factor(year)*Provenance, data=moniger_survival_byyr_binom, family=binomial) ###model convergence issue - maybe because of all the 0's??

moniger_survival_byyr_binom %>% 
  group_by(Provenance,year) %>% 
  summarise(prev.yr.alive.sum=sum(prev.yr.alive), died.sum=sum(died)) %>% 
  mutate(prop.surv = (prev.yr.alive.sum-died.sum)/prev.yr.alive.sum) %>% 
  right_join(moniger_survival_byyr_binom %>% 
  group_by(Provenance,year) %>% 
  summarise(prev.yr.alive.sum=sum(prev.yr.alive), died.sum=sum(died)) %>% 
  mutate(prop.surv = (prev.yr.alive.sum-died.sum)/prev.yr.alive.sum) %>% 
  group_by(Provenance) %>% 
  summarise(min_surv=min(prop.surv)), by=c("prop.surv"="min_surv","Provenance")) %>% View()

summary_moniger_survival_byyr_binom <- moniger_survival_byyr_binom %>% 
  group_by(Provenance,year) %>% 
  summarise(prev.yr.alive.sum=sum(prev.yr.alive), died.sum=sum(died)) %>% 
  mutate(prop.surv = (prev.yr.alive.sum-died.sum)/prev.yr.alive.sum) 

ggplot(summary_moniger_survival_byyr_binom, aes(x=Provenance, y=prop.surv, color=factor(year)))+
  geom_point(position = position_dodge(width=1))+
  theme(axis.text.x = element_text(angle=45, hjust=1))

####ANOVAs for each year separately

survmod74 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1974), family=binomial)
Anova(survmod74, type="3")
survmod74_marg = lsmeans(survmod74, ~ Provenance)

CLD_survmod74 = cld(survmod74_marg,
          alpha=0.05,
          Letters=letters)
CLD_survmod74 

survmod79 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1979), family=binomial)
Anova(survmod79, type="3")

survmod85 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1985), family=binomial)
Anova(survmod85, type="3")

survmod91 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1991), family=binomial)
Anova(survmod91, type="3")

survmod96 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==1996), family=binomial)
Anova(survmod96, type="3")

survmod06 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==2006), family=binomial)
Anova(survmod06, type="3")

survmod14 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom %>% filter(year==2014), family=binomial)
Anova(survmod14, type="3")

survival_means <- left_join(
moniger_survival_byyr %>% 
  filter(name=="Stat74") %>% 
  group_by(Provenance) %>% 
  summarise(alltrees74=n()),
moniger_survival_byyr %>% 
  group_by(Provenance, year) %>% 
  summarise(n.trees=sum(value)) %>% 
  pivot_wider(names_from=year, values_from=n.trees), by="Provenance") %>% 
    mutate("1974" = `1974`/alltrees74, 
           "1979" = `1979`/alltrees74,
           "1985" = `1985`/alltrees74,
           "1991" = `1991`/alltrees74,
           "1996" = `1996`/alltrees74,
           "2006" = `2006`/alltrees74,
           "2014" = `2014`/alltrees74) %>% 
    pivot_longer(`1974`:`2014`, names_to="year", values_to="prop.surv.since.1970")

survival_means_fig <- ggplot(survival_means, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=prop.surv.since.1970*100, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(size=3, position = position_dodge(width=0.8))+
  #geom_line(position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Survival (%)")

#png("figure_summary.png", width=190, height=225, unit="mm", res=600)
ggarrange(survival_means_fig, dbh_means_fig, ht_means_fig, cone_means_fig, ncol=1, nrow=4, common.legend = TRUE)
#dev.off()
```

####PC only mods
```{r}

##with gila
survmod_pc<- glmmTMB(cbind(alive,died) ~  PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_byyr_binom, family=binomial) 
summary(survmod_pc)

# dredge_survmod_pc <- dredge(survmod_pc)
# dredge_survmod_pc ##null is best

moniger_survival_nog <- moniger_survival_byyr_binom %>% filter(!Provenance%in%c("Gila NF"))

##no gila
survmod_pc_nog<- glmmTMB(cbind(alive,died) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_nog, family=binomial)

summary(survmod_pc_nog)
# dredge_survmod_pc_nog <- dredge(survmod_pc_nog)
# dredge_survmod_pc_nog ##null is best
```

####individual climate variables

```{r}
moniger_survival_long <- moniger_survival_byyr_binom %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality), names_to="climvar.name", values_to = "climvar.value")

surv_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- as.data.frame(summary(mod)$coefficients$cond)[2,]$`Pr(>|z|)`
Mr2=r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family=binomial)
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2,]$`Pr(>|z|)`
Mr2_nog=r2(mod_nog)$R2_marginal


surv_mods <- bind_rows(surv_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog = Mr2_nog))}

surv_mods %>% arrange(pvalue_nog) ##length of growing season seems to be influential both with and without Gila, also smrpb & y
surv_mods %>% 
  filter(pvalue_nog<0.05) %>% 
  arrange(desc(Mr2_nog))

#FFP
surv_FFP_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="FFP"), family="binomial")
summary(surv_FFP_mod)

surv_FFP_data <- moniger_survival_long %>% filter(climvar.name=="FFP")

newdata_FFP_surv <- data.frame(
    climvar.value = seq(min(surv_FFP_data$climvar.value), 
                      max(surv_FFP_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
survFFP_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_FFP_surv$climvar.value),max(newdata_FFP_surv$climvar.value),length.out=50))

surv_FFP_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="FFP"), family="binomial")

survFFP_newdata2 <- cbind(survFFP_newdata1, predict(surv_FFP_mod_glm, newdata = survFFP_newdata1, type = "link", se=TRUE))
survFFP_newdata3 <- within(survFFP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(survFFP_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("FFP")

#without Gila is still significant
surv_FFP_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_FFP_mod_nog)

surv_FFP_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_FFP_mod_nog)

##predictions
surv_FFP_data_nog <- moniger_survival_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF")

survFFP_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv_FFP_data_nog$climvar.value),max(surv_FFP_data_nog$climvar.value),length.out=50))

survFFP_nog_newdata2 <- cbind(survFFP_nog_newdata1, predict(surv_FFP_mod_nog_glm, newdata = survFFP_nog_newdata1, type = "link", se=TRUE))
survFFP_nog_newdata3 <- within(survFFP_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

survFFP_bothmod_data<- bind_rows(survFFP_newdata3 %>% mutate(model="with Gila NF"),
survFFP_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(survFFP_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("FFP")
#########
#########

#smrpb
surv_smrpb_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="smrpb"), family="binomial")
summary(surv_smrpb_mod)

surv_smrpb_data <- moniger_survival_long %>% filter(climvar.name=="smrpb")

newdata_smrpb_surv <- data.frame(
    climvar.value = seq(min(surv_smrpb_data$climvar.value), 
                      max(surv_smrpb_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
survsmrpb_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_smrpb_surv$climvar.value),max(newdata_smrpb_surv$climvar.value),length.out=50))

surv_smrpb_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="smrpb"), family="binomial")

survsmrpb_newdata2 <- cbind(survsmrpb_newdata1, predict(surv_smrpb_mod_glm, newdata = survsmrpb_newdata1, type = "link", se=TRUE))
survsmrpb_newdata3 <- within(survsmrpb_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(survsmrpb_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")

#without Gila is significant
surv_smrpb_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_smrpb_mod_nog)

##predictions
surv_smrpb_data_nog <- moniger_survival_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF")

survsmrpb_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv_smrpb_data_nog$climvar.value),max(surv_smrpb_data_nog$climvar.value),length.out=50))

surv_smrpb_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")


survsmrpb_nog_newdata2 <- cbind(survsmrpb_nog_newdata1, predict(surv_smrpb_mod_nog_glm, newdata = survsmrpb_nog_newdata1, type = "link", se=TRUE))
survsmrpb_nog_newdata3 <- within(survsmrpb_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

survsmrpb_bothmod_data<- bind_rows(survsmrpb_newdata3 %>% mutate(model="with Gila NF"),
survsmrpb_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(survsmrpb_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")
#########

#########
#########

#y
surv_y_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="y"), family="binomial")
summary(surv_y_mod)

surv_y_data <- moniger_survival_long %>% filter(climvar.name=="y")

newdata_y_surv <- data.frame(
    climvar.value = seq(min(surv_y_data$climvar.value), 
                      max(surv_y_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
survy_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_y_surv$climvar.value),max(newdata_y_surv$climvar.value),length.out=50))

surv_y_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="y"), family="binomial")

survy_newdata2 <- cbind(survy_newdata1, predict(surv_y_mod_glm, newdata = survy_newdata1, type = "link", se=TRUE))
survy_newdata3 <- within(survy_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(survy_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("y")

#without Gila is significant
surv_y_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_y_mod_nog)

##predictions
surv_y_data_nog <- moniger_survival_long %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF")

survy_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv_y_data_nog$climvar.value),max(surv_y_data_nog$climvar.value),length.out=50))

surv_y_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival_long %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF"), family="binomial")


survy_nog_newdata2 <- cbind(survy_nog_newdata1, predict(surv_y_mod_nog_glm, newdata = survy_nog_newdata1, type = "link", se=TRUE))
survy_nog_newdata3 <- within(survy_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

survy_bothmod_data<- bind_rows(survy_newdata3 %>% mutate(model="with Gila NF", pvalue = summary(surv_y_mod)$coefficient$cond[2,4]),
survy_nog_newdata3 %>% mutate(model="without Gila NF", pvalue = summary(surv_y_mod_nog)$coefficient$cond[2,4]))

ggplot(survy_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("y")
#########

###quadratic

surv_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2:3,]$`Pr(>|z|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

surv_mods_quad <- bind_rows(surv_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))

}

surv_mods_quad %>% arrange(pvalue2_nog) ##Eref, cmd

##Eref
surv_Eref_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="Eref"), family="binomial")
summary(surv_Eref_mod)
r2(surv_Eref_mod)

surv_Eref_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="Eref"), family="binomial")

surv_Eref_data <- moniger_survival_long %>% filter(climvar.name=="Eref")

##predictions
survEref_newdata1 <- expand.grid(climvar.value = seq(min(surv_Eref_data$climvar.value),max(surv_Eref_data$climvar.value),length.out=50))

survEref_newdata2 <- cbind(survEref_newdata1, predict(surv_Eref_mod_glm, newdata = survEref_newdata1, type = "link", se=TRUE))
survEref_newdata3 <- within(survEref_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#without Gila is still significant
surv_eref_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_eref_mod_nog)
r2(surv_eref_mod_nog)

surv_eref_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surveref_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

surveref_newdata2_nog <- cbind(surveref_newdata1_nog, predict(surv_eref_mod_nog_glm, newdata = surveref_newdata1_nog, type = "link", se=TRUE))
surveref_newdata3_nog <- within(surveref_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_eref_bothmod <- bind_rows(survEref_newdata3 %>% mutate(model="with Gila NF"),surveref_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv_eref_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("Eref")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()
#########

##CMD
surv_CMD_mod2 <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="CMD"), family="binomial")
summary(surv_CMD_mod2)
r2(surv_CMD_mod2)

surv_CMD_mod2_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="CMD"), family="binomial")

surv_CMD_data <- moniger_survival_long %>% filter(climvar.name=="CMD")

##predictions
survCMD2_newdata1 <- expand.grid(climvar.value = seq(min(surv_CMD_data$climvar.value),max(surv_CMD_data$climvar.value),length.out=50))

survCMD2_newdata2 <- cbind(survCMD2_newdata1, predict(surv_CMD_mod2_glm, newdata = survCMD2_newdata1, type = "link", se=TRUE))
survCMD2_newdata3 <- within(survCMD2_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#without Gila is still significant
surv_CMD_mod2_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) + (1|year), data=moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv_CMD_mod2_nog)
r2(surv_CMD_mod2_nog)

surv_CMD_mod2_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
survCMD2_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

survCMD2_newdata2_nog <- cbind(survCMD2_newdata1_nog, predict(surv_CMD_mod2_nog_glm, newdata = survCMD2_newdata1_nog, type = "link", se=TRUE))
survCMD2_newdata3_nog <- within(survCMD2_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv_CMD_bothmod <- bind_rows(survCMD2_newdata3 %>% mutate(model="with Gila NF"),survCMD2_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv_CMD_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("CMD")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()

########
#########
```

#####transfer distance

```{r}

surv_clim_long_transfer <- moniger_survival_long %>%
  left_join(plantation_climNA, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value))

surv_clim_long_transfer_nog <- surv_clim_long_transfer %>% filter(!Provenance=="Gila NF")

surv_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance) + (1|year) + (1|BLK), data=surv_clim_long_transfer %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
p.value<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance) + (1|year) + (1|BLK), data=surv_clim_long_transfer_nog %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
p.value_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2_nog <- r2(mod_nog)$R2_marginal

surv_mods_transfer <- bind_rows(surv_mods_transfer, data.frame(var=provenance_climvars[i], p.value = p.value, Mr2=Mr2, p.value_nog = p.value_nog, Mr2_nog=Mr2_nog))

}

surv_mods_transfer %>% arrange(p.value_nog) #DD5, MWMT, Tavesm, NFFD, eFFP, FFP, Eref, RH, y, bFFP, CMD
surv_mods_transfer %>% filter(p.value_nog<0.05) %>% arrange(Mr2_nog) 

clim_pien_cor[c("DD5", "MWMT", "Tavesm", "NFFD", "eFFP", "FFP", "Eref", "RH", "bFFP", "CMD"),c("DD5", "MWMT", "Tavesm", "NFFD", "eFFP", "FFP", "Eref", "RH", "bFFP", "CMD")]

#Eref - correlated to DD5, MWMT, Tavesm
surv_Eref_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|year) + (1|Provenance)+(1|BLK), data=surv_clim_long_transfer_nog %>% filter(climvar.name=="Eref"), family=binomial)
summary(surv_Eref_mod_nog) #provenances with Eref more similar to plantation had higher survival
r2(surv_Eref_mod_nog)
plot(ggpredict(surv_Eref_mod_nog, terms = "diff_plant"))

#RH
surv_RH_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|year) + (1|Provenance)+(1|BLK), data=surv_clim_long_transfer_nog %>% filter(climvar.name=="RH"), family=binomial)
summary(surv_RH_mod_nog) #provenances with RH more similar to plantation had higher survival
r2(surv_RH_mod_nog)
plot(ggpredict(surv_RH_mod_nog, terms = "diff_plant"))

#CMD
surv_CMD_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|year) + (1|Provenance)+(1|BLK), data=surv_clim_long_transfer_nog %>% filter(climvar.name=="CMD"), family=binomial)
summary(surv_CMD_mod_nog) #provenances with CMD more similar to plantation had higher survival
r2(surv_CMD_mod_nog)
plot(ggpredict(surv_CMD_mod_nog, terms = "diff_plant"))

#bFFP - correlated to NFFD, FFP, eFFP
surv_bFFP_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|year) + (1|Provenance)+(1|BLK), data=surv_clim_long_transfer_nog %>% filter(climvar.name=="bFFP"), family=binomial)
summary(surv_bFFP_mod_nog) #provenances with bFFP more similar to the plantation have higher probability of survival
r2(surv_bFFP_mod_nog)
plot(ggpredict(surv_bFFP_mod_nog, terms = "diff_plant"))

#y
surv_y_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|year) + (1|Provenance)+(1|BLK), data=surv_clim_long_transfer_nog %>% filter(climvar.name=="y"), family=binomial)
summary(surv_y_mod_nog) #provenances with y more similar to the plantation have higher probability of survival
r2(surv_y_mod_nog)
plot(ggpredict(surv_y_mod_nog, terms = "diff_plant"))

##distance in 2d climate space

surv_climdist_df <- surv_clim_long_transfer %>% 
  dplyr::select(Provenance, BLK, year, alive, died, climvar.name, diff_plant) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
surv_climdist_mod <- glmmTMB(cbind(alive,died) ~ dist_2d + (1|Provenance) + (1|year) + (1|BLK), data=surv_climdist_df, family=binomial)
summary(surv_climdist_mod) # not significant 

```

##Survival 2014

###ANOVA

```{r}
### do survival analyses for each year independently (since overall survival for each year are not independent of each other). For the climate analysis, I'm just going to look at how provenance climate impacted survival to 2014, since this is the most informative for longevity of these trees. 

moniger_survival_byyr_zeros <- moniger_data_comb %>% 
  mutate(Stat79 = ifelse(Stat74 == 9, 0, Stat79)) %>% 
  mutate(Stat85 = ifelse(Stat79 %in% c(NA,9), 0, Stat85)) %>% 
  mutate(Stat91 = ifelse(Stat85 %in% c(NA,9), 0, Stat91)) %>% 
  mutate(Stat96 = ifelse(Stat91 %in% c(NA,9), 0, Stat96)) %>% 
  mutate(Stat06 = ifelse(Stat96 %in% c(NA,9), 0, Stat06)) %>% 
  mutate(Stat14 = ifelse(Stat06 %in% c(NA,9), 0, Stat14)) %>% 
  dplyr::select(c(SORT,LOC,BLK,REP,Provenance,Stat74:Stat14)) %>% 
  pivot_longer(Stat74:Stat14) %>% 
  mutate(year=case_when(name == "Stat74" ~ 1974,
                        name == "Stat79" ~ 1979,
                        name == "Stat85" ~ 1985,
                        name == "Stat91" ~ 1991,
                        name == "Stat96" ~ 1996,
                        name == "Stat06" ~ 2006,
                        name == "Stat14" ~ 2014)) %>% 
  mutate(value = ifelse(value==9,0,value))

moniger_survival_byyr_binom_zeros<- moniger_survival_byyr_zeros %>% 
  group_by(Provenance,BLK,year) %>% 
  summarise(alive=sum(value)) %>% 
  mutate(died=4-alive) %>% 
  full_join(surv_df_zero) %>% 
  mutate(year=ifelse(is.na(year),2014,year),
         alive=ifelse(is.na(alive),0,alive),
         died=ifelse(is.na(died),4,died)) %>% 
  left_join(moniger_survival %>% dplyr::select(c(Provenance,BLK,PC1,PC2,AHM:SHM,x,y,smrpb,monsoonality)) %>% unique()) 

####ANOVAs for each year separately

alltree_survmod74 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1974), family=binomial)
Anova(alltree_survmod74, type="3")
alltree_survmod74_marg = lsmeans(alltree_survmod74, ~ Provenance)

CLD_alltree_survmod74 = cld(alltree_survmod74_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod74 

alltree_survmod79 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1979), family=binomial)
Anova(alltree_survmod79, type="3")
alltree_survmod79_marg = lsmeans(alltree_survmod79, ~ Provenance)

CLD_alltree_survmod79 = cld(alltree_survmod79_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod79 

alltree_survmod85 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1985), family=binomial)
Anova(alltree_survmod85, type="3")
alltree_survmod85_marg = lsmeans(alltree_survmod85, ~ Provenance)

CLD_alltree_survmod85 = cld(alltree_survmod85_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod85 

alltree_survmod91 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1991), family=binomial)
Anova(alltree_survmod91, type="3")
alltree_survmod91_marg = lsmeans(alltree_survmod91, ~ Provenance)

CLD_alltree_survmod91 = cld(alltree_survmod91_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod91 

alltree_survmod96 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1996), family=binomial)
Anova(alltree_survmod96, type="3")
alltree_survmod96_marg = lsmeans(alltree_survmod96, ~ Provenance)

CLD_alltree_survmod96 = cld(alltree_survmod96_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod96 

alltree_survmod06 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==2006), family=binomial) 
Anova(alltree_survmod06, type="3")
alltree_survmod06_marg = lsmeans(alltree_survmod06, ~ Provenance)

CLD_alltree_survmod06 = cld(alltree_survmod06_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod06 

alltree_survmod14 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==2014), family=binomial)
Anova(alltree_survmod14, type="3")
alltree_survmod14_marg = lsmeans(alltree_survmod14, ~ Provenance)

CLD_alltree_survmod14 = cld(alltree_survmod14_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod14 

#####calculate summary stats
moniger_survival_byyr_binom_zeros_2014<- moniger_survival_byyr_binom_zeros %>% filter(year=="2014")
prop_surv_by_prov <- moniger_survival_byyr_binom_zeros_2014 %>% 
  group_by(Provenance) %>% 
  summarise(alive=sum(alive), died=sum(died)) %>% 
  mutate(surv.prop=alive/(died+alive)) %>% 
  arrange(surv.prop)
```

###PC only mods
```{r}

##with gila
survmod2014_pc<- glmmTMB(cbind(alive,died) ~  PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=moniger_survival_byyr_binom_zeros_2014, family=binomial) 
summary(survmod2014_pc)
# 
# dredge_survmod2014_pc <- dredge(survmod2014_pc)
# dredge_survmod2014_pc 

best_survmod2014_pc<- glmmTMB(cbind(alive,died) ~  PC2 + I(PC2^2) + (1|Provenance) + (1|BLK) , data=moniger_survival_byyr_binom_zeros_2014, family=binomial) 
summary(best_survmod2014_pc) #nothing significant

moniger_survival_2014_nog <- moniger_survival_byyr_binom_zeros_2014 %>% filter(!Provenance%in%c("Gila NF"))

##no gila
survmod2014_pc_nog<- glmmTMB(cbind(alive,died) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK) , data=moniger_survival_2014_nog, family=binomial)

summary(survmod2014_pc_nog)
#dredge_survmod2014_pc_nog <- dredge(survmod2014_pc_nog)
#dredge_survmod2014_pc_nog ##null is best
```

###individual climate variables

```{r}
moniger_survival2014_long <- moniger_survival_byyr_binom_zeros_2014 %>% 
  pivot_longer(c(PC1,PC2,AHM:SHM, x:monsoonality), names_to="climvar.name", values_to = "climvar.value")

surv_mods_2014<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
pvalue<- as.data.frame(summary(mod)$coefficients$cond)[2,]$`Pr(>|z|)`
Mr2=r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance)+ (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family=binomial)
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2,]$`Pr(>|z|)`
Mr2_nog=r2(mod_nog)$R2_marginal

surv_mods_2014 <- bind_rows(surv_mods_2014, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog = Mr2_nog))}

surv_mods_2014 %>% arrange(pvalue_nog) ##length of growing season seems to be influential both with and without Gila, also smrpb and y
surv_mods_2014 %>% 
  filter(pvalue_nog<0.05) %>% 
  arrange(desc(Mr2_nog))

###

###create data frame with coefficients of the significant models
surv2014_sigvars <-surv_mods_2014 %>% filter(pvalue_nog<0.05) %>% pull(var)
surv_mods_2014_coeffs<- data.frame()
surv_mods_2014_coeffs_nog <- data.frame()
for(i in 1:length(surv2014_sigvars)){
mod <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) +  (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name==surv2014_sigvars[i]), family=binomial)
p.value<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
estimate <- confint(mod)[2,3]
lwr <- confint(mod)[2,1]
upr <- confint(mod)[2,2]

mod_nog <- glmmTMB(cbind(alive,died) ~ climvar.value + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(!Provenance=="Gila NF") %>% filter(climvar.name==surv2014_sigvars[i]), family=binomial)
p.value_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
estimate_nog <- confint(mod_nog)[2,3]
lwr_nog <- confint(mod_nog)[2,1]
upr_nog <- confint(mod_nog)[2,2]

surv_mods_2014_coeffs <- bind_rows(surv_mods_2014_coeffs, data.frame(var=surv2014_sigvars[i], p.value = p.value, estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
surv_mods_2014_coeffs_nog <- bind_rows(surv_mods_2014_coeffs_nog, data.frame(var=surv2014_sigvars[i],  p.value = p.value_nog, estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
}

surv_mods_2014_coeffs_all<- bind_rows(surv_mods_2014_coeffs, surv_mods_2014_coeffs_nog)

ggplot(surv_mods_2014_coeffs_all, aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.5,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.5, position = position_dodge(width=1))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  ggtitle("2014 Survival - Provenance Climate")

###


#FFP
surv_FFP_mod2014 <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="FFP"), family="binomial")
summary(surv_FFP_mod2014)

surv_FFP_data2014 <- moniger_survival2014_long %>% filter(climvar.name=="FFP")

newdata_FFP_surv2014 <- data.frame(
    climvar.value = seq(min(surv_FFP_data2014$climvar.value), 
                      max(surv_FFP_data2014$climvar.value), 
                      length.out = 100
                      ))

##predictions
surv2014FFP_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_FFP_surv2014$climvar.value),max(newdata_FFP_surv2014$climvar.value),length.out=50))

surv2014_FFP_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival2014_long %>% filter(climvar.name=="FFP"), family="binomial")

surv2014_FFP_newdata2 <- cbind(surv2014FFP_newdata1, predict(surv2014_FFP_mod_glm, newdata = surv2014FFP_newdata1, type = "link", se=TRUE))
surv2014_FFP_newdata3 <- within(surv2014_FFP_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#without Gila is still significant
surv2014_FFP_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) , data=moniger_survival2014_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_FFP_mod_nog)

surv2014_FFP_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival2014_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_FFP_data_nog <- moniger_survival2014_long %>% filter(climvar.name=="FFP") %>% filter(!Provenance=="Gila NF")

surv2014_FFP_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv2014_FFP_data_nog$climvar.value),max(surv2014_FFP_data_nog$climvar.value),length.out=50))

surv2014_FFP_nog_newdata2 <- cbind(surv2014_FFP_nog_newdata1, predict(surv2014_FFP_mod_nog_glm, newdata = surv2014_FFP_nog_newdata1, type = "link", se=TRUE))
surv2014_FFP_nog_newdata3 <- within(surv2014_FFP_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv2014_FFP_bothmod_data<- bind_rows(surv2014_FFP_newdata3 %>% mutate(model="with Gila NF"),
surv2014_FFP_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(surv2014_FFP_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("FFP")+
  theme_bw()
#########
#########

#smrpb
surv2014_smrpb_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="smrpb"), family="binomial")
summary(surv2014_smrpb_mod)

surv2014_smrpb_data <- moniger_survival2014_long %>% filter(climvar.name=="smrpb")

newdata_smrpb_surv2014 <- data.frame(
    climvar.value = seq(min(surv2014_smrpb_data$climvar.value), 
                      max(surv2014_smrpb_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
surv2014_smrpb_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_smrpb_surv2014$climvar.value),max(newdata_smrpb_surv2014$climvar.value),length.out=50))

surv2014_smrpb_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival2014_long %>% filter(climvar.name=="smrpb"), family="binomial")

surv2014_smrpb_newdata2 <- cbind(surv2014_smrpb_newdata1, predict(surv2014_smrpb_mod_glm, newdata = surv2014_smrpb_newdata1, type = "link", se=TRUE))
surv2014_smrpb_newdata3 <- within(surv2014_smrpb_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(surv2014_smrpb_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")

#without Gila is still significant
surv2014_smrpb_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) , data=moniger_survival2014_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_smrpb_mod_nog)

surv2014_smrpb_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) , data=moniger_survival2014_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_smrpb_data_nog <- moniger_survival2014_long %>% filter(climvar.name=="smrpb") %>% filter(!Provenance=="Gila NF")

surv2014_smrpb_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv2014_smrpb_data_nog$climvar.value),max(surv2014_smrpb_data_nog$climvar.value),length.out=50),
                                 Provenance = "Pike NF",
                                 BLK = "C",
                                 year=2006)

surv2014_smrpb_nog_newdata2 <- cbind(surv2014_smrpb_nog_newdata1, predict(surv2014_smrpb_mod_nog_glm, newdata = surv2014_smrpb_nog_newdata1, type = "link", se=TRUE))
surv2014_smrpb_nog_newdata3 <- within(surv2014_smrpb_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv2014_smrpb_bothmod_data<- bind_rows(surv2014_smrpb_newdata3 %>% mutate(model="with Gila NF"),
surv2014_smrpb_nog_newdata3 %>% mutate(model="without Gila NF"))

ggplot(surv2014_smrpb_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("smrpb")+
  theme_bw()
#########

#y
surv2014_y_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+ (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="y"), family="binomial")
summary(surv2014_y_mod)

surv2014_y_data <- moniger_survival2014_long %>% filter(climvar.name=="y")

newdata_y_surv2014 <- data.frame(
    climvar.value = seq(min(surv2014_y_data$climvar.value), 
                      max(surv2014_y_data$climvar.value), 
                      length.out = 100
                      ))

##predictions
surv2014_y_newdata1 <-  expand.grid(climvar.value = seq(min(newdata_y_surv2014$climvar.value),max(newdata_y_surv2014$climvar.value),length.out=50))

surv2014_y_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival2014_long %>% filter(climvar.name=="y"), family="binomial")

surv2014_y_newdata2 <- cbind(surv2014_y_newdata1, predict(surv2014_y_mod_glm, newdata = surv2014_y_newdata1, type = "link", se=TRUE))
surv2014_y_newdata3 <- within(surv2014_y_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(surv2014_y_newdata3, aes(x = climvar.value, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("y")

#without Gila is significant
surv2014_y_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance)+(1|BLK) , data=moniger_survival2014_long %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_y_mod_nog)

surv2014_y_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value), data=moniger_survival2014_long %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF"), family="binomial")


##predictions
surv2014_y_data_nog <- moniger_survival2014_long %>% filter(climvar.name=="y") %>% filter(!Provenance=="Gila NF")

surv2014_y_nog_newdata1 <- expand.grid(climvar.value = seq(min(surv2014_y_data_nog$climvar.value),max(surv2014_y_data_nog$climvar.value),length.out=50),
                                 Provenance = "Pike NF",
                                 BLK = "C",
                                 year=2006)

surv2014_y_nog_newdata2 <- cbind(surv2014_y_nog_newdata1, predict(surv2014_y_mod_nog_glm, newdata = surv2014_y_nog_newdata1, type = "link", se=TRUE))
surv2014_y_nog_newdata3 <- within(surv2014_y_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv2014_y_bothmod_data<- bind_rows(surv2014_y_newdata3 %>% mutate(model="with Gila NF", pvalue = summary(surv2014_y_mod)$coefficient$cond[2,4]),
surv2014_y_nog_newdata3 %>% mutate(model="without Gila NF", pvalue = summary(surv2014_y_mod_nog)$coefficient$cond[2,4]))

ggplot(surv2014_y_bothmod_data, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("y")
#########

###quadratic

surv2014_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) , data=moniger_survival2014_long %>% filter(climvar.name==provenance_climvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name==provenance_climvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2:3,]$`Pr(>|z|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

surv2014_mods_quad <- bind_rows(surv2014_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))

}

surv2014_mods_quad %>% arrange(pvalue2_nog) ##Eref and CMD are significant both with and without Gila, but they are positively correlated so I will just use Eref since it has a larger r2. Also MCMT

###create data frame with coefficients of the significant models
surv2014_quad_sigvars <-surv2014_mods_quad %>% filter(pvalue2_nog<0.05) %>% pull(var)

surv_quadmods_2014_coeffs<- data.frame()
surv_quadmods_2014_coeffs_nog <- data.frame()
for(i in 1:length(surv2014_quad_sigvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK) , data=moniger_survival2014_long %>% filter(climvar.name==surv2014_quad_sigvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`
estimate <- confint(mod)[3,3]
lwr <- confint(mod)[3,1]
upr <- confint(mod)[3,2]

mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name==surv2014_quad_sigvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2:3,]$`Pr(>|z|)`
estimate_nog <- confint(mod_nog)[3,3]
lwr_nog <- confint(mod_nog)[3,1]
upr_nog <- confint(mod_nog)[3,2]

surv_quadmods_2014_coeffs <- bind_rows(surv_quadmods_2014_coeffs, data.frame(var=paste0(surv2014_quad_sigvars[i],"^2"), p.value1 = pvalues[1], p.value2 = pvalues[2], estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
surv_quadmods_2014_coeffs_nog <- bind_rows(surv_quadmods_2014_coeffs_nog, data.frame(var=paste0(surv2014_quad_sigvars[i],"^2"), p.value1 = pvalues_nog[1], p.value2 = pvalues_nog[2], estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
}

surv_mods_2014_coeffs_all<- bind_rows(surv_mods_2014_coeffs, surv_mods_2014_coeffs_nog,surv_quadmods_2014_coeffs,surv_quadmods_2014_coeffs_nog)

surv2014_provclim_coef_plot <- ggplot(surv_mods_2014_coeffs_all, aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.5,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.5, position = position_dodge(width=1))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  ggtitle("2014 Survival - Provenance Climate")



#eFFP
surv2014_eFFP_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="eFFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_eFFP_mod_nog) 
r2(surv2014_eFFP_mod_nog)
plot(ggpredict(surv2014_eFFP_mod_nog, terms = "climvar.value"))+
  geom_vline(xintercept=plantation_only$eFFP, col="darkorange2", linewidth=1)+
  xlab("Provenance eFFP (day)")+
  ylab("Survival Probability")+ggtitle("End of Frost-Free Period (eFFP)")+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=12))

#bFFP
surv2014_bFFP_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="bFFP") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_bFFP_mod_nog) 
r2(surv2014_bFFP_mod_nog)
plot(ggpredict(surv2014_bFFP_mod_nog, terms = "climvar.value"))+
  geom_vline(xintercept=plantation_only$bFFP, col="darkorange2", linewidth=1)+
  xlab("Provenance bFFP (day)")+
  ylab("Survival Probability")+ggtitle("Beginning of Frost-Free Period (bFFP)")+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=12))

#Eref
surv2014_Eref_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_Eref_mod_nog) 
r2(surv2014_Eref_mod_nog)
plot(ggpredict(surv2014_Eref_mod_nog, terms = "climvar.value [all]"))+
  geom_vline(xintercept=plantation_only$Eref, col="darkorange2", linewidth=1)+
  xlab("Provenance Eref")+
  ylab("Survival Probability")+ggtitle("Hargreave's Reference Evaporation (Eref)")+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=12))

#NFFD
surv2014_NFFD_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="NFFD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_NFFD_mod_nog) 
r2(surv2014_NFFD_mod_nog)
plot(ggpredict(surv2014_NFFD_mod_nog, terms = "climvar.value"))+
  geom_vline(xintercept=plantation_only$NFFD, col="darkorange2", linewidth=1)+
  xlab("Provenance NFFD")+
  ylab("Survival Probability")+ggtitle("# Frost-Free Days (NFFD)")+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=12))

#CMD
surv2014_CMD_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_CMD_mod_nog) 
r2(surv2014_CMD_mod_nog)
plot(ggpredict(surv2014_CMD_mod_nog, terms = "climvar.value [100:700]"))+
  geom_vline(xintercept=plantation_only$CMD, col="darkorange2", linewidth=1)+
  xlab("Provenance CMD")+
  ylab("Survival Probability")+ggtitle("Climate Moisture Deicit (CMD)")+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=12))



##Eref
surv2014_eref_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="Eref"), family="binomial")
summary(surv2014_eref_mod)
r2(surv2014_eref_mod)

surv2014_eref_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival2014_long %>% filter(climvar.name=="Eref"), family="binomial")

surv2014_eref_data <- moniger_survival2014_long %>% filter(climvar.name=="Eref")

##predictions
surv2014_eref_newdata1 <- expand.grid(climvar.value = seq(min(surv2014_eref_data$climvar.value),max(surv2014_eref_data$climvar.value),length.out=50))

surv2014_eref_newdata2 <- cbind(surv2014_eref_newdata1, predict(surv2014_eref_mod_glm, newdata = surv2014_eref_newdata1, type = "link", se=TRUE))
surv2014_eref_newdata3 <- within(surv2014_eref_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#without Gila is still significant
surv2014_eref_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_eref_mod_nog)
r2(surv2014_eref_mod_nog)

surv2014_eref_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival2014_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_eref_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival2014_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival2014_long %>% filter(climvar.name=="Eref") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

surv2014_eref_newdata2_nog <- cbind(surv2014_eref_newdata1_nog, predict(surv2014_eref_mod_nog_glm, newdata = surv2014_eref_newdata1_nog, type = "link", se=TRUE))
surv2014_eref_newdata3_nog <- within(surv2014_eref_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv2014_eref_bothmod <- bind_rows(surv2014_eref_newdata3 %>% mutate(model="with Gila NF"),surv2014_eref_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv2014_eref_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("Eref")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()
#########

##MCMT
surv2014_mcmt_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="MCMT"), family="binomial")
summary(surv2014_mcmt_mod)
r2(surv2014_mcmt_mod)

surv2014_mcmt_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival2014_long %>% filter(climvar.name=="MCMT"), family="binomial")

surv2014_mcmt_data <- moniger_survival2014_long %>% filter(climvar.name=="MCMT")

##predictions
surv2014_mcmt_newdata1 <- expand.grid(climvar.value = seq(min(surv2014_mcmt_data$climvar.value),max(surv2014_mcmt_data$climvar.value),length.out=50))

surv2014_mcmt_newdata2 <- cbind(surv2014_mcmt_newdata1, predict(surv2014_mcmt_mod_glm, newdata = surv2014_mcmt_newdata1, type = "link", se=TRUE))
surv2014_mcmt_newdata3 <- within(surv2014_mcmt_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#without Gila is still significant
surv2014_mcmt_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="MCMT") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_mcmt_mod_nog)
r2(surv2014_mcmt_mod_nog)

surv2014_mcmt_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival2014_long %>% filter(climvar.name=="MCMT") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_mcmt_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival2014_long %>% filter(climvar.name=="MCMT") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival2014_long %>% filter(climvar.name=="MCMT") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

surv2014_mcmt_newdata2_nog <- cbind(surv2014_mcmt_newdata1_nog, predict(surv2014_mcmt_mod_nog_glm, newdata = surv2014_mcmt_newdata1_nog, type = "link", se=TRUE))
surv2014_mcmt_newdata3_nog <- within(surv2014_mcmt_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv2014_mcmt_bothmod <- bind_rows(surv2014_mcmt_newdata3 %>% mutate(model="with Gila NF"),surv2014_mcmt_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv2014_mcmt_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("MCMT")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()
#########

##CMD
surv2014_CMD_mod <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="CMD"), family="binomial")
summary(surv2014_CMD_mod)
r2(surv2014_CMD_mod)

surv2014_CMD_mod_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival2014_long %>% filter(climvar.name=="CMD"), family="binomial")

surv2014_CMD_data <- moniger_survival2014_long %>% filter(climvar.name=="CMD")

##predictions
surv2014_CMD_newdata1 <- expand.grid(climvar.value = seq(min(surv2014_CMD_data$climvar.value),max(surv2014_CMD_data$climvar.value),length.out=50))

surv2014_CMD_newdata2 <- cbind(surv2014_CMD_newdata1, predict(surv2014_CMD_mod_glm, newdata = surv2014_CMD_newdata1, type = "link", se=TRUE))
surv2014_CMD_newdata3 <- within(surv2014_CMD_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

#without Gila is still significant
surv2014_CMD_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2) + (1|Provenance) + (1|BLK), data=moniger_survival2014_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_CMD_mod_nog)
r2(surv2014_CMD_mod_nog)

surv2014_CMD_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(climvar.value) + I(scale(climvar.value)^2), data=moniger_survival2014_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_CMD_newdata1_nog <- expand.grid(climvar.value = seq(min(moniger_survival2014_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),max(moniger_survival2014_long %>% filter(climvar.name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(climvar.value)),length.out=50))

surv2014_CMD_newdata2_nog <- cbind(surv2014_CMD_newdata1_nog, predict(surv2014_CMD_mod_nog_glm, newdata = surv2014_CMD_newdata1_nog, type = "link", se=TRUE))
surv2014_CMD_newdata3_nog <- within(surv2014_CMD_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

surv2014_CMD_bothmod <- bind_rows(surv2014_CMD_newdata3 %>% mutate(model="with Gila NF"),surv2014_CMD_newdata3_nog %>% mutate(model="without Gila NF"))

ggplot(surv2014_CMD_bothmod, aes(x = climvar.value, y = PredictedProb, linetype=model)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  xlab("CMD")+
    ylab("Predicted Probability")+
  ggtitle("Survival")+
  theme_bw()
#########
```

#####transfer distance

```{r}

surv2014_clim_long_transfer <- moniger_survival2014_long %>%
  left_join(plantation_climNA, by=c("climvar.name"="var")) %>% 
  mutate(diff_plant = abs(plant_value - climvar.value))

surv2014_clim_long_transfer_nog <- surv2014_clim_long_transfer %>% filter(!Provenance=="Gila NF")

surv2014_mods_transfer<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance) +  (1|BLK), data=surv2014_clim_long_transfer %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
p.value<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance) + (1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name==provenance_climvars[i]), family=binomial)
p.value_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2_nog <- r2(mod_nog)$R2_marginal

surv2014_mods_transfer <- bind_rows(surv2014_mods_transfer, data.frame(var=provenance_climvars[i], p.value = p.value, Mr2=Mr2, p.value_nog = p.value_nog, Mr2_nog=Mr2_nog))

}

surv2014_mods_transfer %>% arrange(p.value_nog) #Eref, RH, y, bFFP, CMD (all same as other survival metric) + FFP, eFFP
surv2014_mods_transfer %>% filter(p.value_nog<0.05) %>% arrange(Mr2_nog) 

###create data frame with coefficients of the significant models
surv2014_transfer_sigvars <-surv2014_mods_transfer %>% filter(p.value_nog<0.05) %>% pull(var)
surv2014_mods_transfer_coeffs<- data.frame()
surv2014_mods_transfer_coeffs_nog <- data.frame()
for(i in 1:length(surv2014_transfer_sigvars)){
mod <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance) +  (1|BLK), data=surv2014_clim_long_transfer %>% filter(climvar.name==surv2014_transfer_sigvars[i]), family=binomial)
p.value<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
estimate <- confint(mod)[2,3]
lwr <- confint(mod)[2,1]
upr <- confint(mod)[2,2]

mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance) + (1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name==surv2014_transfer_sigvars[i]), family=binomial)
p.value_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
estimate_nog <- confint(mod_nog)[2,3]
lwr_nog <- confint(mod_nog)[2,1]
upr_nog <- confint(mod_nog)[2,2]

surv2014_mods_transfer_coeffs <- bind_rows(surv2014_mods_transfer_coeffs, data.frame(var=surv2014_transfer_sigvars[i], p.value = p.value, estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
surv2014_mods_transfer_coeffs_nog <- bind_rows(surv2014_mods_transfer_coeffs_nog, data.frame(var=surv2014_transfer_sigvars[i],  p.value = p.value_nog, estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
}

surv2014_mods_transfer_coeffs_all<- bind_rows(surv2014_mods_transfer_coeffs, surv2014_mods_transfer_coeffs_nog)

surv2014_transfer_coef_plot <- ggplot(surv2014_mods_transfer_coeffs_all, aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.5,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.5, position = position_dodge(width=1))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  ggtitle("2014 Survival - Transfer Distance")

ggarrange(surv2014_provclim_coef_plot, surv2014_transfer_coef_plot, ncol=2, common.legend = TRUE)

#which were the variables with the largest coefficients?
surv2014_mods_transfer_coeffs_nog %>% 
  arrange(desc(estimate))

#Eref
surv2014_Eref_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="Eref"), family=binomial)
summary(surv2014_Eref_mod_nog) #provenances with Eref more similar to plantation had higher survival
r2(surv2014_Eref_mod_nog)
plot(ggpredict(surv2014_Eref_mod_nog, terms = "diff_plant"))+
  xlab("Eref difference from plantation")+
  ylab("Survival Probability")+ggtitle("Eref")

#CMD
surv2014_CMD_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="CMD"), family=binomial)
summary(surv2014_CMD_mod_nog) #provenances with CMD more similar to the plantation have higher probability of survival
r2(surv2014_CMD_mod_nog)
plot(ggpredict(surv2014_CMD_mod_nog, terms = "diff_plant"))+
  xlab("CMD difference from plantation")+
  ylab("Survival Probability")+ggtitle("CMD")

#MWMT
surv2014_MWMT_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="MWMT"), family=binomial)
summary(surv2014_MWMT_mod_nog) #provenances with MWMT more similar to the plantation have higher probability of survival
r2(surv2014_MWMT_mod_nog)
plot(ggpredict(surv2014_MWMT_mod_nog, terms = "diff_plant"))+
  xlab("MWMT difference from plantation")+
  ylab("Survival Probability")+ggtitle("MWMT")

#FFP
surv2014_FFP_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="FFP"), family=binomial)
summary(surv2014_FFP_mod_nog) #provenances with FFP more similar to the plantation have higher probability of survival
r2(surv2014_FFP_mod_nog)
plot(ggpredict(surv2014_FFP_mod_nog, terms = "diff_plant"))+
  xlab("FFP difference from plantation")+
  ylab("Survival Probability")+ggtitle("FFP")

#Tavesm
surv2014_Tavesm_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="Tavesm"), family=binomial)
summary(surv2014_Tavesm_mod_nog) #provenances with Tavesm more similar to the plantation have higher probability of survival
r2(surv2014_Tavesm_mod_nog)

tavesm_data <- surv2014_clim_long_transfer_nog %>% filter(climvar.name=="Tavesm") %>% ungroup() %>% dplyr::select(c(Provenance,climvar.name,climvar.value, diff_plant)) %>% unique() %>% 
  left_join(prop_surv_by_prov) %>% 
  rename(predicted = surv.prop) %>% 
  mutate(prov_plant = climvar.value - plantation_only$Tavesm)

predict_surv_tavesm <- ggpredict(surv2014_Tavesm_mod_nog, terms = "diff_plant")
predict_surv_tavesm_df <- data.frame(predicted = as.numeric(predict_surv_tavesm$predicted), diff_plant = as.numeric(predict_surv_tavesm$x), lwr = as.numeric(predict_surv_tavesm$conf.low), upr=as.numeric(predict_surv_tavesm$conf.high))

ggplot(data=predict_surv_tavesm_df, aes(x=diff_plant, y=predicted))+
  geom_ribbon(aes(ymin=lwr, ymax=upr), fill="black", alpha=0.2)+
  geom_line()+
  scale_color_manual(values=c("skyblue4","tomato3"))+
  geom_point(data=tavesm_data, aes(x=diff_plant, y=predicted, col=prov_plant>0))+
  xlab("Tavesm difference from plantation")+
  ylab("Survival Probability")+ggtitle("Tavesm")

#bFFP
surv2014_bFFP_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="bFFP"), family=binomial)
summary(surv2014_bFFP_mod_nog) #provenances with bFFP more similar to the plantation have higher probability of survival
r2(surv2014_bFFP_mod_nog)
plot(ggpredict(surv2014_bFFP_mod_nog, terms = "diff_plant"))+
  xlab("bFFP difference from plantation")+
  ylab("Survival Probability")+ggtitle("bFFP")

#eFFP
surv2014_eFFP_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="eFFP"), family=binomial)
summary(surv2014_eFFP_mod_nog) #provenances with eFFP more similar to the plantation have higher probability of survival
r2(surv2014_eFFP_mod_nog)
plot(ggpredict(surv2014_eFFP_mod_nog, terms = "diff_plant"))+
  xlab("eFFP difference from plantation")+
  ylab("Survival Probability")+ggtitle("eFFP")

#RH
surv2014_RH_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="RH"), family=binomial)
summary(surv2014_RH_mod_nog) #provenances with RH more similar to the plantation have higher probability of survival
r2(surv2014_RH_mod_nog)
plot(ggpredict(surv2014_RH_mod_nog, terms = "diff_plant"))+
  xlab("RH difference from plantation")+
  ylab("Survival Probability")+ggtitle("RH")

#y
surv2014_y_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="y"), family=binomial)
summary(surv2014_y_mod_nog) #provenances with y more similar to the plantation have higher probability of survival
r2(surv2014_y_mod_nog)
plot(ggpredict(surv2014_y_mod_nog, terms = "diff_plant"))+
  xlab("Latitude difference from plantation")+
  ylab("Survival Probability")+ggtitle("Latitude")

#DD5
surv2014_DD5_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="DD5"), family=binomial)
#MWMT
surv2014_MWMT_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="MWMT"), family=binomial)
#Tavesm
surv2014_Tavesm_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="Tavesm"), family=binomial)
#NFFD
surv2014_NFFD_mod_nog <- glmmTMB(cbind(alive,died) ~ diff_plant + (1|Provenance)+(1|BLK), data=surv2014_clim_long_transfer_nog %>% filter(climvar.name=="NFFD"), family=binomial)

##distance in 2d climate space

surv2014_climdist_df <- surv2014_clim_long_transfer %>% 
  dplyr::select(Provenance, BLK, year, alive, died, climvar.name, diff_plant) %>% 
  filter(climvar.name %in% c("PC1","PC2")) %>% 
  pivot_wider(names_from=climvar.name,values_from = diff_plant) %>% 
  mutate(dist_2d = sqrt(PC1^2 + PC2^2))
  
surv2014_climdist_mod <- glmmTMB(cbind(alive,died) ~ dist_2d + (1|Provenance) + (1|BLK), data=surv2014_climdist_df, family=binomial)
summary(surv2014_climdist_mod) # not significant 
confint(surv2014_climdist_mod)
surv2014_climdist_mod_nog <- glmmTMB(cbind(alive,died) ~ dist_2d + (1|Provenance) + (1|BLK), data=surv2014_climdist_df %>% filter(!Provenance=="Gila NF"), family=binomial)
summary(surv2014_climdist_mod_nog) #not significant
summary(surv2014_climdist_mod_nog)$coef

###final figure

surv2014_allmods<- bind_rows(surv2014_mods_transfer_coeffs_all %>% 
  mutate(type = "transfer distance"),
surv_mods_2014_coeffs_all %>% 
  mutate(type = "provenance climate")) %>% 
  bind_rows(data.frame(var = "2D PCA", p.value = as.data.frame(summary(surv2014_climdist_mod)$coefficients$cond)[2,]$`Pr(>|z|)`, estimate = confint(surv2014_climdist_mod)[2,3], lwr = confint(surv2014_climdist_mod)[2,1], upr = confint(surv2014_climdist_mod)[2,2], model="with Gila NF", type="transfer distance")) %>% 
  bind_rows(data.frame(var = "2D PCA", p.value= as.data.frame(summary(surv2014_climdist_mod_nog)$coefficients$cond)[2,]$`Pr(>|z|)`, estimate = confint(surv2014_climdist_mod_nog)[2,3], lwr = confint(surv2014_climdist_mod_nog)[2,1], upr = confint(surv2014_climdist_mod_nog)[2,2], model="without Gila NF", type="transfer distance")) %>% 
  mutate(var=ifelse(var=="y","latitude",var)) %>% 
  mutate(p.value=ifelse(is.na(p.value),p.value2,p.value))

ggplot(surv2014_allmods, aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.8,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.8, position = position_dodge(width=1))+
  scale_color_manual(values=c("darkgrey","black"))+
  geom_text(aes(x=0.1, label=paste0("p = ",round(p.value,2))), hjust=0, position = position_dodge(width=1),size=3)+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  facet_wrap(~type, scales="free_x")+
  ggtitle("2014 Survival")

surv2014_provclim_modplot<- ggplot(surv2014_allmods %>% filter(type=="provenance climate")%>% bind_rows(data.frame(var=c("Tavesm","RH","MWMT","Eref","DD5","CMD","2D PCA"),type="provenance climate", model="with Gila NF")), aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.8,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.8, position = position_dodge(width=1))+
  scale_color_manual(values=c("gray50","black"))+
  geom_text(data=surv2014_allmods %>% filter(type=="provenance climate"), aes(x=0.08, y=factor(var), color=model, label=paste0("p = ",round(p.value,2))), hjust=0, position = position_dodge(width=1),size=3, show.legend=FALSE)+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
    facet_wrap(~type, scales="free_x")+
  xlim(c(-1.8,0.25))+
  ggtitle("2014 Survival")

surv2014_transfer_modplot <- ggplot(surv2014_allmods %>% filter(type=="transfer distance") %>% bind_rows(data.frame(var=c("smrpb","MCMT^2","Eref^2","CMD^2"),type="transfer distance", model="with Gila NF")), aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.8,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.8, position = position_dodge(width=1))+
  scale_color_manual(values=c("gray50","black"))+
  geom_text(data=surv2014_allmods %>% 
  filter(type=="transfer distance"), aes(x=0.09, y = factor(var), color=model, label=paste0("p = ",round(p.value,2))), hjust=0, position = position_dodge(width=1),size=3, show.legend=F)+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  facet_wrap(~type, scales="free_x")+
  xlim(c(-0.4,0.15))+
  ggtitle("")+
  theme(axis.text.y=element_blank())


ggarrange(surv2014_provclim_modplot, surv2014_transfer_modplot, common.legend=TRUE, align="h", widths=c(1.05,0.9))

```

##Latitude plots

```{r}
###absolute height is log-transformed
###basal area and relative basal area growth are square root transformed

lat_dbh_predictdata_all %>% colnames()
predictdata_lat_dbh_gr_all %>% colnames()
predictdata_lat_dbh_relgrowth_all %>% colnames()

predictdata_lat_ht_all %>% colnames()
predictdata_y_htgrowth_all%>% colnames()
predictdata_y_relht_all%>% colnames()

survy_bothmod_data %>% colnames()
surv2014_y_bothmod_data %>% colnames()

dbh_lat_data<- bind_rows(lat_dbh_predictdata_all %>% mutate(metric="absolute", trait="DBH"),predictdata_lat_dbh_gr_all %>% mutate(metric="increment", trait="DBH", lwr=lwr^2, upr=upr^2, fit=fit^2),predictdata_lat_dbh_relgrowth_all %>% mutate(metric="relative increment", trait="DBH", lwr=lwr^2, upr=upr^2, fit=fit^2) )

ht_lat_data <- bind_rows(predictdata_lat_ht_all %>% rename(value=climvar.value) %>% mutate(metric="absolute", trait="Height", lwr=exp(lwr), upr=exp(upr), fit=exp(fit)),predictdata_y_htgrowth_all %>% mutate(metric="increment", trait="Height"),predictdata_y_relht_all %>% mutate(metric="relative increment", trait="Height")) 

surv_lat_data <- bind_rows(survy_bothmod_data %>% mutate(metric="increment", trait="Survival"), surv2014_y_bothmod_data %>% mutate(metric="absolute", trait="Survival")) %>% 
  dplyr::select(-fit) %>% 
  rename(value=climvar.value, lwr = LL, upr = UL, fit=PredictedProb) 

all_lat_data<- bind_rows(dbh_lat_data, ht_lat_data, surv_lat_data) %>% 
  mutate(units = case_when(trait == "DBH" & metric == "absolute" ~ "DBH (cm)",
                         trait == "DBH" & metric == "increment" ~ "Basal area growth (cm^2/yr)",
                         trait == "DBH" & metric == "relative increment" ~ "Basal area relative growth (%/yr)",
                         trait == "Height" & metric == "absolute" ~ "Height (m)",
                         trait == "Height" & metric == "increment" ~ "Height growth (m/yr)",
                         trait == "Height" & metric == "relative increment" ~ "Height relative growth (%/yr)",
                         trait == "Survival" & metric == "absolute" ~ "% Survival to 2014",
                         trait == "Survival" & metric == "increment" ~ "% Survival each year")) %>% 
  mutate(ypos = case_when(units == "DBH (cm)" & model=="with Gila NF" ~ 8.25,
                          units == "DBH (cm)" & model=="without Gila NF" ~ 8.5,
                          units=="Height (m)"& model=="with Gila NF" ~ 1.35,
                          units=="Height (m)"& model=="without Gila NF" ~ 1.5,
                          units == "% Survival to 2014" & model=="with Gila NF" ~ 0.635,
                          units == "% Survival to 2014" & model=="without Gila NF" ~ 0.655,
                          units=="Basal area growth (cm^2/yr)" & model=="with Gila NF" ~ 4.75,
                          units=="Basal area growth (cm^2/yr)" & model=="without Gila NF" ~ 5,
                          units=="Height growth (m/yr)" & model=="with Gila NF" ~ .15,
                          units=="Height growth (m/yr)" & model=="without Gila NF" ~ .157,
                          units=="% Survival each year" & model=="with Gila NF" ~ 0.9275,
                          units=="% Survival each year" & model=="without Gila NF" ~ 0.9325,
                          units=="Basal area relative growth (%/yr)" & model=="with Gila NF" ~ 14,
                          units=="Basal area relative growth (%/yr)" & model=="without Gila NF" ~ 15,
                          units=="Height relative growth (%/yr)" & model=="with Gila NF"~10.3,
                          units=="Height relative growth (%/yr)" & model=="without Gila NF"~10.5
                          )) %>% 
  bind_rows(data.frame(units="NA",model="with Gila NF"))

lat_rug_data <- expand.grid(value=provs_bylat$y, Provenance=provs_bylat$Provenance, metric=c("absolute","increment","relative increment"), trait=c("DBH","Height","Survival")) %>% 
  mutate(fit = case_when(trait == "DBH" & metric == "absolute" ~ 9,
                         trait == "DBH" & metric == "increment" ~ 7,
                         trait == "DBH" & metric == "relative increment" ~ 25,
                         trait == "Height" & metric == "absolute" ~ 1.2,
                         trait == "Height" & metric == "increment" ~ .2,
                         trait == "Height" & metric == "relative increment" ~ 11.5,
                         trait == "Survival" & metric == "absolute" ~ .75,
                         trait == "Survival" & metric == "increment" ~ .96)) %>% 
  filter(!(metric=="relative increment" & trait=="Survival")) %>% 
  mutate(units = case_when(trait == "DBH" & metric == "absolute" ~ "DBH (cm)",
                         trait == "DBH" & metric == "increment" ~ "Basal area growth (cm^2/yr)",
                         trait == "DBH" & metric == "relative increment" ~ "Basal area relative growth (%/yr)",
                         trait == "Height" & metric == "absolute" ~ "Height (m)",
                         trait == "Height" & metric == "increment" ~ "Height growth (m/yr)",
                         trait == "Height" & metric == "relative increment" ~ "Height relative growth (%/yr)",
                         trait == "Survival" & metric == "absolute" ~ "% Survival to 2014",
                         trait == "Survival" & metric == "increment" ~ "% Survival each year"))
  


ggplot(all_lat_data, aes(x=value, y=fit))+
  geom_line(aes(color=model))+
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=model), alpha=0.3)+
  geom_rug(data=lat_rug_data, aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  facet_wrap(metric~trait, scales="free")+
  facet_wrap(~factor(units, levels=c("% Survival to 2014","DBH (cm)","Height (m)","% Survival each year","Basal area growth (cm^2/yr)","Height growth (m/yr)","NA","Basal area relative growth (%/yr)","Height relative growth (%/yr)")), scales="free_y")+
  geom_text(aes(x=32.5,y=ypos,label=paste0("p = ",round(pvalue,2)), col=model), size=3.5, hjust=0)+
  scale_color_manual(values=c("darkgrey","black"))+
  scale_fill_manual(values=c("darkgrey","black"))+
  geom_vline(xintercept=plantation_only$y, col="darkorange2", linewidth=1)+
  xlab("Provenance latitude (degrees)")+
  ylab("Model fit")+
  theme_bw()

```

```{r}
#for presentation
ggplot(all_lat_data %>% filter(metric%in%c("absolute","increment")& trait %in%c("DBH","Height")), aes(x=value, y=fit))+
  geom_line(aes(color=model))+
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=model), alpha=0.3)+
  geom_rug(data=lat_rug_data%>% filter(metric%in%c("absolute","increment")& trait %in%c("DBH","Height")), aes(x=value,y=fit), linewidth=1, col="black", sides="b")+
  facet_wrap(metric~trait, scales="free")+
  facet_wrap(~factor(units, levels=c("% Survival to 2014","DBH (cm)","Height (m)","% Survival each year","Basal area growth (cm^2/yr)","Height growth (m/yr)","NA","Basal area relative growth (%/yr)","Height relative growth (%/yr)")), scales="free_y")+
  geom_text(aes(x=32.5,y=ypos,label=paste0("p = ",round(pvalue,2)), col=model), size=2, hjust=0)+
  scale_color_manual(values=c("darkgrey","black"))+
  scale_fill_manual(values=c("darkgrey","black"))+
  geom_vline(xintercept=plantation_only$y, col="darkorange2", linewidth=1)+
  xlab("Provenance latitude (degrees)")+
  ylab("Model fit")+
  theme_bw()
```

##RWI

Cores were only taken from one tree from each provenance in each block, therefore we do not include block as a random effect in these models. 

###Raw

```{r}
prov_all <- read.rwl("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Standardized_ring_widths/ARSTAN_output/prov_all.rwl")

rwi.stats(prov_all)
```

####exploration
```{r}
#plot raw data to look at timeseries length
par(mfrow=c(1,1))
plot.rwl(prov_all)

##compare timing of when trees reached 30cm tall (and thus had a growth ring measured)
dbh_age <- prov_all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(prov_all)) %>% 
  pivot_longer(!year, values_to = "rw", names_to="tree") %>% 
  left_join(moniger_data_comb %>% mutate(tree=paste(LOC,BLK,REP,sep="")), by="tree")
  
dbh_age_summary <- dbh_age %>%
  filter(!is.na(rw)) %>% 
  group_by(Provenance,tree) %>% 
  summarise(minyr = as.numeric(min(year)), maxyr=as.numeric(max(year)), n=n()) %>% 
  mutate(years.calc = maxyr-minyr+1)

#compare when time series started (min year)
ggplot(dbh_age_summary, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=minyr))+
  geom_boxplot()+
  geom_point(color="maroon")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#compare length of timeseries
ggplot(dbh_age_summary, aes(x=Provenance, y=n))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

dbh_age_summary2 <- dbh_age_summary %>% 
  left_join(dbh, by=c("tree"="Series","Provenance")) 

ggplot(dbh_age_summary2, aes(x=minyr, y=DBH14, col=Provenance))+
  geom_point() #there isn't a strong correlation between dbh and the length of the timeseries which makes me think that rings were just lost (not that the tree didn't reach DBH height until the min year)
###

##remove NAs from ring width series
prov_all_nona<- prov_all %>% na.omit()
colnames(prov_all_nona)

##raw
ggplot(dbh_age, aes(x=year, y=rw, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance)+
  theme(legend.position = "none")

###investigating series with really low ring width values
dbh_rwi_comp <- dbh_age %>% 
  filter(!tree=="32A1") %>% 
  group_by(Provenance, tree) %>% 
  summarise(sum=sum(rw, na.rm = TRUE)) %>% 
  arrange(tree) %>% 
  bind_cols(dbh %>%
              filter(Series %in% unique(dbh_age$tree)) %>% 
              dplyr::select(-Provenance) %>% 
              arrange(Series) %>% 
  filter(!is.na(DBH14))) %>% 
  mutate(lowsum=ifelse(sum<15,"yes","no"))

dbh_rwi_comp %>% 
  filter(lowsum=="yes")

ggplot(dbh_rwi_comp)+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))

ggplot(dbh_rwi_comp %>% mutate(sum=ifelse(sum<15,sum*10,sum)))+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))+
  geom_abline(slope=1/10,intercept = 0) ##seems like these "low sum" ring measurements are off by a factor of 10
###########
```

####remove bad data

```{r}
#find series that are likely off by an order of magnitude
off_trees<- dbh_rwi_comp %>% 
  filter(lowsum=="yes") %>% pull(tree) %>% c("58A4") #this is the weird tree that's half and half

prov_good_nona <- prov_all_nona %>% dplyr::select(-all_of(off_trees))

###this cuts out sketchy trees and year = 2016
prov_good <- prov_all %>% dplyr::select(-all_of(off_trees)) %>% 
  filter(!row.names(prov_all)=="2016")

#ring width series statistics
par(mfrow=c(1,1))
plot(prov_good, plot.type="spag")
rwl.report(prov_good)
prov_good_stats<- summary(prov_good)
summary(prov_good_stats$ar1)

##some plots of the raw data averaged
dbh_age_good <- dbh_age %>% 
  filter(!tree %in% off_trees)

ave_rw_all <- dbh_age_good %>%
  na.omit() %>% 
  group_by(year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n()))

plantation_aet_sum<- plantation_cwd %>% 
  group_by(year) %>% 
  summarise(aet_sum=sum(aet)) %>% 
  mutate(aet_scale=scale(aet_sum))

ggplot(ave_rw_all, aes(x=as.numeric(year), y=ave_rw))+
  geom_bar(data=plantation_aet_sum, aes(x=as.numeric(year), y=aet_scale), stat="identity")+
  geom_point()+
  geom_errorbar(aes(x=as.numeric(year), ymin=(ave_rw-se), ymax=(ave_rw+se)), col="red")+
  geom_line()
### it seems like the major deviation in the data is in response to the wet period right before the drought, rather than the 2002 drought. 

```

###Detrending

```{r}
##detrending with Spline method - using stiffness of 35 years
##need to figure out what age to start at based on how long the "young tree growth spurt" usually takes

growth.detrended.all = matrix(nrow=nrow(prov_good), ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.all[,i]<- obj
}
colnames(growth.detrended.all) = colnames(prov_good)
rownames(growth.detrended.all) = rownames(prov_good)

rwi.stats(growth.detrended.all, period="max")
chron(growth.detrended.all)
plot(chron(growth.detrended.all), add.spline=TRUE, nyrs=35)
sss(growth.detrended.all)

growth.detrended.df.all <- growth.detrended.all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.all)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df.all, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

##remove first 15 years of ring widths since they are missing for many trees and likely represent unusual growth patterns. 
growth.detrended.short = matrix(nrow=nrow(prov_good)-15, ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good %>% filter(!(row.names(prov_good) < 1985))  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.short[,i]<- obj
}
colnames(growth.detrended.short) = colnames(prov_good)
rownames(growth.detrended.short) = rownames(prov_good)[16:nrow(prov_good)]

rwi.stats(growth.detrended.short, period="max")
plot(chron(growth.detrended.short), add.spline=TRUE, nyrs=35)
sss(growth.detrended.short)
sens1(growth.detrended.short[,1])

##########

growth.detrended.df <- growth.detrended.short %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.short)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree") %>% 
  mutate(period=ifelse(year<2000, "early", "late"))

ggplot(growth.detrended.df, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

growth.detrended.byprov <- growth.detrended.df %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

plantation_clim_cut <- plantation_aet_sum %>% 
  filter(year>1984 & year < 2016)

plantation_clim_cut<- plantation_clim_cut %>% 
  mutate(aet_scale_1 = 2*((plantation_clim_cut$aet_sum  - min(plantation_clim_cut$aet_sum )) / (max(plantation_clim_cut$aet_sum) - min(plantation_clim_cut$aet_sum))) - 1)

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_clim_cut, aes(x=year, y=aet_scale_1), stat="identity")+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="AET (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())

ggplot(growth.detrended.df, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=rw_spline, fill=period))+
  geom_boxplot()+
  theme(axis.text.x=element_text(angle=45))

rwi_byyear<- growth.detrended.df %>% 
  group_by(year) %>% 
  summarise(mean.rwi = mean(rw_spline, na.rm=TRUE)) 
```

####Gini coefficient

```{r}
trees<- unique(growth.detrended.df$tree)

Gini(growth.detrended.df %>% filter(tree==trees[1]) %>% pull(rw_spline), weights=NULL, unbiased = TRUE, conf.level=.95, R=10000, type="bca", na.rm=TRUE)

###get time period with all trees included in all years (common period)
gini_df = data.frame()
for(i in 1:length(trees)){
gini = growth.detrended.df %>% filter(year > 1990 & year < 2011) %>% filter(tree==trees[i]) %>% pull(rw_spline) %>% 
  Gini(weights=NULL, unbiased = TRUE, conf.level=0.95, R=10000, type="perc", na.rm=TRUE)
gini_df = bind_rows(gini_df, data.frame(gini=gini[1], lwr = gini[2], upr=gini[3], tree=trees[i]))
}

gini_byprov<- gini_df %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(tree,BLK,Provenance,HT14,DBH14) %>% unique(), by="tree")

ggplot(gini_byprov, aes(x=factor(Provenance, levels = provs_bylat$Provenance), y=gini, fill=factor(Provenance, levels = provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("Gini coefficient")+
  xlab("Provenance")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "none",
        axis.title = element_text(size=12, color="black"), axis.text = element_text(size = 12, color="black"))

gini_sum<- gini_byprov %>% 
  group_by(Provenance) %>% 
  summarise(mean=mean(gini), sd=sd(gini), se=sd(gini)/sqrt(n()))

gini_plot<- ggplot(gini_sum, aes(x=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code), y=mean, fill=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code), color=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code)))+
  geom_point(size=3)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), linewidth=1, width=0.5)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_y_continuous(breaks=c(0.1,0.2))+
  geom_text(aes(x="DNF", y=0.19, label="p = 0.06"), col="black", size=4)+
  ylab("Gini coefficient")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8), legend.position = "none",
        axis.title = element_text(color="black"), axis.text = element_text(color="black"), axis.title.x = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())

plantation_vpd_scaled <- plantation_clim %>% 
  dplyr::select(c(year, prior_vpdmax_wt))%>% 
  filter(year>1984 & year < 2016) %>% 
  mutate(vpdmax_scale_1 = 2*((prior_vpdmax_wt  - min(prior_vpdmax_wt)) / (max(prior_vpdmax_wt) - min(prior_vpdmax_wt))) - 1) %>% 
  mutate(droughtyr = ifelse(year==2002, "yes","no"))

plantation_ppt_sm_scaled <- plantation_clim %>% 
  dplyr::select(c(year, ppt_sm))%>% 
  filter(year>1984 & year < 2016) %>% 
  mutate(ppt_sm_scale_1 = 2*((ppt_sm  - min(ppt_sm)) / (max(ppt_sm) - min(ppt_sm))) - 1) %>% 
  mutate(droughtyr = ifelse(year==2002, "yes","no"))


rwi_gini_plot<- ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  #geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale_1, fill=droughtyr), stat="identity")+
  geom_bar(data=plantation_ppt_sm_scaled, aes(x=year, y=ppt_sm_scale_1, fill=droughtyr), stat="identity")+
  scale_fill_manual(values=c("gray20","red"), name="Drought Year")+
  ggnewscale::new_scale_fill()+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="Winter VPDmax (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())+
  annotation_custom(ggplotGrob(gini_plot), xmin=1983, xmax=1997, ymin=0.35, ymax=1.1)

png("figures/rwi_gini_plot.png", width=11,height=7, unit="in", res=300)
rwi_gini_plot
dev.off()

##ANOVA

gini_provmod <- lmer(log(gini) ~ Provenance + (1|BLK), data=gini_byprov)
plot(gini_provmod)
qqmath(gini_provmod)
anova(gini_provmod)

gini_marg = lsmeans(gini_provmod, ~ Provenance)

CLD_gini = cld(gini_marg,
          alpha=0.05,
          Letters=letters)
CLD_gini #payette greater than 12, gila less than 10


mean(gini_byprov$gini)
sd(gini_byprov$gini)

##Model with climate as a predictor
gini_clim_df <- gini_byprov %>% 
  left_join(prov_pcapts_big) 

#MAT
gini_byMAT <- lmer(log(gini) ~ MAT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMAT)
qqmath(gini_byMAT)
summary(gini_byMAT)

#map
gini_bymap <- lmer(log(gini) ~ MAP+ (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bymap)
qqmath(gini_bymap)
summary(gini_bymap)

#TD
gini_byTD <- lmer(log(gini) ~ TD + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byTD)
qqmath(gini_byTD)
summary(gini_byTD)

#MCMT
gini_byMCMT <- lmer(log(gini) ~ MCMT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMCMT)
qqmath(gini_byMCMT)
summary(gini_byMCMT)

#MSP
gini_byMSP <- lmer(log(gini) ~ MSP + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMSP)
qqmath(gini_byMSP)
summary(gini_byMSP)

#SHM
gini_bySHM <- lmer(log(gini) ~ SHM + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bySHM)
qqmath(gini_bySHM)
summary(gini_bySHM)

#NFFD
gini_byNFFD <- lmer(log(gini) ~ NFFD + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byNFFD)
qqmath(gini_byNFFD)
summary(gini_byNFFD)

#bFFP
gini_bybFFP <- lmer(log(gini) ~ bFFP + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bybFFP)
qqmath(gini_bybFFP)
summary(gini_bybFFP)

#eFFP
gini_byeFFP <- lmer(log(gini) ~ eFFP + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byeFFP)
qqmath(gini_byeFFP)
summary(gini_byeFFP)

#MWMT
gini_byMWMT <- lmer(log(gini) ~ MWMT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMWMT)
qqmath(gini_byMWMT)
summary(gini_byMWMT)

#dd_0
gini_bydd_0 <- lmer(log(gini) ~ DD0 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bydd_0)
qqmath(gini_bydd_0)
summary(gini_bydd_0)

#dd5
gini_bydd5 <- lmer(log(gini) ~ DD5 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bydd5)
qqmath(gini_bydd5)
summary(gini_bydd5)

#EMT
gini_byEMT <- lmer(log(gini) ~ EMT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byEMT)
qqmath(gini_byEMT)
summary(gini_byEMT)

#cmd
gini_bycmd <- lmer(log(gini) ~ CMD + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bycmd)
qqmath(gini_bycmd)
summary(gini_bycmd)

#pas
gini_bypas <- lmer(log(gini) ~ PAS + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bypas)
qqmath(gini_bypas)
summary(gini_bypas)

#smrpb
gini_bysmrpb <- lmer(log(gini) ~ smrpb + (1|Provenance) + (1|BLK), data=gini_clim_df %>% filter(!Provenance=="Gila NF"))
plot(gini_bysmrpb)
qqmath(gini_bysmrpb)
summary(gini_bysmrpb) ##only significant with Gila included

#PC1
gini_byPC1 <- lmer(log(gini) ~ PC1 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byPC1)
qqmath(gini_byPC1)
summary(gini_byPC1)
#PC2
gini_byPC2 <- lmer(log(gini) ~ PC2 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byPC2)
qqmath(gini_byPC2)
summary(gini_byPC2) 
#PC3
gini_byPC3 <- lmer(log(gini) ~ PC3 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byPC3)
qqmath(gini_byPC3)
summary(gini_byPC3)
gini_byPC3_nog <- lmer(log(gini) ~ PC3 + (1|Provenance) + (1|BLK), data=gini_clim_df %>% filter(!Provenance=="Gila NF"))
summary(gini_byPC3_nog)


###see if gini coefficient is related to survival and growth
tree_data_all <- growth.detrended.df %>% 
  dplyr::select(c(tree,SORT,LOC,BLK,REP)) %>% 
  left_join(moniger_data_comb, by=c("SORT","LOC","BLK","REP"))

gini_all_data<- gini_byprov %>% 
  left_join(unique(tree_data_all))

gini_dbh14_mod <- lmer(DBH14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!is.na(DBH14)))
plot(gini_dbh14_mod)
qqmath(gini_dbh14_mod)
summary(gini_dbh14_mod)

gini_dbh14_mod_nog <- lmer(DBH14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!Provenance=="Gila NF") %>% filter(!is.na(DBH14)))
summary(gini_dbh14_mod_nog)

##predict
newdata_gini_dbh = data.frame(gini=seq(min(gini_all_data$gini), max(gini_all_data$gini),.01))

gini_dbh14_mod_lm <- lm(DBH14 ~ gini, data=gini_all_data %>% filter(!is.na(DBH14)))
predict_gini_dbh = data.frame(gini=newdata_gini_dbh,predict(gini_dbh14_mod_lm, newdata_gini_dbh, interval="confidence"))

ggplot(predict_gini_dbh, aes(x=gini, y=fit))+
  geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.3)+
  geom_line()+
  ylab("DBH (cm)")+
  xlab("Gini coefficient")+
  theme_bw()

gini_ht14_mod <- lmer(HT14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!is.na(HT14)))
plot(gini_ht14_mod)
qqmath(gini_ht14_mod)
summary(gini_ht14_mod)

gini_ht14_mod_nog <- lmer(HT14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!Provenance=="Gila NF") %>%  filter(!is.na(HT14)))
summary(gini_ht14_mod_nog)

##predict
newdata_gini_ht = data.frame(gini=seq(min(gini_all_data$gini), max(gini_all_data$gini),.01))

gini_ht14_mod_lm <- lm(HT14 ~ gini, data=gini_all_data %>% filter(!is.na(HT14)))
predict_gini_ht = data.frame(gini=newdata_gini_ht,predict(gini_ht14_mod_lm, newdata_gini_ht, interval="confidence"))

ggplot(predict_gini_ht, aes(x=gini, y=fit))+
  geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.3)+
  geom_line()+
  ylab("Height (m)")+
  xlab("Gini coefficient")+
  theme_bw()


gini_surv_df<- moniger_survival_byyr_zeros %>% 
  filter(year==2014) %>% 
  mutate(tree=paste0("X",LOC,BLK,REP)) %>% 
  right_join(gini_byprov)
  
gini_surv14_mod <- glmmTMB(value ~ gini + (1|BLK), data=gini_surv_df, family=binomial(link="logit"))
summary(gini_surv14_mod) #not significant
r2(gini_surv14_mod)

gini_surv14_mod_nog <- glmmTMB(value ~ gini + (1|BLK), data=gini_surv_df %>% filter(!Provenance=="Gila NF"), family=binomial(link="logit"))
summary(gini_surv14_mod_nog)

```

###Resistance vs. Resilience

####Odd time periods

#####Detrended with spline

```{r}
###DETRENDED DATA
droughtyear = 2002
buffertime = seq(0,3,1)
spline_calcs_list<- list()
for(i in 1:length(buffertime)){
drought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] & year <= droughtyear + buffertime[i]) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rw = mean(rw_spline))

predrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear - buffertime[i] - 1 - buffertime[i]*2 & year <= droughtyear - buffertime[i] - 1) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rw = mean(rw_spline))

postdrought_rw<- growth.detrended.df %>% 
  filter(year >= droughtyear + buffertime[i] + 1  & year <= droughtyear + buffertime[i] + 1 + buffertime[i]*2) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rw = mean(rw_spline))

spline_calcs_list[[i]] <- left_join(drought_rw,predrought_rw) %>% left_join(postdrought_rw) %>% 
  mutate(resistance = drought_ave_rw/predrought_ave_rw, resilience = postdrought_ave_rw/predrought_ave_rw) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")
}

splinemodlist_resistance<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resistance[[i]] <- aov(resistance ~ Provenance, data=spline_calcs_list[[i]])
}
summary(splinemodlist_resistance[[1]])
summary(splinemodlist_resistance[[2]]) #3yr still significant but diff provs
TukeyHSD(splinemodlist_resistance[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05)
cld(lsmeans(splinemodlist_resistance[[2]], ~Provenance), alpha=0.05, Letters=letters)

ggplot(as.data.frame(spline_calcs_list[[2]]), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
summary(splinemodlist_resistance[[3]])
summary(splinemodlist_resistance[[4]]) 

splinemodlist_resilience<- list()
for(i in 1:length(spline_calcs_list)){
splinemodlist_resilience[[i]] <- aov(resilience ~ Provenance, data=spline_calcs_list[[i]] %>% filter(!is.na(resilience)))
}
summary(splinemodlist_resilience[[1]])
summary(splinemodlist_resilience[[2]]) ##3 year periods is significant
TukeyHSD(splinemodlist_resilience[[2]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #all Gila
cld(lsmeans(splinemodlist_resilience[[2]], ~Provenance), alpha=0.05, Letters=letters)
summary(splinemodlist_resilience[[3]]) ##5 year periods is significant (p < 0.05)
TukeyHSD(splinemodlist_resilience[[3]])$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #Gila, in addition to Inlet Creek being lower than Larimer 2 and Pike
ggplot(as.data.frame(spline_calcs_list[[3]]), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
cld(lsmeans(splinemodlist_resilience[[3]], ~Provenance), alpha=0.05, Letters=letters)

summary(splinemodlist_resilience[[4]]) 

####

lapply(spline_calcs_list, summary)
spline_calcs_list[[1]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[2]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[3]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience))
spline_calcs_list[[4]] %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(sd.resist=sd(resistance), sd.resil = sd(resilience,na.rm=T))

```

####Even time periods

#####Detrended with spline

```{r}
## even time periods
####
#01-02 - 2 years, significant for resistance

drought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0102<- growth.detrended.df %>% 
  filter(year >= 2003 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0102 <- left_join(drought_rwi_0102,predrought_rwi_0102) %>% left_join(postdrought_rwi_0102) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0102 <- aov(resistance ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resistance_0102)
TukeyHSD(splinemodlist_resistance_0102)$Provenance %>% as.data.frame() %>% filter(`p adj` <0.05) #significant but no pairwiise differences
cld(lsmeans(splinemodlist_resistance_0102, ~Provenance),alpha=0.05, Letters=letters)

splinemodlist_resilience_0102 <- aov(resilience ~ Provenance, data=spline_calcs_0102)

summary(splinemodlist_resilience_0102)

#02-03 - 2 years, not significant

drought_rwi_0203<- growth.detrended.df %>%
  filter(year >= 2002 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2001) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0203<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0203 <- left_join(drought_rwi_0203,predrought_rwi_0203) %>% left_join(postdrought_rwi_0203) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0203 <- aov(resistance ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resistance_0203)

splinemodlist_resilience_0203 <- aov(resilience ~ Provenance, data=spline_calcs_0203)

summary(splinemodlist_resilience_0203)

#01-04 - 4 years, significant resilience only

drought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2001 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 1997 & year <= 2000) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0104<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2008) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0104 <- left_join(drought_rwi_0104,predrought_rwi_0104) %>% left_join(postdrought_rwi_0104) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0104 <- aov(resistance ~ Provenance, data=spline_calcs_0104)
TukeyHSD(splinemodlist_resistance_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

summary(splinemodlist_resistance_0104)
cld(lsmeans(splinemodlist_resistance_0104, ~Provenance), alpha = 0.05, Letters=letters)

splinemodlist_resilience_0104 <- aov(resilience ~ Provenance, data=spline_calcs_0104)

summary(splinemodlist_resilience_0104)
TukeyHSD(splinemodlist_resilience_0104)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
cld(lsmeans(splinemodlist_resilience_0104, ~Provenance), alpha = 0.05, Letters=letters)

ggplot(as.data.frame(spline_calcs_0104), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#00-03 - 4 years, significant reslience only 

drought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2003) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 1996 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0003<- growth.detrended.df %>% 
  filter(year >= 2004 & year <= 2007) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0003 <- left_join(drought_rwi_0003,predrought_rwi_0003) %>% left_join(postdrought_rwi_0003) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0003 <- aov(resistance ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resistance_0003)

splinemodlist_resilience_0003 <- aov(resilience ~ Provenance, data=spline_calcs_0003)

summary(splinemodlist_resilience_0003)
TukeyHSD(splinemodlist_resilience_0003)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
cld(lsmeans(splinemodlist_resilience_0003, ~Provenance), alpha=0.05, Letters=letters)
ggplot(as.data.frame(spline_calcs_0003), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#00-05 - 6 years 

drought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2000 & year <= 2005) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 1994 & year <= 1999) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_0005<- growth.detrended.df %>% 
  filter(year >= 2006 & year <= 2011) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_0005 <- left_join(drought_rwi_0005,predrought_rwi_0005) %>% left_join(postdrought_rwi_0005) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_0005 <- aov(resistance ~ Provenance, data=spline_calcs_0005)

summary(splinemodlist_resistance_0005)

splinemodlist_resilience_0005 <- aov(resilience ~ Provenance, data=spline_calcs_0005 %>% filter(!is.na(resilience)))

summary(splinemodlist_resilience_0005)
TukeyHSD(splinemodlist_resilience_0005)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
cld(lsmeans(splinemodlist_resilience_0005, ~Provenance), alpha=0.05, Letters=letters)
ggplot(as.data.frame(spline_calcs_0005), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))


#99-04 - 6 years not significant for either resistance or resilience

drought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1999 & year <= 2004) %>% 
  group_by(tree) %>% 
  summarise(drought_ave_rwi = mean(rw_spline))

predrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 1993 & year <= 1998) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave_rwi = mean(rw_spline))

postdrought_rwi_9904<- growth.detrended.df %>% 
  filter(year >= 2005 & year <= 2010) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave_rwi = mean(rw_spline))

spline_calcs_9904 <- left_join(drought_rwi_9904,predrought_rwi_9904) %>% left_join(postdrought_rwi_9904) %>% 
  mutate(resistance = drought_ave_rwi/predrought_ave_rwi, resilience = postdrought_ave_rwi/predrought_ave_rwi) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(BLK,tree,Provenance) %>% unique(), by="tree")

splinemodlist_resistance_9904 <- aov(resistance ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resistance_9904)

splinemodlist_resilience_9904 <- aov(resilience ~ Provenance, data=spline_calcs_9904)

summary(splinemodlist_resilience_9904)
TukeyHSD(splinemodlist_resilience_9904)$Provenance %>% as.data.frame() %>% filter(`p adj`<0.05)
cld(lsmeans(splinemodlist_resilience_9904, ~Provenance), alpha=0.05, Letters=letters)
ggplot(as.data.frame(spline_calcs_9904), aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

###### summary stats
spline_calcs_0102 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0203 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0104 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0003 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience), sd.resil = sd(resilience))

spline_calcs_0005 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience,na.rm=T), sd.resil = sd(resilience,na.rm=T))

spline_calcs_9904 %>% dplyr::select(c(resistance,resilience)) %>% as.data.frame() %>% 
  summarise(mean.resist = mean(resistance), sd.resist=sd(resistance), mean.resil = mean(resilience, na.rm=T), sd.resil = sd(resilience, na.rm=T))
```


####Climate Trends in RR

#####resistance

```{r}
##I'm going to look at trends in resistance and resilience (spline detrended) due to provenance climate for all the time periods that had significant differences between provenances. For resistance, this is drought = 2001-2002 (2), 2001-2003 (3), and 2001-2004 (4).

#####01-02
RR0102_clim<- spline_calcs_0102 %>% 
  left_join(prov_pcapts_big)

##PCA models
resis_0102mod_pc <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR0102_clim)
plot(resis_0102mod_pc)
qqmath(resis_0102mod_pc)
summary(resis_0102mod_pc) 

resis_0102mod_pc_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR0102_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_0102mod_pc_noG)
qqmath(resis_0102mod_pc_noG)
summary(resis_0102mod_pc_noG) #nothing significant when Gila removed

#dredge(resis_0102mod_pc) ##null model is the best

RR0102_clim_long <- RR0102_clim %>% pivot_longer(all_of(provenance_climvars))
RR0102_clim_long_nog <- RR0102_clim_long %>% filter(!Provenance=="Gila NF")

RR0102_resist_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR0102_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR0102_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR0102_resist_mods <- bind_rows(RR0102_resist_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR0102_resist_mods %>% arrange(pvalue_nog) #CMD, y

#CMD
RR0102_resist_CMD_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR0102_clim_long %>% filter(name=="CMD"))
summary(RR0102_resist_CMD_mod)

#y
RR0102_resist_y_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR0102_clim_long %>% filter(name=="y"))
summary(RR0102_resist_y_mod)

#quadratic
RR0102_resist_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR0102_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR0102_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR0102_resist_mods_quad <- bind_rows(RR0102_resist_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR0102_resist_mods_quad %>% arrange(pvalue_nog) #nothing significant

```

```{r}
#####3 year
RR3_clim<- spline_calcs_list[[2]] %>% 
  left_join(prov_pcapts_big)

##PCA models
resis_3mod_pc <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR3_clim)
plot(resis_3mod_pc)
qqmath(resis_3mod_pc)
summary(resis_3mod_pc) 

resis_3mod_pc_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_3mod_pc_noG)
qqmath(resis_3mod_pc_noG)
summary(resis_3mod_pc_noG) #nothing significant when Gila removed

#dredge(resis_3mod_pc) ##null model is the best

RR3_clim_long <- RR3_clim %>% pivot_longer(all_of(provenance_climvars))
RR3_clim_long_nog <- RR3_clim_long %>% filter(!Provenance=="Gila NF")

RR3_resist_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR3_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR3_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR3_resist_mods <- bind_rows(RR3_resist_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR3_resist_mods %>% arrange(pvalue_nog) #Eref, MCMT, y

#Eref
RR3_resist_Eref_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR3_clim_long %>% filter(name=="Eref"))
summary(RR3_resist_Eref_mod)

ggplot(RR3_clim_long %>% filter(name=="Eref"), aes(x=value, y=resistance))+
  geom_point()+
  geom_smooth(method="lm")

#y
RR3_resist_y_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR3_clim_long %>% filter(name=="y"))
summary(RR3_resist_y_mod)

#MCMT
RR3_resist_MCMT_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR3_clim_long %>% filter(name=="MCMT"))
summary(RR3_resist_MCMT_mod)

#quadratic
RR3_resist_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR3_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR3_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR3_resist_mods_quad <- bind_rows(RR3_resist_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR3_resist_mods_quad %>% arrange(pvalue_nog2) #nothing significant
```

```{r}
##4 year 01-04

RR4_clim<- spline_calcs_0104 %>% 
  left_join(prov_pcapts_big) 

##PCA models
resis_mod_pc <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR4_clim)
plot(resis_mod_pc)
qqmath(resis_mod_pc)
summary(resis_mod_pc) 

resis_mod_pc_noG <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR4_clim %>% filter(!Provenance=="Gila NF"))
plot(resis_mod_pc_noG)
qqmath(resis_mod_pc_noG)
summary(resis_mod_pc_noG) 

#dredge(resis_mod_pc) ##null model is the best

RR4_clim_long <- RR4_clim %>% pivot_longer(all_of(provenance_climvars))
RR4_clim_long_nog <- RR4_clim_long %>% filter(!Provenance=="Gila NF")

RR4_resist_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR4_resist_mods <- bind_rows(RR4_resist_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR4_resist_mods %>% arrange(pvalue_nog) #MCMT, y

#y
RR4_resist_y_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name=="y"))
summary(RR4_resist_y_mod)

#MCMT
RR4_resist_MCMT_mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name=="MCMT"))
summary(RR4_resist_MCMT_mod)

ggplot(RR4_clim_long %>% filter(name=="MCMT"), aes(x=value, y=resistance))+
  geom_point()+
  geom_smooth(method="lm")

#quadratic
RR4_resist_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR4_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR4_resist_mods_quad <- bind_rows(RR4_resist_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR4_resist_mods_quad %>% arrange(pvalue_nog2) #PPTsm

#PPTsm
RR4_resist_PPTsm_mod <- lmer(log(resistance) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR4_clim_long_nog %>% filter(name=="PPTsm"))
summary(RR4_resist_PPTsm_mod)

ggplot(RR4_clim_long %>% filter(name=="PPTsm"), aes(x=value, y=resistance))+
  geom_point()
  
```

#####resilience

```{r}
##I'm going to look at trends in resistance and resilience (spline detrended) due to provenance climate for all the time periods that had significant differences between provenances. For resilience, this is drought = 2001-2003 (3), 2001-2004 (4), 2000-2003 (4), 2000-2004 (5), 2000-2005 (6), 1999-2004 (6).

##
resil_mod_pc <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR4_clim)
plot(resil_mod_pc)
qqmath(resil_mod_pc)
summary(resil_mod_pc)

RR4_clim_noG <- RR4_clim %>% filter(!Provenance == "Gila NF")

resil_mod_pc_noG <- lmer(resilience ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR4_clim_noG)
plot(resil_mod_pc_noG)
qqmath(resil_mod_pc_noG)
summary(resil_mod_pc_noG)

# dredge(resil_mod_pc) #null model is best when Gila is included
# dredge(resil_mod_pc_noG) #null is best when Gila is excluded

RR4_resil_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR4_resil_mods <- bind_rows(RR4_resil_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR4_resil_mods %>% arrange(pvalue_nog) #MCMT

#MCMT
RR4_resil_MCMT_mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name=="MCMT"))
summary(RR4_resil_MCMT_mod)

ggplot(RR4_clim_long %>% filter(name=="MCMT") %>% filter(!Provenance=="Gila NF"), aes(x=value, y=resilience))+
  geom_point()+
  geom_smooth(method="lm")

#quadratic
RR4_resil_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR4_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR4_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR4_resil_mods_quad <- bind_rows(RR4_resil_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR4_resil_mods_quad %>% arrange(pvalue_nog2) #y

```

```{r}
#####00-03
RR0003_clim<- spline_calcs_0003 %>% 
  left_join(prov_pcapts_big) 

##PCA models
resil_0003mod_pc <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR0003_clim)
plot(resil_0003mod_pc)
qqmath(resil_0003mod_pc)
summary(resil_0003mod_pc) 

resil_0003mod_pc_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR0003_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_0003mod_pc_noG)
qqmath(resil_0003mod_pc_noG)
summary(resil_0003mod_pc_noG) #nothing significant when Gila removed

# dredge(resil_0003mod_pc) ##null model is the best

RR0003_clim_long<- RR0003_clim %>% pivot_longer(all_of(provenance_climvars))
RR0003_clim_long_nog <- RR0003_clim_long %>% filter(!Provenance=="Gila NF")

RR0003_resil_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR0003_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR0003_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR0003_resil_mods <- bind_rows(RR0003_resil_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR0003_resil_mods %>% arrange(pvalue_nog) #nothing

#quadratic
RR0003_resil_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR0003_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR0003_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR0003_resil_mods_quad <- bind_rows(RR0003_resil_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR0003_resil_mods_quad %>% arrange(pvalue_nog2) #PPTsm

```

```{r}
#####00-04
RR9904_clim<-  spline_calcs_9904 %>% 
  left_join(prov_pcapts_big) 

##PCA models
resil_9904mod_pc <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR9904_clim)
plot(resil_9904mod_pc)
qqmath(resil_9904mod_pc)
summary(resil_9904mod_pc) 

resil_9904mod_pc_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR9904_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_9904mod_pc_noG)
qqmath(resil_9904mod_pc_noG)
summary(resil_9904mod_pc_noG) #nothing significant when Gila removed

# dredge(resil_9904mod_pc) ##null model is the best


RR9904_clim_long<- RR9904_clim %>% pivot_longer(all_of(provenance_climvars))
RR9904_clim_long_nog <- RR9904_clim_long %>% filter(!Provenance=="Gila NF")

RR9904_resil_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR9904_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR9904_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR9904_resil_mods <- bind_rows(RR9904_resil_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR9904_resil_mods %>% arrange(pvalue_nog) #MCMT

#quadratic
RR9904_resil_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR9904_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR9904_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR9904_resil_mods_quad <- bind_rows(RR9904_resil_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR9904_resil_mods_quad %>% arrange(pvalue_nog2) #x

```

```{r}
#####00-05
RR0005_clim<-  spline_calcs_0005 %>% 
  left_join(prov_pcapts_big) 

RR0005_clim_resil <- RR0005_clim %>% 
  filter(!is.na(resilience))
##PCA models
resil_0005mod_pc <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR0005_clim_resil)
plot(resil_0005mod_pc)
qqmath(resil_0005mod_pc)
summary(resil_0005mod_pc) 

resil_0005mod_pc_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR0005_clim_resil %>% filter(!Provenance=="Gila NF"))
plot(resil_0005mod_pc_noG)
qqmath(resil_0005mod_pc_noG)
summary(resil_0005mod_pc_noG) #nothing significant when Gila removed

# dredge(resil_0005mod_pc) ##null model is the best

RR0005_clim_resil_long<- RR0005_clim_resil %>% pivot_longer(all_of(provenance_climvars))
RR0005_clim_resil_long_nog <- RR0005_clim_resil_long %>% filter(!Provenance=="Gila NF")

RR0005_resil_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR0005_clim_resil_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=RR0005_clim_resil_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR0005_resil_mods <- bind_rows(RR0005_resil_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

RR0005_resil_mods %>% arrange(pvalue_nog) #MCMT, Tavewt

#quadratic
RR0005_resil_mods_quad<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR0005_clim_resil_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + I(value^2) + (1|Provenance)+ (1|BLK), data=RR0005_clim_resil_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

RR0005_resil_mods_quad <- bind_rows(RR0005_resil_mods_quad, data.frame(var=provenance_climvars[i], pvalue = pvalue[1], pvalue2 = pvalue[2], Mr2=Mr2, pvalue_nog = pvalue_nog[1], pvalue_nog2 = pvalue_nog[2], Mr2_nog=Mr2_nog))
}

RR0005_resil_mods_quad %>% arrange(pvalue_nog2) #MCMT

```

```{r}
#####3 year
##PCA models
resil_3mod_pc <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR3_clim)
plot(resil_3mod_pc)
qqmath(resil_3mod_pc)
summary(resil_3mod_pc) 

resil_3mod_pc_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR3_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_3mod_pc_noG)
qqmath(resil_3mod_pc_noG)
summary(resil_3mod_pc_noG) #nothing significant 

# dredge(resil_3mod_pc) ##null model is the best
```

```{r}
#####5 year
RR5_clim <- spline_calcs_list[[3]] %>% 
  left_join(prov_pcapts_big)

##PCA models
resil_5mod_pc <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR5_clim)
plot(resil_5mod_pc)
qqmath(resil_5mod_pc)
summary(resil_5mod_pc) 

resil_5mod_pc_noG <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance) + (1|BLK), data=RR5_clim %>% filter(!Provenance=="Gila NF"))
plot(resil_5mod_pc_noG)
qqmath(resil_5mod_pc_noG)
summary(resil_5mod_pc_noG) #nothing significant 

# dredge(resil_5mod_pc) ##null model is the best
```

###Other Metrics

####long pre-drought

```{r}
###calculate resistance using all growth data from 1985 - 2001 as the pre-drought period
drought_new<- growth.detrended.df %>% 
  filter(year == 2002) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2002) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

postdrought_new<- growth.detrended.df %>% 
  filter(year > 2002) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs <- left_join(drought_new,predrought_new) %>% left_join(postdrought_new) %>% 
  mutate(resistance = drought_ave/predrought_ave, resilience = postdrought_ave/predrought_ave) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(tree,Provenance,BLK) %>% unique(), by="tree")

mean(new_calcs$resistance);sd(new_calcs$resistance)
mean(new_calcs$resilience);sd(new_calcs$resilience)
new_calcs %>% filter(Provenance=="Gila NF") %>% pull(resilience) %>% mean()

new_aov_resist <- lmer(resistance ~ Provenance + (1|BLK), data=new_calcs)
plot(new_aov_resist)
qqmath(new_aov_resist)
anova(new_aov_resist) #no difference in resistance when compared to average growth 1985-2002

ggplot(new_calcs, aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

R8502_clim <- new_calcs %>% 
  left_join(prov_pcapts_big)

R8502_clim_long<- R8502_clim %>% 
  pivot_longer(all_of(provenance_climvars))
R8502_clim_long_nog <- R8502_clim_long %>% filter(!Provenance=="Gila NF")

R8502_resis_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

R8502_resis_mods <- bind_rows(R8502_resis_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

R8502_resis_mods %>% arrange(pvalue_nog) #nothing significant

resis_pc_mod <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim)
plot(resis_pc_mod)
qqmath(resis_pc_mod)
summary(resis_pc_mod)

R8502_clim_nog <- R8502_clim %>% filter(!Provenance=="Gila NF")

resis_pc_mod_nog <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim_nog)
plot(resis_pc_mod_nog)
qqmath(resis_pc_mod_nog)
summary(resis_pc_mod_nog)

dredge(resis_pc_mod_nog) #null is best


####resilience

new_aov_resil <- lmer(resilience ~ Provenance + (1|BLK), data=new_calcs)
plot(new_aov_resil)
qqmath(new_aov_resil)
anova(new_aov_resil) #significant difference in resilience when compared to average growth 1985-2002
cld(lsmeans(new_aov_resil, ~Provenance),
          alpha=0.05,
          Letters=letters) #just Gila is different

ggplot(new_calcs, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

R8502_resil_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

R8502_resil_mods <- bind_rows(R8502_resil_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

R8502_resil_mods %>% arrange(pvalue_nog) #nothing significant

resil_pc_mod <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim)
plot(resil_pc_mod)
qqmath(resil_pc_mod)
summary(resil_pc_mod)

R8502_clim_nog <- R8502_clim %>% filter(!Provenance=="Gila NF")

resil_pc_mod_nog <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim_nog)
plot(resil_pc_mod_nog)
qqmath(resil_pc_mod_nog)
summary(resil_pc_mod_nog)

dredge(resil_pc_mod_nog) #null is best

```


####recovery time
```{r}
#####recovery time 

no_reduction<- growth.detrended.df %>% 
  filter(year == 2002) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff<0) ##50 trees didn't reduce growth in 2002

count_no_red<- growth.detrended.df %>%
  filter(year==2002) %>% 
  group_by(Provenance) %>% 
  summarise(ntrees=n()) %>% 
  left_join(no_reduction %>% group_by(Provenance) %>% summarise(nNR=n()))

ggplot(count_no_red, aes(x=Provenance, y=(nNR/ntrees)*100))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))
  
recover_time<- growth.detrended.df %>%
  filter(!tree %in% no_reduction$tree) %>% 
  filter(year > 2001) %>%
  left_join(predrought_new) %>% 
  mutate(diff = rw_spline - predrought_ave) %>% 
  filter(diff>0) %>% 
  group_by(tree) %>% 
  summarise(minyr = min(year)) %>% 
  mutate(recoverytime = as.numeric(minyr) - 2002) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(tree,Provenance,BLK) %>% unique(), by="tree")

aov.recover <- lmer(log(recoverytime) ~ Provenance + (1|BLK), data=recover_time)
plot(aov.recover)
qqmath(aov.recover)
anova(aov.recover)  #no difference in recovery time

ggplot(recover_time, aes(x=Provenance, y=recoverytime))+
  geom_boxplot()+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##climate model for recovery time
recover_time_clim <- recover_time %>% 
  left_join(prov_pcapts_big)

recov_mod_pca <- lmer(log(recoverytime) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pca)
qqmath(recov_mod_pca)
summary(recov_mod_pca)
# dredge(recov_mod_pca) #null model is best

###
not_recovered<- dbh_age_good %>% 
  mutate(tree=paste0("X",tree)) %>% 
  filter(! tree %in% no_reduction$tree) %>% 
  filter(! tree %in% recover_time$tree) 
not_recovered ##all of the trees recovered

#total growth reduction
growth_red<- growth.detrended.df %>% 
  filter(!tree %in% no_reduction$tree) %>% 
  filter(!tree %in% unique(not_recovered$tree)) %>% 
  filter(year>2001) %>% 
  left_join(predrought_new) %>% 
  mutate(growth_red = predrought_ave-rw_spline) %>% 
  filter(growth_red>0)

growth_red_sum <- growth_red %>% 
  left_join(recover_time) %>% 
  mutate(year_diff = minyr-year) %>% 
  filter(year_diff > 0) %>% 
  group_by(Provenance,BLK,tree) %>% 
  summarise(max.growth.red = max(growth_red), sum.growth.red=sum(growth_red)) %>% 
  left_join(growth_red, by=c("max.growth.red" = "growth_red", "tree","Provenance","BLK")) %>% 
  left_join(recover_time, by=c("Provenance", "tree","BLK")) %>% 
  left_join(prov_pcapts_big) 

##max growth reduction models
#anova
aov.mgr <- lmer(max.growth.red ~ Provenance + (1|BLK), data=growth_red_sum)
plot(aov.mgr)
qqmath(aov.mgr)
anova(aov.mgr)  #no significant difference in max growth reduction between provenances

#linear models
mgr.pcmod <- lmer(max.growth.red ~ PC1*PC2 + (1|Provenance) + (1|BLK), data=growth_red_sum)
plot(mgr.pcmod)
qqmath(mgr.pcmod)
summary(mgr.pcmod)
# dredge(mgr.pcmod) #null is best

##sum growth reduction models
#anova
aov.sumgr <- lmer(log(sum.growth.red) ~ Provenance + (1|BLK), data=growth_red_sum)
plot(aov.sumgr)
qqmath(aov.sumgr)
anova(aov.sumgr)  #no significant difference in sum growth reduction between provenances

#linear models
sumgr.pcmod <- lmer(log(sum.growth.red) ~ PC1*PC2 + (1|Provenance) + (1|BLK), data=growth_red_sum)
plot(sumgr.pcmod)
qqmath(sumgr.pcmod)
summary(sumgr.pcmod)
# dredge(sumgr.pcmod) #null is best

```

##Correlations

###climate x climate cors
```{r}
##look at correlation between current year and previous year climate variables at plantation

plantation_clim_cor<- plantation_clim %>% 
  ungroup() %>% 
  filter(year > 1970 & year < 2023) %>% 
 dplyr::select(c(prior_ppt_sm, prior_ppt_wt:prior_tmax_sm, prior_tmean_wt:vpdmax_sm, prior_vpdmax_wt:prior_vpdmax_sm, prior_cwd_sm, prior_cwd_wt:prior_aet_sm, prior_aet_wt:aet_sm)) %>% 
  cor()

plantation_clim_cor

ggcorrplot(plantation_clim_cor, type="lower", insig = "blank", lab=FALSE)

```

###growth x climate cors

```{r}
##calculate correlations between detrended growth and climate at plantation

plantation_frost_minus1<- plantation_frost %>% mutate(year = year+1) 

colnames(plantation_frost_minus1)<- paste("prior_",colnames(plantation_frost_minus1),sep="")

growth_climate_df <- growth.detrended.df %>% 
  left_join(plantation_clim) %>% 
  left_join(plantation_frost) %>% 
  left_join(plantation_frost_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  filter(!is.na(rw_spline)) %>% 
  dplyr::select(-site) %>% 
  dplyr::select(-prior_day_of_last_spring_frost) %>% 
  rename(dofff_sm = day_of_first_fall_frost, dolsf_sp= day_of_last_spring_frost, prior_dofff_sm = prior_day_of_first_fall_frost)

climvars <- colnames(growth_climate_df %>% dplyr::select(c(prior_ppt_sm:prior_dofff_sm)))
tree_ids <- unique(growth_climate_df$tree)

gc_cor_df<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i])
  tree <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline)
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df <- bind_rows(gc_cor_df, row)
  }}
gc_cor_df %>% group_by(V1) %>% summarise(n=n())

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  arrange(n) %>% 
  print(n=55) #number of trees with significant correlations between growth and each climate var

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  pull(V2) %>% 
  unique() %>% 
  length() #number of trees with at least one significant growth-climate correlation
length(unique(gc_cor_df$V2))

gc_cor_df %>% 
  group_by(V2) %>% 
  summarise(maxcor = max(rw_spline, na.rm=T)) %>% 
  left_join(gc_cor_df, by=c("maxcor"="rw_spline", "V2")) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>%
  arrange(n) %>%
  print(n=55) #number of trees whose maximum correlation value is with each climate var 

cor_clean <- gc_cor_df %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance, BLK) %>% unique(), by="tree") %>%
  filter(!is.na(cor)) %>% 
  separate(climvar, into=c("time","var","season"), sep="_", remove=FALSE, fill="left") %>% 
  mutate(time_season = paste(time, season, sep=""))

overall_clim_cor_sig<- data.frame()
for(i in 1:length(unique(cor_clean$climvar))){
  data= cor_clean %>% filter(climvar==unique(cor_clean$climvar)[i]) %>% dplyr::select(cor)
  mod = t.test(data, y=NULL, alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)
  pvalue=mod$p.value
  lwr=mod$conf.int[1]
  upr=mod$conf.int[2]
  estimate=mod$estimate[1]
  
  overall_clim_cor_sig = bind_rows(overall_clim_cor_sig, data.frame(climvar=unique(cor_clean$climvar)[i], pvalue=pvalue, lwr=lwr, upr=upr, estimate=estimate))
}

overall_clim_cor_sig %>% filter(pvalue<0.05)

cor_means <- cor_clean %>% 
  group_by(climvar, time, var, season) %>% 
  summarise(mean.cor=mean(cor), sd.cor = sd(cor), se.cor=mean(cor)/sqrt(sd(cor))) %>% 
  mutate(time_season = paste(time, season, sep="")) %>% 
  left_join(overall_clim_cor_sig %>% 
                separate(climvar, into=c("time","var","season"), sep="_", remove=FALSE, fill="left") %>% mutate(time_season = paste(time, season, sep=""))
) %>% 
  mutate(sig=ifelse(pvalue<0.05, "*", ""))

ggplot(cor_means, aes(x=factor(time_season, levels=c("priorsp","priorsm","priorfa","priorwt","NAsp","NAsm"), labels= c("priorsp","priorsm","priorfa","priorwt","sp","sm")), y=estimate,col=mean.cor>0))+
  geom_point(position=position_dodge(1), size=3)+
  geom_errorbar(aes(ymin=lwr, ymax=upr),width=0.5)+
  geom_text(aes(y=0.25, label=sig), size=5)+
  scale_color_manual(values=c("red","black"))+
  scale_shape_manual(values=c(1,13))+
  geom_hline(yintercept=0)+
  facet_wrap(~factor(var, levels=c("aet","cwd","vpdmax","ppt","dolsf","dofff","tmin","tmean","tmax")), nrow=3)+
  theme_bw()+
  ylim(c(-0.15, 0.3))+
  xlab("")+ylab("Mean Pearson's r")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

sig_trees_per_clim <- cor_clean %>% 
  filter(p.value<0.05) %>% 
  group_by(climvar, time, var, season, time_season) %>% 
  summarise(n_sig_trees=n())
  
ggplot(cor_clean, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_grid(var~factor(time_season, levels=c("priorsp","priorsm","priorfa","priorwt","NAsp","NAsm"), labels=c("prior sp","prior sm","prior fa","prior wt","sp","sm")))+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))

allanovas<- data.frame()
for(i in 1:length(unique(cor_clean$climvar))){
mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == unique(cor_clean$climvar)[i]))
modanova <- as.data.frame(Anova(mod, type="2"))
pvalue<- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Pr(>F)`)
provSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Sum Sq`)
provdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Df`)
residSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Sum Sq`)
residdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Df`)
allanovas <- bind_rows(allanovas, data.frame(climvar=unique(cor_clean$climvar)[i],pvalue=pvalue, provMS = provSS/provdf, residMS = residSS/residdf, provdf=provdf, residdf = residdf))
}

allanovas %>% mutate(diff_prov = residMS - provMS) ##when residMS is greater than provMS (diff > 0)--> variation within provenances is greater than variation between them 
allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov>0) %>% nrow()#within greater than between
allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov<0) %>% nrow()#between greater than within

more_intrapop_diff<- allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov>0)
more_interpop_diff<- allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov<0) 
anova_table<- allanovas %>% mutate(diff = residMS - provMS) %>% 
  separate(climvar, into=c("time","var","season"), sep="_", fill="left")

write.csv(anova_table, "growth_climate_MS.csv")

anova_table %>% 
  mutate(neg=ifelse(diff<0, TRUE, FALSE)) %>% 
  group_by(var, neg) %>% 
  summarise(n=n()) %>% 
  filter(neg==TRUE)
anova_table %>% 
  mutate(neg=ifelse(diff<0, TRUE, FALSE), time_season=paste(time, season, sep=" ")) %>% 
  group_by(time_season, neg) %>% 
  summarise(n=n()) %>% 
  filter(neg==TRUE)

allanovas %>% filter(pvalue<0.05) #prior_ppt_wt, cwd_sp have significant differences between provenances

#prior_ppt_wt
prior_ppt_wt_RWI_mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == "prior_ppt_wt"))
Anova(prior_ppt_wt_RWI_mod, type="2")
lsmeans_prior_ppt_wt_RWI_mod <- lsmeans(prior_ppt_wt_RWI_mod, ~Provenance)
cld(lsmeans_prior_ppt_wt_RWI_mod)

#cwd_sp
cwd_sp_RWI_mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == "cwd_sp"))
Anova(cwd_sp_RWI_mod, type="2")
lsmeans_cwd_sp_RWI_mod <- lsmeans(cwd_sp_RWI_mod, ~Provenance)
cld(lsmeans_cwd_sp_RWI_mod)

min(allanovas$pvalue)
max(allanovas$pvalue)

##T-TESTS
provs <- unique(cor_clean$Provenance)
ttestdata<- data.frame()

for(i in 1:length(unique(cor_clean$climvar))){
  for(j in 1:length(provs)){
data <- cor_clean %>% 
  filter(climvar==unique(cor_clean$climvar)[i]) %>% 
  filter(Provenance == provs[j])

test<- t.test(data$cor, y = NULL,
       alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

row <- data.frame(climvar = unique(cor_clean$climvar)[i], Provenance = provs[j], lwr = test$conf.int[1], upr = test$conf.int[2], estimate = test$estimate, pvalue = test$p.value)

ttestdata <- bind_rows(ttestdata, row)}}

ttestdata %>% filter(pvalue < 0.05) %>% 
  group_by(climvar) %>% 
  summarise(n=n()) %>% 
arrange(n) %>% 
  print(n=56)  ##number of provenances with significant values


sig.cors.byprov <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  left_join(prov_names) %>% 
  filter(!time_season=="priorsp") %>% 
  filter(!var=="spei")#getting rid of prior spring and SPEI just to simplify

ggplot(data=sig.cors.byprov, aes(x=factor(code, levels=provs_bylat$code), y=estimate))+
    geom_jitter(data= cor_clean  %>% left_join(prov_names), aes(x=factor(code, levels=provs_bylat$code), y=cor, color=p.value<0.05),size=2, height=0, width=0.1, alpha=0.2)+
    geom_text(data=cor_means , aes(x="RoNF", y=0.95,label=paste0("mean r = ",round(mean.cor,2)," \u00B1 ",round(sd.cor,2)), col=mean.cor<0))+
    geom_text(data=sig_trees_per_clim , aes(x="RoNF", y=0.7,label=paste0("N[p<0.05] = ",n_sig_trees)))+
  scale_color_manual(values=c("gray20","red"))+
  ggnewscale::new_scale_color()+
  geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_grid(var~factor(time_season, levels=c("priorsm","priorfa","priorwt","NAsp","NAsm"), labels=c("prior sm","prior fa","prior wt","sp","sm")))+
  xlab("")+
  ylim(c(-.6,1))+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=12, color="black"),
        axis.text.y = element_text(size=12, color="black"),
        axis.title = element_text(size=12, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=12),
        panel.grid = element_blank())
```

```{r}
climate_growth_table<- ttestdata %>% 
  left_join(prov_names) %>% 
  dplyr::select(climvar, code, estimate, pvalue) %>% 
  mutate(pvalue=ifelse(pvalue<0.05, "X", ""), estimate=ifelse(estimate > 0 , "+", "-")) %>% 
  mutate(estimate=ifelse(pvalue=="X", estimate, "")) %>% 
  dplyr::select(-pvalue) %>% 
  pivot_wider(names_from=code, values_from=estimate) %>% 
  dplyr::select(c("climvar", provs_bylat$code[-9]))

write.csv(climate_growth_table, "climate_growth_table.csv")

```

####temporal trends

```{r}
growth_climate_df
min(growth_climate_df$year)
max(growth_climate_df$year)

gc_cor_df_1994<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df%>% filter(year<1995) %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i]) 
  tree <- growth_climate_df%>% filter(year<1995) %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline) 
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df_1994 <- bind_rows(gc_cor_df_1994, row)
  }}
gc_cor_df_1994 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="1994")

gc_cor_df_2004<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df%>% filter(year<2005 & year > 1994) %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i]) 
  tree <- growth_climate_df%>% filter(year<2005 & year > 1994) %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline) 
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df_2004 <- bind_rows(gc_cor_df_2004, row)
  }}
gc_cor_df_2004 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2004")

gc_cor_df_2014<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df%>% filter(year<2015 & year > 2004) %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i]) 
  tree <- growth_climate_df%>% filter(year<2015 & year > 2004) %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline) 
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df_2014 <- bind_rows(gc_cor_df_2014, row)
  }}
gc_cor_df_2014 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2014")


gc_cor_periods<- bind_rows(gc_cor_df_1994 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="1994"),
          gc_cor_df_2004 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2004"),
          gc_cor_df_2014 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2014"))

ggplot(gc_cor_periods, aes(x=period, y=mean.rwi, col=mean.rwi>0))+
  geom_point()+
  facet_wrap(~V1)+
  geom_hline(yintercept=0, color="black")

```

###provenance climate affect on Gx C correlation 
```{r}

##############################################

cor_provclim<- cor_clean %>%
  left_join(prov_names) %>% 
  left_join(
prov_pcapts_big %>% 
  dplyr::select(c(Provenance,PC1:PC2,all_of(colnames(big_pca_data)))), by="Provenance")

cor_provclim_long <- pivot_longer(cor_provclim, PC1:monsoonality)

# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
climvar_list <- unique(cor_provclim_long$climvar)

names <- unique(cor_provclim_long$name)
lmerdata <- data.frame()
for(i in 1:length(climvar_list)){
  for(j in 1:length(names)){
    data <- cor_provclim_long %>% filter(climvar==climvar_list[i] & name==names[j]) 
    mod <- lmer(cor ~ value + (1|Provenance) + (1|BLK), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    mod_nog <- lmer(cor ~ value + (1|Provenance) + (1|BLK), data=data %>% filter(!Provenance=="Gila NF"))
    pvalue.lmer_nog <- as.data.frame(summary(mod_nog)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    # Cr2.lmer <- performance::r2(mod)$R2_conditional
    # Mr2.lmer <- performance::r2(mod)$R2_marginal
   
    lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvar_list[i], name=names[j], pvalue.lmer = pvalue.lmer, pvalue.lmer_nog = pvalue.lmer_nog))  

#     if(!is.na(Cr2.lmer)) (
# lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvar_list[i], name=names[j], pvalue.lmer = pvalue.lmer, r2.lmer=Cr2.lmer, r2type="C")) ) 

#     if(is.na(Cr2.lmer)) (
# lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvar_list[i], name=names[j], pvalue.lmer = pvalue.lmer, r2.lmer=Mr2.lmer, r2type="M"))
#  ) 
  }}

lmerdata %>% filter(pvalue.lmer_nog < 0.05)

currentyr_plot<- ggplot(data=left_join(lmerdata %>% filter(pvalue.lmer < 0.05 & pvalue.lmer_nog<0.05), cor_provclim_long)  %>% filter(!str_detect(climvar, "prior")), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  theme(strip.text=element_text(size=8), axis.text.x=element_text(size=5), axis.text.y=element_text(size=5), axis.title=element_text(size=5))

currentyr_plot
clim_pien_cor

prioryr_plot <- ggplot(data=left_join(lmerdata %>% filter(pvalue.lmer < 0.05 & pvalue.lmer_nog<0.05), cor_provclim_long) %>% filter(str_detect(climvar, "prior")), aes(x=value, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  theme(strip.text=element_text(size=8), axis.text.x=element_text(size=5), axis.text.y=element_text(size=5), axis.title=element_text(size=5))

prioryr_plot


##########final plot

lmerdata %>% filter(climvar %in% c("prior_ppt_wt", "cwd_sp")) %>% filter(pvalue.lmer_nog < 0.05) ##just look at trends if provenances significantly differed from each other in the ANOVA

##cwd_sp & CMD

cwd_sp_CMD_mod <- lmer(cor ~ value + (1|Provenance) + (1|BLK), data=cor_provclim_long %>% filter(climvar=="cwd_sp" & name=="CMD" ))
plot(cwd_sp_CMD_mod)
qqmath(cwd_sp_CMD_mod)
summary(cwd_sp_CMD_mod)
cwd_sp_CMD_mod_nog <- lmer(cor ~ value + (1|Provenance) + (1|BLK), data=cor_provclim_long %>% filter(!Provenance=="Gila NF") %>%  filter(climvar=="cwd_sp" & name=="CMD" ))


##predictions
cwd_sp_CMD_data <- cor_provclim_long %>% filter(climvar=="cwd_sp" & name=="CMD" )
cwd_sp_CMD_mod_lm <- lm(cor ~ value, data=cwd_sp_CMD_data)
cwd_sp_CMD_mod_lm_nog <- lm(cor ~ value, data=cwd_sp_CMD_data %>% filter(!Provenance=="Gila NF"))

## with Gila
newdata_cwd_sp_CMD <- data.frame(value= seq(min(cwd_sp_CMD_data$value),max(cwd_sp_CMD_data$value), length.out=50))

predict_cwd_sp_CMD <- predict(cwd_sp_CMD_mod_lm, newdata_cwd_sp_CMD, interval="confidence")

predict_data_cwd_sp_CMD <- as.data.frame(bind_cols(newdata_cwd_sp_CMD,predict_cwd_sp_CMD))

##predictions - without Gila
newdata_cwd_sp_CMD_nog <- data.frame(value= seq(min(cwd_sp_CMD_data %>% filter(!Provenance=="Gila NF") %>% pull(value)),max(cwd_sp_CMD_data %>% filter(!Provenance=="Gila NF") %>% pull(value)), length.out=50))

predict_cwd_sp_CMD_nog <- predict(cwd_sp_CMD_mod_lm_nog, newdata_cwd_sp_CMD_nog, interval="confidence")

predict_data_cwd_sp_CMD_nog <- as.data.frame(bind_cols(newdata_cwd_sp_CMD_nog,predict_cwd_sp_CMD_nog))

predict_data_cwd_sp_CMD_all <- bind_rows(predict_data_cwd_sp_CMD_nog %>% mutate(model="without Gila NF"), predict_data_cwd_sp_CMD %>% mutate(model="with Gila NF"))

pvalues_cwd_sp_CMD <- data.frame(pvalue= c(summary(cwd_sp_CMD_mod)$coefficients[2,5], summary(cwd_sp_CMD_mod_nog)$coefficients[2,5]), model=c("with Gila NF", "without Gila NF"), x=c(500), y=c(-.28,-.35))   

cwd_sp_CMD_plot <- ggplot()+
  geom_point(data=cwd_sp_CMD_data, aes(x=value, y=cor), color="black")+
  geom_line(data=predict_data_cwd_sp_CMD_all, aes(x=value, y=fit, col=model))+
  geom_ribbon(data=predict_data_cwd_sp_CMD_all, aes(x=value, y=fit, ymin=lwr, ymax=upr, fill=model), alpha=0.3)+
  scale_color_manual(values=c("gray35","black"))+
  scale_fill_manual(values=c("gray35","black"))+
  geom_text(data=pvalues_cwd_sp_CMD, aes(x=x, y=y, label=paste0("p = ",round(pvalue,4)), col=model), hjust=0)+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=plantation_only$CMD, color="darkorange2", linewidth=1)+
  xlab("Provenance CMD")+
  ylab("Pearson's r")+
  theme_bw()+
  theme(legend.position="top")+
  ggtitle("")


##cwd_sp & MCMT

cwd_sp_MCMT_mod <- lmer(cor ~ value + (1|Provenance) + (1|BLK), data=cor_provclim_long %>% filter(climvar=="cwd_sp" & name=="MCMT" ))
plot(cwd_sp_MCMT_mod)
qqmath(cwd_sp_MCMT_mod)
summary(cwd_sp_MCMT_mod)
cwd_sp_MCMT_mod_nog <- lmer(cor ~ value + (1|Provenance) + (1|BLK), data=cor_provclim_long %>% filter(!Provenance=="Gila NF") %>% filter(climvar=="cwd_sp" & name=="MCMT" ))


##predictions
cwd_sp_MCMT_data <- cor_provclim_long %>% filter(climvar=="cwd_sp" & name=="MCMT" )
cwd_sp_MCMT_mod_lm <- lm(cor ~ value, data=cwd_sp_MCMT_data)
cwd_sp_MCMT_mod_lm_nog <- lm(cor ~ value, data=cwd_sp_MCMT_data %>% filter(!Provenance=="Gila NF"))

## with Gila
newdata_cwd_sp_MCMT <- data.frame(value= seq(min(cwd_sp_MCMT_data$value),max(cwd_sp_MCMT_data$value), length.out=50))

predict_cwd_sp_MCMT <- predict(cwd_sp_MCMT_mod_lm, newdata_cwd_sp_MCMT, interval="confidence")

predict_data_cwd_sp_MCMT <- as.data.frame(bind_cols(newdata_cwd_sp_MCMT,predict_cwd_sp_MCMT))

##predictions - without Gila
newdata_cwd_sp_MCMT_nog <- data.frame(value= seq(min(cwd_sp_MCMT_data %>% filter(!Provenance=="Gila NF") %>% pull(value)),max(cwd_sp_MCMT_data %>% filter(!Provenance=="Gila NF") %>% pull(value)), length.out=50))

predict_cwd_sp_MCMT_nog <- predict(cwd_sp_MCMT_mod_lm_nog, newdata_cwd_sp_MCMT_nog, interval="confidence")

predict_data_cwd_sp_MCMT_nog <- as.data.frame(bind_cols(newdata_cwd_sp_MCMT_nog,predict_cwd_sp_MCMT_nog))

predict_data_cwd_sp_MCMT_all <- bind_rows(predict_data_cwd_sp_MCMT_nog %>% mutate(model="without Gila NF"), predict_data_cwd_sp_MCMT %>% mutate(model="with Gila NF")) 

pvalues_cwd_sp_MCMT <- data.frame(pvalue= c(summary(cwd_sp_MCMT_mod)$coefficients[2,5], summary(cwd_sp_MCMT_mod_nog)$coefficients[2,5]), model=c("with Gila NF", "without Gila NF"), x=c(-2,-2), y=c(-.28,-.35))   

cwd_sp_MCMT_plot <- ggplot()+
  geom_point(data=cwd_sp_MCMT_data, aes(x=value, y=cor), color="black")+
  geom_line(data=predict_data_cwd_sp_MCMT_all, aes(x=value, y=fit, col=model))+
  geom_ribbon(data=predict_data_cwd_sp_MCMT_all, aes(x=value, y=fit, ymin=lwr, ymax=upr, fill=model), alpha=0.3)+
  scale_color_manual(values=c("gray35","black"))+
  scale_fill_manual(values=c("gray35","black"))+
  geom_text(data=pvalues_cwd_sp_MCMT, aes(x=x, y=y, label=paste0("p = ",round(pvalue,4)), col=model), hjust=0)+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=plantation_only$MCMT, color="darkorange2", linewidth=1)+
  xlab("Provenance MCMT")+
  ylab("Pearson's r")+
  theme_bw()+
  theme(legend.position="top")+
  ggtitle("Spring CWD")

ggarrange(cwd_sp_MCMT_plot, cwd_sp_CMD_plot, nrow=1, common.legend = TRUE)
```
