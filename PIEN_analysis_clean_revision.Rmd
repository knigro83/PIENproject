---
title: "Engelmann Spruce Provenance Study"
author: "Katie Nigro"
date: "2025-04-07"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Set up 

##Packages

```{r}
#load required packages
library(terra)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(dplyr)
library(stringr)
# library(ClimateNAr)
library(ggfortify)
library(RColorBrewer)
library(tidyr)
library(lme4)
library(lmerTest)
library(car)
library(viridis)
library(dplR)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(MuMIn)
library(vegan)
library(cluster)
library(MASS)
library(indicspecies)
library(SPEI)
library(lattice)
library(tibble)
library(pals)
library(aod)
library(interactions)
library(gridExtra)
library(climwin)
library(lubridate)
library(dichromat)
library(prism)
library(multcomp)
library(multcompView)
library(lsmeans)
library(cowplot)
library(glmm)
library(glmmTMB)
library(colorspace)
library(performance)
library("factoextra")
library("corrplot")
library(DescTools)
library(DHARMa)
library(ggeffects)
```

##Plot locations

```{r}
#read in site and provenance locations
us <- geodata::gadm(country = "USA",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")
west_states<- c("Arizona","Colorado","Idaho","Montana","Nevada","New Mexico","South Dakota","North Dakota","Nebraska","Utah","Wyoming","California","Oregon","Washington","Kansas","Oklahoma","Texas")
westernus <- us[match(toupper(west_states),toupper(us$NAME_1)),]

canada <- geodata::gadm(country = "Canada",  level = 1, resolution = 2,
             path = "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject")

##use coordinates adjusted based on elevation and google maps
adjusted_coords<- read.csv("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/PIEN_corrected_coords.csv")

adjusted_provs<- vect(adjusted_coords, geom=c("long_corrected","lat_corrected"), crs=crs(us))

geo.dist.df<- data.frame(Provenance = adjusted_provs$Provenance, geo.dist.to.plant.km = as.matrix(terra::distance(adjusted_provs))[,21]/1000)

ggplot()+
  geom_spatvector(data=westernus)+
  geom_spatvector(data=canada)+
  geom_spatvector(data=adjusted_provs, color="maroon")

#make key for provenance names
prov_names<-adjusted_coords %>% dplyr::select(Provenance, no) %>% 
 separate_wider_delim(Provenance, delim=" ", names=c("first","second","third"), too_few = "align_start", cols_remove=FALSE) %>% 
  separate_wider_delim(first, delim= "-", names=c("first","2"), too_few="align_start") %>% 
    separate_wider_delim(second, delim= "-", names=c("second","3"), too_few="align_start") %>% 
  mutate(across(everything(), ~ replace(.x, is.na(.x), ""))) %>%
  mutate(`3` = ifelse(second=="NF","F",`3`)) %>% 
  mutate(code=paste(substr(first,0,1),substr(`2`,0,1),substr(second,0,1),substr(`3`,0,1),third, sep="")) %>% 
  dplyr::select(c(Provenance,no,code)) %>% 
  mutate(no=as.integer(no)) %>% 
  mutate(code=case_when(Provenance == "Roosevelt NF" ~ "RoNF",
                        Provenance == "Pike NF" ~ "PiNF",
                        Provenance == "Gunnison NF" ~ "GuNF",
                        Provenance == "Coconino NF" ~ "CoNF",
                        Provenance == "Payette NF" ~ "PaNF",
                        Provenance == "Cache NF" ~ "CaNF",
                        Provenance == "Gila NF" ~ "GiNF",
                        TRUE ~ code))

provs_bylat <- as.data.frame(adjusted_provs) %>% 
  bind_cols(crds(adjusted_provs)) %>% 
  left_join(prov_names) %>% 
  arrange(y)
```

#Climate

##ClimateNA

```{r}
#read in climate from climateNA

filenames <- c("AHM","bFFP","CMD","DD_18","DD_0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPT_sm","PPT_sp","PPT_at","PPT_wt","RH","Tave_sm","Tave_wt","TD","SHM")

filenames_edited <- c("AHM","bFFP","CMD","DD18","DD0","DD5","eFFP","EMT","Eref","EXT","FFP","MAP","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","Tavesm","Tavewt","TD","SHM")

clim_raster_stack <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1961_1990_bioclim/Normal_1961_1990/Normal_1961_1990_bioclim/Normal_1961_1990_",filenames,".tif",sep=""))

names(clim_raster_stack)<- filenames_edited

prov_clim_adjusted_bi <- terra::extract(clim_raster_stack, adjusted_provs, method='bilinear') %>% cbind(as.data.frame(adjusted_provs)) %>% cbind(crds(adjusted_provs)) %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP)

prov_clim_adjusted_bi_long<- prov_clim_adjusted_bi %>% 
  mutate(no=ifelse(is.na(no),"Plan",no)) %>% 
  dplyr::select(c(Provenance,AHM:SHM, smrpb, monsoonality)) %>% 
  pivot_longer(AHM:monsoonality) %>% 
  mutate(type="adj bilinear") 

##making provenance climate table for paper
prov_clim_table<- prov_clim_adjusted_bi %>% 
  left_join(prov_names %>% dplyr::select(Provenance, code)) %>% 
  dplyr::select(Provenance, y, x, elev, MAT, MAP, NFFD,PAS) %>% 
  arrange(desc(y))

#write.csv(prov_clim_table,"prov_clim_table.csv")  
```

###Rehfeldt comparison

```{r}
##compare White River to Rehfeldt 2004 planting sites
idacreek<- c(48.364002, -116.822747)
canyoncreek<- c(48.370716, -116.799922)
high <- c(48.353759, -116.760290)
highest <- c(48.344491, -116.714165)
preistriver<- data.frame(rbind(idacreek, canyoncreek, high,highest))
colnames(preistriver)<- c("y","x")

preistriver_vect <- vect(preistriver, geom=c("x","y"), crs=crs(us))

preistriver_clim <- terra::extract(clim_raster_stack, preistriver_vect, method="simple", df=TRUE)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MAT, y=MAP), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MAT, y=MAP), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=NFFD, y=SHM), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=NFFD, y=SHM), col="black", size=3)

ggplot()+
  geom_point(data=preistriver_clim, aes(x=MCMT, y=RH), col="red", size=3)+
  geom_point(data=prov_clim_adjusted_bi %>% filter(Provenance=="Plantation"), aes(x=MCMT, y=RH), col="black", size=3)
```

```{r}
#monthly normals

months = c("01","02","03","04","05","06","07","08","09","10","11","12")

monthly_ppt<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/ppt/PPT",months[i],".tif",sep=""))
ppt <- terra::extract(raster, adjusted_provs)
monthly_ppt <- left_join(monthly_ppt, ppt)}


monthly_tave<- data.frame(ID=seq(1,21,1))
for(i in 1:length(months)){
raster <- rast(paste("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/climateNA/monthly/tave/Tave",months[i],".tif",sep=""))
tave <- terra::extract(raster, adjusted_provs)
monthly_tave <- left_join(monthly_tave, tave)}

monthly_clim <- monthly_ppt %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(PPT01:PPT12) %>% 
  bind_rows(monthly_tave %>%
  bind_cols(as.data.frame(adjusted_provs)) %>% 
  pivot_longer(Tave01:Tave12)) %>% 
  mutate(month=substr(name,nchar(name)-1,nchar(name)),
         var = substr(name,0,nchar(name)-2))

monthly_clim_wide <- monthly_clim %>% 
  dplyr::select(c(Provenance, no, elev, value, month, var)) %>% 
  pivot_wider(values_from=value, names_from=var)

#png("figures/prov_temp_precip.png", width=8,height=8, res=300, units="in")
ggplot()+
  geom_bar(data=monthly_clim_wide, aes(x=as.numeric(month), y=PPT), stat="identity", fill="grey")+
  geom_line(data=monthly_clim_wide, aes(x=as.numeric(month), y=Tave*10), col="black", lwd=1)+
  scale_y_continuous(
    "PPT (mm)", 
    sec.axis = sec_axis(~ . / 10, name = "Temp (C)"), limits=c(-150,350))+
  scale_x_continuous(breaks=seq(1,12,1), labels=seq(1,12,1), name="Month")+
  facet_wrap(~factor(Provenance))+
  theme_bw()+
  theme(panel.grid.minor=element_blank())
#dev.off()

ggplot(monthly_clim %>% filter(var=="Tave") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="Tave") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="red",size=2)+
    facet_wrap(~factor(Provenance))

ggplot(monthly_clim %>% filter(var=="PPT") %>% filter(!Provenance=="Plantation"), aes(x=month, y=value))+
  geom_point(size=2)+
  geom_point(data=monthly_clim %>% filter(var=="PPT") %>% filter(Provenance=="Plantation") %>% rename(test=Provenance), aes(x=month, y=value), col="green",size=3)+
    facet_wrap(~factor(Provenance))
```


```{r}
#compare climates of provenances
prov_vars<- prov_clim_adjusted_bi %>% 
  dplyr::select(c(Provenance,AHM:SHM,x:monsoonality)) %>% 
  left_join(prov_names) %>% 
  pivot_longer(AHM:monsoonality, names_to = "var", values_to = "value")

order<- prov_clim_adjusted_bi %>% 
  arrange(y) %>% 
  pull(Provenance)

# png("figures/prov_clim_plot.png", width=12, height=8, units="in", res=500)
ggplot(prov_vars, aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())
# dev.off()

ggplot(prov_vars %>% filter(!Provenance=="Gila NF") %>% filter(var=="smrpb"), aes(x=factor(Provenance, levels=order), y=value, col=factor(Provenance, levels=order)))+
  geom_point(size=4)+
  geom_hline(data=prov_vars %>% filter(Provenance=="Plantation")%>% filter(var=="smrpb"),aes(yintercept = value, group=var), col=unname(stepped())[9])+
  facet_wrap(~var, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  theme(axis.text.x = element_text(angle=45,hjust=1, size=10), legend.position = 'none', strip.text=element_text(size=12), axis.title.x = element_blank())+
  theme_bw()+
  theme(legend.position="none", axis.text.x = element_text(angle=45, hjust=1, color="black", size=12))+
  xlab("Provenance")+
  ylab("Summer to Spring Precip Ratio")
```


###future climate

```{r}
##get future projections from ClimateNA

#2000's normal
clim2000s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/Normal_1991_2020_bioclim/Normal_1991_2020_bioclim/Normal_1991_2020_",filenames,".tif",sep=""))

names(clim2000s) <- paste(filenames_edited,"_ssp585_2000s", sep="") 

##2020's projections
clim2020s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040/ensemble_8GCMs_ssp585_2011_2040_bioclim/ensemble_8GCMs_ssp585_2011_2040_",filenames,".tif",sep=""))

names(clim2020s) <- paste(filenames_edited,"_ssp585_2020s", sep="")  

##2050's projections
clim2050s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070/ensemble_8GCMs_ssp585_2041_2070_bioclim/ensemble_8GCMs_ssp585_2041_2070_",filenames,".tif",sep=""))

names(clim2050s) <- paste(filenames_edited,"_ssp585_2050s", sep="") 

##2080's projections
clim2080s <- rast(paste0("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100/ensemble_8GCMs_ssp585_2071_2100_bioclim/ensemble_8GCMs_ssp585_2071_2100_",filenames,".tif",sep=""))

names(clim2080s) <- paste(filenames_edited,"_ssp585_2080s", sep="")  

future_clim_raster_stack <- c(clim2020s,clim2050s,clim2080s)

prov_futures<- terra::extract(future_clim_raster_stack, adjusted_provs, weights=T)

prov_futures_long<- prov_futures %>%
  left_join(data.frame(ID=seq(1,21,1), Provenance =adjusted_provs$Provenance)) %>% 
  mutate(smrpb_ssp585_2020s = PPTsm_ssp585_2020s/PPTsp_ssp585_2020s, monsoonality_ssp585_2020s = MSP_ssp585_2020s/MAP_ssp585_2020s, smrpb_ssp585_2050s = PPTsm_ssp585_2050s/PPTsp_ssp585_2050s, monsoonality_ssp585_2050s = MSP_ssp585_2050s/MAP_ssp585_2050s, smrpb_ssp585_2080s = PPTsm_ssp585_2080s/PPTsp_ssp585_2080s, monsoonality_ssp585_2080s = MSP_ssp585_2080s/MAP_ssp585_2080s) %>% 
  dplyr::select(ID,Provenance,everything()) %>% 
  pivot_longer(cols=AHM_ssp585_2020s:monsoonality_ssp585_2080s) %>% 
  separate(name, into=c("climvar","carbon","period"), remove=TRUE) 
```

##PRISM

```{r}
#read in files
ppt_comb_plantation<- read.csv("ppt_comb_plantation.csv") 
tmax_comb_plantation<- read.csv("tmax_comb_plantation.csv")
tmin_comb_plantation<- read.csv("tmin_comb_plantation.csv")
tmean_comb_plantation<- read.csv("tmean_comb_plantation.csv")
vpdmax_comb_plantation<- read.csv("vpdmax_comb_plantation.csv")
vpdmin_comb_plantation<- read.csv("vpdmin_comb_plantation.csv")

ppt_comb_all<- read.csv("ppt_comb_all.csv")
tmax_comb_all<- read.csv("tmax_comb_all.csv")
tmin_comb_all<- read.csv("tmin_comb_all.csv")
tmean_comb_all<- read.csv("tmean_comb_all.csv")
vpdmax_comb_all<- read.csv("vpdmax_comb_all.csv")
vpdmin_comb_all<- read.csv("vpdmin_comb_all.csv")

##add in 1969 to plantation data
 months<- c("01","02","03","04","05","06","07","08","09","10","11","12")
# 
# # set location of climate data
climdir <- "C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/PRISM"
# 
ppt_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_ppt_stable_4kmM3_198101_202305_bil/PRISM_ppt_stable_4kmM2_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  ppt<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  ppt_CN<-cbind(CN,ppt,year,month)
  ppt_data_1969<-rbind(ppt_data_1969,ppt_CN)}

tmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmin_stable_4kmM3_198101_202305_bil/PRISM_tmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmin_CN<-cbind(CN,tmin,year,month)
  tmin_data_1969<-rbind(tmin_data_1969,tmin_CN)}

tmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmax_stable_4kmM3_198101_202305_bil/PRISM_tmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmax_CN<-cbind(CN,tmax,year,month)
  tmax_data_1969<-rbind(tmax_data_1969,tmax_CN)}

tmean_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_tmean_stable_4kmM3_198101_202305_bil/PRISM_tmean_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  tmean<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  tmean_CN<-cbind(CN,tmean,year,month)
  tmean_data_1969<-rbind(tmean_data_1969,tmean_CN)}

vpdmax_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmax_stable_4kmM3_198101_202305_bil/PRISM_vpdmax_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmax<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmax_CN<-cbind(CN,vpdmax,year,month)
  vpdmax_data_1969<-rbind(vpdmax_data_1969,vpdmax_CN)}

vpdmin_data_1969<-vector()
for(j in 1:length(months)){
  raster<-paste(climdir,'/annual/PRISM_vpdmin_stable_4kmM3_198101_202305_bil/PRISM_vpdmin_stable_4kmM3_',"1969",months[j],'_bil.bil',sep="")
  rast <- rast(raster)
  ext.poly <- terra::extract(rast, adjusted_provs, fun = mean, na.rm=TRUE, df=TRUE)
  vpdmin<-ext.poly[,2]
  CN<-adjusted_provs$Provenance
  year <- rep("1969",length(ext.poly[,2]))
  month <- rep(months[j],length(ext.poly[,2]))
  vpdmin_CN<-cbind(CN,vpdmin,year,month)
  vpdmin_data_1969<-rbind(vpdmin_data_1969,vpdmin_CN)}

##append 1969
ppt_comb_plantation <- bind_rows(as.data.frame(ppt_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), ppt=as.numeric(ppt), year=as.integer(year), month=as.integer(month)), ppt_comb_plantation %>% dplyr::select(-c(X.1, X))) 

tmax_comb_plantation <- bind_rows(as.data.frame(tmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmax=as.numeric(tmax), year=as.integer(year), month=as.integer(month)), tmax_comb_plantation %>% dplyr::select(-X))

tmean_comb_plantation <- bind_rows(as.data.frame(tmean_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmean=as.numeric(tmean), year=as.integer(year), month=as.integer(month)), tmean_comb_plantation %>% dplyr::select(-X)) 

tmin_comb_plantation <- bind_rows(as.data.frame(tmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), tmin=as.numeric(tmin), year=as.integer(year), month=as.integer(month)), tmin_comb_plantation%>% dplyr::select(-X)) 

vpdmax_comb_plantation <- bind_rows(as.data.frame(vpdmax_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmax=as.numeric(vpdmax), year=as.integer(year), month=as.integer(month)), vpdmax_comb_plantation%>% dplyr::select(-X)) 

vpdmin_comb_plantation <- bind_rows(as.data.frame(vpdmin_data_1969) %>% filter(CN == "Plantation") %>%
  mutate(date=as.character(as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")), vpdmin=as.numeric(vpdmin), year=as.integer(year), month=as.integer(month)), vpdmin_comb_plantation%>% dplyr::select(-X))

```

###Plantation summary

```{r}
###site climate summary
ppt_plantation_yearly <- ppt_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(ppt_sum = sum(ppt))

mean(ppt_plantation_yearly$ppt_sum)
sd(ppt_plantation_yearly$ppt_sum)

tmin_plantation_dailyave <- tmin_comb_plantation %>% 
  filter(year >1969 & year < 2016) %>% 
  group_by(year) %>% 
  summarise(tmin_ave=mean(tmin))
mean(tmin_plantation_dailyave$tmin_ave)

##plotting site climate over time
tmean_sum<- tmean_comb_plantation %>% 
  filter(year>1969) %>% 
  mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(decade) %>% 
  summarise(MAT = mean(tmean), se_MAT=sd(tmean)/sqrt(n()))

ppt_sum <- ppt_comb_plantation %>% 
  filter(year > 1969) %>% 
    mutate(decade = case_when(year < 1980 ~ "70s",
                            year > 1979 & year < 1990 ~ "80s",
                            year > 1989 & year < 2000 ~ "90s",
                            year > 1999 & year < 2010 ~ "00s",
                            year > 2009 & year < 2020 ~ "10s",
                            year > 2019 ~ "20s"
                            )) %>% 
  group_by(year,decade) %>% 
  summarise(MAP=sum(ppt)) %>% 
  group_by(decade) %>% 
  summarise(MAP_ave = mean(MAP), se_MAP=sd(MAP)/sqrt(n()))

plantation_2dclim <- left_join(tmean_sum, ppt_sum)

ggplot(plantation_2dclim, aes(x=MAT, y=MAP_ave, col=decade))+
         geom_point()

tmean_mod <- lm(tmean ~ year, data=tmean_comb_plantation %>% group_by(year) %>% summarise(tmean=mean(tmean)))
par(mfrow=c(2,2))
plot(tmean_mod)
summary(tmean_mod)

0.015728*45

tmin_mod <- lm(tmin ~ year, data=tmin_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmin=mean(tmin)))
par(mfrow=c(2,2))
plot(tmin_mod)
summary(tmin_mod)

tmax_mod <- lm(tmax ~ year, data=tmax_comb_plantation %>% filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(tmax=mean(tmax)))
par(mfrow=c(2,2))
plot(tmax_mod)
summary(tmax_mod)

ppt_mod <- lm(ppt ~ year, data=ppt_comb_plantation %>%  filter(year >1969 & year < 2016) %>% group_by(year) %>% summarise(ppt=sum(ppt)))
par(mfrow=c(2,2))
plot(ppt_mod)
summary(ppt_mod)

0.021181*46
```

###seasonal

```{r}
##calculate seasonal PRISM values

##ppt
ppt_summed <- as.data.frame(ppt_comb_plantation) %>% 
  mutate(ppt = as.numeric(ppt), year=as.integer(year)) %>%
  filter(!is.na(ppt)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(ppt = sum(ppt)) 

ggplot(ppt_summed %>% filter(CN=="Plantation"), aes(x=year, y=ppt)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(ppt_summed %>% filter(CN=="Plantation") %>% pull(ppt)), col="red")

##seasonal ppt
 
prior_ppt_sm <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_ppt_sm = sum(ppt)) %>% 
  filter(year>1969)
  
prior_ppt_fa <- ppt_comb_plantation %>% 
  filter(month %in% c(9,10,11)) %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_ppt_fa = sum(ppt)) %>% 
  filter(year>1969)
  
prior_ppt_wt <- ppt_comb_plantation %>% 
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month==12, year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_ppt_wt = sum(ppt)) %>% 
  filter(year>1969)

ppt_sp <- ppt_comb_plantation %>% 
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sp = sum(ppt)) %>% 
  filter(year>1969)
  
ppt_sm <- ppt_comb_plantation %>% 
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
  summarise(ppt_sm = sum(ppt)) %>% 
  filter(year>1969)

ppt_seasonal_plantation <- left_join(prior_ppt_sm,prior_ppt_fa) %>% 
  left_join(prior_ppt_wt) %>% 
  left_join(ppt_sp) %>% 
  left_join(ppt_sm)
  
##tmin
tmin_summed <- as.data.frame(tmin_comb_plantation) %>% 
  mutate(tmin = as.numeric(tmin), year=as.integer(year)) %>%
  filter(!is.na(tmin)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmin = mean(tmin)) 

ggplot(tmin_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmin)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmin_summed %>% filter(CN=="Plantation") %>% pull(tmin)), col="red")

##tmax
tmax_summed <- as.data.frame(tmax_comb_plantation) %>% 
  mutate(tmax = as.numeric(tmax), year=as.integer(year)) %>%
  filter(!is.na(tmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmax = mean(tmax))

ggplot(tmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmax_summed %>% filter(CN=="Plantation") %>% pull(tmax)), col="red")

##tmean
tmean_summed <- as.data.frame(tmean_comb_plantation) %>% 
  mutate(tmean = as.numeric(tmean), year=as.integer(year)) %>%
  filter(!is.na(tmean)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(tmean = mean(tmean)) 

ggplot(tmean_summed %>% filter(CN=="Plantation"), aes(x=year, y=tmean)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(tmean_summed %>% filter(CN=="Plantation") %>% pull(tmean)), col="red")

##seasonal temps
all_temps <- bind_rows(tmean_comb_plantation %>% pivot_longer(tmean), tmin_comb_plantation %>% pivot_longer(tmin), tmax_comb_plantation %>% pivot_longer(tmax))

prior_tmean_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmean") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmean_sm = mean(value))
prior_tmin_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmin") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmin_sm = mean(value))
prior_tmax_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmax") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmax_sm = mean(value))

prior_tmean_fa <- all_temps %>% filter(month %in% c(9,10,11) & name=="tmean") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmean_fa = mean(value))
prior_tmin_fa <- all_temps %>% filter(month %in% c(9,10,11) & name=="tmin") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmin_fa = mean(value))
prior_tmax_fa <- all_temps %>% filter(month %in% c(9,10,11) & name=="tmax") %>% 
  mutate(year = year+1) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmax_fa = mean(value))

prior_tmean_wt <- all_temps %>% filter(month %in% c(12,1,2) & name=="tmean") %>% 
  mutate(year = ifelse(year==12,year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmean_wt = mean(value))
prior_tmin_wt <- all_temps %>% filter(month %in% c(12,1,2) & name=="tmin") %>% 
  mutate(year = ifelse(year==12,year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmin_wt = mean(value))
prior_tmax_wt <- all_temps %>% filter(month %in% c(12,1,2) & name=="tmax") %>% 
  mutate(year = ifelse(year==12,year+1, year)) %>% 
  group_by(CN, year) %>% 
  summarise(prior_tmax_wt = mean(value))

tmean_sp <- all_temps %>% filter(month %in% c(3,4,5) & name=="tmean") %>% 
  group_by(CN, year) %>% 
  summarise(tmean_sp = mean(value))
tmin_sp <- all_temps %>% filter(month %in% c(3,4,5) & name=="tmin") %>% 
  group_by(CN, year) %>% 
  summarise(tmin_sp = mean(value))
tmax_sp <- all_temps %>% filter(month %in% c(3,4,5) & name=="tmax") %>% 
  group_by(CN, year) %>% 
  summarise(tmax_sp = mean(value))

tmean_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmean") %>% 
  group_by(CN, year) %>% 
  summarise(tmean_sm = mean(value))
tmin_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmin") %>% 
  group_by(CN, year) %>% 
  summarise(tmin_sm = mean(value))
tmax_sm <- all_temps %>% filter(month %in% c(6,7,8) & name=="tmax") %>% 
  group_by(CN, year) %>% 
  summarise(tmax_sm = mean(value))

plantation_seasonal_temps<- plyr::join_all(list(prior_tmean_sm,prior_tmin_sm,prior_tmax_sm,prior_tmean_fa,prior_tmin_fa,prior_tmax_fa,prior_tmean_wt,prior_tmin_wt,prior_tmax_wt,tmean_sp,tmin_sp,tmax_sp,tmean_sm,tmin_sm,tmax_sm), type="left")

##vpdmax

vpdmax_summed <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(!is.na(vpdmax)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax = mean(vpdmax))

ggplot(vpdmax_summed %>% filter(CN=="Plantation"), aes(x=year, y=vpdmax)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept=mean(vpdmax_summed %>% filter(CN=="Plantation") %>% pull(vpdmax)), col="red")

vpdmax_seasonal <- as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sm = mean(vpdmax)) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year+1)) %>%
  filter(month %in% c(9,10,11)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(prior_vpdmax_fa = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(12,1,2)) %>% 
  mutate(year = ifelse(month == "12", year+1, year)) %>% 
  filter(!year %in% c(1969,2024)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(prior_vpdmax_wt = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year)) %>%
  filter(month %in% c(3,4,5)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(vpdmax_sp = mean(vpdmax))) %>% 
  left_join(as.data.frame(vpdmax_comb_plantation) %>% 
  mutate(vpdmax = as.numeric(vpdmax), year=as.integer(year+1)) %>%
  filter(month %in% c(6,7,8)) %>% 
  group_by(CN, year) %>% 
 dplyr::summarise(prior_vpdmax_sm = mean(vpdmax)))


##look at correlation in annual variables
left_join(tmean_summed,tmax_summed) %>% 
  left_join(tmin_summed) %>% 
  left_join(vpdmax_summed) %>% 
  left_join(ppt_summed) %>% 
  ungroup() %>% 
  dplyr::select(tmean:ppt) %>% 
  cor()

```

##FDSI calculation

High FDSI value = less droughty

```{r}
all_climate <- left_join(ppt_comb_plantation,tmax_comb_plantation) %>% 
  left_join(tmin_comb_plantation) %>% 
  left_join(tmean_comb_plantation) %>% 
  left_join(vpdmax_comb_plantation) %>% 
  left_join(vpdmin_comb_plantation) %>% 
  mutate(vpdmean=(vpdmin+vpdmax)/2)

nrow(all_climate)
nrow(tmin_comb_plantation)

all_climate_long <- all_climate %>% 
  pivot_longer(c("ppt","tmax","tmin","tmean","vpdmax","vpdmin","vpdmean"), names_to="climvar", values_to = "value") %>% 
  mutate(monthvar = paste(climvar,month,sep=""))

climate_minus1<- all_climate_long %>% 
  mutate(year=year+1) %>% 
  mutate(monthvar = paste("yr1",climvar,month,sep=""))

climate_minus2<- all_climate_long %>% 
  mutate(year=year+2) %>% 
  mutate(monthvar = paste("yr2",climvar,month,sep=""))

climate_allyears <- rbind(all_climate_long, climate_minus1, climate_minus2)

### FDSI CALC

### CALCULATIONS TAKEN FROM WILLIAMS ET AL., 2013 
# DOI: 10.1038/NCLIMATE1693
#https://www.nature.com/articles/nclimate1693
FDSI_C <- climate_allyears %>%
 dplyr::select(-c("date","month","climvar")) %>% 
  pivot_wider(id_cols=c("CN","year"), names_from = monthvar, values_from = value)

head(FDSI_C)

FDSI_raw<- FDSI_C %>% 
  group_by(CN, year) %>% 
  summarise(FDSIvpd=(((vpdmean5+vpdmean6+vpdmean7)/3)+(yr1vpdmean8+yr1vpdmean9+yr1vpdmean10)/3)/2, FDSIppt=log(yr1ppt11+yr1ppt12+ppt1+ppt2+ppt3))

meanVPD <- mean(FDSI_raw$FDSIvpd, na.rm=T)
meanppt <- mean(FDSI_raw$FDSIppt, na.rm=T)
SDVPD <- sd(FDSI_raw$FDSIvpd, na.rm=T)
SDppt <- sd(FDSI_raw$FDSIppt, na.rm=T)
FDSI_raw$zscoreppt <- ((FDSI_raw$FDSIppt-meanppt)/SDppt)
FDSI_raw$zscoreVPD <- ((FDSI_raw$FDSIvpd-meanVPD)/SDVPD)

FDSI_raw$FDSI <- (0.44*(FDSI_raw$zscoreppt)-0.56*(FDSI_raw$zscoreVPD))

ggplot(FDSI_raw, aes(x=year, y=FDSI))+
  geom_line()+
  geom_point()
#I think we need to consider the fact that FDSI was really high right before the drought of the early 2000's so that's why trees may not be showing equivalent growth rates after the drought (cause it was still relatively hot and dry)
```

##CWD calculation

```{r}
source("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/grad school/cwd_function_v3.r")
# 
# #get dem
# dem_plantation <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/PIENproject/USGS_13_n40w107_20220216.tif")
# 
# slpasp <- terrain(dem_plantation, v = c("slope","aspect"))
# 
# slpasp_plantation <- terra::extract(slpasp, adjusted_provs %>% filter(Provenance=="Plantation"), method="simple")
# 
# plantation_cwd_data <- all_climate %>% left_join(as.data.frame(adjusted_provs) %>% bind_cols(crds(adjusted_provs)) %>% filter(Provenance=="Plantation"), by=c("CN"="Provenance")) %>%
#   mutate(soilawc=116.5, foldedaspect = abs(180-abs(slpasp_plantation$aspect - 225)), slope=slpasp_plantation$slope)
# 
# write.csv(plantation_cwd_data, "plantation_cwd_data.csv")

plantation_cwd_data<- read.csv("plantation_cwd_data.csv")

plantation_cwd <- cwd_function(site="plantation",slope=plantation_cwd_data$slope, latitude=plantation_cwd_data$y, foldedaspect = plantation_cwd_data$foldedaspect, ppt = plantation_cwd_data$ppt, tmean = plantation_cwd_data$tmean, month = plantation_cwd_data$month, soilawc = plantation_cwd_data$soilawc, year = plantation_cwd_data$year, type="annual")

head(plantation_cwd)


priorsm_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(prior_cwd_sm = sum(cwd)) %>% 
  mutate(year=year+1)%>% 
  filter(year>1970)

priorfa_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)) %>% 
  mutate(year=year+1, prior_cwd_fa=cwd_fa) %>% 
  dplyr::select(-cwd_fa)%>% 
  filter(year>1970)

wt_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(1,2)) %>%
  group_by(site, year) %>% 
  summarise(cwd_wt12 = sum(cwd)) %>% 
  left_join(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(12)) %>% 
  group_by(site, year) %>% 
  summarise(cwd_wtdec = sum(cwd)) %>% 
  mutate(year=year+1)) %>% 
  mutate(prior_cwd_wt = cwd_wt12+cwd_wtdec)%>% 
  dplyr::select(-c(cwd_wt12, cwd_wtdec)) %>% 
  filter(year>1970)

sp_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd))%>% 
  filter(year>1970)

sm_cwd<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(cwd_sm = sum(cwd))%>% 
  filter(year>1970)

cwd_seasonal <- left_join(priorsm_cwd,priorfa_cwd) %>% 
  left_join(wt_cwd) %>% 
  left_join(sp_cwd) %>% 
  left_join(sm_cwd)

##spring drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(cwd_sp = sum(cwd)), aes(x=year, y=cwd_sp))+
  geom_point()+
  geom_line()

##fall drought
ggplot( plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(cwd_fa = sum(cwd)), aes(x=year, y=cwd_fa))+
  geom_point()+
  geom_line()

#summer drought
ggplot(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% filter(month%in%c(6,7,8)), aes(x=date, y=cwd))+
  geom_point(aes(col=factor(year)))+
  geom_line()

#number of times each month throughout the time series had CWD>0. July and August are most common times when CWD > 0, and it averages ~10mm
plantation_cwd %>% 
  filter(cwd>0) %>% 
  group_by(month) %>% 
  summarise(n=n(), mean=mean(cwd))

##summarise monthly climate on an annual basis
plantation_cwd_annual <- plantation_cwd %>% 
  group_by(site,year, soilawc) %>% 
  summarise(ppt_sum = sum(ppt), tmean_ave=mean(tmean), aet_sum=sum(aet), cwd_sum=sum(cwd))

plantation_cwd_annual_long<- plantation_cwd_annual %>% 
  left_join(FDSI_raw %>% dplyr::select(year,FDSI), by="year") %>% 
  dplyr::select(-CN) %>% 
  pivot_longer(ppt_sum:FDSI)

ggplot(plantation_cwd_annual_long %>% filter(name%in%c("cwd_sum","FDSI")), aes(x=year, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_wrap(~name, scales = "free")
  
```

##AET

```{r}
priorsm_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(prior_aet_sm = sum(aet)) %>% 
  mutate(year=year+1)%>% 
  filter(year>1970)

priorfa_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(9,10,11)) %>%
  group_by(site, year) %>% 
  summarise(aet_fa = sum(aet)) %>% 
  mutate(year=year+1, prior_aet_fa=aet_fa) %>% 
  dplyr::select(-aet_fa)%>% 
  filter(year>1970)

wt_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(1,2)) %>%
  group_by(site, year) %>% 
  summarise(aet_wt12 = sum(aet)) %>% 
  left_join(plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(12)) %>% 
  group_by(site, year) %>% 
  summarise(aet_wtdec = sum(aet)) %>% 
  mutate(year=year+1)) %>% 
  mutate(prior_aet_wt = aet_wt12+aet_wtdec)%>% 
  dplyr::select(-c(aet_wt12, aet_wtdec)) %>% 
  filter(year>1970)

sp_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(3,4,5)) %>%
  group_by(site, year) %>% 
  summarise(aet_sp = sum(aet))%>% 
  filter(year>1970)

sm_aet<- plantation_cwd %>% 
  mutate(date= as.Date(paste(month,"01",year,sep="/"), "%m/%d/%Y")) %>% 
  filter(month%in%c(6,7,8)) %>%
  group_by(site, year) %>% 
  mutate(wateryear = year+1) %>% 
  summarise(aet_sm = sum(aet))%>% 
  filter(year>1970)

aet_seasonal <- left_join(priorsm_aet,priorfa_aet) %>% 
  left_join(wt_aet) %>% 
  left_join(sp_aet) %>% 
  left_join(sm_aet)

```

##RAWS
This data is from Dowd Junction weather station, located at 39.626944, -106.451667 - just down the mountain from the White River Plantation site. 

```{r, run=FALSE}
DJ <- read.csv("DowdJunction_monthlydata.csv")

DJ[ DJ == "-9999"] <- NA

DJ_seasonal<- DJ %>% 
  separate(date, into=c("month","day","year"), sep="/", remove=TRUE) %>% 
  mutate(month=as.numeric(month), day=as.numeric(day), year=as.numeric(year)) %>% 
  mutate(season = case_when(month %in% c(12,1,2) ~ "winter",
                            month %in% c(3,4,5) ~ "spring",
                            month %in% c(6,7,8) ~ "summer",
                            month %in% c(9,10,11) ~ "fall"),
         seasonyear = ifelse(month==12, year+1, year)) %>% 
  filter(seasonyear>1985) %>% 
  group_by(seasonyear, season) %>% 
  summarise(ave_mean_air_temp_C = mean(mean_air_temp_C, na.rm=TRUE),
            ave_daily_max_temp_C = mean(mean_daily_max_temp_C, na.rm=TRUE),
            ave_daily_min_temp_C = mean(mean_daily_min_temp_C, na.rm=TRUE),
            ave_mean_RH = mean(mean_RH, na.rm=TRUE),
            total_season_precip_mm = sum(total_precip_mm, na.rm=TRUE))

##looks pretty similar
ggplot()+
  geom_point(data=DJ_seasonal %>% filter(season=="summer" & seasonyear>1986), aes(x=seasonyear, y=ave_mean_air_temp_C), color="orange")+
  geom_line(data=DJ_seasonal %>% filter(season=="summer" & seasonyear>1986), aes(x=seasonyear, y=ave_mean_air_temp_C), color="orange")+
  geom_point(data=plantation_seasonal_temps %>% dplyr::select(year,tmean_sm), aes(x=year, y=tmean_sm), color="red")+
  geom_line(data=plantation_seasonal_temps %>% dplyr::select(year,tmean_sm), aes(x=year, y=tmean_sm), color="red")
```

##All climate vars

```{r}
#combine all climate vars

plantation_clim <- ppt_seasonal_plantation %>% 
  left_join(plantation_seasonal_temps) %>% 
  left_join(vpdmax_seasonal) %>% 
  left_join(cwd_seasonal) %>% 
  left_join(aet_seasonal) 

colnames(plantation_clim)

plantation_clim_long <- plantation_clim %>% 
  dplyr::select(-site) %>% 
  pivot_longer(prior_ppt_sm:aet_sm) %>% 
  separate(name, into=c("name1","name2","name3"), sep="_",remove=FALSE, fill="left") %>% 
  mutate(statistic = case_when(name2 %in% c("tmax","vpdmax") ~ "max",
                               name2=="tmin"~ "min",
                               name2=="tmean" ~ "mean",
                               name2%in%c("ppt","aet","cwd") ~ "sum",
                               TRUE ~ NA),
         type = case_when(name2=="tmax" ~ "TEMP (C)",
                               name2=="tmin"~ "TEMP (C)",
                               name2=="tmean" ~ "TEMP (C)",
                               name2=="ppt" ~ "PPT (mm)",
                               name2=="vpdmax"~"VPD",
                               name2=="aet"~"AET",
                               name2=="cwd"~"CWD",
                               TRUE ~ NA))

plantation_clim_long_currentyr<- plantation_clim_long %>%
  mutate(time_season=paste(name1, name3, sep="_")) %>% 
  dplyr::filter(! time_season == "prior_sm") %>% 
  mutate(currentyr = case_when(time_season=="prior_fa" ~ year-1,
                               TRUE ~ year)) %>% 
  filter(currentyr>1969) %>% 
  filter(currentyr<2016)

ggplot(plantation_clim_long_currentyr %>% filter(name2 %in% c("ppt","tmin","tmean","tmax")), aes(x=currentyr, y=value, col=type))+
  scale_color_manual(values=c("skyblue4","firebrick"))+
  ggnewscale::new_scale_color()+
    geom_line(aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  geom_smooth(method="lm", aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  scale_color_manual(values = c("skyblue4","#6B1717","firebrick","#E79191"), name="Statistic")+
  facet_wrap(type~factor(name3, levels=c("sp","sm","fa","wt"), labels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=2)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))+
  xlab("year")


ggplot(plantation_clim_long_currentyr, aes(x=currentyr, y=value, col=name2))+
  ggnewscale::new_scale_color()+
  geom_line(aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  geom_smooth(method="lm", aes(color=factor(statistic, levels=c("sum","max","mean","min"))))+
  facet_wrap(type~factor(name3, levels=c("sp","sm","fa","wt"), labels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=5)+
  geom_vline(xintercept=2002, linewidth=1)+
  theme_bw()+
  theme(axis.text=element_text(angle=45, hjust=1))

###models

##spring ppt

spppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="ppt_sp"))
plot(spppt_mod)
summary(spppt_mod) #NS

##summer ppt

smppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="ppt_sm"))
plot(smppt_mod)
summary(smppt_mod) #NS

##fall ppt

atppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_ppt_fa"))
plot(atppt_mod)
summary(atppt_mod) #NS

##winter ppt

wtppt_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_ppt_wt"))
plot(wtppt_mod)
summary(wtppt_mod) #NS

##spring temp

sptmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmean_sp"))
plot(sptmean_mod)
summary(sptmean_mod) #NS

sptmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmin_sp"))
plot(sptmin_mod)
summary(sptmin_mod) #significant, NS for 1970-2015

sptmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmax_sp"))
plot(sptmax_mod)
summary(sptmax_mod) #NS

##summer temp

smtmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmean_sm"))
plot(smtmean_mod)
summary(smtmean_mod) #Significant

smtmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmin_sm"))
plot(smtmin_mod)
summary(smtmin_mod) #significant

smtmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="tmax_sm"))
plot(smtmax_mod)
summary(smtmax_mod) #NS

##fall temp

attmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmean_fa"))
plot(attmean_mod)
summary(attmean_mod) #Significant

fatmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmin_fa"))
plot(fatmin_mod)
summary(fatmin_mod) #significant

fatmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmax_fa"))
plot(fatmax_mod)
summary(fatmax_mod) #significant, NS for 1970-2015

##winter temp

wttmean_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmean_wt"))
plot(wttmean_mod)
summary(wttmean_mod) #NS

wttmin_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmin_wt"))
plot(wttmin_mod)
summary(wttmin_mod) #significant, NS for 1970-2015

wttmax_mod <- lm(value~currentyr, data=plantation_clim_long_currentyr %>% filter(name=="prior_tmax_wt"))
plot(wttmax_mod)
summary(wttmax_mod) #NS
```

```{r}
##look at trends in climate over time at the plantation just for 1970-2015

plantation_clim_all_studyperiod<- plantation_clim_long_currentyr %>% 
  filter(currentyr < 2016) %>% 
  filter(!currentyr < 1970) %>% 
  filter(!is.na(value)) %>% 
  mutate(name=paste(name2,name3,sep="_"))

ggplot(plantation_clim_all_studyperiod, aes(x=currentyr, y=value, col=name2, group=name2))+
  geom_point()+
  geom_smooth(method="lm",col="black")+
  facet_wrap(type~factor(name3, levels=c("sp","sm","fa","wt"), labels=c("Spring","Summer","Fall","Winter")), scales="free", nrow=5)

plantation_climvars <- unique(plantation_clim_all_studyperiod$name)

plant_clim_mods <- data.frame()
for(i in 1:length(plantation_climvars)){
climvar = plantation_climvars[i]
data= plantation_clim_all_studyperiod %>% filter(name==climvar)
mod <- lm(value ~ currentyr, data=data)
pvalue = as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
plant_clim_mods <- bind_rows(plant_clim_mods, data.frame(climvar=climvar, pvalue=pvalue))
}

plant_clim_mods %>% filter(pvalue<0.05)  ###fall and summer tmin and fall aet significantly increased during the study period

```

##Climate extremes

```{r}
plantation_clim_long_qs<- plantation_clim_long_currentyr %>% 
  left_join(plantation_clim_long_currentyr %>% 
              mutate(var_season=paste(name2,name3,sep="_")) %>% 
              filter(!is.na(value)) %>% 
              group_by(name2, name3, var_season) %>% 
              summarise(q2.5 = quantile(value, 0.025), q97.5 = quantile(value, 0.975), out.hi = quantile(value, c(0.75))  + IQR(value)*1.5, out.low = quantile(value, c(0.75)) - IQR(value)*1.5)) %>% 
  mutate(name=paste(name2,name3,sep="_")) %>% 
  filter(currentyr > 1969) %>% 
  filter(currentyr < 2016)

##look at years where each climate variable exceeded the 97.5th (or 2.5th) percentile - these are years of potentially extreme climate 
ggplot(plantation_clim_long_qs, aes(x=currentyr, y=value, col=name))+
  geom_point()+
  geom_line()+
  facet_grid(name2~name3, scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.low), col="black")+
  geom_line(data=plantation_clim_long_qs, aes(x=year, y=out.hi), col="black")

###############
## identify drought year
###############
unique(plantation_clim_long_qs$name)

plantation_clim_xtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = case_when(name2 %in% c("ppt","aet") & value < out.low ~ "yes",
                             name2 %in% c("cwd","spei","tmax","tmean","tmin","vpdmax") & value > out.hi ~"yes",
                             TRUE ~ "no")) %>% 
  filter(extreme=="yes")

ggplot(plantation_clim_long_qs %>% 
  mutate(extreme = case_when(name2 %in% c("ppt","aet") & value < out.low ~ "yes",
                             name2 %in% c("cwd","spei","tmax","tmean","tmin","vpdmax") & value > out.hi ~"yes",
                             TRUE ~ "no")), aes(x=currentyr, y=value))+
  geom_vline(xintercept=2002, col="orange")+
  scale_color_manual(values=c("black","red"), name="Dry extreme")+
  geom_line()+
  geom_point(aes(col=extreme))+
  facet_grid(factor(name2, levels=c("aet","cwd","ppt","tmax","tmean","tmin","vpdmax"), labels = c("AET (mm)","CWD (mm)","ppt (mm)","tmax (C)","tmean (C)","tmin (C)","vpdmax (hPa)"))~factor(name3, levels=c("sp","sm","fa","wt")), scales="free")+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.low), col="gray20")+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.hi), col="gray20")+
  theme_bw()+
  xlab("year")+
  theme(strip.text=element_text(size=12), legend.text=element_text(size=12))


xtreme_d_byyr<- plantation_clim_xtremes %>% 
  group_by(currentyr) %>% 
  summarise(n=n()) %>% 
  as.data.frame()

ggplot(xtreme_d_byyr, aes(x=currentyr, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("gold","brown"))+
  ylab("# of extreme variables")+
  theme_bw()

###########
## identify cold years
#############
plantation_clim_coldxtremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name2 %in% c("tmax","tmean","tmin","vpdmax","cwd") & value < out.low, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

xtreme_c_byyr<- plantation_clim_coldxtremes %>% 
  group_by(currentyr) %>% 
  summarise(n=n()) 

ggplot(xtreme_c_byyr, aes(x=currentyr, y=n, fill=n))+
  geom_bar(stat='identity')+
  scale_fill_gradientn(colors=c("lightblue","navy")) #1984 was really cold

plantation_clim_wetextremes<- plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name2 %in% c("ppt","aet","spei") & value > out.hi, "yes", "no" 
  )) %>% 
  filter(extreme=="yes")

ggplot(plantation_clim_long_qs %>% 
  mutate(extreme = ifelse(name2 %in% c("tmax","tmean","tmin","vpdmax","cwd") & value < out.low, "yes", "no" 
  )), aes(x=currentyr, y=value))+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.low), col="gray20")+
  geom_line(data=plantation_clim_long_qs, aes(x=currentyr, y=out.hi), col="gray20")+
  scale_color_manual(values=c("black","#B097FF"))+
  geom_vline(xintercept = 1984, col="blue")+
  geom_line()+
  geom_point(aes(color=extreme))+
  facet_grid(name2~factor(name3, levels=c("sp","sm","fa","wt")), scales="free")+
  theme_bw()

```

##Frost

```{r}
tmindata_30 <- read.csv("tmindata_30.csv")
tmindata_31 <- read.csv("tmindata_31.csv")

head(tmindata_30)
head(tmindata_31)

tmin_all<- bind_rows(tmindata_30, tmindata_31) %>% 
  mutate(date=mdy(paste(month,day,year,sep="-"))) %>% 
  arrange(date)

frost_days<- tmin_all %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(n=n())

ggplot(frost_days, aes(x=year, y=n))+
  geom_point()+
  geom_smooth(method="lm")
  
fd_mod <- lm(n ~ year, data=frost_days)
par(mfrow=c(2,2))
plot(fd_mod)
summary(fd_mod)

tmin_aves<- tmin_all %>% 
  group_by(month,day) %>% 
  summarise(ave_tmin=mean(tmin), se=sd(tmin)/sqrt(n()), n=n()) %>% 
  mutate(doy = ymd(paste("2000",month,day,sep="-")))

tmin_all_spring <- tmin_all %>% 
  filter(month %in% c(5,6,7)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(last_spring_frost = max(date)) %>% 
  bind_rows(data.frame(year=2009, last_spring_frost=as.Date("2009-05-14"))) %>% 
  mutate(day_of_last_spring_frost = as.numeric(yday(last_spring_frost)))

tmin_all_fall <- tmin_all %>% 
  filter(month %in% c(8,9,10)) %>% 
  filter(tmin<0) %>% 
  group_by(year) %>% 
  summarise(first_fall_frost = min(date)) %>%
  bind_rows(data.frame(year=2015, first_fall_frost=as.Date("2015-10-14"))) %>% 
  mutate(day_of_first_fall_frost = as.numeric(yday(first_fall_frost)))

plantation_frost <- left_join(tmin_all_spring, tmin_all_fall) %>% 
  dplyr::select(year, day_of_first_fall_frost, day_of_last_spring_frost) %>% 
  mutate(CN="Plantation")

vlines<- prov_clim_adjusted_bi %>% 
  dplyr::select(Provenance,bFFP,eFFP) %>% 
    mutate(bFFP_date = as.Date(bFFP, origin = "1999-12-31"),
           eFFP_date = as.Date(eFFP, origin = "1999-12-31")) %>% 
  arrange(bFFP) %>% 
  mutate(num = seq(-3.6,8.4,.6)) 

hlines <- vlines %>% 
  pivot_longer(bFFP_date:eFFP_date)


ggplot(tmin_aves, aes(x=doy, y=ave_tmin))+
  # geom_vline(data=vlines, aes(xintercept=bFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  # geom_vline(data=vlines, aes(xintercept=eFFP_date, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_line(data=hlines, aes(x=value, y=num, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=3)+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_text(data=hlines, aes(x=ymd("2000-08-01"), y=num+.2, label=Provenance))+
  geom_point()+
  geom_errorbar(aes(ymin=ave_tmin-se, ymax=ave_tmin+se ))+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  theme_bw()
```

##PIEN climate niche

```{r}
pien <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/pien_range.tif")

pien2 <- classify(pien, cbind(-Inf, 0, NA), right=TRUE)
pien_trim<- trim(pien2)
par(mfrow=c(1,1))
plot(pien_trim)

engelmann_points_usonly <- spatSample(pien_trim, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
engelmann_clim_us <- terra::extract(clim_raster_stack, engelmann_points_usonly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##get points for Canada distribution from Mathys study and limit to only those within the boundary established by Little.
pien_mathys <- rast("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Current and predicted range of Engelmann spruce under climate change in the Pacific Northwest/data/commondata/data0/es_5075/w001001.adf")

pien_little <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ASCC/ASCC/maps/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")

pien_mathys2 <- classify(pien_mathys, cbind(-Inf, 0, NA), right=TRUE)
pien_mathys_crop_ca <- crop(pien_mathys2 %>% project(crs(canada)), canada %>% filter(NAME_1%in%c("Alberta","British Columbia")) ) %>% crop(pien_little %>% project(crs(canada))) %>%
  trim()

pien_mathys_little_ca_points <- spatSample(pien_mathys_crop_ca, size=100000, method="regular", replace=FALSE, na.rm=TRUE, as.points=TRUE, values=TRUE, xy=TRUE)
pien_mathys_little_ca_points_crop <- crop(pien_mathys_little_ca_points, pien_little %>% project(crs(pien_mathys_little_ca_points)))
pien_mathys_little_ca_clim <- terra::extract(clim_raster_stack, pien_mathys_little_ca_points_crop %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

##combine US and Canada climates
clim_pien<- bind_rows(pien_mathys_little_ca_clim,engelmann_clim_us)

ggplot()+
  geom_spatvector(data=engelmann_points_usonly %>% project(crs(canada)),size=0.05)+
  geom_spatvector(data=pien_mathys_little_ca_points_crop %>% project(crs(canada)), size=0.05)+
  geom_spatvector(data = canada, fill=NA, color="red")+
  geom_spatvector(data=westernus, fill=NA, color="red")
```

## PCA

```{r}
#run the PCA

##have to take out smrpb if I want to project into the future...or calculate it from ClimateNA variables

clim_pien_cor<- clim_pien %>% 
  dplyr::select(-ID) %>% 
  filter(!is.na(AHM)) %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP) %>% 
  cor()

ggcorrplot(clim_pien_cor, outline.color="white", type="lower", hc.order=TRUE)

pca2_clim_vars <- c("CMD","MCMT","MWMT","NFFD","PAS","PPTsm","PPTsp","PPTat","PPTwt","RH","TD","smrpb","monsoonality")

env_vars_pien<- clim_pien %>% 
  mutate(smrpb = PPTsm/PPTsp, monsoonality = MSP/MAP) %>% 
    filter(!is.na(AHM)) %>% 
  dplyr::select(all_of(pca2_clim_vars))

env_vars_pien %>% 
  cor()

env_vars_noplant<- prov_clim_adjusted_bi %>% 
  filter(!Provenance=="Plantation") %>% 
  dplyr::select(colnames(env_vars_pien))

big_pca_data <- bind_rows(env_vars_noplant, env_vars_pien)
big_pca_data %>% 
  cor()

set.seed(83)
clim_pca_big <- prcomp(big_pca_data,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units

##to get eigenvalues, we do the square of the stdev
eigenvals_pcabig<- (clim_pca_big$sdev)^2
eigenvals_pcabig
sum(eigenvals_pcabig) #the sum of the eigenvalues = the number of variables (13)
eigenvals_pcabig/sum(eigenvals_pcabig)#this is the proportion variance explained
summary(clim_pca_big)
par(mfrow=c(1,1))
plot(clim_pca_big,type="l")
```

```{r, echo=FALSE}
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC1)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC2)))
as.data.frame(clim_pca_big$rotation[,1:3]) %>% 
  tibble::rownames_to_column() %>% 
  arrange(desc(abs(PC3)))
```

```{r}
#plot PCA
prov_pcapts_big <- clim_pca_big$x[1:nrow(env_vars_noplant),] %>% 
  cbind(prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation")) %>% 
  left_join(prov_names) 

plantation_pcapts <- clim_pca_big$x[1:nrow(env_vars_noplant),] %>% 
  cbind(prov_clim_adjusted_bi %>% filter(!Provenance=="Plantation")) %>% 
  left_join(prov_names) 

plantation_only <- prov_clim_adjusted_bi %>% filter(Provenance == "Plantation") %>% 
  mutate(period="1970s")

plantation_future <- prov_futures_long %>% filter(Provenance=="Plantation") %>% 
  pivot_wider(names_from=climvar, values_from=value, id_cols = c(ID,Provenance,carbon,period)) 

plantation_all<- bind_rows(plantation_only, plantation_future)

carbon.colors<- c("black",brewer.pal(6,"RdBu")[c(6,5,2,1)])

plantation_clim_vars <- plantation_all %>% 
  dplyr::select(c(period,colnames(env_vars_pien)))

big_pca_data_sum <- big_pca_data %>% 
  as.data.frame() %>% 
  mutate(id=seq(1:nrow(big_pca_data))) %>% 
  pivot_longer(CMD:monsoonality) %>% 
  group_by(name) %>% 
  summarise(mean = mean(value), sd=sd(value))

scaled_plantation_futures<- plantation_clim_vars %>% 
  pivot_longer(CMD:monsoonality) %>% 
  left_join(big_pca_data_sum) %>% 
  mutate(scaledvalue = (value - mean)/sd) %>% 
  dplyr::select(period,name,scaledvalue) %>% 
  pivot_wider(names_from="name", values_from = "scaledvalue") %>% 
  dplyr::select(-period)

plant_pca_scores <- data.frame(Provenance="Plantation",
                               period = plantation_all$period,
                               PC1 = (clim_pca_big$rotation[,1] %*% t(scaled_plantation_futures))[1,],
                               PC2 = (clim_pca_big$rotation[,2] %*% t(scaled_plantation_futures))[1,],
                               PC3 = (clim_pca_big$rotation[,3] %*% t(scaled_plantation_futures))[1,])

##### playing with factoextra visualizations #####

get_eigenvalue(clim_pca_big)
fviz_eig(clim_pca_big, addlabels=TRUE)
var<-get_pca_var(clim_pca_big)
var$coord

fviz_pca_var(clim_pca_big, col.var="black")
fviz_cos2(clim_pca_big, choice = "var", axes = 1)
fviz_pca_var(clim_pca_big, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )
head(var$contrib, 3)
corrplot(var$contrib, is.corr=FALSE) 
contrib.plot<- ggarrange(fviz_contrib(clim_pca_big, choice="var", axes=1, fill="wheat3", color="wheat3", title="PC1",xtickslab.rt = 90),fviz_contrib(clim_pca_big, choice="var", axes=2,fill="wheat3", color="wheat3", title="PC2", xtickslab.rt = 90), nrow=1)

contrib.plot

###pien climate niche
scores1 <- data.frame(clim_pca_big$x[,1:3])
# scores <- lapply(scores1, function(x) x / sqrt(sum((x - mean(x))^2)))
loadings <- as.data.frame(clim_pca_big$rotation)[1:3]
loadings_pc1pc2 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","PPTwt","PPTsp","monsoonality","smrpb","CMD","MCMT","NFFD","MWMT"),]
loadings_pc1pc3 <- as.data.frame(clim_pca_big$rotation)[1:3][c("PAS","PPTat","PPTwt","PPTsp","monsoonality","smrpb","CMD","MCMT","NFFD","MWMT"),]
scale <- min(max(abs(scores1$PC1))/max(abs(loadings$PC1)),
             max(abs(scores1$PC2))/max(abs(loadings$PC2))) * 0.8

###test -- this is how you manually calculate contribution of variables to each PC. 
var_cor_func <- function(var.loadings, comp.sdev){var.loadings*comp.sdev}
var.cor <- t(apply(clim_pca_big$rotation, 1, var_cor_func, clim_pca_big$sdev))
var.cor  ##correlation
var.cor^2 ##cos2
comp.cos2 <- apply(var.cor^2, 2, sum)
contrib <- function(var.cos2, comp.cos2){var.cos2*100/comp.cos2}
var.contrib <- t(apply(var.cor^2,1, contrib, comp.cos2))
###

pc1_pc2_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=c(.1,.1,.1,.1,.1,.1,1,-.1,-.2,-.3), vjust=c(1.2,1.2,1.2,-1.2,1.2,1.2,1,1,1,1))+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance", guide="none")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC2, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=2)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC2 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[2]*100,1),"%)",sep=""))+
   xlim(-5,5.5)+
   ylim(-4.5,8)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc2_niche_plot.png", width=5, height=4, res=300, units = "in")
pc1_pc2_niche_plot
dev.off()
 

pc1_pc3_niche_plot <- ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC3))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc3 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC3),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc3 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc3)),
               aes(x = PC1, y = PC3, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC3, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  geom_point(data=prov_pcapts_big, aes(x=PC1, y=PC3, fill=factor(Provenance, levels=provs_bylat$Provenance)), size=1.5, shape=24)+
  ggrepel::geom_text_repel(data=prov_pcapts_big, aes(label=code), size=1.5)+
   xlim(-5,5.5)+
   ylim(-4.5,8)+
  xlab(paste("PC1 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[1]*100,1),"%)",sep=""))+
  ylab(paste("PC3 (",round((eigenvals_pcabig/sum(eigenvals_pcabig))[3]*100,1),"%)",sep=""))+
  theme_bw()+
  theme(legend.position = "none", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8))

png("figures/pc1_pc3_niche_plot.png", width=3, height=3, res=300, units = "in")
pc1_pc3_niche_plot
dev.off()
 
figpca_legend <- get_legend( ggplot(as.data.frame(clim_pca_big$x[-(1:5),]), aes(x=PC1, y=PC2))+
  geom_hex(alpha=0.7, na.rm=TRUE, bins=50)+
  geom_segment(data = loadings_pc1pc2 * scale,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               color = "black", linewidth=.25, arrow = arrow(angle = 25, length = unit(2, "mm")))+
  geom_text(data = as.data.frame(loadings_pc1pc2 * scale) %>% 
              mutate(name=rownames(loadings_pc1pc2)),
               aes(x = PC1, y = PC2, label=name),
               color = "black", size=2, hjust=-.1, vjust=1)+
  scale_fill_gradientn(colors=c("wheat","tan4"))+
  ggnewscale::new_scale_fill()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_point(data=plant_pca_scores, aes(x=PC1, y=PC2, shape=period), col="black", size=2)+
  scale_shape_manual(values=c(19,15,8,3))+
  xlim(-10,8)+
  ylim(-3,6)+
  theme_bw()+
  theme(legend.position = "right", axis.text = element_text(color="black", size=6), axis.title = element_text(size=8)) )
```


Put it all together with a map of the provenances

```{r}

###put pien distribution on map
pien_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Engelmann spruce ( Picea engelmannii) extent, North America/data/commondata/data0/piceenge.shp")
pigl_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/White spruce (Picea glauca) extent, North America/data/commondata/data0/piceglau.shp")
pipu_little_map <- vect("C:/Users/KatherineNigro/Box/01. katherine.nigro Workspace/ArcGIS/Projects/SpeciesRanges/Blue spruce (Picea pungens) extent, North America/data/commondata/data0/picepung.shp")
pien_little_map_prj <- project(pien_little_map, crs(westernus))
pien_little_map_prj_crop <- crop(pien_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pigl_little_map_prj <- project(pigl_little_map, crs(westernus))
pigl_little_map_prj_crop <- crop(pigl_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )
pipu_little_map_prj <- project(pipu_little_map, crs(westernus))
pipu_little_map_prj_crop <- crop(pipu_little_map_prj, ext(-126.92, -93.36, 26.2, 52) )

canada_crop <- crop(canada, ext(-126.92, -97.23, 41.6769, 52))

map <- ggplot()+
  geom_spatvector(data=westernus, col="grey", fill="gray100")+
  geom_spatvector(data=canada_crop, col="grey", fill="gray100")+
  geom_spatvector(data=pien_little_map_prj_crop, fill="wheat", col="wheat")+
  geom_spatvector(data=pigl_little_map_prj_crop, fill="thistle", col="thistle", alpha=0.6)+
  geom_spatvector(data=pipu_little_map_prj_crop, fill="paleturquoise", col="paleturquoise",alpha=.6)+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(!Provenance == "Plantation"), aes(fill=factor(Provenance, levels=provs_bylat$Provenance)), shape=24, size=1.5)+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_spatvector(data=adjusted_provs %>% left_join(prov_names) %>% filter(Provenance == "Plantation"), color="black", size=1.5)+
  geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(!Provenance == "Plantation"), aes(label=code), hjust=c(1.2,-.2,-.2,1.1,-.2,-.2,1,.1,0,1.2,-0.2,1.0, 1.1,1.0,0,1,-0.2,1.2,1,1.2), vjust=c(.4,0,0,0,0,0,1.3,1.4,1.3,rep(0,5),1.3,0,-.2,0,0,0), size=2.5)+
    geom_spatvector_text(data=adjusted_provs %>% left_join(prov_names)%>% filter(Provenance == "Plantation"), aes(label="Plantation"), hjust = 1, vjust=-0.4, col="black", size=2.5)+
  theme(panel.grid = element_blank(), legend.position = "none", axis.title=element_blank(), axis.text = element_text(color="black", size=8))+
  # ggspatial::annotation_scale(
  #   location = "bl",
  #   bar_cols = c("black", "white"),
  #     height = unit(0.1, "cm"),
  #   text_cex = 0.5) +
  ggspatial::annotation_north_arrow(
    location = "bl", which_north = "true",
    pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
    style=north_arrow_fancy_orienteering(text_size=8, line_width = 0.8),
    height=unit(.25, "in"),
    width=unit(.25, "in"))

# png("figures/map.png", width=3, height=3, res=300, units = "in")
 map
# dev.off()

png("figures/map_and_bigpca_bluewhite.png", width=8.3, height=6.5, res=300, units = "in")
ggarrange(map,ggarrange(pc1_pc2_niche_plot, contrib.plot, nrow=2, ncol=1, labels=c("B)","C)")), labels=c("A)",""), ncol=2, nrow=1)
dev.off()
```

```{r}
###how well does the plantation represent typical Engelmann spruce habitat?

lines(x= plant_pca_scores %>% filter(period=="1970s") %>% pull(PC1))

prov_pcapts_big

pien_clim_niche<- as.data.frame(clim_pca_big$x[-(1:5),])

ggarrange(
ggplot()+
  geom_histogram(data=pien_clim_niche, aes(x=PC1), fill="gray", col="black")+
  geom_vline(xintercept = plant_pca_scores %>% filter(period=="1970s") %>% pull(PC1), col="darkorange2", linewidth=2)+
  theme_bw(),
ggplot()+
  geom_histogram(data=pien_clim_niche, aes(x=PC2), fill="gray", col="black")+
  geom_vline(xintercept = plant_pca_scores %>% filter(period=="1970s") %>% pull(PC2), col="darkorange2", linewidth=2)+
  theme_bw())

##future
plantation_future
clim_pien

future_engelmann_clim_us <- terra::extract(future_clim_raster_stack, engelmann_points_usonly %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

future_pien_mathys_little_ca_clim <- terra::extract(future_clim_raster_stack, pien_mathys_little_ca_points_crop %>% project(crs(clim_raster_stack)), method="simple", weights=TRUE)

future_clim_pien<- bind_rows(future_pien_mathys_little_ca_clim,future_engelmann_clim_us)

future_clim_pien_long <- future_clim_pien %>% 
  pivot_longer(AHM_ssp585_2020s:SHM_ssp585_2080s) %>% 
  separate(name, sep="_", into=c("var","carbon","period"))

clim_pien_long <- clim_pien %>% 
  pivot_longer(AHM:SHM, names_to=c("var")) %>% 
  mutate(period="1970s")
  
clim_pien_all <- bind_rows(future_clim_pien_long, clim_pien_long)

clim_pien_all %>% 
  filter(var=="NFFD") %>% 
  group_by(period) %>% 
  summarise(n=n())
nrow(clim_pien)
future_clim_pien_long %>% filter(var=="NFFD") %>% nrow()
clim_pien_long %>% filter(var=="NFFD") %>% nrow()
clim_pien_all %>% filter(var=="NFFD") %>% nrow()

ggplot()+
  geom_histogram(data=clim_pien_all %>% filter(var=="NFFD"), aes(x=value, fill=period), alpha=0.3, binwidth = 10, position="identity")+
  scale_fill_manual(values=c("blue","green","orange","red"))+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(NFFD), col="black", linewidth=1.5)+
  geom_text(aes(x=75, y=6000, label="1970's \n plantation"))+
  labs(x="NFFD", y="Count")+
  theme_bw()

ggplot()+
  geom_histogram(data=clim_pien_all %>% filter(var=="MAP"), aes(x=value, fill=period), alpha=0.3, binwidth = 100, position="identity")+
  scale_fill_manual(values=c("blue","green","orange","red"))+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(MAP), col="black", linewidth=1.5)+
  geom_text(aes(x=1200, y=4500, label="1970's \n plantation"))+
  labs(x="MAP", y="Count")+
  theme_bw()



ggplot()+
  geom_histogram(data=clim_pien, aes(x=MCMT), fill="blue", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MCMT_ssp585_2020s), fill="yellow", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MCMT_ssp585_2050s), fill="orange", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MCMT_ssp585_2080s), fill="red", alpha=0.3)+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(MCMT), col="black", linewidth=2)

ggplot()+
  geom_histogram(data=clim_pien, aes(x=MAP), fill="blue", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MAP_ssp585_2020s), fill="yellow", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MAP_ssp585_2050s), fill="orange", alpha=0.3)+
  geom_histogram(data=future_clim_pien, aes(x=MAP_ssp585_2080s), fill="red", alpha=0.3)+
  geom_vline(xintercept = plantation_all %>% filter(period=="1970s") %>% pull(MAP), col="black", linewidth=2)


```

#Response variables

##DBH

```{r}
##DBH data is in centimeters
moniger_data <- read.csv("past_moniger_data.csv")
moniger_data_ids <- read.csv("past_moniger_data_ids.csv")

moniger_data_comb <- moniger_data %>% 
  left_join(moniger_data_ids, by=c("LOC" = "ID.Code")) %>% 
  mutate(Provenance = ifelse(Location == "Larimer County 1","Larimer 1",
                                    ifelse(Location == "Larimer County 2","Larimer 2",Location))) %>% 
  left_join(prov_pcapts_big) 

dbh <- moniger_data_comb %>% 
  dplyr::select(c(SORT, LOC, BLK, REP, DBH91, DBH96, DBH06, DBH14, Provenance, code)) %>% 
  mutate(Series = paste(LOC,BLK,REP,sep="")) 

dbh_long<- dbh %>% 
  filter(!is.na(DBH91)) %>% 
  pivot_longer(DBH91:DBH14, names_to = 'year', values_to = 'DBH')

dbh_clim_data <- dbh_long %>% 
  left_join(prov_pcapts_big) %>% 
  filter(!is.na(DBH)) %>% 
  filter(!DBH==0) ##there is one with a dbh value of 0 which seems like an error.

#arranging provenances by different variables to visually identify patterns in DBH
dbh_by_lat_plot<- ggplot(dbh_long, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by Latitude")

dbh_by_nffd_plot <-ggplot(dbh_clim_data, aes(x=factor(round(NFFD,2)), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
    scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by NFFD")

dbh_by_cmd_plot <-ggplot(dbh_clim_data, aes(x=factor(round(CMD,0)), y=DBH, fill=factor(Provenance, provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(year,levels=c("DBH91","DBH96","DBH06","DBH14")), nrow=1)+
  theme(legend.position = 'none', axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ggtitle("Arranged by CMD")

```


###absolute DBH

####ANOVA

```{r}
dbh_numeric <- dbh_clim_data %>% 
  mutate(num.yr = as.numeric(ifelse(year=="DBH91", 1,
                         ifelse(year=="DBH96", 6,
                                ifelse(year=="DBH06", 16,
                                       ifelse(year=="DBH14", 24, year))))))

dbh_aov <- lmer(DBH ~ year*Provenance + (1|BLK), data = dbh_numeric)
plot(dbh_aov)
qqmath(dbh_aov)
summary(dbh_aov)
anova(dbh_aov) #no significant interaction
rand(dbh_aov)
dbh_aov_noint <- lmer(DBH ~ year + Provenance + (1|BLK), data = dbh_numeric)
Anova(dbh_aov_noint, type="2") #both year and provenance are significant but do not interact (relatively similar order of provenance DBH in each year measured)
summary(dbh_aov_noint)
rand(dbh_aov_noint)

###model each year separately
dbh_aov91 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH91"))

plot(dbh_aov91)
anova(dbh_aov91)
rand(dbh_aov91)

dbh_aov91_marg = lsmeans(dbh_aov91, ~ Provenance)

CLD_dbh_aov91 = cld(dbh_aov91_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov91 #payette greater than 12, gila less than 10

dbh_aov96 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH96"))
plot(dbh_aov96)
anova(dbh_aov96)
dbh_aov96_marg = lsmeans(dbh_aov96, ~ Provenance)

CLD_dbh_aov96 = cld(dbh_aov96_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov96 #payette greater than 12, gila less than 10, cache less than 13

  
dbh_aov06 <- lmer(DBH ~ Provenance + (1|BLK), data = dbh_numeric %>% filter(year=="DBH06"))
plot(dbh_aov06)
anova(dbh_aov06)
dbh_aov06_marg = lsmeans(dbh_aov06, ~ Provenance)

CLD_dbh_aov06 = cld(dbh_aov06_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov06 #payette greater than 13, gila less than 13

dbh_numeric14 <- dbh_numeric %>% filter(year=="DBH14") %>% 
  mutate(Provenance=as.factor(Provenance))

dbh_aov14 <- lmer(DBH ~ Provenance + (1|BLK), data =dbh_numeric14)
plot(dbh_aov14)
Anova(dbh_aov14, type="3")
dbh_aov14_marg = lsmeans(dbh_aov14, ~ Provenance)

CLD_dbh_aov14 = cld(dbh_aov14_marg,
          alpha=0.05,
          Letters=letters)
CLD_dbh_aov14 #payette greater than 15, gila less than 13

dbh14_letter_df<- as.data.frame(CLD_dbh_aov14) %>% 
  rename(letters = `.group`) %>% 
  mutate(year="DBH14")


prov_dbh_order<- dbh_numeric %>% 
  filter(year=="DBH14") %>% 
  group_by(Provenance) %>% 
  summarise(mean_DBH = mean(DBH, na.rm=T)) %>% 
  arrange(mean_DBH)

dbh_early<- ggplot(dbh_numeric %>% filter(!year=="DBH14"), aes(x=factor(year, levels=c("DBH91","DBH96","DBH06"), labels=c(1991,1996,2006)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_x_discrete(name="Year")

dbh_2014<-ggplot(dbh_numeric14, aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y=DBH, fill=factor(Provenance, levels=provs_bylat$Provenance), group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot(position=position_dodge(width=1))+
  #geom_text(data=dbh14_letter_df, aes(x=factor(year, levels=c("DBH14"), labels=c(2014)), y= 35, label=letters, group=factor(Provenance, levels=provs_bylat$Provenance)), position=position_dodge(width=1), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("DBH (cm)")+
    scale_x_discrete(name="Year")+
  theme_bw()+
  theme(axis.text=element_text(color="black", size=12),
        axis.title=element_text(color="black", size=12))

ggarrange(dbh_early,dbh_2014, nrow=2, common.legend = TRUE)

dbh_aves <- dbh_numeric %>% 
  group_by(Provenance,year) %>% 
  summarise(meanDBH=mean(DBH),se_DBH=sd(DBH)/sqrt(n())) %>% 
  mutate(year= case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996)) %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,1985), meanDBH=NA, se_DBH=NA))

dbh_means_fig <- ggplot(dbh_aves, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meanDBH, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meanDBH-se_DBH, ymax=meanDBH+se_DBH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean DBH (cm)")

dbh_means_fig

##just for 2014
 ggplot(dbh_aves %>% filter(year==2014), aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meanDBH, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meanDBH-se_DBH, ymax=meanDBH+se_DBH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean DBH (cm)")+
  theme(axis.text=element_text(color="black", size=12), axis.title=element_text(color="black", size=12))

##look for outliers
ggplot(dbh_numeric, aes(x=num.yr, y=DBH, col=factor(Provenance, levels=provs_bylat$Provenance), group=Series))+
  geom_line()+
  geom_point()+
    scale_color_manual(values=unname(stepped()), "")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))

##rank provenances for each year

provs_byreg<- provs_bylat %>% 
  mutate(region = c(rep("S",13), rep("N",8)))

dbh_ranks<- dbh_aves %>% 
  dplyr::select(-se_DBH) %>% 
  pivot_wider(names_from=year, values_from=meanDBH) %>% 
  arrange((`1991`)) %>% 
  bind_cols(data.frame(rank91 = seq(1,20,1)))%>% 
  arrange((`1996`)) %>% 
  bind_cols(data.frame(rank96 = seq(1,20,1)))%>% 
  arrange((`2006`)) %>% 
  bind_cols(data.frame(rank06 = seq(1,20,1)))%>% 
  arrange((`2014`)) %>% 
  bind_cols(data.frame(rank14 = seq(1,20,1))) %>% 
  pivot_longer(rank91:rank14, names_to="year", values_to="rank") %>% 
  mutate(year=case_when(year == "rank91" ~ 3,
                        year =="rank96" ~ 4,
                        year=="rank06" ~ 5,
                        year=="rank14" ~ 6)) %>% 
  left_join(provs_byreg)

ggplot(data=dbh_ranks)+
  #geom_point(aes(x=year, y=rank, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  #geom_line(aes(x=year, y=rank, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(alpha = 0.6, aes(x=year, ymin=rank-.5, ymax=rank+.5, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~region)+
  ggtitle("DBH")


```

####PC only models

```{r}
#calculate PCA transfer distances
dbh_numeric_time <- dbh_numeric %>% 
  mutate(year=case_when(year == "DBH06" ~ 2006,
                         year == "DBH14" ~ 2014,
                         year == "DBH91" ~ 1991,
                         year == "DBH96" ~ 1996)) %>% 
  mutate(plant_PC1 = plant_pca_scores$PC1[1], plant_PC2 = plant_pca_scores$PC2[1]) %>% 
  mutate(PC1transfer = PC1 - plant_PC1, PC2transfer = PC2 - plant_PC2) %>% 
  mutate(absPC1transfer = abs(PC1transfer), absPC2transfer = abs(PC2transfer)) %>% 
  mutate(pcadist2d = sqrt(absPC1transfer^2 + absPC2transfer^2))

dbh_numeric_time %>% 
  dplyr::select(c(PC1transfer, PC2transfer, pcadist2d)) %>% 
  cor()

dbh_numeric_time_noG <- dbh_numeric_time %>% filter(!Provenance=="Gila NF")

dbh_numeric_time_noG %>% 
  dplyr::select(c(PC1transfer, PC2transfer, pcadist2d)) %>% 
  cor()

###using year as a random effect

#with Gila
# mod_dbh_pca <- lmer(DBH ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time)
# plot(mod_dbh_pca)
# qqmath(mod_dbh_pca)
# summary(mod_dbh_pca)

#no gila

mod_dbh_pca_noG <- lmer(DBH ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|year), data=dbh_numeric_time_noG)
plot(mod_dbh_pca_noG)
qqmath(mod_dbh_pca_noG)
summary(mod_dbh_pca_noG)
options(na.action="na.fail")
mod_dbh_pca_noG_dredge<- dredge(mod_dbh_pca_noG)
mod_dbh_pca_noG_dredge #null is best


```

####transfer distance
```{r}
plantation_climNA <- prov_vars %>% 
  filter(Provenance=="Plantation") %>% 
  dplyr::select(var,value) %>% 
  rename(plant_value = value) %>% 
  bind_rows(data.frame(var=c("PC1","PC2"), plant_value=c(plant_pca_scores %>% filter(period=="1970s") %>% pull(PC1),plant_pca_scores %>% filter(period=="1970s") %>% pull(PC2)) ))

provenance_climvars <- c(colnames(big_pca_data))

dbh_numeric_time_long <- dbh_numeric_time %>% 
  dplyr::select(c(SORT,LOC,BLK,REP,Provenance,code,Series,year,DBH,all_of(provenance_climvars))) %>% 
  pivot_longer(CMD:monsoonality)

dbh_clim_long_transfer <- dbh_numeric_time_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  bind_rows(dbh_numeric_time[,c("SORT","LOC","BLK","REP","Provenance","code","Series","year","DBH","PC1transfer","PC2transfer","pcadist2d")] %>% 
  pivot_longer(PC1transfer:pcadist2d, names_to="name", values_to="transfer"))

dbh_clim_long_transfer_nog <- dbh_clim_long_transfer %>% filter(!Provenance=="Gila NF")

transfer_vars <- unique(dbh_clim_long_transfer_nog$name)

dbh_mods_transfer<- data.frame()
for(i in 1:length(transfer_vars)){
mod <- lmer(DBH ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(DBH ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_clim_long_transfer_nog %>% filter(name==transfer_vars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

dbh_mods_transfer <- bind_rows(dbh_mods_transfer, data.frame(var=transfer_vars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

dbh_mods_transfer %>% arrange(pvalue_nog) #nothing significant without Gila

#quadratic

dbh_mods_quad<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- lmer(DBH ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(DBH ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_clim_long_transfer %>% filter(name==transfer_vars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

dbh_mods_quad <- bind_rows(dbh_mods_quad, data.frame(var=transfer_vars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

dbh_mods_quad %>% arrange(pvalue2_nog) #nothing significant

hist(dbh_clim_long_transfer_nog %>% filter(name=="PC1transfer") %>% pull(transfer))
hist(dbh_clim_long_transfer_nog %>% filter(name=="PC2transfer") %>% pull(transfer))

```

###relativized growth rate
  
```{r}
# ##relativize by previous year's BA
dbh_growth_data_rel<- dbh %>%
  mutate(relareagrowth96=((pi*(DBH96/2)^2)-(pi*(DBH91/2)^2))/(pi*(DBH91/2)^2)*100/5, relareagrowth06=((pi*(DBH06/2)^2)- (pi*(DBH96/2)^2))/(pi*(DBH96/2)^2)*100/10, relareagrowth14=((pi*(DBH14/2)^2)- (pi*(DBH06/2)^2))/(pi*(DBH06/2)^2)*100/8) %>%
  mutate(relareagrowth96=case_when(DBH96 == 0 ~ NA,
                         is.na(DBH96) ~ NA,
                         .default=relareagrowth96),
         relareagrowth06=case_when(DBH06 == 0 ~ NA,
                         is.na(DBH06) ~ NA,
                         .default=relareagrowth06),
         relareagrowth14=case_when(DBH14 == 0 ~ NA,
                         is.na(DBH14) ~ NA,
                         .default=relareagrowth14)) %>%
  pivot_longer(relareagrowth96:relareagrowth14) %>%
  filter(!value<0) %>%  ##gets rid of the one measurement error that resulted in a large negative growth (tree 707-56-I from Dixie NF)
  filter(!is.infinite(value)) %>% ##gets rid of the 3 values that were infinite because dbh was recorded as 0 instead of NA in 2006.
  left_join(prov_pcapts_big) %>% 
  rename(relgrowth=value, year=name)

```


```{r}
#another visual
dbh_growth_data_rel

dbh_growth_data_rel_forplot<- dbh_growth_data_rel %>% dplyr::select(Provenance, year, relgrowth) %>% 
  group_by(Provenance, year) %>% 
  summarise(meanrelgrowth=mean(relgrowth)) %>% 
    mutate(year= ifelse(year %in% c("relareagrowth96"), as.numeric(paste0("19",substr(year, 14,15))), as.numeric(paste0("20",substr(year, 14,15)))))

ggplot()+
  geom_bar(data=dbh_growth_data_rel_forplot, aes(x=year, y=meanrelgrowth/10, fill = factor(Provenance, levels=provs_bylat$Provenance)), stat="identity")+
  geom_point(data=dbh_aves, aes(x=year, y=meanDBH), col="black", size=2)+
  geom_line(data=dbh_aves, aes(x=year, y=meanDBH), col="black")+
  scale_y_continuous(name = "DBH (cm)",sec.axis = sec_axis( transform=~.*10, name="Relative Basal Area Growth Rate (%/yr)")) +
  scale_x_continuous(breaks=c(1991,1996,2006,2014))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=45, hjust=1))

```

####ANOVA
```{r}
###analyze basal area growth data
aov_DBHrel <- lmer(relgrowth ~ year*Provenance + (1|BLK), data=dbh_growth_data_rel)
plot(aov_DBHrel)
qqmath(aov_DBHrel)
anova(aov_DBHrel) ##basal area growth differs by provenance and year, and has significant interaction
```


####PC only models

```{r}
#calculate PCA transfer distances

dbh_growth_rel_clim <- dbh_growth_data_rel %>% 
  left_join(prov_pcapts_big) %>% 
  mutate(plant_PC1 = plant_pca_scores$PC1[1], plant_PC2 = plant_pca_scores$PC2[1]) %>% 
  mutate(PC1transfer = PC1 - plant_PC1, PC2transfer = PC2 - plant_PC2) %>% 
  mutate(absPC1transfer = abs(PC1transfer), absPC2transfer = abs(PC2transfer)) %>% 
  mutate(pcadist2d = sqrt(absPC1transfer^2 + absPC2transfer^2)) 

dbh_growth_rel_clim_noG <- dbh_growth_rel_clim %>% 
  filter(!Provenance=="Gila NF")

###using year as a random effect

#with Gila
mod_relgrowth_pca <- lmer(sqrt(relgrowth) ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_rel_clim)
plot(mod_relgrowth_pca)
qqmath(mod_relgrowth_pca)
summary(mod_relgrowth_pca) #PC2transfer^2 significant

#no gila

mod_relgrowth_pca_nog <- lmer(relgrowth ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|year), data=dbh_growth_rel_clim_noG)
plot(mod_relgrowth_pca_nog)
qqmath(mod_relgrowth_pca_nog)
summary(mod_relgrowth_pca_nog)
options(na.action="na.fail")
mod_relgrowth_pca_noG_dredge<- dredge(mod_relgrowth_pca_nog)
mod_relgrowth_pca_noG_dredge #null is best


```


####transfer distance
```{r}
dbh_relgrowth_clim_long <- dbh_growth_rel_clim %>% 
  dplyr::select(c(SORT,LOC,BLK,REP,Provenance,code,Series,year,relgrowth,all_of(provenance_climvars))) %>% 
  pivot_longer(CMD:monsoonality)

dbh_relgrowth_clim_long_transfer <- dbh_relgrowth_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  bind_rows(dbh_growth_rel_clim[,c("SORT","LOC","BLK","REP","Provenance","code","Series","year","relgrowth","PC1transfer","PC2transfer","pcadist2d")] %>% 
  pivot_longer(PC1transfer:pcadist2d, names_to="name", values_to="transfer"))

dbh_relgrowth_clim_long_transfer_nog <- dbh_relgrowth_clim_long_transfer %>% filter(!Provenance=="Gila NF")

transfer_vars <- unique(dbh_relgrowth_clim_long_transfer_nog$name)

relgrowth_mods_transfer<- data.frame()
for(i in 1:length(transfer_vars)){
mod <- lmer(relgrowth ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(relgrowth ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name==transfer_vars[i]) %>% filter(!Provenance=="Gila NF"))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

relgrowth_mods_transfer <- bind_rows(relgrowth_mods_transfer, data.frame(var=transfer_vars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

relgrowth_mods_transfer %>% arrange(pvalue_nog) #nothing significant without Gila

#quadratic

relgrowth_mods_transfer_quad<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- lmer(relgrowth ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(relgrowth ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=dbh_relgrowth_clim_long_transfer_nog %>% filter(name==transfer_vars[i]) %>% filter(!Provenance=="Gila NF"))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

relgrowth_mods_transfer_quad <- bind_rows(relgrowth_mods_transfer_quad, data.frame(var=transfer_vars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

relgrowth_mods_transfer_quad %>% arrange(pvalue2_nog) #nothing significant

```

##Height 

```{r}

ht_data <- moniger_data_comb %>% 
  filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  filter(!is.na(value))

ht_data_clim <- ht_data %>% 
  left_join(prov_pcapts_big)

ht.order <- ht_data %>% 
  filter(name=="HT14") %>% 
  group_by(Provenance) %>% 
  summarise(meanht = mean(value, na.rm=T)) %>% 
  arrange(meanht)

ht_data_aves <- ht_data %>% filter(!name=="HT74") %>% 
  group_by(name, Provenance,nursery_ht_m ) %>% 
  summarise(meantotht = mean(value), seTH = sd(value)/sqrt(n()))

```

```{r}
#visualize
ht_matrix<- ht_data %>% 
  group_by(Provenance, name) %>% 
  summarise(meanht=mean(value, na.rm=T)) %>% 
  pivot_wider(names_from="name", values_from="meanht") %>%
  left_join(ht_data %>% dplyr::select(Provenance, nursery_ht_m) %>% unique()) %>% 
  dplyr::select(c(Provenance, nursery_ht_m, HT74, HT79, HT85, HT91, HT96, HT06, HT14)) %>% 
  column_to_rownames(var="Provenance") %>% 
  as.matrix()

heatmap(ht_matrix, scale="column", Colv=NA)
```

```{r}
ht_data_year <-  ht_data %>% mutate(year=case_when(
  name=="HT74" ~ 1974,
  name == "HT79" ~ 1979,
  name == "HT85" ~ 1985,
  name == "HT91" ~ 1991,
  name == "HT96" ~ 1996,
  name == "HT06" ~ 2006,
  name == "HT14" ~ 2014))
```

###nursery height

####PC only mods
```{r}

nursery_ht_clim <- ht_data_clim %>% 
  dplyr::select(c(Provenance, nursery_ht_m, PC1,PC2, all_of(provenance_climvars))) %>% 
  unique()

nursery_ht_clim_nog <- nursery_ht_clim %>% filter(!Provenance=="Gila NF")

nursery_ht_clim_long <- nursery_ht_clim %>% 
  pivot_longer(PC1:monsoonality)

nursery_ht_clim_long_nog <- nursery_ht_clim_long %>% filter(!Provenance=="Gila NF")

#with Gila
mod_nursery_pca <- lm(nursery_ht_m ~ PC1*PC2 + I(PC1^2) + I(PC2^2), data=nursery_ht_clim)
par(mfrow=c(2,2))
plot(mod_nursery_pca)
summary(mod_nursery_pca) #PC1^2 significant

#no gila

mod_nursery_pca_nog <- lm(nursery_ht_m ~ PC1*PC2 + I(PC1^2) + I(PC2^2), data=nursery_ht_clim_nog)
plot(mod_nursery_pca_nog)
summary(mod_nursery_pca_nog) #nothing significant
options(na.action="na.fail")
mod_nursery_pca_nog_dredge<- dredge(mod_nursery_pca_nog)
mod_nursery_pca_nog_dredge #null is best
```


####transfer distance
```{r}

nursery_mods<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lm(nursery_ht_m ~ value, data=nursery_ht_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Ar2 <- r2(mod)$R2_adjusted

mod_nog <- lm(nursery_ht_m ~ value, data=nursery_ht_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Ar2_nog <- r2(mod_nog)$R2_adjusted

nursery_mods <- bind_rows(nursery_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Ar2=Ar2, pvalue_nog = pvalue_nog, Ar2_nog=Ar2_nog))

}

nursery_mods %>% arrange(pvalue_nog) #smrpb significant

#smrpb
nursery_smrpb_mod_nog <- lm(nursery_ht_m ~ value, data=nursery_ht_clim_long_nog %>% filter(name=="smrpb"))
par(mfrow=c(2,2))
plot(nursery_smrpb_mod_nog)
summary(nursery_smrpb_mod_nog)


#quadratic

nursery_mods_quad<- data.frame()

for(i in 1:length(provenance_climvars)){
mod <- lm(nursery_ht_m ~ value + I(value^2), data=nursery_ht_clim_long %>% filter(name==provenance_climvars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
ar2 <- performance::r2(mod)$R2_adjusted
 
mod_nog <- lm(nursery_ht_m ~ value + I(value^2), data=nursery_ht_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
ar2_nog <- performance::r2(mod_nog)$R2_adjusted

nursery_mods_quad <- bind_rows(nursery_mods_quad, data.frame(var=provenance_climvars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], ar2 = ar2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], ar2_nog = ar2_nog))
}

nursery_mods_quad %>% arrange(pvalue2_nog) #nothing significant

ggplot(data=nursery_ht_clim_long %>% filter(name=="smrpb" & !Provenance=="Gila NF"), aes(x=value, y=nursery_ht_m))+
  geom_point(aes(col=Provenance), size=3)+
  geom_smooth(method="lm", color="black")+
  scale_color_manual(values=unname(stepped())[-1])+
  theme_bw()+
  xlab("Summer Precip Ratio")+
  ylab("Nursery Height (m)")

```

####effect on absolute ht
```{r}
##effect of initial nursery height

#1974
nurse_ht_mod74 <- lmer(value ~ nursery_ht_m + (1|Provenance) + (1|BLK), data=ht_data %>% filter(name=="HT74") %>% filter(!Provenance=="Gila NF"))
plot(nurse_ht_mod74)
qqmath(nurse_ht_mod74)
summary(nurse_ht_mod74)  ##significant 
str(summary(nurse_ht_mod74))

stats74 <- as.data.frame(summary(nurse_ht_mod74)$coefficients)[2,] %>% 
  mutate(year=1974)

ggplot(data=ht_data %>% filter(!Provenance=="Gila NF"), aes(x=nursery_ht_m, y=value))+
  geom_smooth(method="lm")+
  facet_wrap(~name)

#1979
nurse_ht_mod79 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT79") %>% filter(!Provenance=="Gila NF"))
qqmath(nurse_ht_mod79)
summary(nurse_ht_mod79)  ###there is an effect when Gila is removed
r2(nurse_ht_mod79) ##marginal r2 is very low

stats79 <- as.data.frame(summary(nurse_ht_mod79)$coefficients)[2,] %>% 
  mutate(year=1979)

#1985
nurse_ht_mod85 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT85") %>% filter(!Provenance=="Gila NF"))
qqmath(nurse_ht_mod85)
summary(nurse_ht_mod85)  ###there is an effect when Gila is removed
r2(nurse_ht_mod85) ##marginal r2 is very low

stats85 <- as.data.frame(summary(nurse_ht_mod85)$coefficients)[2,] %>% 
  mutate(year=1985)

#1991
nurse_ht_mod91 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT91") %>% filter(!Provenance=="Gila NF"))
qqmath(nurse_ht_mod91)
summary(nurse_ht_mod91)  ###there is an effect when Gila is removed
r2(nurse_ht_mod91) ##marginal r2 is very low

stats91 <- as.data.frame(summary(nurse_ht_mod91)$coefficients)[2,] %>% 
  mutate(year=1991)

#1996
nurse_ht_mod96 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT96") %>% filter(!Provenance=="Gila NF"))
qqmath(nurse_ht_mod96)
summary(nurse_ht_mod96)  ###there is an effect when Gila is removed
r2(nurse_ht_mod96) ##marginal r2 is very low

stats96 <- as.data.frame(summary(nurse_ht_mod96)$coefficients)[2,] %>% 
  mutate(year=1996)

#2006
nurse_ht_mod06 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT06") %>% filter(!Provenance=="Gila NF"))
qqmath(nurse_ht_mod06)
summary(nurse_ht_mod06)  ###there is an effect when Gila is removed
r2(nurse_ht_mod06) ##marginal r2 is very low

stats06 <- as.data.frame(summary(nurse_ht_mod06)$coefficients)[2,] %>% 
  mutate(year=2006)

#2014
nurse_ht_mod14 <- lmer(value ~ nursery_ht_m + (1|Provenance)+ (1|BLK), data=ht_data %>% filter(name=="HT14") %>% filter(!Provenance=="Gila NF"))
qqmath(nurse_ht_mod14)
summary(nurse_ht_mod14)  ###marginal effect 
r2(nurse_ht_mod14) ##marginal r2 is very low

stats14 <- as.data.frame(summary(nurse_ht_mod14)$coefficients)[2,] %>% 
  mutate(year=2014)

nursery_stats <- bind_rows(stats74, stats79, stats85, stats91, stats96, stats06, stats14) %>% 
left_join(ht_data_year %>% group_by(year) %>% 
  summarise(max=max(value))) %>%
  mutate(x=0.13) %>% 
  rename(p = `Pr(>|t|)`)

ggplot()+
  geom_text(data=nursery_stats, aes(x=x, y=max, label=paste0("p = ", round(p,2))), size=4)+
  geom_point(data=ht_data_year %>% filter(!Provenance=="Gila NF"), aes(x=nursery_ht_m, y=value), col="grey30")+
  geom_smooth(data=ht_data_year %>% filter(!Provenance=="Gila NF"), aes(x=nursery_ht_m, y=value), method="lm", col="red", fill="red")+
  theme_bw()+
  facet_wrap(~year, scales="free_y")+
  ylab("Height (m)")+
  xlab("Nursery Height(m)") ##put stats in this table



```

###absolute height

#### ANOVA
```{r}
##effect of year * provenance
totht_mod <- lmer(log(value) ~ Provenance*year + (1|BLK), data=ht_data_year)
plot(totht_mod)
qqmath(totht_mod)
Anova(totht_mod, type="3") ##there is a significant year by provenance interaction

#no gila
totht_mod_nog <- lmer(log(value) ~ Provenance*year + (1|BLK), data=ht_data_year %>% filter(!Provenance=="Gila NF"))
plot(totht_mod_nog)
qqmath(totht_mod_nog)
Anova(totht_mod_nog, type="3") ##there is a significant year by provenance interaction
####

ggplot()+
  geom_line(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  geom_errorbar(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), ymin=meantotht-seTH, ymax=meantotht+seTH, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)),width=0.2)+
  geom_point(data=ht_data_aves, aes(x=factor(name, levels=c("HT79","HT85","HT91","HT96","HT06","HT14")), y=meantotht, col=factor(Provenance, levels=ht.order$Provenance),group=factor(Provenance, levels=ht.order$Provenance)))+
  scale_color_discrete(name="Provenance")+
  scale_x_discrete(name="Year")+
  ylab("Total Height (m)")

ht_data_aves_forfig <- ht_data_aves %>% 
  bind_rows(data.frame(name="HT74",Provenance="Gila NF", meantotht=NA, seTH=NA))

ht_means_fig <- ggplot(ht_data_aves_forfig, aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meantotht, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meantotht-seTH, ymax=meantotht+seTH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean Height (m)")

##just 2014
ggplot(ht_data_aves_forfig %>% filter(name=="HT14"), aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=meantotht, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_errorbar(aes(x=factor(name,levels=c("HT74","HT79","HT85","HT91","HT96","HT06","HT14"), labels=c(1974,1979,1985,1991,1996,2006,2014)),ymin=meantotht-seTH, ymax=meantotht+seTH, group=factor(Provenance, levels=provs_bylat$Provenance)),position = position_dodge(width=0.8), width=0.2)+
  geom_point(size=3, position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Mean Height (m)")+
  theme_bw()+
  theme(axis.text=element_text(color="black", size=12), axis.title=element_text(color="black", size=12))
#######
#each year separately
totht_mod74 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT74"))
plot(totht_mod74)
qqmath(totht_mod74)
anova(totht_mod74)
rand(totht_mod74)
totht_mod74_marg = lsmeans(totht_mod74, ~ Provenance)

CLD_totht_mod74 = cld(totht_mod74_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod74

totht_mod79 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT79"))
plot(totht_mod79)
qqmath(totht_mod79)
anova(totht_mod79)
rand(totht_mod79)
totht_mod79_marg = lsmeans(totht_mod79, ~ Provenance)

CLD_totht_mod79 = cld(totht_mod79_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod79

totht_mod85 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT85"))
plot(totht_mod85)
qqmath(totht_mod85)
anova(totht_mod85)
rand(totht_mod85)
totht_mod85_marg = lsmeans(totht_mod85, ~ Provenance)

CLD_totht_mod85 = cld(totht_mod85_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod85

totht_mod91 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT91"))
plot(totht_mod91)
qqmath(totht_mod91)
anova(totht_mod91)
rand(totht_mod91)
totht_mod91_marg = lsmeans(totht_mod91, ~ Provenance)

CLD_totht_mod91 = cld(totht_mod91_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod91

totht_mod96 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT96"))
plot(totht_mod96)
qqmath(totht_mod96)
anova(totht_mod96)
rand(totht_mod96)
totht_mod96_marg = lsmeans(totht_mod96, ~ Provenance)

CLD_totht_mod96 = cld(totht_mod96_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod96

totht_mod06 <- lmer(value ~ Provenance + (1|BLK), data= ht_data %>% filter(name=="HT06"))
plot(totht_mod06)
qqmath(totht_mod06)
anova(totht_mod06)
rand(totht_mod06)
totht_mod06_marg = lsmeans(totht_mod06, ~ Provenance)

CLD_totht_mod06 = cld(totht_mod06_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod06

ht_data14<- ht_data %>% filter(name=="HT14") %>% 
  mutate(Provenance=as.factor(Provenance))

totht_mod14 <- lmer(value ~ Provenance + (1|BLK), data=ht_data14)
plot(totht_mod14)
qqmath(totht_mod14)
Anova(totht_mod14, type="3")
rand(totht_mod14)
totht_mod14_marg = lsmeans(totht_mod14, ~ Provenance)

CLD_totht_mod14 = cld(totht_mod14_marg,
          alpha=0.05,
          Letters=letters)
CLD_totht_mod14

totht14_letter_df<- as.data.frame(CLD_totht_mod14) %>% 
  rename(letters = `.group`)
#########

###2014 plot
prov_ht_order14<- ht_data14 %>% 
  group_by(Provenance) %>% 
  summarise(mean_ht = mean(value, na.rm=T)) %>% 
  arrange(mean_ht)

ht_letters_plot<- ggplot(ht_data14, aes(x=factor(Provenance, levels=prov_ht_order14$Provenance), y=value, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  geom_text(data=totht14_letter_df, aes(x=Provenance, y= 17, label=letters), size=5, angle=45, hjust=1)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  theme_bw()+
  ylab("Height (m)")+
  theme(axis.text.x=element_text(angle=45, hjust=1, color="black",size=14), axis.text.y=element_text(color="black",size=14),axis.title.y=element_text(color="black",size=14), axis.title.x=element_blank(), legend.position = "none")
  
ht_letters_plot

###rank them
ht_ranks<- ht_data_aves_forfig %>% 
  filter(!is.na(nursery_ht_m)) %>% 
  dplyr::select(-c("seTH")) %>% 
  pivot_wider(names_from=name, values_from=meantotht) %>% 
  arrange(nursery_ht_m) %>% 
  bind_cols(data.frame(rank0 = seq(1,20,1)))%>% 
  arrange(HT79) %>% 
  bind_cols(data.frame(rank79 = seq(1,20,1)))%>% 
  arrange(HT85) %>% 
  bind_cols(data.frame(rank85 = seq(1,20,1)))%>% 
  arrange(HT91) %>% 
  bind_cols(data.frame(rank91 = seq(1,20,1)))%>% 
  arrange(HT96) %>% 
  bind_cols(data.frame(rank96 = seq(1,20,1)))%>% 
  arrange(HT06) %>% 
  bind_cols(data.frame(rank06 = seq(1,20,1)))%>% 
  arrange(HT14) %>% 
  bind_cols(data.frame(rank14 = seq(1,20,1))) %>% 
  pivot_longer(rank0:rank14, names_to="year", values_to="rank") %>% 
  mutate(year=case_when(year=="rank0" ~ 0,
                        year == "rank79" ~ 1,
                        year =="rank85" ~ 2,
                        year=="rank91" ~ 3,
                        year =="rank96" ~ 4,
                        year=="rank06" ~ 5,
                        year=="rank14" ~ 6)) %>% 
  left_join(provs_byreg)

ggplot(data=ht_ranks)+
  #geom_point(aes(x=year, y=rank, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  #geom_line(aes(x=year, y=rank, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_ribbon(alpha = 0.7, aes(x=year, ymin=rank-.5, ymax=rank+.5, fill=factor(Provenance, levels=provs_bylat$Provenance)))+
  scale_color_manual(values=unname(stepped()))+
  scale_fill_manual(values=unname(stepped()))+
  facet_wrap(~region)+
  ggtitle("Height")+
  theme_bw()

##add absolute DBH
dbh_ht_ranks<- dbh_ranks %>% 
  mutate(trait="DBH") %>% 
  bind_rows(ht_ranks %>% mutate(trait="Height"))

ht0_rank <- dbh_ht_ranks %>% 
  filter(year==0 & trait=="Height") %>% 
  ungroup() %>% 
  dplyr::select(code,rank, trait) %>% 
  rename(rank_0 = rank) 
ht6_rank <- dbh_ht_ranks %>% 
  filter(year==6 & trait=="Height") %>% 
    ungroup() %>% 
  dplyr::select(code,rank, trait) %>% 
  rename(rank_6 = rank)
dbh0_rank <- dbh_ht_ranks %>% 
  filter(year==3 & trait=="DBH") %>% 
  ungroup() %>% 
  dplyr::select(code,rank, trait) %>% 
  rename(rank_0 = rank)
dbh6_rank <- dbh_ht_ranks %>% 
  filter(year==6 & trait=="DBH") %>% 
    ungroup() %>% 
  dplyr::select(code,rank,trait) %>% 
  rename(rank_6 = rank)

rank_labels<- left_join(ht0_rank, ht6_rank) %>% 
  bind_rows(left_join(dbh0_rank,dbh6_rank)) %>% 
  mutate(x1 = ifelse(trait=="DBH",2,-2), 
         x2 = ifelse(trait=="DBH", 7, 8))

ggplot()+
  #geom_point(aes(x=year, y=rank, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  #geom_line(aes(x=year, y=rank, col=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_text(data=rank_labels, aes(x = x1, y=rank_0, label=code), hjust=0)+
  geom_text(data=rank_labels, aes(x = x2, y=rank_6, label=code), hjust=1)+
  geom_ribbon(data=dbh_ht_ranks, alpha = 0.7, aes(x=year, ymin=rank-.5, ymax=rank+.5, fill=factor(Provenance, levels=provs_bylat$Provenance, labels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("Rank")+
  xlab("Year")+
  facet_grid(~trait, scales = "free_x")+
  theme_bw()

```

####PC only models

```{r}
#calculate PCA transfer distances
ht_data_year_clim <- ht_data_year %>% 
  left_join(prov_pcapts_big) %>% 
  rename(ht=value) %>% 
  mutate(plant_PC1 = plant_pca_scores$PC1[1], plant_PC2 = plant_pca_scores$PC2[1]) %>% 
  mutate(PC1transfer = PC1 - plant_PC1, PC2transfer = PC2 - plant_PC2) %>% 
  mutate(absPC1transfer = abs(PC1transfer), absPC2transfer = abs(PC2transfer)) %>% 
  mutate(pcadist2d = sqrt(absPC1transfer^2 + absPC2transfer^2))

ht_data_year_clim_noG <- ht_data_year_clim %>% 
  filter(!Provenance=="Gila NF")

ht_data_year_clim %>% 
  dplyr::select(c(PC1transfer, PC2transfer, pcadist2d)) %>% 
  cor()

ht_data_year_clim_noG %>% 
  dplyr::select(c(PC1transfer, PC2transfer, pcadist2d)) %>% 
  cor()

###using year as a random effect

#no gila

mod_ht_pca_noG <- lmer(log(ht) ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_noG)
plot(mod_ht_pca_noG)
qqmath(mod_ht_pca_noG)
summary(mod_ht_pca_noG) #nothing significant
options(na.action="na.fail")
mod_ht_pca_noG_dredge<- dredge(mod_ht_pca_noG)
mod_ht_pca_noG_dredge #null is best
```

####transfer distance

```{r}

ht_data_year_clim_long <- ht_data_year_clim %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,nursery_ht_m,year,ht,all_of(provenance_climvars))) %>% 
  pivot_longer(CMD:monsoonality)

ht_data_year_clim_long_transfer <- ht_data_year_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  bind_rows(ht_data_year_clim[,c("LOC","BLK","REP","Provenance","nursery_ht_m","year","ht","PC1transfer","PC2transfer","pcadist2d")] %>% 
  pivot_longer(PC1transfer:pcadist2d, names_to="name", values_to="transfer"))

ht_data_year_clim_long_transfer_nog <- ht_data_year_clim_long_transfer %>% filter(!Provenance=="Gila NF")

ht_mods_transfer<- data.frame()
for(i in 1:length(transfer_vars)){
mod <- lmer(log(ht) ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=ht_data_year_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(ht) ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=ht_data_year_clim_long_transfer_nog %>% filter(name==transfer_vars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

ht_mods_transfer <- bind_rows(ht_mods_transfer, data.frame(var=transfer_vars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

ht_mods_transfer %>% arrange(pvalue_nog) #nothing significant without Gila

#quadratic

ht_mods_quad<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- lmer(log(ht) ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(log(ht) ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_data_year_clim_long_transfer_nog %>% filter(name==transfer_vars[i])) 
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

ht_mods_quad <- bind_rows(ht_mods_quad, data.frame(var=transfer_vars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

ht_mods_quad %>% arrange(pvalue2_nog) #nothing significant
```

###relative height growth

```{r}
#relative growth

ht_growth_rel_data<- moniger_data_comb %>% 
    filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  mutate(growth79=HT79-HT74, growth85 = HT85-HT79, growth91 = HT91-HT85, growth96=HT96-HT91, growth06=HT06-HT96, growth14=HT14-HT06) %>% 
  mutate(growth79rel=(growth79/HT74*100)/5, growth85rel=(growth85/HT79*100)/6, growth91rel=(growth91/HT85*100)/6, growth96rel=(growth96/HT91*100)/5, growth06rel=(growth06/HT96*100)/10, growth14rel=(growth14/HT06*100)/8) %>% 
  pivot_longer(growth79rel:growth14rel) %>% 
  mutate(nursery_ht_m = Seedling.Ht..from.Nursery/39.37) %>% 
  filter(!is.na(value))

ht_increment_rel_plot<- ggplot(ht_growth_rel_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")
ht_increment_rel_plot

##who had overall highest relative growth rates across years?
ggplot(ht_growth_rel_data, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##look at trend in relative height growth rate over time for trees that survived until 2014
ggplot(ht_growth_rel_data %>% filter(!is.na(HT14)), aes(x=factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel"), labels=c("1974-79","1979-85","1985-91","1991-96","1996-2006","2006-14")), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(Provenance,levels=provs_bylat$Provenance))+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relative Height Growth Per Year (%)")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")

##look at trend over time for each provenance
relhtgrowth_time<- ht_growth_rel_data %>% 
  mutate(period = case_when(name=="growth79rel" ~ 1,
                            name=="growth85rel" ~ 2,
                            name=="growth91rel" ~ 3,
                            name=="growth96rel" ~ 4,
                            name=="growth06rel" ~ 5,
                            name=="growth14rel" ~ 6))

relht_overtime <- lmer(value ~ period*Provenance + (1|BLK), data=relhtgrowth_time)
plot(relht_overtime)
qqmath(relht_overtime)
summary(relht_overtime)
anova(relht_overtime)

gila_relht_mod <- lmer(value ~ period + (1|BLK), data=relhtgrowth_time %>% filter(Provenance=="Gila NF"))
summary(gila_relht_mod) #no trend over time in relative growth for Gila
```

```{r}
#another visual
ht_growth_rel_data_forplot<- ht_growth_rel_data %>% dplyr::select(Provenance, name, value) %>% 
    mutate(year= ifelse(name %in% c("growth79rel","growth85rel","growth91rel","growth96rel"), as.numeric(paste0("19",substr(name, 7,8))), as.numeric(paste0("20",substr(name, 7,8))))) %>% 
  group_by(Provenance, year, name) %>% 
  summarise(meangrowth=mean(value))

ggplot()+
  geom_bar(data=ht_growth_rel_data_forplot, aes(x=year, y=meangrowth/5, fill = factor(Provenance, levels=provs_bylat$Provenance)), stat="identity")+
  geom_point(data=ht_3meas, aes(x=year, y=meanht), col="black", size=2)+
  geom_line(data=ht_3meas, aes(x=year, y=meanht), col="black")+
  #geom_boxplot(data=height_growth_forplot, aes(x=year, y=value*10, fill=factor(Provenance, levels=provs_bylat$Provenance), group=year), outliers=FALSE)+
  scale_y_continuous(name = "Height (m)",sec.axis = sec_axis( transform=~.*5, name="Relative Height Growth Rate (%/yr)")) +
  scale_x_continuous(breaks=c(1970,1974,1979,1985,1991,1996,2006,2014))+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=45, hjust=1))


dbh_growth_data_rel_forplot

ht_growth_rel_data_forplot
ggplot()+
  geom_point(data=dbh_growth_data_rel_forplot, aes(x=year, y=meanrelgrowth), col="gray50")+
  geom_line(data=dbh_growth_data_rel_forplot, aes(x=year, y=meanrelgrowth), col="gray50")+
  geom_point(data=ht_growth_rel_data_forplot, aes(x=year, y=meangrowth), col="black")+
  geom_line(data=ht_growth_rel_data_forplot, aes(x=year, y=meangrowth), lty=2, col="black")+
  facet_wrap(~Provenance)

```

####ANOVA
```{r}
relhg <- lmer(value ~ Provenance*name + (1|BLK), data=ht_growth_rel_data)
plot(relhg)
qqmath(relhg)
anova(relhg)

###differences between provenances in height increment each year
##1979
HGmod79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth79rel"))
plot(HGmod79)
qqmath(HGmod79)
anova(HGmod79)
rand(HGmod79)
HGmod79_marg = lsmeans(HGmod79, ~Provenance)

CLD_HGmod79 = cld(HGmod79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod79

##1985
HGmod85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth85rel"))
plot(HGmod85)
qqmath(HGmod85)
anova(HGmod85)
rand(HGmod85)
HGmod85_marg = lsmeans(HGmod85, ~Provenance)

CLD_HGmod85 = cld(HGmod85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod85

##1991
HGmod91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth91rel"))
plot(HGmod91)
qqmath(HGmod91)
anova(HGmod91)
rand(HGmod91)
HGmod91_marg = lsmeans(HGmod91, ~Provenance)

CLD_HGmod91 = cld(HGmod91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod91

##1996
HGmod96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth96rel"))
plot(HGmod96)
qqmath(HGmod96)
anova(HGmod96) ##1996 not significantly different between provenances
rand(HGmod96)
HGmod96_marg = lsmeans(HGmod96, ~Provenance)

CLD_HGmod96 = cld(HGmod96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod96 ##Gila no longer in last place by 1996

##2006
HGmod06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth06rel"))
plot(HGmod06)
qqmath(HGmod06)
anova(HGmod06)
rand(HGmod06)
HGmod06_marg = lsmeans(HGmod06, ~Provenance)

CLD_HGmod06 = cld(HGmod06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod06 

##2014
HGmod14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(name=="growth14rel"))
plot(HGmod14)
qqmath(HGmod14)
anova(HGmod14)
rand(HGmod14)
HGmod14_marg = lsmeans(HGmod14, ~Provenance)

CLD_HGmod14 = cld(HGmod14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod14
```

#####survivors only

```{r}

relhg_SO <- lmer(value ~ Provenance*name + (1|BLK), data=ht_growth_rel_data %>% filter(!is.na(HT14)))
anova(relhg_SO)

##########################

ht_increment_rel_plot_survivorsonly<- ggplot(ht_growth_rel_data %>% filter(!is.na(HT14)), aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=value, fill=factor(Provenance,levels=provs_bylat$Provenance)))+
  geom_boxplot()+
  facet_wrap(~factor(name, levels=c("growth79rel","growth85rel","growth91rel","growth96rel","growth06rel","growth14rel")), scales="free")+
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  ylab("Relativized Height Increment")+ xlab("")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")


ht_increment_rel_plot
ht_increment_rel_plot_survivorsonly

###differences between provenances in height increment each year ***SURVIVORS ONLY***
##1979
HGmod_SO_79<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth79rel"))
plot(HGmod_SO_79)
qqmath(HGmod_SO_79)
anova(HGmod_SO_79)
rand(HGmod_SO_79)
HGmod_SO_79_marg = lsmeans(HGmod_SO_79, ~Provenance)

CLD_HGmod_SO_79 = cld(HGmod_SO_79_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_79

##1985
HGmod_SO_85<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth85rel"))
plot(HGmod_SO_85)
qqmath(HGmod_SO_85)
anova(HGmod_SO_85)
rand(HGmod_SO_85)
HGmod_SO_85_marg = lsmeans(HGmod_SO_85, ~Provenance)

CLD_HGmod_SO_85 = cld(HGmod_SO_85_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_85

##1991
HGmod_SO_91<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth91rel"))
plot(HGmod_SO_91)
qqmath(HGmod_SO_91)
anova(HGmod_SO_91)
rand(HGmod_SO_91)
HGmod_SO_91_marg = lsmeans(HGmod_SO_91, ~Provenance)

CLD_HGmod_SO_91 = cld(HGmod_SO_91_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_91

##1996
HGmod_SO_96<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth96rel"))
plot(HGmod_SO_96)
qqmath(HGmod_SO_96)
anova(HGmod_SO_96)
rand(HGmod_SO_96)
HGmod_SO_96_marg = lsmeans(HGmod_SO_96, ~Provenance)

CLD_HGmod_SO_96 = cld(HGmod_SO_96_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_96

##2006
HGmod_SO_06<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth06rel"))
plot(HGmod_SO_06)
qqmath(HGmod_SO_06)
anova(HGmod_SO_06)
rand(HGmod_SO_06)
HGmod_SO_06_marg = lsmeans(HGmod_SO_06, ~Provenance)

CLD_HGmod_SO_06 = cld(HGmod_SO_06_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_06 

##2014
HGmod_SO_14<- lmer(value ~ Provenance + (1|BLK), data = ht_growth_rel_data %>% filter(!is.na(HT14)) %>% filter(name=="growth14rel"))
plot(HGmod_SO_14)
qqmath(HGmod_SO_14)
anova(HGmod_SO_14)
rand(HGmod_SO_14)
HGmod_SO_14_marg = lsmeans(HGmod_SO_14, ~Provenance)

CLD_HGmod_SO_14 = cld(HGmod_SO_14_marg,
                  alpha=0.05,
                  Letters=letters)
CLD_HGmod_SO_14
```

####PC only mods
```{r}

#calculate PCA transfer distances
ht_growth_rel_clim<- ht_growth_rel_data %>% 
  left_join(prov_pcapts_big) %>% 
  rename(relhtgrowth=value) %>% 
  mutate(plant_PC1 = plant_pca_scores$PC1[1], plant_PC2 = plant_pca_scores$PC2[1]) %>% 
  mutate(PC1transfer = PC1 - plant_PC1, PC2transfer = PC2 - plant_PC2) %>% 
  mutate(absPC1transfer = abs(PC1transfer), absPC2transfer = abs(PC2transfer)) %>% 
  mutate(pcadist2d = sqrt(absPC1transfer^2 + absPC2transfer^2))

ht_growth_rel_clim_noG <- ht_growth_rel_clim %>% 
  filter(!Provenance=="Gila NF")

###using year as a random effect

#with Gila
mod_relhtgrowth_pca <- lmer(relhtgrowth ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim)
plot(mod_relhtgrowth_pca)
qqmath(mod_relhtgrowth_pca)
summary(mod_relhtgrowth_pca) #PC2transfer^2 significant with Gila

#no gila

mod_relhtgrowth_pca_noG <- lmer(relhtgrowth ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|name), data=ht_growth_rel_clim_noG)
plot(mod_relhtgrowth_pca_noG)
qqmath(mod_relhtgrowth_pca_noG)
summary(mod_relhtgrowth_pca_noG) #nothing significant
options(na.action="na.fail")
mod_relhtgrowth_pca_noG_dredge<- dredge(mod_relhtgrowth_pca_noG)
mod_relhtgrowth_pca_noG_dredge #null is best
```


####transfer distance

```{r}

ht_growth_rel_clim_long <- ht_growth_rel_clim %>% 
  rename(year=name) %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,year,relhtgrowth,all_of(transfer_vars))) %>% 
  pivot_longer(CMD:pcadist2d)

ht_growth_rel_clim_long_transfer <- ht_growth_rel_clim_long %>%
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  mutate(transfer=ifelse(is.na(transfer), value, transfer))

ht_growth_rel_clim_long_transfer_nog <- ht_growth_rel_clim_long_transfer %>% filter(!Provenance=="Gila NF")

relhtgrowth_mods_transfer<- data.frame()
for(i in 1:length(transfer_vars)){
mod <- lmer(relhtgrowth ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(relhtgrowth ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long_transfer_nog %>% filter(name==transfer_vars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

relhtgrowth_mods_transfer <- bind_rows(relhtgrowth_mods_transfer, data.frame(var=transfer_vars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))

}

relhtgrowth_mods_transfer %>% arrange(pvalue_nog) #NFFD, pcadist2d and PC2transfer significant without Gila

#####NFFD
NFFD_relht_mod_lm_nog <- lm(relhtgrowth ~ transfer, data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="NFFD"))
summary(NFFD_relht_mod_lm_nog)

####make plot 
newdata_NFFD_relht_nog <-  expand.grid(transfer=seq(min(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="NFFD") %>% pull(transfer)), max(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="NFFD") %>% pull(transfer)), length.out=50))
NFFD_relht_predict_nog <- predict(NFFD_relht_mod_lm_nog, newdata = newdata_NFFD_relht_nog, interval="confidence")

predictdata_NFFD_relht_nog <- cbind(newdata_NFFD_relht_nog, NFFD_relht_predict_nog) %>% mutate(var="NFFD")
###

NFFD_relht_plot <- ggplot()+
  #geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="NFFD") %>% pull(value), col="darkorange2")+
  #geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="NFFD") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_NFFD_relht_nog, aes(x=transfer, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_NFFD_relht_nog, aes(x=transfer,y=fit))+
  geom_rug(data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="NFFD") %>% mutate(fit=12) %>% filter(!Provenance=="Gila NF"), aes(x=transfer,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("NFFD Transfer")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
NFFD_relht_plot

#####PC2transfer
PC2transfer_relht_mod_lm_nog <- lm(relhtgrowth ~ transfer, data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PC2transfer"))
summary(PC2transfer_relht_mod_lm_nog)

####make plot 
newdata_PC2transfer_relht_nog <-  expand.grid(transfer=seq(min(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PC2transfer") %>% pull(transfer)), max(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PC2transfer") %>% pull(transfer)), length.out=50))
PC2transfer_relht_predict_nog <- predict(PC2transfer_relht_mod_lm_nog, newdata = newdata_PC2transfer_relht_nog, interval="confidence")

predictdata_PC2transfer_relht_nog <- cbind(newdata_PC2transfer_relht_nog, PC2transfer_relht_predict_nog) %>% mutate(var="PC2transfer")
###

PC2transfer_relht_plot <- ggplot()+
  #geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="PC2transfer") %>% pull(value), col="darkorange2")+
  #geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="PC2transfer") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_PC2transfer_relht_nog, aes(x=transfer, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_PC2transfer_relht_nog, aes(x=transfer,y=fit))+
  geom_rug(data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PC2transfer") %>% mutate(fit=12) %>% filter(!Provenance=="Gila NF"), aes(x=transfer,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("PC2transfer Transfer")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
PC2transfer_relht_plot

#####pcadist2d
pcadist2d_relht_mod_lmer_nog <- lmer(relhtgrowth ~ transfer + (1|Provenance)+ (1|BLK) + (1|year), data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="pcadist2d"))
summary(pcadist2d_relht_mod_lmer_nog)

pcadist2d_relht_mod_lm_nog <- lm(relhtgrowth ~ transfer, data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="pcadist2d"))
summary(pcadist2d_relht_mod_lm_nog)

####make plot 
newdata_pcadist2d_relht_nog <-  expand.grid(transfer=seq(min(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="pcadist2d") %>% pull(transfer)), max(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="pcadist2d") %>% pull(transfer)), length.out=50))
pcadist2d_relht_predict_nog <- predict(pcadist2d_relht_mod_lm_nog, newdata = newdata_pcadist2d_relht_nog, interval="confidence")

predictdata_pcadist2d_relht_nog <- cbind(newdata_pcadist2d_relht_nog, pcadist2d_relht_predict_nog) %>% mutate(var="pcadist2d")
###

pcadist2d_relht_plot <- ggplot()+
  #geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="pcadist2d") %>% pull(value), col="darkorange2")+
  #geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="pcadist2d") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_pcadist2d_relht_nog, aes(x=transfer, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_pcadist2d_relht_nog, aes(x=transfer,y=fit))+
  geom_vline(xintercept=0, linetype=2)+
  geom_rug(data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="pcadist2d") %>% mutate(fit=12) %>% filter(!Provenance=="Gila NF"), aes(x=transfer,y=fit), linewidth=1, sides="b")+
  xlab("Transfer in 2D PCA")+
  ylab("Relative Height Growth Rate (%/year)")+
  theme_bw()+
  theme(legend.position="right")
pcadist2d_relht_plot


#quadratic

relhtgrowth_mods_quad<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- lmer(relhtgrowth ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_transfer %>% filter(name==transfer_vars[i]))
pvalues<- as.data.frame(summary(mod)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2 <- performance::r2(mod)$R2_conditional
Mr2 <- performance::r2(mod)$R2_marginal
 
mod_nog <- lmer(relhtgrowth ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) + (1|year), data=ht_growth_rel_clim_long_transfer_nog %>% filter(name==transfer_vars[i])) 
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients)[2:3,]$`Pr(>|t|)`
Cr2_nog <- performance::r2(mod_nog)$R2_conditional
Mr2_nog <- performance::r2(mod_nog)$R2_marginal

relhtgrowth_mods_quad <- bind_rows(relhtgrowth_mods_quad, data.frame(var=transfer_vars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], cr2= Cr2, mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], cr_nog = Cr2_nog, mr2_nog = Mr2_nog))

}

relhtgrowth_mods_quad %>% arrange(pvalue2_nog) #PPTsp and MCMT significant without Gila


##significant vars
#####PPTsp
PPTsp_relht_mod_lm_nog <- lm(relhtgrowth ~ transfer + I(transfer^2), data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PPTsp"))
summary(PPTsp_relht_mod_lm_nog)

####make plot 
newdata_PPTsp_relht_nog <-  expand.grid(transfer=seq(min(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PPTsp") %>% pull(transfer)), max(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PPTsp") %>% pull(transfer)), length.out=50))
PPTsp_relht_predict_nog <- predict(PPTsp_relht_mod_lm_nog, newdata = newdata_PPTsp_relht_nog, interval="confidence")

predictdata_PPTsp_relht_nog <- cbind(newdata_PPTsp_relht_nog, PPTsp_relht_predict_nog) %>% mutate(var="PPTsp")
###

PPTsp_relht_plot <- ggplot()+
  #geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="PPTsp") %>% pull(value), col="darkorange2")+
  #geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="PPTsp") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_PPTsp_relht_nog, aes(x=transfer, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_PPTsp_relht_nog, aes(x=transfer,y=fit))+
  geom_rug(data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="PPTsp") %>% mutate(fit=12) %>% filter(!Provenance=="Gila NF"), aes(x=transfer,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("PPTsp Transfer")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
PPTsp_relht_plot

#####MCMT
MCMT_relht_mod_lm_nog <- lm(relhtgrowth ~ transfer + I(transfer^2), data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="MCMT"))
summary(MCMT_relht_mod_lm_nog)

####make plot 
newdata_MCMT_relht_nog <-  expand.grid(transfer=seq(min(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="MCMT") %>% pull(transfer)), max(ht_growth_rel_clim_long_transfer_nog %>% filter(name=="MCMT") %>% pull(transfer)), length.out=50))
MCMT_relht_predict_nog <- predict(MCMT_relht_mod_lm_nog, newdata = newdata_MCMT_relht_nog, interval="confidence")

predictdata_MCMT_relht_nog <- cbind(newdata_MCMT_relht_nog, MCMT_relht_predict_nog) %>% mutate(var="MCMT")
###

MCMT_relht_plot <- ggplot()+
  #geom_vline(xintercept = prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="MCMT") %>% pull(value), col="darkorange2")+
  #geom_text(aes(x=prov_clim_adjusted_bi_long %>% filter(Provenance=="Plantation") %>% filter(name=="MCMT") %>% pull(value) + 12, y=12.5, label="plantation"), col="darkorange2")+
  geom_ribbon(data=predictdata_MCMT_relht_nog, aes(x=transfer, ymin=lwr, ymax=upr), alpha=0.2)+
  geom_line(data=predictdata_MCMT_relht_nog, aes(x=transfer,y=fit))+
  geom_rug(data=ht_growth_rel_clim_long_transfer_nog %>% filter(name=="MCMT") %>% mutate(fit=12) %>% filter(!Provenance=="Gila NF"), aes(x=transfer,y=fit, col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1, sides="b")+
  scale_color_manual(values=unname(stepped())[-1], name="Provenance")+
  xlab("MCMT Transfer")+
  ylab("Relative Height Growth Rate (%/year)")+
  facet_grid(~var)+
  theme_bw()+
  theme(legend.position="right")
MCMT_relht_plot

```

####survivors only relht

```{r}
##just some visuals for height growth in survivors vs. non-survivors to help contextualize results.
###absolute height
survivors_ht_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  filter(!is.na(HT14)) %>% 
  filter(!HT14==0) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(uid=paste(LOC,BLK,REP, sep=""),
         year=case_when(name=="HT74" ~ 1974,
                        name=="HT79"~ 1979,
                        name=="HT85" ~1985,
                        name=="HT91" ~ 1991,
                        name=="HT96" ~1996,
                        name=="HT06" ~ 2006,
                        name=="HT14" ~ 2014))

nonsurvivors_ht_data<- moniger_data_comb %>% 
  dplyr::select(c(LOC,BLK,REP,Provenance,HT74:HT14,Seedling.Ht..from.Nursery)) %>% 
  filter(is.na(HT14)| HT14==0) %>% 
  pivot_longer(HT74:HT14) %>% 
  mutate(uid=paste(LOC,BLK,REP, sep=""),
         year=case_when(name=="HT74" ~ 1974,
                        name=="HT79"~ 1979,
                        name=="HT85" ~1985,
                        name=="HT91" ~ 1991,
                        name=="HT96" ~1996,
                        name=="HT06" ~ 2006,
                        name=="HT14" ~ 2014))

ggplot(data=nonsurvivors_ht_data, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, color="red")+
  theme(legend.position = "none")+
  ylab("Height (m)")+
  ggtitle("Non-survivors")

ggplot(data=survivors_ht_data, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, color="red")+
  theme(legend.position = "none")+
  ylab("Height (m)")+
  ggtitle("Survivors")

####relative height growth rate
survivors_relht <- ht_growth_rel_data %>% 
  filter(!is.na(HT14)) %>% 
    mutate(year=case_when(name=="growth79rel" ~ 1979,
                          name=="growth85rel" ~1985,
                          name=="growth91rel"~1991,
                          name=="growth96rel"~1996,
                          name=="growth06rel"~2006,
                          name=="growth14rel"~2014),
           uid=paste(LOC,BLK,REP,sep=""))
nonsurvivors_relht <- ht_growth_rel_data %>% 
  filter(is.na(HT14)) %>% 
    mutate(year=case_when(name=="growth79rel" ~ 1979,
                          name=="growth85rel" ~1985,
                          name=="growth91rel"~1991,
                          name=="growth96rel"~1996,
                          name=="growth06rel"~2006,
                          name=="growth14rel"~2014),
           uid=paste(LOC,BLK,REP,sep=""))

ggplot(data=survivors_relht, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  geom_hline(yintercept=0, color="red")+
  ylab("Relativized Height Growth Per Year")+
  ggtitle("Survivors")+
  theme_bw()+
  theme(legend.position = "none")


ggplot(data=nonsurvivors_relht, aes(x=year, y=value, color=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(alpha=0.4)+
  geom_line(aes(group=uid))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  geom_hline(yintercept=0, color="red")+
  ylab("Relativized Height Growth Per Year")+
  ggtitle("Non-Survivors")+
  theme_bw()+
  theme(legend.position = "none")
```


##Cones

```{r}
cone_data <- moniger_data_comb %>% 
  dplyr::select(c(BLK,REP,Provenance,Cones85:Cones06)) %>% 
  pivot_longer(Cones85:Cones06) %>% 
  mutate(year=case_when(name == "Cones85" ~ 1985,
                        name == "Cones91" ~ 1991,
                        name == "Cones96" ~ 1996,
                        name == "Cones06" ~ 2006)) %>%
  filter(!is.na(value))

cone_sum <- cone_data %>%
  filter(!is.na(value)) %>% 
  group_by(Provenance,year) %>% 
  summarise(value=sum(value), n=n()) %>% 
  mutate(prop.w.cones = value/n)

years_to_cone<- cone_data %>% 
  filter(value==1) %>% 
  group_by( BLK, Provenance) %>% 
  summarise(min_year=min(year)) %>% 
  rbind(cone_data %>% 
          filter(year==2006 & value==0) %>% 
          mutate(min_year=NA) %>% 
          dplyr::select(-c("value","name","year"))) %>% 
  mutate(years_in_field = min_year-1970) %>% 
  distinct(BLK, Provenance, .keep_all = TRUE)

mean(years_to_cone$years_in_field, na.rm=T)
median(years_to_cone$years_in_field, na.rm=T)
min(years_to_cone$years_in_field, na.rm=T)
max(years_to_cone$years_in_field, na.rm=T)
par(mfrow=c(1,1))
hist(years_to_cone$years_in_field)
years_to_cone %>% filter(min_year==1985) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991)) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991,1996)) %>% nrow() / nrow(years_to_cone)
years_to_cone %>% filter(min_year%in%c(1985, 1991, 1996, 2006)) %>% nrow() / nrow(years_to_cone)

cone_sum_forfig<- cone_sum %>% 
  bind_rows(data.frame(Provenance="Gila NF", year=c(1974,1979,2014), prop.w.cones=NA))

cone_means_fig <- ggplot(cone_sum_forfig, aes(x=factor(year,levels=c(1974,1979,1985,1991,1996,2006,2014), labels=c(1974,1979,1985,1991,1996,2006,2014)), y=prop.w.cones*100, col=factor(Provenance, levels=provs_bylat$Provenance),group=factor(Provenance, levels=provs_bylat$Provenance)))+
  geom_point(size=3, position = position_dodge(width=0.8))+
  geom_text(data= data.frame(year=2014, prop.w.cones=.5, Provenance="Lariimer 2", label="not \n sampled"), aes(label=label), color="black")+
  #geom_line(position = position_dodge(width=0.8))+
  scale_color_manual(values=unname(stepped()), "")+
  theme_bw()+
  xlab("Year")+
  ylab("Trees with Cones (%)")
```

###ANOVA
```{r}

cone_data_binom <- cone_data %>% 
  group_by(Provenance, year, BLK, REP) %>% 
  summarise(n_cones = sum(value), total=n()) 

logmod_cat1 <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(year)*Provenance + (1|BLK), data=cone_data_binom, family=binomial)
diagnose(logmod_cat1)
summary(logmod_cat1)
Anova(logmod_cat1, type="3")
confint(logmod_cat1)

##predictions
newdata1 <- with(cone_data_binom, data.frame(year = seq(min(year),max(year),1), Provenance = rep(unique(cone_data$Provenance), each=22)))

newdata1<- expand.grid(Provenance=unique(cone_data_binom$Provenance),
            year=unique(cone_data_binom$year),
            BLK = unique(cone_data_binom$BLK))

newdata2 <- cbind(newdata1, predict(logmod_cat1, newdata = newdata1, type = "link", se=TRUE))
newdata3 <- within(newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_fig<- ggplot(newdata3, aes(x = year, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = factor(Provenance, levels=provs_bylat$Provenance)), alpha = 0.2) + geom_line(aes(colour = factor(Provenance, levels=provs_bylat$Provenance)),
    linewidth = 1)+
  scale_color_manual(values=unname(stepped()),name="Provenance")+
  scale_fill_manual(values=unname(stepped()),name="Provenance")+
  ylab("Predicted Probability")+
  facet_wrap(~BLK)+
  theme_bw()+
  theme(axis.text = element_text(color="black", size=10),
        axis.title = element_text(color="black", size=10),
        legend.position = "none",
        legend.text = element_text(color="black", size=8),
        legend.title = element_text(color="black", size=10))

# png("figures/cone_fig.png", height=3, width=3, res=300, units="in")
 cone_fig
# dev.off()
```

###PC only mods

```{r}
#calculate PCA transfer distances
moniger_subset <- moniger_data_comb %>% 
  filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(Provenance, BLK, REP, HT85, HT91, HT96, HT06, code)) %>%
  pivot_longer(HT85:HT06, values_to = "height") %>% 
    mutate(year=case_when(name == "HT85" ~ 1985,
                        name == "HT91" ~ 1991,
                        name == "HT96" ~ 1996,
                        name == "HT06" ~ 2006)) %>% 
  dplyr::select(-name) %>% 
left_join(cone_data_binom) %>% 
left_join(moniger_data_comb %>% 
  filter(! (LOC==30 & BLK=="D" & REP==3)) %>%  ##excluding Gila tree that was outlier for height in 1996
  dplyr::select(c(BLK, REP, PC1, PC2, PC3, x, y, code))) %>% 
  filter(!(is.na(height)|is.na(n_cones))) %>% 
  mutate(plant_PC1 = plant_pca_scores$PC1[1], plant_PC2 = plant_pca_scores$PC2[1]) %>% 
  mutate(PC1transfer = PC1 - plant_PC1, PC2transfer = PC2 - plant_PC2) %>% 
  mutate(absPC1transfer = abs(PC1transfer), absPC2transfer = abs(PC2transfer)) %>% 
  mutate(pcadist = sqrt(absPC1transfer^2 + absPC2transfer^2))

moniger_subset_noG <- moniger_subset %>% 
  filter(!Provenance=="Gila NF")

###using year as a random effect

#with Gila
mod_cones_pca <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1transfer + I(PC1transfer^2) + scale(height)*PC2transfer + I(PC2transfer^2) + scale(height)*pcadist + (1|code) + (1|year) + (1|BLK), data=moniger_subset, family=binomial)
summary(mod_cones_pca)

#no gila

mod_cones_pca_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(height)*PC1transfer + I(PC1transfer^2) + scale(height)*PC2transfer + I(PC2transfer^2) + scale(height)*pcadist + (1|code) + (1|year) + (1|BLK), data=moniger_subset_noG, family=binomial)
summary(mod_cones_pca_nog) #nothing significant
options(na.action="na.fail")
mod_cones_pca_nog_dredge<- dredge(mod_cones_pca_nog)
mod_cones_pca_nog_dredge #pcadist and height 

##predictions
#no gila
best.mod.cone.clim_nog <- glmmTMB(cbind(n_cones, total-n_cones) ~ height + (1|code) + (1|year) + (1|BLK), data= moniger_subset_noG, family = binomial)
summary(best.mod.cone.clim_nog) #only height is significant
plot(simulateResiduals(best.mod.cone.clim_nog))

##predictions - no gila - height

newmod <- glmmTMB(cbind(n_cones, total-n_cones) ~  height, data= moniger_subset_noG, family = binomial)
summary(newmod)
plot(simulateResiduals(newmod))

CCnewdata1_cone_nog_height <- expand.grid(height=seq(min(moniger_subset_noG$height),max(moniger_subset_noG$height),0.1),
            pcadist=mean(moniger_subset_noG$pcadist))

CCnewdata2_cone_nog_height <- cbind(CCnewdata1_cone_nog_height, predict(newmod, newdata = CCnewdata1_cone_nog_height, type="link", se.fit=TRUE))
CCnewdata3_cone_nog_height <- within(CCnewdata2_cone_nog_height, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cone_plot_height<- ggplot(CCnewdata3_cone_nog_height %>% mutate(var="Height"), aes(x = height, y = PredictedProb)) +
  geom_segment(aes(x=3.859648, y = 0, xend=3.859648, yend=.5), col="red")+
  geom_segment(aes(x=0, y = 0.5, xend=3.859648, yend=.5), col="red")+
  geom_ribbon(aes(ymin = LL, ymax = UL), alpha = 0.2, col=NA) + 
  geom_line(linewidth = 1)+
  geom_line(aes(x=height, y=PredictedProb))+
  geom_rug(data=moniger_subset_noG%>% mutate(PredictedProb=.8), aes(x=height, y=PredictedProb), sides="b", linewidth=1, col="black", alpha=0.5)+
  theme_bw()+
  ylim(c(0,1))+
  xlab("Height (m)")+
  ylab("Predicted Probability of Cones")+
  theme(legend.position = "bottom")

cone_plot_height

###height needed for 50% chance of having cones
#log(p/(1-p)) = b0 + b1*height

b0 = summary(newmod)$coefficients$cond[1,"Estimate"]
b1 = summary(newmod)$coefficients$cond[2,"Estimate"]

#25%
p=0.25
height = (log(p/(1-p))-b0)/b1
height

#50%
p=0.5
height = (log(p/(1-p))-b0)/b1
height

#75%
p=0.75
height = (log(p/(1-p))-b0)/b1
height

#95%
p=0.95
height = (log(p/(1-p))-b0)/b1
height
```

```{r}
moniger_subset

ggplot(moniger_subset)+
  geom_jitter(aes(x=height, y=n_cones))

```

```{r}
moniger_subset

cone_ht_anova <- glmmTMB(cbind(n_cones, total-n_cones) ~ scale(year)*Provenance*height + (1|BLK), data=moniger_subset, family=binomial)
summary(cone_ht_anova)
Anova(cone_ht_anova, type="3")
```

###transfer distance

```{r}
cone_clim_long_transfer <- moniger_subset %>% 
  left_join(prov_pcapts_big) %>% 
  dplyr::select(c(Provenance, BLK, REP, code, height, year, n_cones,total, all_of(provenance_climvars))) %>% 
  pivot_longer(CMD:monsoonality) %>% 
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  bind_rows(moniger_subset[,c("code","BLK","REP","Provenance","year","height","n_cones","total","PC1transfer","PC2transfer","pcadist")] %>% 
              rename(pcadist2d = pcadist) %>% 
  pivot_longer(PC1transfer:pcadist2d, names_to="name", values_to="transfer")) 


cone_clim_long_transfer_nog <- cone_clim_long_transfer %>% filter(!Provenance=="Gila NF")

cone_mods_transfer<- data.frame()
for(i in 1:length(transfer_vars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ transfer*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_clim_long_transfer %>% filter(name==transfer_vars[i]), family=binomial)
p.transfer<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ transfer*height + (1|Provenance) + (1|year) + (1|BLK), data=cone_clim_long_transfer_nog %>% filter(name==transfer_vars[i]), family=binomial)
p.transfer_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
Mr2_nog <- r2(mod_nog)$R2_marginal

cone_mods_transfer <- bind_rows(cone_mods_transfer, data.frame(var=transfer_vars[i], p.transfer = p.transfer, Mr2=Mr2, p.transfer_nog = p.transfer_nog, Mr2_nog=Mr2_nog))

}

cone_mods_transfer %>% arrange(p.transfer_nog) #PPTsm and TD

#significant vars

###PPTsm
cone_ht_pptsm_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ transfer*height + (1|year) + (1|Provenance) + (1|BLK), data=cone_clim_long_transfer_nog %>% filter(name=="PPTsm"), family=binomial)
summary(cone_ht_pptsm_mod_nog)
r2(cone_ht_pptsm_mod_nog)

cone_ht_pptsm_data_nog <- cone_clim_long_transfer %>% filter(!Provenance=="Gila NF") %>% filter(name=="PPTsm")

#prediction
##take random effect out to make predictions
cone_ht_pptsm_nog_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~ transfer*height, data=cone_ht_pptsm_data_nog, family=binomial)

##predictions - 3.9m
cone_ht_pptsm_nog_newdata1 <- with(cone_ht_pptsm_data_nog, expand.grid(transfer = seq(min(transfer),max(transfer),length.out=50), height=c(2.6,5.1,3.9)))

cone_ht_pptsm_nog_newdata2 <- cbind(cone_ht_pptsm_nog_newdata1, predict(cone_ht_pptsm_nog_glm, newdata = cone_ht_pptsm_nog_newdata1, type = "link", se=TRUE))
cone_ht_pptsm_nog_newdata3 <- within(cone_ht_pptsm_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(cone_ht_pptsm_nog_newdata3 %>% filter(height==3.9), aes(x = transfer, y = PredictedProb)) +
  geom_ribbon(aes(ymin = LL,ymax = UL),alpha = 0.2)+ 
  geom_line(linewidth = 1)+
  geom_rug(data=cone_clim_long_transfer_nog %>% filter(name=="PPTsm") %>% mutate(PredictedProb=0.6), sides="b", linewidth=1, color="black", alpha=0.5)+
  ylim(c(0,1))+
  xlab("Provenance summer precip")+
  ylab("Predicted Probability of Cones at 3.9m")+
  theme_bw()

###TD
cone_ht_TD_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ transfer*height + (1|year) + (1|Provenance) + (1|BLK), data=cone_clim_long_transfer_nog %>% filter(name=="TD") %>% filter(!Provenance=="Gila NF"), family=binomial)
summary(cone_ht_TD_mod_nog) 
r2(cone_ht_TD_mod_nog)

cone_ht_td_data_nog<- cone_clim_long_transfer_nog %>% filter(name=="TD")

##predictions
cone_ht_td_nog_glm <-  glmmTMB(cbind(n_cones,total-n_cones) ~ transfer*height, data=cone_ht_td_data_nog, family=binomial)

cone_ht_td_nog_newdata1 <- expand.grid(transfer = with(cone_ht_td_data_nog, seq(min(transfer),max(transfer),length.out=50)), height=c(2.6,5.1,3.9))

cone_ht_td_nog_newdata2 <- cbind(cone_ht_td_nog_newdata1, predict(cone_ht_td_nog_glm, newdata = cone_ht_td_nog_newdata1, type = "link", se=TRUE))
cone_ht_td_nog_newdata3 <- within(cone_ht_td_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cones_TD_plot<- ggplot() + 
  geom_ribbon(data=cone_ht_td_nog_newdata3, aes(ymin = LL,ymax = UL, x = transfer, col=factor(height, levels=c(5.1,3.9,2.6)), fill=factor(height, levels=c(5.1,3.9,2.6))), alpha = 0.2) + 
  geom_line(data=cone_ht_td_nog_newdata3, aes(x = transfer, y = PredictedProb, col=factor(height, levels=c(5.1,3.9,2.6))), linewidth = 1)+
  geom_rug(data=cone_clim_long_transfer_nog %>% filter(name=="TD") %>% mutate(PredictedProb=0.6) %>% dplyr::select(-height), aes(x=transfer), sides="b", linewidth=1, color="black", alpha=0.5)+
  scico::scale_fill_scico_d(palette = "lajolla", begin=0, end=.5, name="Height (m)")+
  scico::scale_color_scico_d(palette = "lajolla", begin=0, end=.5, name="Height (m)")+
  ylim(c(0,1))+
  xlab("TD transfer")+
  ylab("Predicted Probability of Cones")+
  theme_bw()+
  theme(legend.position="top")

cones_TD_plot

#quadratic

cone_ht_mods_quad<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(transfer)*height + I(scale(transfer)^2) + (1|Provenance) + (1|year) + (1|BLK), data=cone_clim_long_transfer %>% filter(name==transfer_vars[i]), family=binomial)
pvalues<- as.data.frame(summary(mod)$coefficients$cond[c(2,4),])$`Pr(>|z|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~ scale(transfer)*height + I(scale(transfer)^2) + (1|Provenance) + (1|year) + (1|BLK), data=cone_clim_long_transfer_nog %>% filter(name==transfer_vars[i]) %>% filter(!code=="GiNF"), family=binomial)
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond[c(2,4),])$`Pr(>|z|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

cone_ht_mods_quad <- bind_rows(cone_ht_mods_quad, data.frame(var=transfer_vars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))
}

cone_ht_mods_quad %>% arrange(pvalue2_nog) ##PPTsm significant again

###PPTsm
cone_ht_pptsm_quad_mod_nog <- glmmTMB(cbind(n_cones,total-n_cones) ~  transfer*height + I(transfer^2)+ (1|year) + (1|Provenance) + (1|BLK), data=cone_clim_long_transfer_nog %>% filter(!Provenance=="Gila NF") %>% filter(name=="PPTsm"), family=binomial)
summary(cone_ht_pptsm_quad_mod_nog)
r2(cone_ht_pptsm_quad_mod_nog)

#prediction
##take random effect out to make predictions
cone_ht_pptsm_quad_nog_glm <- glmmTMB(cbind(n_cones,total-n_cones) ~  transfer*height + I(transfer^2), data=cone_ht_pptsm_data_nog, family=binomial)

##predictions 
cone_ht_pptsm_quad_nog_newdata1 <- with(cone_ht_pptsm_data_nog, data.frame(transfer = seq(min(transfer),max(transfer),length.out=50), height=3.9))

cone_ht_pptsm_quad_nog_newdata2 <- cbind(cone_ht_pptsm_quad_nog_newdata1, predict(cone_ht_pptsm_quad_nog_glm, newdata = cone_ht_pptsm_quad_nog_newdata1, type = "link", se=TRUE))
cone_ht_pptsm_quad_nog_newdata3 <- within(cone_ht_pptsm_quad_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cones_pptsm_plot<- ggplot(cone_ht_pptsm_quad_nog_newdata3, aes(x = transfer, y = PredictedProb)) +
  geom_ribbon(aes(ymin = LL,ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_rug(data=cone_clim_long_transfer_nog %>% filter(name=="PPTsm") %>% mutate(PredictedProb=0.5), sides="b", linewidth=1, color="black", alpha=0.5)+
  ylim(c(0,1))+
  xlab("Summer precip transfer")+
  ylab("Predicted Probability of Cones at 3.9m")+
  theme_bw()+
  theme(legend.position="top")


ggarrange(cone_plot_height,cones_pptsm_plot, cones_TD_plot, ncol=3, labels=c("A)","B)","C)"),nrow=1)
```

##Survival 2014

###ANOVA

```{r}
### do survival analyses for each year independently (since overall survival for each year are not independent of each other). For the climate analysis, I'm just going to look at how provenance climate impacted survival to 2014, since this is the most informative for longevity of these trees. 

moniger_survival_byyr_zeros <- moniger_data_comb %>% 
  mutate(Stat79 = ifelse(Stat74 == 9, 0, Stat79)) %>% 
  mutate(Stat85 = ifelse(Stat79 %in% c(NA,9), 0, Stat85)) %>% 
  mutate(Stat91 = ifelse(Stat85 %in% c(NA,9), 0, Stat91)) %>% 
  mutate(Stat96 = ifelse(Stat91 %in% c(NA,9), 0, Stat96)) %>% 
  mutate(Stat06 = ifelse(Stat96 %in% c(NA,9), 0, Stat06)) %>% 
  mutate(Stat14 = ifelse(Stat06 %in% c(NA,9), 0, Stat14)) %>% 
  dplyr::select(c(SORT,LOC,BLK,REP,Provenance,Stat74:Stat14)) %>% 
  pivot_longer(Stat74:Stat14) %>% 
  mutate(year=case_when(name == "Stat74" ~ 1974,
                        name == "Stat79" ~ 1979,
                        name == "Stat85" ~ 1985,
                        name == "Stat91" ~ 1991,
                        name == "Stat96" ~ 1996,
                        name == "Stat06" ~ 2006,
                        name == "Stat14" ~ 2014)) %>% 
  mutate(value = ifelse(value==9,0,value))

moniger_survival_byyr_binom_zeros<- moniger_survival_byyr_zeros %>% 
  group_by(Provenance,BLK,year) %>% 
  summarise(alive=sum(value)) %>% 
  mutate(died=4-alive) %>% 
  full_join(surv_df_zero) %>% 
  mutate(year=ifelse(is.na(year),2014,year),
         alive=ifelse(is.na(alive),0,alive),
         died=ifelse(is.na(died),4,died)) %>% 
  left_join(moniger_survival %>% dplyr::select(c(Provenance,BLK,PC1,PC2,AHM:SHM,x,y,smrpb,monsoonality)) %>% unique()) 

####ANOVAs for each year separately

alltree_survmod74 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1974), family=binomial)
Anova(alltree_survmod74, type="3")
alltree_survmod74_marg = lsmeans(alltree_survmod74, ~ Provenance)

CLD_alltree_survmod74 = cld(alltree_survmod74_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod74 

alltree_survmod79 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1979), family=binomial)
Anova(alltree_survmod79, type="3")
alltree_survmod79_marg = lsmeans(alltree_survmod79, ~ Provenance)

CLD_alltree_survmod79 = cld(alltree_survmod79_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod79 

alltree_survmod85 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1985), family=binomial)
Anova(alltree_survmod85, type="3")
alltree_survmod85_marg = lsmeans(alltree_survmod85, ~ Provenance)

CLD_alltree_survmod85 = cld(alltree_survmod85_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod85 

alltree_survmod91 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1991), family=binomial)
Anova(alltree_survmod91, type="3")
alltree_survmod91_marg = lsmeans(alltree_survmod91, ~ Provenance)

CLD_alltree_survmod91 = cld(alltree_survmod91_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod91 

alltree_survmod96 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==1996), family=binomial)
Anova(alltree_survmod96, type="3")
alltree_survmod96_marg = lsmeans(alltree_survmod96, ~ Provenance)

CLD_alltree_survmod96 = cld(alltree_survmod96_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod96 

alltree_survmod06 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==2006), family=binomial) 
Anova(alltree_survmod06, type="3")
alltree_survmod06_marg = lsmeans(alltree_survmod06, ~ Provenance)

CLD_alltree_survmod06 = cld(alltree_survmod06_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod06 

alltree_survmod14 <- glmmTMB(cbind(alive, died) ~ Provenance + (1|BLK), data=moniger_survival_byyr_binom_zeros %>% filter(year==2014), family=binomial)
Anova(alltree_survmod14, type="3")
alltree_survmod14_marg = lsmeans(alltree_survmod14, ~ Provenance)

CLD_alltree_survmod14 = cld(alltree_survmod14_marg,
          alpha=0.05,
          Letters=letters)
CLD_alltree_survmod14 

#####calculate summary stats
moniger_survival_byyr_binom_zeros_2014<- moniger_survival_byyr_binom_zeros %>% filter(year=="2014")
prop_surv_by_prov <- moniger_survival_byyr_binom_zeros_2014 %>% 
  group_by(Provenance) %>% 
  summarise(alive=sum(alive), died=sum(died)) %>% 
  mutate(surv.prop=alive/(died+alive)) %>% 
  arrange(surv.prop)
```

###PC only mods
```{r}
####START HERE#####
surv14_clim <- moniger_survival_byyr_binom_zeros_2014 %>% 
  dplyr::select(c(Provenance, BLK, year,alive,died,all_of(provenance_climvars))) %>%
left_join(moniger_data_comb %>% 
  dplyr::select(c(Provenance,BLK, PC1, PC2))) %>% 
  mutate(plant_PC1 = plant_pca_scores$PC1[1], plant_PC2 = plant_pca_scores$PC2[1]) %>% 
  mutate(PC1transfer = PC1 - plant_PC1, PC2transfer = PC2 - plant_PC2) %>% 
  mutate(absPC1transfer = abs(PC1transfer), absPC2transfer = abs(PC2transfer)) %>% 
  mutate(pcadist2d = sqrt(absPC1transfer^2 + absPC2transfer^2))

surv14_clim_nog <- surv14_clim %>% filter(!Provenance=="Gila NF")


survmod2014_pc_nog<- glmmTMB(cbind(alive,died) ~ PC1transfer*PC2transfer + I(PC1transfer^2) + I(PC2transfer^2) + pcadist2d + (1|Provenance) + (1|BLK) + (1|year), data=surv14_clim_nog, family=binomial)

summary(survmod2014_pc_nog) #nothing significant
dredge_survmod2014_pc_nog <- dredge(survmod2014_pc_nog)
dredge_survmod2014_pc_nog ##null is best
```

###transfer distance

```{r}
survival14_transfer <- surv14_clim %>% 
  dplyr::select(c(Provenance, BLK, year, alive, died, all_of(transfer_vars))) %>% 
  pivot_longer(CMD:monsoonality) %>% 
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  bind_rows(surv14_clim[,c("BLK","Provenance","year","alive","died","PC1transfer","PC2transfer","pcadist2d")] %>% 
  pivot_longer(PC1transfer:pcadist2d, names_to="name", values_to="transfer")) 

surv_mods_2014<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- glmmTMB(cbind(alive,died) ~ transfer + (1|Provenance) + (1|BLK), data=survival14_transfer %>% filter(name==transfer_vars[i]), family=binomial)
pvalue<- as.data.frame(summary(mod)$coefficients$cond)[2,]$`Pr(>|z|)`
Mr2=r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ transfer + (1|Provenance)+ (1|BLK), data=survival14_transfer %>% filter(name==transfer_vars[i]) %>% filter(!Provenance=="Gila NF"), family=binomial)
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2,]$`Pr(>|z|)`
Mr2_nog=r2(mod_nog)$R2_marginal

surv_mods_2014 <- bind_rows(surv_mods_2014, data.frame(var=transfer_vars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog = Mr2_nog))}

surv_mods_2014 %>% arrange(pvalue_nog) ##NFFD, smrpb
surv_mods_2014 %>% 
  filter(pvalue_nog<0.05) %>% 
  arrange(desc(Mr2_nog))

###

###create data frame with coefficients of the significant models
surv2014_sigvars <-surv_mods_2014 %>% filter(pvalue_nog<0.05) %>% pull(var)
surv_mods_2014_coeffs<- data.frame()
surv_mods_2014_coeffs_nog <- data.frame()
for(i in 1:length(surv2014_sigvars)){
mod <- glmmTMB(cbind(alive,died) ~ transfer + (1|Provenance) +  (1|BLK), data=survival14_transfer %>% filter(name==surv2014_sigvars[i]), family=binomial)
p.value<- summary(mod)$coefficients$cond[2,]["Pr(>|z|)"]
estimate <- confint(mod)[2,3]
lwr <- confint(mod)[2,1]
upr <- confint(mod)[2,2]

mod_nog <- glmmTMB(cbind(alive,died) ~ transfer + (1|Provenance) + (1|BLK), data=survival14_transfer %>% filter(!Provenance=="Gila NF") %>% filter(name==surv2014_sigvars[i]), family=binomial)
p.value_nog<- summary(mod_nog)$coefficients$cond[2,]["Pr(>|z|)"]
estimate_nog <- confint(mod_nog)[2,3]
lwr_nog <- confint(mod_nog)[2,1]
upr_nog <- confint(mod_nog)[2,2]

surv_mods_2014_coeffs <- bind_rows(surv_mods_2014_coeffs, data.frame(var=surv2014_sigvars[i], p.value = p.value, estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
surv_mods_2014_coeffs_nog <- bind_rows(surv_mods_2014_coeffs_nog, data.frame(var=surv2014_sigvars[i],  p.value = p.value_nog, estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
}

surv_mods_2014_coeffs_all<- bind_rows(surv_mods_2014_coeffs, surv_mods_2014_coeffs_nog)

ggplot(surv_mods_2014_coeffs_all, aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.5,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.5, position = position_dodge(width=1))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  ggtitle("2014 Survival - Provenance Climate")

###


#NFFD

#without Gila 
surv2014_NFFD_mod_nog <- glmmTMB(cbind(alive,died) ~ transfer + (1|Provenance)+(1|BLK) , data=survival14_transfer %>% filter(name=="NFFD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_NFFD_mod_nog)

surv2014_NFFD_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ transfer, data=survival14_transfer %>% filter(name=="NFFD") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_NFFD_data_nog <- survival14_transfer %>% filter(name=="NFFD") %>% filter(!Provenance=="Gila NF")

surv2014_NFFD_nog_newdata1 <- expand.grid(transfer = seq(min(surv2014_NFFD_data_nog$transfer),max(surv2014_NFFD_data_nog$transfer),length.out=50))

surv2014_NFFD_nog_newdata2 <- cbind(surv2014_NFFD_nog_newdata1, predict(surv2014_NFFD_mod_nog_glm, newdata = surv2014_NFFD_nog_newdata1, type = "link", se=TRUE))
surv2014_NFFD_nog_newdata3 <- within(surv2014_NFFD_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

nffd_surv14_plot<- ggplot(surv2014_NFFD_nog_newdata3, aes(x = transfer, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
    geom_vline(xintercept = 0, color="black", linetype=2)+
    geom_rug(data=survival14_transfer %>% filter(name=="NFFD") %>% filter(!Provenance=="Gila NF") %>%  mutate(fit=0.7), aes(x=transfer,y=fit), linewidth=1, sides="b")+
    ylim(c(0.5,1))+
  xlab("NFFD transfer")+
      ylab("Predicted Probability of Survival")+
  theme_bw()
#########
#########

#smrpb
#without Gila is still significant
surv2014_smrpb_mod_nog <- glmmTMB(cbind(alive,died) ~ transfer + (1|Provenance)+(1|BLK) , data=survival14_transfer %>% filter(name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_smrpb_mod_nog)

surv2014_smrpb_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ transfer , data=survival14_transfer %>% filter(name=="smrpb") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_smrpb_data_nog <- survival14_transfer %>% filter(name=="smrpb") %>% filter(!Provenance=="Gila NF")

surv2014_smrpb_nog_newdata1 <- expand.grid(transfer = seq(min(surv2014_smrpb_data_nog$transfer),max(surv2014_smrpb_data_nog$transfer),length.out=50),
                                 Provenance = "Pike NF",
                                 BLK = "C",
                                 year=2006)

surv2014_smrpb_nog_newdata2 <- cbind(surv2014_smrpb_nog_newdata1, predict(surv2014_smrpb_mod_nog_glm, newdata = surv2014_smrpb_nog_newdata1, type = "link", se=TRUE))
surv2014_smrpb_nog_newdata3 <- within(surv2014_smrpb_nog_newdata2, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

smrpb_surv14_plot<- ggplot(surv2014_smrpb_nog_newdata3, aes(x = transfer, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
    geom_vline(xintercept = 0, color="black", linetype=2)+
      geom_rug(data=survival14_transfer %>% filter(name=="smrpb") %>% filter(!Provenance=="Gila NF") %>%  mutate(fit=0.7), aes(x=transfer,y=fit), linewidth=1, sides="b")+
  ylim(c(0.5,1))+
  xlab("Summer:Spring Precip transfer")+
  ylab("Predicted Probability of Survival")+
  theme_bw()
#########


###quadratic

surv2014_mods_quad<- data.frame()

for(i in 1:length(transfer_vars)){
mod <- glmmTMB(cbind(alive,died) ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK) , data=survival14_transfer %>% filter(name==transfer_vars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- glmmTMB(cbind(alive,died) ~ transfer + I(transfer^2) + (1|Provenance) + (1|BLK), data=survival14_transfer %>% filter(name==transfer_vars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2:3,]$`Pr(>|z|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

surv2014_mods_quad <- bind_rows(surv2014_mods_quad, data.frame(var=transfer_vars[i], pvalue1 = pvalues[1], pvalue2 = pvalues[2], Mr2 = Mr2, pvalue1_nog = pvalues_nog[1], pvalue2_nog = pvalues_nog[2], Mr2_nog = Mr2_nog))

}

surv2014_mods_quad %>% arrange(pvalue2_nog) ##CMD

###create data frame with coefficients of the significant models
surv2014_quad_sigvars <-surv2014_mods_quad %>% filter(pvalue2_nog<0.05) %>% pull(var)

surv_quadmods_2014_coeffs<- data.frame()
surv_quadmods_2014_coeffs_nog <- data.frame()
for(i in 1:length(surv2014_quad_sigvars)){
mod <- glmmTMB(cbind(alive,died) ~ scale(transfer) + I(scale(transfer)^2) + (1|Provenance) + (1|BLK) , data=survival14_transfer %>% filter(name==surv2014_quad_sigvars[i]), family="binomial")
pvalues<- as.data.frame(summary(mod)$coefficients$cond)[2:3,]$`Pr(>|z|)`
estimate <- confint(mod)[3,3]
lwr <- confint(mod)[3,1]
upr <- confint(mod)[3,2]

mod_nog <- glmmTMB(cbind(alive,died) ~ scale(transfer) + I(scale(transfer)^2) + (1|Provenance) + (1|BLK), data=survival14_transfer %>% filter(name==surv2014_quad_sigvars[i]) %>% filter(!Provenance=="Gila NF"), family="binomial")
pvalues_nog<- as.data.frame(summary(mod_nog)$coefficients$cond)[2:3,]$`Pr(>|z|)`
estimate_nog <- confint(mod_nog)[3,3]
lwr_nog <- confint(mod_nog)[3,1]
upr_nog <- confint(mod_nog)[3,2]

surv_quadmods_2014_coeffs <- bind_rows(surv_quadmods_2014_coeffs, data.frame(var=paste0(surv2014_quad_sigvars[i],"^2"), p.value1 = pvalues[1], p.value2 = pvalues[2], estimate = estimate, lwr = lwr, upr = upr, model = "with Gila NF"))
surv_quadmods_2014_coeffs_nog <- bind_rows(surv_quadmods_2014_coeffs_nog, data.frame(var=paste0(surv2014_quad_sigvars[i],"^2"), p.value1 = pvalues_nog[1], p.value2 = pvalues_nog[2], estimate = estimate_nog, lwr = lwr_nog, upr = upr_nog, model="without Gila NF"))
}

surv_mods_2014_coeffs_all<- bind_rows(surv_mods_2014_coeffs, surv_mods_2014_coeffs_nog,surv_quadmods_2014_coeffs,surv_quadmods_2014_coeffs_nog)

surv2014_provclim_coef_plot <- ggplot(surv_mods_2014_coeffs_all, aes(y = factor(var), x=estimate, color=model))+
  ylab("")+
  geom_errorbar(aes(xmin=lwr, xmax=upr), linewidth=1, width=0.5, alpha=0.5,position = position_dodge(width=1))+
  geom_point(size=3, alpha=0.5, position = position_dodge(width=1))+
  geom_vline(xintercept=0, linewidth=1)+
  theme_bw()+
  ggtitle("2014 Survival - Provenance Climate")


##CMD
#without Gila 
surv2014_CMD_mod_nog <- glmmTMB(cbind(alive,died) ~ scale(transfer) + I(scale(transfer)^2) + (1|Provenance) + (1|BLK), data=survival14_transfer %>% filter(name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")
summary(surv2014_CMD_mod_nog)
r2(surv2014_CMD_mod_nog)

surv2014_CMD_mod_nog_glm <- glmmTMB(cbind(alive,died) ~ scale(transfer) + I(scale(transfer)^2), data=survival14_transfer %>% filter(name=="CMD") %>% filter(!Provenance=="Gila NF"), family="binomial")

##predictions
surv2014_CMD_newdata1_nog <- expand.grid(transfer = seq(min(survival14_transfer %>% filter(name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(transfer)),max(survival14_transfer %>% filter(name=="CMD") %>% filter(!Provenance=="Gila NF") %>% pull(transfer)),length.out=50))

surv2014_CMD_newdata2_nog <- cbind(surv2014_CMD_newdata1_nog, predict(surv2014_CMD_mod_nog_glm, newdata = surv2014_CMD_newdata1_nog, type = "link", se=TRUE))
surv2014_CMD_newdata3_nog <- within(surv2014_CMD_newdata2_nog, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

cmd2_surv14_plot<- ggplot(surv2014_CMD_newdata3_nog, aes(x = transfer, y = PredictedProb)) + geom_ribbon(aes(ymin = LL,
    ymax = UL), alpha = 0.2) + 
  geom_line(linewidth = 1)+
  geom_vline(xintercept = 0, color="black", linetype=2)+
      geom_rug(data=survival14_transfer %>% filter(name=="CMD") %>% filter(!Provenance=="Gila NF") %>%  mutate(fit=0.7), aes(x=transfer,y=fit), linewidth=1, sides="b")+
    ylim(c(0.5,1))+
  xlab("CMD transfer")+
    ylab("Predicted Probability of Survival")+
  theme_bw()
#########

ggarrange(cmd2_surv14_plot,smrpb_surv14_plot,nffd_surv14_plot, pcadist2d_relht_plot, ncol=2, nrow=2, labels=c("A)","B)","C)","D)"))
```

##Means figure

```{r}
recent_means<- survival_means %>% filter(year==2014) %>% dplyr::select(Provenance, prop.surv.since.1970) %>% 
  left_join(ht_data_aves_forfig %>% ungroup() %>% filter(name=="HT14") %>% dplyr::select(Provenance, meantotht, seTH)) %>% 
  left_join(dbh_aves %>% filter(year==2014) %>% dplyr::select(Provenance, meanDBH, se_DBH)) %>% 
  left_join(cone_sum_forfig %>% filter(year==2006) %>% dplyr::select(Provenance, prop.w.cones)) %>% 
  pivot_longer(c(prop.surv.since.1970,meantotht,meanDBH,prop.w.cones)) %>% 
  mutate(seTH = ifelse(name=="meantotht", seTH, NA), se_DBH = ifelse(name=="meanDBH", se_DBH, NA)) %>% 
  mutate(name = case_when(name=="meanDBH" ~ "DBH (cm) - 2014",
                          name=="meantotht" ~ "Height (m) - 2014",
                          name=="prop.surv.since.1970" ~ "Proportion Survival 1970 - 2014",
                          name=="prop.w.cones" ~ "Proportion with Cones - 2006")) 

ggplot(recent_means, aes(x=factor(Provenance, levels=provs_bylat$Provenance, labels=provs_bylat$code), y=value, col=factor(Provenance, levels=provs_bylat$Provenance, labels=provs_bylat$code)))+
  geom_point(size=3)+
  geom_errorbar(aes(ymax=value+se_DBH, ymin=value-se_DBH))+
  geom_errorbar(aes(ymax=value+seTH, ymin=value-seTH))+
  facet_wrap(~name, scales="free_y")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  xlab("Provenance")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.title.y=element_blank())
  
 
```

##RWI

Cores were only taken from one tree from each provenance in each block, therefore we do not include block as a random effect in these models. 

###Raw

```{r}
prov_all <- read.rwl("C:/Users/KatherineNigro/Box/Engelmann Spruce Provenance/Standardized_ring_widths/ARSTAN_output/prov_all.rwl")

rwi.stats(prov_all)
```

####exploration
```{r}
#plot raw data to look at timeseries length
par(mfrow=c(1,1))
plot.rwl(prov_all)

##compare timing of when trees reached 30cm tall (and thus had a growth ring measured)
dbh_age <- prov_all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(prov_all)) %>% 
  pivot_longer(!year, values_to = "rw", names_to="tree") %>% 
  left_join(moniger_data_comb %>% mutate(tree=paste(LOC,BLK,REP,sep="")), by="tree")
  
dbh_age_summary <- dbh_age %>%
  filter(!is.na(rw)) %>% 
  group_by(Provenance,tree) %>% 
  summarise(minyr = as.numeric(min(year)), maxyr=as.numeric(max(year)), n=n()) %>% 
  mutate(years.calc = maxyr-minyr+1)

#compare when time series started (min year)
ggplot(dbh_age_summary, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=minyr))+
  geom_boxplot()+
  geom_point(color="maroon")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

#compare length of timeseries
ggplot(dbh_age_summary, aes(x=Provenance, y=n))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

dbh_age_summary2 <- dbh_age_summary %>% 
  left_join(dbh, by=c("tree"="Series","Provenance")) 

ggplot(dbh_age_summary2, aes(x=minyr, y=DBH14, col=Provenance))+
  geom_point() #there isn't a strong correlation between dbh and the length of the timeseries which makes me think that rings were just lost (not that the tree didn't reach DBH height until the min year)
###

##remove NAs from ring width series
prov_all_nona<- prov_all %>% na.omit()
colnames(prov_all_nona)

##raw
ggplot(dbh_age, aes(x=year, y=rw, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance)+
  theme(legend.position = "none")

###investigating series with really low ring width values
dbh_rwi_comp <- dbh_age %>% 
  filter(!tree=="32A1") %>% 
  group_by(Provenance, tree) %>% 
  summarise(sum=sum(rw, na.rm = TRUE)) %>% 
  arrange(tree) %>% 
  bind_cols(dbh %>%
              filter(Series %in% unique(dbh_age$tree)) %>% 
              dplyr::select(-Provenance) %>% 
              arrange(Series) %>% 
  filter(!is.na(DBH14))) %>% 
  mutate(lowsum=ifelse(sum<15,"yes","no"))

dbh_rwi_comp %>% 
  filter(lowsum=="yes")

ggplot(dbh_rwi_comp)+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))

ggplot(dbh_rwi_comp %>% mutate(sum=ifelse(sum<15,sum*10,sum)))+
  geom_point(aes(x=sum, y=DBH14, col=lowsum))+
  geom_abline(slope=1/10,intercept = 0) ##seems like these "low sum" ring measurements are off by a factor of 10
###########
```

####remove bad data

```{r}
#find series that are likely off by an order of magnitude
off_trees<- dbh_rwi_comp %>% 
  filter(lowsum=="yes") %>% pull(tree) %>% c("58A4") #this is the weird tree that's half and half

prov_good_nona <- prov_all_nona %>% dplyr::select(-all_of(off_trees))

###this cuts out sketchy trees and year = 2016
prov_good <- prov_all %>% dplyr::select(-all_of(off_trees)) %>% 
  filter(!row.names(prov_all)=="2016")

#ring width series statistics
par(mfrow=c(1,1))
plot(prov_good, plot.type="spag")
rwl.report(prov_good)
prov_good_stats<- summary(prov_good)
summary(prov_good_stats$ar1)

##some plots of the raw data averaged
dbh_age_good <- dbh_age %>% 
  filter(!tree %in% off_trees)

ave_rw_all <- dbh_age_good %>%
  na.omit() %>% 
  group_by(year) %>% 
  summarise(ave_rw=mean(rw), se=sd(rw)/sqrt(n()))

plantation_aet_sum<- plantation_cwd %>% 
  group_by(year) %>% 
  summarise(aet_sum=sum(aet)) %>% 
  mutate(aet_scale=scale(aet_sum))

ggplot(ave_rw_all, aes(x=as.numeric(year), y=ave_rw))+
  geom_bar(data=plantation_aet_sum, aes(x=as.numeric(year), y=aet_scale), stat="identity")+
  geom_point()+
  geom_errorbar(aes(x=as.numeric(year), ymin=(ave_rw-se), ymax=(ave_rw+se)), col="red")+
  geom_line()
### it seems like the major deviation in the data is in response to the wet period right before the drought, rather than the 2002 drought. 

```

###Detrending

```{r}
##detrending with Spline method - using stiffness of 35 years
##need to figure out what age to start at based on how long the "young tree growth spurt" usually takes

growth.detrended.all = matrix(nrow=nrow(prov_good), ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.all[,i]<- obj
}
colnames(growth.detrended.all) = colnames(prov_good)
rownames(growth.detrended.all) = rownames(prov_good)

rwi.stats(growth.detrended.all, period="max")
chron(growth.detrended.all)
plot(chron(growth.detrended.all), add.spline=TRUE, nyrs=35)
sss(growth.detrended.all)

growth.detrended.df.all <- growth.detrended.all %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.all)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree")

ggplot(growth.detrended.df.all, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

##remove first 15 years of ring widths since they are missing for many trees and likely represent unusual growth patterns. 
growth.detrended.short = matrix(nrow=nrow(prov_good)-15, ncol=length(colnames(prov_good)))
for(i in 1:length(prov_good)){
obj<- detrend.series(y = prov_good %>% filter(!(row.names(prov_good) < 1985))  %>%  pull(colnames(prov_good)[i]), y.name="growth", method="Spline", nyrs = 35)
growth.detrended.short[,i]<- obj
}
colnames(growth.detrended.short) = colnames(prov_good)
rownames(growth.detrended.short) = rownames(prov_good)[16:nrow(prov_good)]

rwi.stats(growth.detrended.short, period="max")
plot(chron(growth.detrended.short), add.spline=TRUE, nyrs=35)
sss(growth.detrended.short)
sens1(growth.detrended.short[,1])

##########

growth.detrended.df <- growth.detrended.short %>% 
  as.data.frame() %>% 
  mutate(year = rownames(growth.detrended.short)) %>% 
  pivot_longer(!year, values_to = "rw_spline", names_to="tree") %>% 
  mutate(tree=paste("X",tree,sep=""), year=as.integer(year)) %>% 
  left_join(dbh %>% mutate(tree=paste("X",Series,sep="")), by="tree") %>% 
  mutate(period=ifelse(year<2000, "early", "late"))

ggplot(growth.detrended.df, aes(x=year, y=rw_spline, col=tree))+
  geom_line()+
  geom_point()+
  facet_wrap(~Provenance, scales = "free")+
  theme(legend.position = "none")

growth.detrended.byprov <- growth.detrended.df %>% 
  group_by(Provenance,year) %>% 
  summarise(meanrwi = mean(rw_spline, na.rm=T), se=sd(rw_spline,na.rm=T)/sqrt(n()))

plantation_clim_cut <- plantation_aet_sum %>% 
  filter(year>1984 & year < 2016)

plantation_clim_cut<- plantation_clim_cut %>% 
  mutate(aet_scale_1 = 2*((plantation_clim_cut$aet_sum  - min(plantation_clim_cut$aet_sum )) / (max(plantation_clim_cut$aet_sum) - min(plantation_clim_cut$aet_sum))) - 1)

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_clim_cut, aes(x=year, y=aet_scale_1), stat="identity")+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="AET (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())

ggplot(growth.detrended.df, aes(x=factor(Provenance,levels=provs_bylat$Provenance), y=rw_spline, fill=period))+
  geom_boxplot()+
  theme(axis.text.x=element_text(angle=45))

rwi_byyear<- growth.detrended.df %>% 
  group_by(year) %>% 
  summarise(mean.rwi = mean(rw_spline, na.rm=TRUE)) 
```

####Gini coefficient

```{r}
trees<- unique(growth.detrended.df$tree)

Gini(growth.detrended.df %>% filter(tree==trees[1]) %>% pull(rw_spline), weights=NULL, unbiased = TRUE, conf.level=.95, R=10000, type="bca", na.rm=TRUE)

###get time period with all trees included in all years (common period)
gini_df = data.frame()
for(i in 1:length(trees)){
gini = growth.detrended.df %>% filter(year > 1990 & year < 2011) %>% filter(tree==trees[i]) %>% pull(rw_spline) %>% 
  Gini(weights=NULL, unbiased = TRUE, conf.level=0.95, R=10000, type="perc", na.rm=TRUE)
gini_df = bind_rows(gini_df, data.frame(gini=gini[1], lwr = gini[2], upr=gini[3], tree=trees[i]))
}

gini_byprov<- gini_df %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(tree,BLK,Provenance,HT14,DBH14) %>% unique(), by="tree")

ggplot(gini_byprov, aes(x=factor(Provenance, levels = provs_bylat$Provenance), y=gini, fill=factor(Provenance, levels = provs_bylat$Provenance)))+
  geom_boxplot()+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  ylab("Gini coefficient")+
  xlab("Provenance")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1), legend.position = "none",
        axis.title = element_text(size=12, color="black"), axis.text = element_text(size = 12, color="black"))

gini_sum<- gini_byprov %>% 
  group_by(Provenance) %>% 
  summarise(mean=mean(gini), sd=sd(gini), se=sd(gini)/sqrt(n()))

gini_plot<- ggplot(gini_sum, aes(x=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code), y=mean, fill=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code), color=factor(Provenance, levels = provs_bylat$Provenance, labels=provs_bylat$code)))+
  geom_point(size=3)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), linewidth=1, width=0.5)+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_y_continuous(breaks=c(0.1,0.2))+
  geom_text(aes(x="DNF", y=0.19, label="p = 0.06"), col="black", size=4)+
  ylab("Gini coefficient")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=8), legend.position = "none",
        axis.title = element_text(color="black"), axis.text = element_text(color="black"), axis.title.x = element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())

plantation_vpd_scaled <- plantation_clim %>% 
  dplyr::select(c(year, prior_vpdmax_wt))%>% 
  filter(year>1984 & year < 2016) %>% 
  mutate(vpdmax_scale_1 = 2*((prior_vpdmax_wt  - min(prior_vpdmax_wt)) / (max(prior_vpdmax_wt) - min(prior_vpdmax_wt))) - 1) %>% 
  mutate(vpdmax_scale.5 = 1*((prior_vpdmax_wt  - min(prior_vpdmax_wt)) / (max(prior_vpdmax_wt) - min(prior_vpdmax_wt))) - .5) %>% 
  mutate(droughtyr = ifelse(year==2002, "yes","no"))

plantation_ppt_sm_scaled <- plantation_clim %>% 
  dplyr::select(c(year, ppt_sm))%>% 
  filter(year>1984 & year < 2016) %>% 
  mutate(ppt_sm_scale_1 = 2*((ppt_sm  - min(ppt_sm)) / (max(ppt_sm) - min(ppt_sm))) - 1) %>% 
  mutate(droughtyr = ifelse(year==2002, "yes","no"))


rwi_gini_plot<- ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale_1, fill=droughtyr), stat="identity")+
  #geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale_1), stat="identity", fill="gray20")+
  scale_fill_manual(values=c("gray20","red"), name="Drought Year")+
  ggnewscale::new_scale_fill()+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="Winter VPDmax (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())+
  annotation_custom(ggplotGrob(gini_plot), xmin=1983, xmax=1997, ymin=0.35, ymax=1.1)

png("figures/rwi_gini_plot.png", width=11,height=7, unit="in", res=300)
rwi_gini_plot
dev.off()

##make figure 4 simpler
gini_sum

ggplot(growth.detrended.byprov, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale.5, color=droughtyr), stat="identity", fill=NA)+
  #geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale_1), stat="identity", fill="gray20")+
  scale_color_manual(values=c("gray20","red"), name="Drought Year")+
  ggnewscale::new_scale_color()+
  geom_point(aes( col=factor(Provenance, levels=provs_bylat$Provenance)), size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-se-1, ymax=meanrwi+se-1, fill=factor(Provenance, levels=provs_bylat$Provenance)), alpha=0.3)+
  scale_y_continuous(name="Winter VPDmax (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_line(aes(col=factor(Provenance, levels=provs_bylat$Provenance)), linewidth=1)+
  geom_hline(yintercept=0, linetype=1)+
  geom_text(data=gini_sum, x=2013, y=0.7, aes(label=paste0("gini = ", round(mean,2))))+
  facet_wrap(~factor(Provenance, levels=provs_bylat$Provenance))+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank(), strip.text = element_text(size=12, color="black"))

growth.detrended.ave <- growth.detrended.df %>% 
  group_by(year) %>% 
  summarize(meanrwi = mean(rw_spline, na.rm=T), sd=sd(rw_spline, na.rm=T))

ggplot(growth.detrended.ave, aes(x=year, y=meanrwi-1))+
  geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale_1, color=droughtyr), stat="identity", fill=NA)+
  #geom_bar(data=plantation_vpd_scaled, aes(x=year, y=vpdmax_scale_1), stat="identity", fill="gray20")+
  scale_color_manual(values=c("gray20","red"), name="Drought Year")+
  geom_point(size=2)+
  geom_ribbon(aes(x=year, ymin=meanrwi-sd-1, ymax=meanrwi+sd-1), alpha=0.3)+
  scale_y_continuous(name="Winter VPDmax (scaled)", sec.axis = sec_axis(~.+1, name="RWI"))+
  geom_line(linewidth=1)+
  geom_hline(yintercept=0, linetype=2)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=10), axis.title = element_text(color="black", size=12), panel.grid = element_blank())

##ANOVA

gini_provmod <- lmer(log(gini) ~ Provenance + (1|BLK), data=gini_byprov)
plot(gini_provmod)
qqmath(gini_provmod)
anova(gini_provmod)

gini_marg = lsmeans(gini_provmod, ~ Provenance)

CLD_gini = cld(gini_marg,
          alpha=0.05,
          Letters=letters)
CLD_gini #payette greater than 12, gila less than 10


mean(gini_byprov$gini)
sd(gini_byprov$gini)

##Model with climate as a predictor
gini_clim_df <- gini_byprov %>% 
  left_join(prov_pcapts_big) 

#MAT
gini_byMAT <- lmer(log(gini) ~ MAT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMAT)
qqmath(gini_byMAT)
summary(gini_byMAT)

#map
gini_bymap <- lmer(log(gini) ~ MAP+ (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bymap)
qqmath(gini_bymap)
summary(gini_bymap)

#TD
gini_byTD <- lmer(log(gini) ~ TD + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byTD)
qqmath(gini_byTD)
summary(gini_byTD)

#MCMT
gini_byMCMT <- lmer(log(gini) ~ MCMT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMCMT)
qqmath(gini_byMCMT)
summary(gini_byMCMT)

#MSP
gini_byMSP <- lmer(log(gini) ~ MSP + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMSP)
qqmath(gini_byMSP)
summary(gini_byMSP)

#SHM
gini_bySHM <- lmer(log(gini) ~ SHM + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bySHM)
qqmath(gini_bySHM)
summary(gini_bySHM)

#NFFD
gini_byNFFD <- lmer(log(gini) ~ NFFD + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byNFFD)
qqmath(gini_byNFFD)
summary(gini_byNFFD)

#bFFP
gini_bybFFP <- lmer(log(gini) ~ bFFP + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bybFFP)
qqmath(gini_bybFFP)
summary(gini_bybFFP)

#eFFP
gini_byeFFP <- lmer(log(gini) ~ eFFP + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byeFFP)
qqmath(gini_byeFFP)
summary(gini_byeFFP)

#MWMT
gini_byMWMT <- lmer(log(gini) ~ MWMT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byMWMT)
qqmath(gini_byMWMT)
summary(gini_byMWMT)

#dd_0
gini_bydd_0 <- lmer(log(gini) ~ DD0 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bydd_0)
qqmath(gini_bydd_0)
summary(gini_bydd_0)

#dd5
gini_bydd5 <- lmer(log(gini) ~ DD5 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bydd5)
qqmath(gini_bydd5)
summary(gini_bydd5)

#EMT
gini_byEMT <- lmer(log(gini) ~ EMT + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byEMT)
qqmath(gini_byEMT)
summary(gini_byEMT)

#cmd
gini_bycmd <- lmer(log(gini) ~ CMD + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bycmd)
qqmath(gini_bycmd)
summary(gini_bycmd)

#pas
gini_bypas <- lmer(log(gini) ~ PAS + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_bypas)
qqmath(gini_bypas)
summary(gini_bypas)

#smrpb
gini_bysmrpb <- lmer(log(gini) ~ smrpb + (1|Provenance) + (1|BLK), data=gini_clim_df %>% filter(!Provenance=="Gila NF"))
plot(gini_bysmrpb)
qqmath(gini_bysmrpb)
summary(gini_bysmrpb) ##only significant with Gila included

#PC1
gini_byPC1 <- lmer(log(gini) ~ PC1 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byPC1)
qqmath(gini_byPC1)
summary(gini_byPC1)
#PC2
gini_byPC2 <- lmer(log(gini) ~ PC2 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byPC2)
qqmath(gini_byPC2)
summary(gini_byPC2) 
#PC3
gini_byPC3 <- lmer(log(gini) ~ PC3 + (1|Provenance) + (1|BLK), data=gini_clim_df)
plot(gini_byPC3)
qqmath(gini_byPC3)
summary(gini_byPC3)
gini_byPC3_nog <- lmer(log(gini) ~ PC3 + (1|Provenance) + (1|BLK), data=gini_clim_df %>% filter(!Provenance=="Gila NF"))
summary(gini_byPC3_nog)


###see if gini coefficient is related to survival and growth
tree_data_all <- growth.detrended.df %>% 
  dplyr::select(c(tree,SORT,LOC,BLK,REP)) %>% 
  left_join(moniger_data_comb, by=c("SORT","LOC","BLK","REP"))

gini_all_data<- gini_byprov %>% 
  left_join(unique(tree_data_all))

gini_dbh14_mod <- lmer(DBH14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!is.na(DBH14)))
plot(gini_dbh14_mod)
qqmath(gini_dbh14_mod)
summary(gini_dbh14_mod)

gini_dbh14_mod_nog <- lmer(DBH14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!Provenance=="Gila NF") %>% filter(!is.na(DBH14)))
summary(gini_dbh14_mod_nog)

##predict
newdata_gini_dbh = data.frame(gini=seq(min(gini_all_data$gini), max(gini_all_data$gini),.01))

gini_dbh14_mod_lm <- lm(DBH14 ~ gini, data=gini_all_data %>% filter(!is.na(DBH14)))
predict_gini_dbh = data.frame(gini=newdata_gini_dbh,predict(gini_dbh14_mod_lm, newdata_gini_dbh, interval="confidence"))

ggplot(predict_gini_dbh, aes(x=gini, y=fit))+
  geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.3)+
  geom_line()+
  ylab("DBH (cm)")+
  xlab("Gini coefficient")+
  theme_bw()

gini_ht14_mod <- lmer(HT14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!is.na(HT14)))
plot(gini_ht14_mod)
qqmath(gini_ht14_mod)
summary(gini_ht14_mod)

gini_ht14_mod_nog <- lmer(HT14 ~ gini + (1|code) + (1|BLK), data=gini_all_data %>% filter(!Provenance=="Gila NF") %>%  filter(!is.na(HT14)))
summary(gini_ht14_mod_nog)

##predict
newdata_gini_ht = data.frame(gini=seq(min(gini_all_data$gini), max(gini_all_data$gini),.01))

gini_ht14_mod_lm <- lm(HT14 ~ gini, data=gini_all_data %>% filter(!is.na(HT14)))
predict_gini_ht = data.frame(gini=newdata_gini_ht,predict(gini_ht14_mod_lm, newdata_gini_ht, interval="confidence"))

ggplot(predict_gini_ht, aes(x=gini, y=fit))+
  geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.3)+
  geom_line()+
  ylab("Height (m)")+
  xlab("Gini coefficient")+
  theme_bw()


gini_surv_df<- moniger_survival_byyr_zeros %>% 
  filter(year==2014) %>% 
  mutate(tree=paste0("X",LOC,BLK,REP)) %>% 
  right_join(gini_byprov)
  
gini_surv14_mod <- glmmTMB(value ~ gini + (1|BLK), data=gini_surv_df, family=binomial(link="logit"))
summary(gini_surv14_mod) #not significant
r2(gini_surv14_mod)

gini_surv14_mod_nog <- glmmTMB(value ~ gini + (1|BLK), data=gini_surv_df %>% filter(!Provenance=="Gila NF"), family=binomial(link="logit"))
summary(gini_surv14_mod_nog)

```

 ###Resistance vs. Resilience

####long pre-drought

```{r}
###calculate resistance using all growth data from 1985 - 2001 as the pre-drought period
drought_new<- growth.detrended.df %>% 
  filter(year %in% c(2002,2003)) %>% 
  group_by(tree) %>% 
  summarise(drought_ave= mean(rw_spline))

predrought_new<- growth.detrended.df %>% 
  filter(year > 1984 & year <2002) %>% 
  group_by(tree) %>% 
  summarise(predrought_ave= mean(rw_spline, na.rm=T))

postdrought_new<- growth.detrended.df %>% 
  filter(year > 2003) %>% 
  group_by(tree) %>% 
  summarise(postdrought_ave= mean(rw_spline, na.rm=T))

#resistance
new_calcs <- left_join(drought_new,predrought_new) %>% left_join(postdrought_new) %>% 
  mutate(resistance = drought_ave/predrought_ave, resilience = postdrought_ave/predrought_ave) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(tree,Provenance,BLK) %>% unique(), by="tree")

mean(new_calcs$resistance);sd(new_calcs$resistance)
mean(new_calcs$resilience);sd(new_calcs$resilience)
new_calcs %>% filter(Provenance=="Gila NF") %>% pull(resilience) %>% mean()

new_aov_resist <- lmer(resistance ~ Provenance + (1|BLK), data=new_calcs)
plot(new_aov_resist)
qqmath(new_aov_resist)
anova(new_aov_resist) #no difference in resistance when compared to average growth 1985-2001

RR_prov_mean<- new_calcs %>% 
  group_by(Provenance) %>% 
  summarise(mean.resistance = mean(resistance), sd.resistance=sd(resistance),
            mean.resilience = mean(resilience), sd.resilience=sd(resilience)) %>% 
  mutate(resistance = paste0(round(mean.resistance,2)," (", round(sd.resistance,2), ")"),
         resilience = paste(round(mean.resilience,2), " (", round(sd.resilience,2), ")")) %>% 
  left_join(provs_bylat)

write.csv(RR_prov_mean, "RR_prov_mean.csv")

ggplot(new_calcs, aes(x=Provenance, y=resistance))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

R8502_clim <- new_calcs %>% 
  left_join(prov_pcapts_big)

R8502_clim_long<- R8502_clim %>% 
  pivot_longer(all_of(provenance_climvars))
R8502_clim_long_nog <- R8502_clim_long %>% filter(!Provenance=="Gila NF")

R8502_resis_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resistance) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

R8502_resis_mods <- bind_rows(R8502_resis_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

R8502_resis_mods %>% arrange(pvalue_nog) #nothing significant

resis_pc_mod <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim)
plot(resis_pc_mod)
qqmath(resis_pc_mod)
summary(resis_pc_mod)

R8502_clim_nog <- R8502_clim %>% filter(!Provenance=="Gila NF")

resis_pc_mod_nog <- lmer(log(resistance) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim_nog)
plot(resis_pc_mod_nog)
qqmath(resis_pc_mod_nog)
summary(resis_pc_mod_nog)

dredge(resis_pc_mod_nog) #null is best


####resilience

new_aov_resil <- lmer(resilience ~ Provenance + (1|BLK), data=new_calcs)
plot(new_aov_resil)
qqmath(new_aov_resil)
anova(new_aov_resil) #significant difference in resilience when compared to average growth 1985-2002
cld(lsmeans(new_aov_resil, ~Provenance),
          alpha=0.05,
          Letters=letters) #just Gila is different

ggplot(new_calcs, aes(x=Provenance, y=resilience))+
  geom_boxplot()+
  geom_point()+
  geom_hline(yintercept=1, col="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

R8502_resil_mods<- data.frame()
for(i in 1:length(provenance_climvars)){
mod <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long %>% filter(name==provenance_climvars[i]))
pvalue<- as.data.frame(summary(mod)$coefficients)[2,]$`Pr(>|t|)`
Mr2 <- r2(mod)$R2_marginal

mod_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long_nog %>% filter(name==provenance_climvars[i]))
pvalue_nog<- as.data.frame(summary(mod_nog)$coefficients)[2,]$`Pr(>|t|)`
Mr2_nog <- r2(mod_nog)$R2_marginal

R8502_resil_mods <- bind_rows(R8502_resil_mods, data.frame(var=provenance_climvars[i], pvalue = pvalue, Mr2=Mr2, pvalue_nog = pvalue_nog, Mr2_nog=Mr2_nog))
}

R8502_resil_mods %>% arrange(pvalue_nog) #MCMT significant both with and without Gila.

#mcmt
mcmt_R8502_resil_nog <- lmer(log(resilience) ~ value + (1|Provenance)+ (1|BLK), data=R8502_clim_long_nog %>% filter(name=="MCMT"))
plot(mcmt_R8502_resil_nog)
qqmath(mcmt_R8502_resil_nog)
summary(mcmt_R8502_resil_nog)

resil_pc_mod <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim)
plot(resil_pc_mod)
qqmath(resil_pc_mod)
summary(resil_pc_mod) #provenances with warmer winters had better resilience to the drought, or just grow better in the post-drought period because the temps at the plantation have warmed.

R8502_clim_nog <- R8502_clim %>% filter(!Provenance=="Gila NF")

resil_pc_mod_nog <- lmer(log(resilience) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance)+ (1|BLK), data=R8502_clim_nog)
plot(resil_pc_mod_nog)
qqmath(resil_pc_mod_nog)
summary(resil_pc_mod_nog)

dredge(resil_pc_mod_nog) #null is best

```


####recovery time
```{r}
#####recovery time 

no_reduction_02<- growth.detrended.df %>% 
  filter(year == 2002) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff<0) ##50 trees didn't reduce growth in 2002

no_reduction_03<- growth.detrended.df %>% 
  filter(year == 2003) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff<0) ##29 trees didn't reduce growth in 2003

count_no_red_02<- growth.detrended.df %>%
  filter(year==2002) %>% 
  group_by(Provenance) %>% 
  summarise(ntrees=n()) %>% 
  left_join(no_reduction_02 %>% group_by(Provenance) %>% summarise(nNR=n()))

ggplot(count_no_red_02, aes(x=Provenance, y=(nNR/ntrees)*100))+
  geom_bar(stat="identity", fill="red")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

count_no_red_03<- growth.detrended.df %>%
  filter(year==2003) %>% 
  group_by(Provenance) %>% 
  summarise(ntrees=n()) %>% 
  left_join(no_reduction_03 %>% group_by(Provenance) %>% summarise(nNR=n()))

ggplot(count_no_red_03, aes(x=Provenance, y=(nNR/ntrees)*100))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle=45, hjust=1))

reduction_either <- growth.detrended.df %>% 
  filter(year == 2002) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
  filter(diff>0) %>% 
  bind_rows(growth.detrended.df %>% 
  filter(year == 2003) %>%
  left_join(predrought_new) %>% 
  mutate(diff = predrought_ave- rw_spline) %>% 
    filter(diff>0)) %>% 
  pull(tree) %>% 
  unique()

no_reduction <- growth.detrended.df %>% 
  filter(!tree %in% reduction_either) %>% 
  pull(tree) %>% 
  unique()
  
length(unique(reduction_either))
length(no_reduction)
length(unique(growth.detrended.df$tree))
120/137
17/137

recover_time<- growth.detrended.df %>%
  filter(tree %in% reduction_either) %>% 
  filter(year > 2003) %>%
  left_join(predrought_new) %>% 
  mutate(diff = rw_spline - predrought_ave) %>% 
  filter(diff>0) %>% 
  group_by(tree) %>% 
  summarise(minyr = min(year)) %>% 
  mutate(recoverytime = as.numeric(minyr) - 2003) %>% 
  left_join(dbh_age %>% mutate(tree=paste0("X",tree)) %>% dplyr::select(tree,Provenance,BLK) %>% unique(), by="tree")

aov.recover <- lmer(log(recoverytime) ~ Provenance + (1|BLK), data=recover_time)
plot(aov.recover)
qqmath(aov.recover)
anova(aov.recover)  #no difference in recovery time

ggplot(recover_time, aes(x=Provenance, y=recoverytime))+
  geom_boxplot()+
  geom_point()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##climate model for recovery time
recover_time_clim <- recover_time %>% 
  left_join(prov_pcapts_big)

recov_mod_pca <- lmer(log(recoverytime) ~ PC1*PC2 + I(PC1^2) + I(PC2^2) + (1|Provenance), data=recover_time_clim)
plot(recov_mod_pca)
qqmath(recov_mod_pca)
summary(recov_mod_pca)
# dredge(recov_mod_pca) #null model is best

###
not_recovered<- dbh_age_good %>% 
  mutate(tree=paste0("X",tree)) %>% 
  filter(tree %in% reduction_either) %>% 
  filter(! tree %in% recover_time$tree) 
not_recovered ##all of the trees recovered

#total growth reduction
growth_red<- growth.detrended.df %>% 
  filter(!tree %in% no_reduction) %>% 
  filter(!tree %in% unique(not_recovered$tree)) %>% 
  filter(year>2001) %>% 
  left_join(predrought_new) %>% 
  mutate(growth_red = predrought_ave-rw_spline) %>% 
  filter(growth_red>0)

growth_red_sum <- growth_red %>% 
  left_join(recover_time) %>% 
  mutate(year_diff = minyr-year) %>% 
  filter(year_diff > 0) %>% 
  group_by(Provenance,BLK,tree) %>% 
  summarise(max.growth.red = max(growth_red), sum.growth.red=sum(growth_red)) %>% 
  left_join(growth_red, by=c("max.growth.red" = "growth_red", "tree","Provenance","BLK")) %>% 
  left_join(recover_time, by=c("Provenance", "tree","BLK")) %>% 
  left_join(prov_pcapts_big) 

##max growth reduction models
#anova
aov.mgr <- lmer(max.growth.red ~ Provenance + (1|BLK), data=growth_red_sum)
plot(aov.mgr)
qqmath(aov.mgr)
anova(aov.mgr)  #no significant difference in max growth reduction between provenances

#linear models
mgr.pcmod <- lmer(max.growth.red ~ PC1*PC2 + (1|Provenance) + (1|BLK), data=growth_red_sum)
plot(mgr.pcmod)
qqmath(mgr.pcmod)
summary(mgr.pcmod)
# dredge(mgr.pcmod) #null is best

##sum growth reduction models
#anova
aov.sumgr <- lmer(log(sum.growth.red) ~ Provenance + (1|BLK), data=growth_red_sum)
plot(aov.sumgr)
qqmath(aov.sumgr)
anova(aov.sumgr)  #no significant difference in sum growth reduction between provenances

#linear models
sumgr.pcmod <- lmer(log(sum.growth.red) ~ PC1*PC2 + (1|Provenance) + (1|BLK), data=growth_red_sum)
plot(sumgr.pcmod)
qqmath(sumgr.pcmod)
summary(sumgr.pcmod)
# dredge(sumgr.pcmod) #null is best

```

##Correlations

###climate x climate cors
```{r}
##look at correlation between current year and previous year climate variables at plantation

plantation_clim_cor<- plantation_clim %>% 
  ungroup() %>% 
  filter(year > 1970 & year < 2023) %>% 
 dplyr::select(c(prior_ppt_sm, prior_ppt_wt:prior_tmax_sm, prior_tmean_wt:vpdmax_sm, prior_vpdmax_wt:prior_vpdmax_sm, prior_cwd_sm, prior_cwd_wt:prior_aet_sm, prior_aet_wt:aet_sm)) %>% 
  cor()

plantation_clim_cor

ggcorrplot(plantation_clim_cor, type="lower", insig = "blank", lab=FALSE)

```

###growth x climate cors

```{r}
##calculate correlations between detrended growth and climate at plantation

plantation_frost_minus1<- plantation_frost %>% mutate(year = year+1) 

colnames(plantation_frost_minus1)<- paste("prior_",colnames(plantation_frost_minus1),sep="")

growth_climate_df <- growth.detrended.df %>% 
  left_join(plantation_clim) %>% 
  left_join(plantation_frost) %>% 
  left_join(plantation_frost_minus1, by=c("year" = "prior_year", "CN" = "prior_CN")) %>% 
  ungroup() %>% 
  filter(year>1970) %>% 
  filter(!is.na(rw_spline)) %>% 
  dplyr::select(-site) %>% 
  dplyr::select(-prior_day_of_last_spring_frost) %>% 
  rename(dofff_sm = day_of_first_fall_frost, dolsf_sp= day_of_last_spring_frost, prior_dofff_sm = prior_day_of_first_fall_frost)

climvars <- colnames(growth_climate_df %>% dplyr::select(c(prior_ppt_sm:prior_dofff_sm)))
tree_ids <- unique(growth_climate_df$tree)

gc_cor_df<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i])
  tree <- growth_climate_df %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline)
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df <- bind_rows(gc_cor_df, row)
  }}
gc_cor_df %>% group_by(V1) %>% summarise(n=n())

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>% 
  arrange(n) %>% 
  print(n=55) #number of trees with significant correlations between growth and each climate var

gc_cor_df %>% 
  filter(p.value<0.05) %>% 
  pull(V2) %>% 
  unique() %>% 
  length() #number of trees with at least one significant growth-climate correlation
length(unique(gc_cor_df$V2))

gc_cor_df %>% 
  group_by(V2) %>% 
  summarise(maxcor = max(rw_spline, na.rm=T)) %>% 
  left_join(gc_cor_df, by=c("maxcor"="rw_spline", "V2")) %>% 
  group_by(V1) %>% 
  summarise(n=n()) %>%
  arrange(n) %>%
  print(n=55) #number of trees whose maximum correlation value is with each climate var 

cor_clean <- gc_cor_df %>% 
  rename(climvar=V1, tree=V2, cor=rw_spline) %>%
  mutate(cor = as.numeric(cor)) %>% 
  left_join(growth_climate_df %>%dplyr::select(tree,Provenance, BLK) %>% unique(), by="tree") %>%
  filter(!is.na(cor)) %>% 
  separate(climvar, into=c("time","var","season"), sep="_", remove=FALSE, fill="left") %>% 
  mutate(time_season = paste(time, season, sep=""))

overall_clim_cor_sig<- data.frame()
for(i in 1:length(unique(cor_clean$climvar))){
  data= cor_clean %>% filter(climvar==unique(cor_clean$climvar)[i]) %>% dplyr::select(cor)
  mod = t.test(data, y=NULL, alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)
  pvalue=mod$p.value
  lwr=mod$conf.int[1]
  upr=mod$conf.int[2]
  estimate=mod$estimate[1]
  
  overall_clim_cor_sig = bind_rows(overall_clim_cor_sig, data.frame(climvar=unique(cor_clean$climvar)[i], pvalue=pvalue, lwr=lwr, upr=upr, estimate=estimate))
}

overall_clim_cor_sig %>% filter(pvalue<0.05)

cor_means <- cor_clean %>% 
  group_by(climvar, time, var, season) %>% 
  summarise(mean.cor=mean(cor), sd.cor = sd(cor), se.cor=mean(cor)/sqrt(sd(cor))) %>% 
  mutate(time_season = paste(time, season, sep="")) %>% 
  left_join(overall_clim_cor_sig %>% 
                separate(climvar, into=c("time","var","season"), sep="_", remove=FALSE, fill="left") %>% mutate(time_season = paste(time, season, sep=""))
) %>% 
  mutate(sig=ifelse(pvalue<0.05, "*", ""))

ggplot(cor_means, aes(x=factor(time_season, levels=c("priorsp","priorsm","priorfa","priorwt","NAsp","NAsm"), labels= c("priorsp","priorsm","priorfa","priorwt","sp","sm")), y=estimate,col=mean.cor>0))+
  geom_point(position=position_dodge(1), size=3)+
  geom_errorbar(aes(ymin=lwr, ymax=upr),width=0.5)+
  geom_text(aes(y=0.25, label=sig), size=5)+
  scale_color_manual(values=c("red","black"))+
  scale_shape_manual(values=c(1,13))+
  geom_hline(yintercept=0)+
  facet_wrap(~factor(var, levels=c("aet","cwd","vpdmax","ppt","dolsf","dofff","tmin","tmean","tmax")), nrow=3)+
  theme_bw()+
  ylim(c(-0.15, 0.3))+
  xlab("")+ylab("Mean Pearson's r")+
  theme(axis.text.x=element_text(angle=45, hjust=1))

sig_trees_per_clim <- cor_clean %>% 
  filter(p.value<0.05) %>% 
  group_by(climvar, time, var, season, time_season) %>% 
  summarise(n_sig_trees=n())
  
ggplot(cor_clean, aes(x=factor(Provenance, levels=provs_bylat$Provenance), y=cor, color=p.value<0.05))+
  geom_jitter(height=0, width=0.1, size=3,alpha=0.7)+
  facet_grid(var~factor(time_season, levels=c("priorsp","priorsm","priorfa","priorwt","NAsp","NAsm"), labels=c("prior sp","prior sm","prior fa","prior wt","sp","sm")))+
  scale_color_manual(values=c("gray20", "red"))+
  geom_hline(yintercept=0)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, color="black", size=10),
        axis.text = element_text(color="black", size=12),
        axis.title = element_text(color="black", size=14),
        legend.text = element_text(color="black", size=12),
        legend.title = element_text(color="black", size=14),
        strip.text = element_text(color="black", size=12))

allanovas<- data.frame()
for(i in 1:length(unique(cor_clean$climvar))){
mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == unique(cor_clean$climvar)[i]))
modanova <- as.data.frame(Anova(mod, type="2"))
pvalue<- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Pr(>F)`)
provSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Sum Sq`)
provdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Provenance") %>%  pull(`Df`)
residSS <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Sum Sq`)
residdf <- modanova %>% mutate(var = rownames(modanova)) %>% filter(var=="Residuals") %>%  pull(`Df`)
allanovas <- bind_rows(allanovas, data.frame(climvar=unique(cor_clean$climvar)[i],pvalue=pvalue, provMS = provSS/provdf, residMS = residSS/residdf, provdf=provdf, residdf = residdf))
}

allanovas %>% mutate(diff_prov = residMS - provMS) ##when residMS is greater than provMS (diff > 0)--> variation within provenances is greater than variation between them 
allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov>0) %>% nrow()#within greater than between
allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov<0) %>% nrow()#between greater than within

more_intrapop_diff<- allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov>0)
more_interpop_diff<- allanovas %>% mutate(diff_prov = residMS - provMS) %>% filter(diff_prov<0) 
anova_table<- allanovas %>% mutate(diff = residMS - provMS) %>% 
  separate(climvar, into=c("time","var","season"), sep="_", fill="left")

write.csv(anova_table, "growth_climate_MS.csv")

anova_table %>% 
  mutate(neg=ifelse(diff<0, TRUE, FALSE)) %>% 
  group_by(var, neg) %>% 
  summarise(n=n()) %>% 
  filter(neg==TRUE)
anova_table %>% 
  mutate(neg=ifelse(diff<0, TRUE, FALSE), time_season=paste(time, season, sep=" ")) %>% 
  group_by(time_season, neg) %>% 
  summarise(n=n()) %>% 
  filter(neg==TRUE)

allanovas %>% filter(pvalue<0.05) #prior_ppt_wt, cwd_sp have significant differences between provenances

#prior_ppt_wt
prior_ppt_wt_RWI_mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == "prior_ppt_wt"))
Anova(prior_ppt_wt_RWI_mod, type="2")
lsmeans_prior_ppt_wt_RWI_mod <- lsmeans(prior_ppt_wt_RWI_mod, ~Provenance)
cld(lsmeans_prior_ppt_wt_RWI_mod)

#cwd_sp
cwd_sp_RWI_mod <- lm(cor ~ Provenance, data=cor_clean %>% filter(climvar == "cwd_sp"))
Anova(cwd_sp_RWI_mod, type="2")
lsmeans_cwd_sp_RWI_mod <- lsmeans(cwd_sp_RWI_mod, ~Provenance)
cld(lsmeans_cwd_sp_RWI_mod)

min(allanovas$pvalue)
max(allanovas$pvalue)

##T-TESTS
provs <- unique(cor_clean$Provenance)
ttestdata<- data.frame()

for(i in 1:length(unique(cor_clean$climvar))){
  for(j in 1:length(provs)){
data <- cor_clean %>% 
  filter(climvar==unique(cor_clean$climvar)[i]) %>% 
  filter(Provenance == provs[j])

test<- t.test(data$cor, y = NULL,
       alternative = "two.sided",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)

row <- data.frame(climvar = unique(cor_clean$climvar)[i], Provenance = provs[j], lwr = test$conf.int[1], upr = test$conf.int[2], estimate = test$estimate, pvalue = test$p.value)

ttestdata <- bind_rows(ttestdata, row)}}

ttestdata %>% filter(pvalue < 0.05) %>% 
  group_by(climvar) %>% 
  summarise(n=n()) %>% 
arrange(n) %>% 
  print(n=56)  ##number of provenances with significant values


sig.cors.byprov <- cor_clean %>% left_join(ttestdata %>% filter(pvalue < 0.05)) %>% 
  mutate(sig = case_when(!is.na(pvalue) ~ "*",
                         .default = "")) %>% 
  left_join(prov_names) %>% 
  filter(!time_season=="priorsp") %>% 
  filter(!var=="spei")#getting rid of prior spring and SPEI just to simplify

ggplot(data=sig.cors.byprov, aes(x=factor(code, levels=provs_bylat$code), y=estimate))+
    geom_jitter(data= cor_clean  %>% left_join(prov_names), aes(x=factor(code, levels=provs_bylat$code), y=cor, color=p.value<0.05),size=2, height=0, width=0.1, alpha=0.2)+
    geom_text(data=cor_means , aes(x="RoNF", y=0.95,label=paste0("mean r = ",round(mean.cor,2)," \u00B1 ",round(sd.cor,2)), col=mean.cor<0))+
    geom_text(data=sig_trees_per_clim , aes(x="RoNF", y=0.7,label=paste0("N[p<0.05] = ",n_sig_trees)))+
  scale_color_manual(values=c("gray20","red"))+
  ggnewscale::new_scale_color()+
  geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr, color = factor(code, levels=provs_bylat$code)),width=0.8, linewidth=1)+
    geom_errorbar(aes(x=factor(code, levels=provs_bylat$code), ymin=lwr, ymax=upr),width=0.8, color="black", linewidth=0.5)+
  geom_point(size=2, shape=21, aes(fill=factor(code, levels=provs_bylat$code)))+
  scale_color_manual(values=unname(stepped()), name="Provenance")+
  scale_fill_manual(values=unname(stepped()), name="Provenance")+
  geom_hline(yintercept=0, col="black")+
  facet_grid(var~factor(time_season, levels=c("priorsm","priorfa","priorwt","NAsp","NAsm"), labels=c("prior sm","prior fa","prior wt","sp","sm")))+
  xlab("")+
  ylim(c(-.6,1))+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, size=12, color="black"),
        axis.text.y = element_text(size=12, color="black"),
        axis.title = element_text(size=12, color="black"),
        legend.position = "none",
        strip.text = element_text(color="black", size=12),
        panel.grid = element_blank())
```

```{r}
climate_growth_table<- ttestdata %>% 
  left_join(prov_names) %>% 
  dplyr::select(climvar, code, estimate, pvalue) %>% 
  mutate(pvalue=ifelse(pvalue<0.05, "X", ""), estimate=ifelse(estimate > 0 , "+", "-")) %>% 
  mutate(estimate=ifelse(pvalue=="X", estimate, "")) %>% 
  dplyr::select(-pvalue) %>% 
  pivot_wider(names_from=code, values_from=estimate) %>% 
  dplyr::select(c("climvar", provs_bylat$code[-9]))

write.csv(climate_growth_table, "climate_growth_table.csv")

```

####temporal trends

```{r}
growth_climate_df
min(growth_climate_df$year)
max(growth_climate_df$year)

gc_cor_df_1994<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df%>% filter(year<1995) %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i]) 
  tree <- growth_climate_df%>% filter(year<1995) %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline) 
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df_1994 <- bind_rows(gc_cor_df_1994, row)
  }}
gc_cor_df_1994 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="1994")

gc_cor_df_2004<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df%>% filter(year<2005 & year > 1994) %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i]) 
  tree <- growth_climate_df%>% filter(year<2005 & year > 1994) %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline) 
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df_2004 <- bind_rows(gc_cor_df_2004, row)
  }}
gc_cor_df_2004 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2004")

gc_cor_df_2014<-data.frame()
for(i in 1:length(climvars)){
  for(j in 1:length(tree_ids)){
  clim <- growth_climate_df%>% filter(year<2015 & year > 2004) %>% dplyr::filter(tree == tree_ids[j]) %>% dplyr::select(climvars[i]) 
  tree <- growth_climate_df%>% filter(year<2015 & year > 2004) %>% dplyr::filter(tree == tree_ids[j]) %>%dplyr::select(rw_spline) 
  gc.cor <- cor(clim, tree)
  p.value <- cor.test(clim %>% pull(1), tree %>% pull(1))$p.value
  row <- cbind(climvars[i], tree_ids[j], gc.cor, p.value) %>% as.data.frame()
  gc_cor_df_2014 <- bind_rows(gc_cor_df_2014, row)
  }}
gc_cor_df_2014 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2014")


gc_cor_periods<- bind_rows(gc_cor_df_1994 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="1994"),
          gc_cor_df_2004 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2004"),
          gc_cor_df_2014 %>% mutate(rw_spline=as.numeric(rw_spline)) %>% group_by(V1) %>% summarise(mean.rwi = mean(rw_spline, na.rm=T), n=n()) %>% mutate(period="2014"))

ggplot(gc_cor_periods, aes(x=period, y=mean.rwi, col=mean.rwi>0))+
  geom_point()+
  facet_wrap(~V1)+
  geom_hline(yintercept=0, color="black")

```

###provenance climate affect on Gx C correlation 
```{r}

##############################################

cor_provclim<- cor_clean %>%
  left_join(prov_names) %>% 
  left_join(
prov_pcapts_big %>% 
  dplyr::select(c(Provenance,PC1:PC2,all_of(colnames(big_pca_data)))), by="Provenance") %>% 
  left_join(dbh_numeric_time %>% 
  dplyr::select(Provenance, pcadist2d) %>% 
  unique())

cor_provclim_long <- pivot_longer(cor_provclim, PC1:pcadist2d)

#translate into transfer distance

cor_provclim_long_transfer <- cor_provclim_long %>% 
  left_join(plantation_climNA, by=c("name"="var")) %>% 
  mutate(transfer = value - plant_value) %>% 
  mutate(name=ifelse(name=="PC1","PC1transfer",ifelse(name=="PC2","PC2transfer", name))) %>% 
  mutate(transfer = ifelse(name=="pcadist2d", value, transfer))


# makes plot for every plantation and provenance clim variable

# pdf(file="correlation_by_provclim.pdf")
# for(i in 1:length(climvars)){
# plot<- ggplot(cor_provclim_long %>% filter(climvar==climvars[i]), aes(x=value, y=cor))+
#   geom_point()+
#   geom_smooth(method="lm")+
#   facet_wrap(~name, scales="free")+
#   ggtitle(climvars[i])
# print(plot)
# }
# dev.off()

##corresponding models
climvar_list <- unique(cor_provclim_long_transfer$climvar)

names <- transfer_vars
lmerdata <- data.frame()
for(i in 1:length(climvar_list)){
  for(j in 1:length(names)){
    data <- cor_provclim_long_transfer %>% filter(climvar==climvar_list[i] & name==names[j]) 
    mod <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=data)
    pvalue.lmer <- as.data.frame(summary(mod)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    mod_nog <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=data %>% filter(!Provenance=="Gila NF"))
    pvalue.lmer_nog <- as.data.frame(summary(mod_nog)$coefficients)[2,] %>% pull(`Pr(>|t|)`)
    # Cr2.lmer <- performance::r2(mod)$R2_conditional
    # Mr2.lmer <- performance::r2(mod)$R2_marginal
   
    lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvar_list[i], name=names[j], pvalue.lmer = pvalue.lmer, pvalue.lmer_nog = pvalue.lmer_nog))  

#     if(!is.na(Cr2.lmer)) (
# lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvar_list[i], name=names[j], pvalue.lmer = pvalue.lmer, r2.lmer=Cr2.lmer, r2type="C")) ) 

#     if(is.na(Cr2.lmer)) (
# lmerdata <- bind_rows(lmerdata, data.frame(climvar=climvar_list[i], name=names[j], pvalue.lmer = pvalue.lmer, r2.lmer=Mr2.lmer, r2type="M"))
#  ) 
  }}

lmerdata %>% filter(pvalue.lmer_nog < 0.05)

lmerdata %>% filter(pvalue.lmer < 0.05)

currentyr_plot<- ggplot(data=left_join(lmerdata %>% filter(pvalue.lmer < 0.05 & pvalue.lmer_nog<0.05), cor_provclim_long_transfer)  %>% filter(!str_detect(climvar, "prior")), aes(x=transfer, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  theme(strip.text=element_text(size=8), axis.text.x=element_text(size=5), axis.text.y=element_text(size=5), axis.title=element_text(size=5))

currentyr_plot
clim_pien_cor

prioryr_plot <- ggplot(data=left_join(lmerdata %>% filter(pvalue.lmer < 0.05 & pvalue.lmer_nog<0.05), cor_provclim_long_transfer) %>% filter(str_detect(climvar, "prior")), aes(x=transfer, y=cor))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_grid(climvar~name, scales="free")+
  geom_hline(yintercept=0, col="red")+
  theme(strip.text=element_text(size=8), axis.text.x=element_text(size=5), axis.text.y=element_text(size=5), axis.title=element_text(size=5))

prioryr_plot


##########final plot

lmerdata %>% filter(climvar %in% c("prior_ppt_wt", "cwd_sp")) %>% filter(pvalue.lmer_nog < 0.05) ##just look at trends if provenances significantly differed from each other in the ANOVA

##cwd_sp & CMD

cwd_sp_CMD_mod <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=cor_provclim_long_transfer %>% filter(climvar=="cwd_sp" & name=="CMD" ))
plot(cwd_sp_CMD_mod)
qqmath(cwd_sp_CMD_mod)
summary(cwd_sp_CMD_mod)
cwd_sp_CMD_mod_nog <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=cor_provclim_long_transfer %>% filter(!Provenance=="Gila NF") %>%  filter(climvar=="cwd_sp" & name=="CMD" ))


##predictions
cwd_sp_CMD_data <- cor_provclim_long_transfer %>% filter(climvar=="cwd_sp" & name=="CMD" )
cwd_sp_CMD_mod_lm <- lm(cor ~ transfer, data=cwd_sp_CMD_data)
cwd_sp_CMD_mod_lm_nog <- lm(cor ~ transfer, data=cwd_sp_CMD_data %>% filter(!Provenance=="Gila NF"))

## with Gila
newdata_cwd_sp_CMD <- data.frame(transfer= seq(min(cwd_sp_CMD_data$transfer),max(cwd_sp_CMD_data$transfer), length.out=50))

predict_cwd_sp_CMD <- predict(cwd_sp_CMD_mod_lm, newdata_cwd_sp_CMD, interval="confidence")

predict_data_cwd_sp_CMD <- as.data.frame(bind_cols(newdata_cwd_sp_CMD,predict_cwd_sp_CMD))

##predictions - without Gila
newdata_cwd_sp_CMD_nog <- data.frame(transfer= seq(min(cwd_sp_CMD_data %>% filter(!Provenance=="Gila NF") %>% pull(transfer)),max(cwd_sp_CMD_data %>% filter(!Provenance=="Gila NF") %>% pull(transfer)), length.out=50))

predict_cwd_sp_CMD_nog <- predict(cwd_sp_CMD_mod_lm_nog, newdata_cwd_sp_CMD_nog, interval="confidence")

predict_data_cwd_sp_CMD_nog <- as.data.frame(bind_cols(newdata_cwd_sp_CMD_nog,predict_cwd_sp_CMD_nog))

predict_data_cwd_sp_CMD_all <- bind_rows(predict_data_cwd_sp_CMD_nog %>% mutate(model="without Gila NF"), predict_data_cwd_sp_CMD %>% mutate(model="with Gila NF"))

pvalues_cwd_sp_CMD <- data.frame(pvalue= c(summary(cwd_sp_CMD_mod)$coefficients[2,5], summary(cwd_sp_CMD_mod_nog)$coefficients[2,5]), model=c("with Gila NF", "without Gila NF"), x=c(500), y=c(-.28,-.35))   

cwd_sp_CMD_plot <- ggplot()+
  geom_point(data=cwd_sp_CMD_data, aes(x=transfer, y=cor), color="gray")+
  geom_line(data=predict_data_cwd_sp_CMD_nog, aes(x=transfer, y=fit))+
  geom_ribbon(data=predict_data_cwd_sp_CMD_nog, aes(x=transfer, y=fit, ymin=lwr, ymax=upr), alpha=0.3)+
  scale_color_manual(values=c("gray35","black"))+
  scale_fill_manual(values=c("gray35","black"))+
  #geom_text(data=pvalues_cwd_sp_CMD, aes(x=x, y=y, label=paste0("p = ",round(pvalue,4)), col=model), hjust=0)+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=0, color="black", linetype=2, linewidth=1)+
  xlab("CMD transfer")+
  ylab("Pearson's r")+
  theme_bw()+
  theme(legend.position="top")+
  ggtitle("")


##cwd_sp & MCMT

cwd_sp_MCMT_mod <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=cor_provclim_long_transfer %>% filter(climvar=="cwd_sp" & name=="MCMT" ))
plot(cwd_sp_MCMT_mod)
qqmath(cwd_sp_MCMT_mod)
summary(cwd_sp_MCMT_mod)
cwd_sp_MCMT_mod_nog <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=cor_provclim_long_transfer %>% filter(!Provenance=="Gila NF") %>% filter(climvar=="cwd_sp" & name=="MCMT" ))


##predictions
cwd_sp_MCMT_data <- cor_provclim_long_transfer %>% filter(climvar=="cwd_sp" & name=="MCMT" )
cwd_sp_MCMT_mod_lm <- lm(cor ~ transfer, data=cwd_sp_MCMT_data)
cwd_sp_MCMT_mod_lm_nog <- lm(cor ~ transfer, data=cwd_sp_MCMT_data %>% filter(!Provenance=="Gila NF"))

## with Gila
newdata_cwd_sp_MCMT <- data.frame(transfer= seq(min(cwd_sp_MCMT_data$value),max(cwd_sp_MCMT_data$value), length.out=50))

predict_cwd_sp_MCMT <- predict(cwd_sp_MCMT_mod_lm, newdata_cwd_sp_MCMT, interval="confidence")

predict_data_cwd_sp_MCMT <- as.data.frame(bind_cols(newdata_cwd_sp_MCMT,predict_cwd_sp_MCMT))

##predictions - without Gila
newdata_cwd_sp_MCMT_nog <- data.frame(transfer= seq(min(cwd_sp_MCMT_data %>% filter(!Provenance=="Gila NF") %>% pull(transfer)),max(cwd_sp_MCMT_data %>% filter(!Provenance=="Gila NF") %>% pull(transfer)), length.out=50))

predict_cwd_sp_MCMT_nog <- predict(cwd_sp_MCMT_mod_lm_nog, newdata_cwd_sp_MCMT_nog, interval="confidence")

predict_data_cwd_sp_MCMT_nog <- as.data.frame(bind_cols(newdata_cwd_sp_MCMT_nog,predict_cwd_sp_MCMT_nog))

predict_data_cwd_sp_MCMT_all <- bind_rows(predict_data_cwd_sp_MCMT_nog %>% mutate(model="without Gila NF"), predict_data_cwd_sp_MCMT %>% mutate(model="with Gila NF")) 

pvalues_cwd_sp_MCMT <- data.frame(pvalue= c(summary(cwd_sp_MCMT_mod)$coefficients[2,5], summary(cwd_sp_MCMT_mod_nog)$coefficients[2,5]), model=c("with Gila NF", "without Gila NF"), x=c(-2,-2), y=c(-.28,-.35))   

cwd_sp_MCMT_plot <- ggplot()+
  geom_point(data=cwd_sp_MCMT_data, aes(x=transfer, y=cor), color="gray")+
  geom_line(data=predict_data_cwd_sp_MCMT_nog, aes(x=transfer, y=fit))+
  geom_ribbon(data=predict_data_cwd_sp_MCMT_nog, aes(x=transfer, y=fit, ymin=lwr, ymax=upr), alpha=0.3)+
  scale_color_manual(values=c("gray35","black"))+
  scale_fill_manual(values=c("gray35","black"))+
  #geom_text(data=pvalues_cwd_sp_MCMT, aes(x=x, y=y, label=paste0("p = ",round(pvalue,4)), col=model), hjust=0)+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=0, color="black", linetype=2, linewidth=1)+
  xlab("MCMT transfer")+
  ylab("Pearson's r")+
  theme_bw()+
  theme(legend.position="top")+
  ggtitle("Spring CWD")

##cwd_sp & pcadist2d

cwd_sp_pcadist2d_mod <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=cor_provclim_long_transfer %>% filter(climvar=="cwd_sp" & name=="pcadist2d" ))
plot(cwd_sp_pcadist2d_mod)
qqmath(cwd_sp_pcadist2d_mod)
summary(cwd_sp_pcadist2d_mod)
cwd_sp_pcadist2d_mod_nog <- lmer(cor ~ transfer + (1|Provenance) + (1|BLK), data=cor_provclim_long_transfer %>% filter(!Provenance=="Gila NF") %>% filter(climvar=="cwd_sp" & name=="pcadist2d" ))


##predictions
cwd_sp_pcadist2d_data <- cor_provclim_long_transfer %>% filter(climvar=="cwd_sp" & name=="pcadist2d" )
cwd_sp_pcadist2d_mod_lm <- lm(cor ~ transfer, data=cwd_sp_pcadist2d_data)
cwd_sp_pcadist2d_mod_lm_nog <- lm(cor ~ transfer, data=cwd_sp_pcadist2d_data %>% filter(!Provenance=="Gila NF"))

##predictions - without Gila
newdata_cwd_sp_pcadist2d_nog <- data.frame(transfer= seq(min(cwd_sp_pcadist2d_data %>% filter(!Provenance=="Gila NF") %>% pull(transfer)),max(cwd_sp_pcadist2d_data %>% filter(!Provenance=="Gila NF") %>% pull(transfer)), length.out=50))

predict_cwd_sp_pcadist2d_nog <- predict(cwd_sp_pcadist2d_mod_lm_nog, newdata_cwd_sp_pcadist2d_nog, interval="confidence")

predict_data_cwd_sp_pcadist2d_nog <- as.data.frame(bind_cols(newdata_cwd_sp_pcadist2d_nog,predict_cwd_sp_pcadist2d_nog))


#pvalues_cwd_sp_pcadist2d <- data.frame(pvalue= c(summary(cwd_sp_pcadist2d_mod)$coefficients[2,5], summary(cwd_sp_pcadist2d_mod_nog)$coefficients[2,5]), model=c("with Gila NF", "without Gila NF"), x=c(-2,-2), y=c(-.28,-.35))   

cwd_sp_pcadist2d_plot <- ggplot()+
  geom_point(data=cwd_sp_pcadist2d_data, aes(x=transfer, y=cor), color="gray")+
  geom_line(data=predict_data_cwd_sp_pcadist2d_nog, aes(x=transfer, y=fit))+
  geom_ribbon(data=predict_data_cwd_sp_pcadist2d_nog, aes(x=transfer, y=fit, ymin=lwr, ymax=upr), alpha=0.3)+
  scale_color_manual(values=c("gray35","black"))+
  scale_fill_manual(values=c("gray35","black"))+
  #geom_text(data=pvalues_cwd_sp_pcadist2d, aes(x=x, y=y, label=paste0("p = ",round(pvalue,4)), col=model), hjust=0)+
  geom_hline(yintercept=0)+
  geom_vline(xintercept=0, color="black", linewidth=1, linetype=2)+
  xlab("Transfer in 2D PCA")+
  ylab("Pearson's r")+
  theme_bw()+
  theme(legend.position="top")+
  ggtitle("")

ggarrange(cwd_sp_MCMT_plot, cwd_sp_CMD_plot, cwd_sp_pcadist2d_plot, nrow=1, common.legend = TRUE)
```
